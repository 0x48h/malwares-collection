<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>rtp.inc</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;JUMPS</span><span class="sc0">
</span><span class="sc1">;include c:\asm\star.inc</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">

</span><span class="sc5">ENGINE_LENGTH</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ENGINE_END</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ENGINE_START</span><span class="sc0">
</span><span class="sc5">ENGINE_START</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Conditional Assembly *****************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc1">;ENABLE DEBUG_ENCRYPTOR</span><span class="sc0">
</span><span class="sc1">;ENABLE DISPLAY_STATUS</span><span class="sc0">

</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">MULTI_LAYER</span><span class="sc0">

</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLING</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_REG8</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_IMM</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_RM</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_RM_REG</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_RM_MEM</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_MANY_JUNK_OPS</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_PUSH_POP</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_JCOND</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_JMP_CALL</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_LOOP</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_INT</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_ANTI_EMUL0</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_ANTI_EMUL1</span><span class="sc0">
</span><span class="sc5">ENABLE</span><span class="sc0">  </span><span class="sc5">GARBLE_ANTI_EMUL2</span><span class="sc0">

</span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc6">str</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">l1</span><span class="sc0">
    
    </span><span class="sc9">ifdef</span><span class="sc0"> </span><span class="sc5">display_status</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">l1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"&amp;str&amp;"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">
 </span><span class="sc5">l1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">

    </span><span class="sc9">endif</span><span class="sc0">

    </span><span class="sc9">ENDM</span><span class="sc0">
    

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Equates ******************************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">JUNK_ROUT_MAX</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">25</span><span class="sc0">

</span><span class="sc5">Reg16s</span><span class="sc0">      </span><span class="sc5">ENUM</span><span class="sc0">    {</span><span class="sc5">_AX</span><span class="sc4">,</span><span class="sc5">_CX</span><span class="sc4">,</span><span class="sc5">_DX</span><span class="sc4">,</span><span class="sc5">_BX</span><span class="sc4">,</span><span class="sc5">_SP</span><span class="sc4">,</span><span class="sc5">_BP</span><span class="sc4">,</span><span class="sc5">_SI</span><span class="sc4">,</span><span class="sc5">_DI</span><span class="sc0">}
</span><span class="sc5">Reg8s</span><span class="sc0">       </span><span class="sc5">ENUM</span><span class="sc0">    {</span><span class="sc5">_AL</span><span class="sc4">,</span><span class="sc5">_CL</span><span class="sc4">,</span><span class="sc5">_DL</span><span class="sc4">,</span><span class="sc5">_BL</span><span class="sc4">,</span><span class="sc5">_AH</span><span class="sc4">,</span><span class="sc5">_CH</span><span class="sc4">,</span><span class="sc5">_DH</span><span class="sc4">,</span><span class="sc5">_BH</span><span class="sc0">}
</span><span class="sc5">Indexes</span><span class="sc0">     </span><span class="sc5">ENUM</span><span class="sc0">    {</span><span class="sc5">iBX_SI</span><span class="sc4">,</span><span class="sc5">iBX_DI</span><span class="sc4">,</span><span class="sc5">iBP_SI</span><span class="sc4">,</span><span class="sc5">iBP_DI</span><span class="sc4">,</span><span class="sc5">iSI</span><span class="sc4">,</span><span class="sc5">iDI</span><span class="sc4">,</span><span class="sc5">iBP</span><span class="sc4">,</span><span class="sc5">iBX</span><span class="sc0">}

</span><span class="sc1">; R/M's</span><span class="sc0">
</span><span class="sc5">rm_00</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
</span><span class="sc5">rm_08</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
</span><span class="sc5">rm_16</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">
</span><span class="sc5">rm_Reg</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">

</span><span class="sc1">; 00h, 80h family</span><span class="sc0">
</span><span class="sc5">_ADD</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">_OR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">_ADC</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">_SBB</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">_AND</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">_SUB</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">_XOR</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">_CMP</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">38h</span><span class="sc0">

</span><span class="sc1">; C0h, D0h family</span><span class="sc0">
</span><span class="sc5">_ROL</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">_ROR</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">_RCL</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">_RCR</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">_SHL</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">_SHR</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">_SAL</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">_SAR</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">38h</span><span class="sc0">

</span><span class="sc1">; FEh family</span><span class="sc0">
</span><span class="sc5">_INC</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">_DEC</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">_CALLN</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">_CALLF</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">_JMPN</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">_JMPF</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">_PUSH</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">30h</span><span class="sc0">

</span><span class="sc1">; F6h family</span><span class="sc0">
</span><span class="sc5">_TEST</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
           </span><span class="sc1">;08h </span><span class="sc0">
</span><span class="sc5">_NOT</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">_NEG</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">_MUL</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">_IMUL</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">_DIV</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">_IDIV</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">38h</span><span class="sc0">

</span><span class="sc1">; 70h family</span><span class="sc0">
</span><span class="sc5">_JO</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">70h</span><span class="sc0">
</span><span class="sc5">_JNO</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">71h</span><span class="sc0">
</span><span class="sc5">_JC</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">72h</span><span class="sc0">
</span><span class="sc5">_JNC</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">73h</span><span class="sc0">
</span><span class="sc5">_JZ</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">_JNZ</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">75h</span><span class="sc0">
</span><span class="sc5">_JAE</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">76h</span><span class="sc0">
</span><span class="sc5">_JA</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">77h</span><span class="sc0">
</span><span class="sc5">_JS</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">78h</span><span class="sc0">
</span><span class="sc5">_JNS</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">79h</span><span class="sc0">
</span><span class="sc5">_JPZ</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Ah</span><span class="sc0">
</span><span class="sc5">_JPO</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Bh</span><span class="sc0">
</span><span class="sc5">_JL</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Ch</span><span class="sc0">
</span><span class="sc5">_JGE</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Dh</span><span class="sc0">
</span><span class="sc5">_JLE</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Eh</span><span class="sc0">
</span><span class="sc5">_JG</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7Fh</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;** Polymorphic Engine ******************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Red Team Polymorphy 0.1b - (c) 1997 The Soul Manager [IR/G]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si = code to crypt</span><span class="sc0">
</span><span class="sc1">; es:di = where to do it</span><span class="sc0">
</span><span class="sc1">; cx = how much</span><span class="sc0">
</span><span class="sc1">; bx = delta offset where code will start</span><span class="sc0">
</span><span class="sc1">; dx = offset into code for execution to continue</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ds:dx = where to write from</span><span class="sc0">
</span><span class="sc1">; cx = how much</span><span class="sc0">
</span><span class="sc1">; ax = ip</span><span class="sc0">

</span><span class="sc5">rtp_file</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">MULTI_LAYER</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rtp_boot</span><span class="sc0">
        
    </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">MULTI_LAYER</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; cx = how much</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; dx = ret IP offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; bx = delta offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decryptor_garble</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dos_garble</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__rtp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; cx = how much</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; dx = ret IP offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; bx = delta offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__rtp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">      
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si = code to crypt</span><span class="sc0">
</span><span class="sc1">; es:di = where to do it</span><span class="sc0">
</span><span class="sc1">; cx = how much</span><span class="sc0">
</span><span class="sc1">; bx = delta offset where code will start</span><span class="sc0">
</span><span class="sc1">; dx = offset into code for execution to continue</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ds:dx = where to write from</span><span class="sc0">
</span><span class="sc1">; cx = how much</span><span class="sc0">
</span><span class="sc1">; ax = ip</span><span class="sc0">

</span><span class="sc5">rtp_boot</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">MULTI_LAYER</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decryptor_garble</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">no_garble</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decryptor_garble</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dos_garble</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__rtp</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; cx = howmuch</span><span class="sc0">
        </span><span class="sc1">; es:di = where to build decryptor</span><span class="sc0">
        </span><span class="sc1">; bx = delta offset where code starts</span><span class="sc0">
        </span><span class="sc1">; dx = after jmp dest adjusted for delta ofs</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crypt_start</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">; delta</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">after_jmp</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; delta + offset into code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_bytes</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; how much</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_setup</span><span class="sc0">      
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; ** Build Encryptor **</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Build</span><span class="sc0"> </span><span class="sc5">Encryptor</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">encrypt_return</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">e_seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">routine_type</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">create_encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garble_routines</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">no_garble</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG_ENCRYPTOR</span><span class="sc0">

        </span><span class="sc5">STO_B</span><span class="sc0">   </span><span class="sc2">0CCh</span><span class="sc0">

    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_routine</span><span class="sc0">
        </span><span class="sc5">STO_B</span><span class="sc0">   </span><span class="sc2">0CBh</span><span class="sc0">
        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Encryptor</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; ** Code was just Encrypted **</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">encrypt_return</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; ** Build Decryptor **</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Encryptor</span><span class="sc0"> </span><span class="sc5">Returned</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Building</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">junk_rout_ptr</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">d_seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">routine_type</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">create_decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garble_routines</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dos_garble</span><span class="sc0">
</span><span class="sc5">decryptor_garble</span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">pf_inloop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_SP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_AH</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_routine</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">pf_inloop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_SP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_AH</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">after_jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_jmp</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLING</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_junk_routs</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; ** Load Output Registers **</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Load</span><span class="sc0"> </span><span class="sc5">Output</span><span class="sc0"> </span><span class="sc5">Registers</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crypt_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_bytes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">make_routine</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MAKE_ROUTINE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">pf_inloop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_crypt_op</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">initr_list</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_steps</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; loop start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loopr_list</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_steps</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; loop end</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">plaintxt_to_index</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">encode_loop</span><span class="sc0">     

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;** Fundamental Stuff *******************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;= Basic Setup ==============================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; M_* initialised.</span><span class="sc0">
</span><span class="sc1">; regs destroyed</span><span class="sc0">

</span><span class="sc5">pf_dblref</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00001b</span><span class="sc0">
</span><span class="sc5">pf_backward</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00010b</span><span class="sc0">
</span><span class="sc5">pf_word</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00100b</span><span class="sc0">
</span><span class="sc5">pf_inloop</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">01000b</span><span class="sc0">

</span><span class="sc5">poly_setup</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">POLY_SETUP</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; ** Initialise RNG **</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Initializing</span><span class="sc0"> </span><span class="sc5">RNG</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc5">DO</span><span class="sc0">
          </span><span class="sc6">shr</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
          </span><span class="sc6">rcr</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
          </span><span class="sc6">rcr</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
          </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc10">C</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">04C1h</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1DB7h</span><span class="sc0">
          </span><span class="sc5">DONE</span><span class="sc0">
          </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">master_seed.wLO</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">master_seed.wHI</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_rng_seeds</span><span class="sc0">

        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Setting</span><span class="sc0"> </span><span class="sc5">POLY_FLAGS</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">initial_key</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_SP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_AH</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">    </span><span class="sc1">; ** set flags</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">pf_backward</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">pf_word</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">BE</span><span class="sc0">      </span><span class="sc1">; 1/4  chance of no dbl ref</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; (CF=ZF=0). pf_dblref=1    </span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Choose</span><span class="sc0"> </span><span class="sc5">Count</span><span class="sc0"> </span><span class="sc5">Method</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">        </span><span class="sc1">; ** choose count_method</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand_b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_meth</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">07FFFh</span><span class="sc0">   </span><span class="sc1">; ** choose count MUL'r</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">         
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_bytes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">MAX</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_mul</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Choose</span><span class="sc0"> </span><span class="sc5">Index</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">    </span><span class="sc1">; ** choose index</span><span class="sc0">
          </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000011b</span><span class="sc0">    </span><span class="sc1">; clear op field</span><span class="sc0">
          </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; single reg ptrs only</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">iBP</span><span class="sc4">+</span><span class="sc5">rm_00</span><span class="sc0">    </span><span class="sc1">; no imm16</span><span class="sc0">
         </span><span class="sc9">REPEAT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">AE</span><span class="sc0">      </span><span class="sc1">; no reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc0">              
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; save ModRM-for plaintxt too</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_plaintxt</span><span class="sc4">-</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_m_ofs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">plaintxt_to_index</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">index_to_reg_table</span><span class="sc0">
        </span><span class="sc6">xlat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_modrm16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Choose</span><span class="sc0"> </span><span class="sc5">Count_Reg</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_free_reg16</span><span class="sc0">  </span><span class="sc1">; get count reg</span><span class="sc0">
          </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">poly_flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
         </span><span class="sc5">EXIT</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_BX</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">A</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_modrm16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_count</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">poly_flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_plaintxt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Choose</span><span class="sc0"> </span><span class="sc5">Key_Reg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Plaintxt_Reg</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_key</span><span class="sc0">            </span><span class="sc1">; set key reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">poly_flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_key</span><span class="sc4">)],</span><span class="sc5">pf_dblref</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">create_regmodrm</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">                    </span><span class="sc1">; set plaintxt reg</span><span class="sc0">
            
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; si = ofs of modrm object</span><span class="sc0">
</span><span class="sc1">; cx = modrm size (1=16 bit)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; si = create modrm</span><span class="sc0">

</span><span class="sc5">create_regmodrm</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CREATE_MODRM</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">@crm0</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_free_reg16</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">allocate_reg16</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">@crm1</span><span class="sc0">
             </span><span class="sc5">@crm0</span><span class="sc4">:</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_free_reg8</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">allocate_reg8</span><span class="sc0">
            </span><span class="sc5">@crm1</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">         

</span><span class="sc5">index_to_reg_table</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">_SI</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">_DI</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">_BP</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">_BX</span><span class="sc0">

</span><span class="sc1">; just something to save a few bytes</span><span class="sc0">

</span><span class="sc5">save_modrm16</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">allocate_reg16</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rm_Reg</span><span class="sc0">   </span><span class="sc1">; create ModRM</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= ModRM Object stuff =======================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si = ModRM object</span><span class="sc0">
</span><span class="sc1">; es:di = pos. to store offset</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of stored offset</span><span class="sc0">

</span><span class="sc5">store_m_ofs</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;STATUS &lt;STORE_M_OFS&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">lodsw</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_modrm</span><span class="sc0">
            </span><span class="sc6">lodsw</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">PO</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">NS</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; 8 bit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; JMP $+3</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; 16 bit</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si = ModRM object</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si-2 = ModRM object with suitable offset</span><span class="sc0">

</span><span class="sc5">create_m_ofs</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CREATE_M_OFS</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">lodsw</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_modrm</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">PE</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NS</span><span class="sc0">
             </span><span class="sc6">cbw</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ah = ModRM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; flags for offset..</span><span class="sc0">

</span><span class="sc5">test_modrm</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">iBP</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">rm_16</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= Code Optimisation ========================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Optimisations:    push signable imm16     68h</span><span class="sc0">
</span><span class="sc1">;           ShiftOP ModRM, Mask and 0Fh C0h, C1h</span><span class="sc0">
</span><span class="sc1">;                       ShiftOP ModRM, 1        C0h, C1h</span><span class="sc0">
</span><span class="sc1">;           AriOP ModRM, signable imm16 81h</span><span class="sc0">
</span><span class="sc1">;           AriOP AX,imm16          81h</span><span class="sc0">
</span><span class="sc1">;           AriOP AL,imm8           80h</span><span class="sc0">
</span><span class="sc1">;           inc/dec Reg16           FFh</span><span class="sc0">
</span><span class="sc1">;           test al,ax          F6h, F7h</span><span class="sc0">

</span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">a</span><span class="sc4">,</span><span class="sc5">b</span><span class="sc0">
        </span><span class="sc5">PUSHSTATE</span><span class="sc0">
        </span><span class="sc2">.386</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">b</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">optimise_table</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc5">POPSTATE</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">optimise_table</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_68</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_C0</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_C0</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_81</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_80</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_F6</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_F7</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_FF</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_sego</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opt_sego</span><span class="sc0">
            </span><span class="sc5">Optimise_Item</span><span class="sc0">   </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">null_func</span><span class="sc0">
</span><span class="sc5">no_of_optimisers</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">optimise_table</span><span class="sc4">)/</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:bx = start of instruction</span><span class="sc0">
</span><span class="sc1">; es:di = end of instruction</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = new end of instruction</span><span class="sc0">

</span><span class="sc5">optimise</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">OPTIMISE</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">optimise_table</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">no_of_optimisers</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">pushf</span><span class="sc0">
             </span><span class="sc6">lodsw</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">optimise_table</span><span class="sc0">
             </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">LUNE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; 068h - PUSH imm16</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">opt_68</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_ax_signed</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">06Ah</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; C0h,C1h - ShiftOP ModRM, imm8</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">opt_C0</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0Fh</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; 80h - AriOP ModRM, imm8</span><span class="sc0">
            </span><span class="sc1">;           </span><span class="sc0">
    </span><span class="sc5">opt_80</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_REG</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NB</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
             </span><span class="sc5">ANDIF</span><span class="sc0">  </span><span class="sc5">Z</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000100b</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; 81h - AriOP ModRM, imm16</span><span class="sc0">
            </span><span class="sc1">;           </span><span class="sc0">
    </span><span class="sc5">opt_81</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_REG</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">AE</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
             </span><span class="sc5">ANDIF</span><span class="sc0">  </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc1">; Use special AX ops.</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000101b</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.2</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc1">; Sign imm16.</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ax = imm arg</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_ax_signed</span><span class="sc0">    </span><span class="sc1">; check if sign extendable</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; ignore high byte</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">83h</span><span class="sc0">  </span><span class="sc1">; sign it</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------   </span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; FFh - inc/dec ModRM</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">opt_FF</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc2">0C0h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">AE</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
             </span><span class="sc5">ANDIF</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">; F6h - test al</span><span class="sc0">
            </span><span class="sc1">; F7h - test ax</span><span class="sc0">
    </span><span class="sc5">opt_F6</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">opt_F7</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">],</span><span class="sc5">rm_REG</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">_TEST</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">_AX</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.1</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],(</span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc4">)</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
            </span><span class="sc1">;Segment Overrides</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">opt_sego</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bx.2</span><span class="sc4">],</span><span class="sc2">0C0h</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc5">ANDIF</span><span class="sc0">  </span><span class="sc5">PE</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc9">NE</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">optimise</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;= Register Management ======================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ax = regs usage mask</span><span class="sc0">

</span><span class="sc5">get_reg8_mask</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg16</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ax = regs usage mask</span><span class="sc0">

</span><span class="sc5">get_reg16_mask</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg8_mask</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_AL</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_AH</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_SP</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">AE</span><span class="sc0">
             </span><span class="sc1">;;mov  cl,(BIT (_AH - _AL))</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; register allocated</span><span class="sc0">

</span><span class="sc5">allocate_reg8</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg8_mask</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__areg</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg16</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; register allocated</span><span class="sc0">

</span><span class="sc5">allocate_reg16</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg16_mask</span><span class="sc0">
    </span><span class="sc5">__areg</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = unused reg8</span><span class="sc0">

</span><span class="sc5">get_free_reg8</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;STATUS &lt;GET_FREE_REG8&gt;</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">get_reg8_mask</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gfreg</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = unused reg16</span><span class="sc0">

</span><span class="sc5">get_free_reg16</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;STATUS &lt;GET_FREE_REG16&gt;</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">get_reg16_mask</span><span class="sc0">
    </span><span class="sc5">__gfreg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand7</span><span class="sc0">           
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= Misc. ====================================================================</span><span class="sc0">
</span><span class="sc5">crypt_done</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00111110b</span><span class="sc0">
</span><span class="sc5">mods_done</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11111101b</span><span class="sc0">
</span><span class="sc5">loadtxt_done</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11111011b</span><span class="sc0">
</span><span class="sc5">savetxt_done</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11110111b</span><span class="sc0">
</span><span class="sc5">incptr_done</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11101111b</span><span class="sc0">
</span><span class="sc5">deccount_done</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11011111b</span><span class="sc0">

</span><span class="sc5">loopr_list</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">create_encryptor</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">routine_type</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">make_mod</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">inc_ptr</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">dec_count</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">load_plaintxt</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">save_plaintxt</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">initptr_done</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">00000110b</span><span class="sc0">
</span><span class="sc5">initcount_done</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11111101b</span><span class="sc0">
</span><span class="sc5">initkey_done</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">11111011b</span><span class="sc0">

</span><span class="sc5">initr_list</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">34</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">load_key</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">load_ptr</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">dbw</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">load_count</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;-Randomize Order of Steps---------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; si = percentage weighted list of steps</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; they get run randomly.. duh.</span><span class="sc0">

</span><span class="sc5">do_steps</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">percent_ax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ax = whateva</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ZF = AX is signable</span><span class="sc0">

</span><span class="sc5">is_ax_signed</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">cbw</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-Pick Option from List------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; si = op list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = op</span><span class="sc0">
</span><span class="sc1">; si = end of op list</span><span class="sc0">

</span><span class="sc5">pick_op</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">  
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">cbw</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-Pick Option from Percentage weighted List----------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:si = percentage table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; ax = selection</span><span class="sc0">
</span><span class="sc1">; si destroyed</span><span class="sc0">

</span><span class="sc5">percent_ax</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand_b</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NC</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">

</span><span class="sc5">plaintxt_to_index</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_dblref</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_plaintxt.2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_plaintxt</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Routines to Load Registers ***********************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg8</span><span class="sc0">
</span><span class="sc1">; bl = value to load</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of construction</span><span class="sc0">

</span><span class="sc5">load8</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__load</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg16</span><span class="sc0">
</span><span class="sc1">; bx = value to load</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of construction</span><span class="sc0">

</span><span class="sc5">load16</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc5">__load</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">Z</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">     </span><span class="sc1">; MOV reg16,xxxx</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
               </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
                 </span><span class="sc6">stosb</span><span class="sc0">
                 </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc5">DOELSE</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                 </span><span class="sc6">stosw</span><span class="sc0">
               </span><span class="sc5">DONE</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero R, add/or/xor r,xxxx</span><span class="sc0">
               </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zero_reg</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_fake_mov</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rm_Reg</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
               </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
               </span><span class="sc6">stosw</span><span class="sc0">
               </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
               </span><span class="sc6">stosw</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
               </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
               </span><span class="sc5">DONE</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">optimise</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ax = reg8/reg16 ModRM style (AH's 0C0h not needed)</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">zero_reg</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">zero_reg_script</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">zero_test_reg</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">zero_reg_script</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_AND</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ax = reg8/reg16 ModRM style (AH's 0C0h not needed)</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">
                        

</span><span class="sc5">test_reg_script</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_AND</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">       </span><span class="sc1">; 84h=test R,RM</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_CMP</span><span class="sc0">

</span><span class="sc5">test_reg</span><span class="sc4">:</span><span class="sc0">       
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">test_reg_script</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ax = reg8/reg16 ModRM style (AH's 0C0h not needed)</span><span class="sc0">
</span><span class="sc1">; si = script (zero_reg_script or test_reg_script)</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">zero_test_reg</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; BX=xx000Rrr 0000000w</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pick_op</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; AX=xx000Rrr 0000000w</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">       </span><span class="sc1">; AX=xx000Rrr 00Iii00w</span><span class="sc0">
              </span><span class="sc6">stosb</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">   </span><span class="sc1">; AX=xx000Rrr 11000000</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; AX=00000Rrr 11000000</span><span class="sc0">
              </span><span class="sc6">aad</span><span class="sc0">   </span><span class="sc2">9</span><span class="sc0">           </span><span class="sc1">; AL = AH + (AL*9)</span><span class="sc0">
             </span><span class="sc5">DOELSE</span><span class="sc0">         </span><span class="sc1">; AL=11RrrRrr</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">pick_op</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rm_Reg</span><span class="sc0">  </span><span class="sc1">; AriOp8, reg ModRM</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">           </span><span class="sc1">; reg added</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">NZ</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">      </span><span class="sc1">; signed16</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; CommandByte 1st</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">         </span><span class="sc1">; stored</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">  
            </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;    00Iii00w 11RrrRrr stored</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">@lcntr</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= Object specific stuf =====================================================</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">load_count</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">initcount_done</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@lcntr</span><span class="sc0">          
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">initcount_done</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">count_bytes</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_mul</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_meth</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           
            </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc10">C</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
             </span><span class="sc9">org</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">loop_table.si.bx.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_count.1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">lptrcnt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">load16</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">load_ptr</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">initptr_done</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@txtr</span><span class="sc0">          
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">initptr_done</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">crypt_start</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_backward</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_bytes</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_ptr.1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">lptrcntkey</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">lptrcnt</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">load_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">initkey_done</span><span class="sc0">
        </span><span class="sc5">@@txtr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@txtr</span><span class="sc0">           
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">initkey_done</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">initial_key</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_key.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lptrcntkey</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">load8</span><span class="sc0">

</span><span class="sc1">;= RegMem/MemReg warez ======================================================</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">save_plaintxt</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc1">; crypt=0, savetxt=1</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">savetxt_done</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">savetxt_done</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">crypt_done</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@txtr</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_plaintxt</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
            </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">sptxt_exit_b</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc0">     </span><span class="sc1">; MOV M,R</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mtr_put_b</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">load_plaintxt</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">loadtxt_done</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
    </span><span class="sc5">@txtr</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">                        
            </span><span class="sc5">DONE</span><span class="sc0">

            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">loadtxt_done</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble4</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_index</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_plaintxt</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
    </span><span class="sc5">sptxt_exit_b</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">null_func</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc1">; MOV R,M</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Ah</span><span class="sc0">     </span><span class="sc1">; al = command, ah = reg</span><span class="sc0">
              </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">mtr_put_b</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">probability</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">S</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">086h</span><span class="sc0">     </span><span class="sc1">; XCHG R,M</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">mtr_put</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc5">STO_B</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc0">        </span><span class="sc1">; CS:</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">shl</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">38FFh</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">store_m_ofs</span><span class="sc0">
</span><span class="sc5">null_func</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc1">;DOELSE</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">zero_reg</span><span class="sc0">    </span><span class="sc1">; Zero R, ADD/OR/ADC/XOR R,M</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">choose_fake_mov</span><span class="sc0"> </span><span class="sc1">; al = command</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">       </span><span class="sc1">; ah = reg</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">mtr_put</span><span class="sc0">
             </span><span class="sc1">;DONE</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = fake mov op</span><span class="sc0">

</span><span class="sc5">choose_fake_mov</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">_SBB</span><span class="sc0">     </span><span class="sc1">; add/or/adc/sbb</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_SBB</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_XOR</span><span class="sc0">     </span><span class="sc1">; add/or/adc/xor</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Crypt Routines ***********************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:bx = Crypt Script</span><span class="sc0">
</span><span class="sc1">; es:di = Construction Buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of construction</span><span class="sc0">
</span><span class="sc1">; bx = end of script</span><span class="sc0">

</span><span class="sc5">create_decryptor</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc1">;loadtxt=0, crypt=1</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">crypt_done</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">loadtxt_done</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">crypt_done</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">get_crypt_level</span><span class="sc0">         
             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">make_crypt_op</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">garble1</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">LU</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; ds:bx = End of Crypt Script</span><span class="sc0">
</span><span class="sc1">; es:di = Construction Buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of construction</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Encryptor:</span><span class="sc0">
</span><span class="sc1">;       JMP LOC1</span><span class="sc0">
</span><span class="sc1">;   LOC3:   JMP LOC2    </span><span class="sc0">
</span><span class="sc1">;       ENC1</span><span class="sc0">
</span><span class="sc1">;       JMP LOC3</span><span class="sc0">
</span><span class="sc1">;       ENC2</span><span class="sc0">
</span><span class="sc1">;       JMP ENC1</span><span class="sc0">
</span><span class="sc1">;       ENC3</span><span class="sc0">
</span><span class="sc1">;       JMP ENC2</span><span class="sc0">
</span><span class="sc1">;   LOC1:   ENC4</span><span class="sc0">
</span><span class="sc1">;       JMP ENC3</span><span class="sc0">
</span><span class="sc1">;   LOC2:   ...</span><span class="sc0">

</span><span class="sc5">create_encryptor</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc1">;loadtxt=0, crypt=1</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">crypt_done</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">loadtxt_done</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">crypt_done</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_seed</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">_encode_jmp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; save loc1 reloc</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">_encode_jmp</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; save loc2 reloc</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">e_seed</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">get_crypt_level</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">stc</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">make_crypt_op</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_seed</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">encode_jmp</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">e_seed</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">LU</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = code construct buffer</span><span class="sc0">
</span><span class="sc1">; NC for decryptor, CF for encryptor</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc1">; During Execution:</span><span class="sc0">
</span><span class="sc1">; -----------------</span><span class="sc0">
</span><span class="sc1">; ax = CryptOp</span><span class="sc0">
</span><span class="sc1">; si = ofs object</span><span class="sc0">
</span><span class="sc1">; cl = enc/dec</span><span class="sc0">
</span><span class="sc1">; ch -&gt; op to use</span><span class="sc0">

</span><span class="sc5">make_crypt_op</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MAKE_CRYPT_OP</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crypt_obj</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_plaintxt</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">mod_crypt_switch</span><span class="sc4">],</span><span class="sc5">mods_and_crypts</span><span class="sc0">
    </span><span class="sc5">make_modcryp</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">STO_B</span><span class="sc0">   </span><span class="sc2">02Eh</span><span class="sc0">        </span><span class="sc1">; CS:</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">crypt_ops</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">percent_ax</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">last_crypt_op</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_crypt_op</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">crypt_obj</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand_b</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; op2 -&gt; op1</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00011100b</span><span class="sc0">
            </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; creating byte 0</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NC</span><span class="sc0">      </span><span class="sc1">; store op in byte 1?</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; di.1 = place to store reg2</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">       </span><span class="sc1">; creating byte 1</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">               
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_m_ofs</span><span class="sc0"> </span><span class="sc1">; add ModRM ofs</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; arguments</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">     </span><span class="sc5">NZ</span><span class="sc0">     </span><span class="sc1">; 0 ( No arg)</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">     </span><span class="sc5">PO</span><span class="sc0">        </span><span class="sc1">; 3 ( Reg )</span><span class="sc0">
               </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">        </span><span class="sc1">; 1 or 2?</span><span class="sc0">
               </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">    </span><span class="sc1">; 1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
               </span><span class="sc5">DONE</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">
               </span><span class="sc1">; Register Args</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc5">DO</span><span class="sc0">
                 </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc1">; ** Pick a register. **</span><span class="sc0">
                 </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">rand7</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
                 </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">A</span><span class="sc0">
                  </span><span class="sc1">;</span><span class="sc0">
                  </span><span class="sc1">; ** 1/4 chance of enforced Key. **</span><span class="sc0">
                  </span><span class="sc1">;</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_key.1</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                 </span><span class="sc5">DONE</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">get_reg16_mask</span><span class="sc0">
                 </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
                 </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc9">low</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">get_reg8_mask</span><span class="sc0">
                 </span><span class="sc5">DONE</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">REPEAT</span><span class="sc0">   </span><span class="sc9">NE</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_SP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_AH</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">REPEAT</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_plaintxt.1</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
                </span><span class="sc9">REPEAT</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_key.1</span><span class="sc4">]</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
               </span><span class="sc5">CYCLE</span><span class="sc0">     </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">mod_crypt_switch</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">         </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">mods_only</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">         </span><span class="sc5">_JZ</span><span class="sc0">
</span><span class="sc5">mods_and_crypts</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">         </span><span class="sc2">03Ch</span><span class="sc0">   </span><span class="sc1">; cmp al</span><span class="sc0">
               </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">bp.1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; encode reg2</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">optimise</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
 
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = end of construction</span><span class="sc0">

</span><span class="sc5">make_mod</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MAKE_MOD</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)&gt;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">mods_done</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc5">STATUS</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DONE</span><span class="sc4">&gt;</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crypt_obj</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">m_key</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">get_crypt_level</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">mod_crypt_switch</span><span class="sc4">],</span><span class="sc5">mods_only</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">make_modcryp</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">garble1</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">LU</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">mods_done</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; cx = crypt / mod level</span><span class="sc0">

</span><span class="sc5">get_crypt_level</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand7</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; CRYPT OPS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ca_none</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; No Parameter</span><span class="sc0">
</span><span class="sc5">ca_byte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; 8 bit Parameter</span><span class="sc0">
</span><span class="sc5">ca_bw</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; 8 bit for byte, 16 bit for word Parameter</span><span class="sc0">
</span><span class="sc5">ca_reg</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Register Parameter</span><span class="sc0">

</span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">Probability</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OpByte</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Command</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ArgType</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">Probability</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc5">Command</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OpByte</span><span class="sc4">),</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Op2</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Op1</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">ArgType</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">crypt_ops</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_bw</span><span class="sc0">  
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_bw</span><span class="sc0">  
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_NOT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_NOT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_none</span><span class="sc0">    
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_NEG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_NEG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_none</span><span class="sc0">    
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_INC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_DEC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_none</span><span class="sc0">    
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ROL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ROR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_none</span><span class="sc0">    
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ROL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ROR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_byte</span><span class="sc0">    
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">35</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_reg</span><span class="sc0"> 
    </span><span class="sc5">CryptOp</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ca_reg</span><span class="sc0"> 

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Loop Stuff ***************************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; bx = top of loop</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">encode_loop</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">ENCODE_LOOP</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_count</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_reg</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_meth</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
            </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; * 5</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">loop_table</span><span class="sc0">
            </span><span class="sc6">xlat</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_ax_signed</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">garble1</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">encode_jmp</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
             </span><span class="sc1">;DOELSE</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc1">;DONE</span><span class="sc0">
                    
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; db JconOP</span><span class="sc0">
</span><span class="sc1">; dw X - Count (INC), Y + Count (DEC)</span><span class="sc0">
</span><span class="sc1">; X = Lower boundary of range where condition untrue.</span><span class="sc0">
</span><span class="sc1">; Y = Upper boundary of range where condition untrue.</span><span class="sc0">

</span><span class="sc5">loop_table</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">_JNZ</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">_JS</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">07FFFh</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">_JNS</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
            
</span><span class="sc1">;= counter/ptr inc dec ======================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">inc_ptr</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">INC_PTR</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)&gt;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">incptr_done</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@licr</span><span class="sc0">
            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">DONE</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">incptr_done</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_backward</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                        
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">rm_08</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">is_ax_signed</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">rm_08</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc5">rm_16</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">iBP</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_index.1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">plaintxt_to_index</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_ptr.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_word</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_backward</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dcip</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">dec_count</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">DEC_COUNT</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)&gt;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">deccount_done</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
    </span><span class="sc5">@licr</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">DONE</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_done</span><span class="sc4">],</span><span class="sc5">deccount_done</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">m_count.1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">count_mul</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_meth</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">dcip</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; al = reg16 OR 40h (INC) / 48h (dec)</span><span class="sc0">
</span><span class="sc1">; bl = amount to inc / dec</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">encode_inc_dec</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">ENCODE_INC_DEC</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc1">;DO</span><span class="sc0">
    </span><span class="sc5">@incdecl</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand_b</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
               </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc1">; ** ADD/SUB **</span><span class="sc0">
               </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
               </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">probability</span><span class="sc0">
               </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">S</span><span class="sc0">
                 </span><span class="sc1">; - Single</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                 </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,((</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">)</span><span class="sc0">
                 </span><span class="sc5">DONE</span><span class="sc0">
                 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,(</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">probability</span><span class="sc0">
                 </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
                  </span><span class="sc6">neg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,(</span><span class="sc5">_ADD</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">)</span><span class="sc0">
                 </span><span class="sc5">DONE</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                 </span><span class="sc6">stosw</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">stosb</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">garble1</span><span class="sc0">
                </span><span class="sc5">DOELSE</span><span class="sc0">
                 </span><span class="sc1">; - Multiple</span><span class="sc0">
                 </span><span class="sc6">cbw</span><span class="sc0">
                 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                 </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
                  </span><span class="sc6">neg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc5">DONE</span><span class="sc0">
                 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand_b</span><span class="sc0">
                 </span><span class="sc6">cwd</span><span class="sc0">
                 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc5">DO</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                  </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000011100000000b</span><span class="sc0">
                  </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">rm_Reg</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_ADD</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
    </span><span class="sc5">@@incdecl</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">@incdecl</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                   </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                  </span><span class="sc5">DONE</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">probability</span><span class="sc0">
                  </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">PO</span><span class="sc0">
                   </span><span class="sc6">neg</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
                   </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc5">_ADD</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc5">_SUB</span><span class="sc4">)</span><span class="sc0">
                  </span><span class="sc5">DONE</span><span class="sc0">
                  </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">stosw</span><span class="sc0">
                  </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">stosw</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">optimise</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">garble1</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
                 </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">LU</span><span class="sc0">
               </span><span class="sc5">DONE</span><span class="sc0">

              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc1">; ** INC/DEC **</span><span class="sc0">
               </span><span class="sc1">;</span><span class="sc0">
               </span><span class="sc5">STO_B</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">garble1</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc1">;JUMPS</span><span class="sc0">
    </span><span class="sc1">;       CYCLE   NZ</span><span class="sc0">
    </span><span class="sc1">;NOJUMPS         ;</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">@@incdecl</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Jump Stuff ***************************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; bx = jmp dest</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">encode_jmp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_encode_jmp</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
             
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = ret type</span><span class="sc0">
</span><span class="sc1">; es:bx = relocation position</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">_encode_push</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">A</span><span class="sc0">       </span><span class="sc1">; e=ret, c=retf, nsne=iret</span><span class="sc0">
             </span><span class="sc5">STO_B</span><span class="sc0">  </span><span class="sc2">09Ch</span><span class="sc0">        </span><span class="sc1">; pushf</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc9">NE</span><span class="sc0">
             </span><span class="sc5">STO_B</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0">     </span><span class="sc1">; push cs</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc1">; push imm</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">PO</span><span class="sc0">
              </span><span class="sc5">STO_B</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc0">            
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
             </span><span class="sc1">; or mov reg, push reg</span><span class="sc0">
             </span><span class="sc5">DOELSE</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">load16_reloc</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc0">
              </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">     </span><span class="sc1">; ret</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc0">     </span><span class="sc1">; retf</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NC</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CFh</span><span class="sc0">     </span><span class="sc1">; iret</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; es:bx = relocation position</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">_encode_jmp</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">BE</span><span class="sc0">
              </span><span class="sc5">STO_B</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
              </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">neg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">          
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
             </span><span class="sc1">;DOELSEIF S</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">S</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">_encode_push</span><span class="sc0">
              </span><span class="sc6">stosb</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc1">;DOELSE</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">load16_reloc</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E0FFh</span><span class="sc0">
              </span><span class="sc6">stosw</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc1">;DONE</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al = ret type</span><span class="sc0">
</span><span class="sc1">; es:bx = relocation position</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">_encode_call</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">A</span><span class="sc0">
             </span><span class="sc5">STO_B</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_encode_push</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_encode_jmp</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; es:di = construction buffer</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; al=reg16</span><span class="sc0">
</span><span class="sc1">; es:bx = relocation position</span><span class="sc0">
</span><span class="sc1">; es:di = construction complete</span><span class="sc0">

</span><span class="sc5">load16_reloc</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_free_reg16</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load16</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Junk Routines ************************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">no_garble</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">101</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">null_func</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">jmp_garble</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">many_junk_ops</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">dos_garble</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">many_junk_ops</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_jcond</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_loop</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_push_pop</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">05</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_anti_emul0</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_anti_emul1</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_int</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">,&lt;</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_jmp_call</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">garble4</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">garble</span><span class="sc0">
</span><span class="sc5">garble1</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">garble</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">GARBLING</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        
            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GARBLE</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_seed</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">garble_routines</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">percent_ax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">LU</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= Different Junk structures ================================================</span><span class="sc0">

</span><span class="sc5">many_junk_ops</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">GARBLE_MANY_JUNK_OPS</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MANY_JUNK_OPS</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand_b</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">A</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08A00h</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">_@mjo_do</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc1">;call  probability</span><span class="sc0">
    </span><span class="sc1">;========================================================</span><span class="sc0">
         </span><span class="sc9">IFDEF</span><span class="sc0">  </span><span class="sc5">GARBLE_RM</span><span class="sc0">
            </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">GARBLE_IMM</span><span class="sc0">
             </span><span class="sc6">jpo</span><span class="sc0">    </span><span class="sc5">@mjo_imm</span><span class="sc0">
            </span><span class="sc9">ENDIF</span><span class="sc0">

             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_CMP</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">@@mjo_do</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

    </span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_IMM</span><span class="sc0">

    </span><span class="sc5">@mjo_imm</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">@mjo_n80</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">         </span><span class="sc1">; 80h</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_CMP</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc5">_@mjo_do</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">@mjo_do</span><span class="sc0">

    </span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
    </span><span class="sc5">@mjo_n80</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jo</span><span class="sc0"> </span><span class="sc5">@mjo_nD0C0</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">         </span><span class="sc1">; 0D0h,0D2h,0C0h</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">any_rand</span><span class="sc0">
               </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1200h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0000000000111000b</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C2h</span><span class="sc0">
              </span><span class="sc9">REPEAT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_SAL</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">@mjo_do</span><span class="sc0">

    </span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
    </span><span class="sc5">@mjo_nD0C0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">any_rand</span><span class="sc0">    </span><span class="sc1">; 0F6h, 0FEh</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00010000b</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">

        </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc1">;========================================================</span><span class="sc0">
    </span><span class="sc5">@mjo_do</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">@@mjo_do</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">make_junk_op</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">optimise</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NS</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_jcond</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_JCOND</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_JCOND</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">BE</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_cmp</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">percent_ax</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">make_junk_op</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">optimise</span><span class="sc0">
             </span><span class="sc5">DOELSE</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0701h</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">test_reg</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_junk_ops</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">junk_cmp</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc4">,</span><span class="sc2">3880h</span><span class="sc0">    </span><span class="sc1">; CMP  R,imm</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">,</span><span class="sc2">0038h</span><span class="sc0">    </span><span class="sc1">; CMP  R,M</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">,</span><span class="sc2">003Ah</span><span class="sc0">    </span><span class="sc1">; CMP  M,R</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">00F6h</span><span class="sc0">    </span><span class="sc1">; TEST R,imm</span><span class="sc0">
            </span><span class="sc5">dbw</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc4">,</span><span class="sc2">0084h</span><span class="sc0">    </span><span class="sc1">; TEST R,M</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_LOOP</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_LOOP</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CX</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_bh</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">120</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand_b</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CL</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CH</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_CX</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load16</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_junk_ops</span><span class="sc0">
            </span><span class="sc5">STO_B</span><span class="sc0">   </span><span class="sc2">0E2h</span><span class="sc0">        </span><span class="sc1">; loop</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">stc</span><span class="sc0">
            </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CX</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pop_bh</span><span class="sc0">          
        </span><span class="sc9">ELSE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;   sti     cli</span><span class="sc0">
</span><span class="sc1">;   push 0</span><span class="sc0">
</span><span class="sc1">;   pop reg0</span><span class="sc0">
</span><span class="sc1">;l1:SP -= 2</span><span class="sc0">
</span><span class="sc1">;   pop reg1</span><span class="sc0">
</span><span class="sc1">;   test reg1</span><span class="sc0">
</span><span class="sc1">;   jz l1   jnz</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_anti_emul0</span><span class="sc4">:</span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_ANTI_EMUL0</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_ANTI_EMUL0</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0">     </span><span class="sc1">; STI</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">probability</span><span class="sc0">
             </span><span class="sc6">pushf</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc10">C</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; CLI</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">S</span><span class="sc0">
               </span><span class="sc5">STO_W</span><span class="sc0">    </span><span class="sc2">006Ah</span><span class="sc0">       </span><span class="sc1">; PUSH 0</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg16</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
               </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zero_reg</span><span class="sc0">    </span><span class="sc1">; zero reg0</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">      </span><span class="sc1">; PUSH reg0</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_free_reg16</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">      </span><span class="sc1">; POP reg1</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">probability</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">O</span><span class="sc0">
               </span><span class="sc5">STO_W</span><span class="sc0">  </span><span class="sc2">04C4Ch</span><span class="sc0">    </span><span class="sc1">; DEC SP, DEC SP</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">               
               </span><span class="sc5">STO_W</span><span class="sc0">  </span><span class="sc2">0EC83h</span><span class="sc0">    </span><span class="sc1">; SUB SP,</span><span class="sc0">
               </span><span class="sc5">STO_B</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; +02</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">get_free_reg16</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">      </span><span class="sc1">; POP reg2</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">)</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">test_reg</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">popf</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_JZ</span><span class="sc0">
             </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; JNZ</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">stc</span><span class="sc0">
             </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">          </span><span class="sc1">; $-xx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; mov ax,xxxx</span><span class="sc0">
</span><span class="sc1">; aam / aad</span><span class="sc0">
</span><span class="sc1">; cmp ax,xxxx</span><span class="sc0">
</span><span class="sc1">; je loc1</span><span class="sc0">
</span><span class="sc1">; jmp far / terminate</span><span class="sc0">
</span><span class="sc1">; loc1:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_anti_emul1</span><span class="sc4">:</span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_ANTI_EMUL1</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_ANTI_EMUL1</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">junk_anti_emul2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_AX</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_bh</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01F7Fh</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00101h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jae_ax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load16</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D4h</span><span class="sc0">     </span><span class="sc1">; AAM</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B00h</span><span class="sc0">    </span><span class="sc1">; AAD on CF</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jae_op</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">any_rand</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; XOR/CMP/SUB AX,imm</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">jae_ax</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">jae_op</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">aam</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_AX</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_bh</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_JNZ</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_anti_emul2</span><span class="sc4">:</span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_ANTI_EMUL2</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_ANTI_EMUL2</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CX</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_DI</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_SI</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_bh</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_SI</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; _DI</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc0">     </span><span class="sc1">; so we can do MOVSW</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load16</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F789h</span><span class="sc0">   </span><span class="sc1">; MOV DI,SI</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc10">C</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">     </span><span class="sc1">; MOV SI,DI</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_CX</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load16</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A5F3h</span><span class="sc0">   </span><span class="sc1">; rep movsw</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">S</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; movsb</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_CX</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_DI</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_SI</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pop_bh</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_int</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_INT</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_INT</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc5">pf_inloop</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_ints</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">no_of_junk_ints_loop</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">Z</span><span class="sc0">
              </span><span class="sc6">popf</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">BE</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_int_cfdx</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">no_of_junk_ints</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">DOELSE</span><span class="sc0">
              </span><span class="sc6">popf</span><span class="sc0">
              </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">junk_anti_emul2</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_int_cfdx</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">lodsw</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_bh</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_AH</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load8</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">AE</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand_b</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_DX</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">load16</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">probability</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">S</span><span class="sc0">
              </span><span class="sc5">DO</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg16</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">zero_reg</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc5">STO_B</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">STO_W</span><span class="sc0">   </span><span class="sc2">021CDh</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_bh</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">AE</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">any_rand</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_JNC</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">    
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">_ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_regs</span><span class="sc0">
         </span><span class="sc9">local</span><span class="sc0">  </span><span class="sc5">_x</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">_ah</span><span class="sc0">
         </span><span class="sc5">_x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_AX</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">_y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_regs</span><span class="sc4">&gt;</span><span class="sc0">
          </span><span class="sc5">_x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_x</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BIT</span><span class="sc0"> </span><span class="sc5">_y</span><span class="sc4">))</span><span class="sc0">
         </span><span class="sc9">ENDM</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc0">

        </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc5">junk_ints</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">30h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_CX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_BX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_BX</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">no_of_junk_ints_loop</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc4">((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_ints</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">junk_int_cfdx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">3Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">3Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">41h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">4Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">int_call</span><span class="sc0">    </span><span class="sc2">5Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_DX</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">no_of_junk_ints</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">((</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_int_cfdx</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_push_pop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_PUSH_POP</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_PUSH_POP</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand7</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">O</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">36FFh</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand_b</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_junk_ops</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_free_reg16</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">junk_routine_entry</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">

    </span><span class="sc5">j_reloc</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">j_used_regs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">j_return</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">j_use_ret</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">j_poly_flags</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">junk_routine_entry</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">junk_jmp_call</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_JMP_CALL</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">JUNK_JMP_CALL</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">junk_rout_ptr</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">JUNK_ROUT_MAX</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">B</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">probability</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">S</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_encode_jmp</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc5">DOELSE</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_encode_call</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.junk_rout_table.j_use_ret</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.junk_rout_table.j_return</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.junk_rout_table.j_reloc</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.junk_rout_table.j_used_regs</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.junk_rout_table.j_poly_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">junk_rout_ptr</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">

        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">make_junk_routs</span><span class="sc4">:</span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_JMP_CALL</span><span class="sc0">

            </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MAKE_JUNK_ROUTS</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garble_routines</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">jmp_garble</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">junk_rout_ptr</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc5">DOWHILE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">))</span><span class="sc5">.junk_rout_table.j_reloc</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">))</span><span class="sc5">.junk_rout_table.j_used_regs</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">))</span><span class="sc5">.junk_rout_table.j_poly_flags</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">))</span><span class="sc5">.junk_rout_table.j_use_ret</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc4">))</span><span class="sc5">.junk_rout_table.j_return</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">garble1</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">Z</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">encode_jmp</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
              </span><span class="sc9">org</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">           
             </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; AX = ModRM style opcode.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; opcode emited.</span><span class="sc0">

</span><span class="sc5">make_junk_op</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">STATUS</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MAKE_JUNK_OP</span><span class="sc4">&gt;</span><span class="sc0">

            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; bx=opcode</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">get_free_reg16</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_REG8</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">probability</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">A</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs.bLO</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc0">
               </span><span class="sc5">ANDIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg8</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
              
        </span><span class="sc9">ENDIF</span><span class="sc0">

             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; ax=ModRM</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">last_junk_reg</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_junk_reg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">S</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">A</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
              </span><span class="sc6">cmc</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">BREAK</span><span class="sc0">  </span><span class="sc5">NC</span><span class="sc0">
             </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc1">; ** Immediate Ops **</span><span class="sc0">
             </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">          </span><span class="sc1">; emit opcode/RM</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">00F6h</span><span class="sc0">    </span><span class="sc1">; TEST r,imm</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
              </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">)</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">B</span><span class="sc0">
        </span><span class="sc5">@mjoar</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
              </span><span class="sc6">stosb</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
               </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
               </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">@mjoar</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">optimise</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc1">; *** ModRM Ops ***</span><span class="sc0">
             </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">S</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">   </span><span class="sc1">; bl=opcode, ax=ModRM</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; bh = reg</span><span class="sc0">
            </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_RM_MEM</span><span class="sc0">
            </span><span class="sc6">js</span><span class="sc0">  </span><span class="sc5">@mjrm_mem</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_RM_REG</span><span class="sc0">

            </span><span class="sc1">; register          </span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rand7</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">rm_Reg</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@mjrm_do</span><span class="sc0">

        </span><span class="sc9">ENDIF</span><span class="sc0">
            </span><span class="sc1">; mem</span><span class="sc0">
    </span><span class="sc5">@mjrm_mem</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_RM_IMM</span><span class="sc0">
            </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">@mjrm_imm16</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">GARBLE_RM_MEM</span><span class="sc0">

            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; no word ptr's</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@mjrm_imm16</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">rand7</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">iBP</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">probability</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc5">S</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">A</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">@@mjrm_do</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@mjrm_do</span><span class="sc0">

    </span><span class="sc5">@mjrm_imm16</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; imm16</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
         </span><span class="sc5">@@mjrm_do</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc9">ENDIF</span><span class="sc0">

            </span><span class="sc1">; al=R/M, DX=parameter bytes</span><span class="sc0">
    </span><span class="sc5">@mjrm_do</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc5">DO</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">any_rand</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">by</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc5">CYCLE</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NS</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">push_bh</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc10">C</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_reg16_mask</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">NZ</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pop_bh</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc10">C</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">get_reg16_mask</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">NZ</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
               </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
               </span><span class="sc6">stosb</span><span class="sc0">
              </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc5">DONE</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Random Number Stuff ******************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; Flags = Random</span><span class="sc0">

</span><span class="sc5">probability</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">rand7</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">any_rand</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">rand_b</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cbw</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; AX = exclusive MAX limit (0 for anything)</span><span class="sc0">
</span><span class="sc1">; RNG_SEED set</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; AX = 0 &lt;= Return &lt; Input AX</span><span class="sc0">
</span><span class="sc1">; Flags = result of SAHF</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">rand</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rng_seed</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.wLO</span><span class="sc4">]</span><span class="sc0">   
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.wHI</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; load seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">17</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">           </span><span class="sc1">; shift feedback loop</span><span class="sc0">
         </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">S</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc5">DONE</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01010111b</span><span class="sc0">
         </span><span class="sc5">DOIF</span><span class="sc0">   </span><span class="sc5">PO</span><span class="sc0">
          </span><span class="sc6">stc</span><span class="sc0">
         </span><span class="sc5">DONE</span><span class="sc0">
         </span><span class="sc6">rcr</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                
         </span><span class="sc6">rcr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.wHI</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; save seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.wLO</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; normalise</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">@rng0</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">@rng0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">                </span><span class="sc1">; set flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;= RNG initilisation ========================================================</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; none.</span><span class="sc0">

</span><span class="sc5">init_rng_seeds</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rng_seed</span><span class="sc4">],</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">master_seed</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs</span><span class="sc0"> </span><span class="sc5">junk_seed</span><span class="sc0">
            </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; junk</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_dual_rng</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">      </span><span class="sc1">; e, d</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; rand32 XOR cx = 32 bit seed</span><span class="sc0">
</span><span class="sc1">; ds:si, ds:si.bx = seeds to init</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; si += 4</span><span class="sc0">
</span><span class="sc1">; ax &lt;=&gt; dx</span><span class="sc0">
</span><span class="sc1">; both seeds loaded</span><span class="sc0">

</span><span class="sc5">init_dual_rng</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">any_rand</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc5">wo</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">bx.si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">cmc</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc10">C</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0"> 
</span><span class="sc5">ENGINE_END</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;* Heap *********************************************************************</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">poly_flags</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_done</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">count_meth</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">after_jmp</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; ModRM objects</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">m_ptr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;           -\__ Reg16s</span><span class="sc0">
</span><span class="sc5">m_count</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;       -/      </span><span class="sc0">
</span><span class="sc5">m_index</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;                   -\ Same Size</span><span class="sc0">
</span><span class="sc5">m_key</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;             - Reg  -</span><span class="sc0">
</span><span class="sc5">m_plaintxt</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; (possibly m_index)-/</span><span class="sc0">

</span><span class="sc5">used_regs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">master_seed</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">junk_seed</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">d_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">e_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">junk_rout_ptr</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">junk_rout_table</span><span class="sc0"> </span><span class="sc5">junk_routine_entry</span><span class="sc0">  </span><span class="sc5">JUNK_ROUT_MAX</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;============================================================================</span></div></body>
</html>
