<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>DROPSY.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;DROPSY TEXT effect for Nowhere Man's VCL - TASM will assemble as is using</span><span class="sc0">
</span><span class="sc1">;VCL recommended switches.  When screen is thoroughly dropsie'd, that is all</span><span class="sc0">
</span><span class="sc1">;letters have fallen to a single line across the bottom of the monitor,</span><span class="sc0">
</span><span class="sc1">;the routine will exit to DOS and restore the command prompt. I excerpted</span><span class="sc0">
</span><span class="sc1">;quite a bit of this from some public domain video routines optimized for</span><span class="sc0">
</span><span class="sc1">;the accursed a86 assembler and reworked the whole magilla until TASM</span><span class="sc0">
</span><span class="sc1">;wouldn't choke when swallowing the source. It attempts to meet </span><span class="sc0">
</span><span class="sc1">;minimum requirements for VCL formatting. Heck, this is a nice routine</span><span class="sc0">
</span><span class="sc1">;to have at your fingertips; you gotta admit a CASCADE-virus-like effect </span><span class="sc0">
</span><span class="sc1">;is always something people wanna see. And it's commented up the </span><span class="sc0">
</span><span class="sc1">;kazoo, one of the features I like best about VCL code. Hope you find</span><span class="sc0">
</span><span class="sc1">;it useful. -URNST KOUCH</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
               </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
               </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0100h</span><span class="sc0">

               </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">Start</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc5">Row</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">24</span><span class="sc0">             </span><span class="sc1">;Rows to do initially</span><span class="sc0">

                                   </span><span class="sc1">;First, get current video mode and page.</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">      </span><span class="sc1">;color display, color video mem for page 1</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">          </span><span class="sc1">;Get current video mode</span><span class="sc0">
               </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;Color?</span><span class="sc0">
               </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">A2</span><span class="sc0">             </span><span class="sc1">;Yes</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;Color?</span><span class="sc0">
               </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">A2</span><span class="sc0">             </span><span class="sc1">;Yes</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;Mono?</span><span class="sc0">
               </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">A1</span><span class="sc0">             </span><span class="sc1">;Yes</span><span class="sc0">
               </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0">            </span><span class="sc1">;No,quit</span><span class="sc0">

                                   </span><span class="sc1">;here if 80 col text mode; put video segment in ds.</span><span class="sc0">
</span><span class="sc5">A1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0A300h</span><span class="sc0">      </span><span class="sc1">;Set for mono; mono videomem for page 1</span><span class="sc0">
</span><span class="sc5">A2</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;bx=page offset</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;Video segment</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;in ds</span><span class="sc0">

                                   </span><span class="sc1">;start dropsy effect</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;Start at top left corner</span><span class="sc0">
</span><span class="sc5">A3</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;Save row start on stack</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">          </span><span class="sc1">;Reset column counter</span><span class="sc0">
                                   </span><span class="sc1">;Do next column in a row.</span><span class="sc0">
</span><span class="sc5">A4</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;Set row top in si</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Get char &amp; attr from screen</span><span class="sc0">
               </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">         </span><span class="sc1">;Is it a blank?</span><span class="sc0">
               </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">A7</span><span class="sc0">             </span><span class="sc1">;Yes, skip it</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;No, save it in dx</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">         </span><span class="sc1">;Make it a space</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;and put on screen</span><span class="sc0">
               </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc0">         </span><span class="sc1">;Set for next row</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Row</span><span class="sc0">      </span><span class="sc1">;Get rows remaining</span><span class="sc0">
</span><span class="sc5">A5</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Get the char &amp; attr from screen</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">;Put top row char &amp; attr there</span><span class="sc0">
</span><span class="sc5">A6</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Vert</span><span class="sc0">           </span><span class="sc1">;Wait for 2 vert retraces</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;Put original char &amp; attr back</span><span class="sc0">
                                   </span><span class="sc1">;Do next row, this column.</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc0">          </span><span class="sc1">;Next row</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;Done all rows remaining?</span><span class="sc0">
              </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">A5</span><span class="sc0">              </span><span class="sc1">;No, do next one</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">160</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;Put char &amp; attr on line 25 as junk</span><span class="sc0">
                                   </span><span class="sc1">;Do next column on this row.</span><span class="sc0">
</span><span class="sc5">A7</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;Next column, same row</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">;Dec column counter; done?</span><span class="sc0">
              </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">A4</span><span class="sc0">              </span><span class="sc1">;No, do this column</span><span class="sc0">
</span><span class="sc1">;Do next row.</span><span class="sc0">
</span><span class="sc5">A8</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;Get current row start</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc0">          </span><span class="sc1">;Next row</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Row</span><span class="sc0">          </span><span class="sc1">;All rows done?</span><span class="sc0">
              </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">A3</span><span class="sc0">              </span><span class="sc1">;No</span><span class="sc0">
</span><span class="sc5">A9</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">  
              </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Yes, quit to DOS with error code</span><span class="sc0">

                                   </span><span class="sc1">;routine to deal with snow on CGA screen.</span><span class="sc0">
</span><span class="sc5">Vert</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;Save all registers used</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;Wait for 2 vert retraces</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3DAh</span><span class="sc0">         </span><span class="sc1">;CRT status port</span><span class="sc0">
</span><span class="sc5">F1</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">in</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;Read status</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">;Vert retrace went hi?</span><span class="sc0">
              </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">F1</span><span class="sc0">              </span><span class="sc1">;No, wait for it</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;2nd one?</span><span class="sc0">
              </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">F3</span><span class="sc0">              </span><span class="sc1">;Yes, write during blanking time</span><span class="sc0">
</span><span class="sc5">F2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">in</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;No, get status</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">;Vert retrace went low?</span><span class="sc0">
              </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">F2</span><span class="sc0">              </span><span class="sc1">;No, wait for it</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">F1</span><span class="sc0">              </span><span class="sc1">;Yes, wait for next hi</span><span class="sc0">
</span><span class="sc5">F3</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;Restore registers</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">;and return</span><span class="sc0">
              
              </span><span class="sc5">main</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
              </span><span class="sc5">code</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
              </span><span class="sc9">end</span><span class="sc0">    </span><span class="sc5">main</span><span class="sc0">
</span></div></body>
</html>
