<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>FINDINT.PAS</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
	color: #808080;
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">{The program find_intruder determines which files are infected by the INTRUDER
 virus on a specified disk drive. It works by looking for the same ID code as
 the virus does when determining whether a file has already been infected. That
 code is located at the initial code segment, offset 0, in the EXE file. This
 must be located in the disk file and read, and compared with the value
 contained in INTRUDER}</span><span class="sc0">


</span><span class="sc5">program</span><span class="sc0"> </span><span class="sc11">find_intruder</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">{Compile with Turbo Pascal 4.0 or higher}</span><span class="sc0">

</span><span class="sc5">uses</span><span class="sc0"> </span><span class="sc11">dos</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">const</span><span class="sc0">
  </span><span class="sc11">id_check</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">=</span><span class="sc4">$C8AA</span><span class="sc10">;</span><span class="sc0">         </span><span class="sc1">{Intruder ID code word to look for}</span><span class="sc0">

</span><span class="sc5">type</span><span class="sc0">
  </span><span class="sc11">header_type</span><span class="sc0">      </span><span class="sc10">=</span><span class="sc5">record</span><span class="sc0">              </span><span class="sc1">{EXE file header structure}</span><span class="sc0">
    </span><span class="sc11">signature</span><span class="sc0">      </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lp_size</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">pg_count</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">rel_tbl_entries</span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">hdr_paragraphs</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">minalloc</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">maxalloc</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">init_ss</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">init_sp</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">chksum</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">init_ip</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">init_cs</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">rel_tbl_ofs</span><span class="sc0">    </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">overlay</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">var</span><span class="sc0">
  </span><span class="sc11">check_file</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc5">file</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">{File being checked}</span><span class="sc0">
  </span><span class="sc11">header</span><span class="sc0">           </span><span class="sc10">:</span><span class="sc11">header_type</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">{Exe header data area for file being checked}</span><span class="sc0">
  </span><span class="sc11">id_byte</span><span class="sc0">          </span><span class="sc10">:</span><span class="sc11">word</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">{Init CS:0000 value from the file being checked}</span><span class="sc0">
  </span><span class="sc11">srchpath</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc5">string</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">{Used to store the current path being searched}</span><span class="sc0">


</span><span class="sc1">{The following routine checks one file for infection by opening it, reading
 the EXE header, calculating the location of Initial CS:0000, and reading 2
 bytes from there. Then it compares those bytes with id_check. If they're the
 same, then the file is infected. If the signature is not correct, then the
 program will also display that, so you can find out if you have any non-EXE
 files with the extent .EXE with it.}</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">check_one_file</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">:</span><span class="sc5">string</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc0">
  </span><span class="sc11">assign</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">             </span><span class="sc1">{Set up the file with this path\name}</span><span class="sc0">
</span><span class="sc9">{$I-}</span><span class="sc0">                                   </span><span class="sc1">{I/O checking handled explicitly here}</span><span class="sc0">
  </span><span class="sc11">reset</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">                  </span><span class="sc1">{Open the file}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">IOResult</span><span class="sc10">&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">                   </span><span class="sc1">{If an error, just report it to the console}</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'IO error on the file '</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BlockRead</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">,</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc11">sizeof</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">));</span><span class="sc0">                  </span><span class="sc1">{Read the EXE header}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">IOResult</span><span class="sc10">&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'IO error on the file '</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">header.signature</span><span class="sc10">&lt;&gt;</span><span class="sc11">ord</span><span class="sc10">(</span><span class="sc7">'Z'</span><span class="sc10">)*</span><span class="sc4">256</span><span class="sc10">+</span><span class="sc11">ord</span><span class="sc10">(</span><span class="sc7">'M'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc7">' is not an EXE program file!'</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">,</span><span class="sc4">16</span><span class="sc10">*(</span><span class="sc11">header.hdr_paragraphs</span><span class="sc10">+</span><span class="sc11">header.init_cs</span><span class="sc10">));</span><span class="sc0">   </span><span class="sc1">{Go seek Init CS:0000}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">IOResult</span><span class="sc10">&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">                                           </span><span class="sc1">{Don't forget to take into account the size}</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">                                                       </span><span class="sc1">{of header in calculating this!}</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'IO error on the file '</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BlockRead</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">,</span><span class="sc11">id_byte</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">                              </span><span class="sc1">{Read 2 bytes at Init CS:0000}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">IOResult</span><span class="sc10">&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'IO error on the file '</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">check_file</span><span class="sc10">);</span><span class="sc0">                                            </span><span class="sc1">{and close the file}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">IOResult</span><span class="sc10">&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'IO error on the file '</span><span class="sc10">,</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">exit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">{$I+}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">id_byte</span><span class="sc10">=</span><span class="sc11">id_check</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc7">' is infected.'</span><span class="sc10">)</span><span class="sc0">       </span><span class="sc1">{if id_byte read from file = id_check, it's infected}</span><span class="sc0">
</span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">{The following routine checks all files in the specified path, or any of its
 subdirectories for infection. It will check a whole disk if the initial path
 is '\'. Note that it is recursive, and if directories are nested too deep,
 a stack overflow error will occur.}</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">check_all_files</span><span class="sc10">(</span><span class="sc11">path</span><span class="sc10">:</span><span class="sc5">string</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">var</span><span class="sc0">
  </span><span class="sc11">ExeFile</span><span class="sc0">          </span><span class="sc10">:</span><span class="sc11">SearchRec</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DirEntry</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc11">SearchRec</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc0">
  </span><span class="sc11">FindFirst</span><span class="sc10">(</span><span class="sc11">path</span><span class="sc10">+</span><span class="sc7">'\*.*'</span><span class="sc10">,</span><span class="sc11">Directory</span><span class="sc10">,</span><span class="sc11">DirEntry</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc11">DosError</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DirEntry.Attr</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc11">Directory</span><span class="sc0"> </span><span class="sc10">&lt;&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DirEntry.Name</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]&lt;&gt;</span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc11">check_all_files</span><span class="sc10">(</span><span class="sc11">path</span><span class="sc10">+</span><span class="sc7">'\'</span><span class="sc10">+</span><span class="sc11">DirEntry.Name</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">FindNext</span><span class="sc10">(</span><span class="sc11">DirEntry</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">FindFirst</span><span class="sc10">(</span><span class="sc11">path</span><span class="sc10">+</span><span class="sc7">'\*.EXE'</span><span class="sc10">,</span><span class="sc11">AnyFile</span><span class="sc10">,</span><span class="sc11">ExeFile</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc11">DosError</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">
      </span><span class="sc11">check_one_file</span><span class="sc10">(</span><span class="sc11">path</span><span class="sc10">+</span><span class="sc7">'\'</span><span class="sc10">+</span><span class="sc11">ExeFile.Name</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">FindNext</span><span class="sc10">(</span><span class="sc11">ExeFile</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc0"> </span><span class="sc1">{main}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">ParamCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc11">srchpath</span><span class="sc10">:=</span><span class="sc11">ParamStr</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">            </span><span class="sc1">{if a drive (e.g. 'D:') is specified on command line, use it}</span><span class="sc0">
  </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">srchpath</span><span class="sc10">:=</span><span class="sc7">''</span><span class="sc10">;</span><span class="sc0">                                    </span><span class="sc1">{otherwise take default drive}</span><span class="sc0">
  </span><span class="sc11">check_all_files</span><span class="sc10">(</span><span class="sc11">srchpath</span><span class="sc10">);</span><span class="sc0">                            </span><span class="sc1">{and check all files on that drive}</span><span class="sc0">
</span><span class="sc11">end.</span></div></body>
</html>
