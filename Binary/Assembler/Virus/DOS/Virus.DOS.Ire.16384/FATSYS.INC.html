<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>FATSYS.INC</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; filesystem access unit</span><span class="sc0">

</span><span class="sc1">;               Access   Address</span><span class="sc0">
</span><span class="sc1">;               Method   Type     Target      Start</span><span class="sc0">
</span><span class="sc1">;               -------- -------- ----------- -----------</span><span class="sc0">
</span><span class="sc1">; Level 0:      IO-Ports Physical HD          c=0:h=0:s=1</span><span class="sc0">
</span><span class="sc1">; Level 1:      Level0   Logical  HD          s=0</span><span class="sc0">
</span><span class="sc1">; Level 2:      Level1   Logical  Partition   s=0</span><span class="sc0">
</span><span class="sc1">; Level 3:      Level2   Logical  FAT,Cluster cluster=2</span><span class="sc0">



</span><span class="sc1">;MIN_SECT_PER_CLUST     equ       8     ;  4k MIN</span><span class="sc0">
</span><span class="sc5">MAX_SECT_PER_CLUST</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">128</span><span class="sc0">     </span><span class="sc1">; 64k MAX</span><span class="sc0">

</span><span class="sc5">direntry_name</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; directory entry</span><span class="sc0">
</span><span class="sc5">direntry_ext</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">direntry_attr</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">direntry_time</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">direntry_cluster</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">direntry_size</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">char_DELETED</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0E5h</span><span class="sc0">            </span><span class="sc1">; some constants</span><span class="sc0">
</span><span class="sc5">char_NOFILE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">fa_readonly</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">; file attributes</span><span class="sc0">
</span><span class="sc5">fa_hidden</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000010b</span><span class="sc0">
</span><span class="sc5">fa_system</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000100b</span><span class="sc0">
</span><span class="sc5">fa_volumeid</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00001000b</span><span class="sc0">
</span><span class="sc5">fa_directory</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010000b</span><span class="sc0">
</span><span class="sc5">fa_archive</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00100000b</span><span class="sc0">

</span><span class="sc5">ROOT</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; root dir cluster</span><span class="sc0">
</span><span class="sc5">EOF</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; EOF cluster</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">level0_getcmdport</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F7h</span><span class="sc0">        </span><span class="sc1">; master</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">level0_drive</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">177h</span><span class="sc0">        </span><span class="sc1">; slave</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level0_calcdrive</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; primary/secondary</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level0_drive</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10100000b</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level0_init</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_getcmdport</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; busy</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000000b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; drive #</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_calcdrive</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; ready</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">        </span><span class="sc1">; indentify drive</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; data</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__3</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; read</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_driveinfo</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">insw</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level0_read</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_mask</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_rw</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">         </span><span class="sc1">; read</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_count</span><span class="sc0">
                        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_ptr</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; data</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__3</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; read</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">insw</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__3</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_unmask</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_unmask</span><span class="sc0">

                        </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level0_write</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_mask</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_rw</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">         </span><span class="sc1">; write</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_count</span><span class="sc0">
                        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_ptr</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; ready?</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__3</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; write</span><span class="sc0">
                        </span><span class="sc5">seges</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">outsw</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__3</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_unmask</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">io_unmask</span><span class="sc0">

                        </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">io_mask</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_port21</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A1h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_portA1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">io_unmask</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_port21</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_portA1</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level0_rw</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_getcmdport</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000000b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; sector count</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level0_count</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; sector</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level0_sector</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; cylinder - lo</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_cylinder</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; cylinder - hi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; drive #</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_calcdrive</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level0_head</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; ready</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">level1_read</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level1_rw</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_read</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level1_write</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level1_rw</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level0_write</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level1_rw</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">level1_ptr</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">level0_ptr</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level1_count</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level1_sector</span><span class="sc0">
                        </span><span class="sc6">cdq</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_max_sector</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level0_max_head</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_head</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level0_cylinder</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">level2_init</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_drivecount</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_drivestart</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_recscan</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level2_recscan</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__read</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">level2_mbr.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AA55h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_mbr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">__scan_ptable</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                     </span><span class="sc1">;  cmp     al, 1           ; fat12</span><span class="sc0">
                     </span><span class="sc1">;  je      __found_drive</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; fat16</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__found_drive</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">; bigdos</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__found_drive</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; extended</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__found_ext</span><span class="sc0">

</span><span class="sc5">__scan_next</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">level2_drivecount</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__scan_ptable</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__read</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level1_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level1_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level1_ptr.o</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">level2_mbr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level1_ptr.s</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level1_read</span><span class="sc0">

                        </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__found_drive</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc1">; scan drives to avoid recursive extended</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_drivestart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_drivecount</span><span class="sc0">
                        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__scan_next</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">level2_drivecount</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__scan_next</span><span class="sc0">

</span><span class="sc5">__found_ext</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_recscan</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__read</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__scan_next</span><span class="sc0">

</span><span class="sc5">level2_initdrive</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_drive</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">level2_drivestart</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">level2_basesector</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level2_read</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_rw</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level1_read</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level2_write</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_rw</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level1_write</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level2_rw</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">level2_ptr</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">level1_ptr</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_sector</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level2_basesector</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level1_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">level2_count</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">level1_count</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">level3_init</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.o</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">level3_boot</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.s</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_read</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_boot</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AA55h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FAT16_ID</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__FAT16</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

</span><span class="sc5">__FAT16</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_reserved</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_sectpercluster</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                      </span><span class="sc1">; cmp     eax, MIN_SECT_PER_CLUST</span><span class="sc0">
                      </span><span class="sc1">; jb      __error</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_SECT_PER_CLUST</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_fatcopies</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_rootdirentries</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">511</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_rootdirsectors</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_SECT_PER_CLUST</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_sectperfat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_sectperfat</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_fatcopies</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_reserved</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_rootstart</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_rootdirsectors</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_datastart</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_totalsectors</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_datastart</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_sectpercluster</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_totalclusters</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_cachesector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; input:   bx=cluster</span><span class="sc0">
                        </span><span class="sc1">; output:  ax=value</span><span class="sc0">

</span><span class="sc5">level3_cluster_get</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_read_fat_sector</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calcfat_LO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level3_cache</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; input:   bx=cluster</span><span class="sc0">
                        </span><span class="sc1">;          ax=value</span><span class="sc0">

</span><span class="sc5">level3_cluster_set</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_read_fat_sector</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calcfat_LO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">level3_cache</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_write_fat_sector</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_calcfat_HI</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; fat sector #</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_calcfat_LO</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; input: ebx=cluster #</span><span class="sc0">

</span><span class="sc5">level3_read_fat_sector</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calcfat_HI</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_reserved</span><span class="sc0">  </span><span class="sc1">; partition sector #</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">level3_cachesector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level3_cachesector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.o</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">level3_cache</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.s</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_read</span><span class="sc0">

</span><span class="sc5">__skip</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_write_fat_sector</span><span class="sc4">:</span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calcfat_HI</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_reserved</span><span class="sc0">  </span><span class="sc1">; partition sector #</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.o</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">level3_cache</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_ptr.s</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_fatcopies</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">pushad</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_write</span><span class="sc0">
                        </span><span class="sc6">popad</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_sectperfat</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_read</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_read</span><span class="sc0">

                        </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_write</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level3_calc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">level2_write</span><span class="sc0">

                        </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">level3_calc</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">level3_ptr</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">level2_ptr</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">level3_cluster</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ROOT</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__root</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_count</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_sectpercluster</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_cluster</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_sectpercluster</span><span class="sc0">
                        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_datastart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__root</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_rootdirsectors</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">level3_rootstart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">level2_sector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">FAT16_ID</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FAT16   '</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span></div></body>
</html>
